<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><link rel=stylesheet href=/main.b078dd132968e74ef07e62c6e31f9d49bf2ad5872952ed627ba8326f3f712b45939261733971dbb4c667dc64caab32b7cdbe7f7de210f13c751699db36993537.css integrity="sha512-sHjdEylo507wfmLG4x+dSb8q1YcpUu1ie6gybz9xK0WTkmFzOXHbtMZn3GTKqzK3zb5/feIQ8Tx1FpnbNpk1Nw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>解决c10k c100k c10m问题 - MySpace</title><meta name=description content="今天整理资料时，无意中重新碰到了c10k这个话题，然后联想到了c10m问题。虽然c10k问题大家已经看过类似文章了，但是c10m问题系统性总结的却不多。今天刚好看了个相关的分享，顺便整理下。"><link rel=canonical href=/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="解决c10k c100k c10m问题"><meta property="og:description" content="今天整理资料时，无意中重新碰到了c10k这个话题，然后联想到了c10m问题。虽然c10k问题大家已经看过类似文章了，但是c10m问题系统性总结的却不多。今天刚好看了个相关的分享，顺便整理下。"><meta property="og:url" content="/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/"><meta property="og:site_name" content="MySpace"><meta property="article:published_time" content="2024-01-06T20:30:24+08:00"><meta property="article:modified_time" content="2024-01-06T20:30:24+08:00"><meta property="og:image" content="/doks.png"><meta property="og:image:alt" content="MySpace"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@hitzhangjie"><meta name=twitter:creator content="@hitzhangjie"><meta name=twitter:title content="解决c10k c100k c10m问题"><meta name=twitter:description content="今天整理资料时，无意中重新碰到了c10k这个话题，然后联想到了c10m问题。虽然c10k问题大家已经看过类似文章了，但是c10m问题系统性总结的却不多。今天刚好看了个相关的分享，顺便整理下。"><meta name=twitter:image content="/doks.png"><meta name=twitter:image:alt content="解决c10k c100k c10m问题"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/1","name":"","url":"/","sameAs":["https://twitter.com/hitzhangjie","https://www.linkedin.com/in/hitzhangjie/","https://github.com/hitzhangjie"],"image":{"@type":"ImageObject","@id":"/#/schema/image/1","url":"/\u003cnil\u003e","width":null,"height":null,"caption":""}},{"@type":"WebSite","@id":"/#/schema/website/1","url":"/","name":"MySpace","description":"MySpace is a hitzhangjie\u0027s personal space, for blogs, books, journey, thinkings.","publisher":{"@id":"/#/schema/person/1"}},{"@type":"WebPage","@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/","url":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/","name":"解决c10k c100k c10m问题","description":"今天整理资料时，无意中重新碰到了c10k这个话题，然后联想到了c10m问题。虽然c10k问题大家已经看过类似文章了，但是c10m问题系统性总结的却不多。今天刚好看了个相关的分享，顺便整理下。","isPartOf":{"@id":"/#/schema/website/1"},"about":{"@id":"/#/schema/person/1"},"datePublished":"2024-01-06T20:30:24CET","dateModified":"2024-01-06T20:30:24CET","breadcrumb":{"@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/#/schema/image/2"},"inLanguage":"","potentialAction":[{"@type":"ReadAction","target":["/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/"]}]},{"@type":"BreadcrumbList","@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/","url":"/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"/blog2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"/#/schema/article/1","headline":"解决c10k c100k c10m问题","description":"今天整理资料时，无意中重新碰到了c10k这个话题，然后联想到了c10m问题。虽然c10k问题大家已经看过类似文章了，但是c10m问题系统性总结的却不多。今天刚好看了个相关的分享，顺便整理下。","isPartOf":{"@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/"},"mainEntityOfPage":{"@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/"},"datePublished":"2024-01-06T20:30:24CET","dateModified":"2024-01-06T20:30:24CET","author":{"@id":"/#/schema/person/2"},"publisher":{"@id":"/#/schema/person/1"},"image":{"@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"/blog/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/#/schema/image/2","url":"/doks.png","contentUrl":"/doks.png","caption":"解决c10k c100k c10m问题"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=/site.webmanifest><script type=text/javascript src="https://platform-api.sharethis.com/js/sharethis.js#property=607868a58d7101001829a8df&product=sop" async></script><style>[alt~=sharing]{border:0;box-shadow:none}div#st-1{text-align:unset}div#st-1 .st-btn{height:24px;padding:0 4px}div#st-1 .st-btn>img{top:4.2px}div#st-2 .st-btn{height:24px;padding:0 4px}div#st-2 .st-btn>img{top:4.2px}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-168027530-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-168027530-1')</script></head><body class="blog single d-flex flex-column min-vh-100"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/ aria-label=MySpace>MySpace</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>MySpace</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/books/>Books</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/landscape>Landscape</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://twitter.com/hitzhangjie><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><small class="ms-2 d-lg-none">Twitter</small></a></li><li class=nav-item><a class="nav-link social-link" href=https://github.com/hitzhangjie><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-lg-none">GitHub</small></a></li></ul></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>Tag List</h3><ol><li><a href=/tags/c10k/>c10k</a></li><li><a href=/tags/c100k/>c100k</a></li><li><a href=/tags/c10m/>c10m</a></li></ol></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#问题背景>问题背景</a></li><li><a href=#c10k问题-1999-1gbps-ethernet>c10k问题, 1999, 1Gbps Ethernet</a></li><li><a href=#性能制约瓶颈>性能制约瓶颈</a></li><li><a href=#解决c10k问题>解决c10k问题</a></li><li><a href=#解决c10m问题-2010-10gbps-ethernet>解决c10m问题, 2010, 10Gbps Ethernet</a></li><li><a href=#本文小结>本文小结</a></li><li><a href=#参考文献>参考文献</a></li></ul></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>解决c10k c100k c10m问题</h1><div style=display:flex><div>分享:&nbsp;&nbsp;</div><div><div class=sharethis-inline-share-buttons></div></div></div><hr><p class=lead></p><h3 id=问题背景>问题背景 <a href=#%e9%97%ae%e9%a2%98%e8%83%8c%e6%99%af class=anchor aria-hidden=true>#</a><a href=#问题背景 class=anchor aria-hidden=true>#</a></h3><p>c10k, c100k甚至c10m，这些问题大家已经不再陌生，聊起来可能显得有点枯燥？新技术层出不穷，至少我自己对这些问题有了些新的认识，需要更新沉淀下我的“小宇宙”。</p><h3 id=c10k问题-1999-1gbps-ethernet>c10k问题, 1999, 1Gbps Ethernet <a href=#c10k%e9%97%ae%e9%a2%98-1999-1gbps-ethernet class=anchor aria-hidden=true>#</a><a href=#c10k问题-1999-1gbps-ethernet class=anchor aria-hidden=true>#</a></h3><blockquote><p>The <strong>C10k problem</strong> is the problem of optimizing <a href=https://en.wikipedia.org/wiki/Network_socket>network sockets</a> to handle a large number of clients at the same time.[<a href=https://en.wikipedia.org/wiki/C10k_problem#cite_note-C10K-1>1]</a> The name C10k is a <a href=https://en.wikipedia.org/wiki/Numeronym>numeronym</a> for <a href=https://en.wikipedia.org/wiki/Concurrent_computing>concurrently</a> handling ten thousand connections.[<a href=https://en.wikipedia.org/wiki/C10k_problem#cite_note-Liu-Deters-2>2]</a> Handling many concurrent connections is a different problem from handling many <a href=https://en.wikipedia.org/wiki/Requests_per_second>requests per second</a>: the latter requires high throughput (processing them quickly), while the former does not have to be fast, but requires efficient scheduling of connections.</p></blockquote><p>就是说，<strong>c10k解决的是1w连接的高效调度处理问题，而非请求吞吐量问题</strong>。</p><blockquote><p>The problem of socket server optimisation has been studied because a number of factors must be considered to allow a web server to support many clients. This can involve a <strong>combination of operating system constraints and web server software limitations</strong>. According to the scope of services to be made available and the capabilities of the operating system as well as hardware considerations such as multi-processing capabilities, a multi-threading model or a <a href=https://en.wikipedia.org/wiki/Single_threading>single threading</a> model can be preferred. Concurrently with this aspect, which involves considerations regarding memory management (usually operating system related), strategies implied relate to the very diverse aspects of I/O management.</p></blockquote><h3 id=性能制约瓶颈>性能制约瓶颈 <a href=#%e6%80%a7%e8%83%bd%e5%88%b6%e7%ba%a6%e7%93%b6%e9%a2%88 class=anchor aria-hidden=true>#</a><a href=#性能制约瓶颈 class=anchor aria-hidden=true>#</a></h3><p>要让服务支持大量客户端连接，受到操作系统、服务本身实现等的多种限制：</p><ul><li>操作系统<ul><li>允许进程打开的最大fd数量，通常较小，需通过<code>ulimit -n</code>设置</li><li>默认进程、线程栈大小，偏大且进程数、线程数多的话，容易OOM</li><li>那个时代有些可观存在的限制：<ul><li>glibc2.1以下版本使用16-bit数字记录句柄数，仅支持32767个</li><li>有的系统使用16位记录进程ID、现成ID，so可能创建不了太多进程、线程</li><li>有的系统预分配了太大的thread-local存储，比如1MB，假设虚地址空间2GB，那么最多创建2000个线程</li></ul></li><li>内核本身存在问题<ul><li>select、poll、epoll的改进</li><li>thundering herd（惊群）问题</li></ul></li></ul></li><li>服务实现<ul><li>网络IO管理机制，同步、异步</li><li>服务采用的并发处理模型（ppc、tpc、cpc）</li><li>框架实现<ul><li>zero-copy问题，了解收一个网络包的旅程，从网卡端口、驱动中buffer、内核协议栈、应用程序缓冲区，可借助系统调用来减少拷贝开销，推荐<a href=https://www.hitzhangjie.pro/blog/2021-09-09-%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF/>常见的零拷贝技术</a></li><li>使用writev避免发送小包，writev+iovec（scatter、gather分散读、聚集写）</li><li>使用TCP_CORK避免发送小包，将多个小包合并达到MSS后发送, see <a href=https://stackoverflow.com/a/19995579>TCP_CORK</a></li><li>过载保护机制，过载时拒绝新连接，降低错误率。如使用IO ready的客户端数量来作为负载评估指标</li></ul></li><li>caching技术</li></ul></li><li>硬件能力<ul><li>CPU</li><li>内存</li><li>网卡</li></ul></li></ul><h3 id=解决c10k问题>解决c10k问题 <a href=#%e8%a7%a3%e5%86%b3c10k%e9%97%ae%e9%a2%98 class=anchor aria-hidden=true>#</a><a href=#解决c10k问题 class=anchor aria-hidden=true>#</a></h3><p>我们就只关注服务实现过程中与之相关的部分。如果对网络编程、网络框架有清晰认识的话，一定对连接管理以及不同的编程模型有所认识。简单总结下了，不同连接管理方式对应着不同的编程模型：</p><ul><li>PPC（per process per connection），这类代表就是早期的Apache服务器，每个客户端入连接，都是fork一个cgi进程进行处理，进程是资源分配的单位，分配、进程调度的开销要大的多，性能差很容易理解。好处是进程隔离性强，一个进程崩了不影响其他进程；</li><li>TPC（per thread per connection），每个客户端入连接，都创建一个独立的线程来对其进行处理，包括网络IO、事件处理。多线程模型相比多进程模型要好一些，操作系统的写时复制（copy on write）能避免不必要的资源分配，线程上下文切换也更加轻量。但在Linux下线程依然是轻量级进程（LWP），大量线程切换时的上下文开销依然不可忽视；</li><li>CPC（per coroutine per connection），请求的处理不只是网络IO、syscall也有一些程序层面的同步，进程、线程级别的同步机制重、开销大，有没有更加轻量化的实现来最大化CPU资源利用率呢？比如当前代码执行序列现在要等待某个事件完成需要在执行上挂起，但是并不是IO或者阻塞性系统调用，线程能否先去处理其他请求，必要时再把当前位置的代码唤醒呢，而不是阻塞整个线程或者只能创建新线程来承载更多请求呢？可以，这就是协程方案（coroutine）；</li></ul><p>说到这里，就不得不提下为什么要多个进程、多个线程，为了并发提高资源利用率。程序执行操作时，有些操作会阻塞程序执行导致其让出CPU，比如进行网络IO处理，或者执行一些其他的阻塞型的syscalls。</p><p>针对网络IO处理，大家应该了解过同步阻塞、同步非阻塞、异步IO，我们就直说当前最成熟的、顶大梁的方案，同步非阻塞。Linux下通过epoll可以实现同步非阻塞IO，实现高效地IO事件处理。</p><p>这种情况下，其实一定程度上可以将服务器程序中的线程分为两类：</p><ul><li>连接IO事件管理线程</li><li>请求处理线程</li><li>请求处理协程</li></ul><p>比如cpu是8c的，可以分配8个线程专门负责连接事件管理，连接上IO事件就绪后读取请求转发给请求处理线程处理，响应也由请求处理线程发送给IO处理线程，IO处理线程负责回包，数据的传递可以通过无锁内存队列来传递。IO处理线程可以指定一个线程池大小，允许最少空闲线程数（待命）、最大线程数，不能没有限制否则可能影响稳定性甚至OOM挂掉，服务器应该优先保证服务的健壮性，保证对上游承诺的SLA指标。</p><p>腾讯曾经有一个服务器编程框架SPP就是大致这么解决的，它虽然是多进程架构，但是思路差不多：sppproxy单进程单线程负责连接管理，sppworker进程（多个，一般是单线程+协程方案）负责进行请求处理，它们之间通过共享内存队列传递数据。</p><p>通过这种方式可以有效解决c10k问题，c10k问题也不再是个难以解决的问题！</p><p>参考文中 the c10k problem给出了一些当时解决此类问题的示例：</p><ul><li><a href=http://www.kegel.com/c10k.html#examples.nb.select>select based servers</a></li><li><a href=http://www.kegel.com/c10k.html#examples.nb./dev/poll>/dev/poll based servers</a></li><li><a href=http://www.kegel.com/c10k.html#examples.nb.epoll>epoll-based servers</a></li><li><a href=http://www.kegel.com/c10k.html#examples.nb.kqueue>kqueue-based servers</a></li><li><a href=http://www.kegel.com/c10k.html#examples.nb.sigio>rtsig based servers</a></li><li><a href=http://www.kegel.com/c10k.html#examples.threaded>thread-based servers</a></li><li><a href=http://www.kegel.com/c10k.html#examples.kio>in-kernel servers</a> 把服务器实现搬进了内核中 :)</li></ul><p>如果感觉陌生，不妨先读读我前些年总结的<a href=https://www.hitzhangjie.pro/blog/2017-05-02-linux-common-io-model/>Linux常见IO模型</a>。</p><h3 id=解决c10m问题-2010-10gbps-ethernet>解决c10m问题, 2010, 10Gbps Ethernet <a href=#%e8%a7%a3%e5%86%b3c10m%e9%97%ae%e9%a2%98-2010-10gbps-ethernet class=anchor aria-hidden=true>#</a><a href=#解决c10m问题-2010-10gbps-ethernet class=anchor aria-hidden=true>#</a></h3><blockquote><p>我们直接无视了c100k问题，其实可能没有这种提法，毕竟它和c10k只是10倍的差距，不是什么大的挑战，而c10m和c10k比是1000倍的差距，可能工程师们还是喜欢2^10这样的倍数关系，这样才算的上挑战吧。</p></blockquote><p>ok，c10k相比c10m是上个10年的事情，那么到了2010年，大家是如何解决c10m问题的呢？要单机支持1000w并发连接数，即便是现在2024年，让一个工程师把个中技术讲个明白，也可以拿个不错的offer了吧 :)</p><p>The c10m problem! 依靠内核是不能胜任这个问题的，内核恰恰是问题所在！</p><p><img src=/blog/assets/2024-01-06-%E8%A7%A3%E5%86%B3c10kc100kc10m%E9%97%AE%E9%A2%98/Linux_kernel_map.png alt="File:Linux kernel map.png"></p><p>除了解决c10k的哪些可借鉴之处，这里整理了 Robert David Graham 2013 年分享中的一些要点 <a href="https://www.youtube.com/watch?v=73XNtI0w7jA">c10m: defending the Internet at scale</a>。</p><ul><li><p>packet scaling：内核提供的收包机制太重了，自定义网卡驱动，接管对网卡的管理，将收到的包直接递交给应用程序缓冲区，而不是传给内核协议栈，像这样的实现包括：</p><ul><li>PF_RING</li><li>Netmap</li><li>Intel DPDK</li></ul><p>ps：现在有了一种相比较之下更好的技术，基于eBPF的高性能网络。</p></li><li><p>multi-core scaling</p><p>spinlock,mutex,critical section,semaphores?</p><ul><li>no waiting</li><li>un-synchonization<ul><li>core local data</li><li>ring buffers</li><li>RCU (read-copy-update)</li></ul></li><li>atomics<ul><li>cmpxchg</li><li>lock add</li></ul></li><li>lockfree data structures</li><li>thread models<ul><li>pipeline</li><li>worker</li></ul></li><li>taskset</li><li>thread affinity</li></ul></li><li><p>CPU and memory</p><ul><li><p>co-locate data</p><ul><li><p>don&rsquo;t: data structures all over memory connected via pointers</p></li><li><p>do: all the data together in one chunk of memory</p><p>ps：每次follow一个pointer都是一个cache miss，考虑访存延迟! 假设你的数据是A->B->C->D，4个cache miss，如过组织成A|B|C|D，那么就可以减少到4次cache miss。</p></li></ul></li><li><p>compress data</p><ul><li>bit-fields instead of large integers</li><li>indexes (1, 2 bytes) instead of pointers (8 bytes)</li><li>get rid of padding in data structures</li></ul></li><li><p>cache efficient data structures</p><p>B+ tree over Binary Search Tree, etc. 减少访存次数</p></li><li><p>NUMA</p><p>double the main memory access time</p></li><li><p>memory pools</p><ul><li>per object</li><li>per thread</li><li>per socket</li><li>defend against resource exhaustion</li></ul></li><li><p>hyper-threading</p><p>threads > cores, 一个thread阻塞了其他thread可以继续跑，充分利用cpu</p></li><li><p>linux bootparam</p><ul><li>hugepages</li></ul></li></ul></li></ul><p>ps：这里纯粹是听分享整理的，内容不是很详实。待过几天时间宽裕后再继续完善。</p><h3 id=本文小结>本文小结 <a href=#%e6%9c%ac%e6%96%87%e5%b0%8f%e7%bb%93 class=anchor aria-hidden=true>#</a><a href=#本文小结 class=anchor aria-hidden=true>#</a></h3><p>我们可以联想下自己使用的一些编程语言、服务框架、部署机器等等，覆盖了上述哪些要点，或者又引入了哪些其他没提到的方案，是否能胜任c10k、c10m问题。当然对于一个普通后台微服务（可能前段有lb、gateway拦着）也不会管理这么多连接，但是可以想一想，如果直接对接clients，能不能抗的住，如果抗不住问题会出现在哪里，如果能扛得住又是因为什么 :) 权当学习一下。</p><h3 id=参考文献>参考文献 <a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae class=anchor aria-hidden=true>#</a><a href=#参考文献 class=anchor aria-hidden=true>#</a></h3><ol><li>c10k, https://en.wikipedia.org/wiki/C10k_problem</li><li>the c10k problem, http://www.kegel.com/c10k.html</li><li>2million connections by single box, https://web.archive.org/web/20140501234954/https://blog.whatsapp.com/196/1-million-is-so-2011</li><li>TCP_NODELAY and TCP_CORK, https://stackoverflow.com/a/19995579</li><li>常见零拷贝技术, https://www.hitzhangjie.pro/blog/2021-09-09-%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF/</li><li>Linux常见IO模型, https://www.hitzhangjie.pro/blog/2017-05-02-linux-common-io-model/</li><li>解决c10m问题, http://highscalability.com/blog/2013/5/13/the-secret-to-10-million-concurrent-connections-the-kernel-i.html</li><li>c10m: defend the Internet at scale, https://www.youtube.com/watch?v=73XNtI0w7jA</li></ol><div class=edit-page><a href=https://github.com/hitzhangjie/myspace/blob/master/content/blog/2024-01-06-%e8%a7%a3%e5%86%b3c10kc100kc10m%e9%97%ae%e9%a2%98.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></div><div class="docs-navigation d-flex justify-content-between"><a class=ms-auto href=/blog/2023-12-12-%E8%A7%82%E6%B5%8Bgo%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8go-ftrace%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/><div class="card my-1"><div class="card-body py-2">观测Go函数调用：go-ftrace 设计实现 &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted mt-auto"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div><div class=col-lg-8 align=right><p><font size=-1>站点构建版本：v0.2.3</font></p></div></div></div></footer><script src=/js/bootstrap.min.fdbe9b9ba88a036135318f3c721784d684ac9e3280fe282cc80d7d49f7f9c82780cd54228c1608685a230c09984300d7946fc471734d566fcebc148b65bd16db.js integrity="sha512-/b6bm6iKA2E1MY88cheE1oSsnjKA/igsyA19Sff5yCeAzVQijBYIaFojDAmYQwDXlG/EcXNNVm/OvBSLZb0W2w==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.b64f1e7517e5839396950ceee4ef937fbbd3ff20aa1fdd261ce87fa457863404f35a6e5239dd57b20b37f39c2401b933deeef60af180195b16941c88f10e948d.js integrity="sha512-tk8edRflg5OWlQzu5O+Tf7vT/yCqH90mHOh/pFeGNATzWm5SOd1Xsgs385wkAbkz3u72CvGAGVsWlByI8Q6UjQ==" crossorigin=anonymous defer></script>
<script src=/main.min.f16ffd9b364013a1df84be9cd7a45c470cb48639766bf5551e05bba845fe4ab150cb6436de43609bfed9af47c23bd5e395e9a10b932fa6fb2c4ee8f6cc78d7a3.js integrity="sha512-8W/9mzZAE6HfhL6c16RcRwy0hjl2a/VVHgW7qEX+SrFQy2Q23kNgm/7Zr0fCO9XjlemhC5MvpvssTuj2zHjXow==" crossorigin=anonymous defer></script>
<script src=/index.min.98a29678f228782454fb3bf90a3c732099085ff04d43cff4e925e5ccf79a7b5e5a3d524eae6b0e13884efceaa90b1f46a80efc61df1aae0b2a4397d8ebcc5ca0.js integrity="sha512-mKKWePIoeCRU+zv5CjxzIJkIX/BNQ8/06SXlzPeae15aPVJOrmsOE4hO/OqpCx9GqA78Yd8argsqQ5fY68xcoA==" crossorigin=anonymous defer></script></body></html>