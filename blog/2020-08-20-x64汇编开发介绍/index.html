<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Web站点描述">
<title>
x64汇编开发介绍 - 介绍
</title>




<script type="text/javascript" src="https://platform-api.sharethis.com/js/sharethis.js#property=5f24f50fc2418c0012d52ac3&product=inline-share-buttons" async="async">
</script>

<style>
 
[alt~=sharing] {
    border: 0px;
    box-shadow: none;
}
div#st-1 {
    text-align: unset;
}

 
div#st-1 .st-btn {
    height: 24px;
    padding: 0 4px;
}

div#st-1 .st-btn > img {
    top: 4.2px;
}

div#st-2 .st-btn {
    height: 24px;
    padding: 0 4px;
}

div#st-2 .st-btn > img {
    top: 4.2px;
}
</style>







        <meta property="og:title" content="x64汇编开发介绍 - 介绍" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Web站点描述"/>
<meta property="og:url" content="https://hitzhangjie.github.io/blog/2020-08-20-x64%E6%B1%87%E7%BC%96%E5%BC%80%E5%8F%91%E4%BB%8B%E7%BB%8D/"/>
<meta property="og:site_name" content="介绍"/>




<meta property="og:image" content="https://hitzhangjie.github.io/home/me.jpg"/>

<meta property="og:image" content="https://hitzhangjie.github.io/home/profile.jpg"/>




        
<link rel="shortcut icon" href="/img/fav.ico">


        





<link rel="stylesheet" href="/css/main.min.daa833377fb1636f8cbfa65c601050bb5475623deb7aa6e6fdde94a064a6185d.css" integrity="sha256-2qgzN3&#43;xY2&#43;Mv6ZcYBBQu1R1Yj3reqbm/d6UoGSmGF0=" crossorigin="anonymous" media="screen">




    <link rel="stylesheet" href="/custom.css" integrity="" crossorigin="anonymous" media="screen">

        
        
        
        
    </head>
    <body>
        <section id="top" class="section">
            
            <div class="container hero  fade-in one ">
                

    <h1 class="bold-title is-1">博客</h1>


            </div>
            
            <div class="section  fade-in two ">
                
<div class="container">
    <hr>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        
        <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false" >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="navbar-menu " id="navMenu">
            
            
            
            
            <a class="navbar-item" href="/">主页</a>
            

            
            

            
                
            

            
                
            

            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://hitzhangjie.github.io/projects/">
                  
                  项目
                  
                  </a>
                
                
            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://hitzhangjie.github.io/blog/">
                  
                  返回 博客
                  
                  </a>
                
                
            
            
            
            
            
            <a class="navbar-item" href="/#about">关于</a>
            
            
            
            
            
            <a class="navbar-item" href="/#thanks">致谢</a>
            
            
            
            

            
            
            <a class="navbar-item" href="/#contact">联系方式</a>
            
            

            
            
            
            
            <a class="navbar-item" href="https://hitzhangjie.github.io/en/">English</a>
            
            

            
            
        </div>
    </nav>
    <hr>
</div>



                
    <div class="container">

        <h2 class="title is-1 top-pad strong-post-title">
            <a href="https://hitzhangjie.github.io/blog/2020-08-20-x64%E6%B1%87%E7%BC%96%E5%BC%80%E5%8F%91%E4%BB%8B%E7%BB%8D/">x64汇编开发介绍</a>
        </h2>
        <div class="post-data">
            发表时间：2020-08-20 <br> 
            阅读时长：9 分钟 (4040字)
        </div>

        
        <div>
            <div>
            
            
            <p>
                标签：
                
                <a href="/tags/intel">intel</a>,
                
                <a href="/tags/assembly">assembly</a>,
                
                <a href="/tags/x64">x64</a>
                
            </p>
            
            </div>

            <div>
            <br>
            


<div style="display:flex;">
    <div>分享：</div>
    <div>
        <div class="sharethis-inline-share-buttons"></div>
    </div>
</div>


            </div>

        </div>

        
        

        
        <div> 
            
<aside>
    <hr/>
    <header>
    <b>《x64汇编开发介绍》目录：</b>
    <br/>
    </header>
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#介绍">介绍</a></li>
        <li><a href="#架构">架构</a>
          <ul>
            <li><a href="#通用架构">通用架构</a></li>
            <li><a href="#simd架构">SIMD架构</a></li>
          </ul>
        </li>
        <li><a href="#工具">工具</a>
          <ul>
            <li><a href="#assemblers">assemblers</a></li>
            <li><a href="#cc-compilers">c/c++ compilers</a></li>
          </ul>
        </li>
        <li><a href="#指令基础">指令基础</a>
          <ul>
            <li><a href="#寻址模式">寻址模式</a></li>
            <li><a href="#指令集">指令集</a></li>
          </ul>
        </li>
        <li><a href="#操作系统">操作系统</a></li>
        <li><a href="#调用惯例">调用惯例</a></li>
        <li><a href="#示例">示例</a></li>
        <li><a href="#总结">总结</a></li>
        <li><a href="#参考内容">参考内容</a></li>
      </ul>
    </li>
  </ul>
</nav>
    <hr/>
</aside>


        </div>
   
        
        <div class="container markdown top-pad">
            <p>最近在工作和学习中发现，其实汇编是非常重要的，即便现在高级语言已经非常方便了，但是了解汇编对于深入理解计算机系统，以及一些高深的知识点是不可或缺的。举几个例子，比如说Linux操作系统有一个系统调用函数叫Fork我们都知道Fork的返回值在子进程中是0，在父进程中是非0，那这个是如何实现的呢？对于不了解汇编的人也很难有能力去阅读Linux操作系统源码，只能道听途说了解到个大概原因。再比如接下来要讲的gomonkey测试框架实现的一些指令patching操作，这些都是与汇编操作分不开的。甚至你想了解下上下文切换开销，你都需要深入了解下指令执行周期等等的问题。</p>
<p>不懂汇编，不妨碍你开发上层应用，但是对你的深度就是一道坎，你很难跨国这个鸿沟去窥探更底层的一些原理。</p>
<p>有感而发，今天就回顾下intel官方开发发布的x64汇编知识，做一个简单的回顾，也为后面研究gomonkey指令patching等等做一些准备和铺垫。</p>
<h2 id="介绍">介绍</h2>
<p>大家使用x86汇编来写一些对性能比较敏感的程序嗯，这个情况已经持续很多年了嗯，但是现在32位机器应逐渐被64位机器取代了，对应的汇编代码也发生了变化。这篇文章主要就是介绍x64汇编的，如果不了解x86汇编也没什么大碍，当然了解的话理解起来会更简单一点。</p>
<p>x64是一个通用的名字，它表示的是对Intel以及AMD 32位指令集架构的一个64位扩展。AMD首先引入了x64指令集，最初叫x86-64，后面又改成了AMD64。Intel呢，将其支持64位指令集的架构称之为IA-32e，后面又改成了EMT64。这两个版本之间有一点细微的不兼容的地方，但是大部分指令在两个版本上都可以很好的工作，相关的细节可以参考Intel开发手册<a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">Intel 64 And IA-32 Architectures Software Developer&rsquo;s Manuals</a>，以及AMD64架构的技术文档。我们将这两个版本的交集部分称之为x64。不要将x64与64位Intel Itanium架构（称之为IA-64）混为一谈。</p>
<p>这篇文章没有涉及硬件相关的细节，如caches、分支预测，以及其他高级话题。文章最后会给出一些这些领域的参考手册供了解更多。</p>
<p>汇编语言，往往会用来编写对性能要求比较苛刻的程序或其中的一部分。但是对大部分普通程序员来说，与其让其写汇编，还不如写cc++然后配上一个好的编译器来的实在，后者编译器优化的性能可能比其写出的汇编代码质量更高。汇编语言对于调试代码也是有用的，有时一个编译器可能生成了一些不正确的汇编指令，通过调试器在程序中单步调试可以帮助定位到问题的原因。代码优化器，有时也会犯错。汇编的另外一个用途，你可以用它来研究没有源码的程序。反汇编让你能够改变、修复现有的可执行程序（推荐下几个工具hopper or cutter）。如果你想了解或者调查为什么某种编程语言比较慢，其他的比较快之类的问题，汇编也是你的好帮手。最后吧，掌握汇编知识，对于诊断一些恶意软件，也是必不可少的技能。</p>
<h2 id="架构">架构</h2>
<p>当要去学习特定平台的汇编时，首先应该学习的是，该平台的寄存器集合。</p>
<h3 id="通用架构">通用架构</h3>
<p>64位寄存器允许容纳更大的尺寸的数据，或者是地址，所以我们定义的更多的类型，将1个字节byte定义成8bits，将1个字word定义成16bits，将一个双字double word定义成32bits，将一个四字quadword定义成64位，将一个八字double quadword定义成128bits。关于字节序的问题，Intel是小端字节序，意味着低有效位存储在内存的低地址中。</p>
<p><img src="https://software.intel.com/content/dam/develop/external/us/en/images/29529-figure-1-181178.jpg" alt="通用架构"></p>
<p>上图显示了16个64bits的通用目的寄存器，前8个被命名成rax、rbx、rcx、rdx、rbp、rsi、rdi、rsp，这个命名和历史原因有关系，后面8个被命名成了r8~r15。如果前8个自己存器名，将字符r换成e，就变成了对应的地位的32位寄存器，比如rax的低32位是eax。类似地，如果想访问低16位，就直接把前缀去掉，如AX就是访问的rax的低16位，如果低8位呢，那就是AL了，AH就是次低8位（8~15位）。新加的8个寄存器r8~r15可以用类似的方式来访问低位数据，如r8（qword），r8d（lower dword），r8w（lowest word）、r8b（lowest byte MASM风格，intel风格是r8l）。注意没有r8h这种表示法。</p>
<p>使用REX操作码前缀去访问新添加的这8个通用寄存器的字节时，有一些限制，不能像访问之前的8个通用寄存器一样通过AH、BH、CH、DH来访问，并且一次只能访问一个（如R11B），但是可以使用AL、BL、CL、DL，为啥来，因为它就是强制要求将AH、BH、CH、DH转换成BPL、SPL、DIL、SIL来使用。</p>
<p>64位指令指针寄存器RIP，指向下一条要执行的指令的低质，并且支持64位平坦内存模型，当前操作系统中的内存地址布局将在后面提及。</p>
<p>栈指针寄存器RSP，指向当前刚push进栈的元素空间地址，也就是栈顶了，栈从高地址向低地址方向增长。栈用来存储调用例程（函数）的返回值、传递参数，或者用以支持ABI中的调用惯例（如保存调用方现场）。</p>
<p>RFLAGS寄存器，用来存储一些标识信息，它用来标识一些操作的结果（如是否溢出、运算结果的正负等）或者控制处理器的执行。这在x86 32位寄存器EFLAGS中就已经形成了这些，现在在以前基础上又添加了高32位，用来预留支持扩展，当前是没有使用的。下表列出了最常使用的一些flags。大多数其他flags是用于操作系统级别的任务。</p>
<table>
<thead>
<tr>
<th align="left">Symbol</th>
<th align="left">Bit</th>
<th align="left">Name</th>
<th align="left">Set if&hellip;</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">CF</td>
<td align="left">0</td>
<td align="left">Carry</td>
<td align="left">Operation generated a carry or borrow</td>
</tr>
<tr>
<td align="left">PF</td>
<td align="left">2</td>
<td align="left">Parity</td>
<td align="left">Last byte has even number of 1&rsquo;s, else 0</td>
</tr>
<tr>
<td align="left">AF</td>
<td align="left">4</td>
<td align="left">Adjust</td>
<td align="left">Denotes Binary Coded Decimal in-byte carry</td>
</tr>
<tr>
<td align="left">ZF</td>
<td align="left">6</td>
<td align="left">Zero</td>
<td align="left">Result was 0</td>
</tr>
<tr>
<td align="left">SF</td>
<td align="left">7</td>
<td align="left">Sign</td>
<td align="left">Most significant bit of result is 1</td>
</tr>
<tr>
<td align="left">OF</td>
<td align="left">11</td>
<td align="left">Overflow</td>
<td align="left">Overflow on signed operation</td>
</tr>
<tr>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
<tr>
<td align="left">DF</td>
<td align="left">10</td>
<td align="left">Direction</td>
<td align="left">Direction string instructions operate (increment or decrement)</td>
</tr>
<tr>
<td align="left">ID</td>
<td align="left">21</td>
<td align="left">Identification</td>
<td align="left">Changeability denotes presence of CPUID instruction</td>
</tr>
</tbody>
</table>
<p>浮点运算单元（FPU，Floating Point Unit）包含了8个寄存器FPR0-FPR7，还有状态寄存器、控制寄存器，以及其他的几个寄存器。FPR0-7这几个寄存器，每个都可以存储下表中列出的数据类型的值。浮点操作遵从IEEE 754标准。注意，大多数c/c++编译器支持32位和64位的float、double数据类型，但是没有支持80位的浮点数据类型，但是汇编是支持的。这8个寄存器和另外8个MMX？寄存器实际上是共享的同一组物理寄存器。</p>
<table>
<thead>
<tr>
<th align="left">Data Type</th>
<th align="left">Length</th>
<th align="left">Precision (bits)</th>
<th align="left">Decimal digits Precision</th>
<th align="left">Decimal Range</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Single Precision</td>
<td align="left">32</td>
<td align="left">24</td>
<td align="left">7</td>
<td align="left">1.18<em>10^-38 to 3.40</em>10^38</td>
</tr>
<tr>
<td align="left">Double Precision</td>
<td align="left">64</td>
<td align="left">53</td>
<td align="left">15</td>
<td align="left">2.23 <em>10^-308 to 1.79</em>10^308</td>
</tr>
<tr>
<td align="left">Extended Precision</td>
<td align="left">80</td>
<td align="left">64</td>
<td align="left">19</td>
<td align="left">3.37<em>10^-4932 to 1.18</em>10^4932</td>
</tr>
</tbody>
</table>
<p>有几个8位指令支持二进制编码的十进制（BCD），浮点寄存器支持的奇特格式还提供了一种80位，17位的BCD类型。</p>
<blockquote>
<p>不确定是否翻译有误，原文：Binary Coded Decimal (BCD) is supported by a few 8-bit instructions, and an oddball format supported on the floating point registers gives an 80 bit, 17 digit BCD type.</p>
</blockquote>
<p>这16个128bits的XMM寄存器（比x86多了8个）后面会有更详细介绍。</p>
<p>还有就是，段寄存器（在x64下大多数没有用）、控制寄存器、内存管理寄存器、调试寄存器、虚拟化寄存器、性能寄存器（跟踪记录各种类型的内部参数，如cache命中、miss，分支预测命中、miss，微码执行，定时等等）。最突出的性能相关的操作码就是RDTSC，它是用来技术处理器时钟周期的，经常通过它来测量一小段代码的执行耗时。通常c库里面提供的函数gettimeofday是比较耗时间的，所以在高频使用的时候会有性能问题，一般在网络框架里面做定时器、时间测量相关的任务，是会通过RDTSC来推送系统时间进而推算耗时的（在我的文章libmill定时器中也有提及，hitzhangjie.gitbook.io/libmill）。</p>
<p>更多其他细节信息，可以参考全5卷 &ldquo;Intel 64 And IA-32 Architectures Software Developer&rsquo;s Manuals&rdquo;，可以从这里免费下载，http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html。</p>
<h3 id="simd架构">SIMD架构</h3>
<p>单指令多数据（SIMD）指令对多条数据并行执行一条命令，这是汇编例程的常用用法。 MMX和SSE命令（分别使用MMX和XMM寄存器）支持SIMD操作，该操作可并行处理多达八段数据。例如，可以使用MMX在一条指令中将八个字节与另外八个字节相加。</p>
<p>八个64位MMX寄存器MMX0-MMX7是FPR0-7的别名，这意味着任何将FPR和MMX混合起来操作的代码都必须小心，不要覆盖所需的值。 MMX指令对整数类型进行操作，允许对MMX寄存器中的值并行执行字节，字和双字操作。大多数MMX指令以“P”开头表示“packed”。算术，移位/旋转，比较，例如：PCMPGTB表示“比较packed的的有符号1字节整数是否大于”。</p>
<p>16个128位XMM寄存器允许每条指令对四个单精度或两个双精度值进行并行运算。一些指令还适用于压缩字节，字，双字和四字整数。这些称为流式SIMD扩展（SSE）的指令具有多种形式：SSE，SSE2，SSE3，SSSE3，SSE4，以及在本文印制之时可能还会更多。英特尔已经宣布了这些扩展，称为英特尔®高级矢量扩展（Intel®AVX），具有新的256位宽数据路径。 SSE指令包含对浮点和整数类型的移动，算术，比较，重排和拆包以及按位运算。指令名称包括诸如PMULHUW和RSQRTPS之类的。最后，SSE引入了一些有关内存预取（出于性能）和内存屏障（出于多线程安全）的指令。</p>
<p>下表列出了一些命令集，操作的寄存器类型，并行操作的项目数以及项目类型。例如，使用SSE3和128位XMM寄存器，您可以并行处理2个（必须为64位）浮点值，或者并行处理16个（必须为字节大小）整数值。</p>
<p>为了找到给定芯片支持的技术，有一条CPUID指令返回特定于处理器的信息。</p>
<table>
<thead>
<tr>
<th align="left">Technology</th>
<th align="left">Register size/type</th>
<th align="left">Item type</th>
<th align="left">Items in Parallel</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">MMX</td>
<td align="left">64 MMX</td>
<td align="left">Integer</td>
<td align="left">8, 4, 2, 1</td>
</tr>
<tr>
<td align="left">SSE</td>
<td align="left">64 MMX</td>
<td align="left">Integer</td>
<td align="left">8,4,2,1</td>
</tr>
<tr>
<td align="left">SSE</td>
<td align="left">128 XMM</td>
<td align="left">Float</td>
<td align="left">4</td>
</tr>
<tr>
<td align="left">SSE2/SSE3/SSSE3&hellip;</td>
<td align="left">64 MMX</td>
<td align="left">Integer</td>
<td align="left">2,1</td>
</tr>
<tr>
<td align="left">SSE2/SSE3/SSSE3&hellip;</td>
<td align="left">128 XMM</td>
<td align="left">Float</td>
<td align="left">2</td>
</tr>
<tr>
<td align="left">SSE2/SSE3/SSSE3&hellip;</td>
<td align="left">128 XMM</td>
<td align="left">Integer</td>
<td align="left">16,8,4,2,1</td>
</tr>
</tbody>
</table>
<h2 id="工具">工具</h2>
<h3 id="assemblers">assemblers</h3>
<h3 id="cc-compilers">c/c++ compilers</h3>
<h2 id="指令基础">指令基础</h2>
<h3 id="寻址模式">寻址模式</h3>
<h3 id="指令集">指令集</h3>
<h2 id="操作系统">操作系统</h2>
<h2 id="调用惯例">调用惯例</h2>
<h2 id="示例">示例</h2>
<h2 id="总结">总结</h2>
<h2 id="参考内容">参考内容</h2>
<ul>
<li>原文地址: <a href="https://software.intel.com/content/www/us/en/develop/articles/introduction-to-x64-assembly.html">https://software.intel.com/content/www/us/en/develop/articles/introduction-to-x64-assembly.html</a></li>
<li>NASM: <a href="http://www.nasm.us/">http://www.nasm.us/</a></li>
<li>YASM: <a href="http://www.tortall.net/projects/yasm/">http://www.tortall.net/projects/yasm/</a></li>
<li>Flat Assembler (FASM): <a href="http://www.flatassembler.net/">http://www.flatassembler.net/</a></li>
<li>&ldquo;Intel® 64 and IA-32 Architectures Software Developer&rsquo;s Manuals,&rdquo; available online at <a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html">http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html</a></li>
<li>&ldquo;Compiler Intrinsics&rdquo;, available online at <a href="http://msdn.microsoft.com/en-us/library/26td21ds.aspx">http://msdn.microsoft.com/en-us/library/26td21ds.aspx</a></li>
<li>Matt Pietrek, &ldquo;Everything You Need To Know To Start Programming 64-Bit Windows Systems&rdquo;, available online at <a href="http://msdn.microsoft.com/en-us/magazine/cc300794.aspx,">http://msdn.microsoft.com/en-us/magazine/cc300794.aspx,</a> 2009.</li>
<li>Intel® 64 and IA-32 Architectures Software Developer Manuals</li>
</ul>

        </div>
        

        
        <hr>
        <div style="float:right;">
        


<div style="display:flex;">
    <div>分享：</div>
    <div>
        <div class="sharethis-inline-share-buttons"></div>
    </div>
</div>


        </div>

        <br>
        <br>

    </div>

    
    
    <br>
    <br>
    <div style="height:auto;align:center;text-align:center;"> 
        <div>
            <img src="/common/xiaoqi.png" style="height:238px;margin-top:10px;margin-right:5px;"/>
            <img src="/common/qrcode.jpg" style="height:238px;margin-top:10px;"/>
            <img src="/common/yuanbao.png" style="height:238px;margin-top:10px;margin-left:5px;"/>
        </div>

        <div>
            <p>
                感谢打赏，小七🐶、元宝🐱可以改善伙食咯 😘
            </p>
        </div>


    </div>
    

    


                
                <div class="container">
    <hr>
</div>
<div class="container has-text-centered top-pad">
    <a href="#top">
        <i class="fa fa-arrow-up"></i>
    </a>
</div>

<div class="container">
    <hr>
</div>

                <div class="section" id="footer">
    <div class="container has-text-centered">
    
        <span class="footer-text">
            <a href="https://github.com/victoriadrake/hugo-theme-introduction/"><strong>Introduction</strong></a> 主题为 <a href="http://gohugo.io/">Hugo</a> 而设。由开源社群贡献者以 <a href="https://victoria.dev"><i class="fa fa-heart"></i> 和 <i class="fa fa-coffee"></i></a> 创造。
        </span>
    
    </div>
</div>

                
            </div>
        </section>
        
        





<script src="https://hitzhangjie.github.io/js/bundle.23f18222425179f754965a36c9b211bd8cff5e5ab61ee23b52f026cef6699139.js" integrity="sha256-I/GCIkJRefdUllo2ybIRvYz/Xlq2HuI7UvAmzvZpkTk="></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-168027530-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




        
        
        
        
    </body>
</html>
