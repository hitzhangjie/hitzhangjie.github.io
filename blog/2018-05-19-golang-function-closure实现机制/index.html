<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Webç«™ç‚¹æè¿°">
<title>
golang function-closure å®ç°æœºåˆ¶ - ä»‹ç»
</title>



        <meta property="og:title" content="golang function-closure å®ç°æœºåˆ¶ - ä»‹ç»" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Webç«™ç‚¹æè¿°"/>
<meta property="og:url" content="https://hitzhangjie.github.io/blog/2018-05-19-golang-function-closure%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/"/>
<meta property="og:site_name" content="ä»‹ç»"/>




<meta property="og:image" content="https://hitzhangjie.github.io/home/me.jpg"/>

<meta property="og:image" content="https://hitzhangjie.github.io/home/profile.jpg"/>




        
<link rel="shortcut icon" href="/img/fav.ico">


        





<link rel="stylesheet" href="/css/main.min.5c5478bdd5363758f3e73657d5339b1ac7c131a401ffc3338edd7eb5e1a0114e.css" integrity="sha256-XFR4vdU2N1jz5zZX1TObGsfBMaQB/8Mzjt1&#43;teGgEU4=" crossorigin="anonymous" media="screen">




    <link rel="stylesheet" href="/custom.css" integrity="" crossorigin="anonymous" media="screen">

        
        
        
        
    </head>
    <body>
        <section id="top" class="section">
            
            <div class="container hero  fade-in one ">
                

    <h1 class="bold-title is-1">åšå®¢</h1>


            </div>
            
            <div class="section  fade-in two ">
                
<div class="container">
    <hr>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        
        <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false" >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="navbar-menu " id="navMenu">
            
            
            
            
            <a class="navbar-item" href="/">ä¸»é¡µ</a>
            

            
            

            
                
            

            
                
            

            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://hitzhangjie.github.io/projects/">
                  
                  é¡¹ç›®
                  
                  </a>
                
                
            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://hitzhangjie.github.io/blog/">
                  
                  è¿”å› åšå®¢
                  
                  </a>
                
                
            
            
            
            
            
            <a class="navbar-item" href="/#about">å…³äº</a>
            
            
            
            
            
            <a class="navbar-item" href="/#thanks">è‡´è°¢</a>
            
            
            
            

            
            
            <a class="navbar-item" href="/#contact">è”ç³»æ–¹å¼</a>
            
            

            
            
            
            
            <a class="navbar-item" href="https://hitzhangjie.github.io/en/">English</a>
            
            

            
            
        </div>
    </nav>
    <hr>
</div>



                
    <div class="container">
        <h2 class="title is-1 top-pad strong-post-title">
            <a href="https://hitzhangjie.github.io/blog/2018-05-19-golang-function-closure%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">golang function-closure å®ç°æœºåˆ¶</a>
        </h2>
        <div class="post-data">
            å‘è¡¨æ—¶é—´ï¼š2018-05-19 <br> 
            é˜…è¯»æ—¶é•¿ï¼š3 åˆ†é’Ÿ (560å­—)
        </div>

        <p>
        
<div class="blog-share">
    åˆ†äº«ï¼š
    
    <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=golang%20function-closure%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%20https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        <span class="hidden">Twitter</span>
    </a>
    
    
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f"  onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="fab fa-facebook-f"></i>
        <span class="hidden">Facebook</span>
    </a>
    
    
    <a class="icon-pinterest" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f&amp;description=golang%20function-closure%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <i class="fab fa-pinterest-p"></i>
        <span class="hidden">Pinterest</span>
    </a>
    
    
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <i class="fab fa-google-plus-g"></i>
        <span class="hidden">Google+</span>
    </a>
    
</div>



        </p>

        
        
        <p>
            æ ‡ç­¾ï¼š
            
            <a href="/tags/go">go</a>,
            
            <a href="/tags/golang">golang</a>,
            
            <a href="/tags/closure">closure</a>
            
        </p>
        


    </div>
    
    <div class="container markdown top-pad">
        <p>golangé‡Œé¢å‡½æ•°æ—¶first-class citizenï¼Œå¯ä»¥ä½œä¸ºå€¼è¿›è¡Œå‚æ•°ä¼ é€’ï¼Œä¸ç®¡æ˜¯æ™®é€šå‡½æ•°â€œfunc abc()â€ï¼Œè¿˜æ˜¯æˆå‘˜æ–¹æ³•â€œfunc (x X) xxx()â€ï¼Œè¿˜æ˜¯ä¸€ä¸ªé—­åŒ…â€œfunc () { return func(){&hellip;.}}â€â€¦â€¦çœ‹ä¸Šå»å¾ˆæ–¹ä¾¿ï¼Œä¸ç¦è¦é—®ï¼Œgolangé‡Œé¢funcitonå’Œclosureæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ‰’æ‹‰äº†ä¸‹æºç ï¼Œè¿™é‡Œç®€å•æ€»ç»“ä¸‹ã€‚</p>
<h1 id="1-golangä¸­å‡½æ•°å†…éƒ¨è¡¨ç¤ºæ˜¯ä»€ä¹ˆæ ·å­çš„">1 golangä¸­å‡½æ•°å†…éƒ¨è¡¨ç¤ºæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ</h1>
<p>çœ‹ä¸‹golang cmd/compile/internal/types/type.goä¸­å¯¹Funcç±»å‹çš„å®šä¹‰ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// Func contains Type fields specific to func types.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Func</span> <span style="color:#66d9ef">struct</span> {
   <span style="color:#a6e22e">Receiver</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Type</span>  <span style="color:#75715e">// function receiverï¼Œæ¥å—è€…ç±»å‹ï¼Œæ¯ä¸ªå‡½æ•°å®šä¹‰éƒ½åŒ…æ‹¬è¯¥å­—æ®µï¼Œå¯ä»¥ä¸ºnilæˆ–non-nil
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">Results</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">Type</span>   <span style="color:#75715e">// function resultsï¼Œè¿”å›å€¼ç±»å‹
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">Params</span>   <span style="color:#f92672">*</span><span style="color:#a6e22e">Type</span> <span style="color:#75715e">// function paramsï¼Œå‚æ•°åˆ—è¡¨ç±»å‹
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">Nname</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Node</span>   <span style="color:#75715e">// function nameï¼Œå‡½æ•°å
</span><span style="color:#75715e"></span>   <span style="color:#75715e">// Argwid is the total width of the function receiver, params, and results.
</span><span style="color:#75715e"></span>   <span style="color:#75715e">// It gets calculated via a temporary TFUNCARGS type.
</span><span style="color:#75715e"></span>   <span style="color:#75715e">// Note that TFUNC&#39;s Width is Widthptr.
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">Argwid</span> <span style="color:#66d9ef">int64</span>
   <span style="color:#a6e22e">Outnamed</span> <span style="color:#66d9ef">bool</span> <span style="color:#75715e">// æ˜¯å¦æ˜¯å¯å¯¼å‡ºçš„ï¼Ÿ
</span><span style="color:#75715e"></span>}
</code></pre></div><p>é€šè¿‡è¿™ä¸ªFuncå®šä¹‰æ¥çœ‹ï¼Œå…¶å¯ä»¥è¦†ç›–golangé‡Œé¢æ‰€æœ‰çš„å‡½æ•°ç±»å‹å£°æ˜äº†ï¼Œä¸ç®¡æ˜¯æ™®é€šå‡½æ•°ï¼Œè¿˜æ˜¯æˆå‘˜æ–¹æ³•ç­‰ç­‰ã€‚</p>
<h1 id="2-golangä¸­é—­åŒ…æ˜¯æ€ä¹ˆå®ç°çš„">2 golangä¸­é—­åŒ…æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</h1>
<p>å‰ç«¯æ—¶é—´ç»„å†…åˆ†äº«é—­åŒ…ä½¿ç”¨çš„æ—¶å€™ï¼Œè§‰å¾—è¿™ç©æ„è™½ç„¶è½»å·§ä½†æ˜¯å¤ªå®¹æ˜“å‡ºé”™äº†ï¼Œç©¶å…¶åŸå› æ˜¯å› ä¸ºä¸äº†è§£é—­åŒ…çš„å®ç°åŸç†ã€‚é‚£ä¹ˆé—­åŒ…æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼ŒæŠ½æ—¶é—´æ‰’æ‹‰äº†ä¸€ä¸‹golangä¸­å®ç°é—­åŒ…çš„ä»£ç ï¼Œçœ‹å®Œåç¬é—´è§‰å¾—é—­åŒ…å¾ˆç®€å•ã€‚</p>
<p>æ¥ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œ<strong>é—­åŒ…å°±æ˜¯å‡½æ•°+ç¯å¢ƒ</strong>ï¼Œé—®é¢˜æ˜¯<strong>è¿™é‡Œçš„ç¯å¢ƒæ˜¯å¦‚ä½•ä¸å‡½æ•°è¿›è¡Œç»‘å®šçš„å‘¢</strong>ï¼Ÿ</p>
<blockquote>
<p>remark: ä¸€å¼€å§‹çœ‹äº†ä¸Šé¢çš„Funcç±»å‹å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¥ä¸ºæ˜¯golangåˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿçš„ç±»å‹ï¼ˆé‡Œé¢å„ä¸ªå­—æ®µå€¼ä¸ºé—­åŒ…æ•è·çš„å˜é‡å€¼ï¼‰ç„¶åå°†è¯¥è™šæ‹Ÿç±»å‹ä½œä¸ºreceiver-typeæ¥å®ç°çš„å‘¢ï¼Œå¯æ˜¯ä»”ç»†ä¸€æƒ³è¿™ç§æ€è·¯ç«™ä¸ä½è„šï¼Œå› ä¸ºé—­åŒ…æ˜¯golangé‡Œé¢çš„first-class citizenï¼Œé—­åŒ…å®ç°åº”è¯¥éå¸¸è½»é‡æ‰å¯¹ï¼Œå¦‚æœåƒæˆ‘æœ€åˆè¿™ç§æƒ³æ³•é‚£å®åœ¨æ˜¯å¤ªå¤æ‚äº†ï¼Œæƒ³æƒ³è¦åˆ›å»ºå¤šå°‘è™šæ‹Ÿç±»å‹åŠå…¶å¯¹è±¡å§ã€‚</p>
</blockquote>
<p>çœ‹äº†ä¸‹æºä»£ç ï¼Œæ€»ç»“ä¸€ä¸‹golangä¸­çš„å®ç°æ€è·¯ï¼Œè€ƒè™‘åˆ°é—­åŒ…å¯¹è±¡æ˜¯å¦èƒ½é‡å¤ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸¤ä¸ªåœºæ™¯è¿›è¡Œå¤„ç†ï¼š</p>
<p><strong>1) å‡å¦‚é—­åŒ…å®šä¹‰åç«‹å³è¢«è°ƒç”¨</strong>
å› ä¸ºåªä¼šè¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åº”è¯¥åŠ›å›¾é¿å…é—­åŒ…å¯¹è±¡çš„å†…å­˜åˆ†é…æ“ä½œï¼Œé‚£æ€ä¹ˆä¼˜åŒ–ä¸€ä¸‹å‘¢ï¼Œä»¥ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä¸ºä¾‹ã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span>) {
    println(<span style="color:#a6e22e">byval</span>)
    <span style="color:#a6e22e">byref</span><span style="color:#f92672">++</span>
}(<span style="color:#ae81ff">42</span>)
</code></pre></div><p>ä¸Šé¢çš„é—­åŒ…å°†è¢«è½¬æ¢ä¸ºç®€å•å‡½æ•°è°ƒç”¨çš„å½¢å¼ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">byval</span> <span style="color:#66d9ef">int</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">byref</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">a</span> <span style="color:#66d9ef">int</span>) {
    println(<span style="color:#a6e22e">byval</span>)
    (<span style="color:#f92672">*&amp;</span><span style="color:#a6e22e">byref</span>)<span style="color:#f92672">++</span>
}(<span style="color:#a6e22e">byval</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">byref</span>, <span style="color:#ae81ff">42</span>)
</code></pre></div><p>æ³¨æ„çœ‹å‡½æ•°åŸå‹çš„å˜åŒ–ï¼ŒåŸæ¥é—­åŒ…é‡Œé¢æ•è·çš„å˜é‡éƒ½è¢«è½¬æ¢æˆäº†é€šè¿‡å‡½æ•°å‚æ•°æ¥ä¾›å€¼ï¼š</p>
<ul>
<li>å› ä¸ºprintlnæ“ä½œä¸æ¶‰åŠå¯¹byvalå˜é‡çš„ä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥æ˜¯æŒ‰å€¼æ•è·ï¼›</li>
<li>è€Œbyref++æ¶‰åŠåˆ°å¯¹æ•è·å˜é‡çš„ä¿®æ”¹ï¼Œæ‰€ä»¥æ˜¯æŒ‰å¼•ç”¨æ•è·ï¼Œå¯¹äºæŒ‰å¼•ç”¨æ•è·çš„å˜é‡ä¼šè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œgolangç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°†æŒ‰å¼•ç”¨æ•è·çš„å˜é‡åbyrefè½¬æ¢æˆâ€œ&amp;byrefâ€ï¼ŒåŒæ—¶å°†å…¶ç±»å‹è½¬æ¢æˆpointerç±»å‹ï¼Œæ•è·å˜é‡å¯¹åº”çš„å†™æ“ä½œä¹Ÿä¼šè½¬æ¢ä¸ºé€šè¿‡pointeræ¥æ“ä½œã€‚</li>
</ul>
<p><strong>2ï¼‰ å‡å¦‚é—­åŒ…å®šä»¥åå¹¶ä¸æ˜¯ç«‹å³è°ƒç”¨</strong>
é—­åŒ…å®šä¹‰åä¸æ˜¯ç«‹å³ä½¿ç”¨ï¼Œè€Œæ˜¯åç»­è°ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹åŒä¸€ä¸ªé—­åŒ…å¯èƒ½è°ƒç”¨å¤šæ¬¡ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦åˆ›å»ºé—­åŒ…å¯¹è±¡ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ</p>
<ul>
<li>å¦‚æœå˜é‡æ˜¯æŒ‰å€¼æ•è·ï¼Œå¹¶ä¸”è¯¥å˜é‡å ç”¨å­˜å‚¨ç©ºé—´å°äº2*sizeof(int)ï¼Œé‚£ä¹ˆå°±é€šè¿‡åœ¨å‡½æ•°ä½“å†…åˆ›å»ºå±€éƒ¨å˜é‡çš„å½¢å¼æ¥shadowæ•è·çš„å˜é‡ï¼Œç›¸æ¯”äºé€šè¿‡å¼•ç”¨æ•è·ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„åº”è¯¥æ˜¯è€ƒè™‘åˆ°å‡å°‘å¼•ç”¨æ•°é‡ã€å‡å°‘é€ƒé€¸åˆ†æç›¸å…³çš„è®¡ç®—ã€‚</li>
<li>å¦‚æœå˜é‡æ˜¯æŒ‰å¼•ç”¨æ•è·ï¼Œæˆ–è€…æŒ‰å€¼æ•è·ä½†æ˜¯æ•è·çš„å˜é‡å ç”¨å­˜å‚¨ç©ºé—´è¾ƒå¤§ï¼ˆæ‹·è´åˆ°æœ¬åœ°åšå±€éƒ¨å˜é‡ä»£ä»·å¤ªå¤§ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹å°±å°†æ•è·çš„å˜é‡varè½¬æ¢æˆpointerç±»å‹çš„â€œ&amp;varâ€ï¼Œå¹¶åœ¨å‡½æ•°prologueé˜¶æ®µå°†å…¶åˆå§‹åŒ–ä¸ºæ•è·å˜é‡çš„å€¼ã€‚</li>
</ul>
<p>è¿™éƒ¨åˆ†çš„ä»£ç è¯¦è§ï¼šcmd/compile/gc/closure.goä¸­çš„æ–¹æ³•transformclosure(&hellip;)ã€‚
é—­åŒ…å°±æ˜¯å‡½æ•°ä½“+ç¯å¢ƒï¼Œç¯å¢ƒå°±æ˜¯åƒè¿™æ ·ç»‘å®šçš„ã€‚</p>
<h1 id="3-æ€»ç»“">3 æ€»ç»“</h1>
<p>æœ¬æ–‡ç®€è¦æè¿°äº†golangä¸­å¯¹å‡½æ•°çš„å†…éƒ¨å®šä¹‰ï¼Œä»¥åŠé—­åŒ…çš„å¤§è‡´å®ç°æ€è·¯ï¼ŒåŠ æ·±äº†ç†è§£ã€‚</p>
<h1 id="é™„golangé—­åŒ…å¤„ç†å…³é”®ä»£ç ">é™„ï¼šgolangé—­åŒ…å¤„ç†å…³é”®ä»£ç </h1>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">transformclosure</span>(<span style="color:#a6e22e">xfunc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Node</span>) {
	<span style="color:#a6e22e">lno</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lineno</span>
	<span style="color:#a6e22e">lineno</span> = <span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Pos</span>
	<span style="color:#a6e22e">func_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Closure</span>

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">func_</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Top</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Ecall</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#75715e">// If the closure is directly called, we transform it to a plain function call
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// with variables passed as args. This avoids allocation of a closure object.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Here we do only a part of the transformation. Walk of OCALLFUNC(OCLOSURE)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// will complete the transformation later.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// For illustration, the following closure:
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	func(a int) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//		println(byval)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//		byref++
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	}(42)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// becomes:
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	func(byval int, &amp;byref *int, a int) {
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//		println(byval)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//		(*&amp;byref)++
</span><span style="color:#75715e"></span>		<span style="color:#75715e">//	}(byval, &amp;byref, 42)
</span><span style="color:#75715e"></span>
		<span style="color:#75715e">// f is ONAME of the actual function.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Nname</span>

		<span style="color:#75715e">// We are going to insert captured variables before input args.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">params</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">Field</span>
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">decls</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Node</span>
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">func_</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Cvars</span>.<span style="color:#a6e22e">Slice</span>() {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">OXXX</span> {
				<span style="color:#66d9ef">continue</span>
			}
			<span style="color:#a6e22e">fld</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NewField</span>()
			<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Funarg</span> = <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">FunargParams</span>
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Byval</span>() {
				<span style="color:#75715e">// If v is captured by value, we merely downgrade it to PPARAM.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">SetClass</span>(<span style="color:#a6e22e">PPARAM</span>)
				<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Nname</span> = <span style="color:#a6e22e">asTypesNode</span>(<span style="color:#a6e22e">v</span>)
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#75715e">// If v of type T is captured by reference,
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// we introduce function param &amp;v *T
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// and v remains PAUTOHEAP with &amp;v heapaddr
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// (accesses will implicitly deref &amp;v).
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">addr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newname</span>(<span style="color:#a6e22e">lookup</span>(<span style="color:#e6db74">&#34;&amp;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Sym</span>.<span style="color:#a6e22e">Name</span>))
				<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">Type</span> = <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NewPtr</span>(<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>)
				<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">SetClass</span>(<span style="color:#a6e22e">PPARAM</span>)
				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Param</span>.<span style="color:#a6e22e">Heapaddr</span> = <span style="color:#a6e22e">addr</span>
				<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Nname</span> = <span style="color:#a6e22e">asTypesNode</span>(<span style="color:#a6e22e">addr</span>)
			}

			<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Type</span> = <span style="color:#a6e22e">asNode</span>(<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Nname</span>).<span style="color:#a6e22e">Type</span>
			<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Sym</span> = <span style="color:#a6e22e">asNode</span>(<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Nname</span>).<span style="color:#a6e22e">Sym</span>

			<span style="color:#a6e22e">params</span> = append(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">fld</span>)
			<span style="color:#a6e22e">decls</span> = append(<span style="color:#a6e22e">decls</span>, <span style="color:#a6e22e">asNode</span>(<span style="color:#a6e22e">fld</span>.<span style="color:#a6e22e">Nname</span>))
		}

		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">params</span>) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#75715e">// Prepend params and decls.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Type</span>.<span style="color:#a6e22e">Params</span>().<span style="color:#a6e22e">SetFields</span>(append(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Type</span>.<span style="color:#a6e22e">Params</span>().<span style="color:#a6e22e">FieldSlice</span>()<span style="color:#f92672">...</span>))
			<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Dcl</span> = append(<span style="color:#a6e22e">decls</span>, <span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Dcl</span><span style="color:#f92672">...</span>)
		}

		<span style="color:#a6e22e">dowidth</span>(<span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Type</span>)
		<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Type</span> = <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Type</span> <span style="color:#75715e">// update type of ODCLFUNC
</span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> {
		<span style="color:#75715e">// The closure is not called, so it is going to stay as closure.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">body</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">Node</span>
		<span style="color:#a6e22e">offset</span> <span style="color:#f92672">:=</span> int64(<span style="color:#a6e22e">Widthptr</span>)
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">func_</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Cvars</span>.<span style="color:#a6e22e">Slice</span>() {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Op</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">OXXX</span> {
				<span style="color:#66d9ef">continue</span>
			}

			<span style="color:#75715e">// cv refers to the field inside of closure OSTRUCTLIT.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">cv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">nod</span>(<span style="color:#a6e22e">OCLOSUREVAR</span>, <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>)

			<span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">Type</span> = <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Byval</span>() {
				<span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">Type</span> = <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NewPtr</span>(<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>)
			}
			<span style="color:#a6e22e">offset</span> = <span style="color:#a6e22e">Rnd</span>(<span style="color:#a6e22e">offset</span>, int64(<span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">Type</span>.<span style="color:#a6e22e">Align</span>))
			<span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">Xoffset</span> = <span style="color:#a6e22e">offset</span>
			<span style="color:#a6e22e">offset</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">cv</span>.<span style="color:#a6e22e">Type</span>.<span style="color:#a6e22e">Width</span>

			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Byval</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>.<span style="color:#a6e22e">Width</span> <span style="color:#f92672">&lt;=</span> int64(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">Widthptr</span>) {
				<span style="color:#75715e">// If it is a small variable captured by value, downgrade it to PAUTO.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">SetClass</span>(<span style="color:#a6e22e">PAUTO</span>)
				<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Dcl</span> = append(<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Dcl</span>, <span style="color:#a6e22e">v</span>)
				<span style="color:#a6e22e">body</span> = append(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">nod</span>(<span style="color:#a6e22e">OAS</span>, <span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">cv</span>))
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#75715e">// Declare variable holding addresses taken from closure
</span><span style="color:#75715e"></span>				<span style="color:#75715e">// and initialize in entry prologue.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">addr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newname</span>(<span style="color:#a6e22e">lookup</span>(<span style="color:#e6db74">&#34;&amp;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Sym</span>.<span style="color:#a6e22e">Name</span>))
				<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">Type</span> = <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NewPtr</span>(<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>)
				<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">SetClass</span>(<span style="color:#a6e22e">PAUTO</span>)
				<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">SetUsed</span>(<span style="color:#66d9ef">true</span>)
				<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Curfn</span> = <span style="color:#a6e22e">xfunc</span>
				<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Dcl</span> = append(<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Dcl</span>, <span style="color:#a6e22e">addr</span>)
				<span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Param</span>.<span style="color:#a6e22e">Heapaddr</span> = <span style="color:#a6e22e">addr</span>
				<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">Byval</span>() {
					<span style="color:#a6e22e">cv</span> = <span style="color:#a6e22e">nod</span>(<span style="color:#a6e22e">OADDR</span>, <span style="color:#a6e22e">cv</span>, <span style="color:#66d9ef">nil</span>)
				}
				<span style="color:#a6e22e">body</span> = append(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">nod</span>(<span style="color:#a6e22e">OAS</span>, <span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">cv</span>))
			}
		}

		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">body</span>) &gt; <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">typecheckslice</span>(<span style="color:#a6e22e">body</span>, <span style="color:#a6e22e">Etop</span>)
			<span style="color:#a6e22e">walkstmtlist</span>(<span style="color:#a6e22e">body</span>)
			<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">Enter</span>.<span style="color:#a6e22e">Set</span>(<span style="color:#a6e22e">body</span>)
			<span style="color:#a6e22e">xfunc</span>.<span style="color:#a6e22e">Func</span>.<span style="color:#a6e22e">SetNeedctxt</span>(<span style="color:#66d9ef">true</span>)
		}
	}

	<span style="color:#a6e22e">lineno</span> = <span style="color:#a6e22e">lno</span>
}
</code></pre></div>
    </div>

    <br>
    <br>
    
    <div align="center">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡ï¼š<span id="busuanzi_value_site_pv"></span>æ¬¡ /// 
</span>
<span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°ï¼š<span id="busuanzi_value_site_uv"></span>äººæ¬¡ ///
</span>
<span id="busuanzi_container_page_pv">
        æœ¬æ–‡æ€»é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
</span>

    </div>

    <div align="center">
    
<div class="blog-share">
    åˆ†äº«ï¼š
    
    <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=golang%20function-closure%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%20https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        <span class="hidden">Twitter</span>
    </a>
    
    
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f"  onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="fab fa-facebook-f"></i>
        <span class="hidden">Facebook</span>
    </a>
    
    
    <a class="icon-pinterest" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f&amp;description=golang%20function-closure%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <i class="fab fa-pinterest-p"></i>
        <span class="hidden">Pinterest</span>
    </a>
    
    
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-function-closure%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <i class="fab fa-google-plus-g"></i>
        <span class="hidden">Google+</span>
    </a>
    
</div>



    </div>


    
    <br>
    <br>
    <div style="height:auto;align:center;text-align:center;"> 
        <div>
        <p>
            ~~~ å¦‚æœæ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·è®°å¾—æ‰“èµå“¦ã€‚å¸®æˆ‘å®¶å°ä¸ƒğŸ¶ã€å…ƒå®ğŸ±æ”¹å–„ä¸‹ä¼™é£Ÿå§ï¼ŒğŸ˜˜ ~~~
        </p>
        </div>

        <div>
            <img src="/common/xiaoqi.png" style="height:238px;margin-top:10px;margin-right:5px;"/>
            <img src="/common/qrcode.jpg" style="height:238px;margin-top:10px;"/>
            <img src="/common/yuanbao.png" style="height:238px;margin-top:10px;margin-left:5px;"/>
        </div>
    </div>

    



                
                <div class="container">
    <hr>
</div>
<div class="container has-text-centered top-pad">
    <a href="#top">
        <i class="fa fa-arrow-up"></i>
    </a>
</div>

<div class="container">
    <hr>
</div>

                <div class="section" id="footer">
    <div class="container has-text-centered">
    
        <span class="footer-text">
            <a href="https://github.com/victoriadrake/hugo-theme-introduction/"><strong>Introduction</strong></a> ä¸»é¢˜ä¸º <a href="http://gohugo.io/">Hugo</a> è€Œè®¾ã€‚ç”±å¼€æºç¤¾ç¾¤è´¡çŒ®è€…ä»¥ <a href="https://victoria.dev"><!-- raw HTML omitted --><!-- raw HTML omitted --> å’Œ <!-- raw HTML omitted --><!-- raw HTML omitted --></a> åˆ›é€ ã€‚
        </span>
    
    </div>
</div>

                
            </div>
        </section>
        
        


<script src="https://hitzhangjie.github.io/js/bundle.e6934e69d06bb8a213134f4c1468f9478bb7755e786dfb60e3c5a917c5335805.js" integrity="sha256-5pNOadBruKITE09MFGj5R4u3dV54bftg48WpF8UzWAU="></script>



        
        
        
        
    </body>
</html>
