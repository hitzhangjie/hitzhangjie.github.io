var suggestions=document.getElementById('suggestions'),search=document.getElementById('search');search!==null&&document.addEventListener('keydown',inputFocus);function inputFocus(a){a.ctrlKey&&a.key==='/'&&(a.preventDefault(),search.focus()),a.key==='Escape'&&(search.blur(),suggestions.classList.add('d-none'))}document.addEventListener('click',function(a){var b=suggestions.contains(a.target);b||suggestions.classList.add('d-none')}),document.addEventListener('keydown',suggestionFocus);function suggestionFocus(c){const d=suggestions.classList.contains('d-none');if(d)return;const a=[...suggestions.querySelectorAll('a')];if(a.length===0)return;const b=a.indexOf(document.activeElement);if(c.key==="ArrowUp"){c.preventDefault();const d=b>0?b-1:0;a[d].focus()}else if(c.key==="ArrowDown"){c.preventDefault();const d=b+1<a.length?b+1:b;a[d].focus()}}(function(){var a=new FlexSearch.Document({tokenize:function(a){return a.split(/\W+/).concat(a.replace(/[\x00-\x7F]/g,'').split('')).filter(a=>!!a)},cache:100,document:{id:'id',store:["href","title","description"],index:["title","description","content"]}});a.add({id:0,href:"/journey/education/education/",title:"æ•™è‚²ç»å†",description:'â€œæ•™è‚²ç»å†"',content:"   æ—¶é—´æ®µ é˜¶æ®µ å­¦æ ¡ ä¸“ä¸šæ–¹å‘     2013.9~2016.7 ç ”ç©¶ç”Ÿ å››å·å¤§å­¦ è®¡ç®—æœºåº”ç”¨æŠ€æœ¯,ç½‘ç»œå®‰å…¨   2009.9~2013.7 æœ¬ç§‘ å“ˆå°”æ»¨å·¥ä¸šå¤§å­¦ è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯,è½¯ä»¶å·¥ç¨‹    æ±‚å­¦å†ç¨‹æ˜¯äººç”Ÿçš„ä¸€ä¸ªé˜¶æ®µï¼Œæ˜¯åŠªåŠ›è¿ˆå‘ä¸‹ä¸ªé˜¶æ®µçš„æ–°èµ·ç‚¹\nç”Ÿæ´»ä¸­å¤„å¤„æœ‰å­¦é—®ï¼Œå·¥ä½œä¸­ä¹Ÿä¸ä¹æœ‰ä»·å€¼çš„é—®é¢˜ï¼Œå¤šæ€è€ƒå¤šå®è·µ ğŸ¶\n"}),a.add({id:1,href:"/journey/education/hit/",title:"æœ¬ç§‘æ•™è‚²",description:"xxx.md # ",content:"xxx.md # "}),a.add({id:2,href:"/journey/introduction/",title:"æœ¬èŠ‚ä»‹ç»",description:"åœ¨è¿™é‡Œè®°å½•ä¸‹æ—¥å¸¸ç”Ÿæ´»ä¸­çš„æ‰€æ€ã€æ‰€æƒ³ã€‚\nå†™ä»€ä¹ˆå‘¢ï¼Ÿéšä¾¿å†™ï¼Œç›®çš„æ˜¯å’Œè‡ªå·±å¯¹è¯ã€‚",content:"åœ¨è¿™é‡Œè®°å½•ä¸‹æ—¥å¸¸ç”Ÿæ´»ä¸­çš„æ‰€æ€ã€æ‰€æƒ³ã€‚\nå†™ä»€ä¹ˆå‘¢ï¼Ÿéšä¾¿å†™ï¼Œç›®çš„æ˜¯å’Œè‡ªå·±å¯¹è¯ã€‚\n"}),a.add({id:3,href:"/journey/education/scu/",title:"ç ”ç©¶ç”Ÿæ•™è‚²",description:"ç ”ç©¶ç”Ÿæ•™è‚²",content:"æˆ‘æ˜¯æ€ä¹ˆå»è¯»ç ”çš„ï¼Ÿ # è€ƒç ” or åä¸º # 13å¹´è€ƒç ”æ—¶ï¼Œæˆ‘å¿ƒé‡Œå…¶å®æ²¡æœ‰å¾ˆæ˜ç¡®çš„ç›®æ ‡ï¼Œè¦è¯»ä¸ªä»€ä¹ˆæ–¹å‘ï¼Œæˆ–è€…è¦å»å“ªé‡Œå·¥ä½œã€‚è€ƒç ”ä¹‹å‰ï¼Œå¾ˆå¤šåŒå­¦éƒ½å»å‚åŠ ç§‹æ‹›äº†ï¼Œä¸œå¥”è¥¿è·‘çš„ï¼Œé‚£æ—¶å€™åä¸ºæ¥æ ¡å›­æ‹›è˜ï¼Œæˆ‘ä¹Ÿä¸æƒ³ä¸œè·‘è¥¿è·‘çš„ï¼Œäºæ˜¯å°±è¿‘å‚åŠ äº†åä¸ºçš„æ ¡æ‹›ï¼Œä¸€ä¸ªä¸‹åˆè¿‡å®Œå‡ è½®é¢è¯•ï¼Œå½“å¤©æ™šä¸Šå‘äº†Offerã€‚\nè‡ªå·±å½“æ—¶åœ¨è½¯ä»¶ã€è®¡ç®—åŒå­¦é‡Œé¢ç®—æ˜¯å­¦çš„æ¯”è¾ƒå¥½çš„ï¼Œå°¤å…¶æ˜¯ä¸“ä¸šè¯¾æ–¹é¢ï¼Œå¥½å‡ ä¸ªä¿ç ”çš„åŒå­¦å¹³æ—¶åšè¯¾è®¾ã€å®éªŒéƒ½æ˜¯æˆ‘æŒ‡å¯¼çš„ï¼Œä¹Ÿæ²¡ä»€ä¹ˆéœ€è¦é®é®æ©æ©çš„ä¸æ˜¯ã€‚æˆ‘é‚£æ—¶å€™å°±æ˜¯è´ªç©ï¼Œå¿ƒé‡Œè¿˜æƒ³ç€è€ƒç ”ï¼Œä½†æ˜¯å‡†å¤‡çš„ä¹Ÿä¸æ˜¯ç‰¹åˆ«è®¤çœŸï¼Œä¹Ÿæ²¡å‚åŠ è¿‡è€ƒç ”è¾…å¯¼ç­åŸ¹è®­ï¼Œæ€»ä¹‹æœ€å340+ï¼Œä½†æ˜¯æœ‰ä¸€é—¨å¡å°çº¿ï¼Œä¸è¦æˆ‘ã€‚\né‚£ä¸ªæ—¶å€™çœŸçš„æ˜¯å¾ˆå•çº¯ï¼Œè·Ÿé¢è¯•å®˜è¯´æˆ‘è¦è€ƒç ”ï¼Œå¯èƒ½ä¼šè¿çº¦ï¼Œä½†æ˜¯é¢è¯•å®˜è¿˜æ˜¯ç»™äº†æˆ‘Offerï¼ŒåŠæˆ‘è€ƒè™‘ä¸‹å»åä¸ºè¿™æ ·çš„å¹³å°é”»ç‚¼ï¼Œå¯¹æˆ‘å¸®åŠ©å¯èƒ½æ›´å¤§ã€‚æˆ‘é€‰æ‹©å—ç ”æ‰€çš„æ—¶å€™ï¼Œè¿˜åŠæˆ‘è¦ä¸è¦ä¼˜å…ˆè€ƒè™‘æ·±åœ³ã€‚ç°åœ¨æ¥äº†æ·±åœ³å·¥ä½œå‡ å¹´ä¹‹åï¼ŒçœŸçš„æ˜¯æœ‰ç‚¹åæ‚”å½“å¹´çš„é€‰æ‹©å•Šï¼\nè°ƒå‰‚ or åä¸º # 13å¹´è€ƒç ”æˆç»©å‡ºæ¥åï¼Œå‘ç°æ²¡è¿‡ï¼Œæˆ‘çœ‹äº†ä¸‹è€ƒä¸Šçš„èƒ½æŠ¥çš„æ–¹å‘ï¼Œå¿ƒé‡Œæ¾äº†å£æ°”ï¼Œæˆ‘æƒ³å­¦çš„å®‰å…¨æ–¹å‘æ—©å°±è¢«ä¿ç ”çš„å æ»¡äº†ï¼Œè€ƒä¸Šäº†ä¹Ÿæ˜¯é€‰å…¶ä»–æ–¹å‘ï¼Œè‡ªå·±ä¹Ÿä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œé‚£å°±å‡†å¤‡å·¥ä½œå§ã€‚åé¢å®‰å¿ƒåšæ¯•è®¾äº†ï¼Œç›´åˆ°æœ‰ä¸€å¤©å››å·å¤§å­¦å›¾åƒæ‰€è€å¸ˆç»™æˆ‘ç”µè¯ï¼Œçœ‹åˆ°äº†æˆ‘å¡«è¿‡çš„ä¸€åˆ™è°ƒå‰‚ä¿¡æ¯ï¼Œé—®æˆ‘è¦ä¸è¦å»è¯•è¯•ã€‚å°±å»äº†å››å·æˆéƒ½ï¼Œç¬¬ä¸€å¤©é¢å®Œå›¾åƒæ‰€ï¼Œå›¾åƒæ‰€è€å¸ˆè§‰å¾—æˆ‘æŒºä¸é”™ï¼Œæƒ³ç•™æˆ‘ï¼Œå¸¦æˆ‘çœ‹ä»–ä»¬å›¾åƒæ‰€å®éªŒå®¤ï¼Œç¡®å®å¾ˆæ£’å•Šã€‚ç¬¬äºŒå¤©çœ‹åˆ°ç½‘ç»œå®‰å…¨å®éªŒå®¤ä¹Ÿæœ‰è°ƒå‰‚ä¿¡æ¯ï¼Œæˆ‘åˆå»é¢äº†ä¸‹ï¼Œç»“æœç½‘ç»œå®‰å…¨æ–¹å‘ï¼ˆæœ‰3ä¸ªå®éªŒå®¤ï¼‰ã€æ•°æ®æŒ–æ˜æ–¹å‘çš„å‡ ä¸ªè€å¸ˆä¹Ÿæƒ³è¦æˆ‘ã€‚\né€‰æ‹©å…¶å®æŒºé‡è¦çš„ï¼Œæˆ‘å½“æ—¶æ”¾å¼ƒäº†ä¸Šé¢æ‰€æœ‰æœºä¼šï¼Œé€‰äº†å¦ä¸€ä¸ªå®éªŒå®¤çš„å¯¼å¸ˆã€‚å¯¼å¸ˆå‡ºå›½åšè®¿é—®å­¦è€…äº†ï¼Œå¼€å­¦åæ‰è§åˆ°ï¼Œå¯¼å¸ˆæ˜¯æŒºå‰å®³ï¼Œåªæ˜¯ä»–å›å›½åè‡ªç«‹é—¨æˆ·äº†ï¼Œæˆ‘ä¹Ÿå°±åŸºæœ¬æ²¡æ¥è§¦åˆ°å®‰å…¨ç›¸å…³çš„å¤ªå¤šä¸œè¥¿ï¼Œæœ‰ä¹Ÿæ˜¯è‡ªå·±çç¢ç£¨ã€‚å¯¼å¸ˆä¹ŸæŒºè´Ÿè´£ï¼Œæ‰¾é¡¹ç›®ç»™è‡ªå·±é”»ç‚¼ï¼Œæ‰¾æœºä¼šè®©è‡ªå·±å¸¦å›¢é˜Ÿï¼Œä¹ŸæŒºæ„Ÿè°¢è€å¸ˆçš„ã€‚è‡ªå·±ä¹Ÿæœ‰æ—¶é—´å­¦äº†ç‚¹è‡ªå·±æ„Ÿå…´è¶£çš„ä¸œè¥¿ï¼Œä½†æ˜¯ï¼Œå¼¯è·¯çš„ç¡®æ²¡æœ‰å°‘èµ°ï¼Œå¦‚æœæ—©ç‚¹å·¥ä½œçš„è¯ï¼Œå¯èƒ½å¯¹è‡ªå·±æå‡ä¼šæ›´å¿«ã€‚å½“ç„¶ï¼Œæˆ‘ä¾æ—§å¯¹è¿™æ®µç»å†å¿ƒæ€€æ„Ÿæ¿€ï¼Œå¥½çš„åçš„ï¼Œå®ƒéƒ½è®©æˆ‘æœ‰æ‰€æ”¶è·ã€‚\né‚£æ—¶å€™è¿˜æ˜¯æœ‰ç‚¹ä¹¦ç”Ÿæ°”å§ï¼Œæƒ³åœ¨å­¦æ ¡é‡Œå¤šå¾…å‡ å¹´ï¼Œçˆ¶æ¯è™½ä¸æ‡‚ä½†ä¹Ÿæ”¯æŒæˆ‘ç»§ç»­ï¼Œæœ€åå°±å’Œåä¸ºåŠäº†è¿çº¦ã€‚å› ä¸ºè¿™äº‹å§ï¼Œæˆ‘åœ¨å¿ƒé‡Œä¸€ç›´æ˜¯é«˜çœ‹åä¸ºä¸€çœ¼ï¼Œå¹³æ—¶ä¹Ÿå…³æ³¨åä¸ºçš„åŠ¨æ€ï¼Œå¦‚æœå¯ä»¥å¸Œæœ›ä»¥åæœ‰æœºä¼šå§ã€‚\nç ”ç©¶ç”Ÿæ˜¯æ€ä¹ˆè¿‡çš„ï¼Ÿ # æˆéƒ½ï¼ŒçœŸçš„æ˜¯ä¸ªæŒºä¸é”™çš„åŸå¸‚ï¼Œæˆ‘ä¹Ÿå¾ˆæƒ³å†™ç‚¹è‡ªå·±å½“æ—¶åœ¨æˆéƒ½çš„ç”Ÿæ´»ä½“æ‚Ÿï¼Œå°±å€Ÿç€è¿™ä¸ªæœºä¼šçå†™å†™å§ã€‚\næˆéƒ½ç¡®å®å¾ˆå®‰é€¸ # ç¬¬ä¸€æ¬¡å»æˆéƒ½å°±æ˜¯è€ƒç ”è°ƒå‰‚çš„æ—¶å€™ï¼Œå½“æ—¶å»ä¸€ä¸ªå°é¦†å­é‡Œé¢åƒé¥­ï¼Œè€æ¿ç«¯ä¸Šæ¥ä¸€â€œæ¡¶â€ç±³é¥­ï¼Œæˆ‘å¯æ²¡é‚£ä¹ˆå¤šé’±å•Šï¼ŒåŒ—æ–¹ä¸€ç¢—ç±³é¥­è¦1ï¿¥å§ã€‚å½“å³é—®è€æ¿ï¼Œåƒä¸äº†è¿™ä¹ˆå¤šå•Šâ€¦â€¦åŸæ¥æ˜¯éšä¾¿åƒçš„æ„æ€ :)\nå››å·å¤§å­¦æ˜¯ç»¼åˆæ€§å¤§å­¦ï¼Œå’Œæˆ‘ä»¬å“ˆå·¥å¤§è¿™ç±»å·¥ç§‘é™¢æ ¡ä¸åŒï¼Œæˆ‘æœ€å¤§çš„æ„Ÿå—å°±æ˜¯ï¼Œæ ¡å›­é‡Œæ´»åŠ¨æ¯”è¾ƒä¸°å¯Œï¼Œå„ä¸“ä¸šäº¤ç»‡ç¢°æ’çš„æ°”æ¯æ›´æµ“åšä¸€ç‚¹ï¼Œå¦¹å­ä¹Ÿæ¯”è¾ƒå¤šã€‚\nè¯´åˆ°è¿™é‡Œï¼Œæƒ³èµ·ä¸€ä¸ªçœŸå®çš„ç¬‘è¯ï¼Œæˆ‘ä¸€ä¸ªå“¥ä»¬è¯´ä»–ä»¬ç­å¼€å­¦å‰ï¼Œçœ‹åå•æœ‰ä¸¤ä¸ªå¦¹å­ï¼Œç»“æœå¼€å­¦åä¸€ä¸ªå¦¹å­ç›´æ¥æ²¡æ¥åªå‰©ä¸€ä¸ªå¦¹å­ã€‚å°±æ˜¯ç”·å¥³æ¯”ä¾‹æä¸åè°ƒï¼Œè¿æˆ‘ä»¬è®¡ç®—æœºä¸“ä¸šä¹Ÿç®—ä¸Šå§ï¼Œä¸€ä¸ªç­3~4ä¸ªå¦¹å­ï¼Œæ¯æ¬¡ä¸€ä¸Šå¤§è¯¾çš„æ—¶å€™ï¼Œç”·åŒå­¦ä»¬æŒ¤åœ¨ä¸€èµ·è¯´å“ªä¸ªå¦¹å­å¥½çœ‹ï¼Œå°¼ç›ï¼Œè¿ç­ä¸»ä»»éƒ½æ‰¹æˆ‘ä»¬ç­ç”·ç”Ÿä¸ç»™åŠ›ï¼Œè‡ªå·±ç­å¦¹å­è¢«è¿½èµ°äº†ä¹Ÿçœ‹ä¸ä½ :(\nåœ¨å­¦æ ¡é‡Œé¢ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯å­¦ç”Ÿï¼Œå·å¤§ä¸ä¸€æ ·ï¼Œå¼€æ”¾å¼æ ¡å›­ï¼Œå„è‰²å¹´é¾„æ®µçš„äººè¿›è¿›å‡ºå‡ºï¼Œè®©è‡ªå·±æ„Ÿè§‰ä»å¨æµ·ç¯ç¿ åŒºæµ·æ»¨æ ¡å›­ä¸€ä¸‹å­åˆ°äº†ä¸€ä¸ªå¼€partyçš„å°ä¹å›­ï¼Œä¸€å‡ºå¤ªé˜³åå°±èƒ½çœ‹åˆ°ä¸ƒè€å…«å°‘çš„äººåœ¨è‰åªä¸Šæ™’ç€å¤ªé˜³ç©è€èŠå¤©å–èŒ¶ï¼Œä½†æ˜¯çœ‹åˆ°éƒ½ä¼šæ„Ÿè§‰å¾ˆå¼€å¿ƒã€‚åœ¨æ·±åœ³è‹¦é€¼çš„æˆ‘ï¼Œå·²ç»å¾ˆä¹…æ²¡æœ‰ä½“ä¼šåˆ°è¿™ç§æ„Ÿè§‰äº†ã€‚\næˆéƒ½ï¼Œåƒçš„ã€ç©çš„ã€å–çš„ã€è¹¦çš„ï¼Œéƒ½æŒºå¤šçš„ã€‚\n  è¿™ä¸ªç«é”…å°±ä¸è¯´äº†ï¼Œä»€ä¹ˆä¸²ä¸²ä¹‹ç±»çš„ï¼Œæˆ‘å¯¹åƒæ²¡ç ”ç©¶ï¼Œä½†æ˜¯çœ‹åˆ°åˆ«äººåƒï¼ˆæ¯”å¦‚æˆ‘è€å©†ï¼‰æˆ‘ä¹Ÿæ˜¯å¾ˆå¼€å¿ƒçš„ã€‚æˆ‘æœ€å–œæ¬¢çš„å°±æ˜¯ç‚¸åœŸè±†ï¼Œåœ¨æˆéƒ½å…»æˆçš„ä¹ æƒ¯ï¼Œèµ°åˆ°ä¸€ä¸ªåŸå¸‚å»ç©ï¼Œå…ˆè¦æ¢ç´¢ä¸‹è¿™é‡Œæœ‰æ²¡æœ‰å–ç‚¸åœŸè±†çš„ã€‚ä»¥è‡³äºåœ¨æ·±åœ³è…¾è®¯ä¸Šç­ï¼Œå»éº¦å½“åŠ³æˆ‘æ€»æ˜¯å›ºå®šçš„ç‚¹7å·å¥—é¤ï¼Œæœ‰è–¯æ¡å•Šã€‚\n  æˆéƒ½ï¼Œç»™æˆ‘æ„Ÿè§‰æ¯”è¾ƒæ·±çš„å°±æ˜¯ï¼Œå®ƒä½œä¸ºè¥¿éƒ¨æ ¸å¿ƒåŸå¸‚ï¼Œæ—¢æœ‰å®ƒç°ä»£åŒ–çš„ä¸€é¢ï¼ˆèƒ½æƒ³è±¡å—ï¼Œ18æ¡åœ°é“çº¿è¦†ç›–çš„äºŒçº¿åŸå¸‚ï¼Œäº’è”ç½‘å¤§å‚åŸºæœ¬éƒ½æœ‰åˆ†å…¬å¸åœ¨æˆéƒ½ï¼‰ï¼Œä¹Ÿæœ‰å®ƒæ•£å‘ç€æµ“éƒå†å²æ°”æ¯çš„ä¸€é¢ã€‚å¯¹å†å²äººç‰©ã€æ–‡ç‰©ã€è‡ªç„¶é—äº§çš„ä¿æŠ¤æ¯”è¾ƒå¥½ã€‚å°±æ˜¯ä½ æƒ³æµªæœ‰å¯ä»¥è®©ä½ ä½å¤´çš„ç°ä»£åŒ–åŸå¸‚ç¾¤ï¼Œä½ æƒ³é›…ä¹Ÿæœ‰è®©ä½ è‡ªçŸ¥æ–‡åŒ–æ²‰æ·€ä¸è¶³çš„æ–‡åŒ–é—äº§ã€‚\n  å–çš„ï¼Œæœ‰å•¥ï¼ŒèŒ¶å§ï¼Œå°é…’é¦†å§ï¼Œä¹çœ¼æ¡¥é…’å§ä¸€æ¡è¡—å§ã€‚èƒ½ä»£è¡¨æˆéƒ½äººçš„ï¼Œæˆ‘ä¹Ÿä¸æ•¢è¯´å¾ˆäº†è§£ï¼Œä½†æˆ‘æ„Ÿè§‰åº”è¯¥æ˜¯å–èŒ¶å§ï¼Œä¸€ç¾¤äººå–ä¸ªèŒ¶ï¼Œå¹å¹æ°´çš®ï¼ŒèŠèŠå…«å¦ï¼Œå¼€å¿ƒå•Šã€‚å½“å¹´æˆ‘ä»¬å¯¼å¸ˆå°±å–œæ¬¢å–èŒ¶ï¼Œå’Œæˆ‘ä»¬èŠå¾ˆä¹…ã€‚\n  è¹¦çš„ï¼Œé…’å§è¿˜æŒºå¤šçš„ï¼Œå–å¤šäº†ä¹Ÿä¸å¥½ï¼Œä¸è¿‡æˆå¹´äººå–å¤šäº†ä¹Ÿå¯ä»¥ç†è§£å½“å¹´ä¹çœ¼æ¡¥çš„äº‹ï¼Œè‡ªå·±çš„äº‹è‡ªå·±è´Ÿè´£å°±å¥½äº†ï¼Œæ²¡ä»€ä¹ˆå¯ä»¥åš¼çš„ã€‚ä½†æ˜¯åƒå°é…’é¦†è¿™æ ·çš„ï¼Œå€’æ˜¯å¯ä»¥å¤šä¸€ç‚¹ï¼Œè¿˜æŒºå¥½ç©çš„ã€‚æˆéƒ½è¿™å‡ å¹´çš„æ–‡åŒ–ä½œå“ä¹Ÿæ˜¯æ¯”è¾ƒå‡ºå½©ï¼Œã€Šæˆéƒ½æˆéƒ½ã€‹ã€ã€Šå“ªå’ã€‹ç­‰ç­‰å§ã€‚éš¾é“äººçœŸçš„å®‰é€¸äº›æ›´å®¹æ˜“å‡ºå¥½ä½œå“ï¼Ÿ\n  æœ‰çš„æ—¶å€™æˆ‘ä¼šæƒ³ï¼Œè¦æ˜¯æŠŠæˆéƒ½åœ°çš®ç¡¬æ¬åˆ°ä¸œéƒ¨æ²¿æµ·ï¼Œå°±å¯ä»¥æ‰“å®Œç¾äº†ï¼Œä¸»è¦æ˜¯æˆ‘æ¯”è¾ƒå–œæ¬¢çœ‹æµ·ã€‚è¿™æ˜¯å¤§å­¦æ—¶å…»æˆçš„ä¹ æƒ¯ï¼Œå–œæ¬¢è·‘ç¯æµ·è·¯ï¼Œå–œæ¬¢é—»æµ·æ°´è…¥å‘³ï¼Œå–œæ¬¢å¹æµ·é£ã€‚è™½ç„¶æˆéƒ½æ·±å¤„å†…é™†ï¼Œä½†æ˜¯ç°åœ¨çœ‹æ¥ï¼Œä¾ç„¶æ˜¯å±ˆæŒ‡å¯æ•°çš„è¶…é«˜æ€§ä»·æ¯”çš„åŸå¸‚ã€‚\näº«å—å­¦ä¹ è¿‡ç¨‹ # è¯´èµ·æˆ‘è¿™æ®µæ—¶é—´çš„å­¦ä¹ ï¼Œæ˜¯æ¯”è¾ƒè‡ªç”±çš„ï¼Œé™¤äº†æ¯ä¸ªå‘¨æœ«ç»™è€å¸ˆå‘é‚®ä»¶ã€å‘¨ä¸€å’Œè€å¸ˆå¼€ä¼šä»¥å¤–ï¼Œå…¶ä»–çš„æ—¶é—´åŸºæœ¬å¯ä»¥è‡ªç”±æ”¯é…ã€‚å› ä¸ºæˆ‘å¯¼å¸ˆä¹Ÿæ˜¯å•å¹²å˜›ï¼Œæ²¡æœ‰å®éªŒå®¤æ‰“å¼€çš„ä¸€äº›ç¡¬æ€§è¦æ±‚ã€‚æƒ³å»å›¾ä¹¦é¦†ä¹Ÿè¡Œï¼Œæƒ³å¸®å…¶ä»–è€å¸ˆæ‰“æ‰“æ‚ä¹Ÿè¡Œï¼Œæˆ‘ä»¬ä¹Ÿæœ‰å®éªŒå®¤ï¼Œåªä¸è¿‡åœ¨æ±Ÿå®‰æ ¡åŒºäº†ã€‚æ›¾ç»æœ‰æ®µæ—¶é—´è€å¸ˆé—®æˆ‘ä»¬æ„¿ä¸æ„¿æ„æ¬è¿‡å»ä½ï¼Œæˆ‘ä»¬éƒ½è§‰å¾—è„±ç¦»è‡ªå·±çš„å­¦ç”Ÿåœˆå­ä¸å¤ªå¥½ï¼Œäºæ˜¯ä½œç½¢ã€‚\nåŸºæœ¬ä¸Šï¼Œæˆ‘æ¯å¤©éƒ½æ˜¯åœ¨å›¾ä¹¦é¦†åº¦è¿‡ï¼Œè¿™ç§æ„Ÿè§‰è¶…æ£’çš„ã€‚å›¾ä¹¦é¦†æ—è¾¹ä¹Ÿæœ‰ä¸€äº›å°åƒï¼Œæ‰€ä»¥åˆé¥­ã€æ™šé¥­åŸºæœ¬å¯ä»¥å°±è¿‘è§£å†³ï¼Œå‘³é“ä¹Ÿä¸é”™ï¼Œä¸ç”¨è·‘æ¥è·‘å»æŠŠæ—¶é—´æµªè´¹åœ¨è·¯ä¸Šï¼Œå¾ˆå¤šæ—¶å€™å¯ä»¥åœ¨å›¾ä¹¦é¦†ä¸€å¾…å¾…ä¸€å¤©ã€‚\næˆ‘æ¯”è¾ƒå–œæ¬¢æ‹¿ä¸ªç”µè„‘ç›´æ¥åˆ°è®¡ç®—æœºç›¸å…³çš„ä¹¦æ¶æ—è¾¹å­¦ä¹ ï¼Œæœ‰é‡åˆ°ä¸€äº›ä»€ä¹ˆé—®é¢˜çš„æ—¶å€™ï¼Œåœ¨ä¹¦æ¶ä¸Šèµ°èµ°å°±èƒ½æ‰¾åˆ°ç›¸å…³çš„èµ„æ–™ï¼Œå¯èƒ½ä¸€æœ¬ä¹¦çš„ä½œè€…æè¿°çš„ä¸å®¹æ˜“æ‡‚ï¼Œå¯èƒ½å¦ä¸€æœ¬ä¹¦ä¸­æè¿°çš„å°±æ¸…æ¥šä¸€ç‚¹ã€‚æœ‰æ—¶å€™é—²é€›ï¼Œçœ‹åˆ°äº›æ²¡æ¥è§¦è¿‡çš„æˆ–è€…çœ¼å‰ä¸€äº®çš„ä¸œè¥¿ï¼Œä¹Ÿå®¹æ˜“å¼€é˜”ä¸‹æ€è·¯ã€‚\nå½“ç„¶äº†ï¼Œé™¤äº†å­¦ä¹ ï¼Œä¹Ÿè¿˜æ˜¯è¦çœ‹è®ºæ–‡ã€è·ŸæŠ€æœ¯ã€åšé¡¹ç›®çš„ï¼Œå¯¼å¸ˆç»™æˆ‘ä»¬å®šäº†ä¸€ä¸ªä¹¦å•ï¼Œè¦æ±‚æˆ‘ä»¬è¿™äº›æ˜¯åŸºç¡€ï¼Œè¯´å®è¯ï¼Œæ¯›å¾·æ“è€å¸ˆçš„ã€ŠLinuxå†…æ ¸æºç æƒ…æ™¯åˆ†æã€‹ç°åœ¨æˆ‘éƒ½æ²¡å®Œå…¨çœ‹å®Œï¼Œéƒ¨å¤´å¤ªå¤§äº†ï¼Œä½†æ˜¯å†™çš„æ˜¯çœŸå¥½ã€‚\nå¯¼å¸ˆå…¶å®å¯¹æˆ‘ä»¬æŒºå¥½çš„ï¼Œä¹Ÿä¼šæŒ‡ç‚¹æˆ‘ä»¬ï¼Œä¹Ÿä¼šæ‰¾æœºä¼šå¸¦æˆ‘ä»¬å‡ºå»é”»ç‚¼ã€å»ä¼ä¸šå‚è§‚ï¼ˆå›½å®¶ç”µç½‘ã€åä¸ºä¹‹ç±»çš„ï¼‰ï¼Œä¹Ÿä¼šæŒ‡å‡ºæˆ‘ä»¬çš„ä¸è¶³ã€‚åº”è¯¥æ˜¯æˆ‘ä»¬è¢«ç¤¾ä¼šæ¶æ‰“çš„å°‘å§ï¼Œæœ‰æ—¶å€™è¢«å¯¼å¸ˆæ‰¹ä¸€ä¸‹ã€‚\næ€»ä½“è€Œè¨€ï¼Œåœ¨å·å¤§å­¦ä¹ æ„Ÿå—è¿˜å¯ä»¥ï¼Œåçš„ä¹Ÿæœ‰å°±ä¸å€¼å¾—å•ç‹¬æ‹å‡ºæ¥è¯´äº†ï¼Œå…¶ä»–å­¦æ ¡ä¹Ÿæœ‰ã€‚\nåä½œé…¸ç”œè‹¦è¾£ # è·Ÿç€å¯¼å¸ˆåšé¡¹ç›®çš„æ—¶å€™ï¼Œæœ‰é‚£ä¹ˆä¸€ä¸ªå­¦æ ¡çš„é¡¹ç›®ï¼ŒåŸºæœ¬ä¸Šç®—æ˜¯æˆ‘æ˜¯è´Ÿè´£äººåœ¨æ¨åŠ¨ï¼Œç„¶åå’Œå‡ ä¸ªå¸ˆå…„å¼Ÿå®è“äº†ä»è®¾è®¡ã€å¼€å‘ã€äººåŠ›ã€æµ‹è¯•ã€æ–‡æ¡£ã€å®¢æœä¸€æ¡é¾™ï¼Œå¯¼å¸ˆä¹Ÿç»™äº†ä¸€äº›éå¸¸å¥½çš„æŒ‡å¯¼ï¼Œç‰¹åˆ«æ˜¯å’Œéœ€æ±‚æ–¹æ²Ÿé€šã€è¿›åº¦æŠŠæ§æ–¹é¢ã€‚\nå›æƒ³èµ·ä»¥å‰åšä¸€äº›å¤§ä½œä¸šã€è¯¾ç¨‹è®¾è®¡ã€æ¯•ä¸šè®¾è®¡ä¹‹ç±»çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯æˆ‘å¸¦åˆ«äººåšï¼Œå·¥ç¨‹é‡ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œå®åœ¨ä¸è¡Œæˆ‘ç›´æ¥æ’¸äº†ç»™å¤§ä¼™è®²ä¸€è®²ä¹Ÿå¯ä»¥äº†ï¼Œé¡¶å¤šå¤šè®²ä¸¤éï¼Œé¡¶å¤šå—“å­è®²çš„ä¸èˆ’æœäº†ã€‚\nè¿™æ¬¡ä¸è¡Œï¼Œå·¥ç¨‹é‡æœ‰ç‚¹å¤§ï¼Œä»åŸå‹è®¾è®¡ã€webã€appã€åå°ã€æµ‹è¯•ã€bugè·Ÿè¸ªéƒ½éœ€è¦åšï¼ŒäººåŠ›åˆä¸å¤Ÿï¼Œå®¢è§‚è¯´å½“æ—¶æœ‰å‡ ä¸ªåŒå­¦çš„å·¥ç¨‹èƒ½åŠ›è¦ç¨å¾®æ¬ ç¼ºç‚¹ï¼Œåé¢é”»ç‚¼äº†ä¸€æ®µæ—¶é—´åèƒ½ä¸Šæ‰‹äº†ã€‚ä½†æ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ã€å¯è¯»æ€§éƒ½å¾ˆå·®ï¼Œæˆ‘åˆšå¼€å§‹æœ‰æ®µæ—¶é—´ä¼šæ‰¾å‡ºä»–ä»¬çš„é—®é¢˜ç»™ä»–ä»¬è§£é‡Šæ¸…æ¥šï¼Œä»–ä»¬é™†é™†ç»­ç»­æ˜ç™½åä¿®æ”¹ã€‚åé¢æœ‰äº›è¯´äº†ä¹Ÿä¸æ˜ç™½ï¼Œçº¯å‡­ç»éªŒå¹²æ´»ã€‚æœ‰çš„æ—¶å€™èµ¶è¿›åº¦ï¼Œé‡åˆ°bugï¼Œæˆ‘ä¼šæŠŠä»–ä»¬çš„ä»£ç å¤‡ä»½åç›´æ¥é‡å†™ã€‚å¾ˆç²—æš´ã€‚\nå…¶å®è¿™æ ·æ˜¯ä¸å¥½çš„ï¼Œæ…¢æ…¢æˆ‘ä¹Ÿä½“ä¼šåˆ°äº†ï¼Œå¦‚æœè§‰å¾—è‡ªå·±èƒ½åŠ›æ¯”è¾ƒå¼ºä¸€ç‚¹ï¼Œæˆ–è€…å¼ºä¸€äº›ã€å¼ºå¾ˆå¤šï¼Œè¿™ä¸ªå‰æä¸‹ï¼Œå¦‚æœä¸æ³¨æ„å¸¦åŠ¨å‘¨å›´äººæå‡ï¼Œä»¥åè‡ªå·±å°±ä¼šæ¯”è¾ƒç´¯ã€‚å› ä¸ºä½ æ€»æ„Ÿè§‰åˆ«äººå¹²çš„ä¸å¥½ï¼Œä½ è¦äº²è‡ªæ’¸è¢–å­å¹²ï¼Œå·¥ç¨‹é‡å°å¯ä»¥ï¼Œå·¥ç¨‹é‡å¤§äº†ä¹Ÿæ˜¯äºäº‹æ— è¡¥çš„ã€‚\næ‰€ä»¥åé¢ï¼Œè‡ªå·±ç»å¸¸å†™æ–‡æ¡£ï¼Œåˆ†äº«ç»™ä»–ä»¬çœ‹ã€‚ä¹Ÿæ­å»ºäº†buggenieï¼Œä¸“é—¨åœ¨ä¸Šé¢è´´è‡ªå·±æŒ–å‡ºçš„bugã€åŸå› ã€è§£å†³æ–¹æ³•ï¼Œåé¢å¤§å®¶ä¹ æƒ¯äº†ï¼Œä¹Ÿåœ¨ä¸Šé¢è´´bugã€åŸå› ã€è§£å†³æ–¹æ³•ï¼Œæ…¢æ…¢åœ°å°±å¥½äº†å¾ˆå¤šã€‚\næœ‰é‚£ä¹ˆä¸€æ®µæ—¶é—´ï¼Œæˆ‘å¾ˆéƒé—·ï¼Œæ­‡äº†å‡ å¤©ï¼Œæˆ‘çš„åŒå­¦ä»¬å’Œå¯¼å¸ˆæ±‡æŠ¥çš„æ—¶å€™ç©ç¬‘ä¼¼çš„è¯´æˆ‘æœ€è¿‘æ²¡æäº¤ä»£ç ï¼Œå¯¼å¸ˆæ‰¾æˆ‘é¢è°ˆï¼Œè¿˜æ‰¹äº†æˆ‘ä¸€é¡¿ï¼Œæˆ‘çš„gï¼Œæˆ‘ä¸€ä¸ªå‘¨æœ«å¯ä»¥æ’¸å®Œä»–ä»¬ä¸€å‘¨çš„å·¥ä½œé‡ã€‚ä¼‘æ¯å‡ å¤©è€Œå·²ï¼Œè€Œä¸”ä¹Ÿå­˜åœ¨åŠŸèƒ½ä¸Šçš„ä¾èµ–ã€‚å¯¼å¸ˆå…¶å®æ˜¯æƒ³è®©æˆ‘ä»¬ä¿è¯è¿›åº¦ï¼Œå¸®å¦å¤–å‡ ä¸ªåŒå­¦çš„æ¨¡å—åŠ å¿«ç‚¹è¿›åº¦ï¼Œæˆ‘å½“ç„¶æ˜¯æ„¿æ„ï¼Œé—®é¢˜æ˜¯åˆ«äººä»£ç å†™çš„ä¸å¥½ä½†æ˜¯ç°åœ¨åŠ¨åŠ›å¾ˆè¶³çš„æ—¶å€™ï¼Œæˆ‘ä¸Šå»é‡å†™æˆ–è€…å¼€å§‹å½“è€å¸ˆä¹Ÿä¼¼ä¹ä¸æ˜¯å¾ˆå¥½ã€‚\nåé¢å¼€å§‹æƒ³æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¼€å§‹å…³æ³¨ä»£ç reviewã€‚é‚£æ—¶çš„reviewä¹Ÿä¸æ˜¯ç°åœ¨PreMergeé˜¶æ®µreviewï¼Œreviewé€šè¿‡å†åˆå…¥ï¼Œä¹Ÿæ¯”è¾ƒåŸå§‹ï¼Œå°±æ˜¯å¤§å®¶å†™å®Œäº†ï¼Œtrunkæäº¤äº†ï¼Œæ™šä¸Šæˆ‘ä¼šç»Ÿä¸€å’Œæ˜¨å¤©çš„å¯¹æ¯”ä¸‹ï¼Œä»£ç é‡å¯èƒ½ä¼šæœ‰ç‚¹å¤šï¼Œä½†æ˜¯å› ä¸ºæ˜¯å•ä½“æœåŠ¡ï¼Œå„ä¸ªéœ€æ±‚åœºæ™¯é€»è¾‘ä¹Ÿæ¸…æ™°ï¼Œå¾ˆå®¹æ˜“çœ‹æ¸…æ¥šé€»è¾‘æœ‰æ²¡æœ‰é—®é¢˜ã€‚\nåˆè¿™ä¹ˆåšæŒäº†ä¸€æ®µæ—¶é—´ï¼Œæ„Ÿè§‰å¸ˆå…„å¼Ÿå¤šå°‘åœ¨å·¥ç¨‹èƒ½åŠ›æ–¹é¢æœ‰äº†ç‚¹æå‡ï¼Œåˆšå¼€å§‹ç£¨åˆçš„æ—¶å€™å¾ˆç—›è‹¦ï¼Œåé¢å¤§å®¶åœ¨ä¸€èµ·éƒ½å¾ˆæ‹¼ã€äº’ç›¸å¸®åŠ©ã€å…±å…‹æ—¶è‰° :)\næœ‰ä¸€æ¬¡ï¼Œç¬¬äºŒå¤©å°±æ˜¯é¡¹ç›®æ¼”ç¤ºäº†ï¼Œä¼šè®®å¾ˆé‡è¦ï¼Œæˆ‘ä»¬å…¨éƒ¨é€šå®µåŠ ç­è”è°ƒï¼ŒäººåŠ›ä¸å¤ŸçœŸçš„æ˜¯èµ¶è¿›åº¦ï¼Œå¸ˆå…„å¼Ÿä»¬è¿˜æœ‰ä¸€ä¸ªå¥³åŒå­¦å“¦ï¼ŒæŒ¤åœ¨ä¸€ä¸ªå‡ºç§Ÿå±‹é‡Œå¥‹æˆ˜ä¸€æ™šï¼Œå…¶å®ä¹Ÿæœ‰å¾ˆå¤šæ¬¡å‘¨å…­å‘¨æ—¥åœ¨æ¯•åŠ ç´¢åº¦è¿‡çš„ã€‚\nåé¢æˆ‘ä¹Ÿå¾ˆè®¤å¯è¿™å‡ ä¸ªåŒå­¦äº†ï¼Œå¯èƒ½å·¥ç¨‹èƒ½åŠ›å’Œæˆ‘æœ‰å·®è·ï¼Œä½†æ˜¯åœ¨åšäº‹ä¸Šè¿˜æ˜¯å¾ˆé è°±çš„ã€‚å›¢é˜Ÿä¸­ä¸å¯èƒ½æ¯ä¸ªäººéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚éƒ½æ˜¯çˆ±é’»ç ”æŠ€æœ¯çš„ï¼Œå›¢é˜Ÿé‡Œé¢éœ€è¦å„ç§è§’è‰²çš„äººï¼Œå¤§å®¶å„è‡ªå‘æŒ¥è‡ªå·±çš„é•¿å¤„ï¼Œç£¨åˆå¥½ï¼Œå›¢é˜Ÿå°±ä¼šè·å¾—ä¸€ä¸ªæ–¹å‘ä¸€è‡´çš„åˆåŠ›ï¼Œè€Œä¸æ˜¯å„è‡ªåŠ›é‡ç›¸äº’æŠµæ¶ˆã€‚\nå‡†å¤‡å‚åŠ å·¥ä½œ # å‡†å¤‡æ¯•ä¸šæ‰¾å·¥ä½œçš„æ—¶å€™ï¼Œå¼€å§‹æ²¡å¥½å¥½å‡†å¤‡ï¼Œåœ¨æ”¾å‡å»è€å©†å®¶ç©çš„ç«è½¦ä¸Šã€ç©çš„è·¯ä¸Šå®Œæˆäº†Alibabaçš„é¢è¯•ï¼Œæ‹¿äº†Offerï¼Œä½†æ˜¯è¯„çº§ä¸å¤ªå¥½ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½å¾ˆå¤šäººä¼šé€‰æ‹©å»é˜¿é‡Œå§ï¼Œæˆ‘å’¨è¯¢è¿‡é˜¿é‡Œå‡ºæ¥çš„ææ™ºæ…§è€å¸ˆï¼Œä»–ä¹Ÿå»ºè®®æˆ‘å»ã€‚åé¢ï¼Œæˆ‘æƒ³äº†æƒ³ï¼Œè¿˜æ˜¯æƒ³çœ‹çœ‹è‡ªå·±åˆ°åº•å­¦çš„æ€ä¹ˆæ ·ï¼Œè¯æ˜ä¸€ä¸‹è‡ªå·±å˜›ï¼Œå°±å‡†å¤‡äº†ä¸€æ®µæ—¶é—´å»å‚åŠ å…¶ä»–å…¬å¸æ ¡æ‹›ã€‚\nå»å“ªå„¿ã€æ–°æµªã€åä¸ºã€è…¾è®¯ï¼Œæ‹¿åˆ°è…¾è®¯Offerçš„æ—¶å€™ï¼Œæˆ‘å°±ä¸æ‰“ç®—é¢å…¶ä»–çš„äº†ï¼Œå»å“ªå„¿ç»™çš„è¯„çº§åº”è¯¥æ¯”è¾ƒå¥½ï¼Œå‡ ä¸ªåŒæ‹¿åˆ°Offerçš„é‡Œé¢è–ªèµ„æœ€é«˜çš„ï¼Œæ–°æµªçš„é¢è¯•å®˜è¯´æˆ‘æ˜¯é‚£ä¸¤å¤©é¢è¿‡çš„é‡Œé¢æœ€å¥½çš„ï¼Œç›´è¨€è¯´å¯ä»¥å’Œhrè°ˆè–ªæ°´ï¼Œä¸è¡Œä»–å¯ä»¥å’Œhrå•†é‡ã€‚åä¸ºæˆ‘å°±æ˜¯é™ªåŒå­¦å»çš„ï¼Œæœºè¯•é¢˜æˆ‘ä¸€çœ‹éƒ½è¦åäº†ï¼Œç ”ç©¶ç”Ÿäº†è¿˜åœ¨åšæˆ‘æœ¬ç§‘é˜¶æ®µåšçš„ç®—æ³•é¢˜ã€‚è…¾è®¯çš„é¢è¯•å®˜ï¼Œæˆ‘æ„Ÿè§‰æ•´ä¸ªæµç¨‹ä¸‹æ¥æ˜¯æ•ˆç‡æœ€é«˜çš„ï¼Œå“¦ï¼Œä¸å¯¹ï¼Œå»å“ªå„¿æ˜¯æœ€é«˜çš„ï¼Œå½“å¤©å°±ç»™äº†Offerï¼Œè…¾è®¯å’Œå…¶ä»–å‡ å®¶æ¯”æ˜¯æ•ˆç‡æœ€é«˜çš„ã€‚\n å»å“ªå„¿ï¼Œæ‰“ç®—å»çš„ï¼Œåé¢ä¸ä¹…å°±é™¤äº†æ–°é—»ï¼Œè¯´å»å“ªå„¿å’Œè°åˆå¹¶ï¼Œæ€ä¹ˆæ€ä¹ˆçš„ï¼Œæœ€åæ²¡å»ï¼› æ–°æµªï¼Œæ•ˆç‡å¤ªä½ï¼Œå¯èƒ½è·Ÿä»–ä»¬965æœ‰å…³ç³»ï¼Ÿä¸çŸ¥é“ï¼Œä½†æ˜¯éš”äº†å¥½å¤šå¤©æ‰æœ€ç»ˆå‘Offerï¼› ä½†æ˜¯ï¼Œé‚£å¤©æˆ‘å·²ç»å‡†å¤‡å¯„ä¸‰æ–¹ç»™é˜¿é‡Œï¼› è…¾è®¯ï¼Œè¿‡äº†åï¼Œæˆ‘æƒ³ç€è¦ä¸ä¸å»é˜¿é‡Œäº†ï¼Œéƒ¨é—¨ä¸»ç®¡æ²Ÿé€šåï¼Œè¿˜æ˜¯æ¥äº†è…¾è®¯ï¼›  å·¥ä½œè¿™äº›å¹´ï¼Œè¯´çœŸçš„ï¼Œä¼ä¸šã€ä¼ä¸šä¹‹é—´çš„ä¸åŒç‚¹åœ¨å“ªé‡Œå‘¢ï¼ŸçœŸçš„ä»…ä»…æ˜¯ä¸šåŠ¡çº¿å—ï¼Ÿæˆ‘è®¤ä¸ºä»75åˆ†åšåˆ°90åˆ†åˆ°100åˆ†ï¼Œç”šè‡³æ›´é«˜ï¼Œæœ‰ä¸€é¡¹ä¸œè¥¿ä¸€å®šæ˜¯ç»•ä¸è¿‡çš„ï¼Œå°±æ˜¯ä¼ä¸šæ–‡åŒ–ã€‚\nä¼ä¸šæ–‡åŒ–ï¼ŒçœŸçš„ä¸æ˜¯ç©ºå£ç™½è¯ï¼Œä¸€å®¶ä¼ä¸šåšçš„å¥½çš„è¯ï¼Œå®ƒä¼šæŠŠå…¬å¸çš„ä»·å€¼è§‚é€šè¿‡å„ä¸ªäº§å“ç›´è¾¾ç”¨æˆ·ï¼Œç”¨æˆ·ä»äº§å“ä¸­èƒ½çœŸåˆ‡æ„Ÿå—åˆ°è¿™å®¶ä¼ä¸šçš„éŸ§åŠ²ã€‚\n ä½ æ¯”æ–¹è¯´é˜¿é‡Œçš„åº—å°äºŒ ä½ æ¯”æ–¹è¯´æ­£ç›´çš„è…¾è®¯é¹… ä½ æ¯”æ–¹è¯´ç‹¼æ€§çš„åä¸º \u0026hellip;  æ²¡æœ‰åº—å°äºŒçš„å–åŠ›ï¼Œå“ªé‡Œæœ‰é‚£ä¹ˆå¤šäº”æ¹–å››æµ·çš„å›å¤´å®¢ï¼Ÿæ²¡æœ‰æ­£ç›´çš„è…¾è®¯é¹…ï¼Œä½ ä»¬è°æ•¢qqã€å¾®ä¿¡æ¶ˆæ¯å‘ä¸åœï¼Ÿæ²¡æœ‰ç‹¼æ€§çš„åä¸ºï¼Œå“ªé‡Œæ•¢åœ¨é€šä¿¡é¢†åŸŸé‚£ä¹ˆæœ‰åº•æ°”ï¼Ÿ\nå·¥ä½œå¥½å‡ å¹´ï¼Œå·¥ä½œä¸­è™½ç„¶ä¹Ÿæœ‰ä¸å°½å¦‚äººæ„çš„åœ°æ–¹ï¼Œä½†æ˜¯æ€»çš„æ¥è¯´æ˜¯å¥½çš„ã€‚ä¹Ÿä¸ç”¨å†å»å¤šæƒ³å½“åˆçš„é€‰æ‹©å¯¹æˆ–è€…é”™ï¼Œé€‰æ‹©é”™è¯¯å…¶å®ä½•å°ä¸æ˜¯ä¸€ç§æˆé•¿ï¼Œå¤±å»æŸäº›ä¸œè¥¿çš„æ—¶å€™ï¼Œä½ ä¹Ÿä¼šåœ¨åæ€æ€ä¹ˆä»å…¶ä»–åœ°æ–¹èµ¢å›æ¥ã€‚\n"}),a.add({id:4,href:"/tags/kmemcheck/",title:"kmemcheck",description:"",content:""}),a.add({id:5,href:"/tags/kmemleak/",title:"kmemleak",description:"",content:""}),a.add({id:6,href:"/tags/",title:"Tags",description:"",content:""}),a.add({id:7,href:"/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%86%85%E5%AD%98%E9%97%AE%E9%A2%98%E6%A3%80%E6%9F%A5/",title:"å†…æ ¸ä¸­çš„å†…å­˜æ£€æŸ¥å·¥å…·",description:"kmemcheck.txt # kmemcheckç”¨äºå†…æ ¸çš„æœªåˆå§‹åŒ–å†…å­˜çš„åŠ¨æ€æ£€æµ‹ï¼Œå®ƒå·¥ä½œåœ¨å†…æ ¸æ€ï¼Œä¸å·¥ä½œåœ¨ç”¨æˆ·æ€çš„ memcheckå®ç°æœºåˆ¶ä¸åŒã€‚è™½ç„¶kmemcheckä¸å¦‚memcheckç²¾ç¡®ï¼Œä½†æ˜¯å·²ç»è¶³å¤Ÿä½¿ç”¨çš„äº†ã€‚æ­¤å¤–ï¼Œkmemcheckä¼šä½¿ç”¨æ›´å¤šçš„å†…å­˜ï¼Œå¢åŠ ç³»ç»Ÿè´Ÿè½½ï¼Œä»…é€‚åˆç”¨äºå†…æ ¸çš„è°ƒè¯•ã€‚\nkmemleak.txt # kmemleakæ˜¯ä¸€ä¸ªå·¥ä½œåœ¨å†…æ ¸æ€ï¼Œç”¨äºæ£€æµ‹å†…æ ¸ä¸­å†…å­˜æ³„æ¼çš„å·¥å…·ï¼Œä¸å·¥ä½œåœ¨ç”¨æˆ·æ€çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·memcheckåŠ å‚æ•°\u0026ndash;leak-checkå·¥ä½œæ—¶æ•ˆæœç±»ä¼¼ã€‚\nä¸ºäº†åŠ æ·±å¯¹å†…å­˜ç®¡ç†çš„ç†è§£ï¼Œåº”è¯¥æŸ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªå·¥å…·çš„æºä»£ç ã€‚",content:"kmemcheck.txt # kmemcheckç”¨äºå†…æ ¸çš„æœªåˆå§‹åŒ–å†…å­˜çš„åŠ¨æ€æ£€æµ‹ï¼Œå®ƒå·¥ä½œåœ¨å†…æ ¸æ€ï¼Œä¸å·¥ä½œåœ¨ç”¨æˆ·æ€çš„ memcheckå®ç°æœºåˆ¶ä¸åŒã€‚è™½ç„¶kmemcheckä¸å¦‚memcheckç²¾ç¡®ï¼Œä½†æ˜¯å·²ç»è¶³å¤Ÿä½¿ç”¨çš„äº†ã€‚æ­¤å¤–ï¼Œkmemcheckä¼šä½¿ç”¨æ›´å¤šçš„å†…å­˜ï¼Œå¢åŠ ç³»ç»Ÿè´Ÿè½½ï¼Œä»…é€‚åˆç”¨äºå†…æ ¸çš„è°ƒè¯•ã€‚\nkmemleak.txt # kmemleakæ˜¯ä¸€ä¸ªå·¥ä½œåœ¨å†…æ ¸æ€ï¼Œç”¨äºæ£€æµ‹å†…æ ¸ä¸­å†…å­˜æ³„æ¼çš„å·¥å…·ï¼Œä¸å·¥ä½œåœ¨ç”¨æˆ·æ€çš„å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·memcheckåŠ å‚æ•°\u0026ndash;leak-checkå·¥ä½œæ—¶æ•ˆæœç±»ä¼¼ã€‚\nä¸ºäº†åŠ æ·±å¯¹å†…å­˜ç®¡ç†çš„ç†è§£ï¼Œåº”è¯¥æŸ¥çœ‹ä¸‹è¿™ä¸¤ä¸ªå·¥å…·çš„æºä»£ç ã€‚\n"}),a.add({id:8,href:"/tags/jprobe/",title:"jprobe",description:"",content:""}),a.add({id:9,href:"/tags/kprobe/",title:"kprobe",description:"",content:""}),a.add({id:10,href:"/tags/rprobe/",title:"rprobe",description:"",content:""}),a.add({id:11,href:"/blog/%E5%86%85%E6%A0%B8%E6%8E%A2%E9%92%88/",title:"å†…æ ¸æ¢é’ˆkprobeå·¥ä½œåŸç†",description:"å†…æ ¸ä¸ºæ–¹ä¾¿è°ƒè¯•å¼•å…¥äº†å†…æ ¸æ¢é’ˆï¼Œä¸»è¦æœ‰3ç§ï¼Œkprobe/jprobe/rprobeï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨kprobeçš„å·¥ä½œåŸç†ï¼Œè¿™ä¸ªç†è§£äº†ï¼Œå…¶ä»–å‡ ç§æ¢é’ˆå·¥ä½œåŸç†å¾ˆå®¹æ˜“å°±èƒ½è„‘è¡¥å‡ºæ¥ã€‚",content:"å†…æ ¸æ¢é’ˆ # å†…æ ¸ä¸­ç”¨æ¥æ–¹ä¾¿è°ƒè¯•çš„æ¢é’ˆï¼ˆprobeï¼‰ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼š\n kprobeï¼Œå¯ä»¥å¯¹ä»»æ„æŒ‡ä»¤åœ°å€å¤„å®‰è£…æ¢é’ˆ jprobeï¼Œå¯ä»¥å¯¹å‡½æ•°å…¥å£åœ°å€å¤„å®‰è£…æ¢é’ˆï¼Œæ–¹ä¾¿è·å–å‚æ•°ä¿¡æ¯ rprobeï¼Œæˆ–è€…ç§°ä¸ºretprobeï¼Œé¡¾åæ€ä¹‰ï¼Œä¸»è¦ç”¨æ¥è§‚å¯Ÿretvalue  è¿™å‡ ç§æ¢é’ˆçš„å®ç°åŸç†å¤§åŒå°å¼‚ï¼Œè¯¦ç»†çš„å·¥ä½œåŸç†å¯ä»¥å‚è€ƒ kprobes.rstã€‚\nkprobeå·¥ä½œåŸç† # è”æƒ³ä¸‹è°ƒè¯•å™¨ä¸­æ–­ç‚¹çš„å·¥ä½œæ–¹å¼ï¼Œkprobeå¯ä»¥é€šè¿‡æ–­ç‚¹çš„å½¢å¼æ¥å®ç°ï¼š\n è®°å½•ç›®æ ‡åœ°å€addrå¤„çš„åŸå§‹ä¸€å­—èŠ‚æŒ‡ä»¤ å°†ç›®æ ‡åœ°å€å¤„çš„æŒ‡ä»¤æ›¿æ¢ä¸º0xccï¼ˆint3å°±æ˜¯è½¯ä»¶æ–­ç‚¹ï¼‰ï¼Œå¹¶æ³¨å†Œè¯¥åœ°å€å¤„å¯¹åº”çš„kprobeï¼Œkprobeåº”è¯¥åŒ…å«äº†pre_handler/post_handler int3å¯¹åº”çš„ä¸­æ–­æœåŠ¡å¤„ç†ç¨‹åºä¸­ï¼Œæœ‰ä¸€æ®µä»£ç æ˜¯è¦æ‰§è¡Œå¯¹åº”çš„kprobeçš„pre_handlerï¼› å°†åŸaddrå¤„çš„ä¸€å­—èŠ‚æŒ‡ä»¤æ¢å¤ï¼Œç„¶åæ”¹æˆsinglestepæ‰§è¡Œå®Œä¸‹æ¡æŒ‡ä»¤ï¼› æ‰§è¡Œå®Œè¿™ä¸ªå‡½æ•°ä¸­çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œæ‰§è¡Œå®Œè¿”å›åç»§ç»­æ‰§è¡Œpost_handler ç„¶åç›´æ¥continue  æˆ‘è¯´çš„è¿™ä¸ªè¿‡ç¨‹ä¸ä¸€å®šç²¾ç¡®ï¼Œä½†æ˜¯å¤§è‡´å¯ä»¥è¿™ä¹ˆå®ç°ã€‚è¿™ç§æ–¹æ³•å¯èƒ½æ•ˆç‡ä¼šæœ‰ç‚¹ä½ä¸‹ï¼Œkprobes.rstä¸­ä¹Ÿæœ‰äº›ä¼˜åŒ–çš„æ€è·¯ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰ä»”ç»†å»çœ‹ã€‚\næˆ‘æ„Ÿå…´è¶£çš„å°±æ˜¯ï¼Œå†…æ ¸é‡Œé¢çš„kprobeå’Œè°ƒè¯•å™¨ä¸­çš„å¤§è‡´è·Ÿè¸ªtraceeæ‰§è¡Œè¿‡ç¨‹ï¼Œå¾ˆç±»ä¼¼ã€‚\nç›¸åŒç‚¹ï¼šéƒ½æ˜¯é€šè¿‡æŒ‡ä»¤patchçš„æ–¹å¼\nä¸åŒç‚¹ï¼š\n kprobeæ˜¯åˆ©ç”¨äº†int3æŒ‡ä»¤è§¦å‘trapæœåŠ¡ç¨‹åºèµ°åˆ°äº†kprobeçš„å¤„ç†é€»è¾‘å»æ‰§è¡Œpre_handler/post_handlerï¼Œ è€Œè°ƒè¯•å™¨æ˜¯traceeæ‰§è¡Œåˆ°æ–­ç‚¹æ—¶åŒºé€šè¿‡trapæœåŠ¡ç¨‹åºèµ°åˆ°äº†é€šçŸ¥tracerç»§ç»­æ§åˆ¶traceeè¿™ä¸ªé€»è¾‘ã€‚  æ€»ç»“ # ç®€è¦æ€»ç»“äº†ä¸‹kprobeè¿™ç§å†…æ ¸æ¢é’ˆçš„å·¥ä½œåŸç†ã€‚\n"}),a.add({id:12,href:"/categories/",title:"Categories",description:"",content:""}),a.add({id:13,href:"/tags/destructor/",title:"destructor",description:"",content:""}),a.add({id:14,href:"/tags/kobject/",title:"kobject",description:"",content:""}),a.add({id:15,href:"/tags/kref/",title:"kref",description:"",content:""}),a.add({id:16,href:"/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86kobject%E4%B8%8Ekref/",title:"krefå¼•ç”¨è®¡æ•°ä¸kobjectå¯¹è±¡ç®¡ç†",description:"çœ‹å®Œkref/kobjectè¿™å‡ ç¯‡æ–‡æ¡£ï¼Œæ›´æ·±åœ°æ˜ç™½äº†ä¸€ä¸ªé“ç†ï¼Œâ€œèƒ½å·¥æ¨¡å‹ï¼Œå·§åŒ çªƒæ„â€ã€â€œæ— æ‹›èƒœæœ‰æ‹›â€ï¼Œç¼–ç¨‹æ€æƒ³å’Œç¼–ç¨‹å·¥å…·æ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œå‰è€…å¸®åŠ©å®Œå–„åè€…ï¼Œåè€…ä¾¿äºæ›´ç®€å•åœ°æ¨å¹¿å‰è€…ã€‚çºµä½¿æ˜¯cè¯­è¨€è¿™æ ·çš„è¿‡ç¨‹å¼ç¼–ç¨‹è¯­è¨€ï¼Œåœ¨ç‰›äººæ‰‹é‡Œä¹Ÿå¯ä»¥æç‚¼é¢å‘å¯¹è±¡çš„ç²¾é«“æ¥å»ºæ„æ›´å¤æ‚çš„è½¯ä»¶ä¸–ç•Œã€‚",content:"kref # krefå¯ä»¥ä¸ºä½ è‡ªå®šä¹‰çš„ç»“æ„ä½“æä¾›ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œkobjectä¹Ÿå¯ä»¥å® ç°è¯¥åŠŸèƒ½ï¼Œä½†æ˜¯kobjectæ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœåªæ˜¯æä¾›ä¸€ä¸ªç®€å•çš„å¼•ç”¨è®¡æ•°å™¨çš„è¯ï¼Œåº”è¯¥ä½¿ç”¨ krefè€Œä¸æ˜¯kobjectã€‚\nkrefå¯ä»¥åµŒå…¥åœ¨æˆ‘ä»¬å®šä¹‰çš„ç»“æ„ä½“structä¸­ï¼Œå½“æˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ªç»“æ„ä½“æ—¶é€šè¿‡kref_initå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ï¼ˆå¼•ç”¨è®¡æ•°ä¸º1ï¼‰ï¼Œå½“æˆ‘ä»¬å¼•ç”¨è¿™ä¸ªstructæ—¶éœ€è¦é€šè¿‡kref_getæ¥å¢åŠ å…¶å¼•ç”¨è®¡æ•°ï¼Œè€Œå½“æˆ‘ä»¬ä¸å†å¼•ç”¨è¿™ä¸ªstructæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡kref_putæ¥å‡å°‘å¼•ç”¨è®¡æ•°ï¼ŒåŒæ—¶è¿˜å¯ä»¥æä¾›ä¸€ä¸ªdata_releaseçš„å‡½æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶è¯¥å‡½æ•°å°±ä¼šæ‰§è¡Œã€‚\nkreféå¸¸ç±»ä¼¼äºc++ä¸­çš„æ™ºèƒ½æŒ‡é’ˆçš„åŠŸèƒ½ï¼Œgccç¼–è¯‘æœŸå¯¹cè¯­è¨€ä¹Ÿå¢åŠ äº†ä¸€äº›ç±»ä¼¼çš„å±æ€§æ‰©å±•ï¼Œå…è®¸åœ¨å˜é‡ä½œç”¨åŸŸç»“æŸæ—¶æ‰§è¡Œæ³¨å†Œçš„å‡½æ•°ã€‚å¯è§ï¼Œè‡ªå®šä¹‰ç±»å‹ä¸­é€šè¿‡æ°å½“åœ°ä½¿ç”¨krefï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°è¿‘ä¼¼ä¸Šè¿°c++æ™ºèƒ½æŒ‡é’ˆç­‰é«˜é˜¶ç©æ³•ã€‚\nsee kref.rst\nkobject # kobjectåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œåœ¨é¢å‘å¯¹è±¡é¢†åŸŸä¸­ï¼Œå¯¹è±¡æœ‰ç»§æ‰¿å…³ç³»ï¼Œæ´¾ç”Ÿå¯¹è±¡éœ€è¦å®ç°æŠ½è±¡åŸºç±»çš„æ–¹æ³•ï¼Œå¯¹è±¡åœ¨æ²¡æœ‰è¢«å¼•ç”¨æ—¶ä¹Ÿåº”è¯¥è¢«è‡ªåŠ¨é”€æ¯ï¼ˆè”æƒ³c++ææ„å‡½æ•°ï¼‰ç­‰ã€‚é¢å‘å¯¹è±¡çš„é‚£äº›æ€æƒ³åœ¨å†…æ ¸é‡Œé¢åˆæ˜¯æ€ä¹ˆæ ·ä¸€ç§è¡¨ç°å½¢å¼ã€‚\næ— æ‹›èƒœæœ‰æ‹›ï¼Œcè™½ç„¶æ˜¯è¿‡ç¨‹å¼ç¼–ç¨‹è¯­è¨€ï¼Œä½†æ˜¯å…¶ä¾ç„¶å¯ä»¥å†™å‡ºé¢å‘å¯¹è±¡çš„ä»£ç æ¥å¯¹å®Œæˆå¯¹å¤§å‹è½¯ä»¶é¡¹ç›®çš„è®¾è®¡æ„å»ºã€‚\næˆ‘ä»¬ä¸€èˆ¬å°†kobjectåµŒå…¥è‡ªå®šä¹‰çš„ç±»å‹structä¸­æ¥ä½¿ç”¨ï¼ŒåŒæ—¶è¿˜æœ‰å¯¹åº”çš„ä¸€ä¸ªktypeï¼š\n kobjectï¼Œå…·å¤‡äº†å¼•ç”¨è®¡æ•°åŠŸèƒ½ï¼Œé€šè¿‡kobject_init/get/putæ“ä½œå¯ä»¥å¯¹å¼•ç”¨è®¡æ•°è¿›è¡Œæ“ä½œï¼Œå¦å¤–kobjectè¿˜æœ‰parentæŒ‡é’ˆç”¨æ¥æ„å»ºå¯¹è±¡é—´çš„å±‚çº§å…³ç³»ï¼› ktypeï¼Œç”¨æ¥æè¿°æ¯ä¸ªkobjectå¯¹è±¡å¼•ç”¨è®¡æ•°å‡ä¸º0æ—¶åº”è¯¥å¯¹è¿™ä¸ªåŒ…å«kobjectæˆå‘˜çš„structç±»å‹æ‰§è¡Œä½•ç§æ“ä½œï¼Œæ¯”å¦‚å¦‚ä½•æ¸…ç†ã€é‡Šæ”¾ä¹‹ç±»çš„ï¼›  psï¼šksetå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªé›†åˆï¼Œç”¨æ¥ç®¡ç†ä¸€ç³»åˆ—çš„kobjectï¼Œä½¿ç”¨åœºæ™¯è§kobject.rstã€‚\nsee kobject.rst\næ€»ç»“ # çœ‹å®Œè¿™å‡ ç¯‡æ–‡æ¡£ï¼Œæ›´æ·±åœ°æ˜ç™½äº†ä¸€ä¸ªé“ç†ï¼Œâ€œèƒ½å·¥æ¨¡å‹ï¼Œå·§åŒ çªƒæ„â€ã€â€œæ— æ‹›èƒœæœ‰æ‹›â€ï¼Œç¼–ç¨‹æ€æƒ³å’Œç¼–ç¨‹å·¥å…·æ˜¯ç›¸è¾…ç›¸æˆçš„ï¼Œå‰è€…å¸®åŠ©å®Œå–„åè€…ï¼Œåè€…ä¾¿äºæ›´ç®€å•åœ°æ¨å¹¿å‰è€…ã€‚çºµä½¿æ˜¯cè¯­è¨€è¿™æ ·çš„è¿‡ç¨‹å¼ç¼–ç¨‹è¯­è¨€ï¼Œåœ¨ç‰›äººæ‰‹é‡Œä¹Ÿå¯ä»¥æç‚¼é¢å‘å¯¹è±¡çš„ç²¾é«“æ¥å»ºæ„æ›´å¤æ‚çš„è½¯ä»¶ä¸–ç•Œã€‚\n"}),a.add({id:17,href:"/categories/linux%E5%86%85%E6%A0%B8/",title:"linuxå†…æ ¸",description:"",content:""}),a.add({id:18,href:"/tags/refcount/",title:"refcount",description:"",content:""}),a.add({id:19,href:"/tags/smartpointer/",title:"smartpointer",description:"",content:""}),a.add({id:20,href:"/tags/books/",title:"books",description:"",content:""}),a.add({id:21,href:"/tags/docs/",title:"docs",description:"",content:""}),a.add({id:22,href:"/tags/linux/",title:"linux",description:"",content:""}),a.add({id:23,href:"/blog/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/",title:"Linuxå†…æ ¸å­¦ä¹ èµ„æ–™",description:"ç°åœ¨å­¦ä¹ Linuxæ“ä½œç³»ç»Ÿçš„äººè¶Šæ¥è¶Šå¤šäº†ï¼Œè¿›ä¸€æ­¥å­¦ä¹ Kernelçš„äººä¹Ÿè¶Šæ¥è¶Šå¤šäº†ï¼Œç»å¸¸æœ‰äººé—®èµ·æœ‰æ²¡æœ‰è´¨é‡å¥½çš„ã€è·å¾—å¤§å®¶è®¤å¯çš„å­¦ä¹ èµ„æ–™è®ºå›ï¼Œå°¤å…¶æ˜¯å¯¹äºå­¦ä¹ å†…æ ¸çš„æ–°æ‰‹è€Œè¨€ï¼Œèƒ½å¦è·å¾—è¿™äº›å¥½çš„å­¦ä¹ èµ„æ–™è¿˜æ˜¯å¾ˆé‡è¦çš„ã€‚å› ä¸ºç»å¸¸æœ‰äººé—®èµ·è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥åœ¨Linuxæºç éšé™„çš„æ–‡æ¡£ä¸­ï¼Œæœ‰ä¸“é—¨ä¸€ç¯‡æ–‡æ¡£kernel-docs.rstä¸“é—¨æ•´ç†ç½—åˆ—äº†é€‚åˆå¤§å®¶å­¦ä¹ Linuxå†…æ ¸çš„æ–‡æ¡£ã€åœ¨çº¿èµ„æºã€å‡ºç‰ˆä¹¦ç±ç­‰ï¼Œå¹¶é€ä¸€åšäº†ç®€è¦çš„æè¿°ã€‚æ³¨æ„åˆ°å…¶ä¸­æœ‰äº›èµ„æ–™æ˜¯å’Œå…·ä½“å†…æ ¸æ¨¡å—ç›¸å…³çš„ï¼Œå¦‚ç½‘ç»œåè®®æ ˆã€ä¸­æ–­å­ç³»ç»Ÿç­‰ï¼Œä¹Ÿé€‚åˆæœ‰é’ˆå¯¹æ€§åœ°ã€æ·±å…¥åœ°å»å­¦ä¹ ã€‚",content:"ç°åœ¨å­¦ä¹ Linuxæ“ä½œç³»ç»Ÿçš„äººè¶Šæ¥è¶Šå¤šäº†ï¼Œè¿›ä¸€æ­¥å­¦ä¹ Kernelçš„äººä¹Ÿè¶Šæ¥è¶Šå¤šäº†ï¼Œç»å¸¸æœ‰äººé—®èµ·æœ‰æ²¡æœ‰è´¨é‡å¥½çš„ã€è·å¾—å¤§å®¶è®¤å¯çš„å­¦ä¹ èµ„æ–™è®ºå›ï¼Œå°¤å…¶æ˜¯å¯¹äºå­¦ä¹ å†…æ ¸çš„æ–°æ‰‹è€Œè¨€ï¼Œèƒ½å¦è·å¾—è¿™äº›å¥½çš„å­¦ä¹ èµ„æ–™è¿˜æ˜¯å¾ˆé‡è¦çš„ã€‚å› ä¸ºç»å¸¸æœ‰äººé—®èµ·è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥åœ¨Linuxæºç éšé™„çš„æ–‡æ¡£ä¸­ï¼Œæœ‰ä¸“é—¨ä¸€ç¯‡æ–‡æ¡£kernel-docs.rstä¸“é—¨æ•´ç†ç½—åˆ—äº†é€‚åˆå¤§å®¶å­¦ä¹ Linuxå†…æ ¸çš„æ–‡æ¡£ã€åœ¨çº¿èµ„æºã€å‡ºç‰ˆä¹¦ç±ç­‰ï¼Œå¹¶é€ä¸€åšäº†ç®€è¦çš„æè¿°ã€‚æ³¨æ„åˆ°å…¶ä¸­æœ‰äº›èµ„æ–™æ˜¯å’Œå…·ä½“å†…æ ¸æ¨¡å—ç›¸å…³çš„ï¼Œå¦‚ç½‘ç»œåè®®æ ˆã€ä¸­æ–­å­ç³»ç»Ÿç­‰ï¼Œä¹Ÿé€‚åˆæœ‰é’ˆå¯¹æ€§åœ°ã€æ·±å…¥åœ°å»å­¦ä¹ ã€‚\næœ¬æ–‡å‰©ä½™å†…å®¹æ¥è‡ªLinuxå†…æ ¸æ–‡æ¡£ kernel-docs.rstï¼Œæ•´ç†åœ¨æ­¤æ–¹ä¾¿æŸ¥é˜…å‚è€ƒã€‚\nDocs at the Linux Kernel tree # The Sphinx books should be built with make {htmldocs | pdfdocs | epubdocs}.\n* Name: **linux/Documentation** :Author: Many. :Location: Documentation/ :Keywords: text files, Sphinx. :Description: Documentation that comes with the kernel sources, inside the Documentation directory. Some pages from this document (including this document itself) have been moved there, and might be more up to date than the web version.  On-line docs # * Title: **Linux Kernel Mailing List Glossary** :Author: various :URL: https://kernelnewbies.org/KernelGlossary :Date: rolling version :Keywords: glossary, terms, linux-kernel. :Description: From the introduction: \u0026quot;This glossary is intended as a brief description of some of the acronyms and terms you may hear during discussion of the Linux kernel\u0026quot;. * Title: **Tracing the Way of Data in a TCP Connection through the Linux Kernel** :Author: Richard Sailer :URL: https://archive.org/details/linux_kernel_data_flow_short_paper :Date: 2016 :Keywords: Linux Kernel Networking, TCP, tracing, ftrace :Description: A seminar paper explaining ftrace and how to use it for understanding linux kernel internals, illustrated at tracing the way of a TCP packet through the kernel. :Abstract: *This short paper outlines the usage of ftrace a tracing framework as a tool to understand a running Linux system. Having obtained a trace-log a kernel hacker can read and understand source code more determined and with context. In a detailed example this approach is demonstrated in tracing and the way of data in a TCP Connection through the kernel. Finally this trace-log is used as base for more a exact conceptual exploration and description of the Linux TCP/IP implementation.* * Title: **On submitting kernel Patches** :Author: Andi Kleen :URL: http://halobates.de/on-submitting-kernel-patches.pdf :Date: 2008 :Keywords: patches, review process, types of submissions, basic rules, case studies :Description: This paper gives several experience values on what types of patches there are and how likely they get merged. :Abstract: [...]. This paper examines some common problems for submitting larger changes and some strategies to avoid problems. * Title: **Linux Device Drivers, Third Edition** :Author: Jonathan Corbet, Alessandro Rubini, Greg Kroah-Hartman :URL: https://lwn.net/Kernel/LDD3/ :Date: 2005 :Description: A 600-page book covering the (2.6.10) driver programming API and kernel hacking in general. Available under the Creative Commons Attribution-ShareAlike 2.0 license. :note: You can also :ref:`purchase a copy from O'Reilly or elsewhere \u0026lt;ldd3_published\u0026gt;`. * Title: **Writing an ALSA Driver** :Author: Takashi Iwai \u0026lt;tiwai@suse.de\u0026gt; :URL: http://www.alsa-project.org/~iwai/writing-an-alsa-driver/index.html :Date: 2005 :Keywords: ALSA, sound, soundcard, driver, lowlevel, hardware. :Description: Advanced Linux Sound Architecture for developers, both at kernel and user-level sides. ALSA is the Linux kernel sound architecture in the 2.6 kernel version. * Title: **Linux PCMCIA Programmer's Guide** :Author: David Hinds. :URL: http://pcmcia-cs.sourceforge.net/ftp/doc/PCMCIA-PROG.html :Date: 2003 :Keywords: PCMCIA. :Description: \u0026quot;This document describes how to write kernel device drivers for the Linux PCMCIA Card Services interface. It also describes how to write user-mode utilities for communicating with Card Services. * Title: **The Linux Kernel Module Programming Guide** :Author: Peter Jay Salzman, Michael Burian, Ori Pomerantz, Bob Mottram, Jim Huang. :URL: https://sysprog21.github.io/lkmpg/ :Date: 2021 :Keywords: modules, GPL book, /proc, ioctls, system calls, interrupt handlers . :Description: A very nice GPL book on the topic of modules programming. Lots of examples. Currently the new version is being actively maintained at https://github.com/sysprog21/lkmpg. * Title: **Global spinlock list and usage** :Author: Rick Lindsley. :URL: http://lse.sourceforge.net/lockhier/global-spin-lock :Date: 2001 :Keywords: spinlock. :Description: This is an attempt to document both the existence and usage of the spinlocks in the Linux 2.4.5 kernel. Comprehensive list of spinlocks showing when they are used, which functions access them, how each lock is acquired, under what conditions it is held, whether interrupts can occur or not while it is held... * Title: **A Linux vm README** :Author: Kanoj Sarcar. :URL: http://kos.enix.org/pub/linux-vmm.html :Date: 2001 :Keywords: virtual memory, mm, pgd, vma, page, page flags, page cache, swap cache, kswapd. :Description: Telegraphic, short descriptions and definitions relating the Linux virtual memory implementation. * Title: **Video4linux Drivers, Part 1: Video-Capture Device** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/406 :Date: 2000 :Keywords: video4linux, driver, video capture, capture devices, camera driver. :Description: The title says it all. * Title: **Video4linux Drivers, Part 2: Video-capture Devices** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/429 :Date: 2000 :Keywords: video4linux, driver, video capture, capture devices, camera driver, control, query capabilities, capability, facility. :Description: The title says it all. * Title: **Linux IP Networking. A Guide to the Implementation and Modification of the Linux Protocol Stack.** :Author: Glenn Herrin. :URL: http://www.cs.unh.edu/cnrg/gherrin :Date: 2000 :Keywords: network, networking, protocol, IP, UDP, TCP, connection, socket, receiving, transmitting, forwarding, routing, packets, modules, /proc, sk_buff, FIB, tags. :Description: Excellent paper devoted to the Linux IP Networking, explaining anything from the kernel's to the user space configuration tools' code. Very good to get a general overview of the kernel networking implementation and understand all steps packets follow from the time they are received at the network device till they are delivered to applications. The studied kernel code is from 2.2.14 version. Provides code for a working packet dropper example. * Title: **How To Make Sure Your Driver Will Work On The Power Macintosh** :Author: Paul Mackerras. :URL: http://www.linux-mag.com/id/261 :Date: 1999 :Keywords: Mac, Power Macintosh, porting, drivers, compatibility. :Description: The title says it all. * Title: **An Introduction to SCSI Drivers** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/284 :Date: 1999 :Keywords: SCSI, device, driver. :Description: The title says it all. * Title: **Advanced SCSI Drivers And Other Tales** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/307 :Date: 1999 :Keywords: SCSI, device, driver, advanced. :Description: The title says it all. * Title: **Writing Linux Mouse Drivers** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/330 :Date: 1999 :Keywords: mouse, driver, gpm. :Description: The title says it all. * Title: **More on Mouse Drivers** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/356 :Date: 1999 :Keywords: mouse, driver, gpm, races, asynchronous I/O. :Description: The title still says it all. * Title: **Writing Video4linux Radio Driver** :Author: Alan Cox. :URL: http://www.linux-mag.com/id/381 :Date: 1999 :Keywords: video4linux, driver, radio, radio devices. :Description: The title says it all. * Title: **I/O Event Handling Under Linux** :Author: Richard Gooch. :URL: https://web.mit.edu/~yandros/doc/io-events.html :Date: 1999 :Keywords: IO, I/O, select(2), poll(2), FDs, aio_read(2), readiness event queues. :Description: From the Introduction: \u0026quot;I/O Event handling is about how your Operating System allows you to manage a large number of open files (file descriptors in UNIX/POSIX, or FDs) in your application. You want the OS to notify you when FDs become active (have data ready to be read or are ready for writing). Ideally you want a mechanism that is scalable. This means a large number of inactive FDs cost very little in memory and CPU time to manage\u0026quot;. * Title: **(nearly) Complete Linux Loadable Kernel Modules. The definitive guide for hackers, virus coders and system administrators.** :Author: pragmatic/THC. :URL: http://packetstormsecurity.org/docs/hack/LKM_HACKING.html :Date: 1999 :Keywords: syscalls, intercept, hide, abuse, symbol table. :Description: Interesting paper on how to abuse the Linux kernel in order to intercept and modify syscalls, make files/directories/processes invisible, become root, hijack ttys, write kernel modules based virus... and solutions for admins to avoid all those abuses. :Notes: For 2.0.x kernels. Gives guidances to port it to 2.2.x kernels. * Name: **Linux Virtual File System** :Author: Peter J. Braam. :URL: http://www.coda.cs.cmu.edu/doc/talks/linuxvfs/ :Date: 1998 :Keywords: slides, VFS, inode, superblock, dentry, dcache. :Description: Set of slides, presumably from a presentation on the Linux VFS layer. Covers version 2.1.x, with dentries and the dcache. * Title: **The Venus kernel interface** :Author: Peter J. Braam. :URL: http://www.coda.cs.cmu.edu/doc/html/kernel-venus-protocol.html :Date: 1998 :Keywords: coda, filesystem, venus, cache manager. :Description: \u0026quot;This document describes the communication between Venus and kernel level file system code needed for the operation of the Coda filesystem. This version document is meant to describe the current interface (version 1.0) as well as improvements we envisage\u0026quot;. * Title: **Design and Implementation of the Second Extended Filesystem** :Author: RÃ©my Card, Theodore Ts'o, Stephen Tweedie. :URL: https://web.mit.edu/tytso/www/linux/ext2intro.html :Date: 1998 :Keywords: ext2, linux fs history, inode, directory, link, devices, VFS, physical structure, performance, benchmarks, ext2fs library, ext2fs tools, e2fsck. :Description: Paper written by three of the top ext2 hackers. Covers Linux filesystems history, ext2 motivation, ext2 features, design, physical structure on disk, performance, benchmarks, e2fsck's passes description... A must read! :Notes: This paper was first published in the Proceedings of the First Dutch International Symposium on Linux, ISBN 90-367-0385-9. * Title: **The Linux RAID-1, 4, 5 Code** :Author: Ingo Molnar, Gadi Oxman and Miguel de Icaza. :URL: http://www.linuxjournal.com/article.php?sid=2391 :Date: 1997 :Keywords: RAID, MD driver. :Description: Linux Journal Kernel Korner article. :Abstract: *A description of the implementation of the RAID-1, RAID-4 and RAID-5 personalities of the MD device driver in the Linux kernel, providing users with high performance and reliable, secondary-storage capability using software*. * Title: **Linux Kernel Hackers' Guide** :Author: Michael K. Johnson. :URL: https://www.tldp.org/LDP/khg/HyperNews/get/khg.html :Date: 1997 :Keywords: device drivers, files, VFS, kernel interface, character vs block devices, hardware interrupts, scsi, DMA, access to user memory, memory allocation, timers. :Description: A guide designed to help you get up to speed on the concepts that are not intuitively obvious, and to document the internal structures of Linux. * Title: **Dynamic Kernels: Modularized Device Drivers** :Author: Alessandro Rubini. :URL: http://www.linuxjournal.com/article.php?sid=1219 :Date: 1996 :Keywords: device driver, module, loading/unloading modules, allocating resources. :Description: Linux Journal Kernel Korner article. :Abstract: *This is the first of a series of four articles co-authored by Alessandro Rubini and Georg Zezchwitz which present a practical approach to writing Linux device drivers as kernel loadable modules. This installment presents an introduction to the topic, preparing the reader to understand next month's installment*. * Title: **Dynamic Kernels: Discovery** :Author: Alessandro Rubini. :URL: http://www.linuxjournal.com/article.php?sid=1220 :Date: 1996 :Keywords: character driver, init_module, clean_up module, autodetection, mayor number, minor number, file operations, open(), close(). :Description: Linux Journal Kernel Korner article. :Abstract: *This article, the second of four, introduces part of the actual code to create custom module implementing a character device driver. It describes the code for module initialization and cleanup, as well as the open() and close() system calls*. * Title: **The Devil's in the Details** :Author: Georg v. Zezschwitz and Alessandro Rubini. :URL: http://www.linuxjournal.com/article.php?sid=1221 :Date: 1996 :Keywords: read(), write(), select(), ioctl(), blocking/non blocking mode, interrupt handler. :Description: Linux Journal Kernel Korner article. :Abstract: *This article, the third of four on writing character device drivers, introduces concepts of reading, writing, and using ioctl-calls*. * Title: **Dissecting Interrupts and Browsing DMA** :Author: Alessandro Rubini and Georg v. Zezschwitz. :URL: https://www.linuxjournal.com/article.php?sid=1222 :Date: 1996 :Keywords: interrupts, irqs, DMA, bottom halves, task queues. :Description: Linux Journal Kernel Korner article. :Abstract: *This is the fourth in a series of articles about writing character device drivers as loadable kernel modules. This month, we further investigate the field of interrupt handling. Though it is conceptually simple, practical limitations and constraints make this an ''interesting'' part of device driver writing, and several different facilities have been provided for different situations. We also investigate the complex topic of DMA*. * Title: **Device Drivers Concluded** :Author: Georg v. Zezschwitz. :URL: https://www.linuxjournal.com/article.php?sid=1287 :Date: 1996 :Keywords: address spaces, pages, pagination, page management, demand loading, swapping, memory protection, memory mapping, mmap, virtual memory areas (VMAs), vremap, PCI. :Description: Finally, the above turned out into a five articles series. This latest one's introduction reads: \u0026quot;This is the last of five articles about character device drivers. In this final section, Georg deals with memory mapping devices, beginning with an overall description of the Linux memory management concepts\u0026quot;. * Title: **Network Buffers And Memory Management** :Author: Alan Cox. :URL: https://www.linuxjournal.com/article.php?sid=1312 :Date: 1996 :Keywords: sk_buffs, network devices, protocol/link layer variables, network devices flags, transmit, receive, configuration, multicast. :Description: Linux Journal Kernel Korner. :Abstract: *Writing a network device driver for Linux is fundamentally simple---most of the complexity (other than talking to the hardware) involves managing network packets in memory*. * Title: **Analysis of the Ext2fs structure** :Author: Louis-Dominique Dubeau. :URL: https://teaching.csse.uwa.edu.au/units/CITS2002/fs-ext2/ :Date: 1994 :Keywords: ext2, filesystem, ext2fs. :Description: Description of ext2's blocks, directories, inodes, bitmaps, invariants...  Published books # * Title: **Linux Treiber entwickeln** :Author: JÃ¼rgen Quade, Eva-Katharina Kunst :Publisher: dpunkt.verlag :Date: Oct 2015 (4th edition) :Pages: 688 :ISBN: 978-3-86490-288-8 :Note: German. The third edition from 2011 is much cheaper and still quite up-to-date. * Title: **Linux Kernel Networking: Implementation and Theory** :Author: Rami Rosen :Publisher: Apress :Date: December 22, 2013 :Pages: 648 :ISBN: 978-1430261964 * Title: **Embedded Linux Primer: A practical Real-World Approach, 2nd Edition** :Author: Christopher Hallinan :Publisher: Pearson :Date: November, 2010 :Pages: 656 :ISBN: 978-0137017836 * Title: **Linux Kernel Development, 3rd Edition** :Author: Robert Love :Publisher: Addison-Wesley :Date: July, 2010 :Pages: 440 :ISBN: 978-0672329463 * Title: **Essential Linux Device Drivers** :Author: Sreekrishnan Venkateswaran :Published: Prentice Hall :Date: April, 2008 :Pages: 744 :ISBN: 978-0132396554 * Title: **Linux Device Drivers, 3rd Edition** :Authors: Jonathan Corbet, Alessandro Rubini, and Greg Kroah-Hartman :Publisher: O'Reilly \u0026amp; Associates :Date: 2005 :Pages: 636 :ISBN: 0-596-00590-3 :Notes: Further information in http://www.oreilly.com/catalog/linuxdrive3/ PDF format, URL: https://lwn.net/Kernel/LDD3/ * Title: **Linux Kernel Internals** :Author: Michael Beck :Publisher: Addison-Wesley :Date: 1997 :ISBN: 0-201-33143-8 (second edition) * Title: **Programmation Linux 2.0 API systeme et fonctionnement du noyau** :Author: Remy Card, Eric Dumas, Franck Mevel :Publisher: Eyrolles :Date: 1997 :Pages: 520 :ISBN: 2-212-08932-5 :Notes: French * Title: **The Design and Implementation of the 4.4 BSD UNIX Operating System** :Author: Marshall Kirk McKusick, Keith Bostic, Michael J. Karels, John S. Quarterman :Publisher: Addison-Wesley :Date: 1996 :ISBN: 0-201-54979-4 * Title: **Unix internals -- the new frontiers** :Author: Uresh Vahalia :Publisher: Prentice Hall :Date: 1996 :Pages: 600 :ISBN: 0-13-101908-2 * Title: **Programming for the real world - POSIX.4** :Author: Bill O. Gallmeister :Publisher: O'Reilly \u0026amp; Associates, Inc :Date: 1995 :Pages: 552 :ISBN: I-56592-074-0 :Notes: Though not being directly about Linux, Linux aims to be POSIX. Good reference. * Title: **UNIX Systems for Modern Architectures: Symmetric Multiprocessing and Caching for Kernel Programmers** :Author: Curt Schimmel :Publisher: Addison Wesley :Date: June, 1994 :Pages: 432 :ISBN: 0-201-63338-8 * Title: **The Design and Implementation of the 4.3 BSD UNIX Operating System** :Author: Samuel J. Leffler, Marshall Kirk McKusick, Michael J Karels, John S. Quarterman :Publisher: Addison-Wesley :Date: 1989 (reprinted with corrections on October, 1990) :ISBN: 0-201-06196-1 * Title: **The Design of the UNIX Operating System** :Author: Maurice J. Bach :Publisher: Prentice Hall :Date: 1986 :Pages: 471 :ISBN: 0-13-201757-1  Miscellaneous # * Name: **Cross-Referencing Linux** :URL: https://elixir.bootlin.com/ :Keywords: Browsing source code. :Description: Another web-based Linux kernel source code browser. Lots of cross references to variables and functions. You can see where they are defined and where they are used. * Name: **Linux Weekly News** :URL: https://lwn.net :Keywords: latest kernel news. :Description: The title says it all. There's a fixed kernel section summarizing developers' work, bug fixes, new features and versions produced during the week. Published every Thursday. * Name: **The home page of Linux-MM** :Author: The Linux-MM team. :URL: https://linux-mm.org/ :Keywords: memory management, Linux-MM, mm patches, TODO, docs, mailing list. :Description: Site devoted to Linux Memory Management development. Memory related patches, HOWTOs, links, mm developers... Don't miss it if you are interested in memory management development! * Name: **Kernel Newbies IRC Channel and Website** :URL: https://www.kernelnewbies.org :Keywords: IRC, newbies, channel, asking doubts. :Description: #kernelnewbies on irc.oftc.net. #kernelnewbies is an IRC network dedicated to the 'newbie' kernel hacker. The audience mostly consists of people who are learning about the kernel, working on kernel projects or professional kernel hackers that want to help less seasoned kernel people. #kernelnewbies is on the OFTC IRC Network. Try irc.oftc.net as your server and then /join #kernelnewbies. The kernelnewbies website also hosts articles, documents, FAQs... * Name: **linux-kernel mailing list archives and search engines** :URL: http://vger.kernel.org/vger-lists.html :URL: http://www.uwsg.indiana.edu/hypermail/linux/kernel/index.html :URL: http://groups.google.com/group/mlist.linux.kernel :Keywords: linux-kernel, archives, search. :Description: Some of the linux-kernel mailing list archivers. If you have a better/another one, please let me know.   "}),a.add({id:24,href:"/tags/balancing/",title:"balancing",description:"",content:""}),a.add({id:25,href:"/tags/irq/",title:"irq",description:"",content:""}),a.add({id:26,href:"/tags/nic/",title:"nic",description:"",content:""}),a.add({id:27,href:"/blog/irq-balancing/",title:"ä¸­æ–­è¯·æ±‚è´Ÿè½½å‡è¡¡",description:"åœ¨å¤šCPUç³»ç»Ÿä¸Šï¼Œå¦‚ä½•å¯¹è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä»¥æå‡ä¸­æ–­å¤„ç†æ•ˆç‡ã€‚æœ¬æ–‡ä»¥å¤šé˜Ÿåˆ—ã€å•é˜Ÿåˆ—ç½‘å¡ä¸ºä¾‹ä»‹ç»äº†ä¸­æ–­çš„è´Ÿè½½å‡è¡¡æ–¹æ³•ã€‚",content:"å¦‚æœç½‘å¡NICæ”¯æŒå¤šé˜Ÿåˆ—ï¼Œå¯ä»¥ç›´æ¥è®¾ç½®NICå¤šä¸ªé˜Ÿåˆ—çš„irq affinityåˆ°ä¸åŒçš„CPUæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼› å¦‚æœç½‘å¡NICæ˜¯å•é˜Ÿåˆ—çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡RFSæˆ–è€…RPSåœ¨soft interruptå±‚é¢è¿›è¡Œæ¨¡æ‹Ÿï¼Œæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼› RPSã€RFSè¿™ç§æ–¹å¼ä¸»è¦æ˜¯é’ˆå¯¹å•é˜Ÿåˆ—NICçš„ä¼˜åŒ–ã€‚\næˆ‘ä»¬æ˜¯ä»¥ç½‘å¡ä¸­æ–­ä½œä¸ºç¤ºä¾‹ï¼Œå¯¹å…¶ä»–ä¸åŒçš„è®¾å¤‡å…¶å®ä¹Ÿå¯ä»¥åšç±»ä¼¼å¤„ç†ã€‚ å¹¶ä¸æ˜¯è¯´æ‰€æœ‰çš„è®¾å¤‡ä¸­æ–­éƒ½éœ€è¦ç»‘å®šåˆ°å¤šä¸ªcpuæ¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºæœ‰çš„å¤–è®¾çš„ä¸­æ–­è¯·æ±‚æ•°å¯èƒ½å¹¶ä¸å¤šï¼Œå°±æ²¡å¿…è¦äº†ã€‚\nå¤šé˜Ÿåˆ—ç½‘å¡ethtool -l eth0å¯ä»¥çœ‹åˆ°combinedå­—æ®µï¼Œè¯¥å­—æ®µè¡¨æ˜NICæœ‰å‡ ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœæœ‰å¤šä¸ªé˜Ÿåˆ—ï¼Œæ¯”å¦‚8ä¸ªï¼Œ é‚£ä¹ˆå¯¹åº”çš„cpu affinityå¯ä»¥ç›´æ¥è®¾ç½®æˆffï¼Œè¡¨ç¤ºCPU0-7éƒ½å¯ä»¥æ”¶NICä¸­æ–­è¯·æ±‚æ¥å®ç°è´Ÿè½½å‡è¡¡ã€‚\nlspci -vvvå¯ä»¥çœ‹åˆ°ä¸åŒçš„è®¾å¤‡å¯¹åº”çš„ä¸­æ–­å·ï¼Œå¦‚ç½‘å¡è®¾åˆ«å¯èƒ½æ˜¯ï¼špin A routed to IRQ 10ï¼Œæˆ‘ä»¬å°±çŸ¥é“10æ˜¯å…¶ä¸­æ–­å·ã€‚\nTODO:\n irq affinityè®¾å®šäº†æƒ…å†µä¸‹ï¼ŒOSå’Œç¡¬ä»¶æ˜¯å¦‚ä½•äº¤äº’çš„ï¼Ÿå¦‚ä½•è´Ÿè½½å‡è¡¡çš„ï¼Œæ˜¯åœ¨ç¡¬ä»¶å±‚é¢å®ç°çš„ï¼Ÿ RPS/RFSï¼Œè¿™ç§è½¯ä¸­æ–­å±‚é¢çš„å¤„ç†ï¼Œå…·ä½“ç»†èŠ‚æ˜¯æ€æ ·çš„ï¼Ÿ  ä¸‹é¢ä»¥å¤šé˜Ÿåˆ—ç½‘å¡ä¸ºä¾‹æ¥è¯´æ˜æ€ä¹ˆå›äº‹ã€‚\nå¤šé˜Ÿåˆ—ç½‘å¡å®ç°åŸç† # 1.ç¡¬ä»¶å®ç°åŸç† # ä¸‹å›¾æ˜¯Intel 82575ç¡¬ä»¶é€»è¾‘å›¾ï¼Œæœ‰å››ä¸ªç¡¬ä»¶é˜Ÿåˆ—ã€‚å½“æ”¶åˆ°æŠ¥æ–‡æ—¶ï¼Œé€šè¿‡hashåŒ…å¤´çš„SIPã€Sportã€DIPã€Dportå››å…ƒç»„ï¼Œå°†ä¸€æ¡æµæ€»æ˜¯æ”¶åˆ°ç›¸åŒçš„é˜Ÿåˆ—ã€‚åŒæ—¶è§¦å‘ä¸è¯¥é˜Ÿåˆ—ç»‘å®šçš„ä¸­æ–­ã€‚\n2.å•é˜Ÿåˆ—é©±åŠ¨åŸç† # kernelä»2.6.21ç‰ˆæœ¬ä¹‹å‰ä¸æ”¯æŒå¤šé˜Ÿåˆ—ç‰¹æ€§ï¼Œä¸€ä¸ªç½‘å¡åªèƒ½ç”³è¯·ä¸€ä¸ªä¸­æ–­å·ï¼Œå› æ­¤åŒä¸€ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªæ ¸åœ¨å¤„ç†ç½‘å¡æ”¶åˆ°çš„åŒ…ã€‚å¦‚å›¾2.1ï¼Œåè®®æ ˆé€šè¿‡NAPIè½®è¯¢æ”¶å–å„ä¸ªç¡¬ä»¶queueä¸­çš„æŠ¥æ–‡åˆ°å›¾2.2çš„net_deviceæ•°æ®ç»“æ„ä¸­ï¼Œé€šè¿‡QDiscé˜Ÿåˆ—å°†æŠ¥æ–‡å‘é€åˆ°ç½‘å¡ã€‚\n2.å¤šé˜Ÿåˆ—é©±åŠ¨åŸç† # 2.6.21å¼€å§‹æ”¯æŒå¤šé˜Ÿåˆ—ç‰¹æ€§ï¼Œå½“ç½‘å¡é©±åŠ¨åŠ è½½æ—¶ï¼Œé€šè¿‡è·å–çš„ç½‘å¡å‹å·ï¼Œå¾—åˆ°ç½‘å¡çš„ç¡¬ä»¶queueçš„æ•°é‡ï¼Œå¹¶ç»“åˆCPUæ ¸çš„æ•°é‡ï¼Œæœ€ç»ˆé€šè¿‡Sum=Minï¼ˆç½‘å¡queueï¼ŒCPU coreï¼‰å¾—å‡ºæ‰€è¦æ¿€æ´»çš„ç½‘å¡queueæ•°é‡ï¼ˆSumï¼‰ï¼Œå¹¶ç”³è¯·Sumä¸ªä¸­æ–­å·ï¼Œåˆ†é…ç»™æ¿€æ´»çš„å„ä¸ªqueueã€‚\nå¦‚å›¾3.1ï¼Œå½“æŸä¸ªqueueæ”¶åˆ°æŠ¥æ–‡æ—¶ï¼Œè§¦å‘ç›¸åº”çš„ä¸­æ–­ï¼Œæ”¶åˆ°ä¸­æ–­çš„æ ¸ï¼Œå°†è¯¥ä»»åŠ¡åŠ å…¥åˆ°åè®®æ ˆè´Ÿè´£æ”¶åŒ…çš„è¯¥æ ¸çš„NET_RX_SOFTIRQé˜Ÿåˆ—ä¸­ï¼ˆNET_RX_SOFTIRQåœ¨æ¯ä¸ªæ ¸ä¸Šéƒ½æœ‰ä¸€ä¸ªå®ä¾‹ï¼‰ï¼Œåœ¨NET_RX_SOFTIRQä¸­ï¼Œè°ƒç”¨NAPIçš„æ”¶åŒ…æ¥å£ï¼Œå°†æŠ¥æ–‡æ”¶åˆ°CPUä¸­å¦‚å›¾3.2çš„æœ‰å¤šä¸ªnetdev_queueçš„net_deviceæ•°æ®ç»“æ„ä¸­ã€‚\nè¿™æ ·ï¼ŒCPUçš„å„ä¸ªæ ¸å¯ä»¥å¹¶å‘çš„æ”¶åŒ…ï¼Œå°±ä¸ä¼šå› ä¸ºä¸€ä¸ªæ ¸ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå¯¼è‡´ç½‘ç»œIOæ€§èƒ½ä¸‹é™ã€‚\nRSSï¼ˆReceive Side Scalingï¼Œç½‘å¡çš„ç¡¬ä»¶ç‰¹æ€§ï¼Œå¤šé˜Ÿåˆ—ç½‘å¡å°†ä¸åŒçš„æµåˆ†å‘åˆ°ä¸åŒçš„CPUä¸Šå®ç°è´Ÿè½½å‡è¡¡ï¼‰éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œåœ¨ä¸æ”¯æŒRSSçš„ç¯å¢ƒä¸­ï¼ŒRPS/RFSæä¾›äº†è½¯ä»¶çš„è§£å†³æ–¹æ¡ˆã€‚\n RPSï¼ˆReceive Packet Steeringï¼‰æ˜¯æŠŠä¸€ä¸ªrxé˜Ÿåˆ—çš„è½¯ä¸­æ–­åˆ†å‘åˆ°å¤šä¸ªCPUæ ¸ä¸Šï¼Œä»è€Œè¾¾åˆ°è´Ÿè½½å‡è¡¡çš„ç›®çš„ã€‚ RFSï¼ˆReceive Flow Steeringï¼‰æ˜¯RPSçš„æ‰©å±•ï¼ŒRPSåªä¾é hashæ¥æ§åˆ¶æ•°æ®åŒ…ï¼Œæä¾›è´Ÿè½½å¹³è¡¡ï¼Œä½†æ˜¯æ²¡æœ‰è€ƒè™‘åˆ°åº”ç”¨ç¨‹åºçš„ä½ç½®ï¼ˆæŒ‡åº”ç”¨ç¨‹åºæ‰€åœ¨CPUï¼‰ã€‚RFSç›®æ ‡æ˜¯é€šè¿‡æŒ‡æ´¾åº”ç”¨çº¿ç¨‹æ­£åœ¨è¿è¡Œçš„CPUå¤„ç†ä¸­æ–­ï¼Œå¢åŠ æ•°æ®ç¼“å­˜çš„å‘½ä¸­ç‡ã€‚  å‚è€ƒå†…å®¹ï¼š\n"}),a.add({id:28,href:"/tags/affinity/",title:"affinity",description:"",content:""}),a.add({id:29,href:"/tags/interrupt/",title:"interrupt",description:"",content:""}),a.add({id:30,href:"/blog/irq-affinity/",title:"ä¸­æ–­è¯·æ±‚äº²å’Œæ€§",description:"è®¡ç®—æœºç¡¬ä»¶è®¾å¤‡ï¼Œæœ‰äº›é€šè¿‡ä¸­æ–­çš„æ–¹å¼é€šçŸ¥CPUæœ‰æ•°æ®åˆ°è¾¾è¿›è€Œå¯ä»¥å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚é‚£ä¹ˆè¿™é‡Œè®¾å¤‡çš„ä¸­æ–­è¯·æ±‚æ˜¯å¦‚ä½•å‘é€åˆ°å„ä¸ªå¤„ç†å™¨çš„å‘¢ï¼Œæ˜¯å‘é€åˆ°æ‰€æœ‰çš„å¤„ç†å™¨ï¼Œè¿˜æ˜¯é€‰æ‹©ä¸€ä¸ªå‘é€ï¼Œæœ‰æ²¡æœ‰å¯èƒ½æŒ‡å®šå“åº”ä¸­æ–­çš„CPUåˆ—è¡¨ï¼Œå³æœ¬æ–‡æåˆ°çš„ä¸­æ–­è¯·æ±‚çš„äº²å’Œæ€§é—®é¢˜ã€‚Linuxå†…æ ¸æ–‡æ¡£ä¸­irq-affinity.rstå¯¹æ­¤è¿›è¡Œäº†æè¿°ï¼Œæœ¬æ–‡å‚ç…§ç€æ–‡æ¡£å¯¹irq affinityè¿›è¡Œè®¾ç½®ã€æµ‹è¯•ï¼ŒåŠ æ·±ç†è§£ã€‚",content:"SMP IRQ affinityï¼ŒæŒ‡çš„æ˜¯å¯¹ç§°å¤šå¤„ç†å™¨ä¸­çš„ä¸­æ–­è¯·æ±‚ç»‘å®šã€‚\n/proc/irq/IRQ#/smp_affinityå’Œ/proc/irq/IRQ#/smp_affinity_listæŒ‡æ˜äº†å…è®¸æ¥æ”¶æŸ ä¸ªä¸­æ–­è¯·æ±‚IRQ#çš„å¤šä¸ªæˆ–æŸä¸ªcpuã€‚å®ƒæ˜¯ä¸€ä¸ªä½æ©ç smp_affinityæˆ–è€…ä¸€ä¸ªcpuåˆ—è¡¨ smp_affinity_listï¼Œå…¶ä¸­è®°å½•äº†å…è®¸æ¥å—è¯¥ä¸­æ–­è¯·æ±‚çš„cpuã€‚ä¸å…è®¸ç¦æ­¢æ‰€æœ‰cpuæ¥æ”¶è¯¥ ä¸­æ–­è¯·æ±‚ï¼Œå¦‚æœä¸€ä¸ªä¸­æ–­æ§åˆ¶å™¨ä¸æ”¯æŒä¸­æ–­è¯·æ±‚ç»‘å®šï¼Œé‚£ä¹ˆåªèƒ½é‡‡ç”¨é»˜è®¤å€¼ï¼Œå³å…è®¸æ‰€æœ‰ cpuæ¥æ”¶è¯¥ä¸­æ–­è¯·æ±‚ï¼Œå¹¶ä¸”è¿™ä¸ªå€¼ä¸ä¼šè¢«ä¿®æ”¹ã€‚\n/proc/irq/default_smp_affinityæŒ‡æ˜äº†é»˜è®¤çš„ä¸­æ–­ç»‘å®šæ©ç ï¼Œè¿™ä¸ªé»˜è®¤å€¼å°†åº”ç”¨äºæ‰€æœ‰ çš„éæ´»åŠ¨çš„ã€æœªæ¿€æ´»çš„ä¸­æ–­å·ã€‚ä¸€æ—¦ä¸€ä¸ªä¸­æ–­å·è¢«åˆ†é…ã€æ¿€æ´»ï¼Œé‚£ä¹ˆå®ƒçš„ä¸­æ–­ç»‘å®šæ©ç å°† è¢«è®¾ç½®ä¸ºè¿™ä¸ªé»˜è®¤å€¼ã€‚è¿™ä¸ªé»˜è®¤å€¼å¯ä»¥é€šè¿‡å‰é¢æåˆ°è¿‡çš„æ–¹æ³•è¿›è¡Œä¿®æ”¹ã€‚è¿™ä¸ªé»˜è®¤æ©ç çš„ å€¼ä¸º0xffffffffï¼Œè¯·æ³¨æ„ï¼Œè¯¥æ©ç æ˜¯32ä½çš„ã€‚\nè¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œç½‘å¡eth1ä¸­æ–­è¯·æ±‚IRQ44é™å®šå‘é€åˆ°CPU0-3ï¼Œè€Œåå†é™å®šå‘é€åˆ°CPU4-7ã€‚\nç½‘å¡å‘cpuå‘ä¸­æ–­è¯·æ±‚44ï¼Œä¸‹é¢æˆ‘ä»¬å¯¹è¿™ä¸ªä¸­æ–­è¯·æ±‚ä¸cpuçš„ç»‘å®šå…³ç³»è¿›è¡Œè®¾ç½®ï¼Œå¹¶é€šè¿‡ pingå‘½ä»¤è¿›è¡Œæµ‹è¯•ï¼Œç½‘å¡ä¼šå°†æ¥æ”¶åˆ°çš„icmpè¯·æ±‚ï¼Œä»¥ä¸­æ–­44çš„å½¢å¼å‘é€åˆ°ç»‘å®šçš„cpuï¼Œé€š è¿‡æŸ¥çœ‹cpuæ¥æ”¶åˆ°çš„ä¸­æ–­è¯·æ±‚æ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­ï¼Œè¿™ä¸ª44è¿™ä¸ªä¸­æ–­è¯·æ±‚ä¸cpuçš„ç»‘å®šå…³ç³» ã€‚\n[root@moon 44]# cd /proc/irq/44 [root@moon 44]# cat smp_affinity ffffffff  é¦–å…ˆï¼ŒæŸ¥çœ‹åˆ°44è¿™ä¸ªä¸­æ–­è¯·æ±‚çš„é»˜è®¤ç»‘å®šæ©ç ä¸º0xffffffffï¼Œè¯´æ˜ï¼Œæ‰€æœ‰çš„cpuéƒ½å¯ä»¥æ¥ æ”¶è¯¥ä¸­æ–­è¯·æ±‚ã€‚\n[root@moon 44]# echo 0f \u0026gt; smp_affinity [root@moon 44]# cat smp_affinity 0000000f  ç„¶åæˆ‘ä»¬è®¾ç½®smp_affinityçš„å€¼ä¸º0x0000000fï¼Œå³ä½¿å¾—ç¼–å·ä¸º0-3çš„cpuå…è®¸æ¥æ”¶è¯¥44è¿™ä¸ª ä¸­æ–­è¯·æ±‚ï¼Œå…¶ä»–çš„cpuéƒ½ä¸ä¼šæ¥æ”¶44è¿™ä¸ªä¸­æ–­è¯·æ±‚ã€‚\n[root@moon 44]# ping -f h PING hell (195.4.7.3): 56 data bytes ... --- hell ping statistics --- 6029 packets transmitted, 6027 packets received, 0% packet loss round-trip min/avg/max = 0.1/0.1/0.4 ms  ç„¶åï¼Œå¯¹ä¸»æœºè¿›è¡Œpingæµ‹è¯•ï¼Œè¿™é‡Œçš„-fè¡¨ç¤ºæ´ªæ³›ï¼Œhè¡¨ç¤ºä¸»æœºï¼Œå®é™…æµ‹è¯•çš„æ—¶å€™ï¼Œå¯ä»¥ä¿® æ”¹ä¸ºlocalhostã€‚è¿™ä¸ªæ—¶å€™ï¼Œåº”ç”¨ç¨‹åºpingå‘ä¸»æœºå‘é€äº†icmpè¯·æ±‚åŒ…ï¼Œç½‘å¡è®¾å¤‡æ•è·åˆ°ä¹‹ åï¼Œä¼šå‘cpuå‘é€ä¸­æ–­å·ä¸º44çš„ä¸­æ–­è¯·æ±‚ã€‚ç°åœ¨è¯¥ä¸»æœºä¸Šæœ‰8ä¸ªcpuï¼Œç”±äºæˆ‘ä»¬è®¾ç½®äº†ç¼–å· ä¸º0-3çš„cpuå¯ä»¥æ¥æ”¶è¯¥ä¸­æ–­ï¼Œå…¶ä»–çš„åˆ™ä¸å¯ä»¥ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æŸ¥çœ‹cpuå¯¹ä¸­æ–­44çš„æ¥æ”¶æƒ… å†µæ—¶ï¼Œåªæœ‰ç¼–å·ä¸º0-3çš„cpuæ‰èƒ½æ¥æ”¶åˆ°ä¸­æ–­è¯·æ±‚ã€‚\n[root@moon 44]# cat /proc/interrupts | grep 'CPU\\|44:' CPU0 CPU1 CPU2 CPU3 CPU4 CPU5 CPU6 CPU7 44: 1068 1785 1785 1783 0 0 0 0 IO-APIC-level eth1  é€šè¿‡æŸ¥çœ‹æµ‹è¯•ç»“æœï¼Œæˆ‘ä»¬å‘ç°cpu 4-7 ç¡®å®æ²¡æœ‰æ¥æ”¶åˆ°ç¼–å·ä¸º44çš„ä¸­æ–­è¯·æ±‚ï¼Œä½†æ˜¯ç¼–å· ä¸º0-3çš„cpuæ¥æ”¶åˆ°äº†è¯¥ä¸­æ–­è¯·æ±‚ã€‚\nç°åœ¨å°†å…¶é™å®šåˆ°CPU4-7ä¸Šå»ï¼š\n[root@moon 44]# echo f0 \u0026gt; smp_affinity [root@moon 44]# cat smp_affinity 000000f0  è¿›ä¸€æ­¥è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬å°†å…è®¸æ¥æ”¶ç¼–å·44çš„ä¸­æ–­è¯·æ±‚çš„cpuè®¾å®šä¸ºç¼–å·4-7ï¼Œå³å°† smp_affinityçš„å€¼è®¾å®šä¸º0x000000f0ï¼Œä¸‹é¢å†æ¬¡é€šè¿‡pingè¿›è¡Œæµ‹è¯•ã€‚\n[root@moon 44]# ping -f h PING hell (195.4.7.3): 56 data bytes .. --- hell ping statistics --- 2779 packets transmitted, 2777 packets received, 0% packet loss round-trip min/avg/max = 0.1/0.5/585.4 ms [root@moon 44]# cat /proc/interrupts | 'CPU\\|44:' CPU0 CPU1 CPU2 CPU3 CPU4 CPU5 CPU6 CPU7 44: 1068 1785 1785 1783 1784 1069 1070 1069 IO-APIC-level eth1  å°†å½“å‰cpuæ¥æ”¶åˆ°çš„ä¸­æ–­è¯·æ±‚44çš„æ•°é‡ï¼Œä¸å‰é¢ä¸€æ¬¡pingæµ‹è¯•æ—¶å„ä¸ªcpuæ¥æ”¶åˆ°çš„ä¸­æ–­è¯·æ±‚ 44çš„æ•°é‡å¯¹æ¯”å‘ç°ï¼Œåªæœ‰ç¼–å·ä¸º4-7çš„cpuæ¥æ”¶åˆ°çš„ä¸­æ–­è¯·æ±‚44çš„æ•°é‡å‘ç”Ÿäº†æ”¹å˜ï¼Œè¯´æ˜æˆ‘ ä»¬æˆåŠŸçš„è®¾ç½®äº†ä¸­æ–­è¯·æ±‚44çš„ä¸­æ–­ç»‘å®šåˆ°cpu 4-7ã€‚\nå¦‚æœæƒ³å°†ä¸­æ–­è¯·æ±‚é™å®šå‘é€åˆ°CPU1024-1031ä¸Šï¼Œå¯ä»¥è¿™ä¹ˆæ“ä½œï¼š\n[root@moon 44]# echo 1024-1031 \u0026gt; smp_affinity [root@moon 44]# cat smp_affinity 1024-1031  ä¸Šé¢çš„è¯­æ³•å¯ä»¥å°†ä¸­æ–­ç»‘å®šåˆ°ç¼–å·èŒƒå›´ä¸º1024-1031çš„cpuä¸Šã€‚\nsee: irq affinity\n"}),a.add({id:31,href:"/tags/devcontainer/",title:"devcontainer",description:"",content:""}),a.add({id:32,href:"/tags/docker/",title:"docker",description:"",content:""}),a.add({id:33,href:"/tags/ide/",title:"ide",description:"",content:""}),a.add({id:34,href:"/blog/2022-06-28-linux-cc-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E8%AE%BE%E7%BD%AE/",title:"mac/winä¸‹linux c/c++å¼€å‘",description:"Linux C/C++å¼€å‘æ˜¯å¾ˆå¤šåå°å¼€å‘åŒå­¦å¿…å¤‡çš„ä¸€é¡¹æŠ€èƒ½ï¼Œè™½ç„¶ç°åœ¨Javaã€Goç­‰è·¨å¹³å°è¯­è¨€çš„å´›èµ·ä¹Ÿå¸å¼•äº†å¾ˆå¤šå¼€å‘è€…ï¼Œåœ¨æŸäº›ä¸šåŠ¡ä¸­å¾—åˆ°äº†å¤§é‡çš„å®è·µï¼Œä½†æ˜¯C/C++ä¾ç„¶æ˜¯è¢«å¹¿æ³›ä½¿ç”¨çš„ã€‚æ®æˆ‘è§‚å¯Ÿï¼Œè¿›è¡ŒLinux C/C++å¼€å‘æ—¶åœ¨å·¥å…·æ”¯æŒä¸Šè¿˜æ˜¯æ²¡æœ‰Javaã€Goç­‰å¼€å‘èµ·æ¥æ–¹ä¾¿ï¼Œæ¯”å¦‚è¿™ä¸ªè·¨å¹³å°å¼€å‘Linux C/C++ç¨‹åºçš„é—®é¢˜ï¼Œå¤´æ–‡ä»¶ã€åº“ç­‰ç­‰åœ°æ€ä¹ˆé…ç½®ç€ï¼Œç¼–è¯‘æµ‹è¯•æ€ä¹ˆç©ç€ï¼Œè¯´çœŸçš„ï¼Œæˆ‘çœ‹äº†æœ‰äº›åŒäº‹çš„åšæ³•çœŸçš„å¤´å¤§ï¼Œç‰¹åˆ«åŸå§‹ã€‚æœ¬æ–‡å°±è¿™ä¸ªé—®é¢˜è¿›è¡Œä¸€ç‚¹è°ƒç ”ã€æ€»ç»“ï¼Œä¹Ÿä¸ºæ—¥åå¯èƒ½çš„ç±»ä¼¼å¼€å‘å·¥ä½œåšä¸€äº›å‡†å¤‡ã€‚",content:"é—®é¢˜èƒŒæ™¯ # æˆ‘ä»¬å¾ˆå¤šäººä¸»åŠ›æ“ä½œç³»ç»Ÿæ˜¯macOSæˆ–è€…Windowsï¼Œç”¨Linuxä½œä¸ºä¸»åŠ›æ“ä½œç³»ç»Ÿçš„å°‘å§ï¼Œä¸è¿‡ä¹‹å‰ç¡®å®æœ‰è¿ç»­7å¹´å¤šæ˜¯ç”¨Fedoraä½œä¸ºä¸»åŠ›æ“ä½œç³»ç»Ÿ :)\nç°åœ¨å¾ˆå¤šäººå¼€å‘äººå‘˜ä½¿ç”¨MacBook Proä½œä¸ºè‡ªå·±çš„å¼€å‘æœºï¼Œå¤§å‚æ ‡é…ï¼Œæˆ‘ä»¬å¾ˆå¤šåå°å‘¢ï¼Œå¼€å‘çš„ç¨‹åºä¸€èˆ¬æœ€åè¿˜æ˜¯è¦è·‘åœ¨Linuxç³»ç»Ÿä¸Šçš„ï¼Œå°¤å…¶æ˜¯c/c++å¼€å‘æ¶‰åŠåˆ°è¿™é‡Œçš„è·¨å¹³å°å¼€å‘çš„é—®é¢˜ï¼Œå¾ˆå¤šå¼€å‘äººå‘˜ç”¨ç€éå¸¸åŸå§‹çš„æ–¹å¼åœ¨å¼€å‘ï¼Œå¼€å‘ä½“éªŒæ¯”è¾ƒå·®ã€‚\nå€Ÿè¿™ä¸ªå¥‘æœºï¼Œæˆ‘è°ƒç ”äº†ä¸‹ç°åœ¨æ¯”è¾ƒå¥½çš„ä¸€äº›å¼€å‘æ–¹å¼ï¼Œæ€»ç»“åˆ†äº«ä¸‹ã€‚\nå…ˆå®šä¸€ä¸ªè¦å®ç°çš„å°ç›®æ ‡ï¼š\n èƒ½åŸºäºIDEè¿›è¡Œå¼€å‘ï¼Œæ¯”å¦‚VSCode; å¦å¤–ï¼Œç¼–è¯‘æ„å»ºå¿…é¡»èƒ½å¤Ÿ  vscode: add dockerfile to workspace #  åœ¨vscodeä¸­cmd+pï¼Œè¾“å…¥add dockerfile to workspaceå¹¶æ‰§è¡Œï¼Œæ­¤æ—¶ä¼šé€‰æ‹©åŸºç¡€é•œåƒï¼Œå¦‚é¢å‘c++å¼€å‘çš„åŸºç¡€é•œåƒï¼Œæ­¤æ—¶ä¼šç”Ÿæˆé»˜è®¤çš„dockerfileã€‚ ç„¶ååœ¨dockerfileé€‰ä¸­åç‚¹å‡»å³é”®ï¼Œé€‰æ‹©build imageï¼Œæ­¤æ—¶å°±å®Œæˆé•œåƒæ„å»ºäº†ï¼Œè¯¥é»˜è®¤dockerfileé»˜è®¤æ˜¯ä¸€ä¸ªç¼–è¯‘é•œåƒï¼Œé‡Œé¢åŒ…å«äº†ç¼–è¯‘æ„å»ºäº§ç‰©ã€‚ ç›´æ¥è¿è¡Œä¸Šè¿°é•œåƒé»˜è®¤å°±æ˜¯è¿è¡Œç¨‹åºï¼Œè¿è¡Œçš„æ–¹å¼å¯ä»¥åœ¨docker exploreré‡Œé¢æ‰¾åˆ°é•œåƒï¼Œå³é”®èœå•ä¸­é€‰æ‹©Runï¼Œæˆ–è€…å‘½ä»¤è¡Œæ‰§è¡Œã€‚  è¿™ä¸ªé•œåƒåªæ˜¯ç”¨æ¥ç¼–è¯‘æ„å»ºã€æµ‹è¯•è¿è¡Œçš„ï¼Œè¿˜ä¸èƒ½æ»¡è¶³æˆ‘ä»¬å¼€å‘é˜¶æ®µçš„éœ€æ±‚ï¼Œå› ä¸ºå¼€å‘é˜¶æ®µéœ€è¦è€ƒè™‘å¤´æ–‡ä»¶ã€åº“çš„æœç´¢é—®é¢˜ã€‚\nè§£å†³æ€è·¯ï¼š\n è‡³å°‘è¦æ„å»ºä¸€ä¸ªæ”¯æŒå¼€å‘çš„é•œåƒï¼Œå¦‚c/c++é•œåƒï¼› å¯åŠ¨è¿™ä¸ªé•œåƒï¼Œå¹¶å°†å½“å‰å·¥ç¨‹ä»¥volumeçš„å½¢å¼æŒ‚åœ¨åˆ°å®¹å™¨ä¸­ï¼Œæˆ–è€…åœ¨å®¹å™¨ä¸­cloneä¸‹æ¥è¿™ä¸ªé¡¹ç›®ã€‚æäº¤ä»£ç è¦æ³¨æ„éšæ—¶æäº¤ï¼› å¼€å‘é€šè¿‡vscode remoteè¿æ¥åˆ°vscode serverè¿›è¡Œå¼€å‘ï¼Œå…¶å®æ˜¯æœ¬åœ°vscodeé€šè¿‡sshè¿æ¥ä¼ è¾“vscode serverè½¯ä»¶åŒ…åˆ°å®¹å™¨ä¸­å¹¶å®‰è£…å¯åŠ¨ï¼› å¦‚æœå¼€å‘é•œåƒæ”¯æŒç±»ä¼¼WebIDEçš„æ–¹å¼è¿›è¡Œå¼€å‘ï¼Œä¹Ÿå¯ä»¥ä»£æ›¿3è¿™ç§æ–¹å¼ï¼Œåªæ˜¯ä¸€äº›æœ¬åœ°vscodeçš„å¿«æ·é…ç½®ç­‰å¯èƒ½ä¸æ˜¯å¾ˆå¥½åŒæ­¥ã€‚  docker desktop: New Dev environment # Docker Desktopçš„è¿™ç§å®ç°æ–¹å¼ï¼Œå°±æ˜¯ä¸Šé¢æåˆ°çš„2\\3è¿™å‡ æ­¥çš„ç»„åˆï¼ŒåŸºæœ¬æ»¡è¶³æˆ‘ä»¬å¸Œæœ›å®ç°çš„ç›®æ ‡äº†ï¼ˆæ”¯æŒå¼€å‘å®¹å™¨Mount local directoryæˆ–è€…å®¹å™¨ä¸­Clone git repositoryï¼‰ã€‚\nè¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸è¶³ï¼Œå°±æ˜¯å‡è®¾åç»­æœ‰äººè¦æ¥æ‰‹è¿™ä¸ªé¡¹ç›®ï¼Œæˆ–è€…æœ‰äººå’Œä½ åä½œï¼Œä½ æ€ä¹ˆåŠå‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥ç›´æ¥æäº¤ä¸€ä¸ªé•œåƒpushåˆ°registryï¼Œä»–åªè¦èƒ½æ‹‰ä»£ç ï¼Œåˆèƒ½æ‹‰é•œåƒå°±åŸºæœ¬èƒ½è¿˜åŸä¹‹å‰çš„å¼€å‘ç¯å¢ƒã€‚\nä½†æ˜¯æˆ‘ä¸ºä»€ä¹ˆéè¦pushä¸€ä¸ªé•œåƒä¸Šå»å‘¢ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰çš„åŸºç¡€é•œåƒã€å¼€å‘é˜¶æ®µçš„åˆ†äº«é•œåƒï¼‰ï¼Ÿ å¦‚æœä¸pushé•œåƒè€Œdocker destopé»˜è®¤çš„å¼€å‘é•œåƒè°ƒæ•´äº†æˆ–è€…æˆ‘å¸Œæœ›å®šåˆ¶ä¸€ä¸ªç»Ÿä¸€çš„æ€ä¹ˆåŠï¼Ÿ\nDocker Desktopåˆ›å»ºæ–°çš„å¼€å‘é•œåƒçš„æ—¶å€™æœ‰ä¸€ç§æ–¹å¼ï¼Œå…è®¸æŒ‡å®šä¸€ä¸ªåŸºç¡€é•œåƒï¼Œä½†æ˜¯è¿™ä¸ªåŸºç¡€é•œåƒè¦pushåˆ°è¿œç¨‹registryã€‚ä»£ç ä¼šè¢«cloneåˆ°è¿™ä¸ª å®¹å™¨å†…éƒ¨ï¼Œæˆ‘ä»¬å°±é€šè¿‡vscode remoteè¿›è¡Œå¼€å‘å³å¯ã€‚\nå°½ç®¡vscodeé¼“åŠ±éLinuxç”¨æˆ·å°½é‡é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå› ä¸ºfsæ“ä½œæ›´å¿«ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ç‚¹ä¸æ–¹ä¾¿ï¼Œå› ä¸ºè¿™æ•°æ®å·ç›¸å½“äºé¢å¤–æµªè´¹ä¸€ä»½å­˜å‚¨ï¼Œè€ƒè™‘åˆ°ä¹‹å‰å·²ç»å…‹éš†è¿‡çš„æƒ…å†µä¸‹ã€‚ æœ‰æ²¡æœ‰åŠæ³•æ—¢èƒ½è‡ªå®šä¹‰åŸºç¡€é•œåƒï¼Œåˆèƒ½æŒ‚è½½æœ¬åœ°ç£ç›˜ç›®å½•ä¸ºæ•°æ®å·çš„æ–¹å¼æ¥è§£å†³å‘¢ï¼Ÿå¯ä»¥ï¼Œè¯·çœ‹æ–¹å¼3ã€‚\nvscode: Remote-Containers # vscodeä¸­Command Palleteä¸­Remote-Containers: Add Development Container Configuration Filesï¼Œæ‰§è¡Œè¿™ä¸ªæˆ‘ä»¬å¯ä»¥ä¸ºå·¥ç¨‹æŒ‡å®šä¸€ä¸ªé…ç½®æ–‡ä»¶.devcontainer(å®é™…æ˜¯ä¸ªç›®å½•)ï¼Œ.devcontainer/devcontainer.jsonä¸­æŒ‡æ˜äº†æˆ‘ä»¬è¦ä½¿ç”¨å“ªä¸ªé•œåƒä½œä¸ºå¼€å‘å®¹å™¨çš„åŸºç¡€é•œåƒã€‚ è¿™é‡Œçš„åŸºç¡€é•œåƒå¯ä»¥ç”¨vscodeå®˜æ–¹æä¾›çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯è‡ªå·±è‡ªå®šä¹‰å¥½pushåˆ°registryçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯Dockerfileéœ€è¦vscodeä»£ä¸ºæ„å»ºæœ¬åœ°é•œåƒçš„ï¼Œè¿™å‡ ç§æ–¹å¼å‡å¯ï¼\nè¿™æ ·ä¸å°±æ–¹ä¾¿äº†å—ï¼Œæ—¢ä¸éœ€è¦é¢å¤–å­˜å‚¨è¿™ä¸ªåŸºç¡€é•œåƒï¼Œè¿˜ä¿ç•™äº†ç»´æŠ¤åŸºç¡€é•œåƒçš„å¿…è¦é…ç½®ä¿¡æ¯ï¼Œå¦‚Dockerfileç­‰ã€‚å½“ç„¶äº†å¦‚æœåŸºç¡€é•œåƒç»´æŠ¤å¾—å½“ï¼Œæˆ‘ä»¬å¼•ç”¨registry ä¸­çš„åŸºç¡€é•œåƒå³å¯ï¼Œæ²¡å¿…è¦æ¯ä¸ªå·¥ç¨‹ä¸‹éƒ½æ”¾ä¸€ä»½é•œåƒDockerfileä¿¡æ¯ã€‚\næˆ‘ç›®å‰æ¯”è¾ƒå–œæ¬¢è¿™ç§æ–¹å¼ï¼Œå› ä¸ºå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰åŸºç¡€é•œåƒçš„åŒæ—¶ï¼Œæ²¡æœ‰äº†é¢å¤–å®¹å™¨ä¸­å…‹éš†ä»£ç å¯¼è‡´çš„å ç”¨ç£ç›˜ç©ºé—´é—®é¢˜â€¦â€¦ä¸è¿‡è¿™æ ·æ€§èƒ½ä¼šå·®ç‚¹ã€‚\nWebIDE: åŸºäºWebIDEçš„å¼€å‘ç¯å¢ƒ # åœ¨å¼€å‘å®¹å™¨ä¸­æ”¯æŒWebIDEï¼Œgithubçš„codespaceï¼Œä»¥åŠgitpodå°±æ˜¯ç±»ä¼¼çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘è‡ªå·±ä¹ŸåŸºäºå¼€æºçš„theia WebIDEåšè¿‡ç±»ä¼¼çš„demoã€‚\nè¿™ç§æ–¹å¼ä¹Ÿæ˜¯ä¸€ä¸ªæ€è·¯ï¼Œä½†æ˜¯è¿™ç§WebIDEçš„æ–¹å¼ä¸€èˆ¬å’Œä»£ç æ‰˜ç®¡ç«™ç‚¹ç»“åˆèµ·æ¥ä¼šæ¯”è¾ƒå¥½äº›ï¼Œç°åœ¨githubä¸gitpodã€codespaceçš„ç»“åˆï¼Œè…¾è®¯å†…éƒ¨å·¥èœ‚ä¹Ÿæœ‰ä¸WebIDEçš„ç»“åˆã€‚\nè¿™ç§ç»“åˆèµ·æ¥æ˜¯æ¯”è¾ƒæ–¹ä¾¿åœ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸æœ¬åœ°vscodeçš„è”åŠ¨ï¼Œæ¥è§¦å‘ç±»ä¼¼æ–¹å¼1ä¸­çš„è¿™ç§å·¥ä½œæ–¹å¼ï¼Œsshåˆ°å¼€å‘å®¹å™¨ä¸­ï¼Œé€šè¿‡vscode clienté“¾æ¥åˆ°vscode serverã€‚\næˆ‘ä»¬è¿™é‡Œä¸»è¦ä¾§é‡äºæœ¬åœ°å¼€å‘è¿™ç§æ›´é€šç”¨ç‚¹çš„åœºæ™¯ï¼ŒåŸºäºWebIDEçš„è¿™ç§æ–¹å¼å°±ä¸ç»†è¯´äº†ï¼Œå¤§å®¶å¯ä»¥äº†è§£ä¸‹gitpodã€codespaceçš„å·¥ä½œåŸç†ã€‚\nvscode: æ›´å¤šç©æ³• # vscodeä¸­è¿˜æœ‰æ›´å¤šç©æ³•ï¼Œæ¯”å¦‚docker in dockerã€docker from dockerâ€¦å’Œå‰é¢é›†ä¸­æ–¹å¼è¦è§£å†³çš„é—®é¢˜ä¸ä¸€æ ·ï¼Œæ¯”å¦‚å°†vscode extensionå®‰è£…ä¹Ÿæ”¾åˆ°å®¹å™¨ä¸­ç®¡ç†ï¼Œè€Œä¸æ˜¯å’Œæœ¬åœ°vscodeæ··åœ¨ä¸€èµ·ã€‚æœ‰éœ€è¦çš„æ—¶å€™å†ç»†ç©¶å§ï¼Œå…ˆè¿™ä¹ˆå¤§åªäº†è§£ä¸‹ã€‚\næ€»ç»“ # æœ¬æ–‡æ€»ç»“äº†æ¯”è¾ƒå¥½ç”¨çš„è·¨å¹³å°å¼€å‘Linux C/C++ç¨‹åºçš„æ–¹æ³•ï¼Œå…¶å®ä¹Ÿä¸ä»…é™äºC/C++äº†ï¼Œè¿™ä¸ªæ–¹æ³•çš„é€‚ç”¨æ€§å¾ˆå¹¿ï¼Œåªä¸è¿‡å¯¹äºLinux C/C++è·¨å¹³å°å¼€å‘è¿™ä¸ªåœºæ™¯ï¼Œå°±æ¯”è¾ƒæœ‰ä»·å€¼ï¼Œå› ä¸ºçœ‹åˆ°å¾ˆå¤šåŒäº‹çš„åšæ³•å®åœ¨å¤ªåŸå§‹äº†ã€‚\n"}),a.add({id:35,href:"/tags/vscode/",title:"vscode",description:"",content:""}),a.add({id:36,href:"/tags/lock/",title:"lock",description:"",content:""}),a.add({id:37,href:"/tags/mmap/",title:"mmap",description:"",content:""}),a.add({id:38,href:"/tags/multiprocess/",title:"multiprocess",description:"",content:""}),a.add({id:39,href:"/tags/mutex/",title:"mutex",description:"",content:""}),a.add({id:40,href:"/blog/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E9%87%8A%E6%94%BE/",title:"ä»0ç»†è¯´å¦‚ä½•ç®¡ç†å†…å­˜çš„ï¼Ÿ",description:"ä»‹ç»ä¸‹ä»ç”¨æˆ·æ€ç”³è¯·å†…å­˜å¦‚mallocå¼€å§‹åº“å‡½æ•°åšäº†ä»€ä¹ˆã€æ“ä½œç³»ç»Ÿåšäº†ä»€ä¹ˆã€æ“ä½œç³»ç»Ÿå†…å­˜åˆ†é…å™¨æ€ä¹ˆåšçš„ã€ç”¨æˆ·æ€å†…å­˜åˆ†é…å™¨æ€ä¹ˆåšçš„ï¼Œä¸ºä»€ä¹ˆç”¨æˆ·æ€åˆè¦å•ç‹¬åšå†…å­˜åˆ†é…å™¨ã€‚ç±»ä¼¼åœ°ï¼Œé‡Šæ”¾å†…å­˜freeçš„æ—¶å€™è¿™ä¸€è¿ä¸²çš„åˆå‘ç”Ÿäº†ä»€ä¹ˆã€‚",content:""}),a.add({id:41,href:"/blog/%E5%B9%B6%E5%8F%91%E5%90%8C%E6%AD%A5/",title:"å¹¶å‘åŒæ­¥",description:"ä»‹ç»ä¸‹å¦‚ä½•å®ç°å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹é—´çš„å¹¶å‘åŒæ­¥æ§åˆ¶ï¼Œå¤šçº¿ç¨‹åœºæ™¯å¹¶å‘æ§åˆ¶æ¯”è¾ƒå¸¸è§ï¼Œå¤šè¿›ç¨‹çš„å¯èƒ½ä¸å°‘äººéƒ½æ¯”è¾ƒé™Œç”Ÿä¸€ç‚¹å§ã€‚",content:"å¹¶å‘åŒæ­¥ï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­æ˜¯éå¸¸é‡è¦çš„ã€‚å½“æˆ‘ä»¬è®¨è®ºå¹¶å‘ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¯èƒ½æ˜¯é€šè¿‡å¤šçº¿ç¨‹æ¥å®ç°ï¼Œä¹Ÿå¯èƒ½é€šè¿‡å¤šè¿›ç¨‹æ¥å®ç°ã€‚\n æˆ‘ä»¬åœ¨OSç†è®ºä¸­äº†è§£åˆ°è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯è°ƒåº¦çš„æœ€å°å•ä½ã€‚åœ¨Linuxé‡Œé¢ï¼Œè¿™ä¹ˆè®²ä¹Ÿæ˜¯æˆç«‹çš„ã€‚æ›´ç»†è‡´åœ°è¯´ï¼Œåœ¨Linuxä¸­ï¼Œçº¿ç¨‹å…¶å®å°±æ˜¯è½»é‡çº§è¿›ç¨‹LWPæ¥è¡¨ç¤ºçš„ã€‚å¯¹Linuxè°ƒåº¦å™¨è€Œè¨€ï¼Œå¯è°ƒåº¦å®ä½“æ—¢å¯ä»¥æ˜¯è¿›ç¨‹ã€çº¿ç¨‹ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªä»»åŠ¡ç»„ï¼Œè¿™ä¸ªä»»åŠ¡ç»„ä¸­åˆå¯ä»¥æœ‰å…¶ä»–çš„å¯è°ƒåº¦å®ä½“ã€‚\n æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š\n  å½“æˆ‘ä»¬åœ¨å•è¿›ç¨‹å¤šçº¿ç¨‹ä¸­è¯¥å¦‚ä½•é€šè¿‡ï¼Ÿ\n  å½“æˆ‘ä»¬åœ¨å¤šä¸ªè¿›ç¨‹é—´è¿›è¡ŒåŒæ­¥æ—¶è¯¥å¦‚ä½•åŒæ­¥ï¼Ÿ\n  æˆ‘ä»¬å¸¸ç”¨çš„åŒæ­¥çš„æªæ–½åŒ…æ‹¬ï¼š\n mutex/rwmutex semaphore condition variable  æˆ‘ä»¬å¤„ç†æœ€å¤šçš„å¯èƒ½å°±æ˜¯å•è¿›ç¨‹å¤šçº¿ç¨‹æƒ…å†µä¸‹çš„åŒæ­¥ï¼Œä½¿ç”¨ä¸Šé¢è¿™äº›æ¥å¤„ç†æ²¡å•¥å¥½è¯´çš„ã€‚ç°åœ¨æ€è€ƒä¸‹ï¼Œå¦‚æœè¦å®ç°å¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„åŒæ­¥ï¼Œæœ‰æ²¡æœ‰åŠæ³•å‘¢ï¼Ÿ\nè¿™äº›ç©æ„çš„å®ç°ï¼Œæœ¬è´¨ä¸Šæ˜¯åŸºäºå¤„ç†å™¨æŒ‡ä»¤lock addré”æ€»çº¿çš„è¿™ä¸€åŸºç¡€æ§åˆ¶ï¼Œä¸€æ­¥æ­¥å®ç°äº†CASã€Spinlockã€mutex/semaphore/condvarã€‚æ‰€ä»¥å…¶æ ¸å¿ƒå°±æ˜¯åˆ©ç”¨äº†é”ä¸€ä¸ªå†…å­˜åœ°å€æ€»çº¿æ¥å®ç°ã€‚\nokï¼Œé‚£ä¹ˆå‡è®¾æˆ‘ä»¬åœ¨å½“å‰è¿›ç¨‹å…¨å±€å˜é‡ä¸­åˆå§‹åŒ–äº†ä¸€ä¸ªmutexå˜é‡ï¼Œç„¶åforkä¸‹å½“å‰è¿›ç¨‹ï¼Œç„¶å**çˆ¶å­è¿›ç¨‹èƒ½é€šè¿‡è¿™ä¸ªmutexå˜é‡è¿›è¡ŒåŒæ­¥æ§åˆ¶å—ï¼Ÿ**ä¸èƒ½ï¼å› ä¸ºçˆ¶å­è¿›ç¨‹ä¸­å¤åˆ¶åmutexæ˜¯ä¸¤ä¸ªä¸åŒçš„å†…å­˜å˜é‡ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„å†…å­˜åœ°å€æ˜¯ä¸åŒçš„ï¼Œå…¶å®å°±æ˜¯ä¸¤ä¸ªä¸åŒçš„é”ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡è¿™ä¸ªmutexè¿›è¡Œæ­£ç¡®çš„åŒæ­¥æ§åˆ¶ã€‚\né‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬åªè¦åœ¨å…±äº«çš„å†…å­˜ç©ºé—´é‡Œé¢æ¥åˆå§‹åŒ–è¿™ä¸ªmutexå˜é‡å°±å¯ä»¥äº†ï¼ˆå…³é”®çš„å°±æ˜¯lockçš„åº•å±‚çš„å†…å­˜åœ°å€ä¸€æ ·å°±å¯ä»¥äº†ï¼‰ï¼Œæ¯”å¦‚é€šè¿‡ï¼š\nbuffer = (*buffer_t)mmap(NULL,4,devzeroFD,MAP_SHARED)ï¼Œ\nç„¶åå°†buffer-\u0026gt;lockä½œä¸ºmutexå˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå› ä¸ºmmapæ˜ å°„çš„æ—¶å€™æŒ‡å®šäº†å…±äº«æ¨¡å¼ï¼Œæ­¤æ—¶åˆå§‹åŒ–å†™å†…å­˜æ—¶ä¹Ÿæ˜¯å…±äº«çš„ï¼Œforkçš„å­è¿›ç¨‹åˆå§‹åŒ–æ—¶å…¶å®ä¹Ÿæ˜¯åŒä¸€ä¸ªé”ï¼ˆå·²ç»åˆå§‹åŒ–è¿‡ä¸ä¼šé‡å¤åˆå§‹åŒ–å§ï¼Ÿï¼‰ï¼Œç„¶ååç»­åŠ è§£é”éƒ½æ˜¯åœ¨ç›¸åŒçš„åœ°å€ä¸Šäº†ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œæ˜ å°„çš„æ˜¯åŒä¸€æ®µå†…å­˜ã€‚å°±èƒ½æ­£å¸¸å®Œæˆå¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„åŒæ­¥æ§åˆ¶ã€‚\nå…¶ä»–çš„rwmutex/semaphore/condvarï¼Œç†è®ºä¸Šä¹Ÿå¯ä»¥é€šè¿‡ç›¸ä¼¼çš„æ–¹æ³•æ¥å®ç°ã€‚\nreference:\n1: å¤šè¿›ç¨‹å¹¶å‘åŒæ­¥æ§åˆ¶, Synchronization Across Process Boundaries\n2: æ”¯æŒä¼˜å…ˆçº§ç»§æ‰¿çš„é”, Priority Inheritance Mutex\n"}),a.add({id:42,href:"/tags/alignment/",title:"alignment",description:"",content:""}),a.add({id:43,href:"/tags/cache-consistency/",title:"cache consistency",description:"",content:""}),a.add({id:44,href:"/tags/mesi/",title:"mesi",description:"",content:""}),a.add({id:45,href:"/tags/mesif/",title:"MESIF",description:"",content:""}),a.add({id:46,href:"/tags/packed/",title:"packed",description:"",content:""}),a.add({id:47,href:"/tags/padding/",title:"padding",description:"",content:""}),a.add({id:48,href:"/tags/thread-visibility/",title:"thread visibility",description:"",content:""}),a.add({id:49,href:"/tags/volatile/",title:"volatile",description:"",content:""}),a.add({id:50,href:"/blog/%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/",title:"ä¸ºä»€ä¹ˆéœ€è¦å†…å­˜å¯¹é½ï¼Œä»¥åŠå¦‚ä½•æ§åˆ¶å¯¹é½",description:"ä»‹ç»ä¸‹å†…å­˜å¯¹é½è®¿é—®ï¼ˆaligned accessï¼‰çš„é‡è¦æ€§ï¼Œä»¥åŠä¸å¯¹é½è®¿é—®çš„æƒ…å†µä¸‹ä¸åŒå¤„ç†å™¨çš„ä¸åŒçš„è¡Œä¸ºï¼Œä»¥åŠå¦‚ä½•è§„é¿è¿™äº›é—®é¢˜ï¼Œæ¯”å¦‚ç¼–è¯‘æœŸå±‚é¢å¯èƒ½æœ‰å“ªäº›æªæ–½ã€‚ä¹Ÿæè¿°äº†ä¸‹å¦‚ä½•é€šè¿‡GCCæ‰©å±•æ¥æ§åˆ¶aligned boundaryæˆ–è€…packedã€‚",content:"ä»€ä¹ˆæ˜¯å†…å­˜å¯¹é½ï¼Ÿ # æ‰€è°“çš„å†…å­˜å¯¹é½ï¼ŒæŒ‡çš„æ˜¯æˆ‘ä»¬çš„ä¸€äº›æ•°æ®åœ¨å†…å­˜ä¸­ç»„ç»‡çš„æ—¶å€™ï¼Œä¸ºäº†åç»­è®¿é—®æ—¶æ•ˆç‡æ›´é«˜ï¼Œéœ€è¦å°†å…¶èµ·å§‹åœ°å€è¿›è¡Œä¸€å®šçš„å¯¹é½å¤„ç†ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å°†ç»“æ„ä½“å„ä¸ªæˆå‘˜èµ·å§‹åœ°å€åˆ†åˆ«å¯¹é½ï¼Œéç»“æ„ä½“æ¯”å¦‚ä¸€ä¸ªæ™®é€šçš„intæ•°ä¹Ÿä¼šå¯¹é½å¤„ç†çš„ã€‚\nä¸¾ä¸ªintæ•°çš„ä¾‹å­ï¼š\nint n = 100; printf(\u0026quot;n: %d\\n\u0026quot;, n); printf(\u0026quot;sizeof(int): %lu, address: %p\\n\u0026quot;, sizeof(n), \u0026amp;n);  è¿è¡Œåå‘ç°nçš„å¤§å°æ˜¯4å­—èŠ‚ï¼Œåœ°å€æ˜¯0x16d216c4cï¼Œhex \u0026lsquo;c\u0026rsquo;å¯¹åº”äºŒè¿›åˆ¶æ•°ä¸º1100ï¼Œä½ä½æ˜¯00ï¼Œ00è¡¨ç¤ºæ˜¯4å­—èŠ‚å¯¹é½çš„ï¼Œé‚£è¿™ä¸ªintæ•°åœ¨å†…å­˜ä¸­ç»„ç»‡å°±æ˜¯4å­—èŠ‚å¯¹é½çš„ã€‚\nå†çœ‹ä¸ªstructç»“æ„ä½“ï¼š\ntypedef struct { char sex; int age; } Person; Person p; printf(\u0026quot;sizeof(person): %lu\\n\u0026quot;, sizeof(p)); printf(\u0026quot;person.sex address: %p\\n\u0026quot;, \u0026amp;p.sex); printf(\u0026quot;person.age address: %p\\n\u0026quot;, \u0026amp;p.age);  è¿è¡Œåå‘ç°pçš„å¤§å°æ˜¯8ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬ä¹¦æœ¬ä¸Šå­¦ä¹ è¿‡ï¼Œsexæ”¾åœ¨åœ°å€0ï¼Œageæ”¾åœ¨åœ°å€4å¤„ï¼Œsexåæœ‰3ä¸ªpadding charï¼Œè¿™æ ·æ•´ä¸ªæ˜¯8ä¸ªå­—èŠ‚ã€‚ç„¶åæˆ‘ä»¬ç»§ç»­çœ‹ä¸‹åœ°å€:\nperson address: 0x16fdbac44 person.sex address: 0x16fdbac44 person.age address: 0x16fdbac48  structçš„é¦–åœ°å€è·Ÿç¬¬ä¸€ä¸ªæˆå‘˜çš„é¦–åœ°å€æ˜¯ç›¸åŒçš„ï¼Œä½ä½çš„44è¡¨ç¤º01000100ï¼Œè¯´æ˜è¿™ä¸ªç»“æ„ä½“æœ¬èº«ä»¥åŠå†…éƒ¨æˆå‘˜sexéƒ½æ˜¯4å­—èŠ‚å¯¹é½çš„ï¼Œç„¶åageåœ°å€ä½ä½æ˜¯01001000ï¼Œåœ¨0x16fdbac44+4=0x16fdbac48ï¼Œå…¶å®æ˜¯4å­—èŠ‚å¯¹é½çš„ã€‚è¿™ä¹ˆçœ‹ä¸‹æ¥è¿™ä¸ªç»“æ„ä½“ä¸­å„ä¸ªå­—æ®µéƒ½æ˜¯4å­—èŠ‚å¯¹é½çš„ã€‚åœ¨sexå’Œageä¹‹é—´paddingäº†3ä¸ªcharã€‚\nè¿™å°±æ˜¯å†…å­˜å¯¹é½äº†ï¼Œè‡³å°‘ç›´è§‚åœ°çŸ¥é“æ˜¯ä»€ä¹ˆäº†ã€‚\n ç®€å•åœ°è¯´ï¼Œå½“æˆ‘ä»¬å¸Œæœ›è¯»å–çš„æ•°æ®å­—èŠ‚æ•°æ˜¯Nï¼Œè¯¥æ•°æ®èµ·å§‹åœ°å€æ˜¯addrï¼Œå‡è®¾ addr % N == 0 å°±æ˜¯aligned accessï¼Œåä¹‹å°±æ˜¯unaligned accessã€‚\nå³ä¾¿æ˜¯åŸºæœ¬ç±»å‹ä¹Ÿä¼šå¯¹é½ï¼Œå¯¹äºç»“æ„ä½“å„ä¸ªfieldéƒ½ä¼šå¯¹é½ï¼Œå½“æˆ‘ä»¬è¯´ä¸€ä¸ªstructæ˜¯å¤šå°‘å­—èŠ‚å¯¹é½æ—¶ï¼ŒæŒ‡çš„æ˜¯structä¸­fieldå¯¹é½ç”¨çš„å­—èŠ‚æ•°æœ€å¤§çš„ä¸€ä¸ªã€‚ ä¸å¦¨äº†è§£ä¸‹goè¯­è¨€ä¸­çš„å†…å­˜å¯¹é½è§„åˆ™ï¼Œsee: https://go.dev/ref/spec#:~:text=The%20following%20minimal,array%27s%20element%20type.\n ä¸ºä»€ä¹ˆéœ€è¦å¯¹é½ï¼Ÿ # é‚£ä¹ˆä¸ºä»€ä¹ˆè¦å¡«å……äº›paddingæ•°æ®å‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°å¤„ç†å™¨è®¿å­˜çš„å·¥ä½œè¿‡ç¨‹äº†ï¼Œæˆ‘ä»¬æ€ä¹ˆæ§åˆ¶å¤„ç†å™¨è®¿é—®å†…å­˜æ•°æ®çš„ï¼Ÿä¸€èˆ¬å°±æ˜¯é€šè¿‡movæŒ‡ä»¤æ¥å°†å†…å­˜æ•°æ®æ¬è¿åˆ°å†…å­˜åè€…å¯„å­˜å™¨ä¸­ã€‚movæŒ‡ä»¤ï¼ŒæŒ‡ä»¤è¯‘ç ã€æŒ‡ä»¤æ‰§è¡Œï¼Œå…¶å®å°±æ˜¯æŠŠä¸€ä¸ªå†…å­˜åœ°å€æ”¾åˆ°åœ°å€æ€»çº¿ä¸Šé€šè¿‡å†…å­˜æ€»çº¿æ§åˆ¶å¯¹åº”åœ°å€å¯è¯»ï¼Œç„¶åé€šè¿‡æ•°æ®æ€»çº¿ä»æŒ‡å®šèµ·å§‹åœ°å€å¤„è¿ç»­è¯»å–æ•°æ®æ€»çº¿ä½å®½çš„æ•°æ®åˆ°MDRï¼ˆå­˜å‚¨å™¨æ•°æ®å¯„å­˜å™¨ï¼‰ç„¶åè¿›ä¸€æ­¥åŠ è½½åˆ°æŒ‡å®šå¯„å­˜å™¨æˆ–è€…å†…å­˜ä¸­ã€‚\nè¿™é‡Œæœ‰ä»€ä¹ˆè¦å…³æ³¨çš„å—ï¼Ÿæœ‰ï¼Œæ¯”å¦‚8086 20ä½çš„åœ°å€çº¿å¯ä»¥å¯»å€1MBçš„å†…å­˜ï¼Œå†…å­˜ä»¥å­—èŠ‚ç¼–å€ï¼Œé‚£ä¹ˆ20ä½åœ°å€çº¿å¯ä»¥å¯»å€å†…å­˜ç©ºé—´ä¸º2^20=1MBï¼Œä¸€æ¬¡è¯»å–çš„æ•°æ®é‡å–å†³äºæ•°æ®æ€»çº¿ä½å®½ï¼Œæ¯”å¦‚8086ä½ 16ä½æ•°æ®çº¿ï¼Œä¸€æ¬¡ä¹Ÿå°±è¯»å–2ä¸ªå­—èŠ‚ã€‚\nå‡è®¾æˆ‘ä»¬ä¸€ä¸ªintæ•°å§å­˜æ”¾åœ¨åœ°å€0å¤„ï¼Œé‚£ä¹ˆæˆ‘1æ¡æ±‡ç¼–æŒ‡ä»¤mov ax, 0x0å°±å¯ä»¥å®Œæˆï¼Œä¸ºå•¥å‘¢ï¼Œæ•°æ®æ€»çº¿æ˜¯16ä½çš„ï¼Œä¸€æ¬¡å°±èƒ½è¯»å–å‡ºæ¥æ”¾åˆ°axé‡Œã€‚\né‚£ä¹ˆå¦‚æœè¿™ä¸ªintæ•°ä¸åœ¨åœ°å€0å¤„ï¼Œè€Œæ˜¯åœ¨0x1å¤„å‘¢ï¼Ÿæ­¤æ—¶ä¸€æ¡mov ax, 0x0å°±ä¸å¤Ÿäº†ï¼Œåªè¯»äº†8ä¸ªå­—èŠ‚ï¼Œè¿˜æœ‰8ä¸ªå­—èŠ‚åœ¨0x2å¤„ï¼Œæœ€åå°±åªèƒ½movb al, 0x1, movb ah, 0x2ã€‚å’Œå†…å­˜å¯¹é½çš„ç›¸æ¯”ï¼Œè¿™ç§å°±å¤šäº†ä¸€æ¬¡è®¿å­˜æ“ä½œï¼Œæ‰§è¡Œæ•ˆç‡è‡ªç„¶å°±æ…¢äº†å•Šã€‚\nä¸Šé¢è¿™ä¸ªä¾‹å­åŸºæœ¬æ€»ç»“äº†å†…å­˜å¯¹é½çš„åŸå› ï¼Œå°±æ˜¯ä¸ºäº†å°½é‡é€šè¿‡å†…å­˜å¯¹é½å……åˆ†å‘æŒ¥ç¡¬ä»¶è®¿é—®å†…å­˜çš„æ•ˆç‡ï¼Œé¿å…å› ä¸ºæœªåˆç†å¯¹é½å¯¼è‡´çš„ç¼–è¯‘å™¨éœ€è¦å®‰æ’ä¸€äº›å…¶ä»–æ›´å¤šçš„å†…å­˜è®¿é—®æŒ‡ä»¤ï¼Œæ¯æ¡æŒ‡ä»¤æ‰§è¡Œéƒ½éœ€è¦ç»è¿‡å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œç­‰è¿‡ç¨‹ï¼Œè€Œä¸”è¿˜æ˜¯è®¿å­˜ï¼Œè®¿å­˜å’Œå¤„ç†å™¨è®¡ç®—çš„æ•ˆç‡æ˜¯ä¸åœ¨ä¸€ä¸ªæ•°é‡çº§çš„ã€‚æ‰€ä»¥è¦å†…å­˜å¯¹é½ã€‚\n å‡†ç¡®åœ°è¯´ï¼Œunaligned accessçš„åå¤„ä¸»è¦åŒ…å«è¿™äº›ï¼Œè·Ÿå¹³å°æœ‰å…³ç³»ï¼š\n æœ‰çš„å¹³å°ä¼šé€æ˜å¤„ç†è¿™äº›é—®é¢˜ï¼Œåªä¸è¿‡æ˜¯æ€§èƒ½ä¸Šä¼šæœ‰äº›ä¸‹é™ï¼› æœ‰çš„å¹³å°å¯èƒ½ä¼šæŠ›å¼‚å¸¸ï¼Œå¼‚å¸¸å¤„ç†å‡½æ•°æ¥è§£å†³ï¼Œæ€§èƒ½å¼€é”€æ›´å¤§ï¼› æœ‰çš„å¹³å°å¯èƒ½ä¼šæŠ›å¼‚å¸¸ï¼Œå¼‚å¸¸ä¿¡æ¯ä¸æ˜ç¡®ï¼Œæ— æ³•ä¿®å¤ï¼› æœ‰çš„å¹³å°å¯èƒ½ä¸èƒ½æ­£å¸¸å¤„ç†ï¼Œè¯·æ±‚äº†é”™è¯¯çš„å†…å­˜åœ°å€çš„æ•°æ®ï¼Œå¯¼è‡´bugï¼›  ä¸€èˆ¬ç¼–è¯‘å™¨ä¼šè€ƒè™‘ä¸åŒå¹³å°çš„å·®å¼‚æ€§ï¼Œå°½é‡ç”Ÿæˆaligned accessçš„æŒ‡ä»¤ã€‚\nseeï¼šlinux unaligned memory accessã€‚\n å†…å­˜å¯¹é½åŸºæœ¬è§„åˆ™ï¼Ÿ # å†…å­˜å¯¹é½è§„åˆ™ï¼Œå¤§é¢ä¸Šçš„å¤§å®¶éƒ½æ¸…æ¥šï¼Œå°±æ˜¯ç®—å‘—ï¼ŒæŒ‰é‚£å‡ æ¡å¯¹é½è§„åˆ™æ¥ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\ntypedef struct { char sex; int age; } Student;  sexå 1ä¸ªå­—èŠ‚ï¼Œæ”¾åœ¨åœ°å€på¤„1å­—èŠ‚å¯¹é½ï¼›ageæ˜¯4ä¸ªå­—èŠ‚çš„è¯åº”è¯¥4å­—èŠ‚å¯¹é½ï¼Œè¿™æ ·sexååº”è¯¥å¡«å……3ä¸ªpadding charï¼Œageæ”¾åœ¨åœ°å€p+0x4å¤„ï¼Œæœ¬èº«ä¸º4å­—èŠ‚ã€‚è¿™æ ·æ•´ä¸ªstructå¤§å°ä¸º8å­—èŠ‚ï¼Œå„å­—æ®µä¹Ÿåˆç†å¯¹é½äº†ã€‚\nè¯»è€…å¯ä»¥è‡ªè¡Œæ‰¾äº›ç½‘ä¸Šçš„ç›¸å…³èµ„æ–™äº†è§£æ›´å¤šå¯¹é½çš„ä¿¡æ¯ã€‚\nå¦‚ä½•äººä¸ºæ§åˆ¶å¯¹é½ï¼Ÿ # å¯¹äºç¼–è¯‘æœŸé»˜è®¤æ˜¯å¦‚ä½•æ§åˆ¶å¯¹é½çš„ï¼Œæˆ‘ä»¬å¯ä»¥å†™ç¨‹åºè½»æ¾éªŒè¯å‡ºæ¥ã€‚å…¶å®gccç¼–è¯‘æœŸæ‰©å±•å¯ä»¥é€šè¿‡attributeè¿›è¡Œä¿®é¥°ï¼Œå¯¹ç»“æ„ä½“å¯¹é½ã€ç»“æ„ä½“å­—æ®µçš„å¯¹é½è§„åˆ™è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚\nè¿™éƒ¨åˆ†æˆ‘ä»¬å°±é€šè¿‡ç¨‹åºæ¥éªŒè¯å­¦ä¹ ä¸‹ï¼Œä¸åšè¿‡å¤šè§£é‡Šäº†ï¼Œæ³¨é‡Šå¯ä»¥è¯´æ˜ä¸€åˆ‡ã€‚\n#include \u0026lt;stdio.h\u0026gt; typedef struct { char sex; int age; } Person; // because it's packed, so sizeof is 5 bytes // 1 + 4 = 5 bytes typedef struct __attribute__ ((packed)) { char sex; int age; } Student; // this way: 1 + 4 + 3padding + 4 = 12 bytes struct StudentX { char sex __attribute__ ((aligned (1))); int age __attribute__ ((packed)); int xxx __attribute__ ((aligned(4))); }; // this way, the sizeof StudentY will be 16 bytes // 8 + 8 = 16 bytes struct StudentY { char sex __attribute__ ((aligned (8))); int age __attribute__ ((aligned (8))); }; // this way, add attributes to the struct means this struct: // - aligned(4) : sizeof is 8 // - aligned(8) : sizeof is 8 // - aligned(16) : sizeof is 16 // - aligned(32) : sizeof is 32 // // i don't know how aligned affects struct members, it looks like // telling the compiler to try to align the struct members in this way: // - if aligned (n) is too small, use default value, like char:1 int:4 // - if aligned (n) is bigger than default values, try to align to bigger boundary. typedef struct __attribute__ ((aligned (4))) { char sex ; int age ; } StudentZ; int main(int argc, char **argv) { int n = 100; printf(\u0026quot;n: %d\\n\u0026quot;, n); printf(\u0026quot;sizeof(int): %lu, address: %p\\n\u0026quot;, sizeof(n), \u0026amp;n); Person p; printf(\u0026quot;sizeof(person): %lu\\n\u0026quot;, sizeof(p)); printf(\u0026quot;person address: %p\\n\u0026quot;, \u0026amp;p); printf(\u0026quot;person.sex address: %p\\n\u0026quot;, \u0026amp;p.sex); printf(\u0026quot;person.age address: %p\\n\u0026quot;, \u0026amp;p.age); Student s; printf(\u0026quot;sizeof(student): %lu\\n\u0026quot;, sizeof(s)); struct StudentX x; printf(\u0026quot;sizeof(studentx): %lu\\n\u0026quot;, sizeof(x)); struct StudentY y; printf(\u0026quot;sizeof(studenty): %lu\\n\u0026quot;, sizeof(y)); StudentZ z; printf(\u0026quot;sizeof(studentz): %lu\\n\u0026quot;, sizeof(z)); printf(\u0026quot;address of z: %p\\n\u0026quot;, \u0026amp;z); return 0; }  è¿è¡Œç¨‹åºè¿›è¡Œæµ‹è¯•ï¼š\nn: 100 sizeof(int): 4, address: 0x16b356c4c sizeof(person): 8 person address: 0x16b356c44 person.sex address: 0x16b356c44 person.age address: 0x16b356c48 sizeof(student): 5 sizeof(studentx): 12 sizeof(studenty): 16 sizeof(studentz): 8 address of z: 0x16b356c18  é€šè¿‡è¿™é‡Œçš„æµ‹è¯•ç¨‹åºï¼Œä»¥åŠè¾“å‡ºçš„ç»“æœï¼Œæˆ‘ä»¬åº”è¯¥èƒ½æ¨æ–­å‡ºç¼–è¯‘æœŸæ‰©å±• __attribute__ ((aligned (n))) ä¸ __attribute__((packed))çš„å·®å¼‚ã€‚packedè¡¨ç¤ºä¸å†å¯¹å…¶è¿›è¡Œpaddingï¼Œalignedè¡¨ç¤ºäº†æŒ‰ç…§å¤šå°‘å­—èŠ‚æ§åˆ¶å¯¹é½ï¼Œå¦‚æœä¸è¶…è¿‡æŒ‡å®šçš„nå°±ä¸èƒ½å®Œæˆå¯¹å¯¹é½ï¼Œå°±ç”¨é»˜è®¤å¯è¡Œçš„å€¼ï¼Œå¦‚æœnè¶…è¿‡äº†æœ€å°é˜ˆå€¼åˆ™å®‰nè¿›è¡Œã€‚\næ€»ç»“ # æœ¬æ–‡å°ç»“äº†æ•°æ®ã€ç»“æ„ä½“åŠå…¶å­—æ®µåœ¨å†…å­˜ä¸­çš„å¯¹é½ï¼Œå¹¶é€šè¿‡å®ä¾‹è§£é‡Šäº†gccæ‰©å±•å¯¹å¯¹é½çš„æ§åˆ¶ã€‚ä¹‹å‰å¤©ç¾J3é¢è¯•æ—¶æœ‰é—®åŠè®¡ç®—sizeofæ—¶åˆæ²¡æœ‰ä¾‹å¤–æƒ…å†µï¼Œå½“æ—¶ä¹Ÿæ²¡æƒ³èµ·æ¥ã€‚é™¤äº†å¹³å°åŸå› ï¼ˆæ¯”å¦‚intæ•°å¤§å°ä¸æ˜¯4å­—èŠ‚ï¼‰ï¼Œå†æˆ–è€…å¦‚æœæ˜¯é‡‡ç”¨çš„gcc attributeså¯¹å…¶è¿›è¡Œäº†æ‰©å±•ï¼Œæ¯”å¦‚paddingæˆ–è€…æ¯”è¾ƒå¤§çš„aligned valueä¹Ÿä¼šå¯¼è‡´è®¡ç®—ç»“æœä¸ä¸€æ ·çš„é—®é¢˜ã€‚\n"}),a.add({id:51,href:"/tags/%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/",title:"å†…å­˜å¯¹é½",description:"",content:""}),a.add({id:52,href:"/blog/volatile/",title:"å¯¹volatileçš„è®¤è¯†",description:"ä»‹ç»äº†ä¸ºä»€ä¹ˆc/c++éœ€è¦volatileï¼Œå…³äºvolatileä¸èƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§çš„è¯´æ˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆåœ¨x86ä¸Šä¼¼ä¹å¯ä»¥åšåˆ°çº¿ç¨‹å¯è§æ€§çš„é‡Šç–‘ï¼Œæœ€åç®€å•æäº†ä¸‹mesifæ¥è¯´æ˜çº¿ç¨‹å¯è§æ€§æ˜¯è¦ä¾é™„äºcacheä¸€è‡´æ€§åè®®çš„ã€‚",content:"å…³äºè¿™ä¸ªæˆ‘æœ‰ä¸€ç¯‡éå¸¸ä¸é”™çš„æ€»ç»“ï¼Œä¼°è®¡æ˜¯å…¨ç½‘æœ€å¥½çš„æ€»ç»“ï¼šä½ ä¸è®¤è¯†çš„c/c++ volatileï¼Œè™½ç„¶æ ‡é¢˜æœ‰ç‚¹â€œåšçœ¼çƒâ€ï¼Œä½†æ˜¯å†…å®¹ç»å¯¹æ˜¯å¾ˆå¤šé«˜Téƒ½å¯èƒ½ä¸çŸ¥é“çš„ã€‚\nä»Šå¤©ç¿»ä¹‹å‰æ•´ç†çš„Linuxå†…æ ¸æ–‡æ¡£ç¬”è®°æ—¶ï¼Œåˆçœ‹åˆ°äº†å½“æ—¶volatileç›¸å…³çš„ç¬”è®°ï¼Œä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªäº‹æƒ…å‡ å¹´å‰å¬ä¸­å¿ƒçš„é«˜Tåˆ†äº«æ—¶è§‰å¾—ä»–æé”™äº†ï¼Œæ‰å†™çš„è¿™ç¯‡æ€»ç»“ã€‚\nè¿™é‡Œä¹Ÿæ”¾ä¸ªç®€å•çš„æ–‡æ¡£ï¼Œç³»ç»Ÿæ€§çš„å¼ºè°ƒä¸‹ï¼Œè®¤è¯†æ­£ç¡®äº†å¯¹äºå¹¶å‘ç¼–ç¨‹è¿˜æ˜¯å¾ˆé‡è¦çš„ã€‚\nsee also linux volatile considered harmfulï¼Œlinus torvaldså¤§ä½¬äº²ç¬”ã€‚\nç®€å•æ€»ç»“ä¸‹çš„è¯å°±æ˜¯ï¼š\n volatileï¼Œéœ€è¦volatileï¼Œå°¤å…¶æ˜¯å¯¹äºæ¶‰åŠåˆ°å¤–è®¾è®¿é—®çš„æƒ…å†µï¼Œæœ‰äº›å¤–è®¾çš„è®¾å¤‡ç«¯å£æ˜¯é€šè¿‡ç»Ÿä¸€ç¼–å€æ¥çš„ï¼Œä½¿ç”¨æŸäº›è®¿å­˜æŒ‡ä»¤è€Œéä¸“ç”¨çš„in/outæŒ‡ä»¤çš„è¯ï¼Œæœ‰å¯èƒ½è¯»çš„æ•°æ®ä¼šåšä¼˜åŒ–ï¼Œæ¯”å¦‚æ”¾åˆ°å¯„å­˜å™¨ä¸­ï¼Œç¡¬ä»¶cpuè¿˜å¯èƒ½æ”¾åˆ°cacheä¸­ã€‚å¯¹äºè¿™äº›è®¾å¤‡çš„è¯»æ“ä½œï¼Œéœ€è¦é¿å…ä¼˜åŒ–æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œæ‰€ä»¥éœ€è¦volatileã€‚è¿™åœ¨c/c++è®¾å¤‡é©±åŠ¨ä¸­åº”è¯¥æ¯”è¾ƒæœ‰ç”¨ã€‚ volatileï¼Œåœ¨c/c++è¯­è¨€è®¾è®¡å±‚é¢ï¼Œæ²¡æœ‰ä¿è¯çº¿ç¨‹å¯è§æ€§çš„ä»»ä½•ä¿è¯ï¼Œåˆ‡è®°ï¼å®ƒåªæ˜¯å‘ŠçŸ¥ç¼–è¯‘å™¨ä¸è¦åšè½¯ä»¶çº§åˆ«çš„å¯„å­˜å™¨ä¼˜åŒ–è€Œå·²ï¼Œå¯¹äºç¡¬ä»¶çº§åˆ«çš„cacheç¼“å­˜æ²¡æœ‰ä»»ä½•æ§åˆ¶ã€‚ volatileï¼Œä¸èƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œä½†æ˜¯åœ¨ä¸åŒçš„å¤„ç†å™¨å¹³å°ä¸Šå´æ˜¯ä¼šæœ‰ä¸åŒçš„è¡¨ç°ï¼Œæ¯”å¦‚åœ¨x86å¹³å°ä¸Šï¼ŒåŠ äº†volatileä¿®é¥°çš„å˜é‡å°±èƒ½å¤Ÿä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆåŠ äº†volatileä¿®é¥°åé¿å…äº†å¯„å­˜å™¨ä¼˜åŒ–ï¼Œç°åœ¨è¿˜æœ‰cacheçš„é¡¾è™‘å¯¹å§ï¼Œä½†æ˜¯x86å¹³å°æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒä½¿ç”¨äº†ä¸€ç§ç§°ä½œ tsoçš„memory modelï¼Œx86å¤šæ ¸èƒ½å¤Ÿçœ‹åˆ°å…¶ä»–æ ¸å¯¹æŸä¸ªcachelineçš„ä¿®æ”¹ï¼Œå› æ­¤èƒ½æ„ŸçŸ¥åˆ°æœ€æ–°å†™çš„æ•°æ®ï¼Œèƒ½åšåˆ°çº¿ç¨‹å¯è§æ€§ã€‚ volatileåœ¨å…¶ä»–å¹³å°å†…å­˜æ¨¡å‹ä¸åŒï¼Œä¸ä¸€å®šèƒ½å’Œx86ä¸€æ ·å®ç°çº¿ç¨‹å¯è§æ€§ã€‚ è¦æƒ³å®ç°çº¿ç¨‹å¯è§æ€§ï¼Œç¼–è¯‘å™¨ä¸€èˆ¬æ˜¯ç»“åˆè¯­è¨€æœ¬èº«çš„ç‰¹æ€§ï¼Œä¸ºæ­¢ç”Ÿæˆä¸€äº›å†…å­˜å±éšœæŒ‡ä»¤ï¼Œè¿™äº›å±éšœæŒ‡ä»¤æœ€ç»ˆä¼šè§¦å‘cacheçš„MESIFåè®®æ¥ä½¿å¾—å½“å‰æ ¸ä¸Šçš„ä¿®æ”¹å¯¹å…¶ä»–æ ¸å¯è§ã€‚  "}),a.add({id:53,href:"/tags/distro/",title:"distro",description:"",content:""}),a.add({id:54,href:"/tags/fedora/",title:"fedora",description:"",content:""}),a.add({id:55,href:"/tags/gnome/",title:"gnome",description:"",content:""}),a.add({id:56,href:"/tags/kde/",title:"kde",description:"",content:""}),a.add({id:57,href:"/blog/2016-05-07-linux%E6%A1%8C%E9%9D%A2%E5%8F%91%E8%A1%8C%E7%89%88%E5%88%86%E4%BA%AB/",title:"Linuxæ¡Œé¢å‘è¡Œç‰ˆåˆ†äº«",description:"è¿™æ˜¯æˆ‘å¾ˆä¹…ä¹‹å‰2016.5.7å†™çš„ä¸€ç¯‡å…³äºlinuxæ¡Œé¢å‘è¡Œç‰ˆçš„æ–‡ç« ï¼Œä½†æ˜¯ä¸€ç›´åœåœ¨æˆ‘çš„ç¬”è®°é‡Œã€‚ubuntu 16.04 ltsæ˜¯2016å¹´4æœˆ21æ—¥å‘å¸ƒçš„ï¼Œåˆ°ç°åœ¨ä¹Ÿè¦6å¹´å¤šäº†ï¼Œå› ä¸ºæœ€è¿‘åœ¨æ•´ç†ä¹‹å‰çš„ä¸€äº›ç¬”è®°ï¼Œå‘ç°å½“åˆçš„ä¸€äº›æƒ³æ³•è¿˜æŒºå¥½çš„ï¼Œæ‹¿å‡ºæ¥ç»§ç»­åˆ†äº«ä¸‹ã€‚",content:"Linuxæ¡Œé¢å‘è¡Œç‰ˆåˆ†äº« # è¿™æ˜¯ä¸€ç¯‡å†™åœ¨2016å¹´çš„æ–‡ç« ä¸€ç›´åœ¨æˆ‘çš„ä¸ªäººç¬”è®°é‡Œï¼Œæ„Ÿè§‰å½“æ—¶å¾ˆå¤šæƒ³æ³•ä»Šå¤©ä¾ç„¶æˆç«‹ï¼Œæ‰€ä»¥æ‹¿å‡ºæ¥ç»§ç»­åˆ†äº«ä¸‹ã€‚æŸäº›ä¿¡æ¯å¯èƒ½å·²ç»æœ‰è¿‡æ—¶ï¼Œç›¸å…³çš„éƒ¨åˆ†æˆ‘åœ¨å¤‡æ³¨é‡Œè¿›è¡Œäº†æ ‡æ³¨ï¼Œ\n0.ä½“éªŒLinuxå‘è¡Œç‰ˆ # ä»Šå¤©å®‰è£…äº†Ubuntu 16.04 LTSï¼Œæœ¬æ¥å‡†å¤‡ä¸€ç›´ç”¨Fedoraçš„ï¼Œä½†æ˜¯æˆ‘çš„ç¬”è®°æœ¬ä¸Šå®‰è£…çš„è¿˜æ˜¯ Fedora 21ç‰ˆæœ¬ï¼Œä½†æ˜¯å½“å‰æœ€æ–°çš„å·²ç»æ›´æ–°åˆ°äº†Fedora 24,ä»Šå¤©åˆšåˆšå‘å¸ƒäº†Betaç‰ˆæœ¬ã€‚æ­¤ å‰æˆ‘å¯¹Fedora 23 GAä»¥åŠFedora 24 Alphaç‰ˆæœ¬è¿›è¡Œäº†ç®€å•çš„æµ‹è¯•ï¼Œå®åœ¨æ˜¯ä¸å–œæ¬¢KDE 5ï¼\næ€ä¹ˆè¯´å‘¢ï¼Œå…¶å®çœ‹ä¸Šå»KDE 5æŒºæ¼‚äº®çš„ï¼Œåº”è¯¥å°†æ¥ä¹Ÿä¼šæœ‰ä¸é”™çš„å‘å±•ï¼Œä½†æ˜¯è€ƒè™‘åˆ°KDE 5åˆš å‡ºæ¥çš„æ—¶é—´è¿˜ä¸å¤Ÿé•¿ï¼Œå…¶ä¸­å¾ˆå¤šåœ¨KDE 4é‡Œé¢æ–¹ä¾¿å®ç”¨çš„åŠŸèƒ½åœ¨KDE 5ä¸­è¿˜æ²¡æœ‰è¢«å¼€å‘å‡ºæ¥ ï¼Œè€Œæˆ‘åˆæ˜¯ä¸€ä¸ªå€¾å‘äºâ€œå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨â€çš„åŒå­¦ï¼Œè®©æˆ‘è¿™æ ·æŠŠä¸€ä¸ªæœªå……åˆ†å®Œå–„å¥½ çš„æ¡Œé¢ç¯å¢ƒå½“åšè‡ªå·±çš„ä¸»åŠ›ç³»ç»Ÿï¼Œæˆ‘å®åœ¨éš¾ä»¥æ¥å—ï¼å¯¹äºGNOME 3ï¼Œæˆ‘å°±ä¸åšä»»ä½•è¯„è®ºäº† ï¼Œæˆ‘å®å¯ç”¨Ubuntu Unityä¹Ÿä¸ç”¨GNOME 3ï¼\nå¯èƒ½æœ‰äººè¯´ï¼Œæ²¡å¿…è¦ä¸€ç›´è·Ÿç€æ›´æ–°å•Šï¼Œç»§ç»­å®ç”¨Fedora 21ä¹Ÿå¯ä»¥å•Šï¼ï¼Ÿæ­¤è¯å½“ç„¶ä¸å‡ï¼Œ å¯æ˜¯ä¸€ä¸ªå¤±å»åç»­æ›´æ–°æ”¯æŒçš„ç‰ˆæœ¬ï¼Œæˆ‘æƒ³è¿˜æ˜¯è¦ç»§ç»­è·Ÿè¿›æ–°ç‰ˆæœ¬è¦æ›´å¥½ã€‚å…¶å®æˆ‘ç°åœ¨é…ç½® çš„å·²ç»ç›¸å½“æ£’äº†ï¼Œæœ‰çš„è½¯ä»¶æºé‡Œé¢çš„ç¨‹åºå­˜åœ¨æŸäº›å°é—®é¢˜ï¼Œç‘•ä¸æ©ç‘œçš„ï¼Œæˆ‘ä¹Ÿå¯¹å…¶æºä»£ç  è¿›è¡Œäº†éƒ¨åˆ†ä¿®æ”¹ï¼Œä»¥ä¸ºè‡ªå·±æ‰€ç”¨ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å·¥ä½œè¿˜æ˜¯ç›¸å½“å¤šã€ç›¸å½“ç»†çš„ï¼Œå¦‚æœç»§ç»­è·Ÿè¿› æ–°çš„å‘è¡Œç‰ˆï¼Œè€Œè½¯ä»¶æºé‡Œé¢çš„è½¯ä»¶åŒ…å¯èƒ½è¿˜æ²¡æœ‰ä¿®æ”¹è¿‡æ¥ï¼Œæˆ–è€…ä¸ç¬¦åˆæˆ‘çš„éœ€è¦ï¼Œåˆè¦è¿› è¡Œé‡å¤æ€§çš„å·¥ä½œï¼Œæˆ‘è§‰å¾—è¿™ä¸ªå·¥ä½œé‡è¿˜æ˜¯è›®å¤§çš„ï¼Œè‡³å°‘ç°åœ¨æˆ‘æ²¡æœ‰é‚£ä¹ˆå……è¶³çš„æ—¶é—´ã€‚\nFedoraå‘è¡Œç‰ˆæ¯6ä¸ªæœˆæ›´æ–°ä¸€æ¬¡ï¼ŒCentOS 7å¯ä»¥æ”¯æŒ10å¹´ï¼Œæˆ‘æœ¬æ¥ä¹Ÿè®¡åˆ’ä½¿ç”¨CentOSçš„ï¼Œ ä½†æ˜¯CentOSå¯¹ç¨³å®šæ€§çš„è¿½æ±‚ï¼Œä¹Ÿä½¿å¾—å¾ˆå¤šè½¯ä»¶åŒ…ä¸èƒ½è¢«åŠ å…¥å…¶è½¯ä»¶æºï¼Œæœ‰äº›æˆ‘å¾ˆå–œæ¬¢çš„å·¥ å…·ï¼Œå®‰è£…ã€é…ç½®èµ·æ¥å°±ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œdpkgã€alienã€rpmrebuildç”šè‡³ä¿®æ”¹æºä»£ç è¿™äº›å¯èƒ½ éƒ½è¦ç”¨åˆ°ï¼Œä»¥é…ç½®å‡ºä¸€ä¸ªè¶æ‰‹çš„ç³»ç»Ÿç¯å¢ƒã€‚åŠå¹´å‰ï¼Œæˆ‘åœ¨å¦ä¸€å°ä¸‰æ˜Ÿçš„ç¬”è®°æœ¬å®‰è£…äº† CentOS 7ï¼Œé…ç½®å®Œæˆä¹‹åï¼Œå ªç§°å®Œç¾ï¼Œé‚£ä¸ªæ—¶å€™æ—¶é—´å¤šå•Šï¼ŒæŠ˜è…¾çš„æ—¶é—´ä¹ŸæŒºé•¿çš„ï¼›ç°åœ¨æ—¶ é—´æ²¡æœ‰é‚£ä¹ˆå……è£•äº†ï¼Œæˆ‘åœ¨è¿™å°thinkpadä¸Šå®‰è£…äº†CentOS 7.2ï¼Œå‰åä¹Ÿå°±æŠ˜è…¾äº†ä¸€å¤©ï¼Œä¸æ‰“ ç®—æŠ˜è…¾äº†ã€‚\næœ€åï¼Œæˆ‘é€‰æ‹©äº†Ubuntu 16.04 LTSç‰ˆæœ¬ï¼Œå¯ä»¥æ”¯æŒ5å¹´ï¼Œè€Œæˆ‘æœ¬èº«ä¹Ÿæƒ³é‡æ–°æ¯”è¾ƒä¸€ä¸‹ Ubuntuã€Fedoraè¿™ä¸¤å¤§å‘è¡Œç‰ˆï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå¯¹è¿™ä¸¤æ¬¾å‘è¡Œç‰ˆï¼Œæˆ‘éƒ½æœ‰å‘å½“é•¿çš„ä½¿ç”¨æ—¶ é—´ï¼Œç°åœ¨ä¹Ÿç§¯ç´¯äº†å¾ˆå¤šçš„ç»éªŒï¼Œå‰ä¸ä¹…æˆ‘ç¢°å·§åˆçœ‹åˆ°äº†ä¸€ä¸ªå„å¤§å‘è¡Œç‰ˆæ€§èƒ½å¯¹æ¯”çš„æ–‡ç« ï¼Œ å…¶ä¸­Debianç³»åˆ—çš„æ€§èƒ½è¦æ˜æ˜¾ä¼˜äºRHELç³»åˆ—ï¼ŒåŸå› æˆ‘æš‚æ—¶ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šï¼Œè¿™ä¹Ÿæ˜¯æ¿€å‘æˆ‘ é‡æ–°é€‰æ‹©Ubuntuçš„åŸå› ä¹‹ä¸€ã€‚æˆ‘å¸Œæœ›åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé‡æ–°æ¯”è¾ƒä¸€ä¸‹Ubuntuå’ŒFedoraè¿™ä¸¤å¤§å‘è¡Œç‰ˆçš„å·®å¼‚ï¼Œä¾‹å¦‚åŒ…ç®¡ç†å·¥å…·çš„å·®å¼‚ã€è½¯ä»¶åŒ…ä¸­çš„é…ç½®æ–‡ä»¶çš„å·®å¼‚ã€ç³»ç»Ÿç®¡ç†æ–¹é¢çš„å·® å¼‚ï¼Œæ­¤å¤–å‘¢ï¼Œæˆ‘ä¹Ÿå¸Œæœ›èƒ½å¤Ÿå¯¹å…¶æ€§èƒ½ä¸Šçš„å·®å¼‚è¿›è¡Œä¸€ä¸‹æ›´æ·±çš„è®¤è¯†ã€‚\n1.ç³»ç»Ÿå®‰è£…è¿‡ç¨‹ # ç³»ç»Ÿå®‰è£…è¿‡ç¨‹ï¼Œåº”è¯¥è¯´æ˜¯é©¾è½»å°±ç†Ÿäº†ï¼Œä¸‹è½½ä¸€ä¸ªUbuntu 16.04 LTSçš„ISOæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ Unetbootinåˆ¶ä½œä¸€ä¸ªå¯ä»¥å¼•å¯¼ç³»ç»Ÿå®‰è£…çš„Uç›˜ã€‚Uç›˜è¦æ ¼å¼åŒ–æˆFAT32æ ¼å¼ï¼Œä¸”è¦æ ¹æ®éœ€è¦ é¢„ç•™ä¸€å®šçš„å­˜å‚¨ç©ºé—´ï¼Œä»¥ä¾›å®‰è£…è¿‡ç¨‹ä¸­é‡Šæ”¾æ–‡ä»¶ä½¿ç”¨ï¼Œå¦‚æœé¢„ç•™ç©ºé—´ä¸è¶³ï¼Œå¯èƒ½å¯¼è‡´å®‰è£… å¤±è´¥ã€‚\nåˆ¶ä½œå®Œæˆå®‰è£…Uç›˜ä¹‹åï¼Œæ’å…¥ç”µè„‘ï¼Œå…³é—­BIOSä¸­çš„UEFIå¼•å¯¼æ¨¡å¼ï¼Œç„¶åä»USB HDDå¯åŠ¨å®‰è£…å³å¯ã€‚å®‰è£…çš„æ—¶å€™æ‰‹åŠ¨åˆ†åŒºï¼Œæœ€å¥½èƒ½å¤ŸæŠŠé‚£äº›ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ç»™å®‰è£…ä¸Šï¼Œè¿™æ ·çœçš„åç»­å®‰è£… ï¼Œçœå¿ƒã€‚æˆ‘æ˜¯æ·±æœ‰ä½“ä¼šï¼Œä¹‹å‰å®‰è£…éŸ³é¢‘ã€è§†é¢‘æ’­æ”¾å™¨çš„æ—¶å€™ï¼Œå®‰è£…è§£ç åº“æµªè´¹äº†å¾ˆå¤šæ—¶é—´ ã€‚å®‰è£…è¿‡ç¨‹ä¸­æœ‰ä¸ªåˆ«åœ°æ–¹éœ€è¦è®¾ç½®ä¸€ä¸‹ï¼Œä¾‹å¦‚ç”¨æˆ·åã€å¯†ç ã€è¯­è¨€ã€åœ°åŒºã€æ—¶é—´ç­‰ç­‰çš„ã€‚\næ³¨æ„ï¼ŒUbuntuåœ¨å®‰è£…è¿‡ç¨‹ä¸­ä¸ä¼šå¯¹rootç”¨æˆ·çš„å¯†ç è¿›è¡Œè®¾ç½®ï¼Œå¹¶ä¸”é»˜è®¤å°†æ–°å»ºçš„ç”¨æˆ·åŠ å…¥ wheelç»„ä¸­ï¼ä½†æ˜¯åœ¨Fedoraå®‰è£…è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹rootå¯†ç è¿›è¡Œè®¾ç½®ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ· ï¼Œå¹¶å…è®¸é€‰æ‹©æ˜¯å¦å°†è¯¥ç”¨æˆ·åŠ å…¥wheelç»„ä¸­ï¼Œè¿˜å¯ä»¥æŒ‡å®šuidã€gidç­‰ã€‚è¿™æ˜¯ä¸€ä¸ªåŒºåˆ«ï¼Œéœ€ è¦æ³¨æ„ä¸€ä¸‹ï¼Œå®‰è£…å®Œæˆä¹‹åï¼Œéœ€è¦é€šè¿‡â€œpasswd rootâ€å¯¹å¯†ç è¿›è¡Œé‡æ–°è®¾å®šã€‚\nç›¸å¯¹æ¥è¯´ï¼Œå®‰è£…è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒé¡ºåˆ©çš„ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰é¢æåˆ°è¿‡Unetbootinéœ€è¦é¢„ ç•™ä¸€å®šçš„ç©ºé—´ï¼Œä¾‹å¦‚100mï¼Œæˆ–è€…200mï¼Œç”šè‡³500mï¼Œå¦‚æœè®¾ç½®çš„æ¯”è¾ƒå°çš„è¯ï¼Œå¯èƒ½å°±ä¼šé‡åˆ°â€œç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå®‰è£…å¤±è´¥â€ï¼Œè¿™æ˜¯ç”±äºç³»ç»Ÿå®‰è£…è¿‡ç¨‹ä¸­ï¼Œæœ‰äº›å‹ç¼©æ–‡ä»¶éœ€è¦é‡Šæ”¾ï¼Œé‡Šæ”¾çš„ç›®çš„åœ°ä¸æ˜¯åœ¨æˆ‘ä»¬è¦å®‰è£…åˆ°çš„ç›®æ ‡ç¡¬ç›˜ä¸Šï¼Œè€Œæ˜¯åœ¨æˆ‘ä»¬çš„Uç›˜ä¸Šï¼Œå‰©ä½™ç©ºé—´ä¸è¶³çš„è¯ï¼Œè‚¯ å®šæ–‡ä»¶é‡Šæ”¾å°±ä¼šå¤±è´¥ï¼Œå°±ä¸èƒ½æˆåŠŸå®‰è£…åˆ°æˆ‘ä»¬çš„ç›®æ ‡ç¡¬ç›˜ä¸Šã€‚ä¾‹å¦‚Ubuntu Kylinè®¾ç½®100m çš„è¯ï¼Œå°±ä¼šå®‰è£…å¤±è´¥ï¼Œè®¾ä¸º500må°±å¯ä»¥å®‰è£…æˆåŠŸã€‚ç”¨Uç›˜å®‰è£…ä¸ç”¨å…‰ç›˜å®‰è£…è¿˜æ˜¯æœ‰åŒºåˆ«çš„ ï¼Œç”¨å…‰ç›˜å®‰è£…çš„è¯ï¼Œä¸€èˆ¬é‡Šæ”¾æ–‡ä»¶çš„ç›®çš„åœ°åœ¨ç›®æ ‡ç¡¬ç›˜ä¸Šã€‚\nå®‰è£…å®Œæˆä¹‹åï¼Œèµ¶ç´§è¯•ç”¨ä¸€ä¸‹å§ã€‚\n2.è½¯ä»¶å®‰è£…é…ç½® # è½¯ä»¶å®‰è£…å®Œæˆä¹‹åï¼Œåº”è¯¥å…»æˆä¸€ä¸ªå¥½ä¹ æƒ¯ï¼Œå…ˆæŠŠè½¯ä»¶ä¸­çš„æ‰€æœ‰é…ç½®é€‰é¡¹æŸ¥çœ‹ä¸€éï¼Œè¿™æ ·çš„ è¯å°±å¯ä»¥å¯¹è½¯ä»¶æ•´ä½“æœ‰ä¸ªæ›´å…¨é¢çš„è®¤è¯†ã€‚å¾ˆå¤šç”¨æˆ·åœ¨å®‰è£…äº†è½¯ä»¶ä¹‹åï¼Œå°±ä¸ç®¡ä¸é¡¾äº†ï¼Œè¿™ æ€ä¹ˆè¡Œå‘¢ï¼Ÿæ¯”å¦‚æœ‰äº›äººæ‰‹æœºä¸Šå®‰è£…äº†åœ¨çº¿è§†é¢‘æ’­æ”¾è½¯ä»¶ï¼Œä½†æ˜¯ä»æ¥ä¸å…³å¿ƒç›¸å…³è®¾ç½®ï¼Œæ—¶é—´ ä¹…äº†ï¼Œç¼“å­˜å ç”¨ç©ºé—´è¶Šæ¥è¶Šå¤šï¼Œä½†æ˜¯å´ä¸çŸ¥é“æ¸…ç†è¿™äº›åƒåœ¾ï¼›åˆæˆ–è€…ä¹°äº†IPhoneä»¥ä¸ºæ‰‹æœº æœ‰æŒ‡çº¹å®‰å…¨äº†ï¼Œä½†æ˜¯å´ä¸çŸ¥é“è¯¥åœ¨è®¾ç½®é‡Œé¢å¯¹Siriè¿›è¡Œç›¸å…³çš„è®¾ç½®ï¼Œä»¥é˜»æ­¢æœªè§£é”æƒ…å†µä¸‹ çš„ç»•è¿‡å®‰å…¨æ£€æŸ¥çš„é—®é¢˜â€¦â€¦åƒè¿™æ ·çš„ç±»ä¼¼çš„é—®é¢˜æœ‰å¾ˆå¤šã€‚\nå®‰è£…å®Œæˆä¸€ä¸ªè½¯ä»¶ä¹‹åå°šéœ€å¦‚æ­¤ï¼Œå®‰è£…å®Œæˆä¸€ä¸ªæ“ä½œç³»ç»Ÿä¹‹åï¼Œå°±æ›´éœ€è¦è¿™æ ·äº†ã€‚å¯¹äºç³» ç»Ÿä¸­çš„ç»å¤§éƒ¨åˆ†é…ç½®ï¼Œä¾‹å¦‚å¯åŠ¨è®¾ç½®ã€ç™»é™†è®¾ç½®ã€ç•Œé¢è®¾ç½®ã€ç¯å¢ƒå˜é‡è®¾ç½®ã€åˆ«åè®¾ç½®ã€ å¸¸ç”¨è½¯ä»¶åŒ…è®¾ç½®ã€å®‰å…¨è®¾ç½®ã€tricksç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªç†Ÿç»ƒçš„è®¡ç®—æœºç”¨æˆ·å®‰è£…å®Œç³»ç»Ÿä¹‹ ååº”è¯¥è€ƒè™‘çš„ã€‚å¯¹äºLinuxç”¨æˆ·ï¼Œè¿™ä¸€ç‚¹æ˜¾å¾—å°¤ä¸ºé‡è¦ï¼Œä¸€ä¸ªé…ç½®è‰¯å¥½çš„ç³»ç»Ÿï¼Œå¯ä»¥è®© Linuxå……åˆ†å‘æŒ¥å‡ºå…¶ä¼˜åŠ¿ï¼Œæˆä¸ºæˆ‘ä»¬çš„è¶æ‰‹çš„å…µå™¨ï¼\n3.ç³»ç»Ÿå¼•å¯¼è®¾ç½® # 3.1.è®¾å®šGRUBå¼•å¯¼ç•Œé¢ # è®¾å®šGRUBæ˜¯å¾ˆé‡è¦çš„ï¼ŒGRUBå¯ä»¥å¸®åŠ©å¼•å¯¼å¤šä¸ªå®‰è£…çš„ç³»ç»Ÿï¼Œæ”¯æŒwindowsã€unixã€linuxç­‰ï¼Œæˆ‘ä¹‹å‰æ›¾ç»æœ‰ä¸“é—¨çš„ç¬”è®°å¯¹GRUBç›¸å…³çš„é…ç½®è¿›è¡Œäº†è¯¦ç»†åœ°è¯´æ˜ï¼Œè¿™é‡Œå°±ä¸å†é˜è¿°äº†ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„è¯´æ˜åŠ ä»¥äº†è§£ã€‚\nè¿™é‡Œä»…ä»…å¯¹GRUBçš„å·¥ä½œåŸç†è¿›è¡Œä¸€ä¸‹ç®€å•çš„è¯´æ˜ã€‚å½“æˆ‘ä»¬æŒ‰ä¸‹å¼€æœºæŒ‰é’®çš„æ—¶å€™ï¼Œç³»ç»ŸBIOS è¢«å¯åŠ¨ï¼Œå¹¶æ‰§è¡ŒåŠ ç”µè‡ªæ£€ä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆä¹‹åï¼Œå°†å¼•å¯¼æ“ä½œç³»ç»Ÿå¯åŠ¨ã€‚BIOSä¼šå°†ç³»ç»Ÿæ§åˆ¶ æƒäº¤ç”±å¦ä¸€ä¸ªç¨‹åºè¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªç¨‹åºè¢«å®‰è£…åœ¨ç¡¬ç›˜çš„å¯åŠ¨æ‰‡åŒºä¸­ï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªæ‰‡åŒºã€‚ ä½†æ˜¯ä¸€ä¸ªæ‰‡åŒºåªæœ‰512ä¸ªå­—èŠ‚ï¼Œä¸å¯èƒ½è£…ä¸‹è¶³å¤Ÿå¤šçš„ä»£ç æ¥å®Œæˆç³»ç»Ÿçš„å¯åŠ¨ä»»åŠ¡ã€‚å› æ­¤åœ¨ è¿™ä¸ªç¬¬ä¸€æ‰‡åŒºä¸­å¾€å¾€å­˜æ”¾äº†ä¸€äº›ç®€å•çš„ä»£ç ï¼Œè¿™æ®µä»£ç æ¥æ”¶BIOSè½¬äº¤çš„ç³»ç»Ÿæ§åˆ¶æƒï¼Œå»æ‰§ è¡Œåç»­çš„æ›´åŠ å¤æ‚çš„ç³»ç»Ÿå¯åŠ¨ä»»åŠ¡ã€‚\nä»¥GRUB2ä¸ºä¾‹ï¼Œé€šå¸¸å°†GRUBå®‰è£…åœ¨ç¡¬ç›˜çš„ç¬¬ä¸€æ‰‡åŒºä¸­ï¼Œå¹¶ä¸”å°†ç³»ç»Ÿå†…æ ¸æ˜ åƒå®‰è£…åœ¨/bootåˆ†åŒºä¸­ï¼Œå¹¶ä¸”/boot/grub2ä¸­ä¹Ÿä¿ç•™äº†å…¶ä»–çš„å¤§é‡çš„GRUB2ç¨‹åºã€é…ç½®æ–‡ä»¶ç­‰ã€‚è¿™æ ·ç¡¬ç›˜ç¬¬ä¸€æ‰‡åŒºä¸­çš„grubå¼•å¯¼ä»£ç ä¼šåŠ è½½ç›¸åº”çš„ç¨‹åºï¼Œå¹¶æœ€ç»ˆå®Œæˆå†…æ ¸çš„è£…è½½ä»»åŠ¡ã€‚å½“å†…æ ¸è£…è½½å®Œæˆä¹‹åï¼ŒGRUBå†å°†ç³»ç»Ÿæ§åˆ¶æƒäº¤ç”±å†…æ ¸ï¼Œè¿™æ—¶æ“ä½œç³»ç»Ÿæ‰ç®—æ˜¯çœŸæ­£çš„æ¥ç®¡äº†æ•´ä¸ªç³»ç»Ÿã€‚\n3.2.è®¾å®šPlymouthåŠ¨ç”»ï¼Œå¹¶å¼€å¯å¸§ç¼“å†² # 3.2.1.å¼€å¯Plymouth # GRUBè£…è½½å†…æ ¸ã€å¼•å¯¼å†…æ ¸ã€å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ‰§è¡Œå¾ˆå¤šä»»åŠ¡ï¼Œè¿™ä¸ªä»»åŠ¡è€—æ—¶å¯èƒ½è¿˜æ¯” è¾ƒé•¿ï¼Œä¸ºäº†è®©ç”¨æˆ·åœ¨ç­‰å¾…ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¸è‡³äºç­‰å¾…åœ°åˆé—·åˆçƒ¦ï¼Œå¯ä»¥åœ¨è¿™æ®µæ—¶é—´é‡Œ ï¼Œæ˜¾ç¤ºä¸€ä¸ªæ¯”è¾ƒå‹å¥½çš„å¯åŠ¨ç•Œé¢ï¼Œä¾‹å¦‚è¿›åº¦æ¡ã€å¯åŠ¨åŠ¨ç”»ç­‰ç­‰ã€‚\nplymouthå°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªç¨‹åºï¼å®ƒé€šå¸¸åŒ…æ‹¬äº†3ä¸ªä¸»è¦éƒ¨åˆ†ï¼Œä¸€ä¸ªplymouthdç¨‹åºï¼Œè¿™ä¸ªç›¸å½“äºä¸€é¡¹æœåŠ¡ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ä¼šå†³å®šä»€ä¹ˆæ—¶å€™å¼€å¯åŠ¨ç”»ã€ç»“æŸåŠ¨ç”»ï¼Œå¼€å¯å’Œç»“æŸåŠ¨ç”» æ˜¯é€šè¿‡å¦ä¸€ä¸ªç¨‹åºplymouthæ¥å®Œæˆçš„ã€‚å¦ä¸€ä¸ªéƒ¨åˆ†ä¹Ÿå°±æ˜¯è¿™é‡Œçš„åŠ¨ç”»äº†ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º plymouthä¸»é¢˜ã€‚\nç”¨æˆ·å¯èƒ½åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­å®‰è£…å¤šä¸ªplymouthä¸»é¢˜ï¼Œè¿™å°±å­˜åœ¨ä¸€ä¸ªâ€œç³»ç»Ÿæ˜¾ç¤ºå“ªä¸ªä¸»é¢˜â€çš„é€‰æ‹©é—®é¢˜ï¼åœ¨Fedoraé‡Œé¢ï¼Œæ˜¯é€šè¿‡plymouth-set-default-themeæ¥é€‰æ‹©ä¸»é¢˜ï¼Œç„¶åé€šè¿‡ dracuté‡å»ºinitramfså®ç°çš„ã€‚ä½†æ˜¯åœ¨Ubuntué‡Œé¢é‡‡ç”¨äº†ä¸€ç§æ›´åŠ ç®€ä¾¿çš„æ–¹å¼ï¼Œå³é€šè¿‡ update-alternativesæ¥å®ç°ã€‚åœ¨Fedoraé‡Œé¢ï¼Œå…¶å®ä¹Ÿå­˜åœ¨update-alternativeså·¥å…·ï¼Œä½† æ˜¯å´é‡‡ç”¨çš„é‡æ–°å»ºç«‹initramfsçš„æ–¹å¼ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œç¨å¾®æœ‰ç‚¹ç¹çï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¯èƒ½åœ¨ ç³»ç»Ÿå¯åŠ¨é€Ÿåº¦æ–¹é¢æ›´èƒœä¸€ç­¹ã€‚å› ä¸ºplymouthä¸»é¢˜æ‰€éœ€çš„èµ„æºè¢«ç›´æ¥åŠ å…¥åˆ°äº†äº† initramfsä¸­ï¼ŒåŠ è½½åè§£å‹ç¼©çš„é€Ÿåº¦å¯èƒ½æ¯”é€šè¿‡update-alternativesç”Ÿæˆçš„ç¬¦å·é“¾æ¥å†æ¬¡ è®¿é—®æ–‡ä»¶ç³»ç»Ÿæ›´åŠ èŠ‚çœæ—¶é—´ã€‚å„æœ‰ä¼˜ç¼ºç‚¹ï¼\n3.2.2.å¼€å¯å¸§ç¼“å†² # /etc/initramfs-tools/conf.d/splashä¸­å¢åŠ ä¸€è¡ŒFRAMEBUFFER=yï¼Œæ²¡æœ‰è¯¥æ–‡ä»¶å°±åˆ›å»ºè¯¥ æ–‡ä»¶ã€‚å¼€å¯å¸§ç¼“å†²ä¹‹åï¼Œå¯ä»¥åŠ é€Ÿplymouthå¯åŠ¨ï¼Œä»¥ä½¿å¾—plymouthåŠ¨ç”»èƒ½å¤Ÿå°½é‡é“ºæ»¡ç³»ç»Ÿå¯åŠ¨çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œä»¥ä½¿å¾—å¯åŠ¨ç•Œé¢æ›´åŠ å‹å¥½ã€‚\nä¿®æ”¹å®Œæˆåï¼Œéœ€è¦é‡æ–°å»ºç«‹initramfsï¼Œæ‰§è¡Œå‘½ä»¤update-initramfs -uå‘½ä»¤å³å¯å®Œæˆã€‚å¯¹ äºFedoraç³»ç»Ÿéœ€è¦é€šè¿‡dracutæ¥å®Œæˆï¼Œå…¶å®Ubuntué‡Œé¢ä¹Ÿæ˜¯é€šè¿‡dracutæ¥å®Œæˆçš„ï¼Œ update-initramfså‘½ä»¤åªä¸è¿‡æ˜¯ä¸€ä¸ªshellè„šæœ¬è€Œå·²ï¼Œå…¶åªä¸è¿‡æ˜¯å¯¹dracutå‘½ä»¤çš„å°è£…ã€‚\n3.3.æŒ‡å®šå…³é”®å†…æ ¸å‚æ•° # ç³»ç»Ÿä¸­æœ‰äº›å‚æ•°æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨çš„è¿‡ç¨‹ä¸­æŒ‡å®šçš„ï¼Œè™½ç„¶åœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´ä»ç„¶å¯ä»¥å¯¹å…¶è¿›è¡Œä¿® æ”¹ï¼Œä½†æ˜¯å¦‚æœé€šè¿‡é…ç½®æ–‡ä»¶æˆ–è€…å…¶ä»–æ–¹å¼èƒ½å¤ŸæŒ‡å®šå¥½ç›¸å…³çš„å‚æ•°ä¿¡æ¯ï¼Œè¿è¡ŒæœŸé—´å°±æ— éœ€å†å¹²é¢„ã€è°ƒæ•´äº†ã€‚\n3.3.1.è®¾å®šè™šæ‹Ÿå†…å­˜æ¢å‡ºæ¯”ç‡vm.swappiness # ç°åœ¨çš„ç‰©ç†å†…å­˜è¶Šæ¥è¶Šå¤§äº†ï¼Œåœ¨ä¸€èˆ¬ä½¿ç”¨æƒ…å†µä¸‹ï¼Œäº¤æ¢åŒºæ˜¯å¾ˆå°‘ä¼šè¢«ä½¿ç”¨åˆ°çš„ã€‚è™šæ‹Ÿå†…å­˜ é¢‘ç¹çš„æ¢å…¥æ¢å‡ºä¼šå½±å“ç³»ç»Ÿçš„å“åº”é€Ÿåº¦ï¼Œå°±ç®—æ˜¯ç°åœ¨ä½¿ç”¨SSDï¼Œä¹Ÿæ¯”å†…å­˜æ…¢å¾ˆå¤šï¼Œå› æ­¤åˆ ç†åœ°è®¾ç½®å†…å­˜é¡µé¢æ¢å…¥æ¢å‡ºç‡æ˜¯éå¸¸é‡è¦çš„ï¼Œè€Œä¸”æˆ‘ä»¬è¦ä½¿ç”¨çš„æ˜¯æ¡Œé¢ç‰ˆæ“ä½œç³»ç»Ÿï¼Œåˆç† åœ°è®¾ç½®å¯ä»¥å‡å°‘å›¾å½¢ç•Œé¢çš„å“åº”å»¶è¿Ÿæ—¶é—´ã€‚\n/etc/sysctl.confä¸­å¢åŠ vm.swappiness=16ï¼Œé€šè¿‡sysctl vm.swappinesså‘½ä»¤å¯ä»¥çœ‹å‡ºé»˜ è®¤è®¾ç½®æ˜¯60ï¼Œæˆ‘ä»¬é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å°†å…¶è®¾ç½®ä¸º16ã€‚\n3.3.2.è®¾å®šudevçš„ç½‘å¡å‘½åè§„åˆ™ # å¯¹äºç³»ç»Ÿä¸­çš„ç½‘å¡ï¼Œæˆ‘ä»¬æ›´åŠ ç†Ÿæ‚‰eth0ã€wlan0è¿™æ ·çš„å‘½åæ–¹å¼ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸åŠ é…ç½® ï¼Œç³»ç»Ÿä¸­å¾ˆå¯èƒ½æ˜¾ç¤ºçš„æ˜¯enp0s25ã€wlp3s0è¿™æ ·çš„åå­—ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸udevå‘½åè§„åˆ™æœ‰ å…³ç³»ã€‚\nå¦‚ä½•çœ‹åˆ°æˆ‘ä»¬ç†Ÿæ‚‰çš„åå­—å‘¢ï¼Ÿå½“ç„¶ä¸šä½™udevå‘½åè§„åˆ™æœ‰å…³ç³»ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡grubä¼ é€’å†…æ ¸ å‚æ•°â€œnet.ifnames=0 biosdevname=0â€æ¥è§£å†³ï¼Œä¿®æ”¹/etc/default/grubä¹‹åï¼Œéœ€è¦é‡æ–°æ›´æ–°/boot/grub2/grub.cfgï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡update-grub2æ¥å®Œæˆã€‚\nä½†æ˜¯ï¼Œæˆ‘çš„æƒ…å†µæ¯”è¾ƒç‰¹åˆ«ï¼Œæˆ‘è¿™ä¸ªç¬”è®°æœ¬æœ‰ä¸¤ä¸ªç¡¬ç›˜ï¼Œåˆ†åˆ«è®°ä¸º/dev/sdaå’Œ/dev/sdbã€‚å…¶ä¸­/dev/sdbä¸Šå®‰è£…äº†Fedoraï¼Œå¹¶ä¸”åœ¨/dev/sdbä¸Šå®‰è£…äº†grubï¼›/dev/sdaä¸Šå®‰è£…äº†Ubuntuï¼Œå¹¶ä¸”åœ¨/dev/sdaä¸Šå®‰è£…äº†grubã€‚ç„¶åå°†/dev/sdbä½œä¸ºç¬¬ä¸€å¯åŠ¨è®¾å¤‡ï¼Œä¸ºå•¥è¿™ä¹ˆåšï¼Ÿå› ä¸ºsdbæ˜¯ä¸€ä¸ªSSDï¼Œé€Ÿåº¦å¿«ï¼Œè€Œä¸”Fedoraæ˜¯æˆ‘çš„ä¸»åŠ›ç³»ç»Ÿï¼Œå°±æ˜¯è¿™ä¹ˆä¸ªæƒ…å†µã€‚ç”±äºå¼•å¯¼Ubuntuå¯åŠ¨çš„grubé…ç½®æ–‡ä»¶æ˜¯åœ¨/dev/sdbä¸Šçš„Fedoraä¸­ç”Ÿæˆçš„ï¼Œä¸Ubuntuä¸Šé¢çš„grubé…ç½®æ–‡ä»¶æ²¡æœ‰å…³ç³»ã€‚\nå› æ­¤å¦‚æœè¦æ­£ç¡®æ”¹è¿‡ç½‘å¡çš„åå­—æ¥ï¼Œè¿˜æ˜¯éœ€è¦ä¿®æ”¹/dev/sdbä¸Šçš„ /boot/grub2/grub.cfgä¸­çš„ç›¸å…³é…ç½®ã€‚å…¶å®ä¹Ÿå°±æ˜¯å°†ä¸Šè¿°æåˆ°çš„å†…ç›’å‚æ•°åŠ å…¥åˆ° menuentryçš„linuxå‘½ä»¤åçš„é€‰é¡¹ä¸­è€Œå·²ã€‚\n3.3.3.å…³é—­å¯åŠ¨æ—¶fsckå¯¹æ–‡ä»¶ç³»ç»Ÿçš„æ£€æŸ¥ # /etc/fstabä¸­å°†æ¯ä¸ªåˆ†åŒºçš„æœ€åçš„ä¸€åˆ—æ•°å­—å…¨éƒ¨ä¿®æ”¹ä¸º0ï¼Œè¿™æ ·å¯ä»¥é¿å…ç³»ç»Ÿå¯åŠ¨æ—¶å¯¹æ–‡ ä»¶ç³»ç»Ÿè¿›è¡Œæ£€æŸ¥ï¼ŒåŠ å¿«ç³»ç»Ÿå¯åŠ¨é€Ÿåº¦ã€‚\n3.3.4.æ¿€æ´»æ‰€æœ‰çš„ç³»ç»Ÿé­”æ³•é”®vm.sysrq # ä¿®æ”¹/etc/sysctl.confï¼Œå¢åŠ ä¸€è¡Œvm.sysrq=1ï¼Œè¿™æ ·å°±å¯ä»¥æ¿€æ´»Linuxç³»ç»Ÿå†…æ‰€æœ‰çš„é­”æ³• é”®ï¼Œä¾‹å¦‚æ¯”è¾ƒå¸¸ç”¨çš„Ctrl+Alt+Print+Kï¼Œè¡¨ç¤ºæ€æ­»å½“å‰ä¼šè¯ï¼ŒåŒ…æ‹¬å½“å‰ä¼šè¯ä¸­å¯åŠ¨çš„æ‰€æœ‰ çš„è¿›ç¨‹ï¼›Ctrl+Alt+Print+Bï¼Œè¡¨ç¤ºç«‹å³é‡æ–°å¯åŠ¨ç³»ç»Ÿã€‚\nè¿™ä¸¤ä¸ªé­”æ³•é”®æ˜¯æˆ‘ç»å¸¸ä½¿ç”¨çš„ï¼Œéå¸¸æœ‰ç”¨ï¼Œç‰¹åˆ«æ˜¯å¸Œæœ›å¿«é€Ÿæ£€æŸ¥é…ç½®æ›´æ”¹æ˜¯å¦æœ‰æ•ˆæˆ–è€…å›¾ å½¢ç•Œé¢å¤±å»å“åº”çš„æ—¶å€™ã€‚\n4.ç³»ç»Ÿä¼˜åŒ–åŠç³»ç»Ÿå·¥å…· # 4.1.ç³»ç»Ÿé…ç½®ä¼˜åŒ– # 4.1.1.Ubuntu greeteré…ç½® # è¦åˆ›å»ºã€ä¿®æ”¹çš„æ–‡ä»¶ä¸»è¦åŒ…æ‹¬ï¼š\n /usr/share/glib-2.0/schemas/com.canonical.unity-greeter.gschema.xml  ä¿®æ”¹è¯¥æ–‡ä»¶ï¼Œå¯ä»¥ç¦ç”¨greeterç•Œé¢çš„ç³»ç»Ÿå·²å°±ç»ªçš„å£°éŸ³æé†’ã€æ˜¯å¦ç»˜åˆ¶ç½‘æ ¼ã€æ˜¯å¦è¦åŠ  è½½ä¸€ä¸ªå›¾åƒä½œä¸ºèƒŒæ™¯ï¼ŒåŠ è½½å›¾åƒå‰çš„ç•Œé¢é¢œè‰²ç­‰ã€‚å¯¹äºè¦åŠ è½½çš„å›¾ç‰‡æœ€å¥½èƒ½å¤Ÿä¸ç”¨æˆ·ä¹‹å‰ è®¾å®šçš„æ¡Œé¢å£çº¸ä¸€è‡´ï¼Œè¿™æ ·å¯ä»¥åŠ å¿«ç³»ç»Ÿç™»é™†ç³»ç»Ÿçš„æ—¶é—´ï¼ˆé¿å…äº†å†æ¬¡åŠ è½½å›¾ç‰‡å˜›ï¼Œå‡å°‘ äº†è®¿é—®æ–‡ä»¶ç³»ç»Ÿçš„æ—¶é—´ï¼‰ï¼›å¦å¤–ï¼ŒåŠ è½½å›¾ç‰‡ä¹‹å‰çš„é¢œè‰²ï¼Œä¹Ÿåº”å°½é‡ä¸å£çº¸ã€plymouthåŠ¨ç”» èƒŒæ™¯è‰²ç›¸ä¸€è‡´ï¼Œè¿™æ ·æ˜¾å¾—ç³»ç»Ÿå¯åŠ¨æ›´åŠ æµç•…ï¼Œç•Œé¢æ›´å‹å¥½ã€‚\nä¿®æ”¹è¯¥xmlæ–‡ä»¶åï¼Œéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ä½¿å…¶ç”Ÿæ•ˆï¼š\n sudo glib-compile-schemas /usr/share/glib-2.0/schemas\n æ‰§è¡Œæ”¹è¡Œå‘½ä»¤çš„ç›®çš„ï¼Œæ˜¯å°†ä¿®æ”¹åçš„xmlæ–‡ä»¶ä¸æœªä¿®æ”¹çš„xmlæ–‡ä»¶é‡æ–°ç¼–è¯‘æˆä¸€ä¸ªå®Œæ•´çš„äºŒ è¿›åˆ¶æ–‡ä»¶ï¼Œgsettingsè¯»å–è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å¹¶å¯¹å›¾å½¢ç•Œé¢è¿›è¡Œç›¸å…³çš„è®¾ç½®ã€‚\nå…³äºå¦‚ä½•åœ¨ç”¨æˆ·è®¾å®šæ–°çš„å£çº¸ä¹‹åï¼Œè®©ç³»ç»Ÿå¯åŠ¨åˆ°greeterç•Œé¢çš„æ—¶å€™å¯ä»¥è‡ªåŠ¨è£…è½½çš„é—® é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šè¿°xmlé‡Œé¢å°†å¾…åŠ è½½çš„å›¾ç‰‡è®¾ä¸ºä¸€ä¸ªç¬¦å·é“¾æ¥.background-uriã€‚ç„¶åå½“ ç”¨æˆ·ä¿®æ”¹èƒŒæ™¯å›¾ç‰‡åï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤update-backgroundæ¥æ›´æ–°è¯¥é“¾æ¥ï¼Œä½¿å…¶æŒ‡å‘æ–°çš„èƒŒ æ™¯å›¾ç‰‡ï¼›æˆ–è€…åœ¨.bashrcé‡Œé¢å†™å…¥ä¸€äº›è„šæœ¬æ¥å®Œæˆé“¾æ¥çš„æ›´æ–°ã€‚æ€»ä¹‹ç›®çš„å°±æ˜¯ä¿è¯ç”¨æˆ·å† æ¬¡ç™»é™†æ—¶ï¼Œèƒ½å¤ŸåŠ è½½æ­£ç¡®çš„å›¾ç‰‡ï¼Œå®ç°å¹³æ»‘åœ°ç•Œé¢è¿‡æ¸¡ã€‚\n /home/username/.bashrc  å…³äºå¦‚ä½•åœ¨ç”¨æˆ·è®¾å®šæ–°çš„å£çº¸ä¹‹åï¼Œè®©ç³»ç»Ÿå¯åŠ¨åˆ°greeterç•Œé¢çš„æ—¶å€™å¯ä»¥è‡ªåŠ¨è£…è½½çš„é—® é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸Šè¿°xmlé‡Œé¢å°†å¾…åŠ è½½çš„å›¾ç‰‡è®¾ä¸ºä¸€ä¸ªç¬¦å·é“¾æ¥.background-uriã€‚ç„¶åå½“ ç”¨æˆ·ä¿®æ”¹èƒŒæ™¯å›¾ç‰‡åï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤update-backgroundæ¥æ›´æ–°è¯¥é“¾æ¥ï¼Œä½¿å…¶æŒ‡å‘æ–°çš„èƒŒ æ™¯å›¾ç‰‡ï¼›æˆ–è€…åœ¨.bashrcé‡Œé¢å†™å…¥ä¸€äº›è„šæœ¬æ¥å®Œæˆé“¾æ¥çš„æ›´æ–°ã€‚æ€»ä¹‹ç›®çš„å°±æ˜¯ä¿è¯ç”¨æˆ·å† æ¬¡ç™»é™†æ—¶ï¼Œå°…åŠ è½½æ­£ç¡®çš„å›¾ç‰‡ï¼Œå®ç°å¹³æ»‘åœ°ç•Œé¢è¿‡æ¸¡ã€‚\nåœ¨æˆ‘ä»¥å‰ä½¿ç”¨Ubuntu 12.04 LTSçš„æ—¶å€™ï¼Œgconfå¯ä»¥åœ¨ç”¨æˆ·é€‰æ‹©æ–°çš„æ¡Œé¢å£çº¸åæ‰§è¡Œä¸€äº› æ“ä½œï¼Œæ¯”å¦‚æ›´æ–°%gconf.xmlæ–‡ä»¶ï¼Œå…¶ä¸­ä¿å­˜äº†ç”¨æˆ·é€‰æ‹©çš„å£çº¸çš„ç»å¯¹è·¯å¾„ï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥ æ›´æ–°ç¬¦å·é“¾æ¥.background-uriã€‚ä½†æ˜¯åœ¨Ubuntu 16.04 LTSé‡Œé¢ï¼Œæˆ‘å‘ç°ç³»ç»Ÿä¸­é»˜è®¤æ²¡æœ‰ ä½¿ç”¨ç”Ÿæˆ%gconf.xmlæ–‡ä»¶ï¼Œä½†æ˜¯é€šè¿‡gsettingså¯ä»¥è·å–åˆ°å£çº¸è·¯å¾„ä¿¡æ¯ï¼Œå¹¶ä¸”æ ¼å¼ä¸ %gconf.xmlä¸­æ˜¯ä¸€è‡´çš„ã€‚\nåœ¨.bashrcä¸­ï¼Œå¢åŠ å¦‚ä¸‹ä¸‰è¡Œè„šæœ¬å°±å¤Ÿäº†ï¼š\n BACKGROUND_CONFIG=gsettings get org.gnome.desktop.background picture-uri\nBACKGROUND_CONFIG=echo ${BACKGROUND_CONFIG#*//}\nln -sf $BACKGROUND_CONFIG ~/.background-uri\n  /usr/bin/update-background  å½“ç„¶äº†ï¼Œä¹Ÿå¯ä»¥æŠŠä¸Šè¿°ä¸‰è¡Œè„šæœ¬å†™å…¥ä¸€ä¸ªbashè„šæœ¬ä¸­ï¼Œæ”¾å…¥æœç´¢è·¯å¾„/usr/binä¸­ï¼š\n #!/bin/bash\nBACKGROUND_CONFIG=gsettings get org.gnome.desktop.background picture-uri\nBACKGROUND_CONFIG=echo ${BACKGROUND_CONFIG#*//}\nln -sf $BACKGROUND_CONFIG ~/.background-uri\necho \u0026ldquo;update background-uri link \u0026hellip; done\u0026rdquo;\n  /home/username/.background-uri  è¿™åªæ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œé€šè¿‡å®ƒæŒ‡å‘æ­£ç¡®çš„æ¡Œé¢å£çº¸ã€‚ç”±äºä¸å¸Œæœ›åœ¨åç»­ä½¿ç”¨è¿‡ç¨‹ä¸­çœ‹åˆ°è¿™ ä¸ªæ–‡ä»¶ï¼Œæˆ–è€…å¯¹å…¶è¿›è¡Œç›´æ¥ä¿®æ”¹ï¼Œæ‰€ä»¥å°†å…¶è®¾ç½®ä¸ºéšè—æ–‡ä»¶ã€‚\n4.1.2.bashé…ç½® #   /etc/passwd\n  /etc/bash.bashrc \u0026amp; /etc/profile\n  .bashrc \u0026amp; .profile\n ç¯å¢ƒå˜é‡   Javaç›¸å…³\nAntç›¸å…³\nMavenç›¸å…³\n\u0026hellip;\nå…¶ä»–\n  åˆ«å   alias bb=\u0026ldquo;byobu\u0026rdquo;\nalias clean=\u0026ldquo;dpkg -l | grep ^rc | awk \u0026lsquo;{print $2}\u0026rsquo; | xargs sudo dpkg -P\u0026rdquo; alias cls=\u0026ldquo;reset\u0026rdquo;\nalias duu=\u0026ldquo;du -h -a -d 1\u0026rdquo; alias ee=\u0026ldquo;exit\u0026rdquo;\nalias g++=\u0026ldquo;g++ \u0026ndash;std=c++0x\u0026rdquo;\nalias gentags=\u0026ldquo;sudo /usr/bin/ctags \u0026ndash;c-kinds=+dfglm \u0026ndash;language-force=C -R .\u0026rdquo;\nalias gg=\u0026ldquo;cd /home/user/Github/Study\u0026rdquo;\nalias grep=\u0026ldquo;grep \u0026ndash;color=auto\u0026rdquo;\nalias gvim=\u0026ldquo;gvim -f\u0026rdquo;\nalias indent=\u0026ldquo;indent -kr\u0026rdquo;\nalias l=\u0026ldquo;ls -CF\u0026rdquo;\nalias la=\u0026ldquo;ls -A\u0026rdquo;\nalias ll=\u0026ldquo;ls -al\u0026rdquo;\nalias ls=\u0026ldquo;ls \u0026ndash;color=auto\u0026rdquo;\nalias lg-ce=\u0026ldquo;sdcv -u\u0026rsquo;æœ—é“æ±‰è‹±å­—å…¸5.0'\u0026rdquo;\nalias lg-ec=\u0026ldquo;sdcv -u\u0026rsquo;æœ—é“è‹±æ±‰å­—å…¸5.0'\u0026rdquo;\nalias mirror=\u0026ldquo;wget -r -p -np -k\u0026rdquo;\nalias mmatlab=\u0026ldquo;matlab -nojvm\u0026rdquo;\nalias pp=\u0026quot;/usr/bin/proxychains4\u0026quot;\nalias ss=\u0026ldquo;ssh -qtfnN -D 7070 ZhangJie@192.168.56.254\u0026rdquo;\nalias vvim=\u0026ldquo;vim -u ~/.vvimrc\u0026rdquo;\nalias nvim=\u0026ldquo;vim -u NONE\u0026rdquo;\n  å‡½æ•°   hostlist\n\u0026hellip;\nå…¶ä»–\n   4.1.3.gnome-terminalæˆ–Konsoleé…ç½® # 4.1.4.Vimé…ç½® #  vim.tiny-\u0026gt;vim-\u0026gt;vim.nox-\u0026gt;vim.athena-\u0026gt;vim.gtk/vim.gnome  vimçš„ä¸åŒäºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œå…¶ä¸­å†…ç½®çš„åŠŸèƒ½ç‰¹æ€§æœ‰æ‰€å·®å¼‚ï¼Œåœ¨ä¸Šè¿°ç®­å¤´æ‰€ç¤ºé¡ºåºä¸­ï¼Œå„ç‰ˆæœ¬ åŒ…å«çš„ç‰¹å¾ä¾æ¬¡å¢åŠ ã€‚ç³»ç»Ÿä¸­å¯ä»¥å®‰è£…å¤šä¸ªvimç‰ˆæœ¬ï¼Œç„¶åé€šè¿‡update-alternativesæ¥æ§ åˆ¶ä½¿ç”¨é‚£ä¸ªç‰ˆæœ¬ã€‚\n .viminfo  /etc/vim/vimrcä¸­ï¼Œä¿å­˜ç€vimçš„å…¨å±€é…ç½®ã€‚å¥‡è‘©çš„æ˜¯ï¼Œåœ¨Ubuntué‡Œé¢é»˜è®¤æ²¡æœ‰å¼€å¯ viminfoæ”¯æŒï¼Œè¿™ä¸ªåªè¦å¯¹/etc/vim/vimrcæ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œå–æ¶ˆç›¸åº”çš„é…ç½®å‰é¢çš„æ³¨é‡Šå°± å¯ä»¥äº†ã€‚\n .vimrc  vimrcè¿™ä¸ªæ˜¯vimçš„ä¸»è¦é…ç½®æ–‡ä»¶ï¼Œå…³äºvimè¿™ä¸€ä¸ªç¼–è¾‘å™¨ï¼Œæ¶‰åŠåˆ°å¾ˆå¤šæ–¹é¢çš„é…ç½®ï¼ŒåŒ…æ‹¬ é¢œè‰²é…ç½®ã€å¿«æ·é”®é…ç½®ã€é¢œè‰²é…ç½®ã€å‘½ä»¤é…ç½®ã€æ’ä»¶é…ç½®ç­‰ç­‰ï¼Œå»ºè®®æ²¡äº‹å¤šç¿»ç¿»vimç›¸å…³ çš„è®ºå›ï¼Œæ€»èƒ½å­¦åˆ°ç‚¹ä¸œè¥¿ï¼ŒåŠ å¿«æ–‡æœ¬ç¼–è¾‘æ•ˆç‡ã€‚vimä¸æ„§æ˜¯ç¼–è¾‘å™¨ä¹‹ç¥ï¼\nå¦‚æœå®åœ¨æ˜¯å¯¹vimçš„ç›¸å…³é…ç½®æ„Ÿå…´è¶£ï¼Œä¸å¦¨æŸ¥çœ‹ä¸€ä¸‹æˆ‘çš„ç›¸å…³é…ç½®è¯´æ˜ï¼Œå¯ä»¥ä»å¦‚ä¸‹repo è¿›è¡Œè·å–ï¼šhttps://github.com/hitzhangjie/Conf.gitã€‚\n4.1.5.æŒ‰é”®å»¶æ—¶ã€æŒ‰é”®é€Ÿç‡é…ç½®ï¼Œæ›´å¿«é€Ÿåœ°è¾“å…¥ # é™ä½æŒ‰é”®å»¶æ—¶ã€æé«˜æŒ‰é”®é€Ÿç‡ï¼Œè¿™æ ·å¯ä»¥æ›´åŠ å¿«é€Ÿåœ°è¿›è¡Œè¾“å…¥æ“ä½œï¼Œåœ¨Vimä¸­è¿›è¡Œç§»åŠ¨æ•ˆ ç‡ä¹Ÿä¼šæ›´å¿«ã€‚å¯ä»¥æ ¹æ®éœ€è¦ã€ä¸ªäººä¹ æƒ¯è¿›è¡Œé€‚å½“åœ°è°ƒæ•´ã€‚\næœ‰äº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿›è¡Œè¾“å…¥æ“ä½œæ—¶ï¼Œå¦‚æœä¸€è¾¹æ€è€ƒä¸€è¾¹è¾“å…¥çš„æ—¶å€™ï¼Œå¯èƒ½è¾“å…¥æ“ä½œä¼šæ¯”è¾ƒ æ…¢ä¸€äº›ï¼Œä½†æ˜¯å¦‚æœæ€è€ƒä»»åŠ¡ä¸æ˜¯å¾ˆé‡çš„æƒ…å†µä¸‹ï¼Œè¾“å…¥çš„é€Ÿåº¦å°±ä¼šå¾ˆå¿«ï¼Œä½†æ˜¯å‘¢ï¼Œç³»ç»Ÿçš„é»˜ è®¤æŒ‰é”®è®¾ç½®æœ‰ä¸€ä¸ªæŒ‰é”®å»¶æ—¶å’Œè¾“å…¥é€Ÿç‡é™åˆ¶ï¼Œè¿™ä¸ªé™åˆ¶åœ¨æŸäº›æƒ…å†µä¸‹ä¼šä¸¥é‡å¹²æ‰°è¾“å…¥é€Ÿåº¦ ã€‚å¯¹äºè¿™ä¸€ç‚¹æˆ‘æ˜¯æ·±æœ‰ä½“ä¼šï¼Œä½•å†µè‡ªå·±è¿˜æ˜¯ä¸€ä¸ªä¸“ä¸šçº§ç å†œï¼Œä¸€ä¸ªä¸æŠ˜ä¸æ‰£çš„è¾“å…¥å¿«æ‰‹ï¼Œ ä¸€ä¸ªå‘½ä»¤è¡Œã€vimé‡åº¦ç”¨æˆ·ï¼Œå¯¹äºæŒ‰é”®è¾“å…¥é€Ÿåº¦æœ‰ç€è¾ƒé«˜çš„è¦æ±‚ã€‚\nå¯¹äºOS Xç”¨æˆ·ï¼Œå…¶shellä¸­å­˜åœ¨è¾ƒä¸ºä¸¥é‡çš„æŒ‰é”®å»¶æ—¶é—®é¢˜ï¼Œæˆ‘æ˜¯åœ¨ä½“éªŒOS Xçš„è™šæ‹Ÿæœºçš„æ—¶ å€™å‘ç°è¿™ä¸ªé—®é¢˜çš„ï¼Œä¹‹åå°±åœ¨Linuxä¸Šå¯¹ç›¸åº”çš„è®¾ç½®è¿›è¡Œäº†å®Œå–„ï¼Œè¾“å…¥ä½“éªŒæœ‰äº†è¾ƒå¤§æå‡ ã€‚å»ºè®®æœ‹å‹ä»¬ä¼˜åŒ–ä¸€ä¸‹ç›¸åº”çš„é…ç½®ï¼Œç›¸ä¿¡ä¼šæœ‰æ›´å¥½çš„è¾“å…¥ä½“éªŒã€‚\n4.2.ç³»ç»Ÿå¸¸ç”¨å·¥å…· # ç³»ç»Ÿä¸­åŒ…æ‹¬äº†å¤§é‡çš„å·¥å…·ï¼ŒåŒ…æ‹¬å®˜æ–¹çš„ä»¥åŠç¬¬ä¸‰æ–¹æä¾›çš„ï¼Œç”šè‡³æœ‰äº›ä¸ªäººæä¾›çš„å·¥å…·ï¼Œèƒ½ å¤Ÿä»ä¼—å¤šçš„å·¥å…·ä¸­é´é€‰å‡ºé‚£äº›é«˜ä»·å€¼çš„ã€å®ç”¨çš„å·¥å…·ï¼Œå¯¹äºåç»­çš„é«˜æ•ˆå·¥ä½œæ˜¯éå¸¸æœ‰åˆ©çš„ ã€‚åœ¨å¤šå¹´çš„Linuxä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°†è‡ªå·±è§‰å¾—éå¸¸å¥½çš„å·¥å…·ä»‹ç»ç»™å¤§å®¶ï¼Œå½“ç„¶äº†è¿™é‡Œçš„å·¥ å…·å¯èƒ½ä¸ä»…ä»…æ˜¯ä¸€äº›è½¯ä»¶åŒ…ï¼Œä¹Ÿå¯èƒ½æ˜¯ç³»ç»Ÿä¸­æä¾›çš„ä¸€äº›ä¸é”™çš„åŠŸèƒ½ã€ç»„ä»¶ç­‰ç­‰ã€‚\n4.2.1.byobuã€tmuxã€screen # å¯¹äºLinuxè€Œè¨€ï¼Œå‘½ä»¤è¡Œæ˜¯ä½“ç°å…¶å¼ºå¤§ä¹‹å¤„çš„ä¸€ä¸ªçª—å£ã€‚æœ‰äº›åˆšå¼€å§‹å­¦ä¹ Linuxçš„ç”¨æˆ·ï¼Œå¾ˆ éš¾ä»¥ç†è§£ä¸ºä»€ä¹ˆå‘½ä»¤è¡Œè¿™ç§æå…¶ä¸æ–¹ä¾¿çš„æ“ä½œæ–¹å¼ä¼šæœ‰æ¯”GUIæ›´å¥½çš„ä½“éªŒã€æ•ˆç‡ã€‚å…¶å®è¿™ ä¸ªé—®é¢˜å¾ˆå®¹æ˜“ç†è§£ï¼Œä¸€ä¸ªå‘½ä»¤é€šå¸¸å¯ä»¥çµæ´»æŒ‡å®šå‡ ä¸ªã€å¤šä¸ªã€å¾ˆå¤šä¸ªé€‰é¡¹ï¼Œåœ¨GUIä¸­èƒ½å¤Ÿ å¯¹å…¶è¿›è¡Œæœ‰æ•ˆç»„ç»‡ä¸æ˜¯ä¸€é¡¹ç®€å•çš„å·¥ä½œï¼Œä¸æ˜¯è¯´ä¸èƒ½ï¼Œåªæ˜¯è¯´å¯èƒ½ä¼šé™„å¸¦å¾ˆå¤šçš„å·¥ä½œé‡ã€‚\nä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œä»¥windowsèµ„æºç®¡ç†å™¨ä¸ºä¾‹å§ã€‚windowsèµ„æºç®¡ç†å™¨çœ‹ä¼¼å·²ç»éå¸¸å¼ºå¤§äº†ï¼Œåœ¨é‡Œé¢æˆ‘ä»¬å¯ä»¥å°†æ–‡ä»¶ä»¥åˆ—è¡¨ã€å›¾æ ‡ç­‰å¤šç§è§†å›¾å½¢å¼è¿›è¡Œå±•ç¤ºï¼Œå¹¶ä¸”æ”¯æŒå¤åˆ¶ã€ç²˜è´´ã€ ç§»åŠ¨ã€æœç´¢ç­‰æ“ä½œã€‚å¯¹äºæ™®é€šæ¡Œé¢ç”¨æˆ·è€Œè¨€ï¼Œè¿™ä¸ªç¡®å®å·²ç»è¶³å¤Ÿå¼ºå¤§äº†ã€‚ä¸‹é¢æˆ‘è¯•ç€é¢˜å‡  ä¸ªåŠŸèƒ½éœ€æ±‚ï¼Œä½ ä»¬çœ‹çœ‹windowsèµ„æºç®¡ç†å™¨æ˜¯å¦èƒ½å¤Ÿåšåˆ°ã€‚\n åˆ—å‡ºæœ€è¿‘1åˆ†é’Ÿå†…ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Ÿ   Linuxä¸‹å¯ä»¥é€šè¿‡å‘½ä»¤â€œfind -mmin 1â€æ¥å®Œæˆã€‚\n  åˆ—å‡ºæœ€è¿‘10åˆ†é’Ÿå†…è®¿é—®è¿‡çš„æ–‡ä»¶ï¼Ÿ   Linuxä¸‹å¯ä»¥é€šè¿‡å‘½ä»¤â€œfind -amin 10\u0026quot;æ¥å®Œæˆã€‚\n  åˆ—å‡ºæ–‡ä»¶å†…å®¹ä¸­åŒ…æ‹¬â€œxxxxâ€å­—æ ·çš„æ–‡ä»¶ï¼Ÿ   Linuxä¸‹å¯ä»¥é€šè¿‡å‘½ä»¤\u0026rsquo;find -iname \u0026ldquo;*\u0026rdquo; | grep \u0026ldquo;xxxx\u0026rdquo; | cut -d':' -f1 | sort | uniq\u0026rsquo;æ¥å®Œæˆã€‚\n  åˆ—å‡ºæ‰€æœ‰çš„ç›®å½•æ–‡ä»¶ï¼Œæˆ–è€…åˆ—å‡ºæ‰€æœ‰çš„æ™®é€šæ–‡ä»¶ï¼Ÿ   Linuxä¸‹å¯ä»¥é€šè¿‡shellè„šæœ¬æ¥å®Œæˆï¼Œå¦‚ï¼š\n#!/bin/bash\nfor f in find . -iname \u0026quot;*\u0026quot; do\nif [ -d $f ]; then echo $f; fi\ndone\n  æ˜¾ç¤ºå‡ºæŒ‡å®šç›®å½•çš„æ ‘å½¢ç»“æ„ï¼Œå¹¶å¯ä»¥æŒ‡å®šæ·±åº¦ï¼Ÿ   Linuxä¸‹å¯ä»¥é€šè¿‡å‘½ä»¤â€tree -L nâ€œæ¥å®Œæˆã€‚\n   â€¦â€¦\n  å…¶ä»–\n   ç”¨æˆ·çš„éœ€æ±‚æ˜¯çµæ´»å¤šæ ·çš„ï¼Œæ˜¯å˜åŒ–çš„ï¼ŒGUIç•Œé¢ç›¸å¯¹æ¯”è¾ƒå›ºå®šï¼Œæ­£æ‰€è°“ä¼—å£éš¾è°ƒï¼Œæœ‰çš„ç”¨æˆ·å¸Œæœ›åŠŸèƒ½å¤šç‚¹ï¼Œå“ªæ€•ç•Œé¢çœ‹ä¸Šå»å¾ˆå¤æ‚ï¼Œä½†æ˜¯æœ‰çš„ç”¨æˆ·å´å¸Œæœ›ç•Œé¢å°½å¯èƒ½ç®€å•ï¼Œä»…ä»…ä¿ç•™åˆšéœ€çš„åŠŸèƒ½å°±å¯ä»¥ã€‚\n å¯¹äºwindowsèµ„æºç®¡ç†å™¨è€Œè¨€ï¼Œæ— æ³•å®Œæˆä¸Šè¿°ä»»åŠ¡ï¼Œå®é™…ä¸ŠLinuxä¸­çš„æŸäº›ç±»ä¼¼çš„GUIå·¥å…· ä¹Ÿéš¾ä»¥å®Œæ•´åœ°æä¾›ä¸Šè¿°åŠŸèƒ½ï¼Œè€ŒLinuxå‘½ä»¤è¡Œå´å¯ä»¥é€šè¿‡æŸç§å½¢å¼çš„ç»„åˆï¼Œæ¥å¿«é€Ÿåœ°æ»¡è¶³ å„ç§çµæ´»å¤šå˜çš„åŠŸèƒ½éœ€æ±‚ï¼ŒGUIå·¥å…·ç›¸æ¯”è¾ƒä¹‹ä¸‹ï¼Œæ˜¾å¾—éå¸¸ä¸çµæ´»ã€‚è¿™è¿˜åªæ˜¯è°ˆåˆ°ä¸€ä¸ªç®€ å•çš„èµ„æºç®¡ç†æ–¹é¢çš„å·¥ä½œï¼Œæˆ‘ä»¬çš„å·¥ä½œå®é™…ä¸Šæ¯”è¿™ä¸ªè¦å¤æ‚å¾ˆå¤šå¾ˆå¤šï¼ŒLinuxä¸­çš„å‘½ä»¤è¡Œ å¯ä»¥é€šè¿‡ä¸åŒç¨‹åº¦åœ°ç»„åˆæ¥æ»¡è¶³è§£å†³å¤æ‚ä»»åŠ¡ï¼Œä½†æ˜¯è¦æä¾›ä¸€ä¸ªGUIæ¥èƒœä»»æ‰€æœ‰çš„çµ æ´»å¤šå˜çš„ä»»åŠ¡ï¼Œå°±å¤ªä¸ç°å®äº†ã€‚\nä¸Šé¢æåˆ°äº†å‘½ä»¤è¡Œçš„å¼ºå¤§ä¹‹å¤„ï¼Œç›¸ä¿¡å¤§å®¶èƒ½å¤Ÿå¯¹å‘½ä»¤äº§ç”Ÿä¸€ç‚¹æ–°çš„è®¤è¯†ï¼Œå¯¹äºé‡åº¦Linux ç”¨æˆ·æ¥è¯´ï¼Œå‘½ä»¤è¡Œæ˜¯ä¸å¯ç¼ºå°‘çš„ï¼Œä¸€ä¸ªä¸èƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨å‘½ä»¤è¡Œçš„ç”¨æˆ·ï¼Œå¾ˆéš¾è¯´ä»–æ˜¯ä¸€ä¸ªæ°´ å¹³è¾ƒé«˜çš„ç”¨æˆ·ï¼Œå“ªæ€•ä»–æœ‰å†é•¿çš„ä½¿ç”¨ç»å†ä¹Ÿæ˜¯ç™½æ­ï¼Œæ—¶é—´å¹¶ä¸èƒ½ä¿è¯ç”¨æˆ·ç§¯ç´¯äº†å……è¶³çš„ç» éªŒå’ŒçŸ¥è¯†ã€‚é‡åº¦Linuxç”¨æˆ·å¯èƒ½ä¼šå¼€å¯å¾ˆå¤šçš„å‘½ä»¤è¡Œçª—å£ï¼Œå¹¶åœ¨ä¸åŒçš„çª—å£ä¸­æ‰§è¡Œä¸åŒçš„ ä»»åŠ¡ï¼Œä½†æ˜¯å¦‚æœèƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªç¨‹åºå¯¹å¼€å¯çš„å¤šä¸ªå‘½ä»¤è¡Œçª—å£è¿›è¡Œæ›´åŠ æœ‰ç»„ç»‡çš„ç®¡ç†ï¼Œæ“ä½œ èµ·æ¥å°±ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œtmuxã€screenå°±æ˜¯åŸºäºè¿™æ ·çš„ç›®çš„è¯ç”Ÿçš„ã€‚è€Œbyobuæ˜¯å»ºç«‹åœ¨tmuxæˆ–è€…screenä¹‹ä¸Šçš„ä¸€ä¸ªæ›´åŠ ç•Œé¢å‹å¥½çš„å·¥å…·ç¨‹åºï¼Œé€šè¿‡å®ƒå¯ä»¥æ›´åŠ æ–¹ä¾¿çš„å¯¹æ‰“å¼€çš„å¤šä¸ªå‘½ä»¤è¡Œçª—å£è¿›è¡Œç®¡ç†ã€‚byobuä¸­çš„å¸¸ç”¨æ“ä½œåŒ…æ‹¬F2åˆ‡æ¢ã€F8é‡å‘½åç­‰ç­‰ã€‚\n4.2.2.lanternã€switchomega+chromeã€vpn # åœ¨å›½å†…ï¼Œæœ‰å µå¢™é˜»ç¢äº†æˆ‘ä»¬æ­£å¸¸ä¸Šç½‘ï¼Œå°±æ˜¯GFWå˜›ï¼Œä¸è¯´ä½ ä»¬ä¹ŸçŸ¥é“å¯¹ä¸å¯¹ï¼Œä½†æ˜¯æœ‰äº›äºº ç¡®å®æ˜¯ä¸çŸ¥é“çš„ï¼Œæˆ‘åˆšä¸Šå¤§å­¦çš„æ—¶å€™å°±ä¸çŸ¥é“ã€‚09å¹´é«˜ä¸­æ¯•ä¸šä¹‹åï¼Œæˆ‘ä¹°äº†è‡ªå·±çš„ç”µè„‘ï¼Œ æ‰ç®—æ˜¯çœŸæ­£åœ°ç”¨èµ·äº†äº’è”ç½‘ã€‚å¤§ä¸€çš„æ—¶å€™ï¼Œé‚£ä¸ªæ—¶å€™æ¯”è¾ƒèœï¼Œå¾ˆå¤šè®¡ç®—æœºæŠ€æœ¯æ–¹é¢çš„é—®é¢˜ ï¼Œåœ¨ç™¾åº¦ä¸Šæœç´¢ä¸€ä¸‹åŸºæœ¬å°±å¯ä»¥å¾—åˆ°è§£å†³ï¼Œä½†æ˜¯åæ¥æ…¢æ…¢åœ°å‘ç°è‡ªå·±æå‡ºçš„é—®é¢˜ï¼Œç™¾åº¦åŸº æœ¬ä¸Šæœç´¢ä¸åˆ°æ­£ç¡®çš„ç»“æœï¼Œè€Œä¸”ä¹Ÿå¯¹ç™¾åº¦çš„æœç´¢è´¨é‡è¶Šæ¥è¶Šä¸æ»¡æ„ã€‚åé¢æ˜¯ä¸€ä¸ªåŒå­¦ä»‹ç» æˆ‘ä½¿ç”¨Googleï¼Œä¹Ÿç¡®å®è®©è‡ªå·±å—ç›ŠåŒªæµ…ã€‚\nç”¨Googleï¼Œéœ€è¦ç¿»å¢™ï¼Œç¿»å¢™çš„æ‰‹æ®µä¹Ÿæ˜¯å¤šç§å¤šæ ·ï¼Œç¿»å¢™å·¥å…·æ›´æ˜¯äº”èŠ±å…«é—¨ã€‚ä½†æ˜¯è¯´æ¥è¯´å» ï¼ŒæŠŠé‚£äº›é™ˆå¹´åºŸå¼ƒçš„è€å¤è‘£æ¬å‡ºæ¥æ²¡æœ‰å¤šå¤§å®ç”¨ä»·å€¼ï¼Œå½“ç„¶äº†å®ƒä»¬éå¸¸å…·æœ‰å†å²æ„ä¹‰ï¼Œå¯¹ äºé‚£äº›æ›¾ç»å¥‹æ–—åœ¨ç¿»å¢™ä¸€çº¿çš„å‰è¾ˆä»¬æˆ‘ä»¬åº”è¡¨ç¤ºæ„Ÿè°¢ã€‚ç°åœ¨æ¯”è¾ƒå¥½ç”¨çš„ç¿»å¢™å·¥å…·ï¼Œè¦ä¹ˆå°± æ˜¯ç›´æ¥ç”¨vpnï¼Œè¦ä¹ˆå°±æ˜¯ç”¨å¼€æºçš„lanternã€‚lanternæ”¯æŒWindowsã€Linuxã€OS Xå¤šç§æ“ä½œ ç³»ç»Ÿï¼Œä¹Ÿæ”¯æŒAndroidæ‰‹æœºï¼Œç›®å‰ä¸æ”¯æŒiOSã€‚æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥ç›´æ¥ä»å¦‚ä¸‹é“¾æ¥è¿›è¡Œä¸‹è½½ ï¼šhttps://github.com/getlanternã€‚\nå¯¹äºlanternçš„é…ç½®ï¼Œåœ¨windowsä¸‹é¢ï¼Œåªè¦è¿è¡Œlanternï¼ŒIEæµè§ˆå™¨ã€Chromeæµè§ˆå™¨ç­‰å°± ä¼šè‡ªåŠ¨è¿›å…¥ä»£ç†æ¨¡å¼ï¼Œåœ¨ä¸åŒçš„Linuxå‘è¡Œç‰ˆä¸­å¯èƒ½è¦è¿›è¡Œä¸åŒçš„è®¾ç½®ã€‚Ubuntu 16.04 LTSä¸­å¯ä»¥å¯åŠ¨lanternåè®©æµè§ˆå™¨è‡ªåŠ¨è¿›å…¥ä»£ç†æ¨¡å¼ï¼›Fedora 21ä¸­åœ¨å¯åŠ¨Lanternä¹‹åï¼Œ Firefoxæµè§ˆå™¨è‡ªåŠ¨è¿›å…¥ä»£ç†æ¨¡å¼ï¼Œä½†æ˜¯å¯¹äºChromeæµè§ˆå™¨éœ€è¦é€šè¿‡SwitchyOmegaè¿›è¡Œç›¸åº”çš„ä»£ç†è®¾ç½®ï¼Œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªä»£ç†ä»£ç†è§„åˆ™ï¼Œå³ä½¿ç”¨pac.profileæ¥å®ç°è‡ªåŠ¨ä»£ç†ï¼Œ pac.profileè·å–urlä¸º: http://localhost:16823/proxy_on.pacã€‚é€ æˆè¿™ç§é—®é¢˜çš„åŸå›  å¯èƒ½æ˜¯lanternè®¾ç½®é¡µé¢æ²¡æœ‰å‹¾é€‰â€œç®¡ç†ç³»ç»Ÿä»£ç†â€ï¼Œå¯èƒ½ä¹Ÿæ˜¯lanternåœ¨ä¸åŒç³»ç»Ÿä¸Šçš„â€è¡Œä¸ºâ€œå·®å¼‚ã€‚\nlanternæä¾›äº†ä¸€ä¸ªhttpä»£ç†ç«¯å£8787ï¼ˆæ”¯æŒhttpã€httpsåè®®ï¼‰ï¼Œå¯ä»¥é€šè¿‡proxychains è¿›è¡Œè®¾ç½®ï¼Œå¯¹å…¶ä»–httpç¨‹åºè¿›è¡Œä»£ç†ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶ä»–ä½¿ç”¨httpä»£ç†çš„è½¯ä»¶æä¾›ä»£ç†æœåŠ¡ï¼Œ ä¾‹å¦‚android studioã€eclipseã€mendeley desktopç­‰ç­‰ã€‚\n å†™åœ¨2022å¹´6æœˆï¼šå†è§lanternï¼Œlanternæ­¤æ—¶å·²ç»é€€å‡ºå†å²èˆå°å¾ˆå¤šå¹´äº† :(\n 4.2.3.vim+markdownã€cherrytreeã€wiznote # ä¸ç®¡æ˜¯åœ¨å­¦ä¹ Linuxçš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æ˜¯åœ¨å…¶ä»–å­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œéƒ½éœ€è¦å¯¹ç›¸å…³çŸ¥è¯†è¿›è¡Œæ”¶è—ã€æ•´ ç†ã€æ€»ç»“ï¼Œå…»æˆä¸€ä¸ªè‰¯å¥½çš„è®°ç¬”è®°çš„ä¹ æƒ¯æ˜¯éå¸¸é‡è¦çš„ï¼Œå½“ç„¶äº†ï¼Œæ‹¥æœ‰ä¸€ä¸ªè·Ÿå¾—ä¸Šæ€ç»´çš„ è®°ç¬”è®°çš„å·¥å…·ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ï¼Œè¿™ç±»å·¥å…·æœ‰å¾ˆå¤šï¼Œä¹Ÿçœ‹åˆ°å¾ˆå¤šæœ‹å‹éƒ½é€‰æ‹©äº†äº†è‡ªå·±çš„ç¼–è¾‘ å™¨ã€‚æˆ‘æœ¬äººä¹Ÿåœ¨é•¿æœŸçš„å­¦ä¹ è¿‡ç¨‹ä¸­è¯•ç”¨äº†å¤§é‡çš„è®°ç¬”è®°å·¥å…·ï¼Œä½†æ˜¯æœ‰çš„å·¥å…·æä¾›çš„åŠŸèƒ½å¹¶ ä¸æ˜¯æˆ‘æ‰€éœ€è¦çš„ï¼Œæˆ–è€…æ²¡æœ‰æˆ‘æƒ³è¦çš„åŠŸèƒ½ï¼Œç»è¿‡å¤§é‡å°è¯•ä¹‹åï¼Œæˆ‘ä¹Ÿæ‰¾åˆ°äº†é€‚åˆæˆ‘ä½¿ç”¨çš„ è®°ç¬”è®°çš„å·¥å…·ï¼Œåœ¨è¿™é‡Œä¹Ÿç®€å•ä»‹ç»ä¸€ä¸‹ã€‚\næ­£æ‰€è°“å·¥å…·è¦è¶æ‰‹ï¼Œè¶æ‰‹çš„æ„æ€ä¹Ÿå°±æ˜¯è¯´ï¼Œå·¥å…·å¥½ä¸å¥½ï¼Œå…³é”®è¦çœ‹æ˜¯å¦é€‚åˆç”¨æˆ·è‡ªå·±ï¼Œå›  æ­¤ä¸å¤ªå¯èƒ½è¯´ï¼Œæˆ‘å–œæ¬¢çš„å·¥å…·ä½ ä¹Ÿä¸€å®šå–œæ¬¢ï¼Œæˆ–è€…ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ä½ çš„éœ€è¦ï¼Œè¯·è¾©è¯çœ‹å¾…ã€‚\n vim+markdown  vimä½œä¸ºç¼–è¾‘å™¨ä¹‹ç¥ï¼Œå·²ç»èµ¢å¾—äº†å¾ˆå¤šäººçš„é’çï¼Œç‰¹åˆ«æ˜¯ç¨‹åºå‘˜ï¼Œæˆ‘ä¹Ÿæ˜¯ç¨‹åºå‘˜ï¼Œæˆ‘ä¹Ÿå–œ æ¬¢å†™ä¸œè¥¿ï¼Œæ¯”å¦‚å†™æ€»ç»“ã€å†™åšå®¢ã€å†™ä½“ä¼šç­‰ç­‰å§ï¼Œä½†æ˜¯æˆ‘è®¨åŒæŠŠå¤§é‡çš„æ—¶é—´èŠ±åœ¨æ’ç‰ˆä¸Šã€‚ å°†vimä¸markdownç»“åˆèµ·æ¥å¯ä»¥è¯´æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é€‰æ‹©ã€‚å¹¶ä¸”é€šè¿‡é…åˆ vim-instant-markdownæ’ä»¶ï¼Œå¯ä»¥å®ç°åœ¨æ–‡å­—ç¼–è¾‘è¿‡ç¨‹ä¸­çš„å®æ—¶é¢„è§ˆã€‚æˆ‘éå¸¸å–œæ¬¢ç°åœ¨çš„è¿™ç§ç¼–è¾‘ä½“éªŒã€‚ä¸‹å›¾æ˜¯æˆ‘ç°åœ¨ç¼–è¾‘çŠ¶æ€ä¸‹çš„ä¸€ä¸ªæˆªå›¾ã€‚\nå¯¹äºé›†æˆäº†markdownè¯­æ³•æ”¯æŒçš„ç¼–è¾‘å™¨ï¼Œä¹Ÿæœ‰å¾ˆå¤šï¼Œä½†æ˜¯ç”±äºæˆ‘é’Ÿæƒ…äºvimï¼Œå³ä¾¿æœ‰ç¼–è¾‘ å™¨é›†æˆäº†å¯¹vimæ“ä½œæ–¹å¼çš„æ¨¡æ‹Ÿï¼Œä½†æ˜¯æ¯•ç«Ÿè¿˜æ˜¯æ¨¡æ‹Ÿï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„vimï¼Œç¼–è¾‘æ•ˆç‡ä» ç„¶å¤§å¤§å—é™ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰é€‰æ‹©åƒmarkdownã€atomè¿™æ ·çš„ç¼–è¾‘å·¥å…·ã€‚å¦‚æœæœ‹å‹ä»¬ä¸å–œæ¬¢vimï¼Œå¯ä»¥è¯•ç”¨ä¸‹atomã€‚\n psï¼š2022å¹´6æœˆæ›´æ–°ï¼Œæˆ‘ä¹Ÿæ˜¯instant-markdown-dçš„è´¡çŒ®è€…ã€‚\n  cherrytree  cherrytreeä¸­å¯ä»¥é€šè¿‡æ ‘å½¢ç»“æ„å¯¹å¤šä¸ªå­¦ä¹ ä¸åŒçš„å­¦ä¹ å†…å®¹è¿›è¡Œé˜»æ­¢ï¼Œä¾‹å¦‚ä¸ºç¼–ç¨‹ã€å†…æ ¸ ã€ç®—æ³•å•ç‹¬åˆ›å»ºä¸€æ£µæ ‘è¿›è¡Œç®¡ç†ï¼Œç®€å•ç›´è§‚ï¼›\næ ‘å½¢ç»“æ„å¯ä»¥ä»»æ„æ‰©å±•ï¼Œæ”¯æŒå¤šçº§å­æ ‘çš„åˆ›å»ºï¼Œçµæ´»æ–¹ä¾¿ï¼›\nç¼–è¾‘å™¨ä¸­æ”¯æŒä¸åŒç¼–ç¨‹è¯­è¨€çš„è¯­æ³•é«˜äº®ï¼Œè€Œä¸”èƒ½æ–¹ä¾¿åœ°è°ƒèŠ‚ä»£ç çª—å£çš„å¤§å°ï¼Œå®ç”¨ï¼›\ncherrytreeæ˜¯æˆ‘æœ€å¸¸ç”¨çš„è®°ç¬”è®°å·¥å…·äº†ï¼Œå¹¶ä¸”å…¶æ–‡ä»¶æ”¯æŒåŠ å¯†æ“ä½œï¼Œé¿å…ä¿¡æ¯æ³„éœ²ï¼Œä¹Ÿå¯ ä»¥éå¸¸æ–¹ä¾¿åœ°å°†å…¶åŠ å…¥githubä¸­ï¼Œæ°¸ä¸ä¸¢å¤±ï¼Œå¤šå¥½å•Šï¼\n ps: 2022.6æ›´æ–°ï¼Œåœ¨æˆ‘åé¢å·¥ä½œåé€æ¸å°†å·¥ä½œè¿ç§»åˆ°äº†macè®¾å¤‡ä¸‹ï¼Œä¸»è¦åŸå› æ˜¯è‹¹æœç”Ÿæ€ä¸‹è®¾å¤‡ä¹‹é—´æ–‡ä»¶åŒæ­¥éå¸¸æ–¹ä¾¿ï¼Œä½†æ˜¯cherrytreeçš„ä½œè€…è¡¨ç¤ºè‡ªå·±æ²¡æœ‰macè®¾å¤‡ï¼Œæ‰€ä»¥cherrytreeçŸ­æœŸå†…å…¼å®¹macæ˜¯ä¸å¤§å¯èƒ½çš„ã€‚æœ‰ç‚¹é—æ†¾ï¼Œæˆ‘å¯¹macä¸‹çš„å›¾å½¢åŒ–ç¼–ç¨‹ä¸€çŸ¥åŠè§£ï¼Œä¸ç„¶è¿˜å¯ä»¥å¸®åŠ©è´¡çŒ®ä¸‹ã€‚\n  wiznote  æˆ‘ä»¬éƒ½ç»å¸¸ä¸Šç½‘ï¼Œä¸ç®¡æ˜¯ç”¨æ‰‹æœºè¿˜æ˜¯ç”¨ç”µè„‘ï¼Œå¾ˆå¤šæ—¶å€™ï¼Œçœ‹åˆ°éå¸¸å¥½çš„å¸–å­ï¼Œéƒ½æ˜¯å¸Œæœ›å°† å…¶æ”¶è—ä¸€ä¸‹ï¼Œæ”¶å•åˆ°æµè§ˆå™¨æ”¶è—å¤¹æˆ–è€…æŸäº›appå®¢æˆ·ç«¯é‡Œé¢ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¸¸æ³¨æ„åˆ°è¿™ç§æƒ… å†µï¼Œæœ‰çš„å¸–å­ç»è¿‡å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¸èƒ½æ­£å¸¸è®¿é—®äº†ï¼Œå¯èƒ½æ˜¯è¢«åˆ é™¤äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«å’Œ è°äº†ï¼Œæˆ–è€…æ˜¯è¢«é‡æ–°ç¼–è¾‘è¿‡äº†ï¼Œä¸ä¹‹å‰ç›¸æ¯”å‘ç”Ÿäº†å˜åŒ–â€¦â€¦æˆ‘ä»¬å½“ç„¶æ˜¯å¸Œæœ›æ”¶è—çš„å†…å®¹æ—¥å æŸ¥çœ‹çš„æ—¶å€™ä»ç„¶ä¸æ”¶è—æ—¶å†…å®¹ä¿æŒä¸€è‡´ï¼Œå½“ç„¶æ›´ä¸å¸Œæœ›è¿›è¡Œæ”¶è—çš„ç½‘é¡µæ—¥åå±…ç„¶æ— æ³•è®¿é—® äº†ï¼Œè¿™å²‚ä¸æ˜¯å¾ˆç³Ÿç³•ã€‚\nä¸ºçŸ¥ç¬”è®°å¾ˆå¥½åœ°è§£å†³äº†è¿™ä¸€ç‚¹ï¼Œå½“æˆ‘ä»¬æ”¶è—ä¸€ä¸ªç½‘é¡µçš„æ—¶å€™ï¼Œå¹¶ä¸åªæ˜¯ç®€å•åœ°ä¿å­˜ä¸€ä¸‹ç½‘ é¡µçš„é“¾æ¥ï¼Œè€Œæ˜¯å¯ä»¥åœ¨æœ¬åœ°ä¸­ç¦»çº¿ä¸€ä»½å®Œæ•´çš„ç½‘é¡µï¼Œå°†å†…å®¹ä¿å­˜èµ·æ¥ã€‚è€Œä¸”ä¸ºçŸ¥ç¬”è®°è¿˜åš åˆ°äº†æµè§ˆå™¨é¡µé¢æ”¶è—ã€å¾®ä¿¡æœ‹å‹åœˆæ–‡ç« æ”¶è—ã€å…¬ä¼—å·æ–‡ç« æ”¶è—ï¼Œè¿˜èƒ½å¤Ÿå°†å…¶ä»–åœ°æ–¹çœ‹åˆ°çš„ ç½‘é¡µåˆ†äº«åˆ°ä¸ºçŸ¥ç¬”è®°çš„å…¬ä¼—å·ï¼Œåªè¦åˆ†äº«äº†å°±è‡ªåŠ¨ä¿å­˜ã€‚éå¸¸åœ°æ–¹ä¾¿ï¼ç°åœ¨å¾ˆå¤šäººéƒ½åœ¨ä½¿ ç”¨ä¸ºçŸ¥ç¬”è®°äº†ï¼\nç°åœ¨ä¸ºçŸ¥ç¬”è®°ä¹Ÿå¯ä»¥æ”¯æŒmarkdownè¯­æ³•äº†ï¼Œä½†æ˜¯ï¼Œç¼–è¾‘å·¥ä½œæˆ‘è¿˜æ˜¯å¸Œæœ›ä½¿ç”¨vimæ¥å®Œæˆï¼Œ ä¸ºçŸ¥ç¬”è®°æ›´å¤šæ—¶å€™è¢«æˆ‘ç”¨æ¥æ”¶è—ç½‘é¡µã€æœ‹å‹åœˆã€å…¬ä¼—å·ä¸­çš„æ–‡ç« ï¼Œè¿‡ä¸€æ®µæ—¶é—´å†å¯¹å…¶è¿›è¡Œ æ•´ç†ï¼Œæ”¶å…¥cherrytreeä¸­ã€‚ä½†æ˜¯å¯¹äºä¸€èˆ¬çš„ç¬”è®°ï¼Œæˆ‘æ›´å¼ºç›¸é‡ä½¿ç”¨vim+markdownæ¥å®Œæˆã€‚\n psï¼š2022.6æ›´æ–°ï¼Œä¸ºçŸ¥ç¬”è®°ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„ç¬”è®°ï¼Œä½†æ˜¯åœ¨æˆ‘åç»­ä½¿ç”¨ä¸­é‡åˆ°äº†åŒæ­¥é”™ä¹±çš„é—®é¢˜ï¼Œæœ€åæ”¾å¼ƒä½¿ç”¨ç±»ä¼¼äº‘ç¬”è®°çš„ä¸œè¥¿äº†ï¼Œç›´æ¥ç”¨ç®€å•é è°±çš„githubæ¥æ‰˜ç®¡æ•°æ®ï¼Œç”¨æœ€å¥½ç”¨çš„ç¼–è¾‘å™¨typoraç­‰æ¥å†™æ–‡æ¡£ã€‚\n 4.2.4.gthumbã€gimpã€shotwell # æŸ¥çœ‹å›¾ç‰‡å·¥å…·ï¼Œgnomeã€unityé‡Œé¢æœ€å¥½çš„æˆ‘è®¤ä¸ºè¦æ•°gthumbäº†ï¼Œåœ¨kdeé‡Œé¢gthumbç•Œé¢æ¯”è¾ƒä¸‘ï¼Œä½†æ˜¯å…¶åŠŸèƒ½ç»å¯¹æ˜¯æœ€å¼ºå¤§çš„ã€‚gimpæ˜¯ç±»ä¼¼äºpsçš„å›¾åƒå¤„ç†å·¥å…·ï¼Œå°å·§ä¹Ÿå¾ˆä½¿ç”¨ã€‚ shotwellæ˜¯ç…§ç‰‡ç®¡ç†è½¯ä»¶ï¼Œå¹³å¿ƒè€Œè®ºè½¯ä»¶åšçš„æ˜¯ä¸é”™ï¼Œä½†æ˜¯ä½¿ç”¨çš„ç¡®å®ä¸å¤šã€‚\n4.2.5.virtualboxã€vmware workstation # è™šæ‹Ÿæœºç®¡ç†è½¯ä»¶virtualboxåœ¨Linuxä¸‹æ˜¯éå¸¸èµçš„ï¼Œvmware workstationä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ vmware workstationæœ‰äº›bugï¼Œæˆ‘åœ¨Fedora 21ä¸Šè¿›è¡Œå®‰è£…æ˜¯é‡åˆ°äº†é—®é¢˜ï¼Œå½“ç„¶é€šè¿‡ä¿®æ”¹æºä»£ç ï¼Œé‡æ–°ç¼–è¯‘ä¹ŸæˆåŠŸè¿›è¡Œå®‰è£…äº†ï¼Œä½†æ˜¯æœ‰çš„é—®é¢˜è¿˜æ˜¯æ— æ³•è§£å†³ã€‚åœ¨Linuxä¸‹é¢ä½¿ç”¨ virtualboxè¦æ›´åŠ çœå¿ƒä¸€äº›ï¼Œvirtualboxå·²ç»åšçš„éå¸¸å‡ºé”™äº†ï¼Œæ”¯æŒçš„æ“ä½œç³»ç»Ÿç±»å‹æ¯” vmware workstationè¦å¤šï¼Œè€Œä¸”æ€§èƒ½æ–¹é¢ä¹Ÿä¸€ç‚¹ä¸è¾“vmware workstationï¼Œå¯¹Linuxæ”¯æŒçš„ä¹Ÿæ¯”è¾ƒå¥½ã€‚\nåœ¨Linuxä¸‹é¢ï¼Œå»ºè®®ä½¿ç”¨virtualboxï¼Œæˆ‘ç°åœ¨å®‰è£…äº†å¤šä¸ªè™šæ‹Ÿæœºï¼ŒåŒ…æ‹¬windows xpã€ openSUSE 13ã€Mac OS X 10.7æ˜¯ç”¨çš„éå¸¸å¥½ï¼Œå½“ç„¶å…¶ä»–çš„ç³»ç»Ÿä¹Ÿéƒ½å®‰è£…åæµ‹è¯•è¿‡ï¼Œä¸Šé¢æ åˆ°çš„ä¸‰ä¸ªè¦ä¸åŒç¨‹åº¦åœ°ç”¨åˆ°ã€‚\nä»¥å‰åœ¨windowsä¸‹é¢çš„æ—¶å€™ï¼Œæˆ‘ç¡®å®æ˜¯ç”¨vmware workstationæ¯”è¾ƒå¤šï¼Œå› ä¸ºvirtualboxåœ¨ windowsä¸‹é¢è·‘èµ·æ¥çœŸå¿ƒæ…¢çš„è¦å‘½ï¼Œvmware workstationè¦å¥½å¾ˆå¤šï¼Œä½†æ˜¯åœ¨Linuxé‡Œé¢ï¼Œ virtualboxè¿è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œè€Œä¸”æ˜¯è‡ªç”±è½¯ä»¶ï¼Œå½“ç„¶ä½¿ç”¨virtualboxäº†ã€‚\nvirtualboxæä¾›çš„å‡ ç§ç½‘ç»œæ¨¡å¼ï¼Œä¹Ÿå¾ˆç®€æ´æ˜äº†ï¼Œnatã€host onlyç­‰æ¨¡å¼ï¼Œå¯ä»¥åŸºæœ¬æ»¡è¶³ çš„éœ€è¦ï¼Œæˆ‘å€¾å‘äºé€‰æ‹©virtualboxã€‚\n4.2.6.smplayerã€clementineã€mixxxã€mpg123ã€openshot # Linuxä¸‹é¢çš„è§†é¢‘æ’­æ”¾è½¯ä»¶ï¼Œæˆ‘è®¤ä¸ºæœ€æ–¹ä¾¿çš„åº”è¯¥æ˜¯smplayerï¼Œè·Ÿvlcã€dragon playerã€ totemã€mpvç­‰ç­‰æ¯”èµ·æ¥ç®€ç›´æ˜¯ç¥å™¨ï¼Œä¸ä»…åŠŸèƒ½å¤šï¼Œè€Œä¸”æ“ä½œä¹Ÿæ–¹ä¾¿ï¼ŒæŸç§ç¨‹åº¦ä¸Šå½’åŠŸäºå…¶ä¸°å¯Œçš„å¿«æ·é”®é…ç½®æ“ä½œã€‚\néŸ³é¢‘æ’­æ”¾å™¨ï¼Œæˆ‘è§‰å¾—clementineæ¯”è¾ƒå¥½ï¼Œå¬éŸ³ä¹å˜›ï¼Œä¹Ÿä¸éœ€è¦éå¸¸å¤æ‚çš„æ“ä½œï¼Œç•Œé¢ç®€å• æ¸…çˆ½å°±å¥½äº†ï¼Œclementineæ»¡è¶³äº†æˆ‘çš„éœ€è¦ï¼Œæˆ‘ä¸å–œæ¬¢rhymboxã€bansheeç­‰å…¶ä»–æµè¡Œçš„éŸ³é¢‘æ’­æ”¾å™¨ã€‚å–œæ¬¢djã€ç”µå­éŸ³ç­‰åŠ²çˆ†éŸ³ä¹çš„ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹mixxxã€‚mpg123æ˜¯å‘½ä»¤è¡Œä¸‹çš„ä¸€ä¸ªéå¸¸ç®€å•çš„éŸ³é¢‘æ’­æ”¾å·¥å…·ã€‚\nopenshotæ˜¯ä¸€ä¸ªçŸ¢é‡è§†é¢‘ç¼–è¾‘å·¥å…·ï¼Œå…¶åŠŸèƒ½éå¸¸å¤šï¼Œæˆ‘ç»å¸¸ç”¨å®ƒæ¥åˆæˆè§†é¢‘ã€å‰ªè¾‘è§†é¢‘ã€ è§†é¢‘è½¬ç ç­‰ç­‰ï¼Œopenshotå·¥ä½œè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºè®¡ç®—é‡è¾ƒå¤§ï¼Œcpuä½¿ç”¨ç‡è¾ƒé«˜ã€‚\n4.2.7.openssh-serverã€openssh-client # sshï¼Œsecure shellï¼Œè¿™ä¸ªæ˜¯å¾ˆæœ‰ç”¨çš„ä»£æ›¿ftpã€telnetçš„å·¥å…·ï¼Œåœ¨è‡ªå·±çš„ç”µè„‘ä¸Šæ­å»ºä¸€ä¸ª sshdæœåŠ¡è¿˜æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œè¯´ä¸å®šå•¥æ—¶å€™å°±éœ€è¦ä»å…¶ä»–ç”µè„‘é“¾æ¥åˆ°è‡ªå·±çš„ç”µè„‘ï¼Œæ¯”å¦‚ hostä¸guestè¿›è¡Œé€šä¿¡çš„æ—¶å€™ï¼Œæˆ–è€…åœ¨æœ¬åœ°æ­å»ºgitæœåŠ¡å™¨çš„æ—¶å€™â€¦â€¦æœ‰å¾ˆå¤šåœºæ™¯éƒ½ä¼šç”¨åˆ°ã€‚ å½“ç„¶äº†ï¼Œæ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡sshå»é“¾æ¥å¤–é¢çš„æŸä¸ªä¸»æœºã€‚\n psï¼šå› ä¸ºç½‘ç»œçš„åŸå› è®¿é—®githubä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘æ˜¯æäº†ä¸ªäºŒçº§çš„gitæ‰˜ç®¡ï¼Œç¬¬ä¸€çº§æ˜¯åœ¨æœ¬åœ°ç”µè„‘ä¸Šå¼€äº†ä¸ªä¸“é—¨çš„è´¦æˆ·gitï¼Œè¿™ä¸ªè´¦å·homeç›®å½•ä¸‹ç”¨æ¥æ‰˜ç®¡gitæ•°æ®ï¼Œä½†æ˜¯è¿™ä¸ªè´¦å·ç¦æ­¢ç™»å½•ã€‚ç„¶åç™½å¤©æˆ‘åœ¨å›¾ä¹¦é¦†æˆ–è€…ç½‘ç»œä¸å¥½çš„åœ°æ–¹å¹²æ´»ï¼Œå°±ä¼šä»æœ¬åœ°å·¥ä½œç©ºé—´æäº¤åˆ°è¿™é‡Œæ¥ï¼Œç­‰æœ‰ç½‘ç»œäº†æˆ‘å†æäº¤åˆ°githubï¼Œå…¶å®æœ‰äº›æˆ‘ä¹Ÿæ²¡æœ‰æäº¤åˆ°githubã€‚æˆ‘ä¸»è¦æ˜¯æ‹…å¿ƒè¯¯åˆ é™¤rm -rfä¹‹ç±»çš„ä¸å°å¿ƒæŠŠä»“åº“ç»™åˆ äº†ï¼Œæ‰€ä»¥æ‰æä¸ªç‹¬ç«‹è´¦å·æ¥å……å½“gitæœåŠ¡å™¨ã€‚\n æ€»ä¹‹ï¼Œsshdã€sshæ˜¯ç»å¸¸ç”¨åˆ°çš„å·¥å…·ï¼Œå¯ä»¥é€šè¿‡å®‰è£…openssh-serverå°†æœ¬åœ°ä¸»æœºé…ç½®æˆ sshdæœåŠ¡å™¨ï¼Œå®‰è£…openssh-clientæ¥è·å–ç›¸åº”çš„sshç­‰ä¼—å¤šå®ç”¨å®¢æˆ·ç«¯å·¥å…·ã€‚\n4.2.8.gitã€svn # ç‰ˆæœ¬æ§åˆ¶å·¥å…·çš„ä¸¤ä¸ªä»£è¡¨æ˜¯gitå’Œsvnï¼Œå…¶ä¸­svnæ˜¯é›†ä¸­å¼çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ï¼Œè€Œgitæ˜¯åˆ†å¸ƒå¼ çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œgitæ¯”svnè¦ä¼˜ç§€å¾ˆå¤šï¼Œå½“ç„¶å…¶å­¦ä¹ æˆæœ¬è¦é«˜å¾ˆå¤šã€‚\nå»ºè®®å­¦ä¹ ä¸€ä¸‹ã€ŠPro Gitã€‹è¿™æœ¬ä¹¦ï¼Œæ·±å…¥è®¤è¯†ä¸‹gitçš„å·¥ä½œåŸç†ï¼Œå¹¶åœ¨ä»¥åçš„çš„å­¦ä¹ å·¥ä½œä¸­ å…»æˆç‰ˆæœ¬æ§åˆ¶çš„æ„è¯†ï¼Œå¹¶åˆ‡å®å°†gitåº”ç”¨èµ·æ¥ã€‚\n4.2.9.gnome-terminalã€Konsole # ä¸€ä¸ªå¥½ç”¨çš„ç»ˆç«¯æ¨¡æ‹Ÿè½¯ä»¶ï¼Œç»å¯¹æ˜¯éå¸¸é‡è¦çš„ï¼Œæ¯”è¾ƒå¥½ç”¨çš„ä¸¤ä¸ªï¼Œkdeä¸‹é¢ä½¿ç”¨konsoleï¼Œ ubuntu unityã€gnomeä¸‹é¢ä½¿ç”¨gnome-terminalã€‚\nåœ¨é‡Œé¢å¯ä»¥å¯¹å­—ä½“ã€é¢œè‰²ã€è¾“å…¥æŒ‡ç¤ºå™¨ç­‰ç­‰è¿›è¡Œè¾ƒä¸ºä¸°å¯Œçš„è®¾ç½®ï¼Œä¸€åˆ‡ä¸ºäº†æ•ˆç‡ã€‚\n4.2.10.Ubuntu Unityã€KDEã€GNOME # å½“å‰æµè¡Œçš„ä¸‰å¤§æ¡Œé¢ç¯å¢ƒï¼Œæ˜¯ubuntu unityã€kdeã€gnomeï¼Œä»»ä½•ä¸€ä¸ªLinuxå‘è¡Œç‰ˆéƒ½å¯ä»¥ å¯¹ä¸Šè¿°æ¡Œé¢ç¯å¢ƒè¿›è¡Œæ•´åˆï¼Œæˆ‘å¯¹ç›®å‰ä¸»æµçš„æ¡Œé¢ç¯å¢ƒéƒ½ä½¿ç”¨è¿‡ï¼Œä¸Šè¿°ä¸‰ä¸ªä½¿ç”¨çš„æ—¶é—´æ¯”è¾ƒ é•¿ï¼Œæ ¹æ®æˆ‘å¤šå¹´çš„ä½¿ç”¨ä½“ä¼šï¼Œæˆ‘è‡ªå·±æ›´åŠ å€¾å‘äºé€‰æ‹©kdeå’Œubuntu unityã€‚å¦‚æœæˆ‘ä½¿ç”¨çš„ æ˜¯RHELç³»åˆ—çš„ï¼Œæˆ‘å°±ä½¿ç”¨kdeï¼Œå¦‚æœæˆ‘ä½¿ç”¨çš„æ˜¯Ubuntuï¼Œé‚£å°±ä½¿ç”¨ubuntu unityã€‚gnome3å®åœ¨ä¸æ•¢æ­ç»´ï¼Œæœ‰å¾ˆå¤šäººæ¯”è¾ƒæ¨å´‡gnome3ï¼Œä½†æ˜¯æˆ‘ç¡®å®ä¸å–œæ¬¢è¿™ç§æ–¹å¼ï¼Œè‡ªå·±æ„Ÿè§‰æ“ä½œæ•ˆç‡æ˜¯ä¸Šè¿°ä¸‰ä¸ªä¸­æœ€å·®åŠ²çš„ã€‚\n ubuntu unity  ä»ä½¿ç”¨ubuntu 12.04 ltså¼€å§‹ï¼Œå°±å¼€å§‹ä½¿ç”¨ubuntu unityäº†ï¼Œåˆšå¼€å§‹çš„æ—¶å€™ç¡®å®è§‰å¾—è¿˜ä¸ é”™ï¼Œä½†æ˜¯æ°¸ä¹…äº†ï¼Œå°±å‘ç°æœ‰äº›ä¸œè¥¿å¹¶ä¸å®ç”¨ï¼Œæˆ‘æƒ³å›å½’ç²¾ç®€äº†ï¼Œä»æ—§æ˜¯å–„å˜ï¼Œå¹¶ä¸å°±æ˜¯äºº å®¶unityåšçš„ä¸å¥½ã€‚åé¢ä½ ä»¬çŒœæˆ‘ç”¨ä¸Šäº†ä»€ä¹ˆï¼Œæˆ‘ç”¨ä¸Šgnome-shell-fallbackï¼Œæ²¡é”™ï¼Œæˆ‘ è§‰å¾—gnome2æ—¶å€™çš„ç•Œé¢çœŸæ˜¯æ¸…çˆ½å¤šäº†ï¼Œä¸ºæ­¤ï¼Œæˆ‘åé¢è¿˜ä½¿ç”¨äº†ç›¸å½“é•¿æ—¶é—´çš„rhel 6.5ï¼Œç›´ åˆ°åé¢æˆ‘ç”¨ä¸Šäº†Fedoraå¹¶å¼€å§‹ä½¿ç”¨kdeä½œä¸ºä¸»è¦çš„æ¡Œé¢ç¯å¢ƒã€‚\nç°åœ¨å‘ç°ubuntu unityç¡®å®åšçš„ä¸é”™ï¼Œç¨³å®šæ€§ã€é€Ÿåº¦ç­‰å„æ–¹é¢éƒ½ç›¸å½“ä¸é”™ï¼Œæ‰€ä»¥æˆ‘è¦å…ˆç»™ ä¸ªèµï¼å¯ä»¥è¯´ä¹‹å‰ä¸€ç›´éƒ½åœ¨æŠ˜è…¾GUIæ–¹é¢çš„ä¸œè¥¿äº†ï¼Œè¶ŠæŠ˜è…¾è¶Šå¿ƒç´¯ï¼Œç°åœ¨èƒ½å¤Ÿå¹³å¿ƒé™æ°”åœ° æ¥å¯¹å¾…è¿™äº›é—®é¢˜äº†ï¼Œè‡ªå·±ä¹Ÿæœ‰å®åŠ›å¯¹ä¸åˆå¿ƒæ„çš„åœ°æ–¹è¿›è¡Œä¿®æ”¹äº†ï¼Œæ”¹é…ç½®æ–‡ä»¶ã€æ”¹æºä»£ç  ã€æ›¿æ¢å¿…è¦çš„ç»„ä»¶ç­‰ç­‰ï¼Œéšå¿ƒæ‰€æ¬²ä¸é€¾çŸ©ï¼è¿™ç§æ„Ÿè§‰è¿˜æ˜¯éå¸¸çˆ½çš„ï¼å½“æˆ‘çœ‹åˆ°æœ‰æŸä¸ªåŒå­¦ åœ¨ä½¿ç”¨â€œä¸‘é™‹â€çš„Ubuntuæ—¶ï¼Œå¿ƒé‡Œé¢å°±æœ‰ç§ä¸ä¸€æ ·çš„æ„Ÿè§‰ï¼Œå¾ˆå¤šæ–°æ‰‹ä¸ä¼šé…ç½®å´æ€»æ˜¯æŠ±æ€¨ï¼ŒLinuxè¿™ä¹ˆçµæ´»ï¼Œå°±æ˜¯è®©ä½ å»æ¢ç´¢çš„ï¼Œä¸å–œæ¬¢æ¢ç´¢ã€æŠ˜è…¾ï¼Œè‡ªè®¤ä¸ºè¿™æ˜¯æµªè´¹æ—¶é—´çš„å¯ä»¥å»ä¹°ä¸ªMacï¼Œä¸è¿‡è¯´çœŸçš„ï¼ŒMac OS Xçš„GUIå°±æ˜¯ä¸€ä¸ªgnome2çš„çº§åˆ«ï¼Œæ“ä½œæ•ˆç‡æ¸£çš„è¦å‘½ï¼\n psï¼š2022.6æ›´æ–°ï¼Œç°åœ¨macä½¿ç”¨äº†é©¬ä¸Š6å¹´äº†ï¼Œå’Œæˆ‘å½“å¹´ä½¿ç”¨Linuxå‘è¡Œç‰ˆçš„æ—¶é—´å·®ä¸å¤šä¹…äº†ï¼Œè¯´å®è¯macç³»ç»Ÿæ•´ä½“è€Œè¨€æ•´åˆçš„æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯è¦æƒ³ææ•ˆï¼Œè¿˜æ˜¯æœ‰å¾ˆå¤šä¸œè¥¿è¦é…ç½®çš„ï¼Œsee ä½ çš„macæœ‰å“ªäº›è¶æ‰‹çš„å·¥å…·ã€‚\n ç°åœ¨å›å¤´æ¥çœ‹ï¼Œæˆ‘å–œæ¬¢Ubuntu Unityå“ªäº›åœ°æ–¹å‘¢ï¼Œæ²¡æœ‰ç‰¹åˆ«æ¨å´‡çš„åœ°æ–¹ï¼Œå°±æ˜¯ä¸€ç§æ„Ÿè§‰ï¼Œ ä¼˜åŒ–çš„ç¡®å®ä¸é”™äº†ï¼Œæ¯”ä»¥å‰å¼ºå¤šäº†ï¼Œè€Œä¸”æ“ä½œèµ·æ¥ç¡®å®ä¹Ÿæ˜¯å¾ˆæ–¹ä¾¿ã€‚\n kde  è‡ªä»æˆ‘ä½¿ç”¨Fedora 21ä»¥æ¥ï¼Œå°±ä¸€ç›´ä½¿ç”¨kdeä½œä¸ºæ¡Œé¢ç¯å¢ƒï¼Œkde4ç›¸å½“æˆç†Ÿã€ç¨³å®šï¼Œæˆ‘å¾ˆå–œ æ¬¢ï¼Œè€Œä¸”çµæ´»æ€§å¥½ï¼Œå¯ä»¥è¿›è¡Œä¸°å¯Œçš„é…ç½®ï¼Œè¿™ä¸€ç‚¹æˆ‘éå¸¸å–œæ¬¢ï¼Œå¯ä»¥è®©å…¶å˜å¾—ç›¸å½“ç®€çº¦ä¸ ç®€å•ï¼Œä¹Ÿå¯ä»¥è®©å…¶å˜å¾—ç›¸å½“åä¸½è€Œä¼˜é›…ã€‚\nä½†æ˜¯æœ€æ–°çš„Fedoraé‡Œé¢å¢åŠ äº†dnfï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œæˆ‘éå¸¸ä¾èµ–yumï¼Œä½†æ˜¯ç›®å‰dnfè¿˜æ²¡æœ‰å®Œå…¨ å®ç°æŸäº›åŠŸèƒ½ï¼Œè€Œä¸”kde5é‡Œé¢å¾ˆå¤šåœ°æ–¹è¿˜ä¸å®Œå–„ã€‚ä»Šå¹´6æœˆä»½æ‰ä¼šå‡ºFedora 24çš„GAç‰ˆæœ¬ï¼Œ æˆ‘ä¹Ÿç­‰ä¸äº†é‚£ä¹ˆé•¿æ—¶é—´äº†ï¼Œäºæ˜¯æå‰ä½“éªŒäº†ä¸€ä¸‹Alphaç‰ˆæœ¬ï¼Œå‘ç°kde5å¹¶æ²¡æœ‰è¾¾åˆ°æˆ‘å¸Œæœ› çš„ç¨‹åº¦ï¼Œdnfä¹Ÿæ²¡æœ‰å®ç°æˆ‘ä¾èµ–çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘æš‚æ—¶å…ˆæ”¾å¼ƒäº†ä½¿ç”¨Fedora 24çš„å¹´å¤´ï¼Œè½¬è€Œ æŠ•å¥”äº†Ubuntuï¼Œä¹Ÿæ²¡æœ‰ç»§ç»­é‡‡ç”¨kdeæ¡Œé¢ç¯å¢ƒï¼Œè€Œæ˜¯ä½¿ç”¨äº†è‡ªå¸¦çš„unityã€‚\nå…¶å®kde4æ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„æ¡Œé¢ç¯å¢ƒï¼Œç®€çº¦çš„ç•Œé¢ï¼Œä¸°å¯Œçš„å¿«æ·é”®ï¼Œç®€ç›´åŒåˆ°çˆ†ã€‚\n gnome  gnome2æ¯”è¾ƒç®€çº¦ï¼Œå®ç”¨æ€§æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯å¯¹äºè¿½æ±‚é«˜æ•ˆæ“ä½œçš„ç”¨æˆ·æ¥è®²ï¼Œæœªå…åˆæ˜¾å¾—è¿‡äºå¯’ é…¸äº†äº›ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼ŒMac OS Xä¹Ÿå°±æ˜¯ç›¸å½“äºgnome2çš„çº§åˆ«ï¼Œè™½ç„¶è‹¹æœé‡æ–°è®¾è®¡äº†å¾ˆå¤šä¸œè¥¿ï¼Œä½†æ˜¯ä»ç„¶å°±æ˜¯è¿™ä¹ˆä¸ªæ°´å¹³ï¼Œæ“ä½œé¸¡è‚‹ï¼Œéš¾ä»¥æ»¡è¶³æˆ‘çš„éœ€è¦ã€‚\ngnome3æ˜¯æ¯”è¾ƒé«˜çº§äº†ä¸€ç‚¹ï¼Œä½†æ˜¯æœ‰ç‚¹å“—ä¼—å–å® ï¼Œé„™äººä¸å–œæ¬¢ï¼Œè°çˆ±è°ç”¨ï¼Œåæ­£æˆ‘æ˜¯ä¸ç”¨ã€‚å…¶å®gnome3å¾ˆæ—©ä¹‹å‰å°±è¢«æ— æ•°äººå–·è¿‡äº†ï¼Œæ¯”å¦‚Linus Torvaldsã€‚\n psï¼š2022.6æ›´æ–°ï¼Œanywayï¼Œgnome3ç›®å‰ä¼¼ä¹ç§°ä¸ºäº†ä¸»æµæ¡Œé¢ç¯å¢ƒï¼Œç‰¹åˆ«æ˜¯æœåŠ¡å™¨ä¸ºä¸­å¿ƒçš„å‘è¡Œç‰ˆã€‚\n 4.2.11.workspacesã€pagerã€activity #  è™šæ‹Ÿæ¡Œé¢  Ubuntu Unityã€GNOMEé‡Œé¢ä½¿ç”¨çš„æ˜¯workspacesçš„æ¦‚å¿µæ¥è¡¨è¾¾å¤šä¸ªè™šæ‹Ÿæ¡Œé¢çš„æ„æ€ï¼Œåœ¨KDEé‡Œé¢å…¶å®ä¹Ÿæ˜¯ç”¨çš„è¿™ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯å®ƒæä¾›çš„å·¥å…·å´å«pagerï¼Œè¡¨è¾¾çš„æ„æ€æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯è¡¨ç¤ºçš„è™šæ‹Ÿæ¡Œé¢çš„æ„æ€ã€‚\nè™šæ‹Ÿæ¡Œé¢ï¼Œå…¶å®å°±æ˜¯åœ¨ä¸€ä¸ªæ¡Œé¢ä¸Šè™šæ‹Ÿå‡ºå¤šä¸ªæ¡Œé¢ï¼Œä¾‹å¦‚ä¸€ä¸ªç¬”è®°æœ¬å°±åªæœ‰ä¸€ä¸ªå±å¹•ï¼Œåª èƒ½æ˜¾ç¤ºä¸€ä¸ªæ¡Œé¢å•Šï¼Œä½†æ˜¯ç°åœ¨æˆ‘è™šæ‹Ÿå‡º4ä¸ªæ¡Œé¢ï¼Œå¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œåˆ‡æ¢ã€‚ç°åœ¨ä¸»æµæ“ä½œç³» ç»Ÿwindowsã€osxã€linuxä¸­éƒ½æä¾›äº†è™šæ‹Ÿæ¡Œé¢æ”¯æŒã€‚è€Œlinuxä¸­çš„å‡ ä¹æ‰€æœ‰çš„æ¡Œé¢ç¯å¢ƒéƒ½æ”¯ æŒè™šæ‹Ÿæ¡Œé¢ã€‚\n psï¼š2022.6æ›´æ–°ï¼Œwindowsæ˜¯ä»win10å¼€å§‹æ”¯æŒçš„å§ï¼Œå«ä»»åŠ¡è§†å›¾ã€‚osxä¸‹å«æ¡Œé¢1ã€æ¡Œé¢2â€¦â€¦éƒ½æ˜¯ç±»ä¼¼çš„ä¸œè¥¿ã€‚\n è™šæ‹Ÿæ¡Œé¢çš„ä½œç”¨æ˜¯éå¸¸æ˜æ˜¾çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸åŒçš„è™šæ‹Ÿæ¡Œé¢ä¸­åšä¸åŒçš„å·¥ä½œï¼Œè¿™ä½¿å¾—å·¥ä½œ æ›´åŠ äº•äº•æœ‰æ¡ã€æ•ˆç‡æ›´é«˜ã€‚\n æ´»åŠ¨  KDE Plasmaé‡Œé¢ï¼Œæä¾›äº†activityçš„æ¦‚å¿µï¼Œåœ¨åŒä¸€ä¸ªç”¨æˆ·ä¼šè¯ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„ activityï¼Œæ¯”å¦‚éŸ³ä¹activityã€ç¼–ç¨‹activityç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å½“å‰ä¼šè¯ä¸­çš„ä¸åŒactivity ä¸­è¿›è¡Œåˆ‡æ¢ï¼Œä½¿å¾—è‡ªå·±èƒ½å¤Ÿåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚\nactivityçœ‹èµ·æ¥ä¹Ÿæ˜¯éå¸¸æœ‰åº”ç”¨ä»·å€¼çš„ï¼Œä½†æ˜¯æˆ‘ä»»åŠ¡æ¯”è¾ƒæ˜ç¡®ï¼Œå¹¶ä¸”æˆ‘è®¤ä¸ºåœ¨ä¸åŒçš„ä»»åŠ¡ ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œå¹¶ä¸éœ€è¦ä»˜å‡ºè¾ƒå¤šçš„é¢å¤–çš„å·¥ä½œï¼Œæ¯”å¦‚åœ¨æ¸¸æˆã€å·¥ä½œã€å¨±ä¹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ ï¼Œæˆ‘è®¤ä¸ºæ˜¯ä¸€ä¸ªå¾ˆè‡ªç„¶çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘å‡ ä¹ä¸ä½¿ç”¨activityã€‚\n psï¼š2022.6æ›´æ–°ï¼Œactivityå…¶å®æ˜¯åœ¨è™šæ‹Ÿæ¡Œé¢ä¸Šçš„èƒ½åŠ›å‡çº§ï¼Œå®ƒå…è®¸ä½ åœ¨ä¸åŒçš„æ¨¡å¼ä¹‹é—´è¿›è¡Œå¿«é€Ÿåˆ‡æ¢ï¼Œå…¶å®è¿™å°±æ˜¯ä¸€ç§é€šè¿‡è™šæ‹Ÿç¯å¢ƒæ¥å®ç°ä»»åŠ¡éš”ç¦»å¹¶ä¿æŒä¸“æ³¨çš„èƒ½åŠ›ã€‚\nç°åœ¨æ™ºèƒ½æ‰‹æœºä¸­ä¸€èˆ¬ä¹Ÿä¼šæœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œæ¯”å¦‚å·¥ä½œã€å®¶åº­ä¸¤ä¸ªä¸åŒçš„è™šæ‹Ÿç¯å¢ƒï¼Œå½“ç„¶äº†æˆ‘ä»¬ç¡®å®ä¹Ÿå¯ä»¥é€šè¿‡å¤šç”¨æˆ·åˆ‡æ¢çš„æ–¹å¼æ¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœï¼Œä½†æ˜¯activityå¯èƒ½è¦æ›´ä¼˜é›…äº›ï¼Œä½ å¯ä»¥å¤ç”¨è¿™ä¸ªç”¨æˆ·ä¸‹çš„åº”ç”¨ã€æ•°æ®ï¼Œåªæ˜¯åœ¨ä¸åŒçš„é«˜å¼ºåº¦ä»»åŠ¡ä¹‹é—´åšä¸ªéš”ç¦»ï¼Œæ¯”å¦‚ä»å·¥ä½œçŠ¶æ€ä¸€ä¸‹å­åˆ‡åˆ°ä¼‘é—²æ¨¡å¼ï¼Œä¸€é”®æ‰“å¼€éœ€è¦ä¼‘é—²çš„ç¨‹åºä¹‹ç±»çš„ã€‚\nç°åœ¨osxé‡Œé¢æå‡ºäº†ä¸€ç§æ·å¾„çš„è½¯ä»¶ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰ä¸€äº›æ“ä½œï¼Œé€šè¿‡æ·å¾„æ¥åšä¸€äº›æ“ä½œï¼Œä½†æ˜¯åˆè¡·å¯èƒ½ä¸ä¸€æ ·ï¼Œä½†å¯ä»¥æ¨¡æ‹Ÿç›¸åŒçš„åŠŸèƒ½ã€‚\n 4.2.12.è‡ªå®šä¹‰å¿«æ·é”®shortcuts # Ubuntu Unityã€KDE Plasmaä¸­éƒ½æä¾›äº†éå¸¸ä¸°å¯Œçš„å¿«æ·é”®é…ç½®ï¼Œéå¸¸æ£’ï¼å¿«æ·é”®å¯ä»¥æå¤§åœ°æå‡æ“ä½œæ•ˆç‡ã€‚\n4.2.13.tracking mouse # è¿™ä¸ªåº”è¯¥ç®—æ˜¯ä¸€ä¸ªå°å°çš„æŠ€å·§æŠŠï¼Œä¸€èˆ¬åœ¨animation effectä¸­è¿›è¡Œé…ç½®ã€‚æœ‰çš„æ—¶å€™ï¼Œé¼ æ ‡ é¢œè‰²éš¾å…ä¼šéš¾ä»¥ä¸å…¶æ‰€å¤„çš„åŒºåŸŸè¿›è¡ŒåŒºåˆ†ï¼Œç§»åŠ¨ä¸€ä¸‹é¼ æ ‡è¿˜ä¸å®¹æ˜“å‘ç°é¼ æ ‡çš„ä½ç½®ï¼Œæ€ä¹ˆ åŠï¼Ÿå¼€å¯tracking mouseæ•ˆæœä¹‹åï¼ŒæŒ‰ä¸€ä¸‹å¿«æ·é”®ï¼Œå°±å¯ä»¥å‘ç°é¼ æ ‡çš„ä½ç½®äº†ã€‚\n psï¼š2022.6æ›´æ–°ï¼Œosxä¸‹æ‹¼å‘½ç§»åŠ¨é¼ æ ‡æŒ‡é’ˆï¼Œé¼ æ ‡æŒ‡é’ˆä¼šå˜å¤§ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“å‘ç°ã€‚\n 4.2.14.quick tile windows # å¿«é€Ÿåœ°å°†çª—å£ç§»åŠ¨åˆ°æŸä¸€åŒºåŸŸï¼ˆä¸Šä¸‹å·¦å³ä»¥åŠå±å¹•4ä¸ªè§’è½ï¼‰å¹¶ä¸”ä½¿å…¶åœ¨è¯¥èŒƒå›´å†…æœ€å¤§åŒ– ï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¸¸ç”¨çš„ã€æœ‰æ•ˆçš„æ“ä½œã€‚å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éƒ½æ˜¯åŒæ—¶æ‰§è¡Œå¤šé¡¹ä»»åŠ¡ï¼Œå¹¶ä¸”å¸Œæœ›èƒ½å¤Ÿ çœ‹åˆ°å¤šä¸ªä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µï¼Œå› æ­¤ï¼Œè¯¥åŠŸèƒ½å°±éå¸¸æœ‰åº”ç”¨ä»·å€¼äº†ã€‚\nwindowsç¯å¢ƒä¸­ä¸€èˆ¬æœ‰quick tile to left\\rightæ“ä½œï¼ŒUbuntu Unityå’ŒKDEä¸­ä¸€èˆ¬æ”¯æŒä¸Š ä¸‹å·¦å³ä»¥åŠ4ä¸ªè§’è½çš„quick tileæ“ä½œï¼ŒGNOME3ä¸­ä¸æ¸…æ¥šï¼ŒGNOME2ä¸­å€’æ˜¯æœ‰quick tile to left\\rightæ“ä½œã€‚\n psï¼š2022.6æ›´æ–°ï¼Œosxä¸‹è¿™ç‚¹æ²¡æœ‰linuxæ¡Œé¢ç¯å¢ƒæ”¯æŒçš„å¥½ï¼ŒåŸºæœ¬ä¸Šè¦å€ŸåŠ©å·¥å…·æ‰èƒ½è§£å†³ã€‚æˆ‘ç›®å‰æ˜¯ä½¿ç”¨hammerspoon+luaè„šæœ¬çš„æ–¹å¼æ¥å¯¹è¿™äº›åŠŸèƒ½è¿›è¡Œç®¡ç†ã€‚hsçš„å¥½å¤„æ˜¯æä¾›äº†luaçš„æ¥å£ï¼Œå¦‚æœä½ èƒ½çœ‹æ‡‚æ–‡æ¡£ï¼Œæ‡‚ç‚¹å˜æˆï¼Œå°±å¯ä»¥å†™å‡ºè‡ªå·±æƒ³è¦çš„æ¡Œé¢ç®¡ç†è½¯ä»¶æ¥ã€‚æ„Ÿå…´è¶£çš„è¯å¯ä»¥å‚è€ƒæˆ‘å†™çš„ï¼šhttps://github.com/hitzhangjie/conf/tree/master/macOS-hammerspoonã€‚\n 4.2.15.fcitx+sogouè¾“å…¥æ³• # é…ç½®ä¸€ä¸ªå¥½ç”¨çš„è¾“å…¥æ³•æ˜¯è‡³å…³é‡è¦çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦ä¸­è‹±æ–‡æ··è¾“çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤Ÿå¿«é€Ÿåœ°åœ¨ ä¸­è‹±æ–‡ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œå¹¶èƒ½é«˜æ•ˆåœ°è¾“å…¥ä¸­è‹±æ–‡ï¼Œå¯¹äºæé«˜è¾“å…¥æ•ˆç‡ã€æé«˜è¾“å…¥ä½“éªŒéå¸¸é‡ è¦ã€‚\nç›®å‰åœ¨Linuxä¸­ï¼Œæœ€ä¸»è¦çš„è¾“å…¥æ³•æ¡†æ¶ä¸»è¦æ˜¯ç»™äºˆibusæˆ–è€…fcitxï¼Œå…¶ä»–çš„éƒ½ä¸æ˜¯å¾ˆæµè¡Œã€‚ ibusçš„è¯ï¼Œæ·»åŠ ä¸­æ–‡è¾“å…¥æ³•ä¹‹åï¼Œå¯ä»¥å¢åŠ æœç‹—è¾“å…¥æ³•çš„è¯åº“ï¼Œä½†æ˜¯ä¾ç„¶æ¯”è¾ƒé¸¡è‚‹ï¼›æœ€å¥½ çš„åŠæ³•å°±æ˜¯å®‰è£…fcitxï¼Œç„¶åå®‰è£…æœç‹—è¾“å…¥æ³•ã€‚\nåœ¨Ubuntu 12.04 LTSçš„æ—¶å€™ï¼Œç”±äºå®˜æ–¹è½¯ä»¶æºä¸­çš„fcitxç‰ˆæœ¬è¾ƒä½ï¼Œä¸èƒ½æ­£å¸¸å¯åŠ¨æœç‹—è¾“ å…¥æ³•ï¼Œå› æ­¤éœ€è¦æ‰‹åŠ¨æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æºå¯¹fcitxè¿›è¡Œæ›´æ–°ã€‚ç°åœ¨çš„Ubuntu 16.04 LTSä¸­ fcitxå·²ç»è¶³å¤Ÿæ–°äº†ï¼Œç›´æ¥ä»æœç‹—å®˜ç½‘ä¸Šä¸‹è½½debåŒ…è¿›è¡Œå®‰è£…å°±å¯ä»¥äº†ï¼Œæ¯”è¾ƒçœäº‹ã€‚\nå…³äºæœç‹—è¾“å…¥æ³•çš„è®¾ç½®é—®é¢˜ï¼Œæœç‹—è¾“å…¥æ³•æä¾›äº†ä¸“é—¨çš„è®¾ç½®é¢æ¿ï¼Œå¯ä»¥ä¿®æ”¹çš®è‚¤ã€æ¨¡ç³ŠéŸ³ ç­‰ç­‰ï¼Œæé«˜è¾“å…¥ä½“éªŒã€‚å¯¹äºè¾“å…¥æ³•åˆ‡æ¢ctrl+spaceæ¿€æ´»è¾“å…¥æ³•ï¼Œctrl+shiftåœ¨è¾“å…¥æ³•ä¹‹é—´ è¿›è¡Œåˆ‡æ¢ã€‚\nä¸windowsç›¸æ¯”ï¼Œè¿™é‡Œçš„ctrl+shiftåœ¨è¾“å…¥æ³•ä¹‹é—´è¿›è¡Œåˆ‡æ¢æœ‰ç‚¹å·®åˆ«ã€‚åœ¨windowsä¸­æ˜¯åœ¨æ‰€ æœ‰çš„è¾“å…¥æ³•ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œä½†æ˜¯åœ¨fcitxä¸­æ˜¯å°†æ‰€æœ‰çš„è¾“å…¥æ³•åˆ†æˆäº†ä¸¤ç»„ï¼šActive Group å’ŒInactive Groupï¼Œå½“æŒ‰ä¸‹ctrl+shiftä¹‹åï¼Œå®é™…ä¸Šæ˜¯åœ¨å½“å‰groupä¸­è¿›è¡Œåˆ‡æ¢ï¼Œè€Œä¸æ˜¯ åœ¨æ‰€æœ‰çš„è¾“å…¥æ³•ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚å¦‚æœè¦æƒ³åœ¨æ‰€æœ‰çš„è¾“å…¥æ³•ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œéœ€è¦è¿›è¡Œç‰¹åˆ«çš„ è®¾ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‹¾é€‰ä¸Šâ€œinclude inactive input methods when scrollingâ€ã€‚\n psï¼š2022.6æ›´æ–°ï¼ŒæŠ±æ­‰å›¾ç‰‡å¤±æ•ˆäº†ï¼Œå½“åˆæ²¡æ³¨æ„æ˜¯localhostçš„é“¾æ¥ã€‚\n Ubuntu 16.04 LTSé‡Œé¢æœ‰ç‚¹å¥‡è‘©ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œåœ¨.xprofileé‡Œé¢å¢åŠ export GTK_IM_MODULE=fcitxã€export QT_IM_MODULE=fcitxã€export XMODIFIERS=\u0026quot;@im=fcitx\u0026quot; ä¼šå¯¼è‡´fcitxæ— æ³•å¯åŠ¨ã€‚ä»¥å‰åœ¨Ubuntu 12.04 LTSuä»¥åŠFedoraé‡Œé¢éƒ½æ˜¯å¯ä»¥çš„å•Šï¼Œä¸æ™“å¾— è¿™æ¬¡æ˜¯å› ä¸ºä»€ä¹ˆã€‚wppï¼ˆwpsé‡Œé¢çš„æ¼”ç¤ºæ–‡ç¨¿ï¼‰éœ€è¦åœ¨å¯åŠ¨è„šæœ¬/usr/bin/wppä¸­å¢åŠ ä¸Šè¿°ç¯ å¢ƒå˜é‡ï¼Œæ‰èƒ½æ­£å¸¸è¾“å…¥ä¸­æ–‡ã€‚ä¸ç„¶å¯èƒ½è¿è¡Œwppåˆ›å»ºæ–°æ–‡ä»¶çš„æ—¶å€™å¯ä»¥è¾“å…¥ä¸­æ–‡ï¼Œä½†æ˜¯æ‰“ å¼€ä¸€ä¸ªå·²æœ‰çš„pptæ–‡æ¡£æ—¶å°±ä¸èƒ½å¤Ÿæ­£å¸¸è¾“å…¥äº†ã€‚è€Œä¸”æ›´åŠ å¥‡è‘©çš„æ˜¯ï¼Œwppé‡Œé¢å¦‚æœå¯¹æŸä¸€é¡µ æ¼”ç¤ºæ–‡ç¨¿æ·»åŠ äº†å¤‡æ³¨ï¼Œå½“åˆ‡æ¢åˆ°è¿™ä¸€é¡µçš„æ—¶å€™ï¼Œä¼šæ…¢æˆç‹—ã€‚\n psï¼š2022.6æ›´æ–°ï¼Œæ²¡æƒ³åˆ°æœç‹—è¢«è…¾è®¯æ”¶è´­äº†ï¼Œå˜æˆäº†ä¸€å®¶äººï¼Œä¸è¿‡ç°åœ¨åˆè¦è£å‘˜ã€‚\n 4.2.16.software-center vs gnome-software # åœ¨ubuntuä¸Šé¢ï¼Œç°åœ¨æœ‰ä¸¤æ¬¾è½¯ä»¶å®‰è£…å·¥å…·ï¼Œä¸€ä¸ªæ˜¯software-centerï¼Œubuntuä¸“å±çš„ï¼Œå¦ ä¸€ä¸ªæ˜¯gnome-softwareï¼Œè¿™ä¸ªåœ¨è¿è¡Œgnomeç¯å¢ƒçš„ç³»ç»Ÿä¸Šéƒ½å¯ä»¥å®‰è£…ï¼Œæ¯”å¦‚åœ¨fedoraä¸Šä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚\nä½†æ˜¯gnome-softwareç°åœ¨éå¸¸ä¸ç¨³å®šï¼Œå®‰è£…ã€å¸è½½è¿‡ç¨‹ä¸­ç»å¸¸å‡ºé”™ï¼Œè€Œä¸”å¯¹äºä¸€äº›è½¯ä»¶ç»„ ä»¶ï¼ˆä¸æ˜¯ä¸€ä¸ªå¤§å‹çš„ç¨‹åºï¼‰ï¼Œè¿™ç§è½¯ä»¶åŒ…å¾ˆå¯èƒ½åœ¨gnome-softwareå®‰è£…åˆ—è¡¨ä¸­å°±ä¸ä¼šå‡ºç° ã€‚ä½†æ˜¯ubuntu software-centerå°±å¯ä»¥ã€‚æ€ä¹ˆè¯´å‘¢ï¼Œæ„Ÿè§‰gnome-softwareä¸å¦‚ software-centerå®ç”¨ã€å¥å£®ï¼ŒæŠŠdpkgæ•°æ®åº“æå´©æºƒäº†å¯ä¸æ˜¯ä»€ä¹ˆå¥½ç©çš„äº‹æƒ…ã€‚\n psï¼šä½¿ç”¨Linuxçš„ä¸€ä¸ªæœ€å¤§æ„Ÿå—å°±æ˜¯ï¼Œfree softwareçœŸé¦™ï¼Œç»å¤§éƒ¨åˆ†éƒ½æ˜¯å…è´¹çš„ï¼Œæœ€ä¸»è¦çš„è¿˜æ˜¯å¼€æ”¾æºä»£ç ï¼Œä½ å¯ä»¥ä¿®æ”¹å•Šï¼Œä¹Ÿå¯ä»¥å­¦ä¹ ã€‚ç°åœ¨ç”¨äº†macååªèƒ½ä»åº”ç”¨å•†åº—ä¹°ï¼Œæœ‰æ—¶å€™è¿˜è¦æ‰¾ç ´è§£ç‰ˆçš„ã€‚é¼“åŠ±æ”¯æŒæ­£ç‰ˆè½¯ä»¶ï¼Œåªæ˜¯è¯´åœ¨Linuxä¸‹çš„æ—¶å€™çœŸçš„æ„Ÿè§‰å¾ˆè‡ªç”±ã€å¾ˆæ”¾æ¾ã€‚ä»ç¤¾åŒºä¸­æ¥ï¼Œåˆ°ç¤¾åŒºä¸­å»ï¼Œä»ç¤¾åŒºä¸­å­¦ä¹ ï¼Œä¹Ÿå›é¦ˆåˆ°ç¤¾åŒºã€‚ç»™å½“å¹´è‡ªç”±è½¯ä»¶å…ˆé©±ä»¬ä¸ªèµï¼\n 4.2.17.DevHelp # å¯ä»¥æŸ¥çœ‹glibcçš„ç›¸å…³æ‰‹å†Œï¼Œæå¤§å¸®åŠ©è‡ªå·±æ›´åŠ æ·±å…¥åœ°å­¦ä¹ Cè¯­è¨€ç¼–ç¨‹ã€‚æˆ‘ä¸‹é¢å°±è¦å¯¹ glibcä¸­æä¾›çš„ä¸€äº›ç‰¹æ®Šçš„é«˜çº§æ•°æ®ç±»å‹è¿›è¡Œå­¦ä¹ ï¼Œä¾‹å¦‚é“¾è¡¨ã€æ ‘ã€å›¾ã€mapç­‰ç­‰ã€‚glibc å‚è€ƒæ‰‹å†Œå¦‚ä¸‹æ‰€ç¤ºã€‚\n4.2.18.ctagsã€cscope # çœ‹æºä»£ç çš„ï¼Œå½“ç„¶äº†ï¼Œè‡ªå·±å†™ä»£ç çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨çš„åˆ°çš„ã€‚å½’æ ¹ç©¶åº•ï¼Œè¿˜æ˜¯è¦ç»“åˆvimä½¿ç”¨ ï¼Œåœ¨vimé‡Œé¢å¯ä»¥æ ¹æ®ctagsç”Ÿæˆçš„ç´¢å¼•è¿›è¡Œè·³è½¬ï¼Œä¾‹å¦‚è·³è½¬åˆ°å‡½æ•°å®šä¹‰çš„ä½ç½®ï¼ŒæŸ¥çœ‹å®Œæˆ ä¹‹åå†è·³è½¬å›æ¥ã€‚èƒ½å®ç°è¿™ç§åŠŸèƒ½çš„åŸå› æ˜¯ctagsç”Ÿæˆçš„ç´¢å¼•ä¿¡æ¯ï¼Œèƒ½å¤Ÿè¢«vimæ­£ç¡®è§£æï¼Œ vimå†æ‰§è¡Œç›¸åº”çš„è·³è½¬æ“ä½œï¼Œå®ç°jump toå’Œjump backæ“ä½œã€‚å†å°†ä¸Šè¿°è·³è½¬æ“ä½œç»‘å®šåˆ°å…¶ ä»–å¿«æ·é”®ä¾‹å¦‚[[å’Œ]]ä¸Šå°†å¯ä»¥æå¤§åœ°æé«˜ä»£ç é˜…è¯»çš„æ•ˆç‡ã€‚\n psï¼šè¯´å®è¯æ„Ÿè§‰ä¸æ˜¯å¾ˆå¥½ç”¨ã€‚\n 4.2.19.lxr (linux cross reference) # çœ‹æºä»£ç ï¼Œå¼€é˜”çœ¼ç•Œçš„ã€‚lxrä¹Ÿæ˜¯ç»™äºˆctagså»ºç«‹ç´¢å¼•ä¿¡æ¯ï¼Œæ­¤å¤–è¿˜èƒ½å¤Ÿç»™äºˆswish-eæˆ–è€… glimpseè¿›è¡Œå…¨æ–‡æ£€ç´¢ï¼Œå› æ­¤åœ¨é˜…è¯»ä»£ç æ—¶æ£€ç´¢ä¸€ä¸ªå…³é”®è¯ã€å‡½æ•°å®šä¹‰ã€å®å®šä¹‰ç­‰æ–¹é¢æ˜¯ éå¸¸æ–¹ä¾¿çš„ã€‚è€Œä¸”lxræ”¯æŒç‚¹å‡»ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ—¶è·³è½¬åˆ°ç›¸åº”çš„å‡½æ•°å®šä¹‰çš„ä½ç½®ï¼Œç›¸å½“äº jump toçš„åŠŸèƒ½ï¼Œå› ä¸ºlxræ˜¯åŸºäºæµè§ˆå™¨è¿›è¡Œè®¿é—®çš„ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æµè§ˆå™¨çš„å†å²æ‰§è¡Œå›é€€ æ“ä½œï¼Œè¿”å›åˆ°ä¹‹å‰çš„å‡½æ•°è°ƒç”¨é¡µé¢ï¼Œç›¸å½“äºjump backçš„æ“ä½œã€‚\nå› ä¸ºlxræ˜¯åŸºäºæµè§ˆå™¨çš„ã€åªè¯»çš„æºä»£ç é˜…è¯»å·¥å…·ï¼Œå› æ­¤åœ¨é˜…è¯»çš„æ—¶å€™ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…å¯¹ æºä»£ç çš„è¯¯ä¿®æ”¹æ“ä½œï¼Œä½†æ˜¯å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½å¯¹æºä»£ç æ·»åŠ æ³¨é‡Šã€ä¿®æ”¹ç­‰ã€‚\né€‰æ‹©ctagsè¿˜æ˜¯lxrå…³é”®è¿˜æ˜¯çœ‹ä¸ªäººå–œå¥½äº†ï¼Œæˆ‘è§‰å¾—çœ‹å¤§å‹é¡¹ç›®çš„æºä»£ç ï¼Œå¦‚æœåªæ˜¯æœ¬ç€å­¦ ä¹ çš„ç›®çš„è¿›è¡Œä¸€ä¸‹é˜…è¯»çš„è¯ï¼Œé‚£ä¹ˆç”¨lxrå¥½ï¼›å¦‚æœæœ‰ä¿®æ”¹æºä»£ç å¹¶è¿›è¡Œç¼–è¯‘ã€æµ‹è¯•ç­‰å­¦ä¹  ä»»åŠ¡çš„è¯ï¼Œæœ€å¥½ç”¨ctagsã€‚å†æˆ–è€…ï¼Œç›´æ¥ä½¿ç”¨æŸäº›å…¶ä»–çš„IDEä¹Ÿæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚å…³é”®è¿˜æ˜¯ çœ‹ä¸ªäººå–œå¥½ã€‚\n psï¼š2022.6æ›´æ–°ï¼Œè¿™ä¸ªé˜…è¯»å¤§å‹é¡¹ç›®æºç éå¸¸èµï¼Œä¸è¿‡æ·»åŠ æºç æ¯”è¾ƒå•°å—¦ã€‚ç°åœ¨æœ‰äº†æ¯”è¾ƒå¥½çš„æ›¿ä»£å“ï¼Œsourcegraphã€‚ä¹‹å‰å­¦ä¹ java jdkçš„æ—¶å€™ç”¨çš„æ˜¯åœ¨çº¿çš„grepcodeï¼Œå‰å‡ å¹´å€’é—­äº†ã€‚ç°åœ¨æ¯”è¾ƒå¥½çš„å°±æ˜¯sourcegraphäº†ã€‚\n 4.2.20.å…¶ä»– # è‚¯å®šè¿˜æœ‰ä¸€äº›å¾ˆå¥½çš„å·¥å…·ï¼Œä¸èƒ½ä¸€ä¸€åˆ—ä¸¾ï¼Œä¸Šé¢è¿™äº›äº‹ç”¨çš„æ¯”è¾ƒå¤šçš„ã€‚å…ˆåˆ†äº«è¿™äº›æŠŠã€‚\n5.å“ªé‡Œå­¦ä¹ Linux # é¦–å…ˆå¾—ææ˜ç™½è¦å­¦ä¹ linuxå“ªæ–¹é¢ï¼Ÿæ˜¯linuxæ¡Œé¢å‘è¡Œç‰ˆçš„ä½¿ç”¨ï¼Œè¿˜æ˜¯linuxç³»ç»Ÿç®¡ç†ï¼Œè¿˜æ˜¯linuxåº”ç”¨å¼€å‘ï¼Œè¿˜æ˜¯linuxå†…æ ¸å¼€å‘çš„çŸ¥è¯†â€¦â€¦å¹¸å¥½ï¼Œæœ‰å¾ˆå¤šçš„ç¤¾åŒºé‚®ä»¶ç»„ã€è®¨è®ºç»„ã€é—®ç­”ç¤¾åŒºå¯ä¾›æˆ‘ä»¬å­¦ä¹ ã€‚\nStackExchange \u0026amp; CodeProject \u0026amp; Sourceforgeï¼Œæ˜¯æå¥½åœ°å­¦ä¹ è®¡ç®—æœºæŠ€æœ¯çš„åœ°æ–¹ï¼Œç‰¹åˆ«æ˜¯è¿™ä¸ªStackExchangeï¼Œå®ƒçœŸçš„æ˜¯åŒ…ç½—ä¸‡è±¡ï¼Œè€Œä¸”é‡Œé¢çš„ç®¡ç†å‘˜å¾ˆæœ‰æ°´å¹³ï¼Œå½“ä½ çš„é—®é¢˜æè¿°ä¸æ˜¯å¾ˆå‡†ç¡®æ—¶ï¼Œä»–ä»¬è¿˜ä¼šå¸®ä½ æ¶¦è‰²ã€‚é€šå¸¸åœ¨ä¸Šé¢éƒ½èƒ½å¾—åˆ°å¤§ä½¬ä»¬çš„è¿…é€Ÿä¸”æœ‰æ•ˆåœ°è§£ç­”ã€‚æˆ‘è‡ªå·±æ˜¯ä»ä¸­å—ç›ŠåŒªæµ…ã€‚\nå­¦ä¹ å¼€å‘çš„è¯ï¼Œc/c++ primerã€glibcå­¦ä¹ ï¼ˆå¸¸ç”¨æ•°æ®ç»“æ„ç­‰æ”¯æŒå¾ˆå¥½ï¼‰ã€gtk/qt/gnomeå¼€å‘ï¼ˆå›¾å½¢ç•Œé¢ï¼‰ã€makeã€cmakeçš„ä½¿ç”¨ï¼ˆé¡¹ç›®æ„å»ºï¼‰ç­‰ç­‰ã€‚\nåœ¨Linuxä¸‹é¢æ„Ÿè§‰åšä»€ä¹ˆéƒ½ç®€å•ï¼Œä½ æƒ³æƒ³å•Šï¼Œå…¨ä¸–ç•Œé‚£ä¹ˆå¤šæœåŠ¡å™¨éƒ½æ˜¯è·‘åœ¨Linuxä¸Šçš„ï¼ŒåŸºäºLinuxçš„å¼€å‘åŒ…ã€ç»éªŒåˆ†äº«è‚¯å®šå¤šå¦‚ç‰›æ¯›ï¼Œå°±æ˜¯ä¸€ä¸ªå­—çˆ½ã€‚\n"}),a.add({id:58,href:"/tags/ubuntu/",title:"ubuntu",description:"",content:""}),a.add({id:59,href:"/tags/emacs/",title:"emacs",description:"",content:""}),a.add({id:60,href:"/tags/vim/",title:"vim",description:"",content:""}),a.add({id:61,href:"/blog/2016-01-07-vim%E8%BF%9B%E9%98%B6%E7%AE%80%E6%98%93%E6%89%8B%E5%86%8C/",title:"vimä½¿ç”¨è¿›é˜¶å¸¸ç”¨æ“ä½œ",description:"ä»å¼€å§‹æ¥è§¦Linuxå¼€å§‹å°±å¼€å§‹æ¥è§¦vimï¼Œä»åˆšå¼€å§‹åœ°æŠµè§¦åˆ°ç°åœ¨éƒ½ç¦»ä¸å¼€ï¼ˆè¿™ç¯‡æ–‡ç« å†™åœ¨2016å¹´1æœˆï¼Œå®é™…ä¸Šè¡¥å……åˆ°åšå®¢æ˜¯åœ¨2022å¹´6æœˆï¼‰ï¼Œ10å¹´è€ç”¨æˆ·å‘ç°æ—¥å¸¸çš„æµè§ˆå™¨ã€IDEç¼–è¾‘å™¨ç­‰ç­‰éƒ½æ”¹æˆäº†vimæ“ä½œé£æ ¼ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿvimçš„ç®€çº¦ä¸ç®€å•çš„è®¾è®¡è®©å®ƒæˆä¸ºç¼–è¾‘å™¨ä¹‹ç¥ï¼Œä¸€ç‚¹éƒ½ä¸ä¸ºè¿‡ï¼Œè¿™é‡Œä»…ç½—åˆ—äº›ä¸€äº›å¸¸è§çš„æ“ä½œå§ï¼Œå…¶å®è¿˜æœ‰äº›å¸¸ç”¨åŠŸèƒ½ï¼Œåç»­é™†ç»­è¡¥å……æˆ–è€…å†™ä¸€ä¸ªvimç³»åˆ—ï¼Œä»¥å…ä¸€ç¯‡ä¸‡å­—é•¿æ–‡æŠŠvimæ–°æ‰‹å“åˆ°ã€‚ä¸å¹ä¸é»‘ï¼Œä½œä¸ºç¼–è¾‘å™¨vimç¡®å®æœ‰å®ƒçš„è¿‡äººä¹‹å¤„ã€‚",content:"vimä½¿ç”¨è¿›é˜¶å¸¸ç”¨æ“ä½œ # æ–‡ä»¶æ‰“å¼€é€€å‡º #   open and edit files has several modes as following:\n vim filename: open this file vim +n filename: open file and position cursor at line n, `n is a number vim + filename: open this file and position your cursor at last line vim +/pattern filename: open file and position at the first match of pattern vim -r filename: open file and recover from swapfile, swapfile on big RAM is unnecessary, so we can disabled it vim -R filename: open file in mode read-only    providing you have edited the file,if you press:\n :q: to exit and you\u0026rsquo;ll be warned because you have edited file :q!: force to quit and won\u0026rsquo;t get warning message :w: to store the current modification into current file :wq: to store current modification into current file and quit :w fname: store current buffer content into another file fname,save as :ZZ: store current modification and quit    :{n}cq[!] : quit and returns an errcode n, default value of n is 1. you\u0026rsquo;ll need this when you want to abort a git rebase operation :)\n  å†…å®¹æ’å…¥å†…å®¹ #  insert modes,if you press:  i:	insert at current position I:	insert at the beginning of current line a:	append after current position A: append at the end of line o:	insert a new line below current line O:	insert a new line above current line    åœ¨æ–‡ä»¶ä¸­ç§»åŠ¨ #   move your cursor in vim:\n j:	to next line k:	to previous line l:	to right h:	to left    go to specified line:\n \u0026lsquo;line number\u0026rsquo;+\u0026lsquo;G\u0026rsquo;    to the beginning of previous line\n shift +: to the beginning of next line 0:	to the beginning of current line $:	to the end of current line w:	to the beginning of next word,use \u0026lsquo;biaodianfuhao\u0026rsquo; as delimiter W:	like \u0026lsquo;w\u0026rsquo;, but use space as delimiter b:	to the beginning of previous word, \u0026lsquo;biaodianfuhao\u0026rsquo; as delimiter B: to the beginning of previous word, use space as delimiter e:	to the end of next word,\u0026lsquo;biaodianfuhao\u0026rsquo; E:	to the end of next word,space (:	to the beginning of current paragraph ):	to the end of current paragraph {:	to the beginning of previous paragraph }: to the end of next paragraph H:	to the beginning of current screen,not the file M:	to the middle of current screen,not the file L:	to the end of current screen,not the file G:	to the end of file gg:	to the beginning of file    move current line to top/center/bottom\n   z+enter: move current line to top of window z-: move current line to bottom of window zz: move current line to center of window  å†…å®¹åˆ é™¤æ“ä½œ #  delete content in vim:   x	:	delete character of current position X	:	delete left character of current position d1	:	like \u0026lsquo;x\u0026rsquo; d0	:	delete characters from the beginning of line to current position d$	:	delete characters from current position to end of line D	:	like \u0026rsquo;d$' d^	:	like \u0026lsquo;d0\u0026rsquo; but characters to delete doesn\u0026rsquo;t include space and tab dw	:	delete chars from current pos to end of word d5w	:	delete chars from current pos to end of next 5 words dtc	:	delete chars from current pos to next \u0026lsquo;c\u0026rsquo; (\u0026lsquo;c\u0026rsquo; not included) dfc	: delete chars from current pos to next \u0026lsquo;c\u0026rsquo; (\u0026lsquo;c\u0026rsquo; included) d/word	:	delete chars from current pos to the first match of \u0026lsquo;word\u0026rsquo; d3{	:	delete from previous 3 paragraphs to current pos d{	:	delete from beginning of current paragraph to current pos db	:	delete from beginning of current to current pos dW	:	delete from current pos to end of word,use \u0026lsquo;space\u0026rsquo; as delimiter dB	:	delete from beginning of current word to current pos,\u0026lsquo;space\u0026rsquo; d5B	:	from previous 5 words to current pos d)	:	from current pos to the end of current line d4)	:	from current pos to the end of next 5 lines d}	:	from current pos to the end of current paragraph d4}	:	from current pos to the end of next 4 paragraphs dd	: delete current line 3dd	:	delete 3 lines from current line dL	: delete from current pos to end of current screen dH	:	delete from beginning of current screen to current pos  è¯»å†™å¤–éƒ¨æ–‡ä»¶ #   read file\u0026rsquo;s content into buffer: :[address] r [filename] read content of \u0026lsquo;filename\u0026rsquo;,then insert the content into the \u0026lsquo;address\u0026rsquo; position of buffer. if address is 0,then insert content into the beginning of buffer. if address is 100,then insert content after line number 100. if address is default,then insert content after current cursor position.\n  write buffer content into file on disk :[address] w [!] [filename] because it is rarely used,we neglect it.we usually use command \u0026lsquo;w\u0026rsquo; to store.\n  æ–‡ä»¶å†…å®¹æœç´¢ #   search string /pattern : press / then input the pattern to search\n  search string1 and substitute by string2 :[g] [address] s /searchString/substitueString [/option] usually,we use the command as following format: %s /string1/string2/g\nhere is an example:\n%s /string1/string2 /g || | | | ab c d e  a: we can search string1 in all lines in current buffer b: substitue commmand c: the string we want to search d: use string2 to replace string1 e: /g allows us to substitue every match in the same line.if we neglected \u0026lsquo;/g\u0026rsquo; option,and if multiple matches of string1 occurs,we can only substitue the first match.\n  advanced search and substitute by regexp\nProviding there\u0026rsquo;re many strings monitor_\u0026ldquo;desc\u0026rdquo; in code, we want to replace it with cmd_\u0026ldquo;desc\u0026rdquo;_succï¼Œin which the string $desc is composed of characters like abcâ€¦â€¦xyz. So how to do that? In vim command mode, we can press: :%s/monitor_\\([a-z]\\{1,}\\)/cmd_\\1_succã€‚Here [a-z]{1,+} is used to match $descï¼Œthe outerscope () is used to capture the first matched group, ï¼ˆnotice we do some escaping by \\{1,+}ï¼‰ï¼Œthe group \\1 will let us reuse the first captured group (that is $desc) . In vim, the captured group number is numbered by the order ( appearsã€‚ If you think the escape logic is complex, then we can use vim magic or very magic search mode, set magic, then we can use :%s/\\v/monitor_([a-z]{1,})/cmd_\\1_succ instead. Please refer to help magic to read more.\n  åˆ†å±åˆ‡æ¢æ“ä½œ #   split the vim window:\n horizontally split, :split or :split filename vertically split, :vsplit or :vsplit filename    change window focus in vim: ctrl+w+w\n  â€‹	we can also use shortcuts to change focus but it\u0026rsquo;s inconvenient,so neglect it.\nâ€‹	but we can define key maps to use ctrl+hjkl to move between vim buffers.\nclose windows in vim: providing there\u0026rsquo;re several windows splitted existing:  :q :	to close current window :qall	:	to close all windows :only	: to close the other windows    æ‰§è¡Œshellæ“ä½œ #   start a shell in vim: :sh this is the first method to execute shell commands in vim. after you start a shell and execute all commands,you can press \u0026lsquo;exit\u0026rsquo; to quit and go back to vim.\n  execute shell cmd this is another method to execute shell commands. by this method,you can execute only one shell command.\n  â€‹	suggest we use the first method.\n execute shell cmd and insert the result into buffer\n  :.!command if we\u0026rsquo;re in last line mode,we can use \u0026lsquo;.!command\u0026rsquo; instead of \u0026lsquo;!command\u0026rsquo;,like \u0026lsquo;.!ls -al\u0026rsquo;.\n  :!!command if we\u0026rsquo;re in command mode,we can use \u0026lsquo;!!command\u0026rsquo; instead of \u0026lsquo;command\u0026rsquo;. please note,when we type \u0026lsquo;!!command\u0026rsquo;, actually it is \u0026lsquo;.!command\u0026rsquo;.\n    æ ‡è®°è·³è½¬æ“ä½œ #   marks\n ma : create a mark \u0026lsquo;a\u0026rsquo; at current position \u0026lsquo;a : jump to mark \u0026lsquo;a\u0026rsquo; mb : create a mark \u0026lsquo;b\u0026rsquo; at current position \u0026lsquo;b : jump to mark \u0026lsquo;b\u0026rsquo; ma : following mark created with the same name will override the ones create before    è§†å›¾ç±»æ“ä½œ #  mkview/loadview we can create a view for current session, like we can fold/unfold some codes, the state will be saved in the view, which is saved under ~/.vim/views/. even we save/quit, later we reopen the same file, the view created before will be loaded automatically. It\u0026rsquo;s convienient if you\u0026rsquo;re writing some code specially the project is big.  tagsæœç´¢è·³è½¬ #   ctags/etags we can generate tags for your file content, no matter it is normal text file or source code, it just generate tags for your files, then we can search by tags to quickly find the position where it is defined, then we can jump there.\nwhen generating tags, we need install binary tool like ctags/etags, run ctags -R . is OK for most cases, it will generate tags in your current folder for all files recursively.\n  tags search\nby default, it will search tags file under current directory or the same directory which your editing file resides. sometimes we want vim to search other directories, for example, we write linux programs and we need some linux system headers, we want to jump to the system headers by looking up the tags.\nthen we need to generate tags file for system headers, and we should let vim to search through it. we should add the path to that tags file into vim tags search paths.\nset tags=./tags;tags/;~ï¼Œit first find tags file in the same directory which the editing file resides, if not found, then it keep searching in current working directory; if not found it searched the user homedir. if still not found, it stopped.\nwe can add system headers path into the search paths.\nPlease read more abount vim tags by :help tags.\nå…¶ä»– #   you can read my .vimrc to learn more about vim settings:\n  plugins\n plugin manager like vundle autocomplete minibuffers guidelines code snippets syntastic file tree comments vim editor statusbar, like vim-airline vim markdown renderer, like vim-instant-markdown vim markdown toc generator file encoding fix    encoding\n encoding/fileencoding/termencoding    backspace/delete\n  line wrapping\n  autoread file when file outer changed\n  key mappings\n  highlight search, cursorline, cursorcolumn, foreground, background\n  autowrap for specified types\n  split window and move btw them\n  syntax highlight\n  colors theme\n  format paragraph\n  tab and spaces\n  fold and unfold, autofold text block\n  insert text effiently, like time, heading, horziontal\n  create helpfile and generate tags for them, jump btw files by tags\n  settings for coding, like vim-go, etc\n  etc.\n  æ€»ç»“ # vimè¢«ITç•Œèµèª‰ä¸ºç¼–è¾‘å™¨ä¹‹ç¥ï¼Œä¸emacsè¿™ä¸ªè¢«ç§°ä¸ºç¥ä¹‹ç¼–è¾‘å™¨çš„éƒ½æœ‰å¾ˆå¤šæ”¯æŒè€…ã€‚\næˆ‘æ˜¯vimçš„æ”¯æŒè€…ï¼Œæˆ‘å–œæ¬¢èƒ½ç”¨ä¸€ä¸ªæŒ‰é”®æå®šçš„å°±ä¸ç”¨åŒæ—¶æŒ‰ç»„åˆé”®ã€‚æœ‰äººä¼šè´¨ç–‘ï¼Œè¿™ä¹ˆå¤šçš„æŒ‰é”®ä½ è®°å¾—ä½å—ï¼Ÿä¸æ˜¯åœ¨è£…xå§ï¼Ÿ\nçœŸä¸æ˜¯ï¼Œvimä¼˜ç§€çš„åœ°æ–¹ï¼Œä¸€ä¸ªæ˜¯å¥‰è¡Œæç®€ä¸»ä¹‰ï¼Œè¿™ä¸ªå¾ˆç¬¦åˆæˆ‘çš„ä¹ æƒ¯æˆ–è€…è¯´æ€§æ ¼ï¼›å†å°±æ˜¯å®ƒæœ‰éå¸¸å¼ºå¤§çš„å®šåˆ¶åŠŸèƒ½ï¼Œä½ å¯ä»¥æŠŠè‡ªå·±æƒ³è¦çš„é…ç½®ä»¥dotfilesçš„å½¢å¼ç»´æŠ¤èµ·æ¥ï¼Œå°±åƒæˆ‘ä¸€æ ·ï¼Œæ¢ä¸ªåœ°æ–¹æ¢ä¸ªæœºå™¨æŠŠé…ç½®æ‹–ä¸‹æ¥ï¼Œå°±å¯ä»¥ç”¨èµ·æ¥ã€‚\nå‰æœŸè™½ç„¶å­¦ä¹ æˆæœ¬é«˜ï¼Œä¸€æ—¦ä¸Šæ‰‹å¾ˆå®¹æ˜“çˆ±ä¸é‡Šæ‰‹ï¼Œèåœé’èœå„æœ‰æ‰€çˆ± :) å½“æ—¶æ˜¯æ€ä¹ˆå†³å®šè¦ä¿®ç‚¼vimçš„å‘¢ï¼Ÿæ˜¯ä¸ºäº†è£…xçœ‹èƒ½ä¸èƒ½åœ¨å®Œå…¨è„±ç¦»é¼ æ ‡çš„æƒ…å†µä¸‹å¯¹è®¡ç®—æœºè¿›è¡Œå„ç§æ“ä½œï¼Œæ¯”å¦‚é€šè¿‡å‘½ä»¤ã€é…ç½®ç­‰ç­‰ï¼Œè™½ç„¶åˆè¡·ä¸çº¯ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯ä¸Šè½¦äº† :)\n"}),a.add({id:62,href:"/blog/2022-05-08-%E5%86%99%E5%9C%A8%E6%AF%8D%E4%BA%B2%E8%8A%82/",title:"å†™åœ¨2022.5.8æ¯äº²èŠ‚ï¼šæ— é¢˜",description:"ä»Šå¤©æ˜¯æ¯äº²èŠ‚ï¼Œåœ¨è¿™ä¸ªç‰¹æ®Šçš„æ—¥å­ï¼Œé»˜é»˜åœ°å†™ç‚¹ä¸œè¥¿è¡¨è¾¾ä¸‹å¯¹å¦ˆå¦ˆã€è€å©†çš„æ„Ÿè°¢ï¼Œå†™ç€å†™ç€å°±è·‘åäº†ï¼Œéƒ½æ„Ÿè°¢ä¸‹å§ï¼Œå¸Œæœ›ä»Šå¹´ä¸€åˆ‡é¡ºåˆ©ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  å†™åœ¨å‰é¢\nè¿‡å»å¾ˆå¤šä¸ªæ—¶é—´èŠ‚ç‚¹ï¼Œæœ¬æ¥åº”è¯¥å†™ä¸‹ç‚¹ä»€ä¹ˆï¼Œå¥½è®©å®ƒæ˜¾å¾—æ›´ä¸°æ»¡äº›ã€æœ‰ä»ªå¼æ„Ÿäº›ï¼Œæ˜¾å¾—è‡ªå·±æ²¡æœ‰è™šåº¦è¿™æ®µæ—¶å…‰ã€‚è¿™æ ·é‚£æ ·çš„åŸå› ï¼Œä¸€æ¬¡æ¬¡ä½œç½¢ã€‚ä»Šå¤©æœ‰ç‚¹æ‰‹æŒ‡é…¸ç–¼ï¼Œä¹Ÿä¸æ˜¯å¾ˆæƒ³å»å†™çš„ï¼Œä½†æˆ‘æ‹…å¿ƒé”™è¿‡è¿™ä¸ªç‰¹æ®Šçš„æ—¥å­ï¼Œä»¥åæ‰¾ä¸åˆ°è¿™æ ·çš„å¥½æ—¶æœºæ¥å€¾è¯‰è¿™äº›æ²‰ç§¯å¾ˆä¹…çš„æƒ³æ³•ï¼Œæ‰€ä»¥è¿˜æ˜¯çŸ«æƒ…ä¸€å›å§ã€‚\nç«Ÿä¹Ÿç”¨ä¸Šäº†â€œæ— é¢˜â€åšé¢˜ç›®ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¤šé‡è§’è‰²çš„å˜åŒ–ï¼Œè¦ç»•åœ¨å¿ƒå¤´çš„æ€ç»ªæ›´å¤šäº†äº›ã€å¤æ‚äº†äº›å§ï¼Œä¸è¿‡æœ¬æ–‡ä¹Ÿç¡®å®æ²¡é¢„è®¾ä¸»é¢˜ã€‚\næ„Ÿæ©è€å©†ï¼šä½ çš„ç¬¬ä¸€ä¸ªæ¯äº²èŠ‚\nå¯¹å†œå†æˆ‘æ€»æ˜¯æä¸æ¸…æ¥šï¼Œå³ä¾¿å¶å°”å‘ç°ä¸ªç‰¹æ®Šçš„èŠ‚æ°”ã€èŠ‚æ—¥ä¹Ÿæ˜¯æ— æ„ä¸­å¬è¯´ï¼Œç”±äºä»å°è¿‡ç”Ÿæ—¥éƒ½æ˜¯æŒ‰ç…§å†œå†ï¼Œæ‰€ä»¥æˆ‘çš„ç”Ÿæ—¥ä¹ŸåŸºæœ¬æ˜¯çˆ¶æ¯ã€å§¨å¦ˆã€å§¥å§¥ä»–ä»¬æåŠçš„æ—¶å€™æˆ‘æ‰ä¼šçŸ¥é“ï¼Œå“¦ï¼Œç”Ÿæ—¥é‚£å¤©å¯ä»¥åŠ é¤æ„æ€ä¸‹ã€‚\nä¹Ÿç»å¸¸æœ‰è¿™æ ·çš„æ–‡ç« ï¼Œå­©å­ç”Ÿæ—¥é‚£å¤©ï¼Œå´ä¹Ÿæ˜¯æ¯äº²æœ€ç—›çš„é‚£å¤©ï¼Œå­©å­ä¹Ÿåº”è¯¥åœ¨ç”Ÿæ—¥é‚£å¤©è¡¨è¾¾ä¸‹å¯¹æ¯äº²çš„æ„Ÿæ©ã€‚ä¹Ÿæ˜ç™½è¿™ä¸ªé“ç†ï¼Œä½†æ˜¯å´æ²¡æ³•æ„ŸåŒèº«å—ã€‚\nå®è´é—ºå¥³å‡ºç”Ÿï¼Œæˆ‘ä»æ·±åœ³èµ¶åˆ°æ­¦æ±‰åï¼Œåªèƒ½åœ¨äº§æˆ¿å¤–ç­‰å¾…ï¼Œæ²¡èƒ½é™ªä¼´åœ¨è€å©†æ—è¾¹ï¼Œä¹Ÿæ²¡æ„Ÿå—åˆ°å¥¹æœ‰å¤šæ’•å¿ƒè£‚è‚ºçš„ç–¼ç—›ï¼Œå½“æˆ‘æ€€æ£ç€æƒŠå–œå»çœ‹å¥¹å¨˜ä¿©æ—¶ï¼Œçœ‹åˆ°è€å©†è„¸è‰²é‚£ä¹ˆæ†”æ‚´ï¼ŒåŠ ä¸Šæ™šä¸Šé™ªåºŠæ—¶ä¸´è¿‘äº§æˆ¿çš„å¹´è½»å¦ˆå¦ˆç–¼çš„ç›´å–Šï¼Œæˆ‘ä¹Ÿçœ‹åˆ°äº†åŒ»æŠ¤æ¸…ç†å‡ºæ¥çš„èƒç›˜â€¦â€¦ä¸€ä¸‹å­å†…å¿ƒæªäº†ä¸€ä¸‹ï¼Œç”Ÿä¸ªå¨ƒåšæ¯äº²çš„çœŸçš„å¤ªä¸å®¹æ˜“äº†ã€‚\nè”æƒ³åˆ°è€å©†äº§å‰ä»ä½“å‹å¾®èƒ–åˆ°é•¿ä¸ªå¤§è‚šå­è¡ŒåŠ¨ä¸ä¾¿ï¼Œäº§åçš„å„ç§æ¢å¤ï¼Œå¸¦å¨ƒçš„è¾›è‹¦ï¼Œåœ¨æˆ‘è¿™ä¸ªâ€œå¥‹æ–—Bâ€åœ¨æ·±åœ³å‡ ä¹ç¼ºå¸­äº†ä¸€åˆ‡ç›¸å…³äº‹é¡¹çš„æƒ…å†µä¸‹ï¼Œè€å©†å‡ ä¹è‡ªå·±ä¸€ä¸ªäººæ‰›ä¸‹äº†æ‰€æœ‰åŠ³ç´¯å’Œå§”å±ˆã€‚\næ„Ÿè°¢è€å©†ï¼Œé€ç»™æˆ‘ä¸€ä¸ªå°å¤©ä½¿ï¼Œæ„Ÿè°¢è€å©†çš„è¾›è‹¦ä»˜å‡ºï¼Œä»Šå¤©ä¹Ÿæ˜¯ä½ çš„ç¬¬ä¸€ä¸ªèŠ‚æ—¥ã€‚è™½ç„¶å°å®è´è¿˜ä¸ä¼šå«å¦ˆå¦ˆï¼Œä½†ç°åœ¨å·²ç»çŸ¥é“äº†å»æ‰¾å¦ˆå¦ˆï¼Œä»¥åå¥¹ä¹Ÿä¼šæ…¢æ…¢å˜æˆä½ çš„è·Ÿå±è™«ï¼Œæ¯äº²èŠ‚ä¹Ÿä¼šç»™ä½ é€æ¥æŸåº·ä¹ƒé¦¨ï¼Œå°±å…ˆæ†§æ†¬ä¸‹å§ã€‚\næ„Ÿæ©æ¯äº²ï¼šä»Šå¤©æ‰ä½“ä¼šåˆ°é‚£ä»½ä¸æ˜“\nå¦‚æœæ²¡æœ‰äº²è‡ªçœ‹åˆ°è€å©†ç»å†çš„é‚£äº›ä¸æ˜“ï¼Œæˆ‘å¯èƒ½æ°¸è¿œä¹Ÿä¸ä¼šæ„Ÿå—åˆ°åšæ¯äº²çš„é‚£ä»½ä¸æ˜“ï¼Œè€Œä¸”æ˜¯åœ¨30å¹´å‰é‚£æ ·çš„ç”Ÿæ´»ã€åŒ»ç–—æ¡ä»¶ä¸‹ã€‚\nä»æˆ‘è®°äº‹èµ·ï¼Œå¦ˆå¦ˆå°±æ˜¯æˆ‘å¿ƒçµçš„æ¸¯æ¹¾ï¼Œçœåƒä¿­ç”¨ï¼Œç»™æˆ‘åšå¥½åƒçš„ï¼Œç»™æˆ‘åšè¡£æœï¼Œåšé‹å­ï¼Œæ•™æˆ‘è¯†æ‹¼éŸ³ã€å†™å­—ã€ç®—æœ¯ï¼Œåˆšå»ä¸Šå­¦æ—¶è¯¥ä¼šçš„ä¹Ÿéƒ½ä¼šå·®ä¸å¤šäº†ã€‚é‚£æ—¶å€™ï¼Œå®¶é‡Œæ¡ä»¶ä¹Ÿä¸å¥½ï¼Œçˆ¸çˆ¸å¦ˆå¦ˆè¾›è¾›è‹¦è‹¦åœ°åŠ³åŠ¨ï¼Œå®¶é‡Œå†éš¾çš„æ—¶å€™ï¼Œä¹Ÿä¸è®©æˆ‘å› æ­¤è€Œå—ä¼¤åˆ†æ¯«ã€‚\nå¿µäº†é‚£ä¹ˆå¤šå¹´ä¹¦ï¼Œç»ˆäºæ¯•ä¸šäº†ï¼Œæˆ‘æ€¥ä¸å¯è€åœ°è¦å»è¯•è¯•ï¼Œå¯æ˜¯çˆ¸çˆ¸å´å…ˆèµ°äº†ï¼Œé‚£æ®µæ—¶é—´è™½ç„¶å¦ˆå¦ˆå’Œæˆ‘æ¥äº†æ·±åœ³ï¼Œä½†æ˜¯æˆ‘èƒ½æ„Ÿå—åˆ°ï¼Œå¥¹å¾ˆå‹æŠ‘ï¼Œæ—©å‡ºæ™šå½’çš„å„¿å­ã€ä¸ç†Ÿæ‚‰çš„ç¯å¢ƒã€ä¸ç†Ÿæ‚‰çš„ç½‘ç»œè´­ç‰©ã€ä¸ç†Ÿæ‚‰çš„åŒ»é™¢å°±è¯Šæµç¨‹ï¼Œç­‰ç­‰ã€‚æˆ‘å¼€å§‹æƒ³ï¼Œæœ‰å¯èƒ½å¦ˆå¦ˆæ˜¯ä¸ºäº†ç»´æŠ¤å„¿å­åœ¨ä»–äººçœ¼ä¸­çš„å­å¿ƒé€‰æ‹©æ€§åœ°æ”¾å¼ƒäº†ç†Ÿæ‚‰çš„å®¶ã€äººã€ç¯å¢ƒï¼Œéš¾ä¸ºå¦ˆå¦ˆäº†ã€‚\nè€å©†æ€€å­•åï¼Œå¦ˆå¦ˆä¹Ÿå°½å·±æ‰€èƒ½èµ¶æ¥ç…§é¡¾ï¼Œäººç”Ÿåœ°ä¸ç†Ÿçš„æ­¦æ±‰ï¼Œæˆ‘ä¹Ÿæ‹…å¿ƒè¿™å©†åª³çŸ›ç›¾ä¼šä¸ä¼šä¹Ÿè®©æˆ‘æŸæ‰‹æ— ç­–ï¼Œä¸è¿‡å¦ˆå¦ˆå’Œè€å©†éƒ½æ˜¯é€šæƒ…è¾¾ç†ä¹‹äººï¼Œä¹Ÿæ²¡å‡ºç°è¿‡çŸ›ç›¾ï¼ŒçœŸçš„å¾ˆè®©äººæ¬£æ…°ï¼Œä½†è¿™èƒŒåå¥¹ä»¬ä¹Ÿå„è‡ªç‰ºç‰²äº†å¾ˆå¤šã€‚\næ¯äº²èŠ‚å¿«ä¹ï¼Œå†è¿‡äº›å¤©ï¼Œä½ ä¹Ÿä¼šå¤šä¸ªè·Ÿå±è™«ï¼Œè¢«å–Šâ€œå¥¶å¥¶â€ä¹Ÿå¾ˆå¼€å¿ƒå§ã€‚\næ„Ÿè°¢è­¦å¯Ÿï¼šå¯¹æˆ‘çš„æ‰¹è¯„æ•™è‚²\nçˆ¸çˆ¸åˆšèµ°é‚£ä¸€ä¸¤å¹´ï¼Œæˆ‘å¸¸è§‰å¾—è¿™ä¸ªæ²¡æœ‰ä»–çš„ä¸–ç•Œå‡ ä¹ä¸å¯æ¥å—ã€‚çˆ¸çˆ¸èº«ä¸Šé‚£ç§æ­£ç›´ã€åšæ¯…ã€è±è¾¾çš„å“è´¨ï¼Œåœ¨å®¶æ—ä¸­ä¹Ÿæ¯”è¾ƒå—é•¿è¾ˆåŒè¾ˆå°è¾ˆçš„ä¿¡ä»»ã€‚æˆ‘è™½æœ¬æ€§ä¸åï¼Œä½†æ˜¯åšçš„å°±æ²¡çˆ¸çˆ¸å¥½ï¼ŒåŸæœ¬æ‰“ç®—å¤šè·Ÿçˆ¸çˆ¸èŠèŠï¼Œè®©è‡ªå·±åšçš„æ›´å¥½ã€‚å¯è°èƒ½æƒ³åˆ°ï¼Œæˆ‘çš„è‰¯å¸ˆç›Šå‹å°±è¿™ä¹ˆèµ°äº†ã€‚\né‚£æ®µæ—¶é—´çœ¼é‡Œå®¹ä¸å¾—æ²™å­äº†ï¼Œå‡ ä¹è‡ªæˆ‘å°é—­äº†å’Œå…¶ä»–äººçš„æ¥è§¦å’Œäº¤æµã€‚å·¥ä½œä¸Šä¹Ÿå› æ­¤æˆ–å¤šæˆ–å°‘é‡åˆ°äº›ä¸å¿«ï¼Œè¿™æ®µæ—¶é—´ä¹Ÿæ²¡å°‘å’Œè€å©†ã€å¦ˆå¦ˆæŠ±æ€¨ã€‚\næœ‰æ®µæ—¶é—´æˆ‘ä¹Ÿç»å¸¸çœ‹äº›â€œé’ˆç ­æ—¶å¼Šâ€çš„å†…å®¹ï¼Œå¥½çš„åçš„ã€å¯¹çš„é”™çš„ï¼Œæˆ‘åªç›¸ä¿¡è‡ªå·±çš„çœ¼ç›ã€æ€è€ƒï¼Œå” å¨ä¸ªä¸åœï¼Œè€å©†ä¹Ÿå¬çš„çƒ¦ï¼Œå¦ˆå¦ˆå†å¬ä¼°è®¡ä¹Ÿå¬å‡ºäº†è€èŒ§ã€‚åé¢æˆ‘å‘ç°ä¹Ÿæ”¹å˜ä¸äº†å¥¹ä»¬ï¼Œå¥¹ä»¬ä¹Ÿä¸å…³å¿ƒè¿™äº›ï¼Œæˆ‘å°±æ›´éƒé—·äº†ã€‚å½“æˆ‘çœ‹Youtubeä¸€äº›ç›¸å…³å†…å®¹æ—¶ï¼Œè€å©†å°±ä¼šä¸»åŠ¨æ’­æ”¾é‡‘ç¿è£ç­‰äººçš„è§†é¢‘ã€‚\næ·±åœ³çš„å¿«èŠ‚å¥ä¹Ÿæ˜¯å‡ºäº†åçš„ï¼Œå½“ä½ åŒè„šè½åœ°æ·±åœ³å¼€å§‹ï¼Œä½ å°±å¼€å§‹èµ°è·¯å¸¦é£äº†ã€‚å¤§å¤šæ•°å¹´è½»äººéƒ½è„šæ­¥å¦‚é£ï¼Œä»–ä»¬ä¹Ÿå¾ˆæ‹¼ï¼Œæƒœæ—¶å¦‚é‡‘ã€‚æœ‰æ—¶æ˜¯åŸå¸‚è§„åˆ’çš„é—®é¢˜ï¼Œæœ‰æ—¶æ˜¯å¹³å°è°ƒåº¦ç­–ç•¥çš„é—®é¢˜ï¼Œæœ‰æ—¶æ˜¯äººè‡ªå·±çš„é—®é¢˜ï¼Œè°éƒ½æƒ³å¿«ä¸€ç‚¹ï¼Œä½ å¿«å°±éœ€è¦æœ‰äººé…åˆä½ æ…¢ä¸€ç‚¹ï¼Œä¸ç„¶å°±å®¹æ˜“å‡ºå†²çªã€‚\næ€»æœ‰äº›æ¼ è§†è§„åˆ™çš„äººä¼šæ¥æŒ‘åŠ¨ä½ çš„ç¥ç»ï¼Œå·®ç‚¹å‰²å–‰çš„ç”µåŠ¨è½¦é®é˜³æ£šã€çœ‹æ‰‹æœºé¢‘ç¹è¸©ä½ è„šåè·Ÿçš„è¡Œäººã€æ–‘é©¬çº¿å’Œè¡ŒäººæŠ¢è·¯çš„å¸æœºã€å’Œè¡ŒäººæŠ¢è·¯é—¯çº¢ç¯çš„å¤–å–å°å“¥ã€ä¸é¿è®©è‡ªè¡Œè½¦çš„å¸æœºï¼Œç­‰ç­‰ã€‚\nè¿™äº›å› ç´ å åŠ åˆ°ä¸€èµ·ï¼Œæœ€ç»ˆè®©æˆ‘å˜æˆä¸€ä¸ªç«è¯æ¡¶ã€‚ç»ˆäºåé¢å‘ç”Ÿäº†ä¸€æ¬¡å†²çªï¼Œè°ƒèŠ‚ä¸­ï¼Œä¸€ä¸ªå·®ä¸å¤šçˆ¸çˆ¸è¿™ä¸ªå¹´çºªçš„è­¦å¯Ÿï¼Œå’Œæˆ‘èŠäº†èŠï¼Œâ€œä½ å°±è¯´å¤§å“¥ä½ å‰å®³â€ï¼Œâ€œä½ å¯ä»¥éª‚ä»–åå£æ°´â€ï¼Œâ€œä»–ä¸å¯¹åœ¨å…ˆï¼Œä½†ä½ çŠ¯ä¸ç€æŠŠä»–â€¦â€¦â€ï¼Œâ€œå¹´è½»äººå¹´è½»æ°”ç››å¯ä»¥ç†è§£â€ï¼Œâ€œä¸å€¼å¾—â€ï¼Œé“ç†æ˜¯å¾ˆç®€å•çš„é“ç†â€¦â€¦ä½†æ˜¯æˆ‘æœ‰å¤šä¹…æ²¡æœ‰å¬åˆ°æ¥è‡ªé•¿è¾ˆçš„â€œç–å¯¼â€äº†ã€‚æˆ‘å¿½ç„¶æ„Ÿè§‰åˆ°è±ç„¶å¼€æœ—ï¼Œå‰æ‰€æœªæœ‰çš„è½»æ¾ï¼Œæ„Ÿè°¢æ·±åœ³è­¦å¯Ÿçš„æ‰¹è¯„æ•™è‚²ï¼Œè®©æˆ‘ä»¥ä¸€ä¸ªå°é”™è¯¯åŠæ—¶â€œè¿·é€”çŸ¥è¿”â€ã€‚\nå»å¹´å¹´åº•ï¼Œå¯¹ä¸€å®¶å‡å†’çš„è‹¹æœå”®åæœåŠ¡ä¸­å¿ƒçš„ç»´æƒè¿‡ç¨‹ï¼Œç®—æ˜¯æˆ‘æŠŠè­¦å¯Ÿçš„è¯å¬è¿›å»äº†ï¼Œè¿™ä¸ªç¤¾ä¼šä¸Šæœ‰å¾ˆå¤šèµ„æºèƒ½ååŠ©ä½ æƒ©ç½šçŠ¯é”™è¯¯çš„äººï¼Œåªè¦ä½ åˆ©ç”¨å¥½å®ƒä»¬ï¼Œæ²¡å¿…è¦å‰‘èµ°åé”‹ã€‚\næ„Ÿè°¢äº²æœ‹ï¼šè°¢è°¢ä½ ä»¬ä¸€ç›´åœ¨\nå·¥ä½œåä¹Ÿæ²¡ä»€ä¹ˆæœºä¼šå’Œäº²æœ‹å¸¸èšèšï¼Œå†åŠ ä¸Šè¿™å‡ å¹´ç–«æƒ…é˜²æ§ï¼Œæœºä¼šå°±æ›´å°‘äº†ï¼Œ21å¹´åº•å› ä¸ºå°å®å®å¤ªå°ä¹Ÿæ²¡æœ‰å›è€å®¶ã€‚20å¹´åº•åŠå©šç¤¼çš„æ—¶å€™ï¼Œé‚£ä¸ªæ—¶å€™åœ¨å©šç¤¼ç°åœºå¿ƒè¡€æ¥æ½®æ‹ç…§æ€ä¹ˆèƒ½å°‘çš„äº†å’Œå‘å°ã€æœ‹å‹ä»¬å‘¢ï¼Ÿæ‹äº†å‡ å¼ åˆç…§ã€‚\nä¸è¿‡æ²¡å‡ å¤©è€å©†å°±æœ‰å–œäº†ï¼Œåé¢å°±å¿™ç€å„ç§ç›¸å…³çš„äº‹æƒ…ï¼Œç«Ÿç„¶å¿˜è®°äº†æŠŠè¿™äº›ç…§ç‰‡ç»™å¯¼å‡ºæ¥ã€‚è¿‡äº›å¤©æŠ½ä¸ªå‘¨æœ«ï¼ŒæŠŠè¿™äº›ç…§ç‰‡æ•´ç†ä¸€ä¸‹ï¼Œç»™å®¶äººæœ‹å‹ä»¬å‘ä¸€ä¸‹ã€‚\næ„Ÿè°¢ä½ ä»¬ä¸€ç›´åœ¨ï¼Œè™½ç„¶ä¹Ÿå¸¸å¸¸å¾ˆä¹…ä¸è”ç³»ã€‚è™½ç„¶æˆ‘ä»¬èº«å¤„ä¸åŒçš„åŸå¸‚ï¼Œåšç€ä¸åŒçš„å·¥ä½œï¼Œæ¯å¤©æ“å¿ƒç€ä¸åŒçš„è¯é¢˜ï¼Œä½†æ˜¯æ€»æœ‰äº›ä¸œè¥¿æ˜¯æˆ‘ä»¬å…±åŒå…³æ³¨çš„ï¼Œæ¯”å¦‚ç”Ÿæ´»ã€å¸¦å¨ƒã€‚\næ—¶é—´ã€ç©ºé—´ï¼Œä¼šè®©äººä¸äººäº§ç”Ÿè·ç¦»æ„Ÿï¼Œåƒå±±ä¸œã€æ·±åœ³è·ç¦»1700å…¬é‡Œï¼Œä¹Ÿä¸è¿‡æ˜¯2å°æ—¶çš„è·ç¦»ï¼Œå‹è°Šä¹‹ä¸Šçš„æ—¶ç©ºè·ç¦»ï¼Œæˆ‘è®¤ä¸ºåªæ˜¯ä¸€å¥å¾®ä¿¡â€œå˜¿ï¼Œåœ¨å—â€çš„è·ç¦»ã€‚\næ„Ÿè°¢ä¼¤ç–¤ï¼šè®¤è¯†å¹¶çˆ±æƒœèº«ä½“\nè¿™ä¸ªä¸–ç•Œç¦»äº†è°éƒ½ä¼šè½¬ï¼Œå“ªæ€•äººç±»ç­ç»ï¼Œå‡ ç™¾äº¿å¹´åä¹Ÿå¯èƒ½è¯ç”Ÿå…¶ä»–ç‰©ç§ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªä¸–ç•Œä¸æ˜¯ä¸ºè°è€Œå­˜åœ¨ï¼Œæˆ‘ä»¬æ‰æ˜¯è¿™ä¸ªä¸–ç•Œçš„æ¸¸å®¢ã€‚å½“æˆ‘ä»¬åœ¨æ—…é€”ä¸­é‡åˆ°äº›ä¸å¿«ï¼Œä¹Ÿå°½é‡æ€€æ£ç€ä¹è§‚çš„å¿ƒæ€å»è§‚å¯Ÿå®ƒå§ã€‚\nâ€œä¼¤ç–¤ï¼Œæ˜¯ç¾å¥½ç”Ÿæ´»çš„åˆºé’â€ï¼Œ20å¹´å§ï¼Œéª‘ç€è‡ªè¡Œè½¦é‡é‡ä»è½¦æŠŠå‰æ‘”äº†å‡ºå»ï¼ˆè½¦è½®å¡åœ¨ç –ç¼é‡Œï¼‰ï¼Œæ™šä¸Šå¤ªé»‘æ¥ä¸åŠååº”ï¼Œæ‰‹æŒè¢«æ“¦æ‰3~4å¹³æ–¹å˜ç±³å·¦å³çš„çš®ï¼Œç«è¾£è¾£åœ°ç–¼ï¼Œä¸€åªæ‰‹éª‘åˆ°å°åŒºé—¨å£å‘äº†è¿™æ¡æœ‹å‹åœˆï¼Œ â€œScars are just tattoos of better storiesâ€ã€‚\nå› ä¸ºæˆ‘åšæŒéª‘è¡Œåå‡ å¹´ï¼Œè¿™æ˜¯æˆ‘å–œæ¬¢çš„äº‹æƒ…ï¼Œæ‰€ä»¥åœ¨å› å®ƒè€Œå—ä¼¤åæ‰ä¼šè¿™ä¹ˆä¹è§‚ï¼Œå¦‚æœæ˜¯å·¥ä½œç”Ÿæ´»ä¸Šçš„ç³Ÿç³•çš„å…¶ä»–äº‹ï¼Œæˆ‘å¯èƒ½å°±æ²¡è¿™ä¹ˆå¥½å¿ƒæƒ…äº†ã€‚\n21å¹´ï¼Œå› ä¸ºæ„å¤–ä¼¤åˆ°äº†ä¸€åªæ‰‹æŒ‡ï¼Œä½é™¢ã€‚ç—…æˆ¿é‡Œæœ‰ä½å¤§å“¥ç±»ä¼¼çš„ä¼¤ï¼Œå› ä¸ºæƒ³çœé’±é€‰æ‹©æˆªå»äº†æ‰‹æŒ‡ã€‚æˆ‘çš„è´¹ç”¨ï¼ŒæŠ¥é”€å‰æ€»è®¡1wå¤šï¼ŒæŠ¥é”€å®Œå2600ã€‚è¿™ä¸ªç¤¾ä¼šå¹¶ä¸æ˜¯é‚£ä¹ˆå…¶ä¹èèçš„ï¼Œæœ‰å¾ˆå¤šç¾¤ä½“æ”¶å…¥å¹¶ä¸é«˜ï¼Œåœ¨å‡ºç°èº«ä½“ä¸Šçš„é—®é¢˜æ—¶ï¼Œè¿˜æ˜¯ä¼šæœ‰äº›äººè¿«äºç»æµå‹åŠ›è¢«åŠ¨åœ°ã€æ— å¥ˆåœ°æ”¾å¼ƒã€‚è¿™ä»¶äº‹å¯¹æˆ‘è§¦åŠ¨è¿˜æ˜¯å¾ˆå¤§ï¼Œæˆ‘ä¹Ÿå¼€å§‹å…³æ³¨æ²»ç–—çš„å±€é™æ€§ï¼Œæœ‰äº›ä¸œè¥¿èƒ½ä¿®ä½†ä¿®ä¸å½»åº•ã€‚\nä»¥å‰æˆ‘å¬è¿‡ä¸¤ç§ä¸åŒçš„å£°éŸ³ï¼Œâ€œç•™å¾—é’å±±åœ¨ï¼Œä¸æ€•æ²¡æŸ´çƒ§â€ï¼Œâ€œä¸ºäº†é©å‘½ï¼Œä½ è¿˜æ€•æµè¡€ç‰ºç‰²å—â€ã€‚å¾ˆæ˜æ˜¾ï¼Œæ–­ç« å–ä¹‰åªä¼šæ›²è§£æˆ‘ä»¬çš„è®¤è¯†ã€‚\næˆ‘æƒ³è¯´çš„æ˜¯ï¼Œä»»ä½•æ—¶å€™æˆ‘ä»¬é€‰æ‹©çˆ±æƒœè‡ªå·±çš„èº«ä½“ï¼Œéƒ½ä¸èƒ½ç®—ä½œæ˜¯é”™è¯¯ã€‚ä»è‡ªå·±è¿™ä¸ªä¸ªä½“è€Œè¨€ï¼Œè¿™ä¸ªä¸–ç•Œä¸Šé™¤äº†ä½ ç”˜æ„¿ä¸ºä¹‹çŒ®èº«çš„ç›®æ ‡ä»¥å¤–ï¼Œå‡ ä¹ä¸å­˜åœ¨ä»»ä½•æ¯”ä½ çš„èº«ä½“æ›´æœ‰ä»·å€¼ã€é«˜çº§çš„ä¸œè¥¿ã€‚\n21å¹´è¯»äº†ä¸€æœ¬ä¹¦ã€Šäººä½“çš„ç§˜å¯†ã€‹ï¼Œæˆ‘å¾ˆå–œæ¬¢é‡Œé¢ä¸€æ®µè¯ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸‹ï¼Œå¤§æ„æ˜¯è¯´ï¼šâ€œå°±åœ¨æˆ‘ä»¬è¿·èŒ«ã€ä¸çŸ¥æ‰€æªçš„å½“ä¸‹ï¼Œä½ çš„èº«ä½“é‡Œæ— æ•°çš„ç»†èƒã€å„ç§ç»„ç»‡ã€å™¨å®˜æ­£åœ¨ä¸ºä½ çš„æ­£å¸¸è¿è¡Œä»¥æœ€å¤§åœ°æ•ˆç‡å·¥ä½œâ€¦â€¦â€ã€‚é—­ä¸Šçœ¼ç›ä½“ä¼šä¸‹ï¼Œå°±åœ¨æˆ‘ä»¬ä¸çŸ¥æ‰€æªçš„å½“ä¸‹ï¼Œæœ‰æ— æ•°çš„ç»†èƒæ­£åœ¨ä¸ºæˆ‘ä»¬æ‹¼å‘½åœ°è¿è½¬ã€‚äººä½“ã€ç”Ÿå‘½ï¼Œæ˜¯å¤šä¹ˆå¥‡å¦™å•Šï¼äº‹å®ä¸Šï¼Œé™¤å»å¥åº·äººä½“ä¸­çš„â€œç²¾ç¥â€ï¼Œå•çœ‹ç»„å»ºäººä½“çš„åŒ–å­¦å…ƒç´ ï¼Œé€ ä»·å°±è¦ä¸Šç™¾ä¸‡å…ƒï¼ˆæˆ–è€…ç™¾ä¸‡ç¾å…ƒï¼‰ï¼Œæ›´ä¸ç”¨è¯´è¿™äº›ç‰©è´¨ç»„ä»¶èµ·æ¥çš„å¤æ‚çš„ç»„ç»‡ã€å™¨å®˜äº†ï¼Œè€Œä¸”è¿˜æ²¡æœ‰è€ƒè™‘äººç±»æœ€ä¼Ÿå¤§çš„â€œå¤§è„‘çš„æ€ç»´â€ã€‚\nèº«ä½“æœ‰äº›ä¸œè¥¿ï¼Œåäº†å°±æ˜¯ä¿®ä¸å¥½çš„ï¼Œæ¯”å¦‚ä¼¤ç–¤ã€ç‰™é½¿ã€è„±å‘ã€è‚Œè…±ï¼Œç­‰ç­‰è¿™äº›æ˜¾è€Œæ˜“è§çš„ã€‚æ›´å€¼å¾—æ·±æ€çš„æ˜¯ï¼Œæˆ‘ä»¬æŒ£å¾—çš„æ”¶å…¥ï¼Œå¹¶ä¸ä¸€å®šå¤Ÿç”¨æ¥å«ä»˜èº«ä½“æŸå®³çš„ä¿®å¤è´¹ç”¨ã€‚\nå¸Œæœ›å¤§å®¶èƒ½åšæŒæŸ¥ä½“ï¼Œå¤šå…³æ³¨èº«ä½“å¼‚å¸¸ï¼Œç”¨æ­£ç¡®çš„æ–¹æ³•çˆ±æƒœè‡ªå·±çš„èº«ä½“æ€»æ²¡æœ‰é”™çš„ï¼Œé™¤éä½ æ„¿æ„ä¸ºä¹‹åšå‡ºç‰ºç‰²ã€‚\næ‹¥æŠ±å¤šå…ƒï¼šä¸åŒæ­£æ˜¯å­˜åœ¨çš„ä»·å€¼\næ…¢æ…¢åœ°å‘ç°å¾ˆå¤šäººå¯¹å¾ˆå¤šäº‹åŠ¡çš„çœ‹æ³•éƒ½æ˜¯ä¸åŒçš„ï¼Œæˆ‘ä»¬å¸¸ä»¥è¿™å¥è¯è‡ªé©±ï¼Œâ€œå›å­å’Œè€Œä¸åŒï¼Œå°äººåŒè€Œä¸åˆâ€ï¼Œè¯´ç›´ç™½ç‚¹ï¼Œä¸åŒæ‰æ˜¯æˆ‘ä»¬å­˜åœ¨çš„ä»·å€¼ï¼Œæˆ‘æ€æ•…æˆ‘åœ¨ï¼Œå°½ç®¡æˆ‘çš„è®¤çŸ¥ä¸ä¸€å®šå…¨é¢ã€æ­£ç¡®ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡ä¸€å®šæœ‰æ¯”æˆ‘æ›´èªæ˜ã€æœ‰è§è¯†çš„äººï¼Œåªè¦ä»–èƒ½æŠŠæˆ‘åæ˜ çš„å› ç´ è€ƒè™‘è¿›å»ï¼Œåœ¨æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€è®¾è®¡å±‚é¢äºˆä»¥è§£å†³æ‰ï¼Œé‚£è¿™å°±æ˜¯æœ‰ä»·å€¼çš„ã€‚\nå› ä¸ºåšè®¡ç®—æœºç›¸å…³å·¥ä½œçš„åŸå› ï¼Œæˆ‘åŠ å…¥äº†ä¸€äº›Slackç¾¤ç»„ã€Twitterå…³æ³¨äº†ä¸€äº›æ¯”è¾ƒç‰›çš„æŠ€æœ¯äººå‘˜ï¼Œå‡ å¹´ä¹‹åï¼Œæˆ‘å¯ä»¥å¾ˆèˆ’å¿ƒçš„è¯´ï¼Œshowoffä¸€ä¸‹æ²¡äº‹ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚\nä»¥å‰æˆ‘çš„QQç©ºé—´ã€æœ‹å‹åœˆã€å¾®åšå¤¹æ‚ç€å„ç§æŠ€æœ¯æ–‡ç« ï¼Œåæ¥æˆ‘çœ‹å¤§å®¶éƒ½ä¸æ€ä¹ˆå‘ï¼Œé‚£ç®—äº†å§ï¼Œæˆ‘æ„Ÿè§‰æˆ‘ä¹Ÿæ‰“æ‰°åˆ°å¤§å®¶äº†ï¼Œå°±ä¸å‘äº†å§ã€‚é—æ†¾çš„æ˜¯ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ç§åœˆå­é‡Œçš„äº¤æµã€‚æˆ‘ä»¬çœŸçš„è¦å¯¹å¥½å‹åˆ—è¡¨æ‰“ä¸Šå„ç§æ ‡ç­¾ï¼Œå‘æ¡æœ‹å‹åœˆä¹‹å‰æ–Ÿé…Œä¸€ç•ªå—ï¼Ÿ\næˆ‘å…³æ³¨çš„è¿™äº›å¤§ä½¬è¿˜éƒ½æŒºå¹³æ˜“è¿‘äººçš„ï¼Œä»–ä»¬ä¹Ÿä¼šæ™’å¨ƒï¼Œæ™’codesnippetï¼Œæ™’è‡ªå·±æ–°ä¹°çš„å®é©¬ï¼Œæ™’è‡ªå·±åˆšè¿˜å®Œæˆ¿è´·ï¼Œæ™’è‡ªå·±ä¹¦å†™åˆ°å“ªé‡Œäº†ï¼Œæ™’è‡ªå·±æ•²é”®ç›˜æ‰‹é€Ÿæœ‰å¤šå¿«ï¼ˆæœ‰æ¬¡è·Ÿå¤§ä½¬pkè¿‡ï¼Œç•¥é€Šä¸€ç­¹ï¼‰ï¼Œæ™’è‡ªå·±æ¥ä¸‹æ¥è¦å»å“ªé‡Œåˆ†äº«ï¼Œæ™’ä»Šå¤©å’Œå¥³å‹çš„çº¦ä¼šå¾ˆå¼€å¿ƒâ€¦è¿™æ ·çš„ç”Ÿæ´»å¤šç®€å•ï¼\nå¦å¤–ï¼Œè¿‘å‡ å¹´å‡ºç°äº†ä¸å°‘Appæƒ³æ‰“ç ´ç†Ÿäººç¤¾äº¤çš„æ¨¡å¼ï¼Œsoulç­‰ç­‰çš„ï¼Œä¸»è¦åŸå› è¿˜æ˜¯ä¸€äº›ç°å®åŸå› å¯¼è‡´ä¸Šè¿°é—®é¢˜ä¼¼ä¹æ— æ³•ä¸å¥½è§£å†³ï¼Œå¹´è½»äººç”šè‡³ä¹ŸåŒ…æ‹¬ä¸€äº›åƒæˆ‘è¿™æ ·çš„â€œè€äººâ€ä¹Ÿå¼€å§‹å»å°è¯•ä¸€äº›æ‰“ç ´ç†Ÿäººç¤¾äº¤çš„æ–¹å¼ï¼Œshowoffæ˜¯å¤šä¹ˆé‡è¦ï¼Œç›®çš„è¿˜æ˜¯ä¸ºäº†ç»™ç¤¾äº¤æ³¨å…¥ä¸€äº›æœ‰æ´»åŠ›çš„å…ƒç´ ï¼Œæ‰æ›´æœ‰å¯ç©æ€§ã€‚\näººï¼ŒçœŸçš„æ²¡å¿…è¦æŠŠè‡ªå·±éšè—èµ·æ¥ï¼Œæˆ‘è¿˜æ˜¯å¸Œæœ›æˆ‘çš„æœ‹å‹åœˆé‡Œé¢èƒ½æœ‰äº›æ™’è¿™ä¸ªæ™’é‚£ä¸ªçš„ï¼Œè™½ç„¶æˆ‘ä¸ä¸€å®šçœ‹çš„æ‡‚ï¼Œä½†å¦‚æœä½ èƒ½ç‚«ä¸€ä¸‹ï¼Œé‚£å¯¹æˆ‘è€Œè¨€åº”è¯¥ä¹Ÿç¡®å®å¼€æ‹“äº†ä¸‹çœ¼ç•Œã€‚ä¹Ÿä¸ç”¨æ‹…å¿ƒè‡ªå·±çš„æ„è§æ˜¯å¦ä¸åŒï¼Œæ˜¯å¦ä¼šè¢«èµåŒï¼Œå¦‚æœä½ æŠ±ç€æ›´åŠ ç§¯æå¼€æ”¾çš„å¿ƒæ€å»äº’åŠ¨ï¼Œä¹Ÿä¼šä¸æ–­ä¿®æ­£è‡ªå·±çš„è§‚ç‚¹ã€‚\nç°å®ä¸­ï¼Œæœ‰å¾ˆå¤šäººä¸åˆ†äº«ï¼Œæœ‰çš„æ˜¯æ‹…å¿ƒè¢«è®¤ä¸ºæ˜¯ç‚«è€€ï¼Œä½†æ˜¯ä»–æ˜æ˜åªæ˜¯ä¸ºäº†åˆ†äº«ä½“éªŒï¼Œå¦‚æœåç»­XRæŠ€æœ¯çš„åŠ æˆï¼Œä¸€ä½èº«å¤„å¾·å›½éª‘ç€s1000rrçš„éª‘å‹å¯ä»¥è®©å¤„äºç¦æ‘©åœ°å¸¦çš„æˆ‘æ„Ÿå—ä¸€æ³¢300km/hçš„ç™«ç‹‚é€Ÿåº¦ï¼Œé‚£ä½ è¯´æˆ‘ä¼šä»¥ä¸ºä»–åœ¨ç‚«è€€ä»–æœ‰è·‘è½¦å—ï¼Ÿä¸ä¼šã€‚\næŠ€æœ¯ï¼Œå½’æ ¹ç»“åº•è¿˜æ˜¯æœåŠ¡äºäººç±»çš„ç°å®ç”Ÿæ´»ï¼Œåªä¸è¿‡å®ƒå¯èƒ½é€šè¿‡äº†è™šæ‹Ÿçš„é€”å¾„ï¼Œè¿™é‡Œçš„â€œè™šæ‹Ÿâ€ä¹Ÿåªæ˜¯ä¸€ç§åª’ä»‹è€Œå·²ï¼Œåˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ‘å’Œå¼‚å›½ä»–ä¹¡çš„æœ‹å‹é€šç”µè¯ï¼Œä»–å¬åˆ°çš„å£°éŸ³ä¹Ÿæ˜¯è™šæ‹Ÿçš„ï¼Œå¹¶ä¸æ˜¯æˆ‘çš„å£°éŸ³340m/sä¼ æ’­è¿‡å»çš„ï¼Œå¯è¿™åˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ\nè™šæ‹Ÿï¼Œå¹¶ä¸æ˜¯ä¸ºäº†æŠŠå¤§å®¶æ¶è®¾åœ¨è™šæ‹Ÿä¸­ï¼Œæ°æ°å®ƒæ˜¯å»ºç«‹åœ¨ç°å®åŸºç¡€ä¸Šçš„è¿›ä¸€æ­¥æŠ½è±¡ï¼Œé€šè¿‡å®ƒå¯ä»¥ä¸°å¯Œæˆ‘ä»¬è¿æ¥çš„åª’ä»‹ã€‚æ¯”å¦‚æ·±åœ³å¤œæ™šåŠ ç­çš„æˆ‘å¯ä»¥è§¦æ‘¸åˆ°æ­¦æ±‰å©´å„¿åºŠä¸Šçš„å®è´ï¼Œæ„Ÿå—åˆ°å¥¹qå¼¹çš„çš®è‚¤ã€å®é™çš„å–˜æ¯å£°ã€‚\nç°åœ¨å…ƒå®‡å®™æ¦‚å¿µç«çƒ­ï¼Œå¦‚æœä½ è”æƒ³ä¸åˆ°æ›´å¤šçš„åœºæ™¯ï¼Œä¸è¦æ€¥ï¼Œä¸å¦¨è®©å­å¼¹å†é£ä¸€ä¼šå„¿ï¼Œä¹Ÿè®¸é‚£æ—¶å€™ä¼šæœ‰è¿˜ä¸é”™çš„åœºæ™¯è½åœ°å®ç°ã€‚\næ”¶å°¾å§\nå¥½åƒè¯´äº†å¾ˆå¤šï¼Œè¿™å¤§è‡´å°±æ˜¯æˆ‘è¿‘æ®µæ—¶é—´çš„æƒ³æ³•ï¼Œæ„Ÿè°¢è€å©†ã€æ„Ÿè°¢æ¯äº²ã€æ„Ÿè°¢äº²æœ‹ã€æ„Ÿè°¢è­¦å¯ŸåŒå¿—ã€æ‹¥æŠ±ä¸åŒçš„å£°éŸ³ã€‚2022å˜åŒ–é¢‡å¤šï¼Œåšå½“ä¸‹æœ€æ­£ç¡®çš„å†³å®šå§ï¼Œå‰©ä¸‹çš„äº¤ç»™è¿æ°”ï¼Œç›¸ä¿¡å¤§å®¶è¿æ°”éƒ½ä¸ä¼šå¤ªå·®ã€‚\n"}),a.add({id:63,href:"/tags/%E6%AF%8D%E4%BA%B2%E8%8A%82/",title:"æ¯äº²èŠ‚",description:"",content:""}),a.add({id:64,href:"/tags/%E7%88%B6%E4%BA%B2%E8%8A%82/",title:"çˆ¶äº²èŠ‚",description:"",content:""}),a.add({id:65,href:"/tags/ha/",title:"HA",description:"",content:""}),a.add({id:66,href:"/tags/sla/",title:"SLA",description:"",content:""}),a.add({id:67,href:"/blog/2022-06-21-%E5%AE%9E%E8%B7%B5%E4%B8%AD%E9%AB%98%E5%8F%AF%E7%94%A8%E5%A6%82%E4%BD%95%E5%81%9A/",title:"å®è·µä¸­é«˜å¯ç”¨å¦‚ä½•åš",description:"å¤§å®¶ç»å¸¸æåŠé«˜å¯ç”¨ï¼Œä½†æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹è¦å»è€ƒè™‘é«˜å¯ç”¨ï¼Œå“ªäº›æœåŠ¡åº”è¯¥åšé«˜å¯ç”¨ï¼Œæœ‰çŠ¶æ€ã€æ— çŠ¶æ€æœåŠ¡å®ç°é«˜å¯ç”¨çš„æ–¹æ³•åˆæœ‰ä»€ä¹ˆä¸åŒï¼Ÿæœ¬æ–‡å¯¹æ­¤åšäº†ä¸€äº›æ€è€ƒï¼Œä¹Ÿæä¾›äº†ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„ä½æˆæœ¬çš„è§£å†³æ€è·¯ã€‚",content:"é«˜å¯ç”¨ # æå‡æœåŠ¡å¯ç”¨æ€§å½“ç„¶æ˜¯ä¸€ä»¶å¥½äº‹ï¼Œä½†æ˜¯å®ç°é«˜å¯ç”¨ä¹Ÿæ˜¯æœ‰æˆæœ¬çš„ã€‚æå‡å¯ç”¨æ€§çš„å¸¸ç”¨åšæ³•æ˜¯é€šè¿‡é è®¾å¤‡å†—ä½™æ¥å®ç°ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–çš„åŠæ³•ï¼Œä½†æ˜¯ä¸ç®¡æ˜¯å“ªç§åŠæ³•ï¼Œåšè¿™äº›å·¥ä½œæ˜¯æœ‰æˆæœ¬çš„ã€‚å®è·µä¸­ï¼Œä¸€èˆ¬è¦æƒè¡¡æŠ•å…¥äº§å‡ºæ¯”ï¼Œæ¥å†³å®šéœ€ä¸éœ€è¦åšHAï¼Œåšçš„è¯å¯¹å“ªäº›æœåŠ¡åšHAã€‚\næå‡å¯ç”¨æ€§çš„æ‰‹æ®µ # æ‰€è°“é«˜å¯ç”¨ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥è€ƒè™‘ï¼š\n è¿›ç¨‹å†…æ¨¡å—çš„å¼€é—­ï¼ˆç‰¹æ€§å¼€å…³ï¼‰ï¼šå¯¹å¼‚å¸¸ä»£ç åˆ†æ”¯è¿›è¡Œæ‰“å¼€ã€å…³é—­æ§åˆ¶ï¼Œæœ‰é—®é¢˜æ—¶å¯ä»¥å…³é—­ ç‰¹å®šç”¨æˆ·çš„å½±å“ï¼šç‰¹å®šç”¨æˆ·æœ¬åœ°æ•°æ®é—®é¢˜å¯èƒ½è§¦å‘æŸç§å¼‚å¸¸ï¼Œå¯ä»¥æš‚æ—¶å¯¹ç”¨æˆ·å±è”½ç‰¹å®šé€»è¾‘ å­ç³»ç»Ÿçº§çš„å½±å“ï¼šå¤§ç³»ç»Ÿå°åšï¼Œè½»é‡åˆ†ç¦»ï¼Œå°†å…³é”®æœåŠ¡å’Œä¸€èˆ¬æœåŠ¡æ‹†åˆ†å¼€ï¼Œé¿å…äº’ç›¸å½±å“ è¿›ç¨‹çº§çš„å½±å“ï¼šå¤šè¿›ç¨‹æ¨¡å‹ï¼Œé¿å…å•ä¸ªè¿›ç¨‹æŒ‚æ‰äº§ç”Ÿå½±å“ï¼Œå¸¸ç”¨çš„å…±äº«å†…å­˜é˜Ÿåˆ—+å¤šè¿›ç¨‹ èŠ‚ç‚¹çº§çš„å½±å“ï¼šå•ä¸ªèŠ‚ç‚¹æŒ‚æ‰ï¼Œå¯ä»¥é€šè¿‡å†—ä½™ã€å±è”½æ•…éšœèŠ‚ç‚¹çš„æ–¹å¼æ¥è§£å†³ï¼Œä¸»å¤‡ã€é›†ç¾¤ç­‰ ç»„ä»¶çº§çš„å½±å“ï¼šå¯¹ç»„ä»¶çš„æ€§èƒ½è¾¹ç•Œè¦æœ‰æ¸…æ™°çš„è®¤è¯† å¤§æµé‡å†²å‡»ï¼šæ¶ˆæ¯é˜Ÿåˆ—å‰Šå³° åœ°éœ‡ç«ç¾å¯¼è‡´çš„åŒºåŸŸæ€§æ•…éšœï¼šéƒ¨ç½²æ—¶è€ƒè™‘è·¨æœºæˆ¿ã€è·¨åŒºåŸŸéƒ¨ç½²ï¼Œå¼‚åœ°å¤šæ´» ç­‰ç­‰  æœ‰çŠ¶æ€ã€æ— çŠ¶æ€æœåŠ¡ # æœåŠ¡ä¹Ÿåˆ†ä¸ºæœ‰çŠ¶æ€æœåŠ¡ã€æ— çŠ¶æ€æœåŠ¡ï¼Œå¯¹è¿™ä¸¤ç§æƒ…æ™¯çš„å¤„ç†æ–¹å¼ä¸€èˆ¬ä¹Ÿä¸åŒçš„ã€‚\n æ— çŠ¶æ€æœåŠ¡ï¼Œä¸€èˆ¬é€šè¿‡å±è”½æ•…éšœèŠ‚ç‚¹ã€è´Ÿè½½å‡è¡¡çš„æ–¹å¼æ¥è§£å†³å³å¯ï¼› æœ‰çŠ¶æ€æœåŠ¡ï¼Œåˆ™ç›¸å¯¹æ›´å¤æ‚ä¸€äº›ã€‚æ€»è€Œè¨€ä¹‹èŠ‚ç‚¹çº§çš„å¯ç”¨æ€§çš„æå‡ï¼Œä¸€èˆ¬è¦å€ŸåŠ©è®¾å¤‡å†—ä½™æ¥å®ç°ï¼Œä½†æ˜¯å¯¹æ¸¸æˆä¸šåŠ¡è€Œè¨€ï¼Œè¿™ä¸ªæˆæœ¬ä¼šæ¯”è¾ƒé«˜ã€‚è€Œä¸”æœ‰äº›æ¸¸æˆåå°æœåŠ¡æ˜¯æœ‰çŠ¶æ€æœåŠ¡ï¼Œå¯¹è¿™ç±»æœåŠ¡åšHAä¼šæ˜æ˜¾å¢åŠ æ•´ä½“æ–¹æ¡ˆçš„å¤æ‚åº¦ï¼ˆæ¯”å¦‚ä¸»å¤‡æ–¹æ¡ˆï¼Œæˆ–è€…åˆ†ç‰‡+å‰¯æœ¬çš„é›†ç¾¤æ–¹æ¡ˆï¼‰ï¼Œè€Œä¸”è®¾å¤‡æˆæœ¬ä¹Ÿä¼šå¢åŠ å¾ˆå¤šã€‚è®¾å¤‡æˆæœ¬è¿‡é«˜ï¼Œè¿˜ä¸å¦‚è®©ç©å®¶é‡å¼€ä¸€å±€ã€‚  æ¸¸æˆä¸šåŠ¡çš„ç‰¹ç‚¹å’Œæ™®é€šçš„ä¸šåŠ¡å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œå…¶æˆ˜æ–—æœåŠ¡å™¨ä¸€èˆ¬éƒ½æ˜¯æœ‰çŠ¶æ€æœåŠ¡ï¼Œæ‰€ä»¥ä¸»æµæ— çŠ¶æ€æœåŠ¡é‡‡ç”¨çš„HAæ–¹æ¡ˆã€ä¸»å¤‡æˆ–è€…é›†ç¾¤æ–¹æ¡ˆï¼Œä¸ä¸€å®šæ€»é€‚ç”¨äºæ¸¸æˆåœºæ™¯çš„ï¼Œå› ä¸ºè€ƒè™‘åˆ°æœºå™¨æŒ‚æ‰åæ¢å¤çš„æ”¶ç›Šï¼Œè¿™ä¸ªå®ç°æˆæœ¬ã€æ–¹æ¡ˆå¤æ‚åº¦å°±å¤ªé«˜äº†ã€‚\næ¸¸æˆä¸šåŠ¡ä¸­å¯¹æœ‰çŠ¶æ€æœåŠ¡çš„HAä¸€èˆ¬è¿™æ ·åšï¼Œå¯èƒ½ä¼šé€šè¿‡ï¼š\n åˆ†åŒºåˆ†æœ åˆ†set å¤šè¿›ç¨‹ å¤§ç³»ç»Ÿå°åš+è½»é‡åˆ†ç¦» ç‰¹æ€§å¼€å…³ ç”¨æˆ·æ•°æ®å¼‚å¸¸å±è”½ ç­‰ç­‰  é€šè¿‡è¿™äº›æ–¹å¼çš„æ¥é™ä½é—®é¢˜å½±å“é¢ï¼Œä¹Ÿç®—æ˜¯æå‡å¯ç”¨æ€§çš„åŠæ³•å§ã€‚\n"}),a.add({id:68,href:"/tags/%E6%97%A0%E7%8A%B6%E6%80%81/",title:"æ— çŠ¶æ€",description:"",content:""}),a.add({id:69,href:"/tags/%E6%9C%89%E7%8A%B6%E6%80%81/",title:"æœ‰çŠ¶æ€",description:"",content:""}),a.add({id:70,href:"/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/",title:"é«˜å¯ç”¨",description:"",content:""}),a.add({id:71,href:"/tags/algorithm/",title:"algorithm",description:"",content:""}),a.add({id:72,href:"/tags/data-structure/",title:"data structure",description:"",content:""}),a.add({id:73,href:"/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/",title:"æ•°æ®ç»“æ„ä¸ç®—æ³•",description:"",content:""}),a.add({id:74,href:"/blog/2022-05-24-%E6%B5%85%E8%B0%88%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/",title:"æµ…è°ˆæ•°æ®ç»“æ„ä¸ç®—æ³•",description:"æœ¬ç§‘å­¦æ•°æ®ç»“æ„ä¸ç®—æ³•æ—¶ï¼Œè‡ªå·±ä¹Ÿæ¯”è¾ƒæ³¨æ„ç†è®ºå®è·µæƒ³ç»“åˆï¼Œå¯¹è¯¾æœ¬ä¸Šè®²æˆçš„å†…å®¹ä¹Ÿç®—æ˜¯æŒæ¡çš„æ¯”è¾ƒå¥½ï¼Œåˆ°è€ƒç ”å¤ä¹ æ—¶ç”šè‡³èƒ½ç›´æ¥æ‹¿å‡ºè‰ç¨¿çº¸æŠŠè¯¾æœ¬ä¸­æ‰€æœ‰çº¿æ€§è¡¨ã€æ ‘ã€å›¾ç­‰ç›¸å…³çš„ç®—æ³•ç›´æ¥ç»™æ‰‹å†™å‡ºæ¥ï¼Œè‡³ä»Šæˆ‘è¿˜ä¿ç•™ç€å½“æ—¶çš„ä¸€ä»½è‰ç¨¿ :)\næ•°æ®ç»“æ„ä¸ç®—æ³•æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå½“å¯¹è®¡ç®—æ€§èƒ½ã€å­˜å‚¨ç©ºé—´æå‡ºæ˜ç¡®è¦æ±‚æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘è®¡ç®—å¤æ‚åº¦ã€ç©ºé—´å¤æ‚åº¦çš„é—®é¢˜ï¼Œåªä¸è¿‡å®é™…å·¥ä½œä¸­è¦æ±‚æ²¡æœ‰é‚£ä¹ˆé«˜ï¼Œå¤§å®¶ä¹Ÿæ²¡æœ‰é‚£ä¹ˆé‡è§†è€Œå·²ã€‚ä½†æ˜¯å½“æ¶‰åŠåˆ°ä¸€äº›å¤ç”¨èŒƒå›´æ¯”è¾ƒå¹¿çš„ä»£ç ï¼Œä¸€èˆ¬éƒ½ä¼šåšbenchmarkæ¥éªŒè¯å…¶æ˜¯å¦okã€‚\nå¦‚æœä¸€ä¸ªåŒå­¦è„‘æµ·é‡Œæœ‰æˆä½“ç³»çš„æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è®­ç»ƒï¼Œåœ¨è®¾è®¡æ–¹æ¡ˆæ—¶ä¹Ÿä¼šåŒæ—¶è€ƒè™‘å‡ ç§æ–¹æ¡ˆå¹¶å¹³è¡¡å„è‡ªä¼˜ç¼ºç‚¹ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å·¥ç¨‹ç´ å…»ã€‚å½“ç„¶äº†æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è®­ç»ƒï¼Œä¹Ÿä¼šé€æ¸åŸ¹å…»å¤§å®¶ä¸€ç§èƒ½åŠ›ï¼Œå°±æ˜¯åŒ–ç¹ä¸ºç®€ã€æŠŠç‰¹æ®Šé—®é¢˜ä¸€èˆ¬åŒ–ï¼Œè¿™ç§èƒ½åŠ›åœ¨ç¼–ç ã€è®¾è®¡è§£å†³æ–¹æ¡ˆæ—¶ä¹Ÿä¼šå…·å¤‡æ›´å¥½çš„ç»´æŠ¤æ€§ã€‚\næˆ‘è‡ªè®¤ä¸ºè‡ªå·±å…·å¤‡è¿™ç§èƒ½åŠ›äº†ï¼Œä½†æ˜¯å®é™…æƒ…å†µæ˜¯ï¼Œåœ¨æˆ‘æ¥è§¦äº†åˆ†å¸ƒå¼é¢†åŸŸçš„ç›¸å…³çŸ¥è¯†åï¼Œæˆ‘å‘ç°æ•°æ®ç»“æ„ä¸ç®—æ³•çœŸçš„æ˜¯åšå¤§ç²¾æ·±ï¼Œæ•°æ®ç»“æ„å¯ä»¥å°åˆ°ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå¯ä»¥å¤§åˆ°ä¸€ä¸ªB+æ ‘ï¼Œè€Œå¯¹ä»–ä»¬çš„è¿ç”¨æ›´èƒ½å½°æ˜¾æŒæ¡çš„ç²¾ç‚¼ç¨‹åº¦ï¼Œæ•°ç»„è®°å½•çš„å¯èƒ½æ˜¯ä¸€ç³»åˆ—æ™®é€šæ•°å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é¢†åŸŸå†²çªæ£€æµ‹çš„æ—¶é’Ÿå‘é‡ã€‚\nåœ¨æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è¯¾æœ¬ä¸Šï¼Œå¯èƒ½æ¥è§¦ä¸åˆ°è¿™ä¹ˆå¹¿æ³›çš„é¢†åŸŸï¼ŒæŸç§ç¨‹åº¦ä¸Šä¼šè®©äººè§‰å¾—è¯¾æœ¬çŸ¥è¯†æœ‰ç‚¹æ­»æ¿ã€æ¯ç‡¥ï¼Œä¸çŸ¥é“å‰Googleå·¥ç¨‹å¸ˆç‹äº‰çš„æå®¢æ—¶é—´è¯¾ç¨‹ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•ã€‹ä¹‹ç¾ï¼Œæ˜¯å¦ä¼šæœ‰å¦ä¸€ç•ªå‘³é“ï¼Ÿå¦å¤–ï¼Œè‡ªå·±ä»æœªå‚åŠ è¿‡ACMç«èµ›ä¹‹ç±»çš„ï¼Œä¹Ÿçœ‹è¿‡ä¸€äº›å‚ä¸ç«èµ›çš„åŒå­¦çš„åˆ†äº«ã€ç¼–ç¨‹æ¨¡æ¿ï¼Œå†…å®¹è¦†ç›–é¢ä¹‹å¹¿ä¹Ÿè®©æˆ‘æ±—é¢œï¼Œè‡ªè§‰èƒ½åŠ›ä¸èƒ½åŠã€‚\næ‰€ä»¥æˆ‘å‡†å¤‡è¯•è¯»ä¸‹ç‹äº‰çš„è¯¾ç¨‹ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•ã€‹ï¼Œgo go goã€‚",content:"æœ¬ç§‘å­¦æ•°æ®ç»“æ„ä¸ç®—æ³•æ—¶ï¼Œè‡ªå·±ä¹Ÿæ¯”è¾ƒæ³¨æ„ç†è®ºå®è·µæƒ³ç»“åˆï¼Œå¯¹è¯¾æœ¬ä¸Šè®²æˆçš„å†…å®¹ä¹Ÿç®—æ˜¯æŒæ¡çš„æ¯”è¾ƒå¥½ï¼Œåˆ°è€ƒç ”å¤ä¹ æ—¶ç”šè‡³èƒ½ç›´æ¥æ‹¿å‡ºè‰ç¨¿çº¸æŠŠè¯¾æœ¬ä¸­æ‰€æœ‰çº¿æ€§è¡¨ã€æ ‘ã€å›¾ç­‰ç›¸å…³çš„ç®—æ³•ç›´æ¥ç»™æ‰‹å†™å‡ºæ¥ï¼Œè‡³ä»Šæˆ‘è¿˜ä¿ç•™ç€å½“æ—¶çš„ä¸€ä»½è‰ç¨¿ :)\næ•°æ®ç»“æ„ä¸ç®—æ³•æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼Œå½“å¯¹è®¡ç®—æ€§èƒ½ã€å­˜å‚¨ç©ºé—´æå‡ºæ˜ç¡®è¦æ±‚æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘è®¡ç®—å¤æ‚åº¦ã€ç©ºé—´å¤æ‚åº¦çš„é—®é¢˜ï¼Œåªä¸è¿‡å®é™…å·¥ä½œä¸­è¦æ±‚æ²¡æœ‰é‚£ä¹ˆé«˜ï¼Œå¤§å®¶ä¹Ÿæ²¡æœ‰é‚£ä¹ˆé‡è§†è€Œå·²ã€‚ä½†æ˜¯å½“æ¶‰åŠåˆ°ä¸€äº›å¤ç”¨èŒƒå›´æ¯”è¾ƒå¹¿çš„ä»£ç ï¼Œä¸€èˆ¬éƒ½ä¼šåšbenchmarkæ¥éªŒè¯å…¶æ˜¯å¦okã€‚\nå¦‚æœä¸€ä¸ªåŒå­¦è„‘æµ·é‡Œæœ‰æˆä½“ç³»çš„æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è®­ç»ƒï¼Œåœ¨è®¾è®¡æ–¹æ¡ˆæ—¶ä¹Ÿä¼šåŒæ—¶è€ƒè™‘å‡ ç§æ–¹æ¡ˆå¹¶å¹³è¡¡å„è‡ªä¼˜ç¼ºç‚¹ï¼Œè¿™å…¶å®å°±æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„å·¥ç¨‹ç´ å…»ã€‚å½“ç„¶äº†æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è®­ç»ƒï¼Œä¹Ÿä¼šé€æ¸åŸ¹å…»å¤§å®¶ä¸€ç§èƒ½åŠ›ï¼Œå°±æ˜¯åŒ–ç¹ä¸ºç®€ã€æŠŠç‰¹æ®Šé—®é¢˜ä¸€èˆ¬åŒ–ï¼Œè¿™ç§èƒ½åŠ›åœ¨ç¼–ç ã€è®¾è®¡è§£å†³æ–¹æ¡ˆæ—¶ä¹Ÿä¼šå…·å¤‡æ›´å¥½çš„ç»´æŠ¤æ€§ã€‚\næˆ‘è‡ªè®¤ä¸ºè‡ªå·±å…·å¤‡è¿™ç§èƒ½åŠ›äº†ï¼Œä½†æ˜¯å®é™…æƒ…å†µæ˜¯ï¼Œåœ¨æˆ‘æ¥è§¦äº†åˆ†å¸ƒå¼é¢†åŸŸçš„ç›¸å…³çŸ¥è¯†åï¼Œæˆ‘å‘ç°æ•°æ®ç»“æ„ä¸ç®—æ³•çœŸçš„æ˜¯åšå¤§ç²¾æ·±ï¼Œæ•°æ®ç»“æ„å¯ä»¥å°åˆ°ä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå¯ä»¥å¤§åˆ°ä¸€ä¸ªB+æ ‘ï¼Œè€Œå¯¹ä»–ä»¬çš„è¿ç”¨æ›´èƒ½å½°æ˜¾æŒæ¡çš„ç²¾ç‚¼ç¨‹åº¦ï¼Œæ•°ç»„è®°å½•çš„å¯èƒ½æ˜¯ä¸€ç³»åˆ—æ™®é€šæ•°å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é¢†åŸŸå†²çªæ£€æµ‹çš„æ—¶é’Ÿå‘é‡ã€‚\nåœ¨æ•°æ®ç»“æ„ä¸ç®—æ³•çš„è¯¾æœ¬ä¸Šï¼Œå¯èƒ½æ¥è§¦ä¸åˆ°è¿™ä¹ˆå¹¿æ³›çš„é¢†åŸŸï¼ŒæŸç§ç¨‹åº¦ä¸Šä¼šè®©äººè§‰å¾—è¯¾æœ¬çŸ¥è¯†æœ‰ç‚¹æ­»æ¿ã€æ¯ç‡¥ï¼Œä¸çŸ¥é“å‰Googleå·¥ç¨‹å¸ˆç‹äº‰çš„æå®¢æ—¶é—´è¯¾ç¨‹ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•ã€‹ä¹‹ç¾ï¼Œæ˜¯å¦ä¼šæœ‰å¦ä¸€ç•ªå‘³é“ï¼Ÿå¦å¤–ï¼Œè‡ªå·±ä»æœªå‚åŠ è¿‡ACMç«èµ›ä¹‹ç±»çš„ï¼Œä¹Ÿçœ‹è¿‡ä¸€äº›å‚ä¸ç«èµ›çš„åŒå­¦çš„åˆ†äº«ã€ç¼–ç¨‹æ¨¡æ¿ï¼Œå†…å®¹è¦†ç›–é¢ä¹‹å¹¿ä¹Ÿè®©æˆ‘æ±—é¢œï¼Œè‡ªè§‰èƒ½åŠ›ä¸èƒ½åŠã€‚\næ‰€ä»¥æˆ‘å‡†å¤‡è¯•è¯»ä¸‹ç‹äº‰çš„è¯¾ç¨‹ã€Šæ•°æ®ç»“æ„ä¸ç®—æ³•ã€‹ï¼Œgo go goã€‚\n"}),a.add({id:75,href:"/tags/pattern/",title:"pattern",description:"",content:""}),a.add({id:76,href:"/blog/2022-04-24-understanding-design-patterns/",title:"Understanding the Design Patterns",description:"The design patterns is a blueprint about how to solve a commonly-reoccuring prolem in specific occasions.According to scale and complexity, the patterns could be categorized as Architecture Patterns, Design Patterns and Idioms.",content:"The design patterns is a blueprint about how to solve a commonly-reoccuring prolem in specific occasions.According to scale and complexity, the patterns could be categorized as Architecture Patterns, Design Patterns and Idioms.\nIntroduction # go-patterns actually is short for design patterns in go, which shows list of demos behind the concepts.\nWe must think about the following questions before we dive into the demos, it is really important.\n What\u0026rsquo;s a pattern? What\u0026rsquo;s a design pattern? History of patterns? Why should I learn patterns? Criticism of patterns? Classification of patterns? etc.  What\u0026rsquo;s a pattern? # Pattern is a solution, which works well in practices, to a commonly reoccurring problems. Patterns could be created and shared in every area, like building body, improving representation skills, architecture skills, or software design.\nI\u0026rsquo;m a developer, when I talk about patterns, I mean the software design pattern. Learning patterns can help us build software on the collective experience of skilled software engineers. Then when we work on a particular problem, we could recall a similar problem which had already been solved and reuse the essense of its solution to solve this new problem. That\u0026rsquo;s ä¸¾ä¸€åä¸‰ in Chinese.\nWith the help of patterns, novices will work better as if they were (or almost as if they were) experts on modest-sized projects, without having to gain many years of experience.\nWhat makes a pattern? # A pattern for software architecture describes a particular recurring design problem that arises in specific design contexts, and presents a well-proven generic scheme for its solution. The solution scheme is specified by describing its consitituent components, their responsibilities and relationships, and the ways in which they collaborate.\nSee: Pattern-Oriented Software Architecture, Volume 1, Page 8~11.\n Context: a situation giving rise to a problem. Problem: the recurring problem arising in that context. Solution: a proven resolution of the problem.  Pattern Categories # In software design area, patterns could be split into different layers.\nA closer look at existing patterns reveals that they cover various ranges of scale and abstraction.\n Some patterns help in structuring a software system into subsystems. Other patterns support the refinement of subsystems and components, or of the relationships between them. Further patterns help in implementing particular design aspects in a specific programming language.  Patterns also range from domain-independent ones, such as those for decoupling interacting components, to patterns addressing domain-specific aspects such as transaction policies in business applications, or call routing in telecommunication.\nTo refine our classification, we group patterns into three categories:\n  Architecture Patterns\nViable software architectures are built according to some overall structuring principle. We describe these principles with architectural patterns.\n A architectural pattern expresses a fundamental structural organization schema for software systems. It provides a set of predefined subsystems, specifies their responsibilities, and includes rules and guidelines for organizing the relationships between them.\n Architectural patterns are templates for concrete software architectures. They specify the system-wide structual properties of an application, and have an impact on the architecture of its subsystems. The selection of an architecture pattern is therefore a fundamental design decision when developing a software system.\n  Design Patterns The subsystems of a software architecture, as well as the relationships between them, usually consist of several smaller architectural units. We describe these using design patterns.\n A design pattern provides a scheme for refining the subsystems or components of a software system, or the relationships between them. It describes a commonly-recurring structure of communicating components that solves a general design problem within a particular context.\n Design patterns are medium-scale patterns. They are smaller in scale than architectural patterns, but tend to be independent of a particular programming language or programming paradigm. The application of a design pattern has no effect on the fundamental structure of a software system, but may have a strong influence on the architecture of a subsystem.\nMany design patterns provides structures for decomposing more complex services or components. Others address the effective cooperation between them, such as the following pattern: Observer or Publisher-Subscriber.\n  Idioms Idioms deal with the implemention of particular design issues.\n An idiom is a low-level pattern specific to a programming language. An idiom describes how to implement particular aspects of components or the relationships between them using the features of the given language.\n Idiom represent the lowest-level patterns. They address aspects of both design and implemention.\nMost idioms are language-specific, they capture existing programming experience. Often the same idiom looks different for different languages, and sometimes an idiom that is useful for one programming language doesn\u0026rsquo;t make sense in another.\n  Relationships between Patterns # A pattern solves a particular problem, but its application may raise new problems. Some of these can be solved by other patterns.\nMost patterns for software architecture raise problems that can be solved by smaller patterns. Patterns do not usually exist in isolation. Each pattern depends on the smaller patterns it contains and on the larger patterns in which it is contained.\nAnd a pattern may also be a variant of another.\nPatterns can also combine in more complex structures at the same level of abstraction. Each pattern resolves a particular subset of the forces to balance the forces when solving the problem.\nPattern Description # Patterns must be presented in an appropriate form if we are to understand and discuss them. A good description helps us grasp the essense of a pattern immediately:\n what\u0026rsquo;s the problem the pattern addresses? what\u0026rsquo;s the proposed solution?\nA good description also provides us with all the details necessary to implement a pattern, and to consider the consequences of its application. describe the solution uniformly!\nThis helps us to compare one pattern with another, especially when we are looking for alternative solutions to a problem.  The basic Context-Prolem-Solution structure provides a good starting point for a description format, but it is not enough.\nA pattern must be named - preferably with an intuitive name - if we are to share it and discuss it.\nOK, a good pattern template is showed below, please use it as a starting point:\n Name The name and a short Summary of the pattern. Also Known As Other names for the pattern, if any are known. Example A real-world example demonstrating the existence of the problem and the need for the pattern. Throughout the description we refer to the example to illustrate solution and implementation aspects, where this is necessary for useful. Context The situations in which the pattern may apply. Problem the problem the pattern addresses, including a discussion of its associated forces. Solution The fundamental solution principle underlying the pattern. Structure A detailed specification of the structural aspects of the pattern, including CRC-cards and OMT class diagram. Dynamics Typical scenarios describing the runtime behavior of the pattern. We further illustrate the scenarios with Object Message Sequences Charts. Implementation Guidelines for implementing the pattern. ...... ....... Variants A brief description of variants or specializations of a pattern. Known Uses Examples of the use of this pattern, taken from existing systems. Consequences The benefits the pattern provides, and any potiential liabilities. See Also References to patterns that solve similar problems, and to patterns that help us refine the pattern we are describing.  Will you learn patterns? # Now I think your answer will be definitely 100% Yes.\nRepository hitzhangjie/go-patterns will aim to provide demos for design patterns and idioms in golang. Hope we could follow the design details of design patterns to quickly solve the recurring problems.\n"}),a.add({id:77,href:"/tags/gdb/",title:"gdb",description:"",content:""}),a.add({id:78,href:"/blog/2022-04-10-macos-10.15.7%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEgdb/",title:"macOS 10.15.7å®‰è£…é…ç½®gdb",description:"macOS darwinå†…æ ¸çš„è°ƒæ•´å¯¼è‡´gdbæ— æ³•æ­£å¸¸å·¥ä½œï¼Œæœ¬æ–‡æ€»ç»“äº†æƒé™é—®é¢˜ã€è°ƒè¯•å¡æ­»é—®é¢˜çš„ä¸€ç§è§£å†³åŠæ³•ï¼Œäº²æµ‹å¯ç”¨ã€‚ä½†æ˜¯è¯¥åŠæ³•åªæ˜¯ç»•è¿‡äº†æŸäº›å¼‚å¸¸ï¼Œå¹¶æ²¡æœ‰å½»åº•ä¿®å¤gdbçš„bug",content:"é—®é¢˜ç®€ä»‹ # gdbä½œä¸ºä¸€æ¬¾ç¬¦å·çº§è°ƒè¯•å™¨ï¼Œæ˜¯å¹¿å¤§å¼€å‘äººå‘˜æ’æŸ¥é—®é¢˜çš„ç¥å…µåˆ©å™¨ï¼Œä½†æ˜¯å› ä¸ºmacOS darwinå†…æ ¸çš„ä¸€äº›è°ƒæ•´ï¼Œgdbå‡ºç°äº†å„ç§ç¥å¥‡çš„bugè¡Œä¸ºï¼Œå¦‚æƒé™é—®é¢˜å¯¼è‡´çš„æ— æ³•å¯åŠ¨è°ƒè¯•ã€å¯åŠ¨è°ƒè¯•åè°ƒè¯•ä¼šè¯å¡æ­»ç­‰ç­‰ã€‚\nä½œè€…æ­¤å‰ä¹Ÿæ›¾ç»å› ä¸ºæ­¤ç±»é—®é¢˜è€Œè‹¦æ¼ï¼Œç”šè‡³ä¸å¾—ä¸æ”¾å¼ƒäº†ä½¿ç”¨gdbè°ƒè¯•å™¨è€Œä½¿ç”¨å…¶ä»–åŠæ³•æ¥æ’æŸ¥ã€‚æœ€è¿‘åœ¨é€šè¿‡homebrewå®‰è£…jupyterlabçš„æ—¶å€™å‘ç°gdbè¢«å‡çº§äº†ï¼Œå°±çªç„¶æƒ³èµ·äº†ä¹‹å‰è¢«æç½®çš„è¿™ä¸ªé—®é¢˜ï¼Œæµ‹è¯•åå‘ç°gdbè¿˜æ˜¯ä¸å¯æ­£å¸¸ä½¿ç”¨ã€‚å› æ­¤googleä¸€åœˆåŠ ä¸æ–­æµ‹è¯•ï¼Œæœ€ç»ˆç»ˆäºæˆåŠŸäº†ã€‚\nè¿™é‡Œæ€»ç»“ä¸‹æ–¹ä¾¿æ—¥åæŸ¥é˜…ï¼Œä¹Ÿä¾›é‡åˆ°ç±»ä¼¼é—®é¢˜çš„æœ‹å‹å‚è€ƒï¼Œè¿™ç¡®å®æ˜¯ä¸€ä¸ªè€å¤§éš¾çš„é—®é¢˜äº†ã€‚googleèƒ½å‘ç°å¾ˆå¤šé’ˆå¯¹è¯¥é—®é¢˜çš„è®¨è®ºï¼Œéš¾å…„éš¾å¼Ÿä»¬ï¼Œlet\u0026rsquo;s goã€‚\nå¦‚ä½•è§£å†³ #   download the source code zip file from https://github.com/bminor/binutils-gdb.git, unzip the zipfile to ./binutils-gdb-master\n  then try to build from master HEAD\nmkdir build cd build ../binutils-gdb-master/configure \\ --disable-unit-tests \\ --disable-binutils \\ --without-guile make -j8  the built gdb binary is put here: ./gdb/gdb. Because I want to make package management simpler, so I don\u0026rsquo;t want to run make install to install the gdb and other files.\n ps: there\u0026rsquo;s no make uninstall target in the Makefile, if you want to remove all installed files, try this:\n make install DESTDIR=/tmp/gccinst find /tmp/gccinst | sed -e s,/tmp/gccinst,, | \\ (while read F; do rm \u0026quot;$F\u0026quot;; done)    I then run brew install gdb to install the homebrew latest version, then I replace the gdb binary by:\ncp ./gdb/gdb /usr/local/Cellar/gdb/11.2/bin/gdb -f    Then codesign mentioned above, OK, I put it here for convenience: write a gdb-entitlement.xml:\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot; encoding=\u0026quot;UTF-8\u0026quot;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026quot;-//Apple//DTD PLIST 1.0//EN\u0026quot; \u0026quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026quot;\u0026gt; \u0026lt;plist version=\u0026quot;1.0\u0026quot;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;com.apple.security.cs.allow-jit\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;com.apple.security.cs.allow-unsigned-executable-memory\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;com.apple.security.cs.allow-dyld-environment-variables\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;com.apple.security.cs.disable-library-validation\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;com.apple.security.cs.disable-executable-page-protection\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;com.apple.security.cs.debugger\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;com.apple.security.get-task-allow\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt;  then run following command to codesign:\nsudo codesign --entitlements gdb-entitlement.xml -fs gdb-cert $(which gdb)  If you haven\u0026rsquo;t created gdb-cert before, run following command to create:\n# download the script, or create one with the content in Appendix https://github.com/conda-forge/gdb-feedstock/blob/main/recipe/macos-codesign/macos-setup-codesign.sh # replace the certificate name sed -i 's/gdb-codesign/gdb-cert/g' macos-setup-codesign.sh # run the script to create the certificate and trust it ./macos-setup-codesign.sh # check the certificate is create or not security find-certificate -p -c gdb-cert | openssl x509 -checkend 0 or security find-certificate -p -c gdb-cert |openssl x509 -noout -text\\    then you can start your debugging, it works.\n  å°èŠ‚ # æœ¬æ–‡æ€»ç»“äº†è§£å†³macOSå¹³å°ä¸Šgdbæ— æ³•æ­£å¸¸è°ƒè¯•çš„é—®é¢˜ï¼Œè¿™ä¸ªåŠæ³•åªæ˜¯è§£å†³äº†æˆ‘å’Œéƒ¨åˆ†å¼€å‘äººå‘˜é‡åˆ°çš„é—®é¢˜ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»æ ¹æœ¬ä¸Šä¿®å¤é—®é¢˜ï¼Œä¸æ’é™¤åœ¨æ‚¨çš„ç¯å¢ƒä¸‹ä¾ç„¶å­˜åœ¨é—®é¢˜ï¼Œè¯·è‡ªå·±å°è¯•æ˜¯å¦æœ‰æ•ˆï¼Œä¸è¡Œå°±ç»§ç»­å¯»æ‰¾å…¶ä»–è§£å†³æ–¹æ¡ˆã€‚\né™„å½• #   macos-setup-codesign.sh\n#!/bin/bash # This script is copied from https://github.com/llvm/llvm-project/blob/master/lldb/scripts/macos-setup-codesign.sh CERT=\u0026quot;gdb_codesign\u0026quot; function error() { echo error: \u0026quot;$@\u0026quot; 1\u0026gt;\u0026amp;2 exit 1 } function cleanup { # Remove generated files rm -f \u0026quot;$TMPDIR/$CERT.tmpl\u0026quot; \u0026quot;$TMPDIR/$CERT.cer\u0026quot; \u0026quot;$TMPDIR/$CERT.key\u0026quot; \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 } trap cleanup EXIT # Check if the certificate is already present in the system keychain security find-certificate -Z -p -c \u0026quot;$CERT\u0026quot; /Library/Keychains/System.keychain \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 if [ $? -eq 0 ]; then echo Certificate has already been generated and installed exit 0 fi # Create the certificate template cat \u0026lt;\u0026lt;EOF \u0026gt;$TMPDIR/$CERT.tmpl [ req ] default_bits = 2048 # RSA key size encrypt_key = no # Protect private key default_md = sha512 # MD to use prompt = no # Prompt for DN distinguished_name = codesign_dn # DN template [ codesign_dn ] commonName = \u0026quot;$CERT\u0026quot; [ codesign_reqext ] keyUsage = critical,digitalSignature extendedKeyUsage = critical,codeSigning EOF echo Generating and installing gdb_codesign certificate # Generate a new certificate openssl req -new -newkey rsa:2048 -x509 -days 3650 -nodes -config \u0026quot;$TMPDIR/$CERT.tmpl\u0026quot; -extensions codesign_reqext -batch -out \u0026quot;$TMPDIR/$CERT.cer\u0026quot; -keyout \u0026quot;$TMPDIR/$CERT.key\u0026quot; \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 [ $? -eq 0 ] || error Something went wrong when generating the certificate # Install the certificate in the system keychain sudo security add-trusted-cert -d -r trustRoot -p codeSign -k /Library/Keychains/System.keychain \u0026quot;$TMPDIR/$CERT.cer\u0026quot; \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 [ $? -eq 0 ] || error Something went wrong when installing the certificate # Install the key for the certificate in the system keychain sudo security import \u0026quot;$TMPDIR/$CERT.key\u0026quot; -A -k /Library/Keychains/System.keychain \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 [ $? -eq 0 ] || error Something went wrong when installing the key # Kill task_for_pid access control daemon sudo pkill -f /usr/libexec/taskgated \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 # Exit indicating the certificate is now generated and installed exit 0    "}),a.add({id:79,href:"/tags/debugging/",title:"debugging",description:"",content:""}),a.add({id:80,href:"/tags/delve/",title:"delve",description:"",content:""}),a.add({id:81,href:"/tags/dlv/",title:"dlv",description:"",content:""}),a.add({id:82,href:"/tags/k8s/",title:"k8s",description:"",content:""}),a.add({id:83,href:"/tags/kubernetes/",title:"kubernetes",description:"",content:""}),a.add({id:84,href:"/blog/2022-04-08-%E5%AE%9E%E7%8E%B0k8s%E5%BA%94%E7%94%A8%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95/",title:"å®ç°k8såº”ç”¨è¿œç¨‹è°ƒè¯•",description:"æœ€è¿‘åœ¨æ”¯æŒå›¢é˜Ÿæµ‹è¯•å·¦ç§»ã€æµ‹è¯•è§„èŒƒã€CI/CDæµæ°´çº¿æ–¹é¢çš„ä¸€äº›å·¥ä½œï¼Œé’ˆå¯¹å¼€å‘äººå‘˜å‘ç°é—®é¢˜ã€å®šä½é—®é¢˜ã€ä¿®å¤é—®é¢˜è¿™ä¸ªè¿‡ç¨‹äº§ç”Ÿäº†ä¸€ç‚¹æ–°çš„æƒ³æ³•ï¼Œå°¤å…¶æ˜¯åœ¨æ•´ä½“ä¸Šäº‘åçš„å¤§èƒŒæ™¯ä¸‹ï¼Œæˆ‘è®¤ä¸ºå€¼å¾—å’Œå¤§å®¶ä¸€èµ·æ¢è®¨ä¸‹ï¼Œå¦‚ä½•å€ŸåŠ©è¿œç¨‹è°ƒè¯•æ›´å¿«é€Ÿåœ°å®šä½k8såº”ç”¨é—®é¢˜ã€‚",content:"æœ€è¿‘åœ¨æ”¯æŒå›¢é˜Ÿæµ‹è¯•å·¦ç§»ã€æµ‹è¯•è§„èŒƒã€CI/CDæµæ°´çº¿æ–¹é¢çš„ä¸€äº›å·¥ä½œï¼Œé’ˆå¯¹å¼€å‘äººå‘˜å‘ç°é—®é¢˜ã€å®šä½é—®é¢˜ã€ä¿®å¤é—®é¢˜è¿™ä¸ªè¿‡ç¨‹äº§ç”Ÿäº†ä¸€ç‚¹æ–°çš„æƒ³æ³•ï¼Œå°¤å…¶æ˜¯åœ¨æ•´ä½“ä¸Šäº‘åçš„å¤§èƒŒæ™¯ä¸‹ï¼Œæˆ‘è®¤ä¸ºå€¼å¾—å’Œå¤§å®¶ä¸€èµ·æ¢è®¨ä¸‹ï¼Œå¦‚ä½•å€ŸåŠ©è¿œç¨‹è°ƒè¯•æ›´å¿«é€Ÿåœ°å®šä½k8såº”ç”¨é—®é¢˜ã€‚\n1 é—®é¢˜èƒŒæ™¯ # ç°åœ¨å…¬å¸å¤§éƒ¨åˆ†ä¸šåŠ¡éƒ½ä¸Šäº‘äº†ï¼ŒæœåŠ¡éƒ¨ç½²åŸºæœ¬ä¸Šä¹Ÿk8så®¹å™¨åŒ–äº†ï¼Œè§£å†³äº†ä¸€äº›è€å¤§éš¾çš„é—®é¢˜ï¼Œæœ¬æ–‡ä¸è®¨è®ºk8sçš„å¥½å¤„ï¼Œæˆ‘ä»¬è®¨è®ºä¸‹å¼€å‘k8såº”ç”¨ï¼ˆæ¯”å¦‚å¾®æœåŠ¡ï¼‰æ—¶å¼€å‘ä¾§å¯èƒ½ç¢°åˆ°çš„ä¸€äº›é—®é¢˜ã€‚å‰æ®µæ—¶é—´æˆ‘å¼€å‘äº†ä¸€ä¸ªç»Ÿè®¡æ¨¡è°ƒæ¥å£æˆåŠŸç‡çš„æœåŠ¡ï¼Œéƒ¨ç½²åœ¨123å¹³å°ï¼Œå› ä¸ºæœåŠ¡ä»£ç æœ‰äº›éšæ™¦çš„bugæ’æŸ¥ä¿®å¤èŠ±äº†äº›æ—¶é—´ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å°±å¼€å§‹æ€è€ƒä¸ºä»€ä¹ˆæˆ‘å¯¹goã€trpcå¾ˆç†Ÿçš„æƒ…å†µä¸‹å®šä½é—®é¢˜è¿˜è¿™ä¹ˆéº»çƒ¦å‘¢ï¼Ÿäºæ˜¯å°±æœ‰äº†æ¥ä¸‹æ¥çš„æ¢ç´¢ä»¥åŠè¿™ç¯‡æ€»ç»“ã€‚\n2 ç»å¸¸é‡åˆ°çš„é—®é¢˜ # å¦‚æœä¸€ä»¶äº‹æƒ…ï¼ŒçŸ­æ—¶é—´å†…éœ€è¦äººè‚‰é‡å¤å¾ˆå¤šéï¼Œå°±å¾ˆå®¹æ˜“è®©äººæŠ“ç‹‚ï¼Œæ¯”å¦‚è¿™æ¬¡å¼€å‘ä½“éªŒå¾ˆå¿«å°±è®©æˆ‘æŠ“ç‹‚äº†ï¼š\n æµ‹è¯•æœåŠ¡å‘ç°æœåŠ¡è¡¨ç°ä¸æ­£å¸¸ï¼Œå‡†å¤‡å®šä½bug æŸ¥çœ‹é”™è¯¯æ—¥å¿—åˆæ­¥é”å®šé—®é¢˜èŒƒå›´ï¼Œé‡æ–°èµ°è¯»ä»£ç è¿›ä¸€æ­¥ç¼©å°é—®é¢˜èŒƒå›´ ä¿®æ”¹ä»£ç ã€æäº¤ä»£ç ï¼Œæ„å»ºé•œåƒã€å‘å¸ƒï¼Œç„¶åé‡æ–°æµ‹è¯•  æ’æŸ¥é—®é¢˜ä¸åªæ˜¯è¿™ä¹ˆè½»ææ·¡å†™ï¼Œç®€å•3æ­¥å°±æå®šäº†ï¼š\n å¯èƒ½æ˜¯bugä¸å®¹æ˜“å®šä½ï¼Œåœ¨å¤–éƒ¨æ•°æ®æ»¡è¶³æŸç§æ¡ä»¶ä¸‹æˆ–è€…é‡åˆ°æŸç§äº‹ä»¶æ—¶æ‰ä¼šè§¦å‘bugï¼› å¯èƒ½æ˜¯æµ‹è¯•ç”¨ä¾‹è¦†ç›–ä¸å¤Ÿï¼Œé€šè¿‡ä¸Šè¿°æ–¹æ³•å®šä½å¹¶è§£å†³äº†é—®é¢˜1ï¼Œä½†æ˜¯åé¢å‘ç°äº†é—®é¢˜2ï¼› å¯èƒ½æ˜¯æ—¥å¿—ä¿¡æ¯ä¸å¤Ÿï¼Œé”™è¯¯å¼‚å¸¸åˆ†æ”¯æ²¡æœ‰æ—¥å¿—ï¼Œæˆ–è€…æ—¥å¿—ä¿¡æ¯ä¸å…¨ï¼› å¾®æœåŠ¡æ¶æ„äº‹åŠ¡å¤„ç†ä¼šè·¨è¶Šå¤šä¸ªæœåŠ¡ï¼Œå¯èƒ½è¦ç»“åˆtracingã€loggingã€metricså¤šä¸ªç³»ç»Ÿè”åˆæ’æŸ¥ï¼› ä¿®æ”¹ä»£ç åæäº¤å¹¶æ„å»ºå‘å¸ƒï¼Œå¯èƒ½æ¶‰åŠåˆ°CI/CDç¯èŠ‚ï¼Œæµæ°´çº¿è€—æ—¶è¾ƒé•¿ï¼› 123å¹³å°æä¾›äº†dtoolsæ¥å¿«é€Ÿæ„å»ºã€patchï¼Œä½†æ˜¯ç ´åäº†æµ‹è¯•ç¯å¢ƒç¨³å®šæ€§ï¼ˆç¼ºå°‘é•œåƒï¼‰ TKEæœ‰åŒå­¦åŸºäºä¸ƒå½©çŸ³é…ç½®ä¸‹å‘å®ç°çš„æ›¿æ¢å·¥å…·ï¼Œå­˜åœ¨dtoolsç±»ä¼¼çš„é—®é¢˜ï¼› â€¦â€¦  æ€»ä¹‹ï¼Œè¿™ä¸ªæ’æŸ¥è¿‡ç¨‹å¯èƒ½è¦æ¶‰åŠåˆ°å¤šè½®äººè‚‰æ“ä½œï¼Œä½œä¸ºä¸€ä¸ªVIMå…šè¿ä¸Šä¸‹ç§»åŠ¨éƒ½è§‰å¾—ç”¨æ»‘åŠ¨é¼ æ ‡ã€æŒ‰ä¸Šä¸‹å·¦å³æ˜¯ç§ä½æ•ˆçš„æ“ä½œï¼Œæ›´ä¸ç”¨è¯´è®©æˆ‘åœ¨å„ä¸ªç³»ç»Ÿä¸­é—´ï¼ˆè€Œä¸”ç³»ç»Ÿè¡”æ¥å½“å‰ä¹Ÿè¿˜æœ‰è¾ƒå¤§ç©ºé—´ï¼‰åˆ‡æ¥åˆ‡å»äº†ã€‚åšäº†è¿™ä¹ˆå¤šâ€œé¢å¤–â€çš„æ“ä½œï¼Œæ‰èƒ½æ¸æ¸å»é€¼è¿‘çœŸç›¸ã€è§£å†³çœŸæ­£çš„é—®é¢˜ã€‚\n3 é™ä½é—®é¢˜å¤æ‚åº¦ # è¿™é‡Œå…ˆå£°æ˜ä¸‹ï¼Œå¹¶ä¸æ˜¯è¯´é€šè¿‡æ—¥å¿—è¿™ç§æ–¹å¼æ’æŸ¥é—®é¢˜ä¸å¥½ï¼Œä¸»è¦è¿˜æ˜¯è¦çœ‹å¾…è§£å†³é—®é¢˜çš„å¤æ‚åº¦ï¼Œå¦‚æœåŠ å‡ è¡Œæ—¥å¿—å°±å¯ä»¥è½»æ¾ç¼©å°é—®é¢˜åŸŸå¹¶è§£å†³ï¼Œé‚£è‡ªç„¶æ˜¯å¥½çš„ã€‚ä½†æ˜¯å®é™…æƒ…å†µæ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰é—®é¢˜éƒ½è¿™ä¹ˆå®¹æ˜“è§£å†³ï¼Œè€Œä¸”ä¹Ÿç¡®å®éœ€è¦å¤šè€ƒè™‘ä¸€äº›å…¶ä»–å½±å“ï¼Œæ¯”å¦‚dtoolså¯¹æµ‹è¯•ç¯å¢ƒçš„ç ´åï¼ˆè¦†ç›–äº†é•œåƒã€å¿˜äº†æ‰“é•œåƒæ€ä¹ˆåŠï¼‰ï¼Œé¢‘ç¹æµ‹è¯•ä¸¥æ ¼èµ°CI/CDçš„è€—æ—¶ï¼Œç­‰ç­‰ã€‚\nåŒ…æ‹¬ç°åœ¨æå€¡çš„æµ‹è¯•å·¦ç§»ï¼Œå•æµ‹è¦†ç›–ã€æ¥å£æµ‹è¯•ã€é›†æˆæµ‹è¯•ç­‰ç­‰ï¼Œæµ‹è¯•æ˜¯é—¨è‰ºæœ¯ï¼Œè¿œæ¯”æˆ‘ä¹‹å‰è‚¤æµ…çš„è®¤è¯†è¦é‡è¦ï¼Œé™¤äº†è´¨é‡ä¹Ÿè¦å…³æ³¨æ•ˆç‡ï¼Œåšè¿™ä¹ˆå¤šå…¶å®ä¹Ÿæ˜¯åƒåœ¨æŠ•å…¥æ—¶é—´ã€è¿­ä»£æ•ˆç‡ã€è½¯ä»¶è´¨é‡ã€å›¢é˜Ÿæ„æˆç­‰å› ç´ ä¹‹é—´å¯»æ±‚ä¸€ç§å¹³è¡¡ï¼Œé™ä½æ•´ä½“å¤æ‚åº¦ã€‚ç°åœ¨æœ‰äº›å›¢é˜Ÿå·²ç»ä¸å†å°†å•æµ‹è¦†ç›–ç‡å½“åšç¡¬æŒ‡æ ‡äº†ï¼Œè€Œæ˜¯é€šè¿‡ç»“åˆå¤šç§æµ‹è¯•æ‰‹æ®µæ¥å¯»æ±‚è¿™ç§å¹³è¡¡ã€‚\nå¾ˆå¤šäººå¯¹TDDæœ‰è®¤è¯†ï¼Œä½†æ˜¯åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šçœŸçš„å»åšï¼Œä»£ç è¯­å¥è¦†ç›–ã€åˆ†æ”¯è¦†ç›–æƒ…å†µå¯èƒ½å¹¶ä¸é«˜ï¼Œè€Œä¸”å¯¹æŸäº›corner caseså¯èƒ½é æ­£å¸¸æ€è·¯ä¹Ÿå¾ˆéš¾æ„é€ å‡ºæ¥ï¼Œå¯èƒ½è¦ç»“åˆfuzz testingæ¥ååŠ©ã€‚\nè¯´è¿™ä¹ˆå¤šï¼Œåªæ˜¯ä¸ºäº†è¯´æ˜ä¸€ç‚¹ï¼Œå‘ç°é—®é¢˜ã€èµ°æŸ¥æ—¥å¿—ã€èµ°æŸ¥ä»£ç ã€ä¿®å¤æäº¤ã€æ„å»ºå‘å¸ƒã€é‡æ–°æµ‹è¯•ï¼Œå¯èƒ½æ˜¯æˆ‘ä»¬æ¯ä¸ªå¼€å‘åŒå­¦è§£å†³å®šä½è§£å†³bugæ—¶é«˜é¢‘å‡ºç°çš„æ“ä½œæµç¨‹ï¼Œæ²¡æœ‰å¥½çš„é—®é¢˜å®šä½å·¥å…·æ”¯æŒï¼Œå¯¹å®è´µçš„å¼€å‘èµ„æºå°±æ˜¯ç§æµªè´¹ã€‚\næˆ‘çœ‹äº†ä¸‹å¤–éƒ¨çš„å¾ˆå¤šå›¢é˜Ÿåœ¨k8så¼€å‘æ–¹é¢çš„ä¸€äº›å®è·µï¼Œè¿™ä¸ªè¿‡ç¨‹æ„Ÿè§‰æ˜¯å¯ä»¥ä¼˜åŒ–çš„ï¼Œé‚£å°±æ˜¯è®©å¼€å‘k8såº”ç”¨çš„æˆ‘ä»¬è·å¾—æœ¬åœ°è°ƒè¯•èƒ½åŠ›ï¼Œè®©è¿œç¨‹çš„ä¸€äº›â€œä¸ç¡®å®šæ€§çš„å› ç´ â€å˜æˆæœ¬åœ°â€œè‚‰çœ¼å¯è§â€çš„è§‚æµ‹ï¼Œé—®é¢˜è§£å†³èµ·æ¥å°±æ–¹ä¾¿å¤šäº†ã€‚å°¤å…¶æ˜¯å¯¹æŸäº›testcaseï¼Œå¯èƒ½éœ€è¦åå¤å¾€å‰ã€å¾€åç¿»ä»£ç æ‰èƒ½å®šä½åˆ°é—®é¢˜ï¼Œè¿™ç§åœ¨å°†mozilla rrï¼ˆrecord and replayï¼‰ä½œä¸ºè°ƒè¯•å™¨backendçš„åŠ æˆä¸‹ä¼˜åŠ¿ä¼šéå¸¸æ˜æ˜¾ã€‚\n4 è¿œç¨‹è°ƒè¯•k8såº”ç”¨ # å‰é¢æˆ‘ä»¬è¯´äº†å¼€å‘å®šä½bugæ—¶å¤§è‡´çš„æ‰‹æ®µï¼Œå¹¶ä¸”å¼ºè°ƒäº†åœ¨é—®é¢˜æ¯”è¾ƒå¤æ‚æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé€šè¿‡å¤šæ¬¡â€œä¿®æ”¹ä»£ç ã€æ„å»ºå‘å¸ƒã€æµ‹è¯•â€è¿™æ ·çš„æµç¨‹æ¥é€¼è¿‘bugï¼Œè¿™ç§åœºæ™¯ä¸‹ï¼Œå¦‚æœèƒ½ç”¨è°ƒè¯•å™¨æ¥è·Ÿè¸ªä¸‹åº”ç”¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè§‚æµ‹ä¸‹æ‰§è¡Œæµç¨‹ã€å˜é‡ä¿¡æ¯ç­‰æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œç¼©å°é—®é¢˜åŸŸçš„è¿‡ç¨‹ä¼šå¿«å¾ˆå¤šï¼Œæ‰©å±•é˜…è¯»éƒ¨åˆ†ç»™å‡ºäº†ä¸€äº›ä¸šç•Œå›¢é˜Ÿçš„å®è·µï¼Œä¾›å‚è€ƒã€‚\nè°ƒè¯•å™¨åŸºç¡€ # å¯¹äºä¸€èˆ¬çš„åº”ç”¨ç¨‹åºè°ƒè¯•å™¨å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šæŒ‡ä»¤çº§è°ƒè¯•å™¨ã€ç¬¦å·çº§è°ƒè¯•å™¨ï¼Œå¤§å®¶å¹³æ—¶è°ƒè¯•ç”¨çš„gdbã€delveç­‰å°±æ˜¯ç¬¦å·çº§è°ƒè¯•å™¨ï¼Œå½“ç„¶ä»–ä»¬ä¹Ÿå…·å¤‡ä¸€å®šçš„æŒ‡ä»¤çº§è°ƒè¯•èƒ½åŠ›ã€‚ç°ä»£ç¬¦å·çº§è°ƒè¯•å™¨æ¶æ„ä¸€èˆ¬åˆ†ä¸ºfrontendã€backendï¼ŒäºŒè€…é€šè¿‡serviceå±‚è¿›è¡Œé€šä¿¡ï¼ˆå¦‚å€ŸåŠ©rpcæˆ–è€…pipeï¼‰ï¼Œfrontendä¸»è¦æ˜¯å®Œæˆä¸ç”¨æˆ·çš„äº¤äº’ã€å±•ç¤ºï¼Œbackendå®Œæˆå¯¹traceeï¼ˆè¢«è°ƒè¯•çº¿ç¨‹ï¼‰çš„å®é™…æ§åˆ¶ã€‚\nä»¥goè¯­è¨€çš„ç¬¦å·çº§è°ƒè¯•å™¨go-delve/delveä¸ºä¾‹ï¼Œå…¶åˆ†ä¸ºfrontendã€backendï¼Œfrontendå¯ä»¥æ˜¯å‘½ä»¤è¡Œã€gdlvå›¾å½¢ç•Œé¢ã€vscodeã€golandç­‰ï¼Œbackendé’ˆå¯¹ä¸åŒçš„å¹³å°æœ‰å¤šç§å®ç°ï¼Œå¦‚å€ŸåŠ©å¹³å°çš„delve nativeå®ç°ã€å€ŸåŠ©å…¶ä»–è°ƒè¯•å™¨èƒ½åŠ›gdbserverã€mozilla rrç­‰ã€‚æœ¬åœ°è°ƒè¯•frontendå’Œbackendä¹‹é—´é€šä¿¡é€šè¿‡net.pipeï¼Œè¿œç¨‹é€šä¿¡é€šè¿‡json-rpcï¼Œå¦‚æœæ˜¯è€ƒè™‘åˆ°ä¸vscodeã€golandé›†æˆçš„è¯åˆ™éœ€è¦è€ƒè™‘ç±»ä¼¼DAPï¼ˆdebugger adapter protocolï¼‰çš„æ–¹å¼ã€‚\nps: è¿™é‡Œä¸è¿‡å¤šå±•å¼€äº†ï¼Œå¯¹è°ƒè¯•å™¨è®¾è®¡å®ç°æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„ç”µå­ä¹¦ï¼ˆæœ€åä¸€ç« å¾…å®Œæˆï¼‰ï¼šhttps://www.hitzhangjie.pro/debugger101.io/\nå¤§å®¶ç”¨çš„vscodeæ’ä»¶ã€go-delve/delveè°ƒè¯•å™¨ï¼Œå…¶å®å°±æ˜¯å…ˆèµ·ä¸ªdlv backendä»¥serverçš„å½¢å¼ç›‘å¬ï¼Œåè®®å°±æ˜¯DAPï¼Œé€šè¿‡vscodeè°ƒè¯•çš„æ—¶å€™ï¼Œä¼šé€šè¿‡DAPåè®®ä¸dlv backendäº¤äº’ï¼Œdlv backendå¯¹è¢«è°ƒè¯•è¿›ç¨‹è¿›è¡Œæ§åˆ¶ï¼ˆå¦‚æ§åˆ¶å•æ­¥æ‰§è¡Œã€è¯»å†™å†…å­˜ç­‰ï¼‰ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·çš„ï¼Œå¯¹äºè¿œç¨‹è°ƒè¯•k8såº”ç”¨ï¼Œä¹Ÿæ˜¯è¿™æ ·çš„è¿‡ç¨‹ã€‚\nè¿œç¨‹è°ƒè¯•æ¼”ç¤º # é¦–å…ˆç»™å¤§å®¶ç®€å•å®æ“æ¼”ç¤ºä¸‹è¿œç¨‹è°ƒè¯•k8såº”ç”¨ï¼Œæœ€åå¤§å®¶ä¼šæ„è¯†åˆ°è¿™ä¸ªæ˜¯å®Œå…¨å¯ä»¥å®ç°çš„ï¼Œè€Œä¸”å¯ä»¥åšçš„æ›´æ–¹ä¾¿æ˜“ç”¨ã€‚\nç¤ºä¾‹å·¥ç¨‹è¯´æ˜ # ä¸‹é¢ä»¥ä¸€ä¸ªç®€å•çš„å·¥ç¨‹ä½œä¸ºç¤ºä¾‹ï¼Œå®æ“ä¸‹å¦‚ä½•è¿œç¨‹è°ƒè¯•k8såº”ç”¨ï¼Œè¿™ä¸ªå·¥ç¨‹åªæœ‰è¿™ä¹ˆå‡ ä¸ªæ–‡ä»¶ï¼š\n/Volumes/kubernetes/debugging-go-app-in-k8s $ tree . . â”œâ”€â”€ Dockerfile â”œâ”€â”€ Makefile â”œâ”€â”€ app â””â”€â”€ main.go 0 directories, 4 files  è¿™é‡Œçš„main.goï¼Œæ˜¯ä¸€ä¸ªhttpæœåŠ¡ï¼Œæ¨¡æ‹Ÿæˆ‘ä»¬çš„å¾®æœåŠ¡ï¼Œå¯ä»¥é•¿æœŸè¿è¡Œå¹¶æ¥å—ç”¨æˆ·è¯·æ±‚ã€‚\npackage main import ( \u0026quot;log\u0026quot; \u0026quot;net/http\u0026quot; \u0026quot;os\u0026quot; ) // DefaultPort is the default port to use if once is not specified by the SERVER_PORT environment variable const DefaultPort = \u0026quot;8080\u0026quot; func getServerPort() string { port := os.Getenv(\u0026quot;SERVER_PORT\u0026quot;) if port != \u0026quot;\u0026quot; { return port } return DefaultPort } // EchoHandler echos back the request as a response func EchoHandler(writer http.ResponseWriter, request *http.Request) { log.Println(\u0026quot;Echoing back request made to \u0026quot; + request.URL.Path + \u0026quot; to client (\u0026quot; + request.RemoteAddr + \u0026quot;)\u0026quot;) writer.Header().Set(\u0026quot;Access-Control-Allow-Origin\u0026quot;, \u0026quot;*\u0026quot;) // allow pre-flight headers writer.Header().Set(\u0026quot;Access-Control-Allow-Headers\u0026quot;, \u0026quot;Content-Range, Content-Disposition, Content-Type, ETag\u0026quot;) request.Write(writer) } func main() { log.Println(\u0026quot;starting server, listening on port \u0026quot; + getServerPort()) http.HandleFunc(\u0026quot;/\u0026quot;, EchoHandler) http.ListenAndServe(\u0026quot;:\u0026quot;+getServerPort(), nil) }  Makefileå®Œæˆåº”ç”¨ç¨‹åºçš„æ„å»ºï¼š\nall: GOOS=linux GOARCH=amd64 go build -gcflags 'all=-N -l' -o ./app ./main.go  Dockerfileå®Œæˆé•œåƒæ„å»ºï¼š\nFROM golang:1.16.3 ENV GO111MODULE=on RUN go get github.com/go-delve/delve/cmd/dlv@v1.8.2 RUN mkdir app WORKDIR /app COPY app . EXPOSE 10000 EXPOSE 8080 ENTRYPOINT [\u0026quot;/go/bin/dlv\u0026quot;, \u0026quot;--listen=:10000\u0026quot;, \u0026quot;--headless=true\u0026quot;, \u0026quot;--api-version=2\u0026quot;, \u0026quot;exec\u0026quot;, \u0026quot;./app\u0026quot;]  æ³¨æ„è¿™é‡Œæˆ‘ä»¬ç›´æ¥dlvã€appåŠ åˆ°äº†é•œåƒé‡Œï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºç›´æ¥æ˜¯ä»¥è¢«è°ƒè¯•æ¨¡å¼è¿è¡Œçš„ã€‚å®é™…çœŸçš„è€ƒè™‘åˆ°ä¾¿åˆ©æ€§çš„è¯ï¼Œdlvä»¥sidecarçš„å½¢å¼æä¾›ï¼Œå¹¶ä¸”æ¥æ”¶dlv connectè¯·æ±‚åattachåˆ°running processçš„æ–¹å¼æ›´åˆé€‚ï¼Œç°åœ¨æ˜¯å®Œå…¨å¯ä»¥åšåˆ°è¿™ç‚¹çš„ï¼Œdlvä½œè€…Derek Parkeræ›¾ç»åšè¿‡ä¸€æœŸåˆ†äº«ï¼Œä¸“é—¨ä»‹ç»k8s clusteråº”ç”¨è°ƒè¯•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ä»æ–‡æœ«å‚è€ƒé“¾æ¥ä¸­æ‰¾åˆ°ã€‚\nç¤ºä¾‹å·¥ç¨‹éƒ¨ç½² # åç»­å†…å®¹å‡å®šå¤§å®¶å·²ç»å®‰è£…äº†dockerã€minikubeï¼Œå¦‚æœæ²¡æœ‰è¯·è‡ªè¡Œäº†è§£ä¸‹å¦‚ä½•å®‰è£…ï¼Œç„¶åå¯åŠ¨dockerã€minikube startå¯åŠ¨æœ¬åœ°k8s clusterã€‚\næ„å»ºé•œåƒå‰å…ˆå°†docker registryæŒ‡å‘minikubeé»˜è®¤çš„registryï¼š\neval $(minikube -p minikube docker-env)  ç„¶åå†æ„å»ºè¿™ä¸ªé•œåƒï¼Œè¿™æ ·kubectlå°±èƒ½å¼•ç”¨åˆ°æœ¬åœ°é•œåƒï¼š\ndocker build -t debugging-go-app-in-k8s:latest .  k8séƒ¨ç½²å¹¶è¿è¡Œè¿™ä¸ªé•œåƒï¼š\nkubectl run --rm -i debugging-go-app-in-k8s:latest --image-pull-policy=Never  è¿è¡Œå¹¶æŸ¥çœ‹å®¹å™¨æ˜¯å¦èµ·æ¥ï¼š\nkubectl get pods  åº”è¯¥èƒ½çœ‹åˆ°debugging-go-app-in-k8sï¼Œèµ·æ¥å°±okäº†ã€‚\nminikubeæœ‰ç‚¹ç‰¹æ®Šï¼Œæ­£å¸¸æ¥è¯´å¯ä»¥é€šè¿‡minikube serviceæ¥åˆ›å»ºä¸ªtunnelä»¥ä¸å®¹å™¨ä¸­çš„ç¨‹åºé€šä¿¡ï¼Œæ¯”å¦‚æµ‹è¯•httpæ¥å£ã€‚\nä¹Ÿå¯ä»¥é€šè¿‡kubectl port-forwardæ¥å®ç°ï¼š\nkubectl port-forward debugging-go-app-in-k8s 10000:10000 // è¿™ä¸ªæ˜¯dlv backendç«¯å£ kubectl port-forward debugging-go-app-in-k8s 8080:8080 // è¿™ä¸ªæ˜¯httpæœåŠ¡ç«¯å£  ä¸€ä¸ªæ”¯æŒè°ƒè¯•çš„k8såº”ç”¨å·²ç»å‡†å¤‡å¥½äº†ï¼Œç„¶åå¯ä»¥é€šè¿‡dlvæˆ–è€…IDEè¿›è¡Œè°ƒè¯•äº†ã€‚\nè¿œç¨‹è°ƒè¯•æµ‹è¯• # ä»¥dlvå‘½ä»¤è¡Œè°ƒè¯•ä¸ºä¾‹ï¼š\n// å…ˆè¿æ¥åˆ°è¿œç¨‹k8s podä¸­çš„debugger backend dlv connect localhost:10000 dlv\u0026gt; _ // å‡†å¤‡ä¸ªæ–­ç‚¹ï¼Œæ¯”å¦‚æ¥å£å¤„ç†å‡½æ•° dlv\u0026gt; break EchoHandler dlv\u0026gt; _  ç„¶åç»™httpæœåŠ¡å‘ä¸ªè¯·æ±‚ curl http://localhost:8080ï¼Œæ­¤æ—¶å°±ä¼šå‘ç°dlv frontendå·²ç»åœåœ¨EchoHandlerè¿™ä¸ªä½ç½®äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ­£å¸¸è¿›è¡Œè°ƒè¯•äº†ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡vscodeé‡Œé¢çš„Run\u0026gt;Connect and Debugæ¥è®¾ç½®remote addressä¸ºlocalhost:8080ååœ¨vscodeä¸­è¿›è¡Œè°ƒè¯•ã€‚\nä¸å®¹å™¨å¹³å°ç»“åˆ # å¼€å‘åŒå­¦å¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯ï¼Œä¸å¦¨ä¸»åŠ¨è´¡çŒ®ä¸€ä¸‹ï¼Œè…¾è®¯å†…éƒ¨çš„ä¸»æµå®¹å™¨å¹³å°æ˜¯TKEï¼ˆTencent Kubernetes Engineï¼‰ï¼ŒPCG 123å¹³å°ä¹Ÿæ˜¯åœ¨TKEåŸºç¡€ä¸Šæ„å»ºã€‚ç†è®ºä¸Šæˆ‘ä»¬å›´ç»•å®¹å™¨å¹³å°æä¾›äº›è°ƒè¯•å™¨æ’ä»¶å³å¯å®ç°è¿œç¨‹è°ƒè¯•èƒ½åŠ›ã€‚æœ€ç»ˆè¿œç¨‹è°ƒè¯•èƒ½åŠ›æ”¯æŒçš„è¯ï¼Œå¯èƒ½æœ€ç»ˆå½¢æ€åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚\nåœ¨åŒä¸€ä¸ªpodä¸­éƒ¨ç½²ä¸€ä¸ªdelveï¼Œdelveå¯¹åŒä¸€ä¸ªpodä¸­çš„go-appè¿›è¡Œè°ƒè¯•ï¼Œç„¶åå¼€å‘äººå‘˜é€šè¿‡debugger frontendé€šè¿‡json-rpcæˆ–è€…DAPä¸podä¸­çš„delveï¼ˆdebugger backendï¼‰è¿›è¡Œäº¤äº’ï¼Œå®Œæˆå¯¹æœåŠ¡go-appçš„è°ƒè¯•ã€‚\nç”±äºæºä»£ç å­˜æ”¾è·¯å¾„å·®å¼‚çš„é—®é¢˜ï¼Œdlvæä¾›äº†ä¸€ç§è§£å†³æ€è·¯substitute-pathï¼Œè¿™æ ·åœ¨æ¶‰åŠåˆ°æºç ç›¸å…³çš„è½¬æ¢æ—¶ï¼ˆæ¯”å¦‚åŸºäºfile linenoæ·»åŠ æ–­ç‚¹ç­‰ï¼‰ä¾ç„¶å¯ä»¥é¡ºåˆ©è°ƒè¯•ã€‚\n5 æœ¬æ–‡å°ç»“ # å¼€å‘è¿‡ç¨‹ä¸­å¯¹é—®é¢˜å®šä½çš„ä¸€ç‚¹æ€è€ƒï¼Œäº†è§£äº†ä¸‹ä¸šç•Œä¸€äº›å®è·µï¼Œå¯¹äºk8sã€å¾®æœåŠ¡è¿™ç§æƒ…å†µï¼Œè¿˜æ˜¯å¾ˆå€¼å¾—å»ºè®¾è¿œç¨‹è°ƒè¯•èƒ½åŠ›çš„ã€‚ä¸šç•Œå¾ˆå¤šå¤´éƒ¨ä¼ä¸šéƒ½æœ‰è¿™æ–¹é¢çš„å®è·µï¼Œæ¯”å¦‚Googleã€RHELç­‰ï¼Œä»¥Google Cloudçš„Cloud Codeä¸ºä¾‹ï¼Œæ”¯æŒwatchæœ¬åœ°ä»£ç æ›´æ–°å¹¶è‡ªåŠ¨å‘å¸ƒã€é‡æ–°å¯åŠ¨è°ƒè¯•ï¼Œå…¶ä»–çš„å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ‰©å±•é˜…è¯»äº†è§£ã€‚\nç ”å‘æ•ˆç‡ã€å·¥å…·å»ºè®¾æ˜¯ä¸€é¡¹é•¿è·‘ï¼Œæˆ‘ä»¬è¦å€¾å¬ä¸€çº¿ç”¨æˆ·çš„çœŸå®è¯‰æ±‚ï¼Œä¹Ÿè¦å¤šå»æ¢ç´¢ä¼˜ç§€å›¢é˜Ÿçš„å®è·µæ¥åå“ºè‡ªèº«ã€‚\n6 æ‰©å±•é˜…è¯» #  Google Cloud: Cloud Codeè°ƒè¯•k8såº”ç”¨ï¼Œhttps://cloud.google.com/code/docs/vscode/debug solo-io/Squash: The debuggers for microservicesï¼Œhttps://github.com/solo-io/squash vscode-kubernetes-tools/debugï¼Œhttps://github.com/vscode-kubernetes-tools/vscode-kubernetes-tools/blob/master/debug-on-kubernetes.md setlog/debug-k8s: how to debug a go-service in k8s, https://github.com/setlog/debug-k8s remote debugging on k8s using vscode, https://www.youtube.com/watch?v=nMm-vaFcG9c\u0026amp;list=LL\u0026amp;index=2 bug on a cluster by derek parker - 20220317, https://www.youtube.com/watch?v=TKPmvy6xGlQ\u0026amp;t=340s bug on a cluster by derek parker - 20220406ï¼Œhttps://www.meetup.com/ChicagoGo/events/284436038 debugging go applications inside k8sï¼Œhttps://hackernoon.com/debugging-go-application-inside-kubernetes-from-ide-h5683xeb telepresence: making the remote local: faster feedback, collaboration and debuggingï¼Œhttps://www.telepresence.io/docs/latest/concepts/faster/ Debugging Go Microservices in Kubernetes with VScodeï¼Œhttps://blog.getambassador.io/debugging-go-microservices-in-kubernetes-with-vscode-a36beb48ef1  "}),a.add({id:85,href:"/tags/ast/",title:"AST",description:"",content:""}),a.add({id:86,href:"/tags/highlight/",title:"highlight",description:"",content:""}),a.add({id:87,href:"/tags/ident/",title:"ident",description:"",content:""}),a.add({id:88,href:"/tags/keyword/",title:"keyword",description:"",content:""}),a.add({id:89,href:"/blog/2022-02-09-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%BA%90%E4%BB%A3%E7%A0%81%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE/",title:"å¦‚ä½•å®ç°æºä»£ç è¯­æ³•é«˜äº®",description:"å¤§å®¶å¯¹æºä»£ç è¯­æ³•é«˜äº®å¹¶ä¸é™Œç”Ÿï¼Œä¸ç®¡æ˜¯åŠŸèƒ½å¼ºå¤§çš„IDEï¼Œè¿˜æ˜¯å¸¸è§„çš„ä¸€äº›ç¼–è¾‘å™¨vimã€sublimeã€markdown codefencesç­‰éƒ½æ”¯æŒä¸åŒç¼–ç¨‹è¯­è¨€çš„è¯­æ³•é«˜äº®ï¼Œå¤§å®¶çŸ¥é“å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å—ï¼Ÿæœ¬æ–‡å°±ä»¥goè¯­è¨€è¯­æ³•é«˜äº®ä¸ºä¾‹ç®€å•åšä¸ªä»‹ç»ã€‚",content:"è¯­æ³•é«˜äº® # è½¯ä»¶å¼€å‘è¿‡ç¨‹ä¸­å¯¹æºä»£ç è¿›è¡Œè¯­æ³•é«˜äº®æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å°†ç¨‹åºä¸­ä¸åŒçš„è¦ç´ è¿›è¡Œæœ‰æ•ˆåœ°åŒºåˆ†ï¼Œå¦‚å…³é”®å­—ã€ä¿ç•™å­—ã€æ ‡è¯†ç¬¦ã€æ‹¬å·åŒ¹é…ã€æ³¨é‡Šã€å­—ç¬¦ä¸²ç­‰ç­‰ã€‚å¼€å‘äººå‘˜ä½¿ç”¨çš„IDEä¸€èˆ¬éƒ½æ”¯æŒè¯­æ³•é«˜äº®ï¼Œåƒvimã€sublimeç­‰çš„ç¼–è¾‘å™¨ä¹Ÿå¯ä»¥é€šè¿‡æ’ä»¶å¯¹ä¸åŒç¼–ç¨‹è¯­è¨€çš„æºä»£ç è¿›è¡Œè¯­æ³•é«˜äº®æ”¯æŒã€‚\nå¦‚ä½•å®ç° # è¦å®ç°è¯­æ³•é«˜äº®ï¼Œéœ€è¦åšå“ªäº›å·¥ä½œå‘¢ï¼Ÿå¦‚æœå­¦ä¹ è¿‡ç¼–è¯‘åŸç†ï¼Œå…¶å®åº”è¯¥å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°ä¸€ä¸ªè¯æ³•åˆ†æå™¨èƒ½å¤Ÿæå–ç¨‹åºä¸­çš„tokenåºåˆ—ï¼Œå¹¶é€šè¿‡è¯­æ³•åˆ†æå™¨è¿›è¡Œåˆ†æè¯†åˆ«è¿™äº›tokenå…·ä½“ä¸ºä½•ç‰©ã€å®ƒä»¬ä¹‹é—´å…·ä½“æ˜¯ä»€ä¹ˆè”ç³»ï¼Œæ˜¯æ„æˆä¸€ä¸ªå‡½æ•°ï¼Œè¿˜æ˜¯æ„æˆä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿˜æ˜¯ç®€å•åˆ°å®šä¹‰äº†ä¸€ä¸ªå˜é‡ã€ä¸€ä¸ªåˆ†æ”¯æ§åˆ¶è¯­å¥ï¼Œç­‰ç­‰ã€‚åªè¦è¯†åˆ«å‡ºæ¥äº†ï¼Œå°†è¿™äº›ä¸åŒçš„ç¨‹åºæ„é€ è¿›è¡Œé«˜äº®æ˜¾ç¤ºè‡ªç„¶ä¸å†å›°éš¾ã€‚\nåŠ¨æ‰‹å®è·µ # æˆ‘ä»¬å°±ä»¥goè¯­è¨€ä¸ºä¾‹ï¼Œæ¥å…·ä½“è®¨è®ºä¸‹å¦‚ä½•å¯¹æºç è¿›è¡Œé«˜äº®æ˜¾ç¤ºã€‚è‡ªç„¶æˆ‘ä»¬ä¸å¸Œæœ›é‡æ–°å®ç°ä¸€éè¯æ³•åˆ†æå™¨ã€è¯­æ³•åˆ†æå™¨ä¹‹ç±»çš„çç¢å·¥ä½œï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰ç²¾åŠ›å»é‡æ–°å®ç°ä¸€éè¿™ç±»å·¥ä½œã€‚å°½ç®¡flexã€yaccå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç®€åŒ–è¿™ç±»å·¥ä½œï¼Œä½†æ˜¯goæ ‡å‡†åº“å…¶å®å·²ç»æä¾›äº†package astæ¥å¸®åŠ©æˆ‘ä»¬åšä¸€äº›è¯­æ³•åˆ†æç›¸å…³çš„å·¥ä½œã€‚æœ¬æ–‡æˆ‘ä»¬å°±åŸºäºpackage astæ¥æ¼”ç¤ºä¸‹å¦‚ä½•å¯¹goæºç è¿›è¡Œè¯­æ³•é«˜äº®ã€‚\nè®¾è®¡ä¸€ä¸ªpackage colorizeæ¥æä¾›ä¸€ä¸ªcolorize.Print(\u0026hellip;)æ–¹æ³•ï¼Œæ¥å°†æŒ‡å®šçš„æºç æ–‡ä»¶è¿›è¡Œé«˜äº®å±•ç¤ºï¼Œå¹¶ä¸”å…è®¸æŒ‡å®šæºæ–‡ä»¶çš„è¡Œå·èŒƒå›´ã€io.Writerã€é«˜äº®é¢œè‰²é£æ ¼ã€‚åªç”¨ç¼–å†™å¦‚ä¸‹å‡ ä¸ªæºæ–‡ä»¶å³å¯ï¼š\n line_writer.goï¼Œè´Ÿè´£æŒ‰è¡Œè¾“å‡ºï¼Œè¾“å‡ºçš„æ—¶å€™å…è®¸æŒ‡å®štokenã€é«˜äº®é¢œè‰²é£æ ¼ï¼ŒtokenåŒ…å«äº†èµ·å§‹ä½ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥é…åˆé¢œè‰²ï¼Œå³å¯å®Œæˆå¯¹ç‰¹å®šå…³é”®å­—ã€æ ‡è¯†ç¬¦ã€æ³¨é‡Šç­‰ä¸åŒç¨‹åºæ„é€ çš„é«˜äº®æ˜¾ç¤ºï¼› colorize.goï¼Œè´Ÿè´£è¯»å–æºæ–‡ä»¶å¹¶å¯¹å…¶è¿›è¡ŒASTåˆ†æï¼Œå°†å…¶ä¸­æˆ‘ä»¬è¦é«˜äº®çš„ä¸€äº›ç¨‹åºæ„é€ æå–å‡ºæ¥ï¼Œå¦‚å…³é”®å­—packageã€varã€funcç­‰ä½œä¸ºtokenæå–å‡ºæ¥ï¼Œå¹¶æ„é€ ä¸€ä¸ªcolorTokï¼ˆåŒ…å«äº†tokenæœ¬èº«ä½ç½®ä¿¡æ¯ã€å±äºå“ªä¸€ç±»åˆ«ï¼Œè¿™é‡Œçš„ç±»åˆ«å†³å®šäº†æœ€ç»ˆçš„é¢œè‰²é£æ ¼ï¼‰ï¼› style.goï¼Œå³é«˜äº®æ˜¾ç¤ºé£æ ¼ï¼Œä¸åŒç±»åˆ«å¯¹åº”ç€ä¸åŒçš„ç»ˆç«¯é¢œè‰²ï¼›  ä¸‹é¢å°±æ˜¯å…·ä½“çš„æºç å®ç°äº†ï¼Œå…¶å®è¿™é‡Œçš„æºç æºè‡ªgo-delve/delveï¼Œæˆ‘åœ¨ç¼–å†™debugger101ç›¸å…³çš„demoæ—¶å‘ç°äº†go-delve/delveä¸­å­˜åœ¨çš„bugï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¿®å¤ï¼Œè¿™é‡Œä¹Ÿç®—æ˜¯ç®€å•è®°å½•åˆ†äº«ä¸€ä¸‹å§ã€‚åŒå­¦ä»¬çœŸæ­£æœ‰æœºä¼šå»å°è¯•è¿™ä¸ªçš„ä¹Ÿä¸å¤šã€‚\nfile: colorize.go # // Package colorize use AST analysis to analyze the source and colorize the different kinds // of literals, like keywords, imported packages, etc. // // If you want to highlight source parts, for example, the identifiers. // - firstly, colorTok must be generated by `emit(token.IDENT, n.Pos(), n.End())` in colorize.go // - secondly, we should map the token.IDENT to some style in style.go // - thirdly, we should define the color escape in terminal.go package colorize import ( \u0026quot;go/ast\u0026quot; \u0026quot;go/parser\u0026quot; \u0026quot;go/token\u0026quot; \u0026quot;io\u0026quot; \u0026quot;io/ioutil\u0026quot; \u0026quot;path/filepath\u0026quot; \u0026quot;reflect\u0026quot; \u0026quot;sort\u0026quot; ) // Print prints to out a syntax highlighted version of the text read from // path, between lines startLine and endLine. func Print(out io.Writer, path string, startLine, endLine, arrowLine int, colorEscapes map[Style]string) error { buf, err := ioutil.ReadFile(path) if err != nil { return err } w := \u0026amp;lineWriter{w: out, lineRange: [2]int{startLine, endLine}, arrowLine: arrowLine, colorEscapes: colorEscapes} var fset token.FileSet f, err := parser.ParseFile(\u0026amp;fset, path, buf, parser.ParseComments) if err != nil { w.Write(NormalStyle, buf, true) return nil } var base int fset.Iterate(func(file *token.File) bool { base = file.Base() return false }) type colorTok struct { tok token.Token // the token type or ILLEGAL for keywords start, end int // start and end positions of the token } toks := []colorTok{} emit := func(tok token.Token, start, end token.Pos) { if _, ok := tokenToStyle[tok]; !ok { return } start -= token.Pos(base) if end == token.NoPos { // end == token.NoPos it's a keyword and we have to find where it ends by looking at the file for end = start; end \u0026lt; token.Pos(len(buf)); end++ { if buf[end] \u0026lt; 'a' || buf[end] \u0026gt; 'z' { break } } } else { end -= token.Pos(base) } if start \u0026lt; 0 || start \u0026gt;= end || end \u0026gt; token.Pos(len(buf)) { // invalid token? return } toks = append(toks, colorTok{tok, int(start), int(end)}) } for _, cgrp := range f.Comments { for _, cmnt := range cgrp.List { emit(token.COMMENT, cmnt.Pos(), cmnt.End()) } } ast.Inspect(f, func(n ast.Node) bool { if n == nil { return true } switch n := n.(type) { case *ast.File: emit(token.PACKAGE, f.Package, token.NoPos) return true case *ast.BasicLit: emit(n.Kind, n.Pos(), n.End()) return true case *ast.Ident: // TODO(aarzilli): builtin functions? basic types? return true case *ast.IfStmt: emit(token.IF, n.If, token.NoPos) if n.Else != nil { for elsepos := int(n.Body.End()) - base; elsepos \u0026lt; len(buf)-4; elsepos++ { if string(buf[elsepos:][:4]) == \u0026quot;else\u0026quot; { emit(token.ELSE, token.Pos(elsepos+base), token.Pos(elsepos+base+4)) break } } } return true } nval := reflect.ValueOf(n) if nval.Kind() != reflect.Ptr { return true } nval = nval.Elem() if nval.Kind() != reflect.Struct { return true } tokposval := nval.FieldByName(\u0026quot;TokPos\u0026quot;) tokval := nval.FieldByName(\u0026quot;Tok\u0026quot;) if tokposval != (reflect.Value{}) \u0026amp;\u0026amp; tokval != (reflect.Value{}) { emit(tokval.Interface().(token.Token), tokposval.Interface().(token.Pos), token.NoPos) } for _, kwname := range []string{\u0026quot;Case\u0026quot;, \u0026quot;Begin\u0026quot;, \u0026quot;Defer\u0026quot;, \u0026quot;Package\u0026quot;, \u0026quot;For\u0026quot;, \u0026quot;Func\u0026quot;, \u0026quot;Go\u0026quot;, \u0026quot;Interface\u0026quot;, \u0026quot;Map\u0026quot;, \u0026quot;Return\u0026quot;, \u0026quot;Select\u0026quot;, \u0026quot;Struct\u0026quot;, \u0026quot;Switch\u0026quot;} { kwposval := nval.FieldByName(kwname) if kwposval != (reflect.Value{}) { kwpos, ok := kwposval.Interface().(token.Pos) if ok \u0026amp;\u0026amp; kwpos != token.NoPos { emit(token.ILLEGAL, kwpos, token.NoPos) } } } return true }) sort.Slice(toks, func(i, j int) bool { return toks[i].start \u0026lt; toks[j].start }) flush := func(start, end int, style Style) { if start \u0026lt; end { w.Write(style, buf[start:end], end == len(buf)) } } cur := 0 for _, tok := range toks { flush(cur, tok.start, NormalStyle) flush(tok.start, tok.end, tokenToStyle[tok.tok]) cur = tok.end } if cur != len(buf) { flush(cur, len(buf), NormalStyle) } return nil }  file: style.go # package colorize import \u0026quot;go/token\u0026quot; // Style describes the style of a chunk of text. type Style uint8 const ( NormalStyle Style = iota KeywordStyle StringStyle NumberStyle CommentStyle LineNoStyle ArrowStyle ) var tokenToStyle = map[token.Token]Style{ token.ILLEGAL: KeywordStyle, token.COMMENT: CommentStyle, token.INT: NumberStyle, token.FLOAT: NumberStyle, token.IMAG: NumberStyle, token.CHAR: StringStyle, token.STRING: StringStyle, token.BREAK: KeywordStyle, token.CASE: KeywordStyle, token.CHAN: KeywordStyle, token.CONST: KeywordStyle, token.CONTINUE: KeywordStyle, token.DEFAULT: KeywordStyle, token.DEFER: KeywordStyle, token.ELSE: KeywordStyle, token.FALLTHROUGH: KeywordStyle, token.FOR: KeywordStyle, token.FUNC: KeywordStyle, token.GO: KeywordStyle, token.GOTO: KeywordStyle, token.IF: KeywordStyle, token.IMPORT: KeywordStyle, token.INTERFACE: KeywordStyle, token.MAP: KeywordStyle, token.PACKAGE: KeywordStyle, token.RANGE: KeywordStyle, token.RETURN: KeywordStyle, token.SELECT: KeywordStyle, token.STRUCT: KeywordStyle, token.SWITCH: KeywordStyle, token.TYPE: KeywordStyle, token.VAR: KeywordStyle, }  file: line_writer.go # package colorize import ( \u0026quot;fmt\u0026quot; \u0026quot;io\u0026quot; ) type lineWriter struct { w io.Writer lineRange [2]int arrowLine int curStyle Style started bool lineno int colorEscapes map[Style]string } func (w *lineWriter) style(style Style) { if w.colorEscapes == nil { return } esc := w.colorEscapes[style] if esc == \u0026quot;\u0026quot; { esc = w.colorEscapes[NormalStyle] } fmt.Fprintf(w.w, \u0026quot;%s\u0026quot;, esc) } func (w *lineWriter) inrange() bool { lno := w.lineno if !w.started { lno = w.lineno + 1 } return lno \u0026gt;= w.lineRange[0] \u0026amp;\u0026amp; lno \u0026lt; w.lineRange[1] } func (w *lineWriter) nl() { w.lineno++ if !w.inrange() || !w.started { return } w.style(ArrowStyle) if w.lineno == w.arrowLine { fmt.Fprintf(w.w, \u0026quot;=\u0026gt;\u0026quot;) } else { fmt.Fprintf(w.w, \u0026quot; \u0026quot;) } w.style(LineNoStyle) fmt.Fprintf(w.w, \u0026quot;%4d:\\t\u0026quot;, w.lineno) w.style(w.curStyle) } func (w *lineWriter) writeInternal(style Style, data []byte) { if !w.inrange() { return } if !w.started { w.started = true w.curStyle = style w.nl() } else if w.curStyle != style { w.curStyle = style w.style(w.curStyle) } w.w.Write(data) } func (w *lineWriter) Write(style Style, data []byte, last bool) { cur := 0 for i := range data { if data[i] == '\\n' { if last \u0026amp;\u0026amp; i == len(data)-1 { w.writeInternal(style, data[cur:i]) if w.curStyle != NormalStyle { w.style(NormalStyle) } if w.inrange() { w.w.Write([]byte{'\\n'}) } last = false } else { w.writeInternal(style, data[cur:i+1]) w.nl() } cur = i + 1 } } if cur \u0026lt; len(data) { w.writeInternal(style, data[cur:]) } if last { if w.curStyle != NormalStyle { w.style(NormalStyle) } if w.inrange() { w.w.Write([]byte{'\\n'}) } } }  è¿è¡Œæµ‹è¯• # ä¸‹é¢æ˜¯æµ‹è¯•æ–‡ä»¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªè¡¨ç¤ºæºç å†…å®¹çš„å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡gomonkey mockæ‰äº†ioutil.ReadFile(\u0026hellip;)çš„æ“ä½œè®©å…¶è¿”å›å®šä¹‰çš„æºç å­—ç¬¦ä¸²ï¼Œç„¶åæ‰§è¡Œcolorize.Print(\u0026hellip;)å¯¹å…¶è¿›è¡Œé«˜äº®æ˜¾ç¤ºã€‚\nfile: colorize_test.go\npackage colorize_test import ( \u0026quot;bytes\u0026quot; \u0026quot;fmt\u0026quot; \u0026quot;io/ioutil\u0026quot; \u0026quot;reflect\u0026quot; \u0026quot;testing\u0026quot; \u0026quot;github.com/agiledragon/gomonkey/v2\u0026quot; \u0026quot;github.com/hitzhangjie/dlv/pkg/terminal/colorize\u0026quot; ) var src = `package main // Vehicle defines the vehicle behavior type Vehicle interface{ // Run vehicle can run in a speed Run() } // BMWS1000RR defines the motocycle bmw s1000rr type BMWS1000RR struct { } // Run bwm s1000rr run func (a *BMWS1000RR) Run() { println(\u0026quot;I can run at 300km/h\u0026quot;) } func main() { var vehicle = \u0026amp;BMWS1000RR{} vehicle.Run() } ` const terminalHighlightEscapeCode string = \u0026quot;\\033[%2dm\u0026quot; const ( ansiBlack = 30 ansiRed = 31 ansiGreen = 32 ansiYellow = 33 ansiBlue = 34 ansiMagenta = 35 ansiCyan = 36 ansiWhite = 37 ansiBrBlack = 90 ansiBrRed = 91 ansiBrGreen = 92 ansiBrYellow = 93 ansiBrBlue = 94 ansiBrMagenta = 95 ansiBrCyan = 96 ansiBrWhite = 97 ) func colorizeCode(code int) string { return fmt.Sprintf(terminalHighlightEscapeCode, code) } var colors = map[colorize.Style]string{ colorize.KeywordStyle: colorizeCode(ansiYellow), colorize.ArrowStyle: colorizeCode(ansiBlue), colorize.CommentStyle: colorizeCode(ansiGreen), colorize.LineNoStyle: colorizeCode(ansiBrWhite), colorize.NormalStyle: colorizeCode(ansiBrWhite), colorize.NumberStyle: colorizeCode(ansiBrCyan), colorize.StringStyle: colorizeCode(ansiBrBlue), } func TestPrint(t *testing.T) { p := gomonkey.ApplyFunc(ioutil.ReadFile, func(name string) ([]byte, error) { return []byte(src), nil }) defer p.Reset() buf := \u0026amp;bytes.Buffer{} colorize.Print(buf, \u0026quot;main.go\u0026quot;, bytes.NewBufferString(src), 1, 30, 10, colors) colorize.Print(os.Stdout, \u0026quot;main.go\u0026quot;, bytes.NewBufferString(src), 1, 30, 10, colors) }  ç°åœ¨è¿è¡Œè¿™ä¸ªæµ‹è¯•ç”¨ä¾‹go test -run TestPrintï¼Œç¨‹åºè¿è¡Œç»“æœå¦‚ä¸‹ï¼š\næˆ‘ä»¬çœ‹åˆ°ç¨‹åºä¸­çš„éƒ¨åˆ†ç¨‹åºå…ƒç´ è¢«é«˜äº®æ˜¾ç¤ºäº†ï¼Œå½“ç„¶æˆ‘ä»¬åªè¯†åˆ«äº†ç®€å•çš„ä¸€å°éƒ¨åˆ†ï¼Œå…³é”®å­—ã€å­—ç¬¦ä¸²ã€æ³¨é‡Šï¼Œå®é™…IDEä¸­ä¼šåˆ†æçš„æ›´åŠ çš„ç»†è‡´ï¼Œå¤§å®¶åœ¨ä½¿ç”¨IDEçš„æ—¶å€™åº”è¯¥ä¹Ÿéƒ½æœ‰è¿™æ–¹é¢çš„ä½“ä¼šã€‚\næœ¬æ–‡å°ç»“ # æœ¬æ–‡ç®€å•æ€»ç»“äº†å¦‚ä½•åŸºäºgo astå¯¹æºä»£ç è¿›è¡Œè¯­æ³•åˆ†æå¹¶è¿›è¡Œé«˜äº®æ˜¾ç¤ºï¼Œå¸Œæœ›è¯»è€…èƒ½äº†è§£åˆ°è¿™é‡Œçš„çŸ¥è¯†ç‚¹ï¼Œå¹¶èƒ½è®¤è¯†åˆ°ç¼–è¯‘åŸç†çš„ç›¸å…³çŸ¥è¯†çœŸçš„æ˜¯å¯ä»¥ç”¨æ¥åšäº›æœ‰ä»·å€¼ã€æœ‰æ„æ€çš„ä¸œè¥¿çš„ã€‚å†æ¯”å¦‚ï¼Œæˆ‘ä»¬å®ç°ä¸€äº›linterså¯¹æºç è¿›è¡Œæ£€æŸ¥ï¼ˆå¦‚golangci-linterï¼‰ï¼Œä½œè€…ä¹‹å‰è¿˜å†™è¿‡ä¸€ç¯‡æ–‡ç« æ˜¯è®²è¿°å¦‚ä½•å¯¹goç¨‹åºè¿›è¡Œå¯è§†åŒ–ï¼Œæœ‰äº›IDEè¿˜æ”¯æŒè‡ªåŠ¨ç”Ÿæˆclassgramã€callgraphç­‰ç­‰ï¼Œè¿™äº›ä¹Ÿæ˜¯å¯¹go astçš„å¦ä¸€ç§åº”ç”¨ã€‚\næ–°çš„ä¸€å¹´ä¸å¤§å®¶å…±å‹‰ï¼Œåšæœ‰è¿½æ±‚çš„å·¥ç¨‹å¸ˆï¼ŒçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶ :)\n"}),a.add({id:90,href:"/tags/b+tree/",title:"B+Tree",description:"",content:""}),a.add({id:91,href:"/tags/btree/",title:"BTree",description:"",content:""}),a.add({id:92,href:"/tags/explain/",title:"explain",description:"",content:""}),a.add({id:93,href:"/tags/index/",title:"index",description:"",content:""}),a.add({id:94,href:"/tags/mysql/",title:"mysql",description:"",content:""}),a.add({id:95,href:"/blog/2022-01-06-mysql%E6%9F%A5%E8%AF%A2%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/",title:"MySQLæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–",description:"ã€è½¬ã€‘MySQLä¼˜åŒ–åŸç†ï¼Œhttps://www.cnblogs.com/zhangyinhua/p/7620964.html\nè¯´èµ·MySQLçš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œç›¸ä¿¡å¤§å®¶ç§¯ç´¯ä¸€å †æŠ€å·§ï¼šä¸èƒ½ä½¿ç”¨SELECT *ã€ä¸ä½¿ç”¨NULLå­—æ®µã€åˆç†åˆ›å»ºç´¢å¼•ã€ä¸ºå­—æ®µé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹â€¦.. ä½ æ˜¯å¦çœŸçš„ç†è§£è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Ÿæ˜¯å¦ç†è§£å…¶èƒŒåçš„å·¥ä½œåŸç†ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸‹æ€§èƒ½çœŸæœ‰æå‡å—ï¼Ÿ\næˆ‘æƒ³æœªå¿…ã€‚å› è€Œç†è§£è¿™äº›ä¼˜åŒ–å»ºè®®èƒŒåçš„åŸç†å°±å°¤ä¸ºé‡è¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ é‡æ–°å®¡è§†è¿™äº›ä¼˜åŒ–å»ºè®®ï¼Œå¹¶åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸‹åˆç†çš„è¿ç”¨ã€‚\n  img { width: 680px; padding-bottom: 1rem; }  MySQLé€»è¾‘æ¶æ„ # å¦‚æœèƒ½åœ¨å¤´è„‘ä¸­æ„å»ºä¸€å¹…MySQLå„ç»„ä»¶ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œçš„æ¶æ„å›¾ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£MySQLæœåŠ¡å™¨ã€‚ä¸‹å›¾å±•ç¤ºäº†MySQLçš„é€»è¾‘æ¶æ„å›¾ã€‚\nMySQLé€»è¾‘æ¶æ„ï¼Œæ¥è‡ªï¼šé«˜æ€§èƒ½MySQL\nMySQLé€»è¾‘æ¶æ„æ•´ä½“åˆ†ä¸ºä¸‰å±‚ï¼Œæœ€ä¸Šå±‚ä¸ºå®¢æˆ·ç«¯å±‚ï¼Œå¹¶éMySQLæ‰€ç‹¬æœ‰ï¼Œè¯¸å¦‚ï¼šè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€å®‰å…¨ç­‰åŠŸèƒ½å‡åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚\nMySQLå¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡å‡åœ¨ä¸­é—´è¿™ä¸€å±‚ï¼ŒåŒ…æ‹¬æŸ¥è¯¢è§£æã€åˆ†æã€ä¼˜åŒ–ã€ç¼“å­˜ã€å†…ç½®å‡½æ•°(æ¯”å¦‚ï¼šæ—¶é—´ã€æ•°å­¦ã€åŠ å¯†ç­‰å‡½æ•°)ã€‚æ‰€æœ‰çš„è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼šå­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚\næœ€ä¸‹å±‚ä¸ºå­˜å‚¨å¼•æ“ï¼Œå…¶è´Ÿè´£MySQLä¸­çš„æ•°æ®å­˜å‚¨å’Œæå–ã€‚å’ŒLinuxä¸‹çš„æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ¯ç§å­˜å‚¨å¼•æ“éƒ½æœ‰å…¶ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚ä¸­é—´çš„æœåŠ¡å±‚é€šè¿‡APIä¸å­˜å‚¨å¼•æ“é€šä¿¡ï¼Œè¿™äº›APIæ¥å£å±è”½äº†ä¸åŒå­˜å‚¨å¼•æ“é—´çš„å·®å¼‚ã€‚\n MySQLæŸ¥è¯¢è¿‡ç¨‹ # æˆ‘ä»¬æ€»æ˜¯å¸Œæœ›MySQLèƒ½å¤Ÿè·å¾—æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å¼„æ¸…æ¥šMySQLæ˜¯å¦‚ä½•ä¼˜åŒ–å’Œæ‰§è¡ŒæŸ¥è¯¢çš„ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±ä¼šå‘ç°ï¼šå¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®©MySQLçš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²ã€‚\nå½“å‘MySQLå‘é€ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒMySQLåˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ\nMySQLæŸ¥è¯¢è¿‡ç¨‹\nå®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®® # MySQLå®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®®æ˜¯â€œåŠåŒå·¥â€çš„ï¼šåœ¨ä»»ä¸€æ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ä¸€æ—¦ä¸€ç«¯å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ç«¯è¦æ¥æ”¶å®Œæ•´ä¸ªæ¶ˆæ¯æ‰èƒ½å“åº”å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¹Ÿæ— é¡»å°†ä¸€ä¸ªæ¶ˆæ¯åˆ‡æˆå°å—ç‹¬ç«‹å‘é€ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚\nå®¢æˆ·ç«¯ç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…å°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¯­å¥å¾ˆé•¿çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®max_allowed_packetå‚æ•°ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢å®åœ¨æ˜¯å¤ªå¤§ï¼ŒæœåŠ¡ç«¯ä¼šæ‹’ç»æ¥æ”¶æ›´å¤šæ•°æ®å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚\nä¸ä¹‹ç›¸åçš„æ˜¯ï¼ŒæœåŠ¡å™¨å“åº”ç»™ç”¨æˆ·çš„æ•°æ®é€šå¸¸ä¼šå¾ˆå¤šï¼Œç”±å¤šä¸ªæ•°æ®åŒ…ç»„æˆã€‚ä½†æ˜¯å½“æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»å®Œæ•´çš„æ¥æ”¶æ•´ä¸ªè¿”å›ç»“æœï¼Œè€Œä¸èƒ½ç®€å•çš„åªå–å‰é¢å‡ æ¡ç»“æœï¼Œç„¶åè®©æœåŠ¡å™¨åœæ­¢å‘é€ã€‚å› è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå°½é‡ä¿æŒæŸ¥è¯¢ç®€å•ä¸”åªè¿”å›å¿…éœ€çš„æ•°æ®ï¼Œå‡å°é€šä¿¡é—´æ•°æ®åŒ…çš„å¤§å°å’Œæ•°é‡æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯æŸ¥è¯¢ä¸­å°½é‡é¿å…ä½¿ç”¨SELECT *ä»¥åŠåŠ ä¸ŠLIMITé™åˆ¶çš„åŸå› ä¹‹ä¸€ã€‚\næŸ¥è¯¢ç¼“å­˜ # åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆMySQLä¼šæ£€æŸ¥è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœå½“å‰æŸ¥è¯¢æ°å¥½å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œåœ¨æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æƒé™åç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸ä¼šè¢«è§£æï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ›´ä¸ä¼šæ‰§è¡Œã€‚\nMySQLå°†ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ï¼ˆä¸è¦ç†è§£æˆtableï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç±»ä¼¼äºHashMapçš„æ•°æ®ç»“æ„ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼ç´¢å¼•ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼é€šè¿‡æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯è®¡ç®—å¾—æ¥ã€‚æ‰€ä»¥ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼ˆä¾‹å¦‚ï¼šç©ºæ ¼ã€æ³¨é‡Šï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¼šå‘½ä¸­ã€‚\nå¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€mysqlåº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœéƒ½ä¸ä¼šè¢«ç¼“å­˜ã€‚æ¯”å¦‚å‡½æ•°NOW()æˆ–è€…CURRENT_DATE()ä¼šå› ä¸ºä¸åŒçš„æŸ¥è¯¢æ—¶é—´ï¼Œè¿”å›ä¸åŒçš„æŸ¥è¯¢ç»“æœï¼Œå†æ¯”å¦‚åŒ…å«CURRENT_USERæˆ–è€…CONNECION_ID()çš„æŸ¥è¯¢è¯­å¥ä¼šå› ä¸ºä¸åŒçš„ç”¨æˆ·è€Œè¿”å›ä¸åŒçš„ç»“æœï¼Œå°†è¿™æ ·çš„æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰ã€‚\næ—¢ç„¶æ˜¯ç¼“å­˜ï¼Œå°±ä¼šå¤±æ•ˆï¼Œé‚£æŸ¥è¯¢ç¼“å­˜ä½•æ—¶å¤±æ•ˆå‘¢ï¼Ÿã€€MySQLçš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä»»ä½•çš„å†™æ“ä½œæ—¶ï¼ŒMySQLå¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ä¸ºå¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ï¼Œç”šè‡³å¯¼è‡´ç³»ç»Ÿåƒµæ­»ä¸€ä¼šå„¿ã€‚è€Œä¸”æŸ¥è¯¢ç¼“å­˜å¯¹ç³»ç»Ÿçš„é¢å¤–æ¶ˆè€—ä¹Ÿä¸ä»…ä»…åœ¨å†™æ“ä½œï¼Œè¯»æ“ä½œä¹Ÿä¸ä¾‹å¤–ï¼š\n ä»»ä½•çš„æŸ¥è¯¢è¯­å¥åœ¨å¼€å§‹ä¹‹å‰éƒ½å¿…é¡»ç»è¿‡æ£€æŸ¥ï¼Œå³ä½¿è¿™æ¡SQLè¯­å¥æ°¸è¿œä¸ä¼šå‘½ä¸­ç¼“å­˜ å¦‚æœæŸ¥è¯¢ç»“æœå¯ä»¥è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€—  åŸºäºæ­¤ï¼Œæˆ‘ä»¬è¦çŸ¥é“å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œç¼“å­˜å’Œå¤±æ•ˆéƒ½ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—ï¼Œåªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«æ¶ˆè€—çš„èµ„æºæ—¶ï¼Œæ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡ã€‚ä½†è¦å¦‚ä½•è¯„ä¼°æ‰“å¼€ç¼“å­˜æ˜¯å¦èƒ½å¤Ÿå¸¦æ¥æ€§èƒ½æå‡æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹æƒ…ï¼Œä¹Ÿä¸åœ¨æœ¬æ–‡è®¨è®ºçš„èŒƒç•´å†…ã€‚å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š\n ç”¨å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼Œæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡ æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥ åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚ å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜  æœ€åçš„å¿ å‘Šæ˜¯ä¸è¦è½»æ˜“æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯å†™å¯†é›†å‹åº”ç”¨ã€‚å¦‚æœä½ å®åœ¨æ˜¯å¿ä¸ä½ï¼Œå¯ä»¥å°†query_cache_typeè®¾ç½®ä¸ºDEMANDï¼Œè¿™æ—¶åªæœ‰åŠ å…¥SQL_CACHEçš„æŸ¥è¯¢æ‰ä¼šèµ°ç¼“å­˜ï¼Œå…¶ä»–æŸ¥è¯¢åˆ™ä¸ä¼šï¼Œè¿™æ ·å¯ä»¥éå¸¸è‡ªç”±åœ°æ§åˆ¶å“ªäº›æŸ¥è¯¢éœ€è¦è¢«ç¼“å­˜ã€‚\nå½“ç„¶æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿæœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œè®¨è®ºçš„ä¹Ÿåªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–æ›´æ·±å…¥çš„è¯é¢˜ï¼Œæ¯”å¦‚ï¼šç¼“å­˜æ˜¯å¦‚ä½•ä½¿ç”¨å†…å­˜çš„ï¼Ÿå¦‚ä½•æ§åˆ¶å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Ÿäº‹åŠ¡å¯¹æŸ¥è¯¢ç¼“å­˜æœ‰ä½•å½±å“ç­‰ç­‰ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæƒå½“æŠ›ç –å¼•ç‰å§ã€‚\nè¯­æ³•è§£æå’Œé¢„å¤„ç† # MySQLé€šè¿‡å…³é”®å­—å°†SQLè¯­å¥è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„è§£ææ ‘ã€‚è¿™ä¸ªè¿‡ç¨‹è§£æå™¨ä¸»è¦é€šè¿‡è¯­æ³•è§„åˆ™æ¥éªŒè¯å’Œè§£æã€‚æ¯”å¦‚SQLä¸­æ˜¯å¦ä½¿ç”¨äº†é”™è¯¯çš„å…³é”®å­—æˆ–è€…å…³é”®å­—çš„é¡ºåºæ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚é¢„å¤„ç†åˆ™ä¼šæ ¹æ®MySQLè§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ã€‚æ¯”å¦‚æ£€æŸ¥è¦æŸ¥è¯¢çš„æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ç­‰ç­‰ã€‚\næŸ¥è¯¢ä¼˜åŒ– # ç»è¿‡å‰é¢çš„æ­¥éª¤ç”Ÿæˆçš„è¯­æ³•æ ‘è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„äº†ï¼Œå¹¶ä¸”ç”±ä¼˜åŒ–å™¨å°†å…¶è½¬åŒ–æˆæŸ¥è¯¢è®¡åˆ’ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åº”çš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚\nMySQLä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œå®ƒå°è¯•é¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬ï¼Œå¹¶é€‰æ‹©å…¶ä¸­æˆæœ¬æœ€å°çš„ä¸€ä¸ªã€‚åœ¨MySQLå¯ä»¥é€šè¿‡æŸ¥è¯¢å½“å‰ä¼šè¯çš„last_query_costçš„å€¼æ¥å¾—åˆ°å…¶è®¡ç®—å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚\nMysqlä»£ç \nmysql\u0026gt; select * from t_message limit 10; ...çœç•¥ç»“æœé›† mysql\u0026gt; show status like 'last_query_cost'; +-----------------+-------------+ | Variable_name | Value | +-----------------+-------------+ | Last_query_cost | 6391.",content:"ã€è½¬ã€‘MySQLä¼˜åŒ–åŸç†ï¼Œhttps://www.cnblogs.com/zhangyinhua/p/7620964.html\nè¯´èµ·MySQLçš„æŸ¥è¯¢ä¼˜åŒ–ï¼Œç›¸ä¿¡å¤§å®¶ç§¯ç´¯ä¸€å †æŠ€å·§ï¼šä¸èƒ½ä½¿ç”¨SELECT *ã€ä¸ä½¿ç”¨NULLå­—æ®µã€åˆç†åˆ›å»ºç´¢å¼•ã€ä¸ºå­—æ®µé€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹â€¦.. ä½ æ˜¯å¦çœŸçš„ç†è§£è¿™äº›ä¼˜åŒ–æŠ€å·§ï¼Ÿæ˜¯å¦ç†è§£å…¶èƒŒåçš„å·¥ä½œåŸç†ï¼Ÿåœ¨å®é™…åœºæ™¯ä¸‹æ€§èƒ½çœŸæœ‰æå‡å—ï¼Ÿ\næˆ‘æƒ³æœªå¿…ã€‚å› è€Œç†è§£è¿™äº›ä¼˜åŒ–å»ºè®®èƒŒåçš„åŸç†å°±å°¤ä¸ºé‡è¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½è®©ä½ é‡æ–°å®¡è§†è¿™äº›ä¼˜åŒ–å»ºè®®ï¼Œå¹¶åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸‹åˆç†çš„è¿ç”¨ã€‚\n  img { width: 680px; padding-bottom: 1rem; }  MySQLé€»è¾‘æ¶æ„ # å¦‚æœèƒ½åœ¨å¤´è„‘ä¸­æ„å»ºä¸€å¹…MySQLå„ç»„ä»¶ä¹‹é—´å¦‚ä½•ååŒå·¥ä½œçš„æ¶æ„å›¾ï¼Œæœ‰åŠ©äºæ·±å…¥ç†è§£MySQLæœåŠ¡å™¨ã€‚ä¸‹å›¾å±•ç¤ºäº†MySQLçš„é€»è¾‘æ¶æ„å›¾ã€‚\nMySQLé€»è¾‘æ¶æ„ï¼Œæ¥è‡ªï¼šé«˜æ€§èƒ½MySQL\nMySQLé€»è¾‘æ¶æ„æ•´ä½“åˆ†ä¸ºä¸‰å±‚ï¼Œæœ€ä¸Šå±‚ä¸ºå®¢æˆ·ç«¯å±‚ï¼Œå¹¶éMySQLæ‰€ç‹¬æœ‰ï¼Œè¯¸å¦‚ï¼šè¿æ¥å¤„ç†ã€æˆæƒè®¤è¯ã€å®‰å…¨ç­‰åŠŸèƒ½å‡åœ¨è¿™ä¸€å±‚å¤„ç†ã€‚\nMySQLå¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡å‡åœ¨ä¸­é—´è¿™ä¸€å±‚ï¼ŒåŒ…æ‹¬æŸ¥è¯¢è§£æã€åˆ†æã€ä¼˜åŒ–ã€ç¼“å­˜ã€å†…ç½®å‡½æ•°(æ¯”å¦‚ï¼šæ—¶é—´ã€æ•°å­¦ã€åŠ å¯†ç­‰å‡½æ•°)ã€‚æ‰€æœ‰çš„è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼šå­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚\næœ€ä¸‹å±‚ä¸ºå­˜å‚¨å¼•æ“ï¼Œå…¶è´Ÿè´£MySQLä¸­çš„æ•°æ®å­˜å‚¨å’Œæå–ã€‚å’ŒLinuxä¸‹çš„æ–‡ä»¶ç³»ç»Ÿç±»ä¼¼ï¼Œæ¯ç§å­˜å‚¨å¼•æ“éƒ½æœ‰å…¶ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚ä¸­é—´çš„æœåŠ¡å±‚é€šè¿‡APIä¸å­˜å‚¨å¼•æ“é€šä¿¡ï¼Œè¿™äº›APIæ¥å£å±è”½äº†ä¸åŒå­˜å‚¨å¼•æ“é—´çš„å·®å¼‚ã€‚\n MySQLæŸ¥è¯¢è¿‡ç¨‹ # æˆ‘ä»¬æ€»æ˜¯å¸Œæœ›MySQLèƒ½å¤Ÿè·å¾—æ›´é«˜çš„æŸ¥è¯¢æ€§èƒ½ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å¼„æ¸…æ¥šMySQLæ˜¯å¦‚ä½•ä¼˜åŒ–å’Œæ‰§è¡ŒæŸ¥è¯¢çš„ã€‚ä¸€æ—¦ç†è§£äº†è¿™ä¸€ç‚¹ï¼Œå°±ä¼šå‘ç°ï¼šå¾ˆå¤šçš„æŸ¥è¯¢ä¼˜åŒ–å·¥ä½œå®é™…ä¸Šå°±æ˜¯éµå¾ªä¸€äº›åŸåˆ™è®©MySQLçš„ä¼˜åŒ–å™¨èƒ½å¤ŸæŒ‰ç…§é¢„æƒ³çš„åˆç†æ–¹å¼è¿è¡Œè€Œå·²ã€‚\nå½“å‘MySQLå‘é€ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒMySQLåˆ°åº•åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ\nMySQLæŸ¥è¯¢è¿‡ç¨‹\nå®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®® # MySQLå®¢æˆ·ç«¯/æœåŠ¡ç«¯é€šä¿¡åè®®æ˜¯â€œåŠåŒå·¥â€çš„ï¼šåœ¨ä»»ä¸€æ—¶åˆ»ï¼Œè¦ä¹ˆæ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ•°æ®ï¼Œè¦ä¹ˆæ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ•°æ®ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œä¸èƒ½åŒæ—¶å‘ç”Ÿã€‚ä¸€æ—¦ä¸€ç«¯å¼€å§‹å‘é€æ¶ˆæ¯ï¼Œå¦ä¸€ç«¯è¦æ¥æ”¶å®Œæ•´ä¸ªæ¶ˆæ¯æ‰èƒ½å“åº”å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•ä¹Ÿæ— é¡»å°†ä¸€ä¸ªæ¶ˆæ¯åˆ‡æˆå°å—ç‹¬ç«‹å‘é€ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•è¿›è¡Œæµé‡æ§åˆ¶ã€‚\nå®¢æˆ·ç«¯ç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åŒ…å°†æŸ¥è¯¢è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨ï¼Œæ‰€ä»¥å½“æŸ¥è¯¢è¯­å¥å¾ˆé•¿çš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®max_allowed_packetå‚æ•°ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢å®åœ¨æ˜¯å¤ªå¤§ï¼ŒæœåŠ¡ç«¯ä¼šæ‹’ç»æ¥æ”¶æ›´å¤šæ•°æ®å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚\nä¸ä¹‹ç›¸åçš„æ˜¯ï¼ŒæœåŠ¡å™¨å“åº”ç»™ç”¨æˆ·çš„æ•°æ®é€šå¸¸ä¼šå¾ˆå¤šï¼Œç”±å¤šä¸ªæ•°æ®åŒ…ç»„æˆã€‚ä½†æ˜¯å½“æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯å¿…é¡»å®Œæ•´çš„æ¥æ”¶æ•´ä¸ªè¿”å›ç»“æœï¼Œè€Œä¸èƒ½ç®€å•çš„åªå–å‰é¢å‡ æ¡ç»“æœï¼Œç„¶åè®©æœåŠ¡å™¨åœæ­¢å‘é€ã€‚å› è€Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå°½é‡ä¿æŒæŸ¥è¯¢ç®€å•ä¸”åªè¿”å›å¿…éœ€çš„æ•°æ®ï¼Œå‡å°é€šä¿¡é—´æ•°æ®åŒ…çš„å¤§å°å’Œæ•°é‡æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ï¼Œè¿™ä¹Ÿæ˜¯æŸ¥è¯¢ä¸­å°½é‡é¿å…ä½¿ç”¨SELECT *ä»¥åŠåŠ ä¸ŠLIMITé™åˆ¶çš„åŸå› ä¹‹ä¸€ã€‚\næŸ¥è¯¢ç¼“å­˜ # åœ¨è§£æä¸€ä¸ªæŸ¥è¯¢è¯­å¥å‰ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆMySQLä¼šæ£€æŸ¥è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ä¸­çš„æ•°æ®ã€‚å¦‚æœå½“å‰æŸ¥è¯¢æ°å¥½å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œåœ¨æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æƒé™åç›´æ¥è¿”å›ç¼“å­˜ä¸­çš„ç»“æœã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸ä¼šè¢«è§£æï¼Œä¹Ÿä¸ä¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’ï¼Œæ›´ä¸ä¼šæ‰§è¡Œã€‚\nMySQLå°†ç¼“å­˜å­˜æ”¾åœ¨ä¸€ä¸ªå¼•ç”¨è¡¨ï¼ˆä¸è¦ç†è§£æˆtableï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ç±»ä¼¼äºHashMapçš„æ•°æ®ç»“æ„ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼ç´¢å¼•ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼é€šè¿‡æŸ¥è¯¢æœ¬èº«ã€å½“å‰è¦æŸ¥è¯¢çš„æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®ç‰ˆæœ¬å·ç­‰ä¸€äº›å¯èƒ½å½±å“ç»“æœçš„ä¿¡æ¯è®¡ç®—å¾—æ¥ã€‚æ‰€ä»¥ä¸¤ä¸ªæŸ¥è¯¢åœ¨ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼ˆä¾‹å¦‚ï¼šç©ºæ ¼ã€æ³¨é‡Šï¼‰ï¼Œéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸ä¼šå‘½ä¸­ã€‚\nå¦‚æœæŸ¥è¯¢ä¸­åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨å‡½æ•°ã€ç”¨æˆ·å˜é‡ã€ä¸´æ—¶è¡¨ã€mysqlåº“ä¸­çš„ç³»ç»Ÿè¡¨ï¼Œå…¶æŸ¥è¯¢ç»“æœéƒ½ä¸ä¼šè¢«ç¼“å­˜ã€‚æ¯”å¦‚å‡½æ•°NOW()æˆ–è€…CURRENT_DATE()ä¼šå› ä¸ºä¸åŒçš„æŸ¥è¯¢æ—¶é—´ï¼Œè¿”å›ä¸åŒçš„æŸ¥è¯¢ç»“æœï¼Œå†æ¯”å¦‚åŒ…å«CURRENT_USERæˆ–è€…CONNECION_ID()çš„æŸ¥è¯¢è¯­å¥ä¼šå› ä¸ºä¸åŒçš„ç”¨æˆ·è€Œè¿”å›ä¸åŒçš„ç»“æœï¼Œå°†è¿™æ ·çš„æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ„ä¹‰ã€‚\næ—¢ç„¶æ˜¯ç¼“å­˜ï¼Œå°±ä¼šå¤±æ•ˆï¼Œé‚£æŸ¥è¯¢ç¼“å­˜ä½•æ—¶å¤±æ•ˆå‘¢ï¼Ÿã€€MySQLçš„æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨ï¼ˆæ•°æ®æˆ–ç»“æ„ï¼‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™å¼ è¡¨ç›¸å…³çš„æ‰€æœ‰ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ä»»ä½•çš„å†™æ“ä½œæ—¶ï¼ŒMySQLå¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®ä¸ºå¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ï¼Œç”šè‡³å¯¼è‡´ç³»ç»Ÿåƒµæ­»ä¸€ä¼šå„¿ã€‚è€Œä¸”æŸ¥è¯¢ç¼“å­˜å¯¹ç³»ç»Ÿçš„é¢å¤–æ¶ˆè€—ä¹Ÿä¸ä»…ä»…åœ¨å†™æ“ä½œï¼Œè¯»æ“ä½œä¹Ÿä¸ä¾‹å¤–ï¼š\n ä»»ä½•çš„æŸ¥è¯¢è¯­å¥åœ¨å¼€å§‹ä¹‹å‰éƒ½å¿…é¡»ç»è¿‡æ£€æŸ¥ï¼Œå³ä½¿è¿™æ¡SQLè¯­å¥æ°¸è¿œä¸ä¼šå‘½ä¸­ç¼“å­˜ å¦‚æœæŸ¥è¯¢ç»“æœå¯ä»¥è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæˆåï¼Œä¼šå°†ç»“æœå­˜å…¥ç¼“å­˜ï¼Œä¹Ÿä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€—  åŸºäºæ­¤ï¼Œæˆ‘ä»¬è¦çŸ¥é“å¹¶ä¸æ˜¯ä»€ä¹ˆæƒ…å†µä¸‹æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šæé«˜ç³»ç»Ÿæ€§èƒ½ï¼Œç¼“å­˜å’Œå¤±æ•ˆéƒ½ä¼šå¸¦æ¥é¢å¤–æ¶ˆè€—ï¼Œåªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«æ¶ˆè€—çš„èµ„æºæ—¶ï¼Œæ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡ã€‚ä½†è¦å¦‚ä½•è¯„ä¼°æ‰“å¼€ç¼“å­˜æ˜¯å¦èƒ½å¤Ÿå¸¦æ¥æ€§èƒ½æå‡æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹æƒ…ï¼Œä¹Ÿä¸åœ¨æœ¬æ–‡è®¨è®ºçš„èŒƒç•´å†…ã€‚å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š\n ç”¨å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼Œæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡ æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥ åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚ å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜  æœ€åçš„å¿ å‘Šæ˜¯ä¸è¦è½»æ˜“æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œç‰¹åˆ«æ˜¯å†™å¯†é›†å‹åº”ç”¨ã€‚å¦‚æœä½ å®åœ¨æ˜¯å¿ä¸ä½ï¼Œå¯ä»¥å°†query_cache_typeè®¾ç½®ä¸ºDEMANDï¼Œè¿™æ—¶åªæœ‰åŠ å…¥SQL_CACHEçš„æŸ¥è¯¢æ‰ä¼šèµ°ç¼“å­˜ï¼Œå…¶ä»–æŸ¥è¯¢åˆ™ä¸ä¼šï¼Œè¿™æ ·å¯ä»¥éå¸¸è‡ªç”±åœ°æ§åˆ¶å“ªäº›æŸ¥è¯¢éœ€è¦è¢«ç¼“å­˜ã€‚\nå½“ç„¶æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿæœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œè®¨è®ºçš„ä¹Ÿåªæ˜¯å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ä»–æ›´æ·±å…¥çš„è¯é¢˜ï¼Œæ¯”å¦‚ï¼šç¼“å­˜æ˜¯å¦‚ä½•ä½¿ç”¨å†…å­˜çš„ï¼Ÿå¦‚ä½•æ§åˆ¶å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Ÿäº‹åŠ¡å¯¹æŸ¥è¯¢ç¼“å­˜æœ‰ä½•å½±å“ç­‰ç­‰ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé˜…è¯»ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œæƒå½“æŠ›ç –å¼•ç‰å§ã€‚\nè¯­æ³•è§£æå’Œé¢„å¤„ç† # MySQLé€šè¿‡å…³é”®å­—å°†SQLè¯­å¥è¿›è¡Œè§£æï¼Œå¹¶ç”Ÿæˆä¸€é¢—å¯¹åº”çš„è§£ææ ‘ã€‚è¿™ä¸ªè¿‡ç¨‹è§£æå™¨ä¸»è¦é€šè¿‡è¯­æ³•è§„åˆ™æ¥éªŒè¯å’Œè§£æã€‚æ¯”å¦‚SQLä¸­æ˜¯å¦ä½¿ç”¨äº†é”™è¯¯çš„å…³é”®å­—æˆ–è€…å…³é”®å­—çš„é¡ºåºæ˜¯å¦æ­£ç¡®ç­‰ç­‰ã€‚é¢„å¤„ç†åˆ™ä¼šæ ¹æ®MySQLè§„åˆ™è¿›ä¸€æ­¥æ£€æŸ¥è§£ææ ‘æ˜¯å¦åˆæ³•ã€‚æ¯”å¦‚æ£€æŸ¥è¦æŸ¥è¯¢çš„æ•°æ®è¡¨å’Œæ•°æ®åˆ—æ˜¯å¦å­˜åœ¨ç­‰ç­‰ã€‚\næŸ¥è¯¢ä¼˜åŒ– # ç»è¿‡å‰é¢çš„æ­¥éª¤ç”Ÿæˆçš„è¯­æ³•æ ‘è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„äº†ï¼Œå¹¶ä¸”ç”±ä¼˜åŒ–å™¨å°†å…¶è½¬åŒ–æˆæŸ¥è¯¢è®¡åˆ’ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åº”çš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’ã€‚\nMySQLä½¿ç”¨åŸºäºæˆæœ¬çš„ä¼˜åŒ–å™¨ï¼Œå®ƒå°è¯•é¢„æµ‹ä¸€ä¸ªæŸ¥è¯¢ä½¿ç”¨æŸç§æ‰§è¡Œè®¡åˆ’æ—¶çš„æˆæœ¬ï¼Œå¹¶é€‰æ‹©å…¶ä¸­æˆæœ¬æœ€å°çš„ä¸€ä¸ªã€‚åœ¨MySQLå¯ä»¥é€šè¿‡æŸ¥è¯¢å½“å‰ä¼šè¯çš„last_query_costçš„å€¼æ¥å¾—åˆ°å…¶è®¡ç®—å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚\nMysqlä»£ç \nmysql\u0026gt; select * from t_message limit 10; ...çœç•¥ç»“æœé›† mysql\u0026gt; show status like 'last_query_cost'; +-----------------+-------------+ | Variable_name | Value | +-----------------+-------------+ | Last_query_cost | 6391.799000 | +-----------------+-------------+  ç¤ºä¾‹ä¸­çš„ç»“æœè¡¨ç¤ºä¼˜åŒ–å™¨è®¤ä¸ºå¤§æ¦‚éœ€è¦åš6391ä¸ªæ•°æ®é¡µçš„éšæœºæŸ¥æ‰¾æ‰èƒ½å®Œæˆä¸Šé¢çš„æŸ¥è¯¢ã€‚è¿™ä¸ªç»“æœæ˜¯æ ¹æ®ä¸€äº›åˆ—çš„ç»Ÿè®¡ä¿¡æ¯è®¡ç®—å¾—æ¥çš„ï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯åŒ…æ‹¬ï¼šæ¯å¼ è¡¨æˆ–è€…ç´¢å¼•çš„é¡µé¢ä¸ªæ•°ã€ç´¢å¼•çš„åŸºæ•°ã€ç´¢å¼•å’Œæ•°æ®è¡Œçš„é•¿åº¦ã€ç´¢å¼•çš„åˆ†å¸ƒæƒ…å†µç­‰ç­‰ã€‚\næœ‰éå¸¸å¤šçš„åŸå› ä¼šå¯¼è‡´MySQLé€‰æ‹©é”™è¯¯çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¿¡æ¯ä¸å‡†ç¡®ã€ä¸ä¼šè€ƒè™‘ä¸å—å…¶æ§åˆ¶çš„æ“ä½œæˆæœ¬ï¼ˆç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ã€å­˜å‚¨è¿‡ç¨‹ï¼‰ã€MySQLè®¤ä¸ºçš„æœ€ä¼˜è·Ÿæˆ‘ä»¬æƒ³çš„ä¸ä¸€æ ·ï¼ˆæˆ‘ä»¬å¸Œæœ›æ‰§è¡Œæ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½†MySQLåªé€‰æ‹©å®ƒè®¤ä¸ºæˆæœ¬å°çš„ï¼Œä½†æˆæœ¬å°å¹¶ä¸æ„å‘³ç€æ‰§è¡Œæ—¶é—´çŸ­ï¼‰ç­‰ç­‰ã€‚\nMySQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„éƒ¨ä»¶ï¼Œå®ƒä½¿ç”¨äº†éå¸¸å¤šçš„ä¼˜åŒ–ç­–ç•¥æ¥ç”Ÿæˆä¸€ä¸ªæœ€ä¼˜çš„æ‰§è¡Œè®¡åˆ’ï¼š\n é‡æ–°å®šä¹‰è¡¨çš„å…³è”é¡ºåºï¼ˆå¤šå¼ è¡¨å…³è”æŸ¥è¯¢æ—¶ï¼Œå¹¶ä¸ä¸€å®šæŒ‰ç…§SQLä¸­æŒ‡å®šçš„é¡ºåºè¿›è¡Œï¼Œä½†æœ‰ä¸€äº›æŠ€å·§å¯ä»¥æŒ‡å®šå…³è”é¡ºåºï¼‰ ä¼˜åŒ–MIN()å’ŒMAX()å‡½æ•°ï¼ˆæ‰¾æŸåˆ—çš„æœ€å°å€¼ï¼Œå¦‚æœè¯¥åˆ—æœ‰ç´¢å¼•ï¼Œåªéœ€è¦æŸ¥æ‰¾B+Treeç´¢å¼•æœ€å·¦ç«¯ï¼Œåä¹‹åˆ™å¯ä»¥æ‰¾åˆ°æœ€å¤§å€¼ï¼Œå…·ä½“åŸç†è§ä¸‹æ–‡ï¼‰ æå‰ç»ˆæ­¢æŸ¥è¯¢ï¼ˆæ¯”å¦‚ï¼šä½¿ç”¨Limitæ—¶ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ•°é‡çš„ç»“æœé›†åä¼šç«‹å³ç»ˆæ­¢æŸ¥è¯¢ï¼‰ ä¼˜åŒ–æ’åºï¼ˆåœ¨è€ç‰ˆæœ¬MySQLä¼šä½¿ç”¨ä¸¤æ¬¡ä¼ è¾“æ’åºï¼Œå³å…ˆè¯»å–è¡ŒæŒ‡é’ˆå’Œéœ€è¦æ’åºçš„å­—æ®µåœ¨å†…å­˜ä¸­å¯¹å…¶æ’åºï¼Œç„¶åå†æ ¹æ®æ’åºç»“æœå»è¯»å–æ•°æ®è¡Œï¼Œè€Œæ–°ç‰ˆæœ¬é‡‡ç”¨çš„æ˜¯å•æ¬¡ä¼ è¾“æ’åºï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡è¯»å–æ‰€æœ‰çš„æ•°æ®è¡Œï¼Œç„¶åæ ¹æ®ç»™å®šçš„åˆ—æ’åºã€‚å¯¹äºI/Oå¯†é›†å‹åº”ç”¨ï¼Œæ•ˆç‡ä¼šé«˜å¾ˆå¤šï¼‰  éšç€MySQLçš„ä¸æ–­å‘å±•ï¼Œä¼˜åŒ–å™¨ä½¿ç”¨çš„ä¼˜åŒ–ç­–ç•¥ä¹Ÿåœ¨ä¸æ–­çš„è¿›åŒ–ï¼Œè¿™é‡Œä»…ä»…ä»‹ç»å‡ ä¸ªéå¸¸å¸¸ç”¨ä¸”å®¹æ˜“ç†è§£çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå…¶ä»–çš„ä¼˜åŒ–ç­–ç•¥ï¼Œå¤§å®¶è‡ªè¡ŒæŸ¥é˜…å§ã€‚\næŸ¥è¯¢æ‰§è¡Œå¼•æ“ # åœ¨å®Œæˆè§£æå’Œä¼˜åŒ–é˜¶æ®µä»¥åï¼ŒMySQLä¼šç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥è¯¢æ‰§è¡Œå¼•æ“æ ¹æ®æ‰§è¡Œè®¡åˆ’ç»™å‡ºçš„æŒ‡ä»¤é€æ­¥æ‰§è¡Œå¾—å‡ºç»“æœã€‚æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„å¤§éƒ¨åˆ†æ“ä½œå‡æ˜¯é€šè¿‡è°ƒç”¨å­˜å‚¨å¼•æ“å®ç°çš„æ¥å£æ¥å®Œæˆï¼Œè¿™äº›æ¥å£è¢«ç§°ä¸ºhandlerAPIã€‚æŸ¥è¯¢è¿‡ç¨‹ä¸­çš„æ¯ä¸€å¼ è¡¨ç”±ä¸€ä¸ªhandlerå®ä¾‹è¡¨ç¤ºã€‚\nå®é™…ä¸Šï¼ŒMySQLåœ¨æŸ¥è¯¢ä¼˜åŒ–é˜¶æ®µå°±ä¸ºæ¯ä¸€å¼ è¡¨åˆ›å»ºäº†ä¸€ä¸ªhandlerå®ä¾‹ï¼Œä¼˜åŒ–å™¨å¯ä»¥æ ¹æ®è¿™äº›å®ä¾‹çš„æ¥å£æ¥è·å–è¡¨çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡¨çš„æ‰€æœ‰åˆ—åã€ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯ç­‰ã€‚å­˜å‚¨å¼•æ“æ¥å£æä¾›äº†éå¸¸ä¸°å¯Œçš„åŠŸèƒ½ï¼Œä½†å…¶åº•å±‚ä»…æœ‰å‡ åä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£åƒæ­ç§¯æœ¨ä¸€æ ·å®Œæˆäº†ä¸€æ¬¡æŸ¥è¯¢çš„å¤§éƒ¨åˆ†æ“ä½œã€‚\nè¿”å›ç»“æœç»™å®¢æˆ·ç«¯ # æŸ¥è¯¢æ‰§è¡Œçš„æœ€åä¸€ä¸ªé˜¶æ®µå°±æ˜¯å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å³ä½¿æŸ¥è¯¢ä¸åˆ°æ•°æ®ï¼ŒMySQLä»ç„¶ä¼šè¿”å›è¿™ä¸ªæŸ¥è¯¢çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚æ”¹æŸ¥è¯¢å½±å“åˆ°çš„è¡Œæ•°ä»¥åŠæ‰§è¡Œæ—¶é—´ç­‰ç­‰ã€‚\nå¦‚æœæŸ¥è¯¢ç¼“å­˜è¢«æ‰“å¼€ä¸”è¿™ä¸ªæŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼ŒMySQLä¹Ÿä¼šå°†ç»“æœå­˜æ”¾åˆ°ç¼“å­˜ä¸­ã€‚\nç»“æœé›†è¿”å›å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå¢é‡ä¸”é€æ­¥è¿”å›çš„è¿‡ç¨‹ã€‚æœ‰å¯èƒ½MySQLåœ¨ç”Ÿæˆç¬¬ä¸€æ¡ç»“æœæ—¶ï¼Œå°±å¼€å§‹å‘å®¢æˆ·ç«¯é€æ­¥è¿”å›ç»“æœé›†äº†ã€‚è¿™æ ·æœåŠ¡ç«¯å°±æ— é¡»å­˜å‚¨å¤ªå¤šç»“æœè€Œæ¶ˆè€—è¿‡å¤šå†…å­˜ï¼Œä¹Ÿå¯ä»¥è®©å®¢æˆ·ç«¯ç¬¬ä¸€æ—¶é—´è·å¾—è¿”å›ç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œéƒ½ä¼šä»¥ä¸€ä¸ªæ»¡è¶³â‘ ä¸­æ‰€æè¿°çš„é€šä¿¡åè®®çš„æ•°æ®åŒ…å‘é€ï¼Œå†é€šè¿‡TCPåè®®è¿›è¡Œä¼ è¾“ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å¯¹MySQLçš„æ•°æ®åŒ…è¿›è¡Œç¼“å­˜ç„¶åæ‰¹é‡å‘é€ã€‚\nå›å¤´æ€»ç»“ä¸€ä¸‹MySQLæ•´ä¸ªæŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´åˆ†ä¸º5ä¸ªæ­¥éª¤ï¼š\n å®¢æˆ·ç«¯å‘MySQLæœåŠ¡å™¨å‘é€ä¸€æ¡æŸ¥è¯¢è¯·æ±‚ æœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œåˆ™ç«‹åˆ»è¿”å›å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„ç»“æœã€‚å¦åˆ™è¿›å…¥ä¸‹ä¸€é˜¶æ®µ æœåŠ¡å™¨è¿›è¡ŒSQLè§£æã€é¢„å¤„ç†ã€å†ç”±ä¼˜åŒ–å™¨ç”Ÿæˆå¯¹åº”çš„æ‰§è¡Œè®¡åˆ’ MySQLæ ¹æ®æ‰§è¡Œè®¡åˆ’ï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“çš„APIæ¥æ‰§è¡ŒæŸ¥è¯¢ å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼ŒåŒæ—¶ç¼“å­˜æŸ¥è¯¢ç»“æœ   æ€§èƒ½ä¼˜åŒ–å»ºè®® # çœ‹äº†è¿™ä¹ˆå¤šï¼Œä½ å¯èƒ½ä¼šæœŸå¾…ç»™å‡ºä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œæ˜¯çš„ï¼Œä¸‹é¢ä¼šä»3ä¸ªä¸åŒæ–¹é¢ç»™å‡ºä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ä½†è¯·ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€å¥å¿ å‘Šè¦å…ˆé€ç»™ä½ ï¼šä¸è¦å¬ä¿¡ä½ çœ‹åˆ°çš„å…³äºä¼˜åŒ–çš„â€œç»å¯¹çœŸç†â€ï¼ŒåŒ…æ‹¬æœ¬æ–‡æ‰€è®¨è®ºçš„å†…å®¹ï¼Œè€Œåº”è¯¥æ˜¯åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸‹é€šè¿‡æµ‹è¯•æ¥éªŒè¯ä½ å…³äºæ‰§è¡Œè®¡åˆ’ä»¥åŠå“åº”æ—¶é—´çš„å‡è®¾ã€‚\nSchemeè®¾è®¡ä¸æ•°æ®ç±»å‹ä¼˜åŒ– # é€‰æ‹©æ•°æ®ç±»å‹åªè¦éµå¾ªå°è€Œç®€å•çš„åŸåˆ™å°±å¥½ï¼Œè¶Šå°çš„æ•°æ®ç±»å‹é€šå¸¸ä¼šæ›´å¿«ï¼Œå ç”¨æ›´å°‘çš„ç£ç›˜ã€å†…å­˜ï¼Œå¤„ç†æ—¶éœ€è¦çš„CPUå‘¨æœŸä¹Ÿæ›´å°‘ã€‚è¶Šç®€å•çš„æ•°æ®ç±»å‹åœ¨è®¡ç®—æ—¶éœ€è¦æ›´å°‘çš„CPUå‘¨æœŸï¼Œæ¯”å¦‚ï¼Œæ•´å‹å°±æ¯”å­—ç¬¦æ“ä½œä»£ä»·ä½ï¼Œå› è€Œä¼šä½¿ç”¨æ•´å‹æ¥å­˜å‚¨ipåœ°å€ï¼Œä½¿ç”¨DATETIMEæ¥å­˜å‚¨æ—¶é—´ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ã€‚\nè¿™é‡Œæ€»ç»“å‡ ä¸ªå¯èƒ½å®¹æ˜“ç†è§£é”™è¯¯çš„æŠ€å·§ï¼š\n é€šå¸¸æ¥è¯´æŠŠå¯ä¸ºNULLçš„åˆ—æ”¹ä¸ºNOT NULLä¸ä¼šå¯¹æ€§èƒ½æå‡æœ‰å¤šå°‘å¸®åŠ©ï¼Œåªæ˜¯å¦‚æœè®¡åˆ’åœ¨åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œå°±åº”è¯¥å°†è¯¥åˆ—è®¾ç½®ä¸ºNOT NULLã€‚ å¯¹æ•´æ•°ç±»å‹æŒ‡å®šå®½åº¦ï¼Œæ¯”å¦‚INT(11)ï¼Œæ²¡æœ‰ä»»ä½•åµç”¨ã€‚INTä½¿ç”¨16ä¸ºå­˜å‚¨ç©ºé—´ï¼Œé‚£ä¹ˆå®ƒçš„è¡¨ç¤ºèŒƒå›´å·²ç»ç¡®å®šï¼Œæ‰€ä»¥INT(1)å’ŒINT(20)å¯¹äºå­˜å‚¨å’Œè®¡ç®—æ˜¯ç›¸åŒçš„ã€‚ UNSIGNEDè¡¨ç¤ºä¸å…è®¸è´Ÿå€¼ï¼Œå¤§è‡´å¯ä»¥ä½¿æ­£æ•°çš„ä¸Šé™æé«˜ä¸€å€ã€‚æ¯”å¦‚TINYINTå­˜å‚¨èŒƒå›´æ˜¯é€šå¸¸æ¥è®²ï¼Œæ²¡æœ‰å¤ªå¤§çš„å¿…è¦ä½¿ç”¨DECIMALæ•°æ®ç±»å‹ã€‚å³ä½¿æ˜¯åœ¨éœ€è¦å­˜å‚¨è´¢åŠ¡æ•°æ®æ—¶ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨BIGINTã€‚æ¯”å¦‚éœ€è¦ç²¾ç¡®åˆ°ä¸‡åˆ†ä¹‹ä¸€ï¼Œé‚£ä¹ˆå¯ä»¥å°†æ•°æ®ä¹˜ä»¥ä¸€ç™¾ä¸‡ç„¶åä½¿ç”¨TIMESTAMPä½¿ç”¨4ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ï¼ŒDATETIMEä½¿ç”¨8ä¸ªå­—èŠ‚å­˜å‚¨ç©ºé—´ã€‚å› è€Œï¼ŒTIMESTAMPåªèƒ½è¡¨ç¤º1970 - 2038å¹´ï¼Œæ¯”DATETIMEè¡¨ç¤ºçš„èŒƒå›´å°å¾—å¤šï¼Œè€Œä¸”TIMESTAMPçš„å€¼å› æ—¶åŒºä¸åŒè€Œä¸åŒã€‚ å¤§å¤šæ•°æƒ…å†µä¸‹æ²¡æœ‰ä½¿ç”¨æšä¸¾ç±»å‹çš„å¿…è¦ï¼Œå…¶ä¸­ä¸€ä¸ªç¼ºç‚¹æ˜¯æšä¸¾çš„å­—ç¬¦ä¸²åˆ—è¡¨æ˜¯å›ºå®šçš„ï¼Œæ·»åŠ å’Œåˆ é™¤å­—ç¬¦ä¸²ï¼ˆæšä¸¾é€‰é¡¹ï¼‰å¿…é¡»ä½¿ç”¨ALTER TABLEï¼ˆå¦‚æœåªåªæ˜¯åœ¨åˆ—è¡¨æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œä¸éœ€è¦é‡å»ºè¡¨ï¼‰ã€‚ schemaçš„åˆ—ä¸è¦å¤ªå¤šã€‚åŸå› æ˜¯å­˜å‚¨å¼•æ“çš„APIå·¥ä½œæ—¶éœ€è¦åœ¨æœåŠ¡å™¨å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¹‹é—´é€šè¿‡è¡Œç¼“å†²æ ¼å¼æ‹·è´æ•°æ®ï¼Œç„¶ååœ¨æœåŠ¡å™¨å±‚å°†ç¼“å†²å†…å®¹è§£ç æˆå„ä¸ªåˆ—ï¼Œè¿™ä¸ªè½¬æ¢è¿‡ç¨‹çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ã€‚å¦‚æœåˆ—å¤ªå¤šè€Œå®é™…ä½¿ç”¨çš„åˆ—åˆå¾ˆå°‘çš„è¯ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´CPUå ç”¨è¿‡é«˜ã€‚ å¤§è¡¨ALTER TABLEéå¸¸è€—æ—¶ï¼ŒMySQLæ‰§è¡Œå¤§éƒ¨åˆ†ä¿®æ”¹è¡¨ç»“æœæ“ä½œçš„æ–¹æ³•æ˜¯ç”¨æ–°çš„ç»“æ„åˆ›å»ºä¸€ä¸ªå¼ ç©ºè¡¨ï¼Œä»æ—§è¡¨ä¸­æŸ¥å‡ºæ‰€æœ‰çš„æ•°æ®æ’å…¥æ–°è¡¨ï¼Œç„¶åå†åˆ é™¤æ—§è¡¨ã€‚å°¤å…¶å½“å†…å­˜ä¸è¶³è€Œè¡¨åˆå¾ˆå¤§ï¼Œè€Œä¸”è¿˜æœ‰å¾ˆå¤§ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè€—æ—¶æ›´ä¹…ã€‚å½“ç„¶æœ‰ä¸€äº›å¥‡æ·«æŠ€å·§å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰å…´è¶£å¯è‡ªè¡ŒæŸ¥é˜…ã€‚  åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼• # ç´¢å¼•æ˜¯æé«˜MySQLæŸ¥è¯¢æ€§èƒ½çš„ä¸€ä¸ªé‡è¦é€”å¾„ï¼Œä½†è¿‡å¤šçš„ç´¢å¼•å¯èƒ½ä¼šå¯¼è‡´è¿‡é«˜çš„ç£ç›˜ä½¿ç”¨ç‡ä»¥åŠè¿‡é«˜çš„å†…å­˜å ç”¨ï¼Œä»è€Œå½±å“åº”ç”¨ç¨‹åºçš„æ•´ä½“æ€§èƒ½ã€‚åº”å½“å°½é‡é¿å…äº‹åæ‰æƒ³èµ·æ·»åŠ ç´¢å¼•ï¼Œå› ä¸ºäº‹åå¯èƒ½éœ€è¦ç›‘æ§å¤§é‡çš„SQLæ‰èƒ½å®šä½åˆ°é—®é¢˜æ‰€åœ¨ï¼Œè€Œä¸”æ·»åŠ ç´¢å¼•çš„æ—¶é—´è‚¯å®šæ˜¯è¿œå¤§äºåˆå§‹æ·»åŠ ç´¢å¼•æ‰€éœ€è¦çš„æ—¶é—´ï¼Œå¯è§ç´¢å¼•çš„æ·»åŠ ä¹Ÿæ˜¯éå¸¸æœ‰æŠ€æœ¯å«é‡çš„ã€‚\næ¥ä¸‹æ¥å°†å‘ä½ å±•ç¤ºä¸€ç³»åˆ—åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•çš„ç­–ç•¥ï¼Œä»¥åŠæ¯æ¡ç­–ç•¥å…¶èƒŒåçš„å·¥ä½œåŸç†ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸ç´¢å¼•ç›¸å…³çš„ä¸€äº›ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œå°†æœ‰åŠ©äºæ›´å¥½çš„ç†è§£åæ–‡çš„å†…å®¹ã€‚æ¨èï¼šå¸¦ä½ ä»å¤´åˆ°å°¾æ‹ä¸€éMySQLç´¢å¼•ç»“æ„ï¼\nç´¢å¼•ç›¸å…³çš„æ•°æ®ç»“æ„å’Œç®—æ³• # é€šå¸¸æˆ‘ä»¬æ‰€è¯´çš„ç´¢å¼•æ˜¯æŒ‡B-Treeç´¢å¼•ï¼Œå®ƒæ˜¯ç›®å‰å…³ç³»å‹æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®æœ€ä¸ºå¸¸ç”¨å’Œæœ‰æ•ˆçš„ç´¢å¼•ï¼Œå¤§å¤šæ•°å­˜å‚¨å¼•æ“éƒ½æ”¯æŒè¿™ç§ç´¢å¼•ã€‚ä½¿ç”¨B-Treeè¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯å› ä¸ºMySQLåœ¨CREATE TABLEæˆ–å…¶å®ƒè¯­å¥ä¸­ä½¿ç”¨äº†è¿™ä¸ªå…³é”®å­—ï¼Œä½†å®é™…ä¸Šä¸åŒçš„å­˜å‚¨å¼•æ“å¯èƒ½ä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚InnoDBå°±æ˜¯ä½¿ç”¨çš„B+Treeã€‚\nB+Treeä¸­çš„Bæ˜¯æŒ‡balanceï¼Œæ„ä¸ºå¹³è¡¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒB+æ ‘ç´¢å¼•å¹¶ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ªç»™å®šé”®å€¼çš„å…·ä½“è¡Œï¼Œå®ƒæ‰¾åˆ°çš„åªæ˜¯è¢«æŸ¥æ‰¾æ•°æ®è¡Œæ‰€åœ¨çš„é¡µï¼Œæ¥ç€æ•°æ®åº“ä¼šæŠŠé¡µè¯»å…¥åˆ°å†…å­˜ï¼Œå†åœ¨å†…å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œæœ€åå¾—åˆ°è¦æŸ¥æ‰¾çš„æ•°æ®ã€‚\nåœ¨ä»‹ç»B+Treeå‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œå®ƒæ˜¯ä¸€ç§ç»å…¸çš„æ•°æ®ç»“æ„ï¼Œå…¶å·¦å­æ ‘çš„å€¼æ€»æ˜¯å°äºæ ¹çš„å€¼ï¼Œå³å­æ ‘çš„å€¼æ€»æ˜¯å¤§äºæ ¹çš„å€¼ï¼Œå¦‚ä¸‹å›¾â‘ ã€‚å¦‚æœè¦åœ¨è¿™è¯¾æ ‘ä¸­æŸ¥æ‰¾å€¼ä¸º5çš„è®°å½•ï¼Œå…¶å¤§è‡´æµç¨‹ï¼šå…ˆæ‰¾åˆ°æ ¹ï¼Œå…¶å€¼ä¸º6ï¼Œå¤§äº5ï¼Œæ‰€ä»¥æŸ¥æ‰¾å·¦å­æ ‘ï¼Œæ‰¾åˆ°3ï¼Œè€Œ5å¤§äº3ï¼Œæ¥ç€æ‰¾3çš„å³å­æ ‘ï¼Œæ€»å…±æ‰¾äº†3æ¬¡ã€‚åŒæ ·çš„æ–¹æ³•ï¼Œå¦‚æœæŸ¥æ‰¾å€¼ä¸º8çš„è®°å½•ï¼Œä¹Ÿéœ€è¦æŸ¥æ‰¾3æ¬¡ã€‚æ‰€ä»¥äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸º(3 + 3 + 3 + 2 + 2 + 1) / 6 = 2.3æ¬¡ï¼Œè€Œé¡ºåºæŸ¥æ‰¾çš„è¯ï¼ŒæŸ¥æ‰¾å€¼ä¸º2çš„è®°å½•ï¼Œä»…éœ€è¦1æ¬¡ï¼Œä½†æŸ¥æ‰¾å€¼ä¸º8çš„è®°å½•åˆ™éœ€è¦6æ¬¡ï¼Œæ‰€ä»¥é¡ºåºæŸ¥æ‰¾çš„å¹³å‡æŸ¥æ‰¾æ¬¡æ•°ä¸ºï¼š(1 + 2 + 3 + 4 + 5 + 6) / 6 = 3.3æ¬¡ï¼Œå› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹äºŒå‰æŸ¥æ‰¾æ ‘çš„å¹³å‡æŸ¥æ‰¾é€Ÿåº¦æ¯”é¡ºåºæŸ¥æ‰¾è¦å¿«ã€‚\näºŒå‰æŸ¥æ‰¾æ ‘å’Œå¹³è¡¡äºŒå‰æ ‘\nç”±äºäºŒå‰æŸ¥æ‰¾æ ‘å¯ä»¥ä»»æ„æ„é€ ï¼ŒåŒæ ·çš„å€¼ï¼Œå¯ä»¥æ„é€ å‡ºå¦‚å›¾â‘¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œæ˜¾ç„¶è¿™æ£µäºŒå‰æ ‘çš„æŸ¥è¯¢æ•ˆç‡å’Œé¡ºåºæŸ¥æ‰¾å·®ä¸å¤šã€‚è‹¥æƒ³äºŒå‰æŸ¥æ‰¾æ•°çš„æŸ¥è¯¢æ€§èƒ½æœ€é«˜ï¼Œéœ€è¦è¿™æ£µäºŒå‰æŸ¥æ‰¾æ ‘æ˜¯å¹³è¡¡çš„ï¼Œä¹Ÿå³å¹³è¡¡äºŒå‰æ ‘ï¼ˆAVLæ ‘ï¼‰ã€‚\nå¹³è¡¡äºŒå‰æ ‘é¦–å…ˆéœ€è¦ç¬¦åˆäºŒå‰æŸ¥æ‰¾æ ‘çš„å®šä¹‰ï¼Œå…¶æ¬¡å¿…é¡»æ»¡è¶³ä»»ä½•èŠ‚ç‚¹çš„ä¸¤ä¸ªå­æ ‘çš„é«˜åº¦å·®ä¸èƒ½å¤§äº1ã€‚æ˜¾ç„¶å›¾â‘¡ä¸æ»¡è¶³å¹³è¡¡äºŒå‰æ ‘çš„å®šä¹‰ï¼Œè€Œå›¾â‘ æ˜¯ä¸€è¯¾å¹³è¡¡äºŒå‰æ ‘ã€‚å¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ€§èƒ½æ˜¯æ¯”è¾ƒé«˜çš„ï¼ˆæ€§èƒ½æœ€å¥½çš„æ˜¯æœ€ä¼˜äºŒå‰æ ‘ï¼‰ï¼ŒæŸ¥è¯¢æ€§èƒ½è¶Šå¥½ï¼Œç»´æŠ¤çš„æˆæœ¬å°±è¶Šå¤§ã€‚æ¯”å¦‚å›¾â‘ çš„å¹³è¡¡äºŒå‰æ ‘ï¼Œå½“ç”¨æˆ·éœ€è¦æ’å…¥ä¸€ä¸ªæ–°çš„å€¼9çš„èŠ‚ç‚¹æ—¶ï¼Œå°±éœ€è¦åšå‡ºå¦‚ä¸‹å˜åŠ¨ã€‚\nå¹³è¡¡äºŒå‰æ ‘æ—‹è½¬\né€šè¿‡ä¸€æ¬¡å·¦æ—‹æ“ä½œå°±å°†æ’å…¥åçš„æ ‘é‡æ–°å˜ä¸ºå¹³è¡¡äºŒå‰æ ‘æ˜¯æœ€ç®€å•çš„æƒ…å†µäº†ï¼Œå®é™…åº”ç”¨åœºæ™¯ä¸­å¯èƒ½éœ€è¦æ—‹è½¬å¤šæ¬¡ã€‚è‡³æ­¤æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œå¹³è¡¡äºŒå‰æ ‘çš„æŸ¥æ‰¾æ•ˆç‡è¿˜ä¸é”™ï¼Œå®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œç›¸åº”çš„ç»´æŠ¤æˆæœ¬è¿˜èƒ½æ¥å—ï¼Œä¸ºä»€ä¹ˆMySQLç´¢å¼•ä¸ç›´æ¥ä½¿ç”¨å¹³è¡¡äºŒå‰æ ‘ï¼Ÿ\néšç€æ•°æ®åº“ä¸­æ•°æ®çš„å¢åŠ ï¼Œç´¢å¼•æœ¬èº«å¤§å°éšä¹‹å¢åŠ ï¼Œä¸å¯èƒ½å…¨éƒ¨å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå› æ­¤ç´¢å¼•å¾€å¾€ä»¥ç´¢å¼•æ–‡ä»¶çš„å½¢å¼å­˜å‚¨çš„ç£ç›˜ä¸Šã€‚è¿™æ ·çš„è¯ï¼Œç´¢å¼•æŸ¥æ‰¾è¿‡ç¨‹ä¸­å°±è¦äº§ç”Ÿç£ç›˜I/Oæ¶ˆè€—ï¼Œç›¸å¯¹äºå†…å­˜å­˜å–ï¼ŒI/Oå­˜å–çš„æ¶ˆè€—è¦é«˜å‡ ä¸ªæ•°é‡çº§ã€‚å¯ä»¥æƒ³è±¡ä¸€ä¸‹ä¸€æ£µå‡ ç™¾ä¸‡èŠ‚ç‚¹çš„äºŒå‰æ ‘çš„æ·±åº¦æ˜¯å¤šå°‘ï¼Ÿå¦‚æœå°†è¿™ä¹ˆå¤§æ·±åº¦çš„ä¸€é¢—äºŒå‰æ ‘æ”¾ç£ç›˜ä¸Šï¼Œæ¯è¯»å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéœ€è¦ä¸€æ¬¡ç£ç›˜çš„I/Oè¯»å–ï¼Œæ•´ä¸ªæŸ¥æ‰¾çš„è€—æ—¶æ˜¾ç„¶æ˜¯ä¸èƒ½å¤Ÿæ¥å—çš„ã€‚é‚£ä¹ˆå¦‚ä½•å‡å°‘æŸ¥æ‰¾è¿‡ç¨‹ä¸­çš„I/Oå­˜å–æ¬¡æ•°ï¼Ÿ\nä¸€ç§è¡Œä¹‹æœ‰æ•ˆçš„è§£å†³æ–¹æ³•æ˜¯å‡å°‘æ ‘çš„æ·±åº¦ï¼Œå°†äºŒå‰æ ‘å˜ä¸ºmå‰æ ‘ï¼ˆå¤šè·¯æœç´¢æ ‘ï¼‰ï¼Œè€ŒB+Treeå°±æ˜¯ä¸€ç§å¤šè·¯æœç´¢æ ‘ã€‚ç†è§£B+Treeæ—¶ï¼Œåªéœ€è¦ç†è§£å…¶æœ€é‡è¦çš„ä¸¤ä¸ªç‰¹å¾å³å¯ï¼šç¬¬ä¸€ï¼Œæ‰€æœ‰çš„å…³é”®å­—ï¼ˆå¯ä»¥ç†è§£ä¸ºæ•°æ®ï¼‰éƒ½å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼ˆLeaf Pageï¼‰ï¼Œéå¶å­èŠ‚ç‚¹ï¼ˆIndex Pageï¼‰å¹¶ä¸å­˜å‚¨çœŸæ­£çš„æ•°æ®ï¼Œæ‰€æœ‰è®°å½•èŠ‚ç‚¹éƒ½æ˜¯æŒ‰é”®å€¼å¤§å°é¡ºåºå­˜æ”¾åœ¨åŒä¸€å±‚å¶å­èŠ‚ç‚¹ä¸Šã€‚å…¶æ¬¡ï¼Œæ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ç”±æŒ‡é’ˆè¿æ¥ã€‚å¦‚ä¸‹å›¾ä¸ºé«˜åº¦ä¸º2çš„ç®€åŒ–äº†çš„B+Treeã€‚\nç®€åŒ–B+Tree\næ€ä¹ˆç†è§£è¿™ä¸¤ä¸ªç‰¹å¾ï¼ŸMySQLå°†æ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ç½®ä¸ºä¸€ä¸ªé¡µçš„æ•´æ•°å€ï¼ˆåŸå› ä¸‹æ–‡ä¼šä»‹ç»ï¼‰ï¼Œä¹Ÿå°±æ˜¯åœ¨èŠ‚ç‚¹ç©ºé—´å¤§å°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨æ›´å¤šçš„å†…ç»“ç‚¹ï¼Œè¿™æ ·æ¯ä¸ªç»“ç‚¹èƒ½ç´¢å¼•çš„èŒƒå›´æ›´å¤§æ›´ç²¾ç¡®ã€‚æ‰€æœ‰çš„å¶å­èŠ‚ç‚¹ä½¿ç”¨æŒ‡é’ˆé“¾æ¥çš„å¥½å¤„æ˜¯å¯ä»¥è¿›è¡ŒåŒºé—´è®¿é—®ï¼Œæ¯”å¦‚ä¸Šå›¾ä¸­ï¼Œå¦‚æœæŸ¥æ‰¾å¤§äº20è€Œå°äº30çš„è®°å½•ï¼Œåªéœ€è¦æ‰¾åˆ°èŠ‚ç‚¹20ï¼Œå°±å¯ä»¥éå†æŒ‡é’ˆä¾æ¬¡æ‰¾åˆ°25ã€30ã€‚å¦‚æœæ²¡æœ‰é“¾æ¥æŒ‡é’ˆçš„è¯ï¼Œå°±æ— æ³•è¿›è¡ŒåŒºé—´æŸ¥æ‰¾ã€‚è¿™ä¹Ÿæ˜¯MySQLä½¿ç”¨B+Treeä½œä¸ºç´¢å¼•å­˜å‚¨ç»“æ„çš„é‡è¦åŸå› ã€‚\nMySQLä¸ºä½•å°†èŠ‚ç‚¹å¤§å°è®¾ç½®ä¸ºé¡µçš„æ•´æ•°å€ï¼Œè¿™å°±éœ€è¦ç†è§£ç£ç›˜çš„å­˜å‚¨åŸç†ã€‚ç£ç›˜æœ¬èº«å­˜å–å°±æ¯”ä¸»å­˜æ…¢å¾ˆå¤šï¼Œåœ¨åŠ ä¸Šæœºæ¢°è¿åŠ¨æŸè€—ï¼ˆç‰¹åˆ«æ˜¯æ™®é€šçš„æœºæ¢°ç¡¬ç›˜ï¼‰ï¼Œç£ç›˜çš„å­˜å–é€Ÿåº¦å¾€å¾€æ˜¯ä¸»å­˜çš„å‡ ç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼Œä¸ºäº†å°½é‡å‡å°‘ç£ç›˜I/Oï¼Œç£ç›˜å¾€å¾€ä¸æ˜¯ä¸¥æ ¼æŒ‰éœ€è¯»å–ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½ä¼šé¢„è¯»ï¼Œå³ä½¿åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œç£ç›˜ä¹Ÿä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹ï¼Œé¡ºåºå‘åè¯»å–ä¸€å®šé•¿åº¦çš„æ•°æ®æ”¾å…¥å†…å­˜ï¼Œé¢„è¯»çš„é•¿åº¦ä¸€èˆ¬ä¸ºé¡µçš„æ•´æ•°å€ã€‚\n é¡µæ˜¯è®¡ç®—æœºç®¡ç†å­˜å‚¨å™¨çš„é€»è¾‘å—ï¼Œç¡¬ä»¶åŠOSå¾€å¾€å°†ä¸»å­˜å’Œç£ç›˜å­˜å‚¨åŒºåˆ†å‰²ä¸ºè¿ç»­çš„å¤§å°ç›¸ç­‰çš„å—ï¼Œæ¯ä¸ªå­˜å‚¨å—ç§°ä¸ºä¸€é¡µï¼ˆè®¸å¤šOSä¸­ï¼Œé¡µçš„å¤§å°é€šå¸¸ä¸º4Kï¼‰ã€‚ä¸»å­˜å’Œç£ç›˜ä»¥é¡µä¸ºå•ä½äº¤æ¢æ•°æ®ã€‚å½“ç¨‹åºè¦è¯»å–çš„æ•°æ®ä¸åœ¨ä¸»å­˜ä¸­æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶ç³»ç»Ÿä¼šå‘ç£ç›˜å‘å‡ºè¯»ç›˜ä¿¡å·ï¼Œç£ç›˜ä¼šæ‰¾åˆ°æ•°æ®çš„èµ·å§‹ä½ç½®å¹¶å‘åè¿ç»­è¯»å–ä¸€é¡µæˆ–å‡ é¡µè½½å…¥å†…å­˜ä¸­ï¼Œç„¶åå¼‚å¸¸è¿”å›ï¼Œç¨‹åºç»§ç»­è¿è¡Œã€‚\n MySQLå·§å¦™åˆ©ç”¨äº†ç£ç›˜é¢„è¯»åŸç†ï¼Œå°†ä¸€ä¸ªèŠ‚ç‚¹çš„å¤§å°è®¾ä¸ºç­‰äºä¸€ä¸ªé¡µï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹åªéœ€è¦ä¸€æ¬¡I/Oå°±å¯ä»¥å®Œå…¨è½½å…¥ã€‚ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæ¯æ¬¡æ–°å»ºèŠ‚ç‚¹æ—¶ï¼Œç›´æ¥ç”³è¯·ä¸€ä¸ªé¡µçš„ç©ºé—´ï¼Œè¿™æ ·å°±ä¿è¯ä¸€ä¸ªèŠ‚ç‚¹ç‰©ç†ä¸Šä¹Ÿå­˜å‚¨åœ¨ä¸€ä¸ªé¡µé‡Œï¼ŒåŠ ä¹‹è®¡ç®—æœºå­˜å‚¨åˆ†é…éƒ½æ˜¯æŒ‰é¡µå¯¹é½çš„ï¼Œå°±å®ç°äº†è¯»å–ä¸€ä¸ªèŠ‚ç‚¹åªéœ€ä¸€æ¬¡I/Oã€‚å‡è®¾B+Treeçš„é«˜åº¦ä¸ºhï¼Œä¸€æ¬¡æ£€ç´¢æœ€å¤šéœ€è¦h-1I/Oï¼ˆæ ¹èŠ‚ç‚¹å¸¸é©»å†…å­˜ï¼‰ï¼Œå¤æ‚åº¦O(h)=O(logMN)ã€‚å®é™…åº”ç”¨åœºæ™¯ä¸­ï¼ŒMé€šå¸¸è¾ƒå¤§ï¼Œå¸¸å¸¸è¶…è¿‡100ï¼Œå› æ­¤æ ‘çš„é«˜åº¦ä¸€èˆ¬éƒ½æ¯”è¾ƒå°ï¼Œé€šå¸¸ä¸è¶…è¿‡3ã€‚\næœ€åç®€å•äº†è§£ä¸‹B+TreeèŠ‚ç‚¹çš„æ“ä½œï¼Œåœ¨æ•´ä½“ä¸Šå¯¹ç´¢å¼•çš„ç»´æŠ¤æœ‰ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œè™½ç„¶ç´¢å¼•å¯ä»¥å¤§å¤§æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œä½†ç»´æŠ¤ç´¢å¼•ä»è¦èŠ±è´¹å¾ˆå¤§çš„ä»£ä»·ï¼Œå› æ­¤åˆç†çš„åˆ›å»ºç´¢å¼•ä¹Ÿå°±å°¤ä¸ºé‡è¦ã€‚\nä»ä»¥ä¸Šé¢çš„æ ‘ä¸ºä¾‹ï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªèŠ‚ç‚¹åªèƒ½å­˜å‚¨4ä¸ªå†…èŠ‚ç‚¹ã€‚é¦–å…ˆè¦æ’å…¥ç¬¬ä¸€ä¸ªèŠ‚ç‚¹28ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nleaf pageå’Œindex pageéƒ½æ²¡æœ‰æ»¡\næ¥ç€æ’å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹70ï¼Œåœ¨Index Pageä¸­æŸ¥è¯¢åå¾—çŸ¥åº”è¯¥æ’å…¥åˆ°50 - 70ä¹‹é—´çš„å¶å­èŠ‚ç‚¹ï¼Œä½†å¶å­èŠ‚ç‚¹å·²æ»¡ï¼Œè¿™æ—¶å€™å°±éœ€è¦è¿›è¡Œä¹Ÿåˆ†è£‚çš„æ“ä½œï¼Œå½“å‰çš„å¶å­èŠ‚ç‚¹èµ·ç‚¹ä¸º50ï¼Œæ‰€ä»¥æ ¹æ®ä¸­é—´å€¼æ¥æ‹†åˆ†å¶å­èŠ‚ç‚¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nLeaf Pageæ‹†åˆ†\næœ€åæ’å…¥ä¸€ä¸ªèŠ‚ç‚¹95ï¼Œè¿™æ—¶å€™Index Pageå’ŒLeaf Pageéƒ½æ»¡äº†ï¼Œå°±éœ€è¦åšä¸¤æ¬¡æ‹†åˆ†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nLeaf Pageä¸Index Pageæ‹†åˆ†\næ‹†åˆ†åæœ€ç»ˆå½¢æˆäº†è¿™æ ·ä¸€é¢—æ ‘ã€‚\næœ€ç»ˆæ ‘\nB+Treeä¸ºäº†ä¿æŒå¹³è¡¡ï¼Œå¯¹äºæ–°æ’å…¥çš„å€¼éœ€è¦åšå¤§é‡çš„æ‹†åˆ†é¡µæ“ä½œï¼Œè€Œé¡µçš„æ‹†åˆ†éœ€è¦I/Oæ“ä½œï¼Œä¸ºäº†å°½å¯èƒ½çš„å‡å°‘é¡µçš„æ‹†åˆ†æ“ä½œï¼ŒB+Treeä¹Ÿæä¾›äº†ç±»ä¼¼äºå¹³è¡¡äºŒå‰æ ‘çš„æ—‹è½¬åŠŸèƒ½ã€‚å½“LeafPageå·²æ»¡ä½†å…¶å·¦å³å…„å¼ŸèŠ‚ç‚¹æ²¡æœ‰æ»¡çš„æƒ…å†µä¸‹ï¼ŒB+Treeå¹¶ä¸æ€¥äºå»åšæ‹†åˆ†æ“ä½œï¼Œè€Œæ˜¯å°†è®°å½•ç§»åˆ°å½“å‰æ‰€åœ¨é¡µçš„å…„å¼ŸèŠ‚ç‚¹ä¸Šã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå·¦å…„å¼Ÿä¼šè¢«å…ˆæ£€æŸ¥ç”¨æ¥åšæ—‹è½¬æ“ä½œã€‚å°±æ¯”å¦‚ä¸Šé¢ç¬¬äºŒä¸ªç¤ºä¾‹ï¼Œå½“æ’å…¥70çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šå»åšé¡µæ‹†åˆ†ï¼Œè€Œæ˜¯å·¦æ—‹æ“ä½œã€‚\nå·¦æ—‹æ“ä½œ\né€šè¿‡æ—‹è½¬æ“ä½œå¯ä»¥æœ€å¤§é™åº¦çš„å‡å°‘é¡µåˆ†è£‚ï¼Œä»è€Œå‡å°‘ç´¢å¼•ç»´æŠ¤è¿‡ç¨‹ä¸­çš„ç£ç›˜çš„I/Oæ“ä½œï¼Œä¹Ÿæé«˜ç´¢å¼•ç»´æŠ¤æ•ˆç‡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ é™¤èŠ‚ç‚¹è·Ÿæ’å…¥èŠ‚ç‚¹ç±»å‹ï¼Œä»ç„¶éœ€è¦æ—‹è½¬å’Œæ‹†åˆ†æ“ä½œï¼Œè¿™é‡Œå°±ä¸å†è¯´æ˜ã€‚\né«˜æ€§èƒ½ç­–ç•¥ # é€šè¿‡ä¸Šæ–‡ï¼Œç›¸ä¿¡ä½ å¯¹B+Treeçš„æ•°æ®ç»“æ„å·²ç»æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œä½†MySQLä¸­ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®çš„å­˜å‚¨å‘¢ï¼Ÿä»¥ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œå‡å¦‚æœ‰å¦‚ä¸‹æ•°æ®è¡¨ï¼š\nMysqlä»£ç \nCREATE TABLE People( last_name varchar(50) not null, first_name varchar(50) not null, dob date not null, gender enum(`m`,`f`) not null, key(last_name,first_name,dob) );  å¯¹äºè¡¨ä¸­æ¯ä¸€è¡Œæ•°æ®ï¼Œç´¢å¼•ä¸­åŒ…å«äº†last_nameã€first_nameã€dobåˆ—çš„å€¼ï¼Œä¸‹å›¾å±•ç¤ºäº†ç´¢å¼•æ˜¯å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ã€‚\nç´¢å¼•å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨ï¼Œæ¥è‡ªï¼šé«˜æ€§èƒ½MySQL\nå¯ä»¥çœ‹åˆ°ï¼Œç´¢å¼•é¦–å…ˆæ ¹æ®ç¬¬ä¸€ä¸ªå­—æ®µæ¥æ’åˆ—é¡ºåºï¼Œå½“åå­—ç›¸åŒæ—¶ï¼Œåˆ™æ ¹æ®ç¬¬ä¸‰ä¸ªå­—æ®µï¼Œå³å‡ºç”Ÿæ—¥æœŸæ¥æ’åºï¼Œæ­£æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæ‰æœ‰äº†ç´¢å¼•çš„â€œæœ€å·¦åŸåˆ™â€ã€‚\n1ã€MySQLä¸ä¼šä½¿ç”¨ç´¢å¼•çš„æƒ…å†µï¼šéç‹¬ç«‹çš„åˆ— # â€œç‹¬ç«‹çš„åˆ—â€æ˜¯æŒ‡ç´¢å¼•åˆ—ä¸èƒ½æ˜¯è¡¨è¾¾å¼çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸èƒ½æ˜¯å‡½æ•°çš„å‚æ•°ã€‚æ¯”å¦‚ï¼š\nselect * from where id + 1 = 5  æˆ‘ä»¬å¾ˆå®¹æ˜“çœ‹å‡ºå…¶ç­‰ä»·äº id = 4ï¼Œä½†æ˜¯MySQLæ— æ³•è‡ªåŠ¨è§£æè¿™ä¸ªè¡¨è¾¾å¼ï¼Œä½¿ç”¨å‡½æ•°æ˜¯åŒæ ·çš„é“ç†ã€‚\n2ã€å‰ç¼€ç´¢å¼• # å¦‚æœåˆ—å¾ˆé•¿ï¼Œé€šå¸¸å¯ä»¥ç´¢å¼•å¼€å§‹çš„éƒ¨åˆ†å­—ç¬¦ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆèŠ‚çº¦ç´¢å¼•ç©ºé—´ï¼Œä»è€Œæé«˜ç´¢å¼•æ•ˆç‡ã€‚\n3ã€å¤šåˆ—ç´¢å¼•å’Œç´¢å¼•é¡ºåº # åœ¨å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨å¤šä¸ªåˆ—ä¸Šå»ºç«‹ç‹¬ç«‹çš„ç´¢å¼•å¹¶ä¸èƒ½æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚ç†ç”±éå¸¸ç®€å•ï¼ŒMySQLä¸çŸ¥é“é€‰æ‹©å“ªä¸ªç´¢å¼•çš„æŸ¥è¯¢æ•ˆç‡æ›´å¥½ï¼Œæ‰€ä»¥åœ¨è€ç‰ˆæœ¬ï¼Œæ¯”å¦‚MySQL5.0ä¹‹å‰å°±ä¼šéšä¾¿é€‰æ‹©ä¸€ä¸ªåˆ—çš„ç´¢å¼•ï¼Œè€Œæ–°çš„ç‰ˆæœ¬ä¼šé‡‡ç”¨åˆå¹¶ç´¢å¼•çš„ç­–ç•¥ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¸€å¼ ç”µå½±æ¼”å‘˜è¡¨ä¸­ï¼Œåœ¨actor_idå’Œfilm_idä¸¤ä¸ªåˆ—ä¸Šéƒ½å»ºç«‹äº†ç‹¬ç«‹çš„ç´¢å¼•ï¼Œç„¶åæœ‰å¦‚ä¸‹æŸ¥è¯¢ï¼š\nselect film_id,actor_id from film_actor where actor_id = 1 or film_id = 1  è€ç‰ˆæœ¬çš„MySQLä¼šéšæœºé€‰æ‹©ä¸€ä¸ªç´¢å¼•ï¼Œä½†æ–°ç‰ˆæœ¬åšå¦‚ä¸‹çš„ä¼˜åŒ–ï¼š\nselect film_id,actor_id from film_actor where actor_id = 1 union all select film_id,actor_id from film_actor where film_id = 1 and actor_id \u0026lt;\u0026gt; 1   å½“å‡ºç°å¤šä¸ªç´¢å¼•åšç›¸äº¤æ“ä½œæ—¶ï¼ˆå¤šä¸ªANDæ¡ä»¶ï¼‰ï¼Œé€šå¸¸æ¥è¯´ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„ç´¢å¼•è¦ä¼˜äºå¤šä¸ªç‹¬ç«‹ç´¢å¼•ã€‚ å½“å‡ºç°å¤šä¸ªç´¢å¼•åšè”åˆæ“ä½œæ—¶ï¼ˆå¤šä¸ªORæ¡ä»¶ï¼‰ï¼Œå¯¹ç»“æœé›†çš„åˆå¹¶ã€æ’åºç­‰æ“ä½œéœ€è¦è€—è´¹å¤§é‡çš„CPUå’Œå†…å­˜èµ„æºï¼Œç‰¹åˆ«æ˜¯å½“å…¶ä¸­çš„æŸäº›ç´¢å¼•çš„é€‰æ‹©æ€§ä¸é«˜ï¼Œéœ€è¦è¿”å›åˆå¹¶å¤§é‡æ•°æ®æ—¶ï¼ŒæŸ¥è¯¢æˆæœ¬æ›´é«˜ã€‚æ‰€ä»¥è¿™ç§æƒ…å†µä¸‹è¿˜ä¸å¦‚èµ°å…¨è¡¨æ‰«æã€‚  å› æ­¤explainæ—¶å¦‚æœå‘ç°æœ‰ç´¢å¼•åˆå¹¶ï¼ˆExtraå­—æ®µå‡ºç°Using unionï¼‰ï¼Œåº”è¯¥å¥½å¥½æ£€æŸ¥ä¸€ä¸‹æŸ¥è¯¢å’Œè¡¨ç»“æ„æ˜¯ä¸æ˜¯å·²ç»æ˜¯æœ€ä¼˜çš„ï¼Œå¦‚æœæŸ¥è¯¢å’Œè¡¨éƒ½æ²¡æœ‰é—®é¢˜ï¼Œé‚£åªèƒ½è¯´æ˜ç´¢å¼•å»ºçš„éå¸¸ç³Ÿç³•ï¼Œåº”å½“æ…é‡è€ƒè™‘ç´¢å¼•æ˜¯å¦åˆé€‚ï¼Œæœ‰å¯èƒ½ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç›¸å…³åˆ—çš„å¤šåˆ—ç´¢å¼•æ›´é€‚åˆã€‚\nå‰é¢æˆ‘ä»¬æåˆ°è¿‡ç´¢å¼•å¦‚ä½•ç»„ç»‡æ•°æ®å­˜å‚¨çš„ï¼Œä»å›¾ä¸­å¯ä»¥çœ‹åˆ°å¤šåˆ—ç´¢å¼•æ—¶ï¼Œç´¢å¼•çš„é¡ºåºå¯¹äºæŸ¥è¯¢æ˜¯è‡³å…³é‡è¦çš„ï¼Œå¾ˆæ˜æ˜¾åº”è¯¥æŠŠé€‰æ‹©æ€§æ›´é«˜çš„å­—æ®µæ”¾åˆ°ç´¢å¼•çš„å‰é¢ï¼Œè¿™æ ·é€šè¿‡ç¬¬ä¸€ä¸ªå­—æ®µå°±å¯ä»¥è¿‡æ»¤æ‰å¤§å¤šæ•°ä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚\nç´¢å¼•é€‰æ‹©æ€§æ˜¯æŒ‡ä¸é‡å¤çš„ç´¢å¼•å€¼å’Œæ•°æ®è¡¨çš„æ€»è®°å½•æ•°çš„æ¯”å€¼ï¼Œé€‰æ‹©æ€§è¶Šé«˜æŸ¥è¯¢æ•ˆç‡è¶Šé«˜ï¼Œå› ä¸ºé€‰æ‹©æ€§è¶Šé«˜çš„ç´¢å¼•å¯ä»¥è®©MySQLåœ¨æŸ¥è¯¢æ—¶è¿‡æ»¤æ‰æ›´å¤šçš„è¡Œã€‚å”¯ä¸€ç´¢å¼•çš„é€‰æ‹©æ€§æ˜¯1ï¼Œè¿™æ˜¯æœ€å¥½çš„ç´¢å¼•é€‰æ‹©æ€§ï¼Œæ€§èƒ½ä¹Ÿæ˜¯æœ€å¥½çš„ã€‚\nç†è§£ç´¢å¼•é€‰æ‹©æ€§çš„æ¦‚å¿µåï¼Œå°±ä¸éš¾ç¡®å®šå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§è¾ƒé«˜äº†ï¼ŒæŸ¥ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œæ¯”å¦‚ï¼š\nSELECT * FROM payment where staff_id = 2 and customer_id = 584  æ˜¯åº”è¯¥åˆ›å»º(staff_id,customer_id)çš„ç´¢å¼•è¿˜æ˜¯åº”è¯¥é¢ å€’ä¸€ä¸‹é¡ºåºï¼Ÿæ‰§è¡Œä¸‹é¢çš„æŸ¥è¯¢ï¼Œå“ªä¸ªå­—æ®µçš„é€‰æ‹©æ€§æ›´æ¥è¿‘1å°±æŠŠå“ªä¸ªå­—æ®µç´¢å¼•å‰é¢å°±å¥½ã€‚\nselect count(distinct staff_id)/count(*) as staff_id_selectivity, count(distinct customer_id)/count(*) as customer_id_selectivity, count(*) from payment  å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨è¿™ä¸ªåŸåˆ™æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†ä»ç„¶æ³¨æ„ä½ çš„æ•°æ®ä¸­æ˜¯å¦å­˜åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¯”å¦‚è¦æŸ¥è¯¢æŸä¸ªç”¨æˆ·ç»„ä¸‹æœ‰è¿‡äº¤æ˜“çš„ç”¨æˆ·ä¿¡æ¯ï¼š\nselect user_id from trade where user_group_id = 1 and trade_amount \u0026gt; 0  MySQLä¸ºè¿™ä¸ªæŸ¥è¯¢é€‰æ‹©äº†ç´¢å¼•(user_group_id,trade_amount)ï¼Œå¦‚æœä¸è€ƒè™‘ç‰¹æ®Šæƒ…å†µï¼Œè¿™çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä½†å®é™…æƒ…å†µæ˜¯è¿™å¼ è¡¨çš„å¤§å¤šæ•°æ•°æ®éƒ½æ˜¯ä»è€ç³»ç»Ÿä¸­è¿ç§»è¿‡æ¥çš„ï¼Œç”±äºæ–°è€ç³»ç»Ÿçš„æ•°æ®ä¸å…¼å®¹ï¼Œæ‰€ä»¥å°±ç»™è€ç³»ç»Ÿè¿ç§»è¿‡æ¥çš„æ•°æ®èµ‹äºˆäº†ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·ç»„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œé€šè¿‡ç´¢å¼•æ‰«æçš„è¡Œæ•°è·Ÿå…¨è¡¨æ‰«æåŸºæœ¬æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œç´¢å¼•ä¹Ÿå°±èµ·ä¸åˆ°ä»»ä½•ä½œç”¨ã€‚\næ¨å¹¿å¼€æ¥è¯´ï¼Œç»éªŒæ³•åˆ™å’Œæ¨è®ºåœ¨å¤šæ•°æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œå¯ä»¥æŒ‡å¯¼æˆ‘ä»¬å¼€å‘å’Œè®¾è®¡ï¼Œä½†å®é™…æƒ…å†µå¾€å¾€ä¼šæ›´å¤æ‚ï¼Œå®é™…ä¸šåŠ¡åœºæ™¯ä¸‹çš„æŸäº›ç‰¹æ®Šæƒ…å†µå¯èƒ½ä¼šæ‘§æ¯ä½ çš„æ•´ä¸ªè®¾è®¡ã€‚\n4ã€é¿å…å¤šä¸ªèŒƒå›´æ¡ä»¶ # å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸ä½¿ç”¨å¤šä¸ªèŒƒå›´æ¡ä»¶ï¼Œæ¯”å¦‚æƒ³æŸ¥è¯¢æŸä¸ªæ—¶é—´æ®µå†…ç™»å½•è¿‡çš„ç”¨æˆ·ï¼š\nselect user.* from user where login_time \u0026gt; '2017-04-01' and age between 18 and 30;  è¿™ä¸ªæŸ¥è¯¢æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå®ƒæœ‰ä¸¤ä¸ªèŒƒå›´æ¡ä»¶ï¼Œlogin_timeåˆ—å’Œageåˆ—ï¼ŒMySQLå¯ä»¥ä½¿ç”¨login_timeåˆ—çš„ç´¢å¼•æˆ–è€…ageåˆ—çš„ç´¢å¼•ï¼Œä½†æ— æ³•åŒæ—¶ä½¿ç”¨å®ƒä»¬ã€‚\n5ã€è¦†ç›–ç´¢å¼• # å¦‚æœä¸€ä¸ªç´¢å¼•åŒ…å«æˆ–è€…è¯´è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„å­—æ®µçš„å€¼ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰å¿…è¦å†å›è¡¨æŸ¥è¯¢ï¼Œè¿™å°±ç§°ä¸ºè¦†ç›–ç´¢å¼•ã€‚è¦†ç›–ç´¢å¼•æ˜¯éå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥æå¤§çš„æé«˜æ€§èƒ½ï¼Œå› ä¸ºæŸ¥è¯¢åªéœ€è¦æ‰«æç´¢å¼•ä¼šå¸¦æ¥è®¸å¤šå¥½å¤„ï¼š\n ç´¢å¼•æ¡ç›®è¿œå°äºæ•°æ®è¡Œå¤§å°ï¼Œå¦‚æœåªè¯»å–ç´¢å¼•ï¼Œæå¤§å‡å°‘æ•°æ®è®¿é—®é‡ ç´¢å¼•æ˜¯æœ‰æŒ‰ç…§åˆ—å€¼é¡ºåºå­˜å‚¨çš„ï¼Œå¯¹äºI/Oå¯†é›†å‹çš„èŒƒå›´æŸ¥è¯¢è¦æ¯”éšæœºä»ç£ç›˜è¯»å–æ¯ä¸€è¡Œæ•°æ®çš„IOè¦å°‘çš„å¤š  6ã€ä½¿ç”¨ç´¢å¼•æ‰«ææ¥æ’åº # MySQLæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥ç”Ÿäº§æœ‰åºçš„ç»“æœé›†ï¼Œå…¶ä¸€æ˜¯å¯¹ç»“æœé›†è¿›è¡Œæ’åºçš„æ“ä½œï¼Œå…¶äºŒæ˜¯æŒ‰ç…§ç´¢å¼•é¡ºåºæ‰«æå¾—å‡ºçš„ç»“æœè‡ªç„¶æ˜¯æœ‰åºçš„ã€‚å¦‚æœexplainçš„ç»“æœä¸­typeåˆ—çš„å€¼ä¸ºindexè¡¨ç¤ºä½¿ç”¨äº†ç´¢å¼•æ‰«ææ¥åšæ’åºã€‚\næ‰«æç´¢å¼•æœ¬èº«å¾ˆå¿«ï¼Œå› ä¸ºåªéœ€è¦ä»ä¸€æ¡ç´¢å¼•è®°å½•ç§»åŠ¨åˆ°ç›¸é‚»çš„ä¸‹ä¸€æ¡è®°å½•ã€‚ä½†å¦‚æœç´¢å¼•æœ¬èº«ä¸èƒ½è¦†ç›–æ‰€æœ‰éœ€è¦æŸ¥è¯¢çš„åˆ—ï¼Œé‚£ä¹ˆå°±ä¸å¾—ä¸æ¯æ‰«æä¸€æ¡ç´¢å¼•è®°å½•å°±å›è¡¨æŸ¥è¯¢ä¸€æ¬¡å¯¹åº”çš„è¡Œã€‚è¿™ä¸ªè¯»å–æ“ä½œåŸºæœ¬ä¸Šæ˜¯éšæœºI/Oï¼Œå› æ­¤æŒ‰ç…§ç´¢å¼•é¡ºåºè¯»å–æ•°æ®çš„é€Ÿåº¦é€šå¸¸è¦æ¯”é¡ºåºåœ°å…¨è¡¨æ‰«æè¦æ…¢ã€‚\nåœ¨è®¾è®¡ç´¢å¼•æ—¶ï¼Œå¦‚æœä¸€ä¸ªç´¢å¼•æ—¢èƒ½å¤Ÿæ»¡è¶³æ’åºï¼Œåˆæ»¡è¶³æŸ¥è¯¢ï¼Œæ˜¯æœ€å¥½çš„ã€‚\nåªæœ‰å½“ç´¢å¼•çš„åˆ—é¡ºåºå’ŒORDER BYå­å¥çš„é¡ºåºå®Œå…¨ä¸€è‡´ï¼Œå¹¶ä¸”æ‰€æœ‰åˆ—çš„æ’åºæ–¹å‘ä¹Ÿä¸€æ ·æ—¶ï¼Œæ‰èƒ½å¤Ÿä½¿ç”¨ç´¢å¼•æ¥å¯¹ç»“æœåšæ’åºã€‚å¦‚æœæŸ¥è¯¢éœ€è¦å…³è”å¤šå¼ è¡¨ï¼Œåˆ™åªæœ‰ORDER BYå­å¥å¼•ç”¨çš„å­—æ®µå…¨éƒ¨ä¸ºç¬¬ä¸€å¼ è¡¨æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨ç´¢å¼•åšæ’åºã€‚ORDER BYå­å¥å’ŒæŸ¥è¯¢çš„é™åˆ¶æ˜¯ä¸€æ ·çš„ï¼Œéƒ½è¦æ»¡è¶³æœ€å·¦å‰ç¼€çš„è¦æ±‚ï¼ˆæœ‰ä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå°±æ˜¯æœ€å·¦çš„åˆ—è¢«æŒ‡å®šä¸ºå¸¸æ•°ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼‰ï¼Œå…¶ä»–æƒ…å†µä¸‹éƒ½éœ€è¦æ‰§è¡Œæ’åºæ“ä½œï¼Œè€Œæ— æ³•åˆ©ç”¨ç´¢å¼•æ’åºã€‚\n-- æœ€å·¦åˆ—ä¸ºå¸¸æ•°ï¼Œç´¢å¼•ï¼š(date,staff_id,customer_id) select staff_id,customer_id from demo where date = '2015-06-01' ``order by staff_id,customer_id  7ã€å†—ä½™å’Œé‡å¤ç´¢å¼• # å†—ä½™ç´¢å¼•æ˜¯æŒ‡åœ¨ç›¸åŒçš„åˆ—ä¸ŠæŒ‰ç…§ç›¸åŒçš„é¡ºåºåˆ›å»ºçš„ç›¸åŒç±»å‹çš„ç´¢å¼•ï¼Œåº”å½“å°½é‡é¿å…è¿™ç§ç´¢å¼•ï¼Œå‘ç°åç«‹å³åˆ é™¤ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªç´¢å¼•(A,B)ï¼Œå†åˆ›å»ºç´¢å¼•(A)å°±æ˜¯å†—ä½™ç´¢å¼•ã€‚å†—ä½™ç´¢å¼•ç»å¸¸å‘ç”Ÿåœ¨ä¸ºè¡¨æ·»åŠ æ–°ç´¢å¼•æ—¶ï¼Œæ¯”å¦‚æœ‰äººæ–°å»ºäº†ç´¢å¼•(A,B)ï¼Œä½†è¿™ä¸ªç´¢å¼•ä¸æ˜¯æ‰©å±•å·²æœ‰çš„ç´¢å¼•(A)ã€‚\nå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½åº”è¯¥å°½é‡æ‰©å±•å·²æœ‰çš„ç´¢å¼•è€Œä¸æ˜¯åˆ›å»ºæ–°ç´¢å¼•ã€‚ä½†æœ‰æå°‘æƒ…å†µä¸‹å‡ºç°æ€§èƒ½æ–¹é¢çš„è€ƒè™‘éœ€è¦å†—ä½™ç´¢å¼•ï¼Œæ¯”å¦‚æ‰©å±•å·²æœ‰ç´¢å¼•è€Œå¯¼è‡´å…¶å˜å¾—è¿‡å¤§ï¼Œä»è€Œå½±å“åˆ°å…¶ä»–ä½¿ç”¨è¯¥ç´¢å¼•çš„æŸ¥è¯¢ã€‚\n8ã€åˆ é™¤é•¿æœŸæœªä½¿ç”¨çš„ç´¢å¼• # å®šæœŸåˆ é™¤ä¸€äº›é•¿æ—¶é—´æœªä½¿ç”¨è¿‡çš„ç´¢å¼•æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¹ æƒ¯ã€‚\nå…³äºç´¢å¼•è¿™ä¸ªè¯é¢˜æ‰“ç®—å°±æ­¤æ‰“ä½ï¼Œæœ€åè¦è¯´ä¸€å¥ï¼Œç´¢å¼•å¹¶ä¸æ€»æ˜¯æœ€å¥½çš„å·¥å…·ï¼Œåªæœ‰å½“ç´¢å¼•å¸®åŠ©æé«˜æŸ¥è¯¢é€Ÿåº¦å¸¦æ¥çš„å¥½å¤„å¤§äºå…¶å¸¦æ¥çš„é¢å¤–å·¥ä½œæ—¶ï¼Œç´¢å¼•æ‰æ˜¯æœ‰æ•ˆçš„ã€‚å¯¹äºéå¸¸å°çš„è¡¨ï¼Œç®€å•çš„å…¨è¡¨æ‰«ææ›´é«˜æ•ˆã€‚å¯¹äºä¸­åˆ°å¤§å‹çš„è¡¨ï¼Œç´¢å¼•å°±éå¸¸æœ‰æ•ˆã€‚å¯¹äºè¶…å¤§å‹çš„è¡¨ï¼Œå»ºç«‹å’Œç»´æŠ¤ç´¢å¼•çš„ä»£ä»·éšä¹‹å¢é•¿ï¼Œè¿™æ—¶å€™å…¶ä»–æŠ€æœ¯ä¹Ÿè®¸æ›´æœ‰æ•ˆï¼Œæ¯”å¦‚åˆ†åŒºè¡¨ã€‚æœ€åçš„æœ€åï¼Œexplainåå†ææµ‹æ˜¯ä¸€ç§ç¾å¾·ã€‚\nç‰¹å®šç±»å‹æŸ¥è¯¢ä¼˜åŒ– # ä¼˜åŒ–COUNT()æŸ¥è¯¢ # COUNT()å¯èƒ½æ˜¯è¢«å¤§å®¶è¯¯è§£æœ€å¤šçš„å‡½æ•°äº†ï¼Œå®ƒæœ‰ä¸¤ç§ä¸åŒçš„ä½œç”¨ï¼Œå…¶ä¸€æ˜¯ç»Ÿè®¡æŸä¸ªåˆ—å€¼çš„æ•°é‡ï¼Œå…¶äºŒæ˜¯ç»Ÿè®¡è¡Œæ•°ã€‚ç»Ÿè®¡åˆ—å€¼æ—¶ï¼Œè¦æ±‚åˆ—å€¼æ˜¯éç©ºçš„ï¼Œå®ƒä¸ä¼šç»Ÿè®¡NULLã€‚å¦‚æœç¡®è®¤æ‹¬å·ä¸­çš„è¡¨è¾¾å¼ä¸å¯èƒ½ä¸ºç©ºæ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯åœ¨ç»Ÿè®¡è¡Œæ•°ã€‚æœ€ç®€å•çš„å°±æ˜¯å½“ä½¿ç”¨COUNT(*)æ—¶ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€æƒ³è±¡çš„é‚£æ ·æ‰©å±•æˆæ‰€æœ‰çš„åˆ—ï¼Œå®é™…ä¸Šï¼Œå®ƒä¼šå¿½ç•¥æ‰€æœ‰çš„åˆ—è€Œç›´æ¥ç»Ÿè®¡è¡Œæ•°ã€‚\næˆ‘ä»¬æœ€å¸¸è§çš„è¯¯è§£ä¹Ÿå°±åœ¨è¿™å„¿ï¼Œåœ¨æ‹¬å·å†…æŒ‡å®šäº†ä¸€åˆ—å´å¸Œæœ›ç»Ÿè®¡ç»“æœæ˜¯è¡Œæ•°ï¼Œè€Œä¸”è¿˜å¸¸å¸¸è¯¯ä»¥ä¸ºå‰è€…çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚ä½†å®é™…å¹¶éè¿™æ ·ï¼Œå¦‚æœè¦ç»Ÿè®¡è¡Œæ•°ï¼Œç›´æ¥ä½¿ç”¨COUNT(*)ï¼Œæ„ä¹‰æ¸…æ™°ï¼Œä¸”æ€§èƒ½æ›´å¥½ã€‚\næœ‰æ—¶å€™æŸäº›ä¸šåŠ¡åœºæ™¯å¹¶ä¸éœ€è¦å®Œå…¨ç²¾ç¡®çš„COUNTå€¼ï¼Œå¯ä»¥ç”¨è¿‘ä¼¼å€¼æ¥ä»£æ›¿ï¼ŒEXPLAINå‡ºæ¥çš„è¡Œæ•°å°±æ˜¯ä¸€ä¸ªä¸é”™çš„è¿‘ä¼¼å€¼ï¼Œè€Œä¸”æ‰§è¡ŒEXPLAINå¹¶ä¸éœ€è¦çœŸæ­£åœ°å»æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‰€ä»¥æˆæœ¬éå¸¸ä½ã€‚é€šå¸¸æ¥è¯´ï¼Œæ‰§è¡ŒCOUNT()éƒ½éœ€è¦æ‰«æå¤§é‡çš„è¡Œæ‰èƒ½è·å–åˆ°ç²¾ç¡®çš„æ•°æ®ï¼Œå› æ­¤å¾ˆéš¾ä¼˜åŒ–ï¼ŒMySQLå±‚é¢è¿˜èƒ½åšå¾—ä¹Ÿå°±åªæœ‰è¦†ç›–ç´¢å¼•äº†ã€‚å¦‚æœä¸è¿˜èƒ½è§£å†³é—®é¢˜ï¼Œåªæœ‰ä»æ¶æ„å±‚é¢è§£å†³äº†ï¼Œæ¯”å¦‚æ·»åŠ æ±‡æ€»è¡¨ï¼Œæˆ–è€…ä½¿ç”¨redisè¿™æ ·çš„å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿã€‚\nä¼˜åŒ–å…³è”æŸ¥è¯¢ # åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹ï¼Œè¡¨ä¸è¡¨ä¹‹é—´é€šè¿‡ä¸€ä¸ªå†—ä½™å­—æ®µæ¥å…³è”ï¼Œè¦æ¯”ç›´æ¥ä½¿ç”¨JOINæœ‰æ›´å¥½çš„æ€§èƒ½ã€‚å¦‚æœç¡®å®éœ€è¦ä½¿ç”¨å…³è”æŸ¥è¯¢çš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š\n ç¡®ä¿ONå’ŒUSINGå­—å¥ä¸­çš„åˆ—ä¸Šæœ‰ç´¢å¼•ã€‚åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™å°±è¦è€ƒè™‘åˆ°å…³è”çš„é¡ºåºã€‚å½“è¡¨Aå’Œè¡¨Bç”¨åˆ—cå…³è”çš„æ—¶å€™ï¼Œå¦‚æœä¼˜åŒ–å™¨å…³è”çš„é¡ºåºæ˜¯Aã€Bï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åœ¨Aè¡¨çš„å¯¹åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ã€‚æ²¡æœ‰ç”¨åˆ°çš„ç´¢å¼•ä¼šå¸¦æ¥é¢å¤–çš„è´Ÿæ‹…ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œé™¤éæœ‰å…¶ä»–ç†ç”±ï¼Œåªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼ˆå…·ä½“åŸå› ä¸‹æ–‡åˆ†æï¼‰ã€‚ ç¡®ä¿ä»»ä½•çš„GROUP BYå’ŒORDER BYä¸­çš„è¡¨è¾¾å¼åªæ¶‰åŠåˆ°ä¸€ä¸ªè¡¨ä¸­çš„åˆ—ï¼Œè¿™æ ·MySQLæ‰æœ‰å¯èƒ½ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–ã€‚  è¦ç†è§£ä¼˜åŒ–å…³è”æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ªæŠ€å·§ï¼Œå°±éœ€è¦ç†è§£MySQLæ˜¯å¦‚ä½•æ‰§è¡Œå…³è”æŸ¥è¯¢çš„ã€‚å½“å‰MySQLå…³è”æ‰§è¡Œçš„ç­–ç•¥éå¸¸ç®€å•ï¼Œå®ƒå¯¹ä»»ä½•çš„å…³è”éƒ½æ‰§è¡ŒåµŒå¥—å¾ªç¯å…³è”æ“ä½œï¼Œå³å…ˆåœ¨ä¸€ä¸ªè¡¨ä¸­å¾ªç¯å–å‡ºå•æ¡æ•°æ®ï¼Œç„¶ååœ¨åµŒå¥—å¾ªç¯åˆ°ä¸‹ä¸€ä¸ªè¡¨ä¸­å¯»æ‰¾åŒ¹é…çš„è¡Œï¼Œä¾æ¬¡ä¸‹å»ï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰è¡¨ä¸­åŒ¹é…çš„è¡Œä¸ºä¸ºæ­¢ã€‚ç„¶åæ ¹æ®å„ä¸ªè¡¨åŒ¹é…çš„è¡Œï¼Œè¿”å›æŸ¥è¯¢ä¸­éœ€è¦çš„å„ä¸ªåˆ—ã€‚\nå¤ªæŠ½è±¡äº†ï¼Ÿä»¥ä¸Šé¢çš„ç¤ºä¾‹æ¥è¯´æ˜ï¼Œæ¯”å¦‚æœ‰è¿™æ ·çš„ä¸€ä¸ªæŸ¥è¯¢ï¼š\nSELECT A.xx,B.yy FROM A INNER JOIN B USING(c) WHERE A.xx IN (5,6)  å‡è®¾MySQLæŒ‰ç…§æŸ¥è¯¢ä¸­çš„å…³è”é¡ºåºAã€Bæ¥è¿›è¡Œå…³è”æ“ä½œï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ä¸‹é¢çš„ä¼ªä»£ç è¡¨ç¤ºMySQLå¦‚ä½•å®Œæˆè¿™ä¸ªæŸ¥è¯¢ï¼š\nouter_iterator = SELECT A.xx,A.c FROM A WHERE A.xx IN (5,6); outer_row = outer_iterator.next; while(outer_row) { inner_iterator = SELECT B.yy FROM B WHERE B.c = outer_row.c; inner_row = inner_iterator.next; while(inner_row) { output[inner_row.yy,outer_row.xx]; inner_row = inner_iterator.next; } outer_row = outer_iterator.next; }  å¯ä»¥çœ‹åˆ°ï¼Œæœ€å¤–å±‚çš„æŸ¥è¯¢æ˜¯æ ¹æ®A.xxåˆ—æ¥æŸ¥è¯¢çš„ï¼ŒA.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œæ•´ä¸ªå…³è”æŸ¥è¯¢ä¹Ÿä¸ä¼šä½¿ç”¨ã€‚å†çœ‹å†…å±‚çš„æŸ¥è¯¢ï¼Œå¾ˆæ˜æ˜¾B.cä¸Šå¦‚æœæœ‰ç´¢å¼•çš„è¯ï¼Œèƒ½å¤ŸåŠ é€ŸæŸ¥è¯¢ï¼Œå› æ­¤åªéœ€è¦åœ¨å…³è”é¡ºåºä¸­çš„ç¬¬äºŒå¼ è¡¨çš„ç›¸åº”åˆ—ä¸Šåˆ›å»ºç´¢å¼•å³å¯ã€‚\nä¼˜åŒ–LIMITåˆ†é¡µ # å½“éœ€è¦åˆ†é¡µæ“ä½œæ—¶ï¼Œé€šå¸¸ä¼šä½¿ç”¨LIMITåŠ ä¸Šåç§»é‡çš„åŠæ³•å®ç°ï¼ŒåŒæ—¶åŠ ä¸Šåˆé€‚çš„ORDER BYå­—å¥ã€‚å¦‚æœæœ‰å¯¹åº”çš„ç´¢å¼•ï¼Œé€šå¸¸æ•ˆç‡ä¼šä¸é”™ï¼Œå¦åˆ™ï¼ŒMySQLéœ€è¦åšå¤§é‡çš„æ–‡ä»¶æ’åºæ“ä½œã€‚\nä¸€ä¸ªå¸¸è§çš„é—®é¢˜æ˜¯å½“åç§»é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œæ¯”å¦‚ï¼šLIMIT 10000 20è¿™æ ·çš„æŸ¥è¯¢ï¼ŒMySQLéœ€è¦æŸ¥è¯¢10020æ¡è®°å½•ç„¶ååªè¿”å›20æ¡è®°å½•ï¼Œå‰é¢çš„10000æ¡éƒ½å°†è¢«æŠ›å¼ƒï¼Œè¿™æ ·çš„ä»£ä»·éå¸¸é«˜ã€‚\nä¼˜åŒ–è¿™ç§æŸ¥è¯¢ä¸€ä¸ªæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å°½å¯èƒ½çš„ä½¿ç”¨è¦†ç›–ç´¢å¼•æ‰«æï¼Œè€Œä¸æ˜¯æŸ¥è¯¢æ‰€æœ‰çš„åˆ—ã€‚ç„¶åæ ¹æ®éœ€è¦åšä¸€æ¬¡å…³è”æŸ¥è¯¢å†è¿”å›æ‰€æœ‰çš„åˆ—ã€‚å¯¹äºåç§»é‡å¾ˆå¤§æ—¶ï¼Œè¿™æ ·åšçš„æ•ˆç‡ä¼šæå‡éå¸¸å¤§ã€‚è€ƒè™‘ä¸‹é¢çš„æŸ¥è¯¢ï¼š\nSELECT film_id,description FROM film ORDER BY title LIMIT 50,5;  å¦‚æœè¿™å¼ è¡¨éå¸¸å¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢æœ€å¥½æ”¹æˆä¸‹é¢çš„æ ·å­ï¼š\nSELECT film.film_id,film.description FROM film INNER JOIN ( SELECT film_id FROM film ORDER BY title LIMIT 50,5 ) AS tmp USING(film_id);  è¿™é‡Œçš„å»¶è¿Ÿå…³è”å°†å¤§å¤§æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œè®©MySQLæ‰«æå°½å¯èƒ½å°‘çš„é¡µé¢ï¼Œè·å–éœ€è¦è®¿é—®çš„è®°å½•ååœ¨æ ¹æ®å…³è”åˆ—å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„åˆ—ã€‚\næœ‰æ—¶å€™å¦‚æœå¯ä»¥ä½¿ç”¨ä¹¦ç­¾è®°å½•ä¸Šæ¬¡å–æ•°æ®çš„ä½ç½®ï¼Œé‚£ä¹ˆä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥ä»è¯¥ä¹¦ç­¾è®°å½•çš„ä½ç½®å¼€å§‹æ‰«æï¼Œè¿™æ ·å°±å¯ä»¥é¿å…ä½¿ç”¨OFFSETï¼Œæ¯”å¦‚ä¸‹é¢çš„æŸ¥è¯¢ï¼š\nSELECT id FROM t LIMIT 10000, 10;  æ”¹ä¸ºï¼š\nSELECT id FROM t WHERE id \u0026gt; 10000 LIMIT 10;  å…¶ä»–ä¼˜åŒ–çš„åŠæ³•è¿˜åŒ…æ‹¬ä½¿ç”¨é¢„å…ˆè®¡ç®—çš„æ±‡æ€»è¡¨ï¼Œæˆ–è€…å…³è”åˆ°ä¸€ä¸ªå†—ä½™è¡¨ï¼Œå†—ä½™è¡¨ä¸­åªåŒ…å«ä¸»é”®åˆ—å’Œéœ€è¦åšæ’åºçš„åˆ—ã€‚\nä¼˜åŒ–UNION # MySQLå¤„ç†UNIONçš„ç­–ç•¥æ˜¯å…ˆåˆ›å»ºä¸´æ—¶è¡¨ï¼Œç„¶åå†æŠŠå„ä¸ªæŸ¥è¯¢ç»“æœæ’å…¥åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œæœ€åå†æ¥åšæŸ¥è¯¢ã€‚å› æ­¤å¾ˆå¤šä¼˜åŒ–ç­–ç•¥åœ¨UNIONæŸ¥è¯¢ä¸­éƒ½æ²¡æœ‰åŠæ³•å¾ˆå¥½çš„æ—¶å€™ã€‚ç»å¸¸éœ€è¦æ‰‹åŠ¨å°†WHEREã€LIMITã€ORDER BYç­‰å­—å¥â€œä¸‹æ¨â€åˆ°å„ä¸ªå­æŸ¥è¯¢ä¸­ï¼Œä»¥ä¾¿ä¼˜åŒ–å™¨å¯ä»¥å……åˆ†åˆ©ç”¨è¿™äº›æ¡ä»¶å…ˆä¼˜åŒ–ã€‚\né™¤éç¡®å®éœ€è¦æœåŠ¡å™¨å»é‡ï¼Œå¦åˆ™å°±ä¸€å®šè¦ä½¿ç”¨UNION ALLï¼Œå¦‚æœæ²¡æœ‰ALLå…³é”®å­—ï¼ŒMySQLä¼šç»™ä¸´æ—¶è¡¨åŠ ä¸ŠDISTINCTé€‰é¡¹ï¼Œè¿™ä¼šå¯¼è‡´æ•´ä¸ªä¸´æ—¶è¡¨çš„æ•°æ®åšå”¯ä¸€æ€§æ£€æŸ¥ï¼Œè¿™æ ·åšçš„ä»£ä»·éå¸¸é«˜ã€‚å½“ç„¶å³ä½¿ä½¿ç”¨ALLå…³é”®å­—ï¼ŒMySQLæ€»æ˜¯å°†ç»“æœæ”¾å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åå†è¯»å‡ºï¼Œå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è™½ç„¶å¾ˆå¤šæ—¶å€™æ²¡æœ‰è¿™ä¸ªå¿…è¦ï¼Œæ¯”å¦‚æœ‰æ—¶å€™å¯ä»¥ç›´æ¥æŠŠæ¯ä¸ªå­æŸ¥è¯¢çš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚\nç»“è¯­ # ç†è§£æŸ¥è¯¢æ˜¯å¦‚ä½•æ‰§è¡Œä»¥åŠæ—¶é—´éƒ½æ¶ˆè€—åœ¨å“ªäº›åœ°æ–¹ï¼Œå†åŠ ä¸Šä¸€äº›ä¼˜åŒ–è¿‡ç¨‹çš„çŸ¥è¯†ï¼Œå¯ä»¥å¸®åŠ©å¤§å®¶æ›´å¥½çš„ç†è§£MySQLï¼Œç†è§£å¸¸è§ä¼˜åŒ–æŠ€å·§èƒŒåçš„åŸç†ã€‚å¸Œæœ›æœ¬æ–‡ä¸­çš„åŸç†ã€ç¤ºä¾‹èƒ½å¤Ÿå¸®åŠ©å¤§å®¶æ›´å¥½çš„å°†ç†è®ºå’Œå®è·µè”ç³»èµ·æ¥ï¼Œæ›´å¤šçš„å°†ç†è®ºçŸ¥è¯†è¿ç”¨åˆ°å®è·µä¸­ã€‚\nå…¶ä»–ä¹Ÿæ²¡å•¥è¯´çš„äº†ï¼Œç»™å¤§å®¶ç•™ä¸¤ä¸ªæ€è€ƒé¢˜å§ï¼Œå¯ä»¥åœ¨è„‘è¢‹é‡Œæƒ³æƒ³ç­”æ¡ˆï¼Œè¿™ä¹Ÿæ˜¯å¤§å®¶ç»å¸¸æŒ‚åœ¨å˜´è¾¹çš„ï¼Œä½†å¾ˆå°‘æœ‰äººä¼šæ€è€ƒä¸ºä»€ä¹ˆï¼Ÿ\n æœ‰éå¸¸å¤šçš„ç¨‹åºå‘˜åœ¨åˆ†äº«æ—¶éƒ½ä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼šå°½å¯èƒ½ä¸è¦ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éå¸¸ä¸å®¹æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¼šå¢åŠ ä½¿ç”¨æˆæœ¬ï¼Œåº”è¯¥æŠŠä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®¢æˆ·ç«¯ã€‚æ—¢ç„¶å®¢æˆ·ç«¯éƒ½èƒ½å¹²è¿™äº›äº‹ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å­˜å‚¨è¿‡ç¨‹ï¼Ÿ JOINæœ¬èº«ä¹ŸæŒºæ–¹ä¾¿çš„ï¼Œç›´æ¥æŸ¥è¯¢å°±å¥½äº†ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦è§†å›¾å‘¢ï¼Ÿ  å‚è€ƒèµ„æ–™ #  [1] å§œæ‰¿å°§ è‘—ï¼›MySQLæŠ€æœ¯å†…å¹•-InnoDBå­˜å‚¨å¼•æ“ï¼›æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ï¼Œ2013 [2] Baron Scbwartz ç­‰è‘—ï¼›å®æµ·å…ƒ å‘¨æŒ¯å…´ç­‰è¯‘ï¼›é«˜æ€§èƒ½MySQLï¼ˆç¬¬ä¸‰ç‰ˆï¼‰; ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾ï¼Œ 2013 [3] ç”± B-/B+æ ‘çœ‹ MySQLç´¢å¼•ç»“æ„\n "}),a.add({id:96,href:"/tags/bazelbuild/",title:"bazelbuild",description:"",content:""}),a.add({id:97,href:"/blog/2021-10-21-bazelbuild%E6%9E%84%E5%BB%BAgo%E5%BE%AE%E6%9C%8D%E5%8A%A1/",title:"bazelbuildï¼šæ„å»ºgoå¾®æœåŠ¡",description:"å…³äºmonorepoã€multirepoçš„äº‰è®ºä¸ç»äºè€³ï¼Œè‡³äºé‡‡ç”¨å“ªç§æ–¹å¼è¿›è¡Œç®¡ç†ï¼Œè¦å› åœ°åˆ¶å®œåœ°é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆï¼Œè¦çœ‹åˆ°å…¶ä¼˜åŠ¿ï¼Œä¹Ÿè¦çœ‹åˆ°å·¥å…·å»ºè®¾å’Œè¿ç§»çš„æˆæœ¬ã€‚è¿™é‡Œé‡ç‚¹è°ˆä¸‹å„è‡ªçš„ä¼˜åŠ¿åŠä»€ä¹ˆæ—¶å€™é€‚ç”¨Bazelæ„å»ºã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  1 å‰è¨€ # å…³äºmonorepoã€multirepoçš„äº‰è®ºä¸ç»äºè€³ï¼Œè‡³äºé‡‡ç”¨å“ªç§æ–¹å¼è¿›è¡Œç®¡ç†ï¼Œè¦å› åœ°åˆ¶å®œåœ°é€‰æ‹©æœ€åˆé€‚çš„æ–¹æ¡ˆï¼Œè¦çœ‹åˆ°å…¶ä¼˜åŠ¿ï¼Œä¹Ÿè¦çœ‹åˆ°å·¥å…·å»ºè®¾å’Œè¿ç§»çš„æˆæœ¬ã€‚è¿™é‡Œé‡ç‚¹è°ˆä¸‹å„è‡ªçš„ä¼˜åŠ¿åŠä»€ä¹ˆæ—¶å€™é€‚ç”¨Bazelæ„å»ºã€‚\n1.1 monorepo # å¦‚æœå›¢é˜Ÿé‡‡ç”¨çš„æ˜¯å¸Œæœ›æ”¹å–„ä»£ç å¤ç”¨ã€å¸Œæœ›è®©çƒ‚ä»£ç æ— å¤„éå½¢ã€å¸Œæœ›æ„å»ºä¸€è‡´çš„CI/CDæ ‡å‡†å¹¶è½åœ°ã€å¸Œæœ›æ›´å¥½åœ°æ²‰æ·€ç»éªŒã€å¸Œæœ›æ›´å¥½åœ°ä¿ƒè¿›å›¢é˜Ÿæˆå‘˜æˆé•¿ç­‰ç­‰ï¼Œè€ƒè™‘åˆ°è¿™äº›ï¼Œä¼¼ä¹monorepoæ˜¯æ›´å¥½çš„ä»£ç ç®¡ç†æ–¹å¼ã€‚\nä½†æ˜¯ä¹Ÿè¦è€ƒè™‘ä»£ç ç®¡ç†çš„è§„æ¨¡ã€æ˜¯å¦å¤šè¯­è¨€æŠ€æœ¯æ ˆã€å¦‚ä½•ä¿è¯é«˜æ•ˆã€å°é—­ã€å¯é‡å¤çš„æ„å»ºã€‚\nè™½ç„¶googleã€uberã€twitterç­‰å¾ˆå¤šå›½å†…å¤–å¤§å‚éƒ½é‡‡ç”¨äº†monorepoæ–¹å¼è¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯ä¹Ÿè¦çœ‹åˆ°è¿™èƒŒåæŠ•å…¥çš„å¤§é‡çš„åŸºç¡€å·¥å…·ã€å¹³å°çš„å»ºè®¾ï¼Œè¿™äº›å¹¶ä¸æ˜¯æ¯ä¸ªå…¬å¸ã€å›¢é˜Ÿæ‰€èƒ½äºˆä»¥æ”¯æŒçš„ã€‚ç›®å‰å¼€æºçš„æŠ€æœ¯æ–¹æ¡ˆä¹Ÿå¹¶éå®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚\nè°·æ­Œä¸ºä»€ä¹ˆé‡‡ç”¨å•ä»“ï¼šWhy Google Stores Billions of Lines of Code in a Single Repository\n1.2 multirepo # multirepoæ¯ä¸ªä»“åº“ä»£ç è§„æ¨¡å°ï¼Œçµæ´»æ˜“ç®¡ç†ï¼Œåšä»€ä¹ˆè°ƒæ•´ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œä¹Ÿä¸éœ€è¦ç‰¹åˆ«é‡çš„åŸºç¡€å·¥å…·ã€å¹³å°çš„æ”¯æŒï¼Œå½“ç„¶å¦‚æœæœ‰å¤§è§„æ¨¡ä»£ç æ£€ç´¢ç­‰ä¹‹ç±»çš„å·¥å…·åŠ æˆï¼Œä¹Ÿç®—é”¦ä¸Šæ·»èŠ±ã€‚\nå¯¹äºå°ä»“æ¨¡å¼ã€å¤§ä»“æ¨¡å¼ä¹‹äº‰ï¼Œå¾®ä¿¡åŒäº‹æ›¾ç»æœ‰ä¸“é—¨åšè¿‡ä¸€ä¸ªå…·ä½“çš„å°ä»“æ¨¡å¼å®è·µåˆ†äº«ã€‚\n1.3 æ„å»ºç³»ç»Ÿ # è¿™ä¸ªä¸–ç•Œå°±æ²¡æœ‰æ‰€è°“çš„é“¶å¼¹ï¼Œå½“æˆ‘ä»¬ä¼å›¾ç”¨ä¸€ç§çœ‹ä¼¼ä¸é”™çš„æ–¹æ¡ˆè§£å†³é—®é¢˜æ—¶ï¼Œè¿™ç§æ–¹æ¡ˆæœ¬èº«ä¹Ÿä¼šé‡æ–°å¼•å…¥ä¸€äº›æ–°çš„é—®é¢˜ã€‚æ‰€ä»¥é‡ä½“è£è¡£ã€å› åœ°åˆ¶å®œå¾ˆé‡è¦ï¼Œå¸Œæœ›æˆ‘ä»¬èƒ½ç»“åˆè‡ªèº«æƒ…å†µï¼ˆåŸºç¡€å¹³å°ã€å·¥ç¨‹ç´ å…»ç°çŠ¶ã€ä¸šåŠ¡åœºæ™¯ã€ä¸šåŠ¡è¿­ä»£æ•ˆç‡ã€äº§å“å®šä½ç­‰ç­‰ï¼‰é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚\npsï¼šæˆ‘è®¤ä¸ºï¼Œmonorepoçš„è§„æ¨¡è‡³å°‘è¦åšåˆ°éƒ¨é—¨åŠä»¥ä¸Šçº§åˆ«ï¼Œå¦åˆ™çœŸçš„å°±æ˜¯è´¹åŠ›ä¸è®¨å¥½ã€‚\nå…³äºmonorepoã€multirepoçš„å¼‚åŒã€ä¼˜ç¼ºç‚¹è¿™é‡Œå°±æš‚ä¸è®¨è®ºäº†ï¼Œè¿™é‡Œå‡†å¤‡è®¨è®ºä¸‹monorepoä¸‹çš„æ„å»ºç³»ç»Ÿæ”¯æŒã€‚\ngoä¸€èˆ¬ç”¨go moduleæ„å»ºï¼Œjavaä¸€èˆ¬ç”¨gradleæˆ–è€…mavenæ„å»ºï¼Œc++ä¸€èˆ¬ç”¨cmakeæˆ–makefileæ„å»ºâ€¦æ€»ä¹‹æœ‰å¾ˆå¤šç±»ä¼¼çš„æ„å»ºæ–¹å¼ï¼Œç°åœ¨æ˜¯å¤šè¯­è¨€åŒä¸€ä¸ªrepoç®¡ç†ï¼Œå¦‚æœä¾ç„¶å„ä¸ªè¯­è¨€å„è‡ªä¸€å¥—æ„å»ºç³»ç»Ÿçš„è¯ï¼Œéšç€ä»£ç è§„æ¨¡ä¸Šå‡ï¼Œä¼šå˜å¾—å¾ˆéš¾ç®¡ç†ã€‚\nä¸€ä¸ªå¥½çš„æ„å»ºç³»ç»Ÿå¿…é¡»éœ€è¦è§£å†³å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š\n- å¦‚ä½•å»ºæ¨¡å¾…æ„å»ºç›®æ ‡çš„ä¾èµ–æ¸…å•ï¼›\n- å¦‚ä½•å®ç°é«˜æ•ˆåœ°æ„å»ºï¼›\n- å¦‚ä½•ä¿è¯å¯é‡å¤åœ°æ„å»ºï¼›\n- å¦‚ä½•è§£å†³å¤šè¯­è¨€æ„å»ºé—®é¢˜ï¼›\nç›®å‰æ¥çœ‹ï¼Œä»äº’è”ç½‘å¤§å‚åŠå¼€æºç¤¾åŒºçš„åé¦ˆæ¥çœ‹ï¼Œè°·æ­Œå¼€æºçš„bazelåº”è¯¥æ˜¯å½“å‰çš„ä¸»æµæ–¹æ¡ˆã€‚\n2 BazelåŸºç¡€ # æœ¬æ–‡åç»­è®¨è®ºå»ºç«‹åœ¨å¼€å‘å›¢é˜ŸåŸºäºâ€œmonorepo+multi-languageâ€çš„èƒŒæ™¯ä¸‹ï¼Œåº”è¯¥å¦‚ä½•ä½¿ç”¨bazelå¯¹trpc-goé¡¹ç›®è¿›è¡Œæ„å»ºã€‚ä¸æ­¤æ— å…³çš„å†…å®¹ä¸äºˆä»¥è®¨è®ºã€‚\n2.1 ä¸ºä»€ä¹ˆç”¨Bazel # - ä»£ç ç®¡ç†æ–¹å¼ï¼šmonorepo\n- repoä¸­åŒ…å«å¤šç§ç¼–ç¨‹è¯­è¨€å¼€å‘çš„projectsï¼›\n- è‡ªå®šä¹‰rulesã€targetæ¥ç”Ÿæˆæ–‡ä»¶ï¼Œå¦‚é€šè¿‡pbç”Ÿæˆpb.goï¼ˆä¸æäº¤ä»£ç ç‰ˆæœ¬æ§åˆ¶ï¼‰ï¼›\n- é€šè¿‡å°é—­æ„å»ºï¼Œæ¥ä¿è¯å¯é‡å¤æ„å»ºï¼›\n- å¸Œæœ›èƒ½å®ç°æ›´ç»†ç²’åº¦çš„å¢é‡æ„å»ºï¼›\n- å¸Œæœ›èƒ½å®ç°åˆ†å¸ƒå¼æ„å»ºï¼›\n- å¸Œæœ›èƒ½åˆ©ç”¨æ„å»ºç¼“å­˜é¿å…ä¸å¿…è¦åœ°é‡å¤æ„å»ºï¼›\n- etcï¼›\npsï¼šif using multirepo \u0026amp;\u0026amp; go build, forget bazel. it overkills your project.\n2.2 Bazelæ ¸å¿ƒæ¦‚å¿µ # bazelçš„ä¸Šæ‰‹æˆæœ¬ç›¸å¯¹ç†Ÿæ‚‰go moduleçš„åŒå­¦æ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬çš„ï¼Œå­¦ä¹ bazelå¹¶ä¸è½»æ¾ï¼Œä½†æ˜¯éšç€å®è·µå¹¶é™†ç»­ä½“ä¼šåˆ°monorepo+bazelå¸¦æ¥çš„å¥½å¤„ä¹‹åï¼Œä¼šå‘ç°bazelæ˜¯éå¸¸å¥½çš„ä¸€ä¸ªæ„å»ºç³»ç»Ÿã€‚å½“ç„¶ï¼Œä¹Ÿå¯èƒ½ä½“ä¼šä¸åˆ° :(ã€‚\nè¦æƒ³ç†Ÿç»ƒä½¿ç”¨bazelï¼Œç†è§£å…¶å·¥ä½œåŸç†ä¸å¯ç¼ºå°‘çš„ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹bazelæ„å»ºçš„æ ¸å¿ƒæ¦‚å¿µã€‚\n2.2.1 WORKSPACE # WORKSPACEï¼Œæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä½äºrepoæ ¹ç›®å½•ä¸‹ï¼Œè¿™æ ·çš„repoä¹Ÿç§°bazelå·¥ä½œåŒºã€‚\nWORKSPACEæ–‡ä»¶ï¼Œå®šä¹‰äº†å·¥ä½œåŒºä¸‹é¡¹ç›®ä¾èµ–çš„æ„å»ºè§„åˆ™ã€å¤–éƒ¨ä¾èµ–ç­‰ï¼Œbazelæ„å»ºtargetsæ—¶éœ€è¦çš„è¾“å…¥ã€BUILDæ–‡ä»¶éƒ½åœ¨å·¥ä½œåŒºä¸‹æœç´¢ï¼Œæ„å»ºtargetsçš„è¾“å‡ºä¹Ÿæ˜¯å­˜å‚¨åœ¨å·¥ä½œåŒºä¸­ã€‚\nbazelè¿è¡Œè¿‡ç¨‹ä¸­ä¼šåœ¨å·¥ä½œåŒºæ ¹ç›®å½•ä¸‹ç”Ÿæˆåå¦‚â€œbazel-*â€çš„å¤šä¸ªç›®å½•ï¼Œæ„å»ºä¾èµ–ã€è¾“å‡ºç­‰å°±æ˜¯å­˜å‚¨åœ¨è¿™äº›ç›®å½•ä¸‹ã€‚\n2.2.2 BUILD # BUILDï¼Œæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œä½äºå·¥ä½œåŒºæ ¹ç›®å½•ä»¥åŠå­ç›®å½•ä¸‹ï¼Œç”¨äºå®šä¹‰packageã€‚BUILDæ–‡ä»¶ç”¨äºæè¿°å¾…æ„å»ºçš„targetsï¼Œä»¥åŠæ„å»ºæ¯ä¸ªtargetçš„è¾“å…¥ã€è¾“å‡ºã€‚\n2.2.3 TARGET # TARGETï¼Œæ˜¯æ„å»ºç›®æ ‡çš„æ„æ€ï¼Œå®ƒä½äºBUILDæ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªBUILDæ–‡ä»¶ä¸­å¯ä»¥æœ‰å¤šä¸ªtargetsã€‚\ntargetsçš„ç±»å‹æ˜¯å¤šç§å¤šæ ·çš„ï¼Œå¦‚cc_binaryã€cc_libraryã€cc_teståˆ†åˆ«è¡¨ç¤ºæ„å»ºc++å¯æ‰§è¡Œç¨‹åºã€åº“ã€å•å…ƒæµ‹è¯•ï¼Œjava_binaryã€java_libraryã€java_teståˆ†åˆ«è¡¨ç¤ºæ„å»ºjavaå¯æ‰§è¡Œç¨‹åºã€åº“ã€å•å…ƒæµ‹è¯•ã€‚\nbazelå†…ç½®æ”¯æŒçš„è¯­è¨€æ•°é‡æ˜¯æœ‰é™çš„ï¼Œåªæ”¯æŒc++ã€javaã€pythonï¼Œå…¶ä»–è¯­è¨€è¦é€šè¿‡æ‰©å±•rulesæ¥æ”¯æŒï¼Œæ¯”å¦‚rules_goæä¾›äº†å¯¹goè¯­è¨€çš„æ„å»ºæ”¯æŒï¼Œrules_goä¸­å®šä¹‰äº†go_binaryã€go_libraryã€go_teståˆ†åˆ«æ„å»ºgoå¯æ‰§è¡Œç¨‹åºã€åº“ã€å•å…ƒæµ‹è¯•ã€‚\nåŒæ ·åœ°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰©å±•rulesæ¥è°ƒç”¨ä¸€äº›ä»£ç ç”Ÿæˆå·¥å…·è‡ªåŠ¨ç”Ÿæˆä¸€äº›æ¡©ä»£ç æ–‡ä»¶ï¼Œæ¯”å¦‚æ ¹æ®pbæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆpb.goã€grpc.goï¼Œæˆ–é’ˆå¯¹trpcæ¡†æ¶çš„pb.goã€trpc.goã€validate.pb.goã€_mock.goæ–‡ä»¶ç­‰ç­‰ã€‚\n2.2.4 RULES # RULESï¼Œç®€è¨€ä¹‹å°±æ˜¯ä¸€ç³»åˆ—æ‰©å±•è§„åˆ™ï¼Œå®ƒå…è®¸æˆ‘ä»¬æ‰©å±•æ–°çš„targetç±»å‹ã€‚RULESçš„ç¼–å†™ï¼Œæ˜¯é€šè¿‡Starlarkè¯­è¨€æ¥å®Œæˆçš„ï¼ŒStarlarkæ˜¯ä¸€é—¨é…ç½®è¯­è¨€ï¼Œç‰¹åˆ«é€‚ç”¨äºbazel rulesçš„ç¼–å†™ã€‚åé¢æˆ‘ä»¬ä¼šé€šè¿‡æ‰©å±•rulesæ¥æ‰©å±•trpcç›¸å…³çš„targetï¼Œä»¥é€šè¿‡pbç”Ÿæˆtrpcæ¡†æ¶éœ€è¦çš„æ¡©ä»£ç ã€‚\n2.2.5 å¯è§æ€§ # ç¼–ç¨‹è¯­è¨€æä¾›äº†æŸäº›è¯­è¨€çº§åˆ«çš„å¯è§æ€§ä¿è¯ï¼Œå¦‚Cè¯­è¨€å¯ä»¥åˆ©ç”¨static/externæ¥å£°æ˜å˜é‡çš„é“¾æ¥å±æ€§ï¼ˆå¯¹ç¼–è¯‘å•å…ƒå†…å¯è§è¿˜æ˜¯å…¨å±€å¯è§ï¼‰ï¼ŒC++ã€Javaç±»æä¾›äº†ä¸€äº›ä¿®é¥°ç¬¦ï¼ŒGoæä¾›äº†å¯¼å‡ºã€éå¯¼å‡ºçš„æ”¯æŒã€‚\nBazelå†…éƒ¨å®šä¹‰äº†ä¸€äº›å¯è§æ€§çš„å£°æ˜æ–¹å¼ï¼Œå…è®¸åœ¨è¯­è¨€ä¹‹ä¸Šæä¾›æ›´è¿›ä¸€æ­¥çš„æ§åˆ¶ã€‚å¯èƒ½æœ‰äº›è¯­è¨€æ²¡æœ‰æä¾›å¯è§æ€§ä¿è¯ï¼Œå³ä¾¿æ˜¯è¯­è¨€æä¾›äº†ç±»ä¼¼çš„ä¿è¯ï¼ŒBazelçš„è¿™ä¸ªèƒ½åŠ›ä¹Ÿèƒ½ä½¿å¾—æˆ‘ä»¬å¯¹ä»£ç æ–½åŠ æ›´è¿›ä¸€æ­¥çš„æ§åˆ¶ã€‚å¦‚Go package Aå¯¼å‡ºäº†ä¸€ä¸ªç±»å‹ç»™package Bä½¿ç”¨ï¼ˆè·¨åŒ…ï¼Œä¸å¾—ä¸å¯¼å‡ºï¼Œè¿™æ˜¯è¯­è¨€çº§åˆ«çš„é™åˆ¶ï¼‰ï¼Œä½†æ˜¯å‡ºäºæŸç§åŸå› ï¼ˆå¦‚ä¸æ‰“ç®—é•¿æœŸç»´æŠ¤ï¼‰å¹¶ä¸å¸Œæœ›è¿™ä¸ªç±»å‹ç»™æ›´å¤§èŒƒå›´çš„å›¢é˜Ÿä½¿ç”¨ï¼Œå°±å¯ä»¥é€šè¿‡Bazelå¯è§æ€§æ¥è¿›è¡Œç²¾ç»†åŒ–çº¦æŸã€‚\n2.2.6 å°é—­æ„å»º # å½“å¼€å‘äººå‘˜å†™å®Œä»£ç æœ¬åœ°ç¼–è¯‘æˆåŠŸäº†ï¼Œä»£ç æäº¤åï¼Œå…¶ä»–äººåœ¨è‡ªå·±çš„æ„å»ºç¯å¢ƒä¸‹å´æ„å»ºå¤±è´¥ï¼Œå¯èƒ½åŸå› æœ‰å¤šç§ï¼š\n- goç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¦‚go1.13æ‰å¼•å…¥äº†errors.Is/As/Unwrapç­‰ï¼Œä»–äººæ„å»ºç¯å¢ƒå¯èƒ½æ˜¯go1.12ï¼›\n- protocåŠæ’ä»¶ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¦‚protoc-gen-goæ—§ç‰ˆæœ¬ä¸æ”¯æŒpaths=source_relativeé€‰é¡¹å¯èƒ½å¯¼è‡´ç”Ÿæˆçš„æ¡©ä»£ç è·¯å¾„ä½ç½®é”™è¯¯ï¼Œç¼–è¯‘æ—¶å¼•ç”¨å¤±è´¥ï¼›\n- mockgenç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå¦‚æ–°ç‰ˆæœ¬è¦æ±‚go.modå·²åˆå§‹åŒ–ï¼Œåä¹‹åˆ™ä¼šmockæ¡©ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œgo testå› ä¸ºç¼ºå°‘å¿…è¦mockä»£ç è€Œæ„å»ºå¤±è´¥ï¼›\n- etcï¼›\nç±»ä¼¼çš„åŸå› è¿˜æœ‰å¾ˆå¤šï¼Œæ— æ³•ä¸€ä¸€åˆ—ä¸¾ï¼Œæˆ‘ä»¬åº”èŠ±åŠŸå¤«æ¶ˆé™¤è¿™äº›ç ´åå¯é‡å¤æ„å»ºçš„å› ç´ ã€‚å°é—­æ„å»ºï¼Œç®€è¨€ä¹‹å°±æ˜¯ä¿è¯æ„å»ºç¯å¢ƒçš„ä¸€è‡´ï¼Œå¹¶ä¿è¯åˆ¶å“çš„å¯é‡å¤æ„å»ºã€‚\nè¦å®ç°å°é—­æ„å»ºï¼Œå°±è¦è¯†åˆ«å½“å‰æ„å»ºä¸­çš„è¿™äº›ç ´åæ€§è¡Œä¸ºï¼Œå¹¶äºˆä»¥æ¶ˆé™¤ï¼Œå¦‚å°†åˆ†æ•£åœ¨å„å¼€å‘åŒå­¦æœºå™¨ä¸Šçš„æ„å»ºå·¥å…·é”å®šä¸€ä¸ªç¨³å®šçš„ç‰ˆæœ¬å¹¶æ‰“åŒ…æˆæ„å»ºä¾èµ–ï¼Œåœ¨WORKSPACEä¸­å®šä¹‰è¯¥ä¾èµ–åŠç‰ˆæœ¬ï¼Œæ„å»ºæ—¶è‡ªåŠ¨æ‹‰å–è¯¥ä¾èµ–å¹¶ç”¨å…¶è¿›è¡Œæ„å»ºã€‚\n2.3 Bazelæ„å»ºå®è·µ # ç†è§£äº†ä¸Šè¿°çš„ä¸€äº›Bazelæ ¸å¿ƒæ¦‚å¿µä¹‹åï¼Œçœ‹å‡ ä¸ªä½¿ç”¨Bazelæ¥è¿›è¡Œæ„å»ºçš„å·¥ç¨‹å®ä¾‹ï¼ŒåŠ æ·±ç†è§£ã€‚\n2.3.1 Bazelæ„å»ºdemo # - Building a C++ Project: https://docs.bazel.build/versions/4.2.1/tutorial/cpp.html\n- Building a Java Project: https://docs.bazel.build/versions/4.2.1/tutorial/java.html\n- Building a Android Project: https://docs.bazel.build/versions/4.2.1/tutorial/android-app.html\n- Building a iOS Project: https://docs.bazel.build/versions/4.2.1/tutorial/ios-app.html\næŠŠä¸Šè¿°4ä¸ªæ„å»ºå®ä¾‹å…¨éƒ¨çœ‹å®Œï¼Œåº”è¯¥å·²ç»å¤§è‡´æŒæ¡äº†Bazelçš„ä½¿ç”¨äº†ã€‚\næœ‰å¯èƒ½è¯»è€…å¹¶ä¸ç†Ÿæ‚‰C++ã€Javaã€Androidã€iOSï¼Œæœ‰å¯èƒ½åªç†Ÿæ‚‰Goå‘¢ï¼Ÿå³ä¾¿ç†Ÿæ‚‰ï¼Œè¦æƒ³ç›´æ¥ä»go moduleè¿ç§»åˆ°bazelæ„å»ºä¹Ÿè¿˜æ˜¯æœ‰ç›¸å½“å¤§çš„æˆæœ¬çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯è¦å•ç‹¬ä»‹ç»ä¸‹å¦‚ä½•ä¸€æ­¥æ­¥ä»go moduleè¿ç§»åˆ°bazelæ„å»ºï¼Œç„¶åæˆ‘ä»¬å†ä»‹ç»æœ€ç»ˆæ²‰æ·€ä¸‹æ¥çš„trpc-goé¡¹ç›®æ„å»ºæ–¹æ¡ˆã€‚\n2.3.2 Bazelæ„å»ºGo # Goè¯­è¨€æ”¯æŒ # ä¸åŒäºä½¿ç”¨Bazelæ„å»ºC++ã€Javaï¼ŒBazelæ”¯æŒçš„å†…ç½®è¯­è¨€ä¸æ”¯æŒGoï¼Œéœ€è¦å¼•å…¥æ‰©å±•çš„rulesæ¥æ”¯æŒGoæ„å»ºï¼Œå³ï¼šhttps://github.com/bazelbuild/rules_goï¼Œå‚è€ƒbazelbuild/rules_go readmeåœ¨WORKSPACEä¸­å¢åŠ ç›¸åº”çš„starlarkè„šæœ¬å³å¯æ”¯æŒåˆ°ã€‚\nBUILDæ–‡ä»¶ä¸­ï¼Œä¹Ÿè¦ä»bazelbuild/rules_goä¸­åŠ è½½targetå®šä¹‰ï¼Œå¦‚go_binaryã€go_libraryã€go_testï¼Œæ­¤æ—¶æˆ‘ä»¬ä¾¿å¯ä»¥åœ¨BUILDæ–‡ä»¶å®šä¹‰goç›¸å…³çš„targetsäº†ã€‚\nGoä¾èµ–ç®¡ç† # goå·¥å…·é“¾æœ‰æ”¯æŒgoçš„ä¾èµ–ç®¡ç†ï¼Œå¼€å‘äººå‘˜åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œgoå·¥å…·é“¾èƒ½å¤Ÿè‡ªåŠ¨åœ°ååŠ©å¼€å‘äººå‘˜æ›´æ–°go.modã€go.sumï¼Œæ˜¯éå¸¸æ˜“ç”¨çš„ã€‚ps å½“ç„¶å…³äºgo moduleçš„ä¸è¶³æˆ‘ä»¬å°±ä¸è®¨è®ºäº†ã€‚\nä»¥go1.16ä¸ºä¾‹ï¼Œå½“æˆ‘ä»¬ä»£ç ä¸­importäº†æŸä¸ªå¤–éƒ¨ä¾èµ–ï¼Œå½“æˆ‘ä»¬ç¼–è¯‘çš„æ—¶å€™ï¼Œä¸ºäº†ä¿è¯å¯é‡å¤æ„å»ºï¼Œgo1.16è¦æ±‚æˆ‘ä»¬æ˜¾ç¤ºåœ°é€šè¿‡â€œgo get $dependencyâ€çš„æ–¹å¼å°†ä¾èµ–æ·»åŠ åˆ°go.modã€go.sumä¸­ã€‚è¿™ä¸ªè¿‡ç¨‹æ¯”è¾ƒä¸¥è°¨ï¼Œå¼€å‘äººå‘˜åœ¨ç¡®è®¤æ²¡æœ‰ä»€ä¹ˆé£é™©çš„æ—¶å€™ï¼Œä¹Ÿä¼šé€šè¿‡â€œgo mod tidyâ€æ¥æ‰¹é‡å°†ä¾èµ–æ›´æ–°åˆ°go.modã€go.sumä¸­ï¼ˆåªæ˜¯ä¸ºäº†æ–¹ä¾¿ï¼‰ã€‚\nè¦çŸ¥é“ï¼Œgo modå¯¹ä¾èµ–çš„ç®¡ç†æ˜¯åŸºäºæºä»£ç ä¸­çš„importpathåˆ†ææ¥å®ç°çš„ï¼Œbazelä¸­å¦‚æœè¦æè¿°go packagesä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¹Ÿæ˜¯è¦é‡‡å–ç±»ä¼¼çš„æ–¹å¼çš„ï¼Œä½†æ˜¯è°æ¥åšè¿™ä¸ªå·¥ä½œå‘¢ï¼Ÿrules_goè¿™ä¸ªæ‰©å±•çš„è§„åˆ™é›†ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ˜¯è¦é€šè¿‡go_repositoryæ¥å®šä¹‰å¤–éƒ¨ä¾èµ–çš„ï¼ˆåŒ…æ‹¬åˆ«åã€importpathã€ç‰ˆæœ¬ã€hashï¼‰ï¼Œç„¶ååœ¨go_binaryã€go_libraryçš„depså±æ€§ä¸­å¼•ç”¨è¿™äº›å¤–éƒ¨ä¾èµ–ï¼Œä½†æ˜¯è”æƒ³go geté€ä¸ªæ·»åŠ çš„æƒ…å†µï¼Œé€ä¸ªæ‰‹å†™ä¹Ÿbazel goä¾èµ–æ˜¯ä¼šå¾ˆå•°å—¦çš„ã€‚\nèƒ½å¦åƒæ‰§è¡Œâ€œgo mod tidyâ€ä¸€æ ·è‡ªåŠ¨æ›´æ–°æ‰€æœ‰çš„ä¾èµ–å‘¢ï¼Ÿgazelleï¼\ngazelleï¼Œå³ï¼šhttps://github.com/bazelbuild/bazel-gazelleã€‚å®ƒèƒ½åˆ†ægoæºç ä¸­çš„importpathæ¥è‡ªåŠ¨æ›´æ–°deps.bzlï¼ˆå¤–éƒ¨ä¾èµ–ï¼‰å¹¶è‡ªåŠ¨ç”Ÿæˆgo_binaryã€go_libraryã€go_testï¼ŒåŒæ—¶è¿˜èƒ½è‡ªåŠ¨å¡«å……è¿™äº›targetsçš„depså±æ€§ã€‚å¦‚æœé¡¹ç›®ä¸­åŒæ—¶æ”¯æŒgo moduleã€bazelæ„å»ºï¼Œgazelleä¹Ÿå¯ä»¥é€šè¿‡go.modã€go.sumæ¥æ›´æ–°deps.bzlä»¥åŠtargetsçš„ä¾èµ–ã€‚\nGoæ¡©ä»£ç  # åœ¨å¾®æœåŠ¡å¼€å‘ä¸­ï¼ŒRPCé€šä¿¡æ¨¡å¼æ˜¯å½“ä¸‹ä¸»æµæ–¹å¼ï¼Œé€šä¿¡åŒæ–¹åŸºäºåŒä¸€ä»½IDLç”Ÿæˆrpcstubæ–‡ä»¶ï¼Œå¦‚grpcæ¡†æ¶éœ€è¦åŸºäºpbæ–‡ä»¶ç”Ÿæˆpb.goã€grpc.goã€‚pbä¹Ÿä¸å±äºbazelå®˜æ–¹æ”¯æŒçš„è¯­è¨€ï¼Œä¹Ÿæ˜¯éœ€è¦é€šè¿‡å¼•å…¥é¢å¤–çš„rulesæ‰©å±•æ¥æ”¯æŒå¯¹pbç›¸å…³çš„æ¡©ä»£ç çš„ç”Ÿæˆã€‚\nrules_protoï¼Œå³ï¼šhttps://github.com/bazelbuild/rules_protoï¼Œæ˜¯å¯¹pbçš„æ‰©å±•æ”¯æŒã€‚\npsï¼šå¤§å®¶å¯èƒ½ä¼šå›°æƒ‘ï¼Œéœ€è¦å¼•å…¥è¿™ä¹ˆå¤šæ‰©å±•çš„rulesï¼Ÿå…¶å®ï¼Œè¿™ä¸ªåªéœ€è¦åœ¨WORKSPACEçš„æ ¹ç›®å½•ä¸­é…ç½®ä¸€æ¬¡å°±å¯ä»¥äº†ï¼Œåç»­åœ¨å·¥ä½œåŒºä¸­å¼€å‘ï¼Œå¤§å®¶åªå…³å¿ƒBUILDæ–‡ä»¶ç¼–å†™å°±å¯ä»¥äº†ã€‚è€Œä¸”æˆ‘ä»¬ä¹Ÿä¼šåœ¨å·¥ä½œåŒºä¸‹æ”¾ç½®ä¸€äº›shellè„šæœ¬ï¼Œè¿è¡Œè„šæœ¬å°±èƒ½å¿«é€Ÿç”Ÿæˆä¸€ä¸ªæ¨¡æ¿BUILDæ–‡ä»¶ã€‚è¿™æ ·ä½¿ç”¨èµ·æ¥å°±ä¼šæ–¹ä¾¿å¤šäº†ã€‚\nGRPCæ„å»º # bazelbuild/codelabsï¼Œå³ï¼šhttps://github.com/bazelbuild/codelabsï¼Œæä¾›äº†ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„bazelæ„å»ºdemoï¼ŒåŒä¸€ä¸ªWORKSPACEä¸‹åŒ…æ‹¬äº†goã€javaã€typescriptã€androidã€protoå¤šä¸ªtargetsçš„æ„å»ºï¼Œè¿™ä¹Ÿç®—ä¸ªæç®€çš„monorepoäº†ã€‚\n2.3.3 æ„å»ºtrpcæœåŠ¡ # æˆ‘ä»¬å°†åœ¨ç¬¬3èŠ‚æ„å»ºtrpcæœåŠ¡ä¸­è¯¦ç»†å±•å¼€ï¼Œæˆ‘ä»¬æ¨èçš„ç›®å½•ç»„ç»‡æ–¹å¼ã€å½“å‰è¦åšçš„å·¥ä½œï¼Œå°†æ¥è¦è¿›ä¸€æ­¥å®Œå–„çš„å·¥ä½œã€‚\nè¿™é‡Œæˆ‘ä»¬å…ˆç®€å•æ¢³ç†ä¸‹ï¼Œä½¿ç”¨bazelæ„å»ºtrpcæœåŠ¡ï¼ˆå…ˆè€ƒè™‘trpc-goï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å“ªäº›ï¼š\ngoè¯­è¨€æ„å»ºæ”¯æŒ # å‰é¢æˆ‘ä»¬ä»‹ç»äº†åŸºäºrules_goæ‰©å±•äº†å¯¹goçš„æ”¯æŒï¼Œä»¥åŠåŸºäºgo_binaryã€go_libraryã€go_testæ¥å®šä¹‰ä¸åŒç±»å‹targetsçš„æ–¹å¼ã€‚è¿™éƒ¨åˆ†å†…å®¹å¯¹æˆ‘ä»¬ä¸å†æ˜¯æŒ‘æˆ˜ã€‚\ngo moduleä¾èµ–ç®¡ç† # å‰é¢æˆ‘ä»¬ä»‹ç»äº†åŸºäºrules_goæ‰©å±•äº†å¯¹goçš„æ”¯æŒï¼Œä»¥åŠåŸºäºgo_repositoryå®šä¹‰å¤–éƒ¨ä¾èµ–å¹¶é€šè¿‡targetsçš„depså¯¹ä¾èµ–è¿›è¡Œæ˜¾ç¤ºå£°æ˜ï¼Œä¹Ÿä»‹ç»äº†åŸºäºgazelleè¿›è¡Œè¾…åŠ©ä¾èµ–ç®¡ç†ã€‚è¿™éƒ¨åˆ†å†…å®¹å¯¹æˆ‘ä»¬ä¸å†æ˜¯æŒ‘æˆ˜ã€‚\npbæ¡©ä»£ç æ”¯æŒ # å‰é¢æˆ‘ä»¬æåˆ°äº†rules_protoå¯¹pbæ¡©ä»£ç è¿›è¡Œæ”¯æŒï¼Œé€šè¿‡rules_protoæ‰©å±•çš„targetç±»å‹ï¼Œæˆ‘ä»¬èƒ½ç”Ÿæˆpb.goæ–‡ä»¶ï¼Œé€šè¿‡proto grpcæ‰©å±•è§„åˆ™ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ç”Ÿæˆgrpc.goæ–‡ä»¶ã€‚ä½†æ˜¯trpcæœ‰ç‚¹ä¸åŒçš„æ˜¯ï¼Œtrpcç›¸å…³çš„æ¡©ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œæ˜¯é€šè¿‡ç»Ÿä¸€çš„ä¸€ä¸ªtrpcå‘½ä»¤è¡Œå·¥å…·æ¥ç”Ÿæˆçš„ï¼ŒåŒ…æ‹¬ï¼š\n- $pb.pb.goï¼štrpcè°ƒç”¨protoc-gen-goç”Ÿæˆï¼›\n- $pb.pb.validate.goï¼štrpcè°ƒç”¨protoc-gen-secvç”Ÿæˆï¼›\n- $pb.trpc.goï¼štrpcç”Ÿæˆçš„é€‚é…trpcæ¡†æ¶çš„rpcstubï¼Œä½œç”¨ç­‰åŒäºgrpc.goï¼›\n- $pb_mock.goï¼štrpcè°ƒç”¨mockgenç”Ÿæˆï¼›\næˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰æ–°çš„è§„åˆ™é›†æ¥æ”¯æŒtrpcç›¸å…³çš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼ŒåŒ…æ‹¬è¦å®šä¹‰å¯¹åº”çš„targetç±»å‹ï¼Œæ¯”å¦‚trpc_protoï¼Œå…¶è¾“å…¥ä¸ºpbæ–‡ä»¶ï¼Œè¾“å‡ºä¸ºå¯¹åº”çš„ä¸Šè¿°æ¡©ä»£ç ã€‚trpc_protoè¯¥targetåº”è¯¥ä½œä¸ºtrpcæœåŠ¡ä¸­go_binaryã€go_libraryã€go_testçš„è¾“å…¥ï¼Œå‡†ç¡®åœ°è¯´æ˜¯å…¶trpc_protoçš„è¾“å‡ºä½œä¸ºè¿™å‡ ä¸ªtargetçš„è¾“å…¥ã€‚\npsï¼šå½“ç„¶æˆ‘ä»¬å¯ä»¥åœ¨å°†trpc_protoä½œä¸ºgo_libraryçš„è¾“å…¥ï¼Œè®©go_binaryã€go_testä¾èµ–go_libraryæ¥å®Œæˆä¸pbæ¡©ä»£ç çš„é“¾æ¥ï¼Œæœ€ç»ˆæˆåŠŸæ„å»ºã€‚\nç°å®æ¯”æƒ³è±¡å¤æ‚ # bazelæ„å»ºçš„æŒæ¡è¿˜æ˜¯æœ‰ä¸€å®šå­¦ä¹ æˆæœ¬çš„ï¼Œå½“å‰å…¬å¸é‡Œé¢ï¼Œå¤§èŒƒå›´é‡‡ç”¨monorepo+å¤šè¯­è¨€å¼€å‘çš„å›¢é˜Ÿï¼Œé‡‡ç”¨bazelè¿›è¡Œæ„å»ºçš„å®è·µå¹¶ä¸å¤šï¼Œå€Ÿé‰´åŠ æ”¹è¿›æ˜¯å¿…é¡»çš„ã€‚\nä¾èµ–ç®¡ç†ï¼Œå¹¶ä¸å¦‚å‰æ–‡ä»‹ç»é‚£ä¹ˆç®€å•ï¼Œå®é™…å·¥ç¨‹ä¸­ä¾èµ–ç®¡ç†è¦å¤æ‚ä¸€äº›ï¼Œè¦æ±‚å¯¹bazelçš„å·¥ä½œåŸç†ã€æ‰©å±•çš„rulesçš„å®ç°æœ‰æ›´åŠ æ¸…æ™°ã€å®Œæ•´çš„è®¤è¯†ï¼Œå¦åˆ™æ„å»ºå¤±è´¥å°†æ˜¯å®¶å¸¸ä¾¿é¥­ã€‚\ntrpcå·¥å…·çš„å·¥ä½œæ–¹å¼ï¼Œå®‰è£…åŠ è½½é…ç½®æ–‡ä»¶ã€æ¨¡æ¿ä¾èµ–$USERã€$HOMEï¼Œè¿èƒŒäº†bazelçš„å°é—­æ„å»ºåŸåˆ™ï¼Œéœ€è¦è¿›è¡Œå®šåˆ¶åŒ–æ”¹é€ ï¼Œä»¥åœ¨bazelä¸­æ­£å¸¸ä½¿ç”¨ã€‚\nbazelæ„å»ºï¼Œå¦‚æœä¸€ä¸å°å¿ƒæ‰§è¡Œäº†bazel cleanï¼Œé‚£ä¹ˆåç»­å†æ¬¡æ„å»ºå°†éå¸¸è€—æ—¶ï¼Œè¦æ‹‰å–å¹¶æ„å»ºå¤§é‡çš„ä¾èµ–å·¥å…·ï¼Œå¦‚protocç­‰ç­‰ã€‚å¤§ä»“æ¨¡å¼ä¸‹ï¼Œåˆ†å¸ƒå¼å¢é‡æ„å»ºã€ç¼“å­˜æ˜¯å¿…é¡»è¦å¼€å¯çš„ï¼Œå¦åˆ™ä¸multirepo+go buildç›¸æ¯”æ„å»ºæ•ˆç‡ä¸¥é‡ä¸‹é™ã€‚\næ¥è§¦bazelæ—¶é—´ä¸é•¿ã€å®è·µç»éªŒåå°‘ï¼ŒæŠ˜è…¾ä¸¤å‘¨ï¼Œç°ä»å­˜åœ¨ä¸€äº›æœªçŸ¥äº‹é¡¹ã€‚bazelçš„æŒæ¡ï¼Œå¯èƒ½éœ€è¦åœ¨æ¨è¡Œmonorepo+bazelbuildçš„å›¢é˜Ÿè¿›è¡Œé€‚å½“çš„åŸ¹è®­ï¼ŒåŠ ä»¥æŒ‡å¯¼ã€‚\n3 Bazelæ„å»ºtrpc # è¿™é‡Œä»‹ç»bazelæ„å»ºtrpcæœåŠ¡ï¼ˆå¦‚æ— ç‰¹æ®ŠæåŠï¼Œè¿™é‡Œçš„trpcæœåŠ¡å‡ä»£æŒ‡trpc-goæœåŠ¡ï¼‰ï¼ŒåŒ…æ‹¬ç‹¬ç«‹çš„trpcæœåŠ¡çš„æ„å»ºã€åç»­å·¥ç¨‹ç›®å½•çš„ç»„ç»‡æ–¹å¼ã€åç»­åè®®çš„æ‰˜ç®¡æ–¹å¼ï¼Œä»¥åŠå…¶ä»–ä¿è¯å°é—­æ„å»ºã€æé«˜æ„å»ºæ•ˆç‡æ‰€éœ€è¦åšçš„å·¥ä½œã€‚\n3.1 æ„å»ºtrpcæœåŠ¡ # 3.1.1 å¿«é€Ÿä½“éªŒ # ä¸ºæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨bazelæ„å»ºä¸€ä¸ªtrpcæœåŠ¡ï¼Œå‡†å¤‡äº†ä¸€ä¸ªdemoï¼Œä»¥æˆªå›¾çš„å½¢å¼æä¾›ã€‚\né¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå’Œtrpcå‘½ä»¤ç”Ÿæˆçš„æ¨¡æ¿å·¥ç¨‹æœ‰ä½•ä¸åŒï¼Ÿ\n- æ ¹ç›®å½•ä¸‹å¤šäº†ä¸¤ä¸ªæ–‡ä»¶ï¼šWORKSPACEã€BUILDæ–‡ä»¶ï¼›\n- stubç›®å½•ä¸‹å¤šäº†BUILDæ–‡ä»¶ï¼›\n- stubç›®å½•ä¸‹å°‘äº†hello.protoç›¸å…³çš„goæ–‡ä»¶ã€go.modæ–‡ä»¶ã€go.sumæ–‡ä»¶ï¼›\nç¡®ä¿å·²ç»å®‰è£…bazelï¼ˆmacOSå¯ä»¥brew install bazelï¼‰ï¼Œcdåˆ°é¡¹ç›®æ ¹ç›®å½•ï¼š\n- æ‰§è¡Œâ€œbazel build //:helloworldâ€ï¼Œå³å®ŒæˆæœåŠ¡äºŒè¿›åˆ¶ç¨‹åºçš„æ„å»ºï¼›\n- æ‰§è¡Œâ€œbazel run //:helloworld \u0026ndash; -conf=trpc_go.yamlâ€æ¥å¯åŠ¨ç¨‹åºï¼›\n- æ‰§è¡Œâ€œbazel test //:helloworld_testâ€ï¼Œå°†æ„å»ºå¤±è´¥ï¼Œç°åœ¨è¿˜æ²¡æœ‰æ”¯æŒmockä»£ç çš„ç”Ÿæˆï¼›\nFIXME mockgenæ‰§è¡Œå¤±è´¥\n3.1.2 é…ç½®WORKSPACE # å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé€šè¿‡æ³¨é‡Šéƒ¨åˆ†å¯ä»¥çœ‹åˆ°åšäº†å“ªäº›å·¥ä½œï¼šæ”¯æŒgoè¯­è¨€ã€é€šè¿‡gazelleè¾…åŠ©goä¾èµ–ç®¡ç†ã€æ”¯æŒprotobufã€æ”¯æŒæˆ‘ä»¬è‡ªå®šä¹‰çš„trpcã€‚éœ€è¦æ³¨æ„çš„æ˜¯è‡ªå®šä¹‰çš„trpcæ˜¯æ”¾ç½®åˆ°è¯¥ç¤ºä¾‹å·¥ç¨‹çš„trpcç›®å½•ä¸‹çš„ï¼Œå°†æ¥æ¨è¡Œå¤§ä»“æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶æ”¾åœ¨monorepoçš„æ ¹ç›®å½•ä¸‹ã€‚\n3.1.3 é…ç½®BUILD # é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„BUILDä¸­å®šä¹‰äº†è¯¥trpcæœåŠ¡çš„å‡ ä¸ªæ„å»ºç›®æ ‡ï¼š\n- gazelleæ˜¯ä¸ºäº†è¾…åŠ©ä»go.modæ–‡ä»¶è‡ªåŠ¨æ›´æ–°ä¾èµ–ã€targetsä¸­çš„depså±æ€§çš„ï¼›\n- go_binaryå®šä¹‰äº†è¦æ„å»ºçš„å¯æ‰§è¡Œç¨‹åºï¼Œå®ƒä¾èµ–helloworld_libè¿™ä¸ªtargetï¼Œè¿™ä¸ªtargetç”±go_libraryå®šä¹‰ï¼Œè¿™é‡Œçš„è¿™ä¸ªå®šä¹‰å®é™…ä¸Šæ˜¯æ‰€æœ‰æºä»£ç æ„å»ºè€Œæˆçš„ä¸€ä¸ªåº“ï¼›\n- go_libraryå®šä¹‰äº†ä¸€ä¸ªåº“ï¼Œå®ƒè¢«go_binaryå¼•ç”¨ï¼Œå®ƒé‡Œé¢åŒ…å«äº†ä¸€ç³»åˆ—è¦æ„å»ºçš„æºæ–‡ä»¶ï¼Œæœ‰å·¥ç¨‹å†…éƒ¨çš„main.goã€hello_service.goï¼Œä¹Ÿæœ‰å¤–éƒ¨ä¾èµ–@repo//path-to:targetï¼Œä¹Ÿæœ‰ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­æœªçº³å…¥çš„ä¸€äº›æ–‡ä»¶ç¼–è¯‘å‡ºçš„åº“ï¼Œä¾¿æ˜¯//stub/\u0026hellip;./helloworld:helloworld-stub-libï¼Œè¿™ä¸ªä¾èµ–åœ¨stub/\u0026hellip;./helloworld/BUILDä¸­å®šä¹‰ï¼Œå…¶å®å®ƒæŠŠpbæ–‡ä»¶å¯¹åº”çš„pb.goã€trpc.goç¼–è¯‘æˆäº†å¯é“¾æ¥çš„åº“ï¼›\n- go_testå®šä¹‰äº†å•æµ‹æµ‹è¯•ç›¸å…³çš„æ„å»ºï¼Œè¿™é‡Œå…ˆä¸ç»†çœ‹ï¼›\nokï¼Œç°åœ¨æˆ‘ä»¬å…ˆå¤§è‡´äº†è§£è¿™å‡ ä¸ªtargetæ˜¯æ€ä¹ˆå›äº‹å³å¯ã€‚\nç»§ç»­çœ‹ä¸‹stub/\u0026hellip;./helloworld/BUILDæ–‡ä»¶ä¸­çš„é…ç½®ä¿¡æ¯ï¼š\n- åŠ è½½äº†å·¥ä½œåŒºæ ¹ç›®å½•ä¸‹çš„trpc/defs.bzlï¼Œå…¶ä¸­å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°trpc_protoï¼Œè¿™å…¶å®æè¿°äº†ä¸€ä¸ªæ–°targetç±»å‹çš„å®šä¹‰ï¼›\n- ä½¿ç”¨trpc_protoå®šä¹‰äº†ä¸€ä¸ªæ–°çš„targetï¼Œå…¶è¾“å…¥ä¸ºstubç›®å½•ä¸‹çš„hello.protoæ–‡ä»¶ï¼Œå…¶è¾“å‡ºå½“å‰ç”±trpc_protoçš„ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨å†³å®šï¼Œå½“å‰åªç”Ÿæˆpb.goã€trpc.goï¼›\n- åŠ è½½rules_goå¹¶é€šè¿‡go_libraryå®šä¹‰äº†ä¸€ä¸ªæ–°çš„targetï¼Œè¿™ä¸ªtargetå°†trpc_protoçš„è¾“å‡ºä½œä¸ºä½œä¸ºï¼ŒåŒæ—¶è¯¥targetä¹Ÿå£°æ˜äº†ä¸€äº›å¤–éƒ¨ä¾èµ–ï¼Œè¯¥targetç¼–è¯‘å‡ºçš„åº“æœ€ç»ˆå…¶å¯¼å…¥è·¯å¾„ä¸ºï¼šè„±æ•å¤„ç†ï¼Œ${importPath}/trpcprotocol/helloworldï¼Œé€šè¿‡è¿™ä¸ªimportpathæ¥å¸®åŠ©goç¼–è¯‘å™¨è¿›è¡Œé“¾æ¥ï¼›\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬äº†è§£äº†WORKSPACEã€BUILDæ–‡ä»¶çš„å¤§è‡´é…ç½®ï¼Œåº”è¯¥èƒ½ç†è§£bazelç¼–è¯‘è¿‡ç¨‹ä¸­çš„å¤§è‡´å·¥ä½œæ–¹å¼äº†ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥çœ‹ä¸‹æˆ‘ä»¬è‡ªå®šä¹‰çš„trpc_proto targetç±»å‹æ˜¯å¦‚ä½•å®šä¹‰çš„ã€‚\n3.1.4 æ‰©å±•RULES # load(\u0026quot;//trpc:defs.bzl\u0026quot;, \u0026ldquo;trpc_proto\u0026rdquo;), trpc_protoå®é™…ä¸Šåªæ˜¯ä¸€ä¸ªstarlarkç¼–å†™çš„å‡½æ•°ï¼Œå°±æ”¾åœ¨å·¥ä½œåŒºæ ¹è·¯å¾„ä¸‹çš„trpc/defs.bzlæ–‡ä»¶ä¸­ã€‚\nå¯èƒ½è¯»è€…å¯¹starlarkä¸ç†Ÿæ‚‰ï¼Œä½†æ˜¯é˜…è¯»åº”è¯¥èƒ½çŸ¥æ™“å…¶å«ä¹‰çš„ã€‚trpc_protoè¿™ä¸ªå‡½æ•°å°±æ˜¯å°†å®šä¹‰çš„targetä¸­çš„å±æ€§ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç„¶åæ‰§è¡Œã€‚è¯¥å‡½æ•°ç¡®å®šäº†è¦è¾“å‡ºçš„æ–‡ä»¶åˆ—è¡¨ï¼Œç„¶åè°ƒç”¨trpc_createå‡½æ•°å¯¹pbæ–‡ä»¶è¿›è¡Œå¤„ç†ã€‚trpc_createå‡½æ•°å†…éƒ¨è°ƒç”¨äº†trpcå‘½ä»¤å®Œæˆå¯¹pbæ–‡ä»¶æ¡©ä»£ç çš„ç”Ÿæˆé€»è¾‘ã€‚\nä½†æ˜¯è¿™äº›å·¥å…·ä»å“ªé‡Œæ¥å‘¢ï¼Ÿé€šè¿‡trpc_createå‡½æ•°ä¸­å¼•ç”¨çš„$$TRPCçš„å€¼ï¼Œå¯ä»¥ç¡®å®štrpcå‘½ä»¤è¡Œå³ä¸º//trpc:trpcï¼Œé€šè¿‡trpc/BUILDæ–‡ä»¶å¯ä»¥ç¡®å®šï¼Œ//trpc:trpcæŒ‡çš„å°±æ˜¯//@trpc//:trpcã€‚\né‚£@trpcè¿™ä¸ªå¤–éƒ¨ä¾èµ–æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ@trpcè¿™ä¸ªå¤–éƒ¨ä¾èµ–åˆåŒ…å«äº†å“ªäº›å†…å®¹å‘¢ï¼Ÿ\nå¤–éƒ¨ä¾èµ–éƒ½æ˜¯åœ¨WORKSPACEä¸­å®šä¹‰çš„ï¼ˆæˆ–è€…ç”±starlarkå‡½æ•°ä»å…¶ä»–æ–‡ä»¶ä¸­åŠ è½½è€Œæ¥ï¼‰ï¼Œæˆ‘ä»¬çœ‹ä¸‹WORKSPACEæ–‡ä»¶ä¸­å¯¹è¯¥å¤–éƒ¨ä¾èµ–trpcçš„å®šä¹‰ï¼Œå…¶å®@trpcæ˜¯å¼•ç”¨çš„è…¾è®¯è½¯ä»¶æºä¸Šçš„ä¸€ä¸ªå‹ç¼©åŒ…ï¼Œhttp_archiveä¼šä¸‹è½½è¯¥å‹ç¼©åŒ…æ”¾åˆ°bazel-*ä¸´æ—¶ç›®å½•ä¸­ï¼Œå¹¶è§£å‹ã€‚\nè¿™ä¸ªå‹ç¼©åŒ…ä¸­åŒ…å«çš„å†…å®¹éƒ½æœ‰å“ªäº›å‘¢ï¼Ÿå¯ä»¥ä¸‹è½½ä¸‹æ¥çœ‹çœ‹ï¼ŒåŒ…å«äº†trpcã€protocç­‰å¸¸ç”¨å‘½ä»¤ä»¥åŠpbæ–‡ä»¶ã€‚è¿™ä¸ªå‹ç¼©åŒ…çš„å†…å®¹ï¼Œå®é™…ä¸Šæ˜¯ç”± https://{è„±æ•å¤„ç†}/go-kits/bazelbuildä¸‹çš„publish.shè„šæœ¬æ„å»ºå¹¶æ¨é€åˆ°è…¾è®¯è½¯ä»¶æºçš„ã€‚\nä¸Šè¿°http_archiveä¸­è¿˜æœ‰ä¸ªé…ç½®é¡¹build_fileï¼Œå®ƒè¡¨ç¤ºå°†//trpc:BUILD.trpc.bazelä½œä¸ºè¯¥å¤–éƒ¨ä¾èµ–@trpcçš„BUILDæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¹²äº†ä»€ä¹ˆå‘¢ï¼Ÿå®ƒå®šä¹‰äº†è¯¥packageï¼ˆBUILDå¯¹åº”packageï¼‰çš„å¯è§æ€§ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½å¼•ç”¨å…¶ä¸‹çš„ä¸€äº›trpcã€protocç­‰äºŒè¿›åˆ¶å·¥å…·ä»¥åŠinclude/**ä¸‹çš„pbæ–‡ä»¶ã€‚\n3.2 æ²‰æ·€æ„å»ºè„šæœ¬ # ä¸ºæ–¹ä¾¿ç¼–å†™WORKSPACEã€BUILDæ–‡ä»¶ï¼Œéœ€å®šä¹‰å‡ ä¸ªshellè„šæœ¬ï¼Œå¸®åŠ©å¿«é€Ÿç”Ÿæˆè¯¥ç±»æ–‡ä»¶ï¼š\n- æ²‰æ·€å¸¸ç”¨çš„WORKSPACEé…ç½®åˆ°ç”Ÿæˆè„šæœ¬generate_workspace.shï¼Œæ”¾åˆ°å…¬å…±åº“ç›®å½•ä¸‹ï¼›\n- æ²‰æ·€å¸¸ç”¨çš„BUILDé…ç½®åˆ°ç”Ÿæˆè„šæœ¬generate_build.shï¼Œæ”¾åˆ°å…¬å…±åº“ç›®å½•ä¸‹ï¼›\nå¼€å‘äººå‘˜ä¸ç®¡æ˜¯å®šä¹‰æ–°çš„WORKSPACEï¼Œè¿˜æ˜¯åœ¨ç°æœ‰WORKSPACEä¸­ç¼–å†™BUILDï¼Œå€ŸåŠ©ä¸Šè¿°è„šæœ¬å¯ä»¥å¿«é€Ÿç”Ÿæˆå¯¹åº”çš„æ–‡ä»¶æ¨¡æ¿ï¼Œç¨åŠ ä¿®æ”¹ä¾¿æ˜¯ã€‚\n3.2 ç›®å½•ç»„ç»‡æ–¹å¼ # å¦‚æœåç»­æ¨è¡Œå¤§ä»“ï¼Œå¤§è‡´çš„ç›®å½•ç»„ç»‡æ–¹å¼æ˜¯è¿™æ ·çš„ï¼ˆçº¢è‰²éƒ¨åˆ†ä¸trpcæ„å»ºç›¸å…³ï¼‰ï¼š\n- monorepoæ ¹ç›®å½•ä¸‹æ”¾ç½®ä¸Šè¿°WORKSPACEï¼›\n- monorepoæ ¹ç›®å½•ä¸‹æ”¾ç½®ä¸Šè¿°è‡ªå®šä¹‰çš„trpcç›¸å…³çš„bazelå®šä¹‰ï¼›\n- monorepoæ ¹ç›®å½•ä¸‹ç»„ç»‡å­æ–‡ä»¶å¤¹ï¼Œå¦‚å¤§ä»“æ˜¯BGçº§è§„æ¨¡ï¼Œå­æ–‡ä»¶å¤¹å¯ç”¨æ¥åŒºåˆ†éƒ¨é—¨ã€ä¸šåŠ¡ï¼›\n- éƒ¨é—¨ã€å­ä¸šåŠ¡ä¸‹çš„é¡¹ç›®æŒ‰projectsç»´åº¦è¿›ä¸€æ­¥ç»„ç»‡å­æ–‡ä»¶å¤¹ï¼›\n- projectç»´åº¦å°±å¯ä»¥å¯¹åº”åˆ°æˆ‘ä»¬çš„trpcå¾®æœåŠ¡äº†ï¼›\n- projectä¸‹çš„æ–‡ä»¶å¤¹ï¼ˆgo package)å¯¹åº”bazel packageï¼Œéœ€ç¼–å†™BUILDæ–‡ä»¶ï¼›\n- projectä¸‹çš„go.modã€go.sumå…¶å®éƒ½å¯ä»¥åˆ é™¤äº†ï¼Œä¿ç•™åº”è¯¥ä¹Ÿå¯ä»¥ï¼›\n- projectä¸‹çš„stubä¸‹ä»…ä¿ç•™pbæ–‡ä»¶ï¼›\n- projectä¸‹ä¸ä¿ç•™stubç›®å½•ï¼Œåè®®æ‰˜ç®¡åœ¨rickï¼Œé€šè¿‡go_repositoryä¸‹è½½ï¼Œprojectä¸‹BUILDä¸­å¢åŠ åŸstub/\u0026hellip;./helloworld/BUILDä¸­targetå®šä¹‰å³å¯ï¼›\n- projectä¸‹çš„go.modã€go.sumå…¶å®éƒ½å¯ä»¥åˆ é™¤äº†ï¼Œä¿ç•™åº”è¯¥ä¹Ÿå¯ä»¥ï¼Œè¾…åŠ©gazelleç”Ÿæˆä¾èµ–ï¼›\n- @trpcå¸¸ç”¨å·¥å…·ï¼Œä¸å†ä¾èµ–å¼€å‘ä¸ªäººã€å…¬å…±æ„å»ºæœºä¸Šå®‰è£…çš„èµ„æºï¼Œç»Ÿä¸€åœ¨è½¯ä»¶æºç»´æŠ¤ï¼›\n- å…¶ä»–ï¼›\n3.3 åè®®æ‰˜ç®¡æ–¹å¼ # 3.3.1 éšé¡¹ç›®stubå­ç›®å½• # è¿™ç§æ–¹å¼å‰æ–‡å·²ç»æ¼”ç¤ºè¿‡äº†ï¼Œå¯ä»¥æ”¯æŒåˆ°ã€‚\n3.3.2 åè®®ç®¡ç†å¹³å°æ‰˜ç®¡ # åè®®ç®¡ç†å¹³å°ä¹Ÿæ˜¯æ‰˜ç®¡åˆ°å·¥èœ‚ï¼Œå¯ä»¥é€šè¿‡go_repositoryä¸‹è½½ï¼Œä¹Ÿå¯ä»¥æ”¯æŒåˆ°ã€‚\nè¿™ä¸¤ç§åè®®æ‰˜ç®¡æ–¹å¼éƒ½æ˜¯å¯ä»¥æ”¯æŒåˆ°çš„ã€‚\n3.4 ä¿è¯å°é—­æ„å»º # é€šè¿‡å°é—­æ„å»ºæ¥ä¿è¯å¯é‡å¤æ„å»ºï¼Œæˆ‘ä»¬éœ€è¦è¯†åˆ«å¯èƒ½ç ´åå°é—­æ„å»ºçš„ä¸€äº›è¡Œä¸ºï¼Œå°†å…¶ç§»é™¤ã€‚\nç›®å‰è§‚å¯Ÿï¼Œtrpcå‘½ä»¤åŠå…¶ä¾èµ–çš„å·¥å…·çš„ä¸€äº›å·¥ä½œæ–¹å¼ï¼Œå¯èƒ½æœ‰è¿èƒŒå°é—­æ„å»ºçš„è¡Œä¸ºï¼Œå¦‚å¼ºä¾èµ–$USERã€$HOMEæ¥å®‰è£…åŠ è½½é…ç½®ã€æ¨¡æ¿ä¿¡æ¯ã€‚å·¥å…·ä¾§å¯èƒ½éœ€è¦è¿›è¡Œå¯¹åº”çš„æ”¹é€ ã€‚\n3.5 æ”¹å–„æ„å»ºæ•ˆç‡ # å¦‚æœæ¨è¡Œå¤§ä»“+bazelbuildï¼Œéœ€è¦æŠŠbazelçš„åˆ†å¸ƒå¼æ„å»ºã€å¢é‡æ„å»ºã€ç¼“å­˜ä¼˜åŠ¿å‘æŒ¥å‡ºæ¥ï¼Œbazel clusteréœ€è¦æå‰åšç›¸åº”çš„è§„åˆ’ã€‚\næŒæ¡bazelæ„å»ºå’Œç®€å•çš„go buildç®¡ç†èµ·æ¥ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„ä¸Šæ‰‹æˆæœ¬çš„ :)ï¼Œæƒ³è®©å¤§å®¶ä½¿ç”¨monorepo+bazel buildè€Œémonorepo+go buildï¼Œè¿˜æ˜¯éœ€è¦å°½å¿«åšå‡†å¤‡ã€ä¼˜åŒ–bazelæ„å»ºä½“éªŒã€‚è¯´ä¸€åƒé“ä¸€ä¸‡ï¼Œä¸å¦‚ç¾å¥½çš„åˆä½“éªŒã€‚\n4 æ€»ç»“ # æœ¬æ–‡æ€»ç»“äº†Bazelæ„å»ºçš„ä¼˜åŠ¿ã€æ ¸å¿ƒæ¦‚å¿µã€ç¤ºä¾‹demoï¼Œä»¥åŠä½¿ç”¨Bazelæ„å»ºtrpcæœåŠ¡çš„ä¸€ç‚¹å®è·µæ€»ç»“ï¼Œä»¥åŠåç»­å¯è¡Œçš„ç›®å½•ç»„ç»‡ã€åè®®æ‰˜ç®¡æ–¹å¼ã€å…¶ä»–ç›¸å…³å·¥ä½œã€‚\nå¯¹Bazelç›¸å…³çš„æœ€ä½³å®è·µè¿˜éœ€è¦è¿›ä¸€æ­¥å»å­¦ä¹ ã€æ¢ç´¢ï¼Œä»¥å……åˆ†å‘æŒ¥Bazelæ„å»ºçš„ä¼˜åŠ¿ã€‚\næœ€åä¹Ÿæ„Ÿè°¢å°ä¼™ä¼´ç­‰ç»™äºˆçš„åé¦ˆã€æä¾›çš„å¯ä¾›å‚è€ƒçš„bazelbuildå·¥ç¨‹ã€‚\n5 å‚è€ƒå†…å®¹ # 1ã€å®˜æ–¹bazelbuildæ–‡æ¡£\n2ã€bazelbuild/codelabs\n3ã€book: beginning bazel\n4ã€PCGä¸ªåˆ«å›¢é˜Ÿçš„go bazelbuildå®è·µï¼Œgoé¡¹ç›®bazelè¿ç§»\nâ€‹ TEGä¸ªåˆ«å›¢é˜Ÿçš„bazelbuildå®è·µï¼šhttps://è„±æ•å¤„ç†/yak/yak2\n5ã€å…¶ä»–kmæ–‡ç« åŠå¤–éƒ¨åˆ†äº«\n6ã€Bazelå­¦ä¹ ç¬”è®°\n"}),a.add({id:98,href:"/tags/hermetic/",title:"hermetic",description:"",content:""}),a.add({id:99,href:"/tags/monorepo/",title:"monorepo",description:"",content:""}),a.add({id:100,href:"/tags/multirepo/",title:"multirepo",description:"",content:""}),a.add({id:101,href:"/tags/dma/",title:"dma",description:"",content:""}),a.add({id:102,href:"/tags/io/",title:"io",description:"",content:""}),a.add({id:103,href:"/tags/sendfile/",title:"sendfile",description:"",content:""}),a.add({id:104,href:"/tags/splice/",title:"splice",description:"",content:""}),a.add({id:105,href:"/tags/zero-copy/",title:"zero copy",description:"",content:""}),a.add({id:106,href:"/blog/2021-09-09-%E5%B8%B8%E8%A7%81%E7%9A%84%E9%9B%B6%E6%8B%B7%E8%B4%9D%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF/",title:"å¸¸è§çš„é›¶æ‹·è´ä¼˜åŒ–æŠ€æœ¯",description:"æœ¬æ–‡ä»‹ç»äº†é›¶æ‹·è´æ˜¯ä»€ä¹ˆã€é›¶æ‹·è´ä¼˜åŒ–çš„ç›®çš„ä»¥åŠå¸¸è§çš„é›¶æ‹·è´æ‰‹æ®µã€‚",content:"åœ¨å…³æ³¨IOæ€§èƒ½æ—¶æˆ‘ä»¬ç»å¸¸å¬åˆ°é›¶æ‹·è´ï¼Œé‚£ä¹ˆé›¶æ‹·è´åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦åšé›¶æ‹·è´ï¼Ÿåˆæœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿæœ¬æ–‡å°±ä¸€èµ·æ¥çœ‹ä¸‹ã€‚\né›¶æ‹·è´æŠ€æœ¯ä¸€èˆ¬å¯ä»¥åˆ†ä¸ºä¸¤ç±» #  devicesï¼ˆdiskã€nicï¼‰å’Œkernel bufferä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡DMAï¼ˆç›´æ¥å­˜å‚¨å™¨è®¿é—®ï¼‰æ¥ä¼˜åŒ–æ‰ï¼Œæ—¢èƒ½å¤Ÿé¿å…ä¸­æ–­CPUå‡è½»CPUè´Ÿè½½ï¼Œä¹Ÿèƒ½å¤Ÿç›´æ¥è¯»å†™å†…å­˜å‡å°‘æ•°æ®ä»nicåˆ°cpuå†åˆ°kernel bufferçš„æ‹·è´åŠ¨ä½œï¼› kernel bufferå’Œapplication bufferä¹‹é—´çš„æ•°æ®æ‹·è´ï¼›  è¯´ä¼˜åŒ–æ‹·è´ä¸€èˆ¬æ˜¯å»ä¼˜åŒ–cpuæ‹·è´ï¼ŒDMAæ‹·è´æ˜¯æ— æ³•é¿å…çš„ã€‚é›¶æ‹·è´åˆ™å¼ºè°ƒçš„æ˜¯kernel bufferå’Œapplication bufferä¹‹é—´çš„æ‹·è´ï¼Œé›¶æ‹·è´å¹¶ä¸æ˜¯è¯´æ•´ä¸ªè¿‡ç¨‹ä¸­å®Œå…¨æœ‰æ²¡æœ‰æ•°æ®æ‹·è´ï¼Œåœ¨kernel spaceè¿˜æ˜¯å‘ç”Ÿæ‹·è´ï¼Œå½“ç„¶ä¸‹é¢æåˆ°çš„sendfile+DMAç¡¬ä»¶æ”¯æŒåˆ†æ•£è¯»/èšé›†å†™æƒ…å†µä¸‹èƒ½ä¼˜åŒ–æ‰kernel bufferä¹‹é—´çš„æ‹·è´ã€‚\nç„¶åæ˜ç¡®ä¸‹ä¼˜åŒ–æ‹·è´çš„åŸå›  #  ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å½±å“åˆ°ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå¸¦æ¥ä¸€å®šçš„å¼€é”€ï¼Œå¦‚readã€writeç»„åˆèµ·æ¥å®Œæˆç£ç›˜æ•°æ®è¯»å–ã€ç½‘ç»œå‘é€ï¼Œå°±è¦åˆ‡æ¢4æ¬¡ï¼Œè€Œä¸”readã€writeè¦é‡å¤å¾ˆå¤šæ¬¡ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å°±ä¸èƒ½å®Œå…¨å¿½è§†ï¼› æ•°æ®æ‹·è´ï¼Œä¸»è¦æ˜¯è¯´åˆ©ç”¨cpuæ¥æ‹·è´ï¼ŒcpuåŠ¿å¿…è¦ä¸­æ–­åŸæ¥çš„ä»»åŠ¡å»åšæ‹·è´çš„äº‹æƒ…ï¼Œmoveæ¥moveå»ï¼Œå¹²äº†äº›æ‚æ´»ï¼Œç†æƒ³æƒ…å†µä¸‹æ˜¯å¸Œæœ›å°½å¯èƒ½åšæ›´å¤šçš„äº‹ï¼Œå½“ç„¶ä¸ä¸€å®šèƒ½å®Œå…¨é¿å…cpuæ‹·è´ï¼Œä½†æ˜¯èƒ½è®©æ‹·è´çš„æ•°æ®é‡å‡å°‘ç‚¹è¿˜æ˜¯å€¼å¾—çš„ï¼›  é›¶æ‹·è´ä¼˜åŒ–ä¸€æ–¹é¢æ˜¯è¦ä¼˜åŒ–æ‰kernel bufferå’Œapplication bufferçš„æ•°æ®æ‹·è´é—®é¢˜ï¼Œä¸€æ–¹é¢ä¹Ÿè¦è€ƒè™‘ä¸‹å¦‚ä½•å°½å¯èƒ½å‡å°‘cpuæ‹·è´å¯¹ç¨‹åºåœé¡¿çš„å½±å“ã€‚\nå¸¸è§çš„æ‹·è´ä¼˜åŒ–æ–¹æ¡ˆ # è¿™é‡Œè§£å†³kernel bufferå’Œapplication bufferä¹‹é—´æ•°æ®æ‹·è´çš„å¸¸ç”¨åŠæ³•æœ‰ä»¥ä¸‹å‡ ç§ï¼Œä»¥è¯»å–ç£ç›˜æ•°æ®å‘é€åˆ°socketä¸ºä¾‹è¯´æ˜ï¼š\nmemory mapping # mmapç³»ç»Ÿè°ƒç”¨ï¼Œreadçš„æ—¶å€™ï¼Œdmaä»ç£ç›˜å‘é€æ•°æ®åˆ°kernel bufferï¼Œmmapæ ¹æ®fdæ˜ å°„å¯¹åº”çš„kernel bufferå’Œapplication bufferï¼Œçœæ‰ä¸€æ¬¡è€ƒæ‹·è´ã€‚writeçš„æ—¶å€™ï¼Œæ•°æ®ä»kernel bufferç›´æ¥æ‹·è´åˆ°socket bufferå†åˆ°nic buffer;\nshared buffers in kernel memory space # è¿™é‡Œå¸Œæœ›èƒ½å†æ¬¡ä¼˜åŒ–æ‰mmapæ–¹æ¡ˆä¸­writeæ—¶ä»kernel bufferåˆ°nic bufferçš„æ‹·è´ï¼Œåœ¨kernel spaceä¸­å»ºç«‹ä¸€ä¸ªå…±äº«å†…å­˜åŒºåŸŸbufï¼Œdmaä¼ é€æ•°æ®åˆ°è¿™ä¸ªbufçš„b_dataæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®ï¼Œwriteçš„æ—¶å€™ä½¿ç”¨dmaä»è¿™ä¸ªbufçš„m_dataä½ç½®å¼€å§‹å†™ï¼Œå…¶å®b_dataã€m_dataå…±äº«äº†åº•å±‚å†…å­˜åŒºåŸŸã€‚ç›¸å½“äºä¸€ä¸ªå†™æŒ‡é’ˆã€ä¸€ä¸ªè¯»æŒ‡é’ˆã€‚é€šè¿‡è¿™ç§æ–¹å¼ä¼˜åŒ–æ‰äº†kernel spaceåˆ°nic spaceçš„æ‹·è´ï¼›\nshared buffers between user and kernel space # linux sk_buffersç»“æ„ï¼Œå…¶ä¸­æœ‰ä¸ªæŒ‡é’ˆè®°å½•ç€è¦å‘é€çš„æ•°æ®ï¼ˆapplication bufferä¸­ï¼‰çš„åœ°å€ï¼Œé¿å…äº†ä»application bufferåˆ°kernel bufferçš„æ‹·è´ï¼›\ndifferent system calls, sendfile, splice, etc # å…ˆè¯´sendfileï¼Œsendfileå…è®¸åœ¨fdä¹‹é—´ç›´æ¥ä¼ é€æ•°æ®ï¼Œè¿›å‡ºsendfileä¸Šä¸‹æ–‡åˆ‡æ¢åªéœ€ä¸¤æ¬¡ï¼Œæ•°æ®ç›´æ¥ä»æºfdå¯¹åº”çš„kernel bufferï¼ˆdmaä»è®¾å¤‡ä¸Šæ‹·è´è¿‡å»ï¼‰åˆ°ç›®çš„socketfdçš„socket bufferæ‹·è´ï¼Œå®Œå…¨ç»•è¿‡äº†åº”ç”¨ç¨‹åºbufferåŠå…¶æ‹·è´ï¼›\nsendfile with DMA Scatter/Gather copy # ä¸Šé¢sendfileå­˜åœ¨ä¸€ä¸ªä»kernel bufferåˆ°socket bufferçš„cpuæ‹·è´ï¼Œå¦‚ä½•ä¼˜åŒ–æ‰ï¼Ÿåœ¨ç¡¬ä»¶æ”¯æŒä¸‹ï¼Œkernel bufferå¯ä»¥åªæŠŠè¿™ä¸ªbufferçš„fdä¿¡æ¯å‘é€ç»™socketï¼Œè¿™é‡Œå°±é¿å…äº†æ•°æ®æ‹·è´ï¼Œè¿™é‡Œçš„kernel bufferå¯ä»¥æ˜¯å¤šä¸ªï¼Œé‚£å°±å‘é€å¤šä¸ªbufferçš„fdä¿¡æ¯ç»™socketï¼Œç„¶åDMAå€ŸåŠ©åˆ†æ•£è¯»èšé›†å†™ç›´æ¥ä»ä¸Šè¿°kernel buffersæ‹·è´åˆ°nic bufferã€‚è¿™æ ·å®Œå…¨æ¶ˆé™¤äº†cpuæ‹·è´åŠ¨ä½œï¼Œé¿å…äº†å¯¹cpuçš„ä¸­æ–­ï¼›\nsplice # ä»ä¸€ä¸ªfdåˆ°å¦ä¸€ä¸ªfdæ‹·è´æ•°æ®ï¼Œå…ˆè¦åœ¨ä¸¤ä¸ªfdä¹‹é—´é€šè¿‡pipeç³»ç»Ÿè°ƒç”¨æ„å»ºä¸€ä¸ªç®¡é“ï¼Œç®¡é“åœ¨å†…æ ¸ä¸­å°±æ˜¯ä¸€ä¸ªbufferåªä¸è¿‡è¿”å›è¯»ç«¯ã€å†™ç«¯åœ¨userspaceä¸­ä¾›è¯»å†™ã€‚spliceå°±æ˜¯ä»æºfdçš„kernel bufferå†™åˆ°pipe bufferçš„å†™ç«¯ï¼Œç„¶åå†ä»è¿™ä¸ªpipe bufferçš„è¯»ç«¯æ‹·è´æ•°æ®åˆ°ç›®çš„fdçš„kernel bufferã€‚å’Œå‰é¢æœ€ç‰›å¯¹æŠ€æœ¯æ–¹æ¡ˆç›¸æ¯”ï¼Œè¿™ç§æ–¹æ¡ˆå’Œå‰é¢è¿™ç§sendfile+DMAåˆ†æ•£è¯»èšé›†å†™ç›¸æ¯”ï¼Œkernel spaceä¸­å¤šäº†ä¸¤æ¬¡cpu copyï¼Œå¥½å¤„æ˜¯å¯ä»¥ä¸éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼›\nhardware support # å‰é¢å·²ç»æåˆ°è¿‡äº†DMAç›¸å…³çš„åŠ æˆï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–æ–¹æ¡ˆï¼›\næ€»ç»“ # æœ¬æ–‡æ€»ç»“äº†é›¶æ‹·è´æ˜¯ä»€ä¹ˆã€ç›®çš„æ˜¯ä»€ä¹ˆä»¥åŠæœ‰å“ªäº›å¸¸è§çš„ä¼˜åŒ–æ‰‹æ®µï¼Œé™¤äº†è½¯ä»¶å±‚é¢çš„æ–¹æ¡ˆï¼Œåœ¨ç¡¬ä»¶åŠ æˆä¸‹è¿˜å¯ä»¥åšæ›´å¥½çš„æ–¹æ¡ˆã€‚å…¶å®ä¸åŒé›¶æ‹·è´æŠ€æœ¯å¯¹å®‰å…¨åŠ å¯†ã€è¿‡æ»¤ä¹Ÿæœ‰ä¸åŒçš„å½±å“ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¦‚æœæœ‰æœºä¼šå†æ€»ç»“åˆ†äº«ã€‚\nå‚è€ƒå†…å®¹ #  https://www.uidaho.edu/-/media/UIdaho-Responsive/Files/engr/research/csds/publications/2012/Performance-Review-of-Zero-Copy-Techniques-2012.pdf mmapï¼šhttps://man7.org/linux/man-pages/man2/mmap.2.html splice/teeï¼šhttps://www.kernelhcy.info/?p=202 splice: https://man7.org/linux/man-pages/man2/splice.2.html  "}),a.add({id:107,href:"/tags/etcd/",title:"etcd",description:"",content:""}),a.add({id:108,href:"/tags/kvstore/",title:"kvstore",description:"",content:""}),a.add({id:109,href:"/tags/raft/",title:"Raft",description:"",content:""}),a.add({id:110,href:"/tags/wal/",title:"wal",description:"",content:""}),a.add({id:111,href:"/blog/2021-09-04-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8raft%E5%BC%80%E5%8F%91%E5%BC%BA%E4%B8%80%E8%87%B4kv%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F/",title:"å¦‚ä½•ä½¿ç”¨raftç®—æ³•å¼€å‘å¼ºä¸€è‡´kvå­˜å‚¨ç³»ç»Ÿ",description:"...",content:"æœ¬æ–‡å†…å®¹ # æœ¬æ–‡ç»“åˆetcdæºç æ¥è¿›è¡Œä»‹ç»ï¼Œetcd/contrib/raftexampleæä¾›äº†ä¸€ä¸ªåŸºäºetcd/raftå®ç°çš„kvå­˜å‚¨ç³»ç»Ÿã€‚ä»è¯¥ç¤ºä¾‹å‡ºå‘ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹å¦‚ä½•åŸºäºraftç®—æ³•å¼€å‘ä¸€ä¸ªå¼ºä¸€è‡´çš„kvå­˜å‚¨ç³»ç»Ÿã€‚\nçœ‹å®Œæœ¬æ–‡çš„æºç åˆ†æåï¼Œä¸Šæ‰‹ä¸€ä¸ªraftå¼ºä¸€è‡´ç³»ç»Ÿå¼€å‘å°±ä¸æ˜¯ä»€ä¹ˆéš¾äº‹äº†ã€‚\npsï¼šå‡å®šè¯»è€…å·²ç»é˜…è¯»å¹¶ç†è§£äº†raftè®ºæ–‡ï¼Œè¿™é‡Œæœ‰æˆ‘çš„æ‰¹æ³¨ç‰ˆçš„In Search of an Understandable Consensus Algorithm.pdfï¼Œè¯»èµ·æ¥å¯èƒ½ä¼šå¥½ç†è§£ç‚¹ã€‚\netcd/raft # etcdæœåŠ¡ç«¯ç¨‹åºå…¥å£ï¼šsee æºç \n å¯åŠ¨è¿‡ç¨‹ä¸­åŒºåˆ†å½“å‰èŠ‚ç‚¹ç±»å‹ï¼šæ ¹æ®data-dirç›®å½•ä¸‹çš„ç›®å½•åmember/proxy/emptyæ¥åŒºåˆ†ï¼Œç„¶åå¯åŠ¨etcdå®ä¾‹æˆ–è€…proxyï¼› å¯åŠ¨etcdæœåŠ¡èŠ‚ç‚¹ï¼šstartEtcdè¿™ä¸ªå‡½æ•°ï¼Œé€»è¾‘ä¸»è¦åŒ…æ‹¬å¯åŠ¨ä¾›é›†ç¾¤èŠ‚ç‚¹é—´é€šä¿¡çš„rafthttpæœåŠ¡ï¼Œä»¥åŠä¾›å®¢æˆ·ç«¯è¯·æ±‚çš„æœåŠ¡ï¼› å¯åŠ¨etcd proxyï¼šstartProxyè¿™ä¸ªå‡½æ•°ï¼Œé€»è¾‘ä¸»è¦æ˜¯å¯åŠ¨etcdä»£ç†ï¼›  etcdå“ªäº›éƒ¨åˆ†å€¼å¾—å­¦ä¹ ï¼š\n etcd proxyä»é¡¹ç›®åŠŸèƒ½ä¸Šæ¥è¯´è™½ç„¶å¾ˆé‡è¦ï¼Œä½†æ˜¯ä»å­¦ä¹ è§’åº¦æ¥è¯´æ²¡é‚£ä¹ˆæœ‰ä»·å€¼ï¼Œä¸çœ‹è¿™ä¸ªï¼› etcd serverä»é¡¹ç›®åŠŸèƒ½ä¸Šæ¥è¯´æ˜¯æ ¸å¿ƒï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿæ²¡æœ‰å¿…è¦å­¦ä¹ æ‰€æœ‰çš„è¯·æ±‚å¤„ç†é€»è¾‘ï¼Œé‡ç‚¹æ˜¯å…³æ³¨è¯»å†™æ“ä½œæ—¶å¦‚ä½•åŸºäºraftå®ç°å¼ºä¸€è‡´ï¼› raftï¼šè¿™éƒ¨åˆ†æ˜¯raftç®—æ³•çš„æ ¸å¿ƒå®ç°ï¼Œä»ç†è§£raftè®ºæ–‡åˆ°ç®—æ³•å·¥ç¨‹åŒ–éœ€è¦é¢å¤–åšå‡ºå·¨å¤§çš„ä¼˜åŒ–ï¼Œè¿™äº›çŸ¥è¯†ç‚¹å¾€å¾€æ˜¯é€šç”¨çš„ï¼Œé‡ç‚¹æŒæ¡ï¼›  raftéƒ¨åˆ†ï¼š\n pbåè®®ï¼š  raft peersçš„é€šä¿¡åè®®ï¼Œsee æºç ï¼› raftç®—æ³•ä¸­æåˆ°æ ¸å¿ƒçš„å‡ ä¸ªrpcå°±æ˜¯Voteã€AppendEntriesï¼Œä½†æ˜¯å·¥ç¨‹ä¸­éœ€è¦è€ƒè™‘æ›´å¤šï¼Œè¯¦è§ä¸Šè¿°pbä¸­çš„enum MessageTypeï¼› ä¸Šè¿°pbä¸­çš„message Messageç±»å‹å®šä¹‰äº†rpcé€šä¿¡è¿‡ç¨‹ä¸­çš„è¯·æ±‚/å“åº”ï¼Œä¸åŒrpcé€šè¿‡MessageType typeå­—æ®µåŒºåˆ†ï¼›   çŠ¶æ€æœºï¼š  raftå®ç°æ•°æ®ä¸€è‡´æ€§æ˜¯é€šè¿‡replicated logï¼ˆå¤åˆ¶æ—¥å¿—ï¼‰å®ç°çš„ï¼Œè¿™é‡Œçš„replicated logæœ‰æ—¶ä¹Ÿç§°ä¸ºWALï¼ˆwrite ahead logï¼‰ï¼› raftç®—æ³•ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹raftnodeå¯èƒ½å¤„äºä»¥ä¸‹çŠ¶æ€ä¸­çš„ä¸€ç§ï¼šfollowerã€candidateã€precandidateã€leaderï¼› raftç®—æ³•ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å¯ä»¥é€šè¿‡ä¸€ä¸ªçŠ¶æ€æœºæ¥å»ºæ¨¡ï¼›    äº†è§£äº†è¿™äº›åŸºç¡€çŸ¥è¯†ä¹‹åï¼Œæˆ‘ä»¬ç»“åˆetcd/contrib/raftexampleæ¥è§£é‡Šä¸‹raftå¦‚ä½•é€‰ä¸¾ï¼Œä»¥åŠleaderé‡åˆ°å†™æ“ä½œå¦‚ä½•ä¿è¯æ•°æ®å¼ºä¸€è‡´ã€‚\netcd/raftå¦‚ä½•è¿›è¡Œleaderé€‰ä¸¾ # newRaftNode newRaftNodeï¼Œsee æºç ï¼Œè¿™ä¸ªå‡½æ•°åŒ…æ‹¬åˆ›å»ºä¸€ä¸ªvar rc raftNodeï¼Œç„¶årc.startRaft()ï¼Œè¿™ä¸ªå‡½æ•°åŒ…å«éå¸¸é‡è¦çš„å‡ ä¸ªéƒ¨åˆ†ï¼š\n startNodeï¼Œsee æºç ï¼Œè¿™ä¸ªä¸»è¦æ˜¯å»ºç«‹å¥½raftnodeå¯åŠ¨æ—¶çš„ä¸€äº›åˆå§‹çŠ¶æ€è½¬æ¢ï¼Œæœ‰ä¸€ä¸ªforäº‹ä»¶å¾ªç¯å¤„ç†ï¼Œå¦‚æ”¹å˜raftnodeçš„çŠ¶æ€ï¼štickå‡½æ•°ã€stepå‡½æ•°ï¼Œä»¥åŠä¸€äº›messageçš„å¤„ç†ç­‰ç­‰ï¼› serveRaftï¼š serveChannelsï¼šsee æºç   startNode:\n å¦‚ä½•æŸ¥çœ‹è¿™éƒ¨åˆ†æºç å‘¢ï¼Œé¦–å…ˆä»å¯åŠ¨ä¸€ä¸ªraftnodeå¼€å§‹å§ï¼šsee æºç ï¼› StartNodeå‡½æ•°å¯åŠ¨ä¸€ä¸ªraftnodeï¼ŒèŠ‚ç‚¹åˆšå¯åŠ¨çš„æ—¶å€™stateéƒ½æ˜¯followerï¼šsee æºç ï¼› StartNodeâ†’Bootstrap(peers)é€šè¿‡é…ç½®å‘Šè¯‰å½“å‰raftnodeæœ‰å¤šå°‘ä¸ªraftpeersï¼Œç„¶åè¿™äº›raftpeersåŠ å…¥ä¸å½“å‰èŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤å±äºå˜æ›´é…ç½®ï¼Œä¹Ÿè¦è®°å½•åˆ°raftlogä¸­ï¼› raftnodeçœŸæ­£è·‘èµ·æ¥æ˜¯åœ¨è¿™é‡Œï¼šsee æºç ï¼Œè¿™é‡Œæœ‰ä¸ªå¤§çš„forå¾ªç¯ï¼Œnodeçš„ä¸»è¦é€»è¾‘éƒ½åœ¨è¿™é‡Œäº†ï¼›  tickElectionï¼šfor/switch-case n.tickCï¼Œé€‰ä¸¾é€»è¾‘ï¼Œæ­¤æ—¶å¦‚æœå½“å‰raftnodeä¸ºfolloweræˆ–è€…candidateå§ï¼Œæ­¤æ—¶çš„tickå‡½æ•°ä¸ºtickElectionï¼Œå¦‚æœé€‰ä¸¾è¶…æ—¶æ—¶é—´è¿‡äº†å¹¶ä¸”æ²¡æ”¶åˆ°leaderçš„heartbeatæ¥é‡ç½®é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œæ­¤æ—¶ä¼šå°†MsgHupæ¶ˆæ¯ç±»å‹ä¼ å…¥stepå‡½æ•°ä¸­ï¼Œå°†å½“å‰followerå˜ä¸ºcandidateå‘èµ·é€‰ä¸¾ï¼šsee æºç ã€‚è¿™é‡Œçš„é€‰ä¸¾åœ¨raftè®ºæ–‡ä¸­æ˜¯ç›´æ¥å°±æ˜¯é€‰ä¸¾åŠ¨ä½œï¼Œä½†æ˜¯å·¥ç¨‹ä¸Šåšäº†ä¼˜åŒ–ï¼Œå¼•å…¥äº†ä¸€ä¸ªå¯é€‰çš„ä¸¤é˜¶æ®µé€‰ä¸¾prevoteã€‚è™½ç„¶å¯ä»¥tickæ˜¯è§¦å‘äº†tickElectionï¼Œä½†æ˜¯è¿™ä¸ªåç»­æ‰§è¡Œä¸­ä¼šæ£€æŸ¥å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰èµ„æ ¼æˆä¸ºleaderï¼Œä¸ä¸€å®šæœ‰èµ„æ ¼ï¼ˆæ¯”å¦‚è‡ªèº«çš„WALä¸æ»¡è¶³æ¡ä»¶ï¼‰ã€‚ å‡å¦‚æœ‰èµ„æ ¼å‘èµ·é€‰ä¸¾ï¼Œåˆ™ä¼šè°ƒç”¨becomeCandidateï¼Œä¼šå°†å½“å‰raftnodeçš„term+1ï¼Œå¹¶ä¸”stepå‡½æ•°å˜ä¸ºstepCandidateã€‚ç„¶åä¼šè°ƒç”¨r.pollæ¥åˆ¤æ–­æ˜¯å¦èƒœé€‰ï¼šsee æºç ï¼Œå…¶å®è¿™é‡Œæ˜¯åˆ¤æ–­çš„è‡ªå·±ç»™è‡ªå·±æŠ•ç¥¨çš„è¯èƒ½å¦èƒœé€‰ï¼Œå¯¹äºsingle raftnodeçš„é›†ç¾¤æœ‰ç”¨ï¼Œå‡å¦‚æ˜¯å¤šèŠ‚ç‚¹é›†ç¾¤é‚£ä¹ˆè¿™é‡Œæ— æ³•èƒœé€‰ï¼Œç»§ç»­çœ‹ã€‚psï¼šå¦‚æœèƒœé€‰å°±becomeLeaderæˆä¸ºleaderäº†ã€‚å¦‚æœä¸æ˜¯å•èŠ‚ç‚¹ï¼Œå°±è¦é€šè¿‡r.sendå‘é€æŠ•ç¥¨ç»™å„ä¸ªpeersï¼šsee æºç ã€‚è¿™é‡Œçš„r.sendå¹¶ä¸æ˜¯çœŸçš„ç½‘ç»œå‘é€ï¼Œè€Œæ˜¯è®°å½•åˆ°r.msgsé‡Œé¢ç­‰ä¸‹å¤„ç†è¿™é‡Œçš„r.msgsã€‚æ³¨æ„è¿™é‡Œr.sendçš„æ—¶å€™å·²ç»ç¼–ç¨‹äº†MsgVoteç±»å‹äº†ï¼Œè¡¨ç¤ºæŠ•ç¥¨è¯·æ±‚ï¼Œåç»­ä¹Ÿåº”è¯¥æ”¶åˆ°MsgVoteRespã€‚ r.msgsä»€ä¹ˆæ—¶å€™å¤„ç†å‘¢ï¼Ÿè¿˜æ˜¯å‰é¢æˆ‘ä»¬æåˆ°çš„è¿™ä¸ªå¤§å¾ªç¯ä½“ï¼Œæ¯è½®å¾ªç¯éƒ½ä¼šæ£€æŸ¥r.msgsä¸­æœ‰æ²¡æœ‰messageè¦å¤„ç†ï¼šsee æºç ï¼Œè¿™é‡Œçš„å‡½æ•°n.rn.HasReady()æ–¹æ³•æ£€æŸ¥åˆ°len(r.msgs)\u0026gt;0ï¼Œåˆ™è®¤ä¸ºæœ‰æ¶ˆæ¯è¦å¤„ç†ï¼Œè¿™ä¸ªæ¶ˆæ¯æœ€ç»ˆä¼šè¢«åŒ…è£…åˆ°ä¸€ä¸ªReady{}äº‹ä»¶ä¸­ï¼Œè¿™ä¸ªäº‹ä»¶ä¼šè¢«ä¸¢åˆ°n.readycè¿™ä¸ªchanä¸­ï¼Œä»€ä¹ˆæ—¶å€™å¤„ç†åœ¨ä¸‹é¢serveChannelsä¸­ä»‹ç»ã€‚ becomeLeaderï¼šsee æºç ï¼Œstepå‡½æ•°å˜ä¸ºstepLeaderï¼Œtickå‡½æ•°åˆ™å˜æˆtickHeartbeatï¼Œæ„å‘³ç€å½“å‰ä¸ºleaderéœ€è¦ç»™followerså®šæ—¶å‘é€heartbeatæ¥é‡ç½®å®ƒä»¬çš„é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œé‚£ä¹ˆheartbeatæ˜¯ä»€ä¹ˆå½¢å¼çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯é€šè¿‡appendEntryï¼Œåªä¸è¿‡entryä¸ºç©ºï¼Œç”¨è¿™ç§ç©ºçš„entryæ¥è¡¨ç¤ºå¿ƒè·³ã€‚leaderå°±è¦æ‹…è´Ÿèµ·writeè¯·æ±‚çš„é‡ä»»äº†ã€‚ ä½†æ˜¯å¦‚æœæ²¡èƒœé€‰çš„è¯ï¼Œraftnodeçš„çŠ¶æ€å°±æ˜¯candidateï¼Œstepå‡½æ•°æœªstepCandidateï¼Œä¸‹é¢ä¼šç»§ç»­ç”¨åˆ°ã€‚    serveChannelsï¼š å‰é¢å…³äºr.msgsçš„æ¶ˆæ¯æ²¡è·Ÿè¸ªåˆ°åœ¨å“ªé‡Œå¤„ç†çš„ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ˜¯ä¸æ˜¯åœ¨serveChannelsé‡Œé¢ï¼Ÿ serveChannels: see æºç \n è¿™ä¸ªå‡½æ•°é‡Œé¢ä¹Ÿæœ‰ä¸€ä¸ªforäº‹ä»¶å¾ªç¯ï¼Œå½“å®ƒå‘ç°rc.node.Ready()æœ‰var rd Ready{}äº‹ä»¶å¯å¤„ç†æ—¶ï¼Œå¦‚æœrdä¸Šæœ‰éç©ºçš„snapshotï¼Œå°±å†™å…¥storageï¼Œç„¶åå°†rd.Entriesä¹Ÿè®°å½•åˆ°rd.HardStateï¼Œç„¶åå°†rd.Entriesä¹Ÿå†™å…¥storageï¼Œæœ€åå°†rd.Messageså‘é€åˆ°peersã€‚æˆ‘ä»¬æ„Ÿè§‰voteMsgæ˜¯åœ¨è¿™ä¸ªæ—¶å€™å‘é€ç»™peersçš„ï¼Œåˆ°åº•æ˜¯ä¸æ˜¯å‘¢ï¼šsee æºç ã€‚æ˜¯çš„ï¼Œè¿™é‡Œçš„rdäº‹ä»¶å°±æ˜¯ä»raftnode.Ready()ä»å‘ä»å…¶raftnode.readycè¿™ä¸ªchannelä¸­å–å‡ºæ¥çš„ã€‚å–å‡ºæ¥åé€šè¿‡transportå‘é€å‡ºå»ï¼Œè¿™æ ·voteMsgå°±å‘é€å‡ºå»äº†ï¼Œé‚£ä¹ˆæŠ•ç¥¨çš„å“åº”åˆæ˜¯ä»€ä¹ˆæ—¶å€™æ”¶åˆ°ã€ä»€ä¹ˆæ—¶å€™å¤„ç†çš„å‘¢ï¼Ÿ startRaft/AddPeerçš„æ—¶å€™ä¼šè°ƒç”¨startPeerï¼Œå†…éƒ¨ä¼šå¼€å§‹å¾ªç¯æ”¶åŒ…ï¼Œæ”¶peerå‘æ¥çš„raftmessageæ”¾å…¥ä¸€ä¸ªrecvc chanä¸­ï¼ŒstartPeerä¸­ä¸“é—¨å¼€å¯äº†ä¸€ä¸ªgoroutineæ¥æ£€æŸ¥recvcä¸­æœ‰æ²¡æœ‰peerå‘é€æ¥çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚peerå‘é€ç»™æˆ‘ä»¬çš„voteMsgçš„å“åº”åŒ…ï¼šsee æºç ã€‚è¿™é‡Œé€šè¿‡raft.Process(ctx,m)å¯¹raftmessageè¿›è¡Œå¤„ç†ã€‚å¦‚ä½•å¤„ç†æ˜¯åœ¨è¿™ä¸ªç¤ºä¾‹ä»£ç ä¸­å®šä¹‰çš„ï¼šsee æºç ï¼Œå³è°ƒç”¨stepå‡½æ•°è¿›è¡Œå¤„ç†ã€‚æˆ‘ä»¬å†å¾€å›çœ‹ä¸‹ï¼Œå‘é€è¿™ä¸ªæ¶ˆæ¯å‰å·²ç»æŠŠèŠ‚ç‚¹çš„stepå‡½æ•°ä¿®æ”¹ä¸ºäº†stepCandidateï¼Œé‚£æˆ‘ä»¬å†çœ‹ä¸‹è¿™ä¸ªå‡½æ•°é‡Œé¢å¹²äº†å•¥ï¼ŒçŒœæµ‹åº”è¯¥æœ‰åˆ¤æ–­æ˜¯å¦æ”¶åˆ°å¤šæ•°æŠ•ç¥¨ç¡®è®¤çš„é€»è¾‘ï¼› stepCandidateï¼šsee æºç ï¼Œæˆ‘ä»¬ä¸è€ƒè™‘å¯é€‰çš„prevoteé˜¶æ®µï¼Œå¾ˆæ˜¾ç„¶è¿™ä¸ªæ¶ˆæ¯MsgVoteçš„å“åº”ç±»å‹åº”è¯¥æ˜¯MsgVoteRespï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ç»§ç»­r.pollæ£€æŸ¥ä¸‹æ˜¯å¦èƒœé€‰å§ï¼Œå¦‚æœèƒœé€‰äº†ï¼Œåˆ™è‡ªå·±becomeLeaderï¼Œç„¶åå¹¿æ’­appendEntriesï¼Œè¿™é‡Œappendæ˜¯å¹²å•¥ï¼Œæ˜¯ä¸ºäº†é€šæ²»å…¶ä»–peersæ›´æ–°commit indexå§ã€‚  è¿™æ ·leaderé€‰ä¸¾å°±å®Œæˆäº†ï¼ï¼ï¼\netcd/raft leaderæ‰§è¡Œputæ“ä½œå¦‚ä½•ä¿è¯å¼ºä¸€è‡´ # ç”¨etcd/raftå®ç°å¼ºä¸€è‡´çš„ç³»ç»Ÿç¤ºä¾‹ï¼šhttps://github.com/etcd-io/etcd/tree/main/contrib/raftexampleã€‚æˆ‘ä»¬ä¸å¦¨ä»è¿™ä¸ªé¡¹ç›®å…¥æ‰‹æ¥çœ‹ä¸‹åˆ°åº•æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚ä¸Šè¿°é¡¹ç›®æ˜¯ä¸€ä¸ªæš´éœ²httpæ¥å£çš„kvå¼ºä¸€è‡´å­˜å‚¨ç³»ç»Ÿã€‚\næ¥ä¸‹æ¥é‡ç‚¹çœ‹ä¸€ä¸ªleaderè´Ÿè´£æ‰§è¡Œå‘½ä»¤put \u0026lt;key\u0026gt; \u0026lt;value\u0026gt;æ—¶çš„æ‰§è¡Œé€»è¾‘ï¼Œæ˜¯æ€æ ·çš„ï¼Œé¢†ç•¥ä¸‹è¿™ä¸ªè¿‡ç¨‹ä¸­raftæ‰®æ¼”çš„è§’è‰²ã€‚ putå‘½ä»¤æ˜¯é€šè¿‡http put methodå®ç°çš„ï¼Œsee æºç ã€‚\nè¿™é‡Œçš„å¤„ç†é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå®ƒç›´æ¥è°ƒç”¨äº†h.store.Propose(key, string(v))ï¼Œh.storeæ˜¯ä¸€ä¸ªkvstoreï¼Œè¿™é‡Œçš„Proposeæ˜¯å¹²å˜›å‘¢ï¼Ÿè¿™é‡Œå°±å¯ä»¥è·Ÿraftç®—æ³•ä¸­çš„MsgPropå…³è”èµ·æ¥äº†ï¼Œè¿˜è®°å¾—å—ï¼ŸMsgPropè¿™ç§æ¶ˆæ¯ç±»å‹æ˜¯ç”¨æ¥appendEntriesçš„ã€‚è¿™é‡Œçš„æ€æƒ³å°±æ˜¯WALï¼ˆwrite ahead logï¼‰çš„æ€æƒ³ï¼Œå…ˆæŠŠåŠ¨ä½œè®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œåé¢åœ¨é€šè¿‡æ—¥å¿—æ¥æ›´æ–°çŠ¶æ€æœºã€‚çŠ¶æ€æœºçš„çŠ¶æ€éƒ½åŒ…å«ä»€ä¹ˆå‘¢ï¼Œæˆ‘ä»¬å‰é¢å·²ç»çŸ¥é“æœ‰å„ç§çŠ¶æ€çš„æµè½¬ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¥å¿—ä¸­è®°å½•çš„æ•°æ®å­˜å‚¨åœ¨å“ªå‘¢ï¼Ÿ\nå°±æ˜¯è¿™é‡Œçš„kvstoreå•Šï¼ä¸€ä¸ªraftnodeå¯åŠ¨åè¦æŠŠå¿«ç…§ã€æ—¥å¿—ä¸­è®°å½•çš„äº‹ä»¶è¿˜åŸåˆ°ä¸€ä¸ªç‰¹å®šçš„å­˜å‚¨ä¸­ï¼Œè¿™ä¸ªç¤ºä¾‹ä¸­å°±æ˜¯ä¸€ä¸ªå†…å­˜ä¸­çš„kvæ•°æ®ç»“æ„ã€‚h.store.Propose(key,string(v))é¦–å…ˆå¼‚æ­¥åœ°è°ƒç”¨kvstore.Propose(key,val)å°†æ•°æ®å†™å…¥åˆ°proposeCè¿™ä¸ªchanä¸­ï¼šsee æºç ï¼Œç„¶åå†å¼‚æ­¥åœ°ä»ä¸­å–å‡ºæ¥ï¼šsee æºç ï¼Œé€šè¿‡rc.node.Propose(ctx, prop)ï¼Œè½¬å…¥raft.node.Proposeå®ç°ï¼šsee æºç ï¼Œè¿™é‡Œçš„n.stepWaitæ–¹æ³•å°†MsgPropæ¶ˆæ¯ç±»å‹ä»¥åŠè¦å†™å…¥çš„æ—¥å¿—æ•°æ®ä¼ ç»™stepWaitï¼Œè¿™é‡Œé¢å°†æ¶ˆæ¯å†™å…¥åˆ°raftnode.propcå°±å®Œäº‹è¿”å›äº†ã€‚\nstartPeerä»è¿™ä¸ªpropc chanä¸­å–å‡ºæ¶ˆæ¯mï¼Œç„¶år.Process(ctx, m)å»å¤„ç†ï¼Œr.Processæ–¹æ³•æ˜¯åœ¨ç¤ºä¾‹ä»£ç ä¸­è‡ªå®šä¹‰çš„ï¼Œsee æºç ï¼Œé€šè¿‡r.Processè¿›å…¥stepå‡½æ•°åˆæ¥åˆ°r.Step(m)ï¼Œæ­¤æ—¶raftnode.Stepå‡½æ•°æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿèµ¶ç´§çœ‹çœ‹å‘é€MsgPropæ¶ˆæ¯æ—¶åˆæ²¡æœ‰æ›´æ”¹raftnode.Stepï¼Œæ²¡æœ‰ï¼Œé‚£è¿™ä¸ªStepåº”è¯¥æ˜¯stepLeader\u0026hellip;æ²¡é”™ï¼Œæ²¿ç€stepLeaderä¸€è·¯çœ‹ä¸‹æ¥ï¼šsee æºç ï¼Œè¿™é‡Œæœç„¶æ˜¯leaderè®©peers appendEntriesçš„åŠ¨ä½œï¼Œå¹²äº†ä»€ä¹ˆå‘¢ï¼Ÿ\né¦–å…ˆå½“å‰raftnode.appendEntriesï¼ŒæŠŠMsgPropæ¶ˆæ¯é‡Œçš„æ—¥å¿—é¡¹ï¼ˆå¯èƒ½æœ‰å¤šæ¡ï¼‰å…ˆè¿½åŠ åˆ°è‡ªå·±çš„log entriesé‡Œé¢ï¼Œç„¶åbcastAppendå‘é€ç»™æ‰€æœ‰çš„peersè®©å®ƒä»¬å»append entriesï¼Œå®ƒä»¬è¿½åŠ æˆåŠŸåè‚¯å®šå›å›åŒ…MsgPropRespæ¶ˆæ¯ç±»å‹çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ¶ˆæ¯æ˜¯åœ¨å“ªé‡Œå¤„ç†çš„ï¼Ÿæ„Ÿè§‰åº”è¯¥ä¹Ÿæ˜¯åœ¨startPeerå‡½æ•°ä¸­çš„æ”¶åŒ…é€»è¾‘é‡Œé¢ã€‚é‚£åº”è¯¥ä¹Ÿæ˜¯ä»recvc chanä¸­å–å‡ºå›åŒ…å¤„ç†ã€‚\nå“ˆå“ˆï¼Œçœ‹åŠå¤©ç«Ÿç„¶æ²¡æœç´¢åˆ°MsgPropRespæ¶ˆæ¯ç±»å‹ï¼Œå‰é¢è¯»æºç æ—¶æœ‰ä¸ªç»†èŠ‚æ¼æ‰äº†ã€‚sendAppendçš„æ—¶å€™å®é™…ä¸Šä¼šæŠŠæ¶ˆæ¯ç±»å‹æ”¹æˆMsgAppï¼ˆMessageAppendï¼‰å»è¿½åŠ æ—¥å¿—ï¼Œfollowerså¤„ç†å®Œæˆåå“åº”ä¸€ä¸ªMsgAppRespæ¶ˆæ¯ç±»å‹ã€‚å¯¹äºleader raftnodeï¼Œæ”¶åˆ°æ¶ˆæ¯åè§¦å‘çŠ¶æ€è½¬æ¢ï¼Œåˆè¦æ‰§è¡Œå…¶stepå‡½æ•°ï¼Œæ­¤æ—¶stepå‡½æ•°è¿˜æ˜¯stepLeaderï¼Œå‘ç°æ¶ˆæ¯æ˜¯MsgAppRespï¼Œå‡†å¤‡å¤„ç†ï¼šsee æºç ã€‚\næˆ‘ä»¬å…ˆè€ƒè™‘æ­£å¸¸æƒ…å†µï¼Œleaderæ”¶åˆ°å“åº”å‘ç°followeråœ¨WALä¸­è®°å½•äº†å‘é€çš„log entriesï¼Œleaderæ”¶åˆ°æ­¤å“åº”åå°±ä¼šå†³å®šæ˜¯å¦è¦æ›´æ–°è¯¥followerçš„next indexï¼ˆä¸‹æ¬¡è¦å‘é€çš„log entrieså¼€å§‹ç´¢å¼•ï¼‰ã€‚ç„¶ååˆ¤æ–­æ˜¯å¦å¯ä»¥æ›´æ–°leaderçš„commit indexäº†ï¼Œæ›´æ–°äº†ä¹‹åå¯¹clientçš„è¯»è¯·æ±‚å°±å¯è§äº†ã€‚leaderæ›´æ–°äº†commit indexä¹‹åä¹Ÿè¦é€šè¿‡bcastAppendé€šçŸ¥followersæ›´æ–°commit indexã€‚\nè¿™äº›å·²æäº¤ç´¢å¼•ä¹‹å‰çš„log entriesä¼šè¢«å‘å¸ƒåˆ°ç¤ºä¾‹ä»£ç ä¸­çš„commitsC chanä¸­ï¼Œç„¶åæœ‰ä¸€ä¸ªgoroutineä¸“é—¨è¯»å–è¿™ä¸Šé¢çš„commitCå¹¶æŠŠå…¶ä¸­çš„entriesè¯»å–å‡ºæ¥ï¼Œåº”ç”¨åˆ°æˆ‘ä»¬çš„kvstoreä¸­ï¼Œè¿™æ ·å­˜å‚¨çš„ä¸€äº›æ•°æ®å°±ä»WALæ—¥å¿—è½¬åŒ–ä¸ºäº†å†…å­˜æ•°æ®ç»“æ„ä¸­çš„çœŸå®æ•°æ®ï¼Œå¯ä»¥å¯¹å¤–æä¾›æŸ¥è¯¢æœåŠ¡äº†ã€‚\nå°ç»“ # å¤§è‡´å°±æ˜¯è¿™äº›å†…å®¹å§ï¼æ„Ÿå…´è¶£çš„ç»§ç»­æ·±æŒ–ä¸‹raftexample+raftå®ç°å§ã€‚æ„Ÿè§‰è‡ªå·±å·²ç»ç†è§£äº†raftçš„æ ¸å¿ƒæ€æƒ³ä»¥åŠå¦‚ä½•ä½¿ç”¨raftæ¥å¼€å‘å¼ºä¸€è‡´å­˜å‚¨ç³»ç»Ÿäº†ï¼Œè¯»è€…æ˜¯ä¸æ˜¯ä¹Ÿæœ‰åŒæ„Ÿå‘¢:)\n"}),a.add({id:112,href:"/tags/techlead/",title:"techlead",description:"",content:""}),a.add({id:113,href:"/tags/technical-leadership/",title:"technical leadership",description:"",content:""}),a.add({id:114,href:"/blog/2021-08-17-%E5%9F%B9%E5%85%BB%E6%8A%80%E6%9C%AF%E9%A2%86%E5%AF%BC%E5%8A%9B/",title:"åŸ¹å…»æŠ€æœ¯é¢†å¯¼åŠ›",description:"æŠ€æœ¯é¢†å¯¼åŠ›çš„3ä¸ªå±‚æ¬¡ï¼šleading self, leading others, leading organizationsï¼Œä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ",content:"å…³äºå¦‚ä½•åŸ¹å…»è‡ªå·±çš„æŠ€æœ¯é¢†å¯¼åŠ›ï¼Œæ–‡ç« technical leadership: getting started ä¸­ä½œè€…åˆ†äº«äº†è‡ªå·±çš„å¿ƒå¾—ã€‚\nè¯»åæ·±æœ‰æ„Ÿè§¦ï¼Œç°åœ¨åšä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚æ€»ç»“ä¸æ‹˜æ³¥äºåŸæ–‡ç»“æ„ï¼Œæ ¹æ®ä¸ªäººæ„Ÿæ‚Ÿé‡æ–°æ•´ç†ä¸‹ã€‚\nå¡‘é€ é¢†å¯¼åŠ›çš„3ä¸ªå±‚æ¬¡ï¼šleading selfï¼Œleading othersï¼Œleading organizationsã€‚æ²¡æœ‰äººå¤©ç”Ÿå°±æ˜¯ä¸“å®¶ï¼Œåœ¨æˆä¸ºä¸“å®¶çš„è·¯çº¿ä¸Šï¼Œæˆ‘ä»¬å°±è¦æ²¿ç€è¿™3ä¸ªå±‚æ¬¡æ…¢æ…¢é”»ç‚¼æå‡è‡ªå·±ã€‚\næˆä¸ºä¸“å®¶ # æƒ³èµ·10000å°æ—¶å®šå¾‹ï¼Œè¦æˆä¸ºé¢†åŸŸä¸“å®¶æ˜¯éœ€è¦ä»˜å‡ºå¤§é‡çš„å®è·µçš„ï¼Œè¿‡ç¨‹ä¸­è¦ä¸æ–­æå‡è‡ªå·±çš„å®è·µèƒ½åŠ›ã€æŠ€æœ¯è§†é‡ã€å¯¹å…¬å¸ä¸šåŠ¡ä»·å€¼åŠç›®æ ‡çš„ç†è§£ã€‚èƒ½å¦æˆä¸ºçœŸæ­£çš„ä¸“å®¶ï¼Œé çš„ä¸æ˜¯è¿æ°”ï¼Œè€Œæ˜¯ç¨³å®šæŒç»­åœ°æœ‰åŠ›è¾“å‡ºï¼Œagain and again and againâ€¦consistentlyï¼è¿™é‡Œå°±è¦æ±‚è‡ªå·±å…ˆåšåˆ°leading selfï¼ŒæŠŠè‡ªå·±åšåˆ°æœ€å¥½ï¼Œèµ·åˆ°è¡¨ç‡çš„ä½œç”¨ã€‚ç„¶åå†å°è¯•é æŠ€æœ¯é¢†å¯¼åŠ›å»leading othersï¼Œleading organizationsã€‚\nå–„äºåˆ†äº« # æé«˜è¿™é‡Œçš„è¾“å‡ºï¼Œä¹Ÿä¸èƒ½æ€»æ˜¯ä¾é ä¸ªäººèƒ½åŠ›ã€‚å¦‚æœä½ æƒ³èµ°å¾—å¤Ÿå¿«ï¼Œä½ å¯èƒ½é€‰æ‹©è‡ªå·±èµ°ï¼›å¦‚æœä½ æƒ³èµ°å¾—æ›´è¿œï¼Œé‚£å¿…é¡»ä¾é å›¢é˜Ÿçš„åŠ›é‡ã€‚å¯¹äºæŒæ¡çš„çŸ¥è¯†ã€æŠ€èƒ½ï¼Œè—ç€æ–ç€å¹¶ä¸æ˜¯åœ¨å¸®ä½ ï¼Œå› ä¸ºä½ æ²¡æœ‰æ­£å‘æ¿€åŠ±åˆ°èº«è¾¹çš„äººï¼Œæ²¡æœ‰åœ¨æ°å½“çš„æ—¶å€™å¡‘é€ æœ‰åŠ›çš„æŠ€æœ¯å½±å“åŠ›ï¼Œæ›´æ²¡æœ‰å¸®åŠ©å¤§å®¶æå‡åˆ°æ›´æ¥è¿‘çš„æ®µä½æ¥ä¸€åœºæ›´æ¼‚äº®çš„å›¢æˆ˜ã€‚æ˜¯æ—¶å€™åœ°åˆ†äº«è‡ªå·±æŒæ¡çš„çŸ¥è¯†ã€æŠ€èƒ½ï¼Œä¹Ÿå‡å°‘ä»–äººå¯¹è‡ªå·±çš„ä¾èµ–ï¼Œä¾§é¢ä¸Šå¯ä»¥èµ¢å–æ›´å¤šçš„æ—¶é—´æ”¾åœ¨æ›´æœ‰ä»·å€¼çš„äº‹æƒ…ä¸Šã€‚çŸ¥è¯†æ˜¯æ²¡æœ‰ç©·å°½çš„ï¼Œæ€»ä¼šæœ‰æ›´å€¼å¾—é’»ç ”çš„é¢†åŸŸç­‰ç€å»æ¢ç´¢ã€‚\næœ‰æ•ˆæ²Ÿé€š # æœ‰æ•ˆæ²Ÿé€šï¼Œå¹¶ä¸æ˜¯è¯´è¦å¦‚ä½•å¿«é€Ÿåœ°ç»“æŸæ²Ÿé€šï¼Œè€Œæ˜¯å¦‚ä½•é«˜æ•ˆç‡åœ°è¾¾æˆå…±è¯†ã€‚å½“ç„¶æœ‰äº›æ²Ÿé€šä¸èƒ½è¾¾æˆå…±è¯†ï¼Œä½†æ˜¯ä¹Ÿè¦æœ‰æ•ˆåœ°åŒæ­¥åŒæ–¹æŒæ¡çš„é—®é¢˜èƒŒæ™¯ã€ä¿¡æ¯ï¼Œå®Œæˆæ„è§çš„äº¤æ¢ï¼Œä»åº”å½“æ”¾åœ¨æ²Ÿé€šç›®çš„çš„ç¬¬ä¸€ä½ã€‚çœ‹å¾…é—®é¢˜è¦é¿å…æºæ‚è¿‡å¤šä¸»è§‚æˆåˆ†ï¼Œå®¢è§‚çœ‹å¾…é—®é¢˜ï¼Œä»¥ç›®æ ‡ä¸ºå¯¼å‘ï¼Œæ›´æœ‰åŠ©äºä¿ƒæˆæœ‰æ•ˆæ²Ÿé€šã€‚æœ‰æ•ˆæ²Ÿé€šæ˜¯è¡¨è¾¾è‡ªå·±ã€äº†è§£ä»–äººçš„å‰æï¼Œä¹Ÿæ˜¯èƒ½å›¢æˆ˜çš„å¿…è¦æ¡ä»¶ã€‚\nåŠ æ²¹ï¼åŠ æ²¹ï¼åŠ æ²¹ï¼\n"}),a.add({id:115,href:"/tags/%E6%8A%80%E6%9C%AF%E9%A2%86%E5%AF%BC%E5%8A%9B/",title:"æŠ€æœ¯é¢†å¯¼åŠ›",description:"",content:""}),a.add({id:116,href:"/books/golang/",title:"Goè¯­è¨€è®¾è®¡å®ç°å†…å¹•",description:"ä½œä¸ºä¸€åGoè¯­è¨€å¼€å‘å±•ï¼Œå¾ˆåº†å¹¸è§è¯äº†Goè¯­è¨€çš„é€æ¸å‘å±•å£®å¤§ï¼Œç°åœ¨ä¹Ÿèµ¢å¾—äº†å¾ˆå¤šå¼€å‘è€…çš„é’çã€‚ä½œä¸ºä¸€åGopherï¼Œå¾ˆéš¾ä¸è¢«Goè¯­è¨€çš„è®¾è®¡å®ç°æ‰€ç€è¿·ï¼Œæˆ–è€…è¯´ï¼Œäº†è§£è¿™é‡Œçš„è®¾è®¡å®ç°ç»†èŠ‚ï¼Œå¯ä»¥è®©æˆ‘ä»¬å­¦åˆ°æ›´å¤šï¼Œä¹Ÿå¯ä»¥å†™å‡ºæ›´å¥½çš„ä»£ç ã€‚",content:"ä½œä¸ºä¸€åGoè¯­è¨€å¼€å‘å±•ï¼Œå¾ˆåº†å¹¸è§è¯äº†Goè¯­è¨€çš„é€æ¸å‘å±•å£®å¤§ï¼Œç°åœ¨ä¹Ÿèµ¢å¾—äº†å¾ˆå¤šå¼€å‘è€…çš„é’çã€‚ä½œä¸ºä¸€åGopherï¼Œå¾ˆéš¾ä¸è¢«Goè¯­è¨€çš„è®¾è®¡å®ç°æ‰€ç€è¿·ï¼Œæˆ–è€…è¯´ï¼Œäº†è§£è¿™é‡Œçš„è®¾è®¡å®ç°ç»†èŠ‚ï¼Œå¯ä»¥è®©æˆ‘ä»¬å­¦åˆ°æ›´å¤šï¼Œä¹Ÿå¯ä»¥å†™å‡ºæ›´å¥½çš„ä»£ç ã€‚\n åœ¨æˆ‘å­¦ä¹ Goè¯­è¨€çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé˜…è¯»äº†ä¸å°‘å…¶ä»–å¼€å‘è€…å†™çš„æ–‡ç« ï¼Œä¹Ÿåšäº†å¾ˆå¤šæºç åˆ†æã€è·Ÿè¸ªè°ƒè¯•ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Ÿäº†è§£è¿™äº›ç»†èŠ‚å…¶å®å¹¶ä¸æ˜¯æœ€é‡è¦çš„ï¼Œäº†è§£èƒŒåçš„è®¾è®¡æ–¹æ¡ˆã€è®¾è®¡æ€æƒ³æ‰æ˜¯æœ€æœ‰ä»·å€¼çš„ã€‚ç»†èŠ‚æ€»æ˜¯åœ¨å˜åŒ–ä¸­çš„ï¼Œä½†æ˜¯è®¾è®¡æ–¹æ¡ˆã€æ€æƒ³çš„å¤§æ–¹å‘æ˜¯æ›´åŠ æ˜ç¡®äº›çš„ã€‚æˆ‘é€æ¸å°†ä¹‹å‰æ”¶é›†ã€ä¹¦å†™çš„å†…å®¹è¿›è¡Œåˆ†ç±»æ•´ç†ï¼Œå°±å˜æˆäº†å½“å‰çš„ç”µå­ä¹¦ã€‚\næœ¬å†…å®¹æ¶‰åŠå¤§é‡çš„Goè¯­è¨€è®¾è®¡å®ç°æ–¹é¢çš„å†…å®¹ï¼ŒåŒ…æ‹¬ç¼–è¯‘å™¨ã€é“¾æ¥å™¨ã€è¿è¡Œæ—¶è°ƒåº¦ã€å†…å­˜åˆ†é…å™¨ã€åƒåœ¾å›æ”¶å™¨ã€æ ‡å‡†åº“ç­‰ç­‰ï¼Œå°½é‡ä¿è¯çŸ¥è¯†ç‚¹çš„ç³»ç»Ÿæ€§ï¼Œã€ŠGoè¯­è¨€è®¾è®¡å®ç°å†…å¹•ã€‹ã€‚\næ¬¢è¿é˜…è¯»ï¼Œå¦‚æœæ‚¨åœ¨é˜…è¯»è¿‡ç¨‹ä¸­å‘ç°æœ‰é”™è¯¯ã€ç–æ¼ã€å»ºè®®ï¼Œä¸è¦çŠ¹è±«ï¼Œè¯·ç»™æˆ‘æissueã€‚\n"}),a.add({id:117,href:"/tags/8%E6%9D%A1%E8%B0%AC%E8%AE%BA/",title:"8æ¡è°¬è®º",description:"",content:""}),a.add({id:118,href:"/tags/%E5%88%86%E5%B8%83%E5%BC%8F/",title:"åˆ†å¸ƒå¼",description:"",content:""}),a.add({id:119,href:"/blog/2021-07-05-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AE%A1%E7%AE%978%E6%9D%A1%E8%B0%AC%E8%AE%BA/",title:"åˆ†å¸ƒå¼è®¡ç®—çš„8æ¡è°¬è®º",description:"åˆ†å¸ƒå¼è®¡ç®—çš„è°¬è®ºï¼Œæ˜¯ç”±L Peter Deutschä»¥åŠå…¶ä»–Sun Microsystemsçš„åŒè¡Œæ€»ç»“çš„å‡ æ¡åˆ†å¸ƒå¼è®¡ç®—åˆå­¦è€…ç»å¸¸è¯¯ä»¥ä¸ºæˆç«‹çš„åˆ¤æ–­ã€‚",content:"åˆ†å¸ƒå¼è®¡ç®—çš„è°¬è®ºï¼Œæ˜¯ç”±L Peter Deutschä»¥åŠå…¶ä»–Sun Microsystemsçš„åŒè¡Œæ€»ç»“çš„å‡ æ¡åˆ†å¸ƒå¼è®¡ç®—åˆå­¦è€…ç»å¸¸è¯¯ä»¥ä¸ºæˆç«‹çš„åˆ¤æ–­ã€‚\nè¿™8æ¡è°¬è®ºåˆ†åˆ«æ˜¯ï¼š\n ç½‘ç»œæ˜¯å¯é çš„ï¼› é€šä¿¡æ—¶å»¶ä¸º0ï¼› å¸¦å®½æ˜¯æ— é™çš„ï¼› ç½‘ç»œæ˜¯å®‰å…¨çš„ï¼› æ‹“æ‰‘ä¸ä¼šæ”¹å˜ï¼› åªæœ‰ä¸€ä¸ªç®¡ç†è€…ï¼› ä¼ è¾“æˆæœ¬ä¸º0ï¼› ç½‘ç»œæ˜¯åŒæ„çš„ï¼›  é™·å…¥è¿™8æ¡è°¬è®ºä¼šå¯¼è‡´å¦‚ä¸‹åæœï¼š\n å¼€å‘çš„è½¯ä»¶ç¨‹åºä¸­é’ˆå¯¹ç½‘ç»œçš„é”™è¯¯å¤„ç†ä¸å¤Ÿå¥å£®ï¼Œé‡åˆ°ç½‘ç»œé”™è¯¯æ—¶ç¨‹åºä¼šstallæˆ–è€…æ— é™ç­‰å¾…å“åº”ï¼Œå³ä¾¿æ˜¯ç½‘ç»œæ¢å¤äº†ï¼Œç¨‹åºä¹Ÿä¸èƒ½è‡ªè¡Œæ¢å¤æˆ–éœ€è¦æ‰‹åŠ¨é‡å¯ï¼› å¿½è§†é€šä¿¡æ—¶å»¶ä»¥åŠå¯èƒ½å¯¼è‡´çš„ä¸¢åŒ…é—®é¢˜ï¼Œåº”ç”¨å±‚ã€ä¼ è¾“å±‚å¼€å‘äººå‘˜å¼€å‘çš„ç¨‹åºå¯¹äºä¼ è¾“æµé‡å¤§å°æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œä¼šå¯¼è‡´ä¸¥é‡çš„çš„ä¸¢åŒ…æˆ–è€…å¸¦å®½æµªè´¹ï¼› æµé‡çš„å‘é€æ–¹ï¼Œå¿½è§†å¸¦å®½æœ¬èº«çš„é™åˆ¶ï¼Œä¼šå¯¼è‡´ä¸€äº›ç“¶é¢ˆï¼› å¿½è§†ç½‘ç»œå®‰å…¨å®¹æ˜“è¢«æ¶æ„ç”¨æˆ·å’Œä¸æ–­æ¼”è¿›çš„èƒ½ç»•è¿‡å®‰å…¨è½¯ä»¶çš„æ¶æ„ç¨‹åºè’™è”½åŒçœ¼ï¼› ç½‘ç»œæ‹“æ‰‘çš„æ”¹å˜ä¹Ÿä¼šå¯¹ç½‘ç»œå¸¦å®½å’Œé€šä¿¡æ—¶å»¶äº§ç”Ÿå½±å“ï¼Œå› æ­¤ä¼šäº§ç”Ÿç›¸ä¼¼çš„é—®é¢˜ï¼› å¯èƒ½ä¼šå‡ºç°å¤šä¸ªç®¡ç†å‘˜ï¼Œå®ƒä»¬å¯èƒ½ä¼šåˆ¶å®šå‡ºç›¸äº’å†²çªçš„ç­–ç•¥ï¼Œæµé‡çš„å‘é€æ–¹éœ€è¦çŸ¥é“è¿™é‡Œçš„â€œç­–ç•¥â€æ‰èƒ½æŒ‰é¢„æœŸè·¯å¾„ä¼ è¾“ï¼Œä½†æ˜¯ç­–ç•¥å‡ºç°å†²çªï¼Œä¼šå¯¹ä¼ è¾“é€ æˆå½±å“ã€‚ æ„å»ºã€ç»´æŠ¤ä¸€ä¸ªç½‘ç»œæˆ–è€…å­ç½‘çš„éšè—æˆæœ¬ä¸èƒ½è¢«å¿½ç•¥ï¼Œåœ¨é¢„ç®—ä¸­å¿…é¡»æ¸…æ™°åœ°åˆ—å‡ºæ¥ï¼Œè€Œä¸èƒ½å‡ºç°çªç„¶åœ°å‰Šå‡ï¼› å¦‚æœå‡å®šä¸€ä¸ªç³»ç»Ÿæ˜¯åŒæ„ç½‘ç»œï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´è¿™é‡Œåˆ—å‡ºçš„å‰3ä¸ªè°¬è®ºï¼›  è¿™8æ¡è°¬è®ºçš„è¯ç”Ÿï¼š\nè¿™8ä¸ªè°¬è®ºå¤§éƒ¨åˆ†ç”±æ¥è‡ªSun Microsystemså…¬å¸çš„L. Peter Deutschæå‡ºï¼Œ1994å¹´å®ƒæå‡ºäº†å‰7ä¸ªã€‚ä¸è¿‡Bill Joyå’ŒTom Lyonåœ¨é‚£æ—¶å°±æ—©å·²ç»å°†å‰4æ¡ä½œä¸ºç½‘ç»œè®¡ç®—çš„è°¬è®ºäº†ã€‚åœ¨1997å¹´ï¼ŒJames Goslingï¼ˆSunå‘˜å·¥ï¼Œä¹Ÿæ˜¯Javaä¹‹çˆ¶ï¼‰æ·»åŠ äº†ç¬¬8æ¡è°¬è®ºã€‚\n"}),a.add({id:120,href:"/tags/2pc/",title:"2PC",description:"",content:""}),a.add({id:121,href:"/tags/3pc/",title:"3PC",description:"",content:""}),a.add({id:122,href:"/tags/base/",title:"BASE",description:"",content:""}),a.add({id:123,href:"/tags/cap/",title:"CAP",description:"",content:""}),a.add({id:124,href:"/tags/concenus/",title:"Concenus",description:"",content:""}),a.add({id:125,href:"/tags/flp/",title:"FLP",description:"",content:""}),a.add({id:126,href:"/tags/paxos/",title:"Paxos",description:"",content:""}),a.add({id:127,href:"/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/",title:"åˆ†å¸ƒå¼ç³»ç»Ÿ",description:"",content:""}),a.add({id:128,href:"/blog/2021-07-01-%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%B7%A5%E7%A8%8B%E5%B8%88roadmap/",title:"åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆroadmap",description:"å¦‚ä½•æˆä¸ºä¸€åèµ„æ·±çš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆï¼Œéœ€è¦è¡¥é½å“ªäº›ç†è®ºåŸºç¡€ï¼Œåˆéœ€è¦å“ªäº›å·¥ç¨‹æ–¹é¢çš„é”»ç‚¼ï¼Ÿæœ¬æ–‡åŸæ–‡è§ Henry Robinson çš„æ–‡ç«  distributed systems theory for the distributed systems engineerï¼Œæˆ‘è§‰å¾—æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„roadmapï¼Œæ²¿ç€è¿™ä¸ªè„‰ç»œåŠå¹´ä¸‹æ¥ï¼Œè¿˜æ˜¯å¾ˆæœ‰æ”¶è·çš„â€¦â€¦ç»§ç»­:)\n1 æŒæ¡åˆ†å¸ƒå¼èƒŒåçš„ç›¸å…³ç†è®º # å¯èƒ½ä¼šæœ‰äººç”©å‡ºå¾ˆå¤šè®ºæ–‡ï¼ŒFLPè®ºæ–‡ã€Paxosè®ºæ–‡ã€Raftè®ºæ–‡ã€æ‹œå åº­å°†å†›ç›¸å…³çš„è®ºæ–‡\u0026hellip;ç›¸å…³çš„è®ºæ–‡å¯ä»¥æ‘†å‡ºå¾ˆå¤šï¼Œä½†æ˜¯è®ºæ–‡æ˜¯æœ‰ä¸€å®šæ·±åº¦çš„ï¼Œæ˜¯éå¸¸ä¸¥è°¨çš„è®ºè¿°ï¼Œå¯¹äºæ”»è¯»PhDçš„åŒå­¦æœ‰å¸®åŠ©ï¼Œä½†æ˜¯å¯¹äºä¸€åä»äº‹åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹çš„åŒå­¦çœŸçš„æœ‰å¿…è¦å…¨éƒ¨æŒæ¡å—ï¼Ÿåº”è¯¥çœ‹å¤šå°‘è®ºæ–‡ï¼Œæ¯•ç«Ÿç»è¿‡äº†é‚£ä¹ˆå¤šå¹´çš„å‘å±•ã€æ²‰æ·€å‘¢ï¼Ÿ ä½œä¸ºä¸€ååˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆï¼Œææ˜ç™½éœ€è¦æŒæ¡å“ªäº›ç†è®ºï¼Œæ¯”å•çº¯äº†è§£æœ‰å“ªäº›è®ºæ–‡æ›´é‡è¦ã€‚\n2 First Steps # ä¸‹é¢çš„4ä¸ªæ–‡é›†å¾ˆå¥½åœ°ä»‹ç»äº†æ„å»ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè¦é¢ä¸´çš„æŒ‘æˆ˜ï¼Œå®ƒä»¬å…±åŒæ¦‚è¿°äº†åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆå¿…é¡»å…‹æœçš„ä¸€äº›æŠ€æœ¯ä¸Šçš„å›°éš¾ï¼Œå¹¶ä¸ºåé¢ç« èŠ‚ä¸­æ›´è¯¦ç»†çš„è¯´æ˜å¥ å®šäº†åŸºç¡€ã€‚\n Distributed Systems for Fun and Profitï¼Œä»‹ç»äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬æ—¶é—´åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰®æ¼”çš„è§’è‰²ã€ä¸åŒçš„å¤åˆ¶ç­–ç•¥ç­‰ï¼› Notes on distributed systems for young bloodsï¼Œä¸æ˜¯çº¯ç†è®ºä»‹ç»ï¼Œåœ¨ç†è®ºå’Œå®è·µä¸­åšåˆ°äº†ä¸€ä¸ªä¸é”™çš„å¹³è¡¡ï¼Œä¸ºåç»­æ›´æ·±å…¥å­¦ä¹ æ‰“å¥½åŸºç¡€ï¼› A Note on Distributed Systemsï¼Œä¸€ç¯‡å¾ˆç»å…¸çš„è®ºæ–‡ï¼Œè§£é‡Šäº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¸èƒ½æ€»æŠŠè¿œç¨‹äº¤äº’å¯¹è±¡å½“åšæœ¬åœ°çš„å¯¹è±¡ï¼Œè®©è¯»è€…ç†è§£åˆ†å¸ƒå¼åœºæ™¯ä¸­çš„é—®é¢˜å’ŒæŒ‘æˆ˜ï¼› The fallacies of distributed computingï¼Œåˆ†å¸ƒå¼è®¡ç®—çš„8ä¸ªè°¬è®ºï¼Œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡äººå‘˜è®¾è®¡ç³»ç»Ÿæ‰“ä¸‹åŸºç¡€ï¼›  æˆ‘ä»¬éœ€è¦äº†è§£ä¸¤ä¸ªé‡è¦å±æ€§çš„å«ä¹‰ï¼Œâ€œsafetyâ€å’Œâ€œlivenessâ€ï¼š\n safetyï¼Œè¯¥å±æ€§è¡¨ç¤ºä¸ä¼šæœ‰åçš„äº‹æƒ…å‘ç”Ÿï¼Œå¦‚APIä¸ä¼šè¿”å›ä¸ä¸€è‡´çš„valueã€é›†ç¾¤ä¸­ä¸ä¼šåŒæ—¶é€‰å‡ºä¸¤ä¸ªleaderç­‰ï¼› livenessï¼Œè¯¥å±æ€§è¡¨ç¤ºå¥½çš„äº‹æƒ…æœ€ç»ˆä¼šå‘ç”Ÿï¼Œå¦‚APIæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªç»“æœã€ç£ç›˜å†™æ“ä½œæœ€ç»ˆä¼šå®Œæˆç­‰ï¼›  3 Failure and Time # åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆé¢å¯¹çš„ä¸€äº›å›°éš¾ï¼Œå…¶å®å¯ä»¥å½’ç»“ä¸ºä¸‹é¢2ä¸ªåŸå› ï¼š\n Processes may fail There\u0026rsquo;s no good way to tell that they have done so  å³ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„è¿›ç¨‹å¯èƒ½ä¼šå‡ºç°æ•…éšœï¼Œä½†æ˜¯å…¶ä»–è¿›ç¨‹åˆæ²¡æœ‰å¯é çš„æ–¹å¼æ¥æ„ŸçŸ¥è¿™ä¸ªè¿›ç¨‹å‡ºç°äº†æ•…éšœã€‚",content:"å¦‚ä½•æˆä¸ºä¸€åèµ„æ·±çš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆï¼Œéœ€è¦è¡¥é½å“ªäº›ç†è®ºåŸºç¡€ï¼Œåˆéœ€è¦å“ªäº›å·¥ç¨‹æ–¹é¢çš„é”»ç‚¼ï¼Ÿæœ¬æ–‡åŸæ–‡è§ Henry Robinson çš„æ–‡ç«  distributed systems theory for the distributed systems engineerï¼Œæˆ‘è§‰å¾—æ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„roadmapï¼Œæ²¿ç€è¿™ä¸ªè„‰ç»œåŠå¹´ä¸‹æ¥ï¼Œè¿˜æ˜¯å¾ˆæœ‰æ”¶è·çš„â€¦â€¦ç»§ç»­:)\n1 æŒæ¡åˆ†å¸ƒå¼èƒŒåçš„ç›¸å…³ç†è®º # å¯èƒ½ä¼šæœ‰äººç”©å‡ºå¾ˆå¤šè®ºæ–‡ï¼ŒFLPè®ºæ–‡ã€Paxosè®ºæ–‡ã€Raftè®ºæ–‡ã€æ‹œå åº­å°†å†›ç›¸å…³çš„è®ºæ–‡\u0026hellip;ç›¸å…³çš„è®ºæ–‡å¯ä»¥æ‘†å‡ºå¾ˆå¤šï¼Œä½†æ˜¯è®ºæ–‡æ˜¯æœ‰ä¸€å®šæ·±åº¦çš„ï¼Œæ˜¯éå¸¸ä¸¥è°¨çš„è®ºè¿°ï¼Œå¯¹äºæ”»è¯»PhDçš„åŒå­¦æœ‰å¸®åŠ©ï¼Œä½†æ˜¯å¯¹äºä¸€åä»äº‹åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹çš„åŒå­¦çœŸçš„æœ‰å¿…è¦å…¨éƒ¨æŒæ¡å—ï¼Ÿåº”è¯¥çœ‹å¤šå°‘è®ºæ–‡ï¼Œæ¯•ç«Ÿç»è¿‡äº†é‚£ä¹ˆå¤šå¹´çš„å‘å±•ã€æ²‰æ·€å‘¢ï¼Ÿ ä½œä¸ºä¸€ååˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆï¼Œææ˜ç™½éœ€è¦æŒæ¡å“ªäº›ç†è®ºï¼Œæ¯”å•çº¯äº†è§£æœ‰å“ªäº›è®ºæ–‡æ›´é‡è¦ã€‚\n2 First Steps # ä¸‹é¢çš„4ä¸ªæ–‡é›†å¾ˆå¥½åœ°ä»‹ç»äº†æ„å»ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿè¦é¢ä¸´çš„æŒ‘æˆ˜ï¼Œå®ƒä»¬å…±åŒæ¦‚è¿°äº†åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆå¿…é¡»å…‹æœçš„ä¸€äº›æŠ€æœ¯ä¸Šçš„å›°éš¾ï¼Œå¹¶ä¸ºåé¢ç« èŠ‚ä¸­æ›´è¯¦ç»†çš„è¯´æ˜å¥ å®šäº†åŸºç¡€ã€‚\n Distributed Systems for Fun and Profitï¼Œä»‹ç»äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†ï¼ŒåŒ…æ‹¬æ—¶é—´åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰®æ¼”çš„è§’è‰²ã€ä¸åŒçš„å¤åˆ¶ç­–ç•¥ç­‰ï¼› Notes on distributed systems for young bloodsï¼Œä¸æ˜¯çº¯ç†è®ºä»‹ç»ï¼Œåœ¨ç†è®ºå’Œå®è·µä¸­åšåˆ°äº†ä¸€ä¸ªä¸é”™çš„å¹³è¡¡ï¼Œä¸ºåç»­æ›´æ·±å…¥å­¦ä¹ æ‰“å¥½åŸºç¡€ï¼› A Note on Distributed Systemsï¼Œä¸€ç¯‡å¾ˆç»å…¸çš„è®ºæ–‡ï¼Œè§£é‡Šäº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¸èƒ½æ€»æŠŠè¿œç¨‹äº¤äº’å¯¹è±¡å½“åšæœ¬åœ°çš„å¯¹è±¡ï¼Œè®©è¯»è€…ç†è§£åˆ†å¸ƒå¼åœºæ™¯ä¸­çš„é—®é¢˜å’ŒæŒ‘æˆ˜ï¼› The fallacies of distributed computingï¼Œåˆ†å¸ƒå¼è®¡ç®—çš„8ä¸ªè°¬è®ºï¼Œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡äººå‘˜è®¾è®¡ç³»ç»Ÿæ‰“ä¸‹åŸºç¡€ï¼›  æˆ‘ä»¬éœ€è¦äº†è§£ä¸¤ä¸ªé‡è¦å±æ€§çš„å«ä¹‰ï¼Œâ€œsafetyâ€å’Œâ€œlivenessâ€ï¼š\n safetyï¼Œè¯¥å±æ€§è¡¨ç¤ºä¸ä¼šæœ‰åçš„äº‹æƒ…å‘ç”Ÿï¼Œå¦‚APIä¸ä¼šè¿”å›ä¸ä¸€è‡´çš„valueã€é›†ç¾¤ä¸­ä¸ä¼šåŒæ—¶é€‰å‡ºä¸¤ä¸ªleaderç­‰ï¼› livenessï¼Œè¯¥å±æ€§è¡¨ç¤ºå¥½çš„äº‹æƒ…æœ€ç»ˆä¼šå‘ç”Ÿï¼Œå¦‚APIæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªç»“æœã€ç£ç›˜å†™æ“ä½œæœ€ç»ˆä¼šå®Œæˆç­‰ï¼›  3 Failure and Time # åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆé¢å¯¹çš„ä¸€äº›å›°éš¾ï¼Œå…¶å®å¯ä»¥å½’ç»“ä¸ºä¸‹é¢2ä¸ªåŸå› ï¼š\n Processes may fail There\u0026rsquo;s no good way to tell that they have done so  å³ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„è¿›ç¨‹å¯èƒ½ä¼šå‡ºç°æ•…éšœï¼Œä½†æ˜¯å…¶ä»–è¿›ç¨‹åˆæ²¡æœ‰å¯é çš„æ–¹å¼æ¥æ„ŸçŸ¥è¿™ä¸ªè¿›ç¨‹å‡ºç°äº†æ•…éšœã€‚\nè¿›ç¨‹æŒæ¡å¹¶å…±äº«ç»™å…¶ä»–è¿›ç¨‹çš„æ—¶é—´æ–¹é¢çš„ä¿¡æ¯ã€å¯èƒ½æ£€æµ‹åˆ°çš„æ•…éšœåœºæ™¯ä»¥åŠå¯ä»¥æ­£ç¡®å®ç°çš„ç®—æ³•å’ŒåŸè¯­ä¹‹é—´å­˜åœ¨éå¸¸ç´§å¯†çš„å…³ç³»ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å‡è®¾ä¸¤ä¸ªä¸åŒçš„èŠ‚ç‚¹å¯¹äºç°åœ¨æ˜¯ä»€ä¹ˆæ—¶é—´æˆ–æ—¶é—´æµé€çš„é€Ÿåº¦å®Œå…¨æ²¡æœ‰å…±äº«çš„ä¿¡æ¯ã€‚\næˆ‘ä»¬éœ€è¦è®¤è¯†åˆ°ï¼š\n æ•…éšœæ¨¡å¼ï¼ˆfailure modesï¼‰ä¹Ÿæ˜¯åˆ†å±‚æ¬¡çš„ï¼Œå¤§è‡´åˆ†æˆï¼šcrash stopï¼ˆå´©æºƒåœæ­¢ï¼‰ â†’ omissionï¼ˆé—æ¼ï¼‰ â†’ Byzantineï¼ˆæ‹œå åº­ï¼‰ã€‚æˆ‘ä»¬è¦çŸ¥é“åœ¨å±‚æ¬¡ç»“æ„é¡¶éƒ¨å¯èƒ½å‘ç”Ÿçš„åœ¨è¾ƒä½çº§åˆ«å¿…é¡»æ˜¯å¯èƒ½çš„ï¼Œåœ¨è¾ƒä½å±‚ä¸å¯èƒ½å‘ç”Ÿçš„åœ¨æ›´é«˜çº§åˆ«ä¹Ÿå¿…é¡»æ˜¯ä¸å¯èƒ½çš„ï¼› åœ¨ç¼ºå°‘ä»»ä½•å…±äº«æ—¶é’Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªäº‹ä»¶å’Œå¦å¤–ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿçš„å…ˆåé¡ºåºã€‚æˆ‘ä»¬éœ€è¦æŒæ¡Lamport clocksï¼Œä»¥åŠå®ƒçš„æ³›åŒ–Vector clocksï¼Œä¹Ÿå‚è€ƒä¸‹Dynamoçš„è¿™ç¯‡è®ºæ–‡å§ï¼› å‘ç”Ÿå•ä¸ªæ•…éšœçš„å¯èƒ½æ€§ï¼Œå¯¹æˆ‘ä»¬å®ç°ä¸€ä¸ªæ­£ç¡®çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„å½±å“æœ‰å¤šå¤§ï¼ˆå¯ä»¥å‚è€ƒä¸‹é¢ç»™å‡ºçš„FLP resultçš„ç¬”è®°ï¼‰ï¼› ä¸åŒçš„æ—¶é—´æ¨¡å‹ï¼ˆmodels of timeï¼‰ï¼ŒåŒæ­¥ï¼ˆsynchronousï¼‰ã€éƒ¨åˆ†åŒæ­¥ï¼ˆpartially synchronousï¼‰ã€å¼‚æ­¥ï¼ˆasynchronousï¼‰ï¼› æ£€æµ‹æ•…éšœæ˜¯ä¸€ä¸ªåŸºæœ¬é—®é¢˜ï¼Œå®ƒåœ¨å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ä¹‹é—´è¿›è¡Œæƒè¡¡â€”â€”è¿™æ˜¯å¦ä¸€ä¸ªsafetyä¸livenessï¼ˆå®‰å…¨ä¸æ´»è·ƒï¼‰çš„å†²çªã€‚ çœŸæ­£å°†æ•…éšœæ£€æµ‹ä½œä¸ºç†è®ºé—®é¢˜æå‡ºçš„è®ºæ–‡æ˜¯ Chandra å’Œ Toueg çš„â€œUnreliable Failure Detectors for Reliable Distributed Systemsï¼ˆå¯é åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸å¯é æ•…éšœæ£€æµ‹å™¨ï¼‰â€ã€‚ä½†æ˜¯ä¹Ÿæœ‰å‡ ä¸ªè¾ƒçŸ­çš„æ‘˜è¦æ€»ç»“ - æˆ‘éå¸¸å–œæ¬¢æ–¯å¦ç¦å¤§å­¦çš„è¿™ä¸ªéšæœºæ‘˜è¦æ€»ç»“Survey on Scalable Failure Detectorsã€‚  4 The basic tension of fault tolerance # ä¸€ä¸ªå¯ä»¥å®¹å¿æŸäº›æ•…éšœï¼ˆfault toleranceï¼‰è€Œä¸é™çº§ï¼ˆdowngradeï¼‰çš„ç³»ç»Ÿå¿…é¡»èƒ½å¤Ÿåƒè¿™äº›æ•…éšœæ²¡æœ‰å‘ç”Ÿä¸€æ ·è¿è¡Œã€‚ è¿™é€šå¸¸æ„å‘³ç€ç³»ç»Ÿçš„æŸäº›éƒ¨åˆ†å¿…é¡»å†—ä½™åœ°å·¥ä½œï¼ˆwork redundantlyï¼‰ï¼Œä½†åšæ¯”ç»å¯¹å¿…è¦çš„å·¥ä½œæ›´å¤šçš„å·¥ä½œï¼ˆdo more work than is absolutely necessaryï¼‰é€šå¸¸ä¼šå¸¦æ¥æ€§èƒ½å’Œèµ„æºæ¶ˆè€—çš„æˆæœ¬ã€‚ è¿™æ˜¯ä¸ºç³»ç»Ÿæ·»åŠ å®¹é”™ï¼ˆfault toleranceï¼‰çš„åŸºæœ¬å†²çªã€‚\næˆ‘ä»¬éœ€è¦äº†è§£ï¼š\n ç¡®ä¿å•å‰¯æœ¬å¯ä¸²è¡ŒåŒ–ï¼ˆsingle-copy serialisabilityï¼‰çš„ä»²è£æŠ€æœ¯ï¼ˆquorum techniqueï¼‰ã€‚ è¯·å‚é˜… Skeen çš„åŸå§‹è®ºæ–‡ a quorum-based commit protocolï¼Œä½†ä¹Ÿè®¸æ›´å¥½çš„æ˜¯ Wikipedia çš„æ¡ç›®ã€‚ å…³äº2é˜¶æ®µæäº¤ï¼ˆ2-phase-commitï¼Œç®€ç§°2PCï¼‰ã€3é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰ã€Paxosï¼Œç­‰ç­‰ï¼Œå®ƒä»¬ä¸ºä»€ä¹ˆä¼šæ‹¥æœ‰ä¸åŒçš„å®¹é”™å±æ€§ï¼› æœ€ç»ˆä¸€è‡´æ€§ï¼ˆeventual consistencyï¼‰åŠå…¶ä»–æŠ€æœ¯ï¼Œå¦‚ä½•ä»¥å¯¹ç³»ç»Ÿè¡Œä¸ºçš„è¾ƒå¼±ä¿è¯ä¸ºä»£ä»·ï¼Œæ¥é¿å…ä¸€è‡´æ€§ã€æ€§èƒ½ä¹‹é—´çš„å†²çªã€‚Dynamoè®ºæ–‡ï¼ˆDynamo: Amazon\u0026rsquo;s Highly Available Key-Value Storeï¼‰æ˜¯ä¸€ä¸ªäº†è§£è¿™äº›å†…å®¹ä¸é”™çš„èµ·ç‚¹å§ï¼ŒPat Hellandçš„ç»å…¸è®ºæ–‡ Life Beyond Transactionsï¼ˆLife beyond Distributed Transactions: an Apostate\u0026rsquo;s Opinionï¼‰ ä¹Ÿå€¼å¾—ä¸€è¯»ã€‚  5 Basic Primitives # åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‡ ä¹æ²¡æœ‰è¾¾æˆä¸€è‡´çš„åŸºæœ¬æ„å»ºå—ï¼ˆbuilding blocksï¼‰ï¼Œä½†æ›´å¤šçš„å¼€å§‹å‡ºç°ã€‚ æˆ‘ä»¬éœ€è¦çŸ¥é“ä»¥ä¸‹é—®é¢˜æ˜¯ä»€ä¹ˆï¼Œä»¥åŠåœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼š\n é¢†å¯¼è€…é€‰ä¸¾ï¼ˆleader electionï¼‰ï¼ŒBullyç®—æ³•ç­‰ï¼› ä¸€è‡´æ€§å¿«ç…§ï¼ˆconsistent snapshottingï¼‰ï¼ŒChandyå’ŒLamportçš„ç»å…¸è®ºæ–‡ Distributed Snapshots: Determining Global States of a Distributed System ç­‰ï¼› å…±è¯†é—®é¢˜ï¼ˆconsensusï¼‰ï¼Œå‚è€ƒä¸Šé¢æåŠçš„2PCã€Paxosè®ºæ–‡ï¼› åˆ†å¸ƒå¼çŠ¶æ€æœºå¤åˆ¶ï¼ˆdistributed state machine replicationï¼‰ï¼Œwikipediaçš„ä»‹ç»å°±ä¸é”™ï¼ŒLampsonçš„è®ºæ–‡ How to build a highly available system using consensus æ¯”è¾ƒæ­£å¼ä½†æ˜¯æœ‰ç‚¹æ¯ç‡¥ï¼› å¹¿æ’­ï¼ˆbroadcastï¼‰ï¼ŒåŒæ—¶ä¼ é€’æ¶ˆæ¯ç»™ä¸æ­¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™é‡Œåˆæœ‰å‡ ç§ä¸åŒçš„æŠ€æœ¯ï¼š1ï¼‰åŸå­å¹¿æ’­ï¼ˆatomic broadcastï¼‰ï¼Œè¦ä¹ˆå¹¿æ’­ä¸€ä¸ªæ¶ˆæ¯ç»™åˆ†ç»„ï¼ˆgroupï¼‰å†…çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¦ä¹ˆä¸å¹¿æ’­ç»™ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼›2ï¼‰gossipï¼Œå‚è€ƒç»å…¸è®ºæ–‡ï¼›3ï¼‰å› æœå¤šæ’­ï¼ˆcausal multicastï¼‰ï¼Œä¹Ÿè€ƒè™‘ä¸‹Birmanå’ŒCheritonä¹‹é—´ä»¤äººæ„‰å¿«çš„æ¥å›ã€‚ é“¾å¼å¤åˆ¶ï¼ˆchain replicationï¼‰ï¼Œé€šè¿‡å°†èŠ‚ç‚¹ç»„ç»‡æˆè™šæ‹Ÿé“¾è¡¨æ¥ç¡®ä¿å†™å…¥çš„ä¸€è‡´æ€§å’Œé¡ºåºæ€§çš„ä¸€ç§å·§å¦™æ–¹æ³•ã€‚1ï¼‰æœ€æ—©çš„è®ºæ–‡ Chain Replication for Supporting High Throughput and Availabilityï¼›2ï¼‰å¯¹è¯»å¤šå†™å°‘åœºæ™¯çš„ä¸€ç³»åˆ—æ”¹è¿› Object Storage on CRAQ: High-throughput chain replication for read-mostly workloadsï¼›3ï¼‰@slfritchieåšçš„ä¸€ä¸ªå®éªŒæŠ¥å‘Š Chain Replication In Theory and in Practice Working Title, rough draftã€‚  6 Fundamental Results # å…³äºåˆ†å¸ƒå¼ç†è®ºçš„å‡ ä¸ªäº‹å®è¦ç‰¢è®°åœ¨å¿ƒï¼Œå…ˆåˆ—å‡ ä¸ªå¸®åŠ©æ¯”è¾ƒå¤§çš„ã€‚\n å¦‚æœåœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼ˆç½‘ç»œåˆ†åŒºï¼‰ï¼Œæˆ‘ä»¬å°†ä¸èƒ½å®ç°å¼ºä¸€è‡´æ€§å­˜å‚¨ï¼ˆCï¼‰çš„åŒæ—¶è¿˜èƒ½å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæ­£ç¡®å“åº”ï¼ˆAï¼‰ã€‚è¿™å°±æ˜¯å¤§å®¶ç†ŸçŸ¥çš„CAPç†è®ºï¼› å…±è¯†ï¼ˆconcensusï¼‰æ˜¯ä¸å¯èƒ½é€šè¿‡å¦‚ä¸‹æ–¹å¼å®ç°çš„ï¼š1ï¼‰æ€»æ˜¯æ­£ç¡®çš„ï¼›2ï¼‰æ€»èƒ½ç»ˆæ­¢ï¼Œå³ä½¿å½“ï¼ˆå¼‚æ­¥ï¼‰ç³»ç»Ÿä¸­æŸå°æœºå™¨å‡ºç°â€œå´©æºƒ-åœæ­¢ï¼ˆcrash-stopï¼‰â€æ—¶ï¼ˆFLP resultï¼‰ã€‚åœ¨è®ºæ–‡â€œWe Love SF Talkâ€ç¬¬ä¸€é¡µè§£é‡Šäº†FLP resultï¼Œåé¢æ˜¯è¯æ˜ï¼Œæ²¡æœ‰å¿…è¦å»ææ˜ç™½è¯æ˜è¿‡ç¨‹ï¼ˆåè¯ï¼Œç¢ç£¨ä¸‹ä¹Ÿå¥½ç†è§£ï¼‰ã€‚ ä¸€èˆ¬è€Œè¨€ï¼Œåœ¨å°‘äº2è½®æ¶ˆæ¯äº¤äº’çš„æƒ…å†µä¸‹ä¸å¯èƒ½è§£å†³å…±è¯†é—®é¢˜ï¼› åŸå­å¹¿æ’­ï¼ˆatomic broadcastï¼‰å’Œå…±è¯†é—®é¢˜ä¸€æ ·å›°éš¾â€”â€”å‡†ç¡®åœ°è¯´ï¼Œå¦‚æœæˆ‘ä»¬è§£å†³äº†åŸå­å¹¿æ’­ï¼Œä¹Ÿå°±è§£å†³äº†å…±è¯†é—®é¢˜ï¼›åä¹‹äº¦ç„¶ã€‚Chandraå’ŒTouegè¯æ˜äº†è¿™ä¸€ç‚¹ï¼ˆUnreliable Failure Detectors for Reliable Distributed Systemsï¼‰ï¼Œæˆ‘ä»¬äº†è§£è¿™æ˜¯å¯¹çš„å°±å¥½äº†ã€‚  7 Real Systems # æŒæ¡ã€ç²¾é€šåˆ†å¸ƒå¼çš„æœ€é‡è¦çš„æ–¹å¼å°±æ˜¯ä¸æ–­å®è·µï¼Œä¸æ–­é˜…è¯»ã€äº†è§£ã€è·Ÿè¿›ã€è¯„ä»·ä¸šç•Œçš„çœŸå®ç³»ç»Ÿã€æ–°å‡ºç°ç³»ç»Ÿçš„è®¾è®¡å†³ç­–ã€‚ ä¸€éåˆä¸€éåœ°è¿™æ ·åšã€‚\nä¸‹é¢æ˜¯ä¸€äº›æ¨èé˜…è¯»ä¿¡æ¯ï¼š\nGoogleï¼š\n GFS Spanner F1 Chubby BigTable MillWheel Omega Dapper Paxos Made Live The Tail At Scale  Not Googleï¼š\n Dryad Cassandra Ceph RAMCloud HyperDex PNUTS Azure Data Lake Store  8 Postscript # æœ¬æ–‡ä½œè€…æ˜¯ Henry Robinson ï¼ŒåŸæ–‡è§ distributed systems theory for the distributed systems engineerã€‚ä½œè€…åœ¨æ–‡æœ«ç•™äº†ä¸ªæ‹›è˜å¹¿å‘Šï¼Œè¿™é‡Œå°±ä¿ç•™äº†ï¼ˆæ—¢ç„¶å¹²è´§æ»¡æ»¡å¦‚æ­¤æœ‰è¯šæ„ï¼‰ã€‚\n å¦‚æœä½ æŒæ¡äº†è¿™ä¸ªåˆ—è¡¨ä¸­çš„æ‰€æœ‰æ¦‚å¿µå’ŒæŠ€æœ¯ï¼Œå¯ä»¥è”ç³»æˆ‘ï¼Œæˆ‘æƒ³å’Œä½ è°ˆè°ˆæˆ‘ä»¬åœ¨Cloudera Slackçš„åˆ†å¸ƒå¼ç³»ç»Ÿå·¥ç¨‹å¸ˆå¼€å‘èŒä½ã€‚â€”â€” Henry Robinson\n psï¼šä½œè€…åŠŸåŠ›æœ‰é™ï¼Œç¿»è¯‘ä¸­å¦‚æœ‰ç–æ¼é”™è¯¯ä¹‹å¤„ï¼Œè¯·æŒ‡å‡ºæ¥é¿å…æˆ‘è¯¯å¯¼ä»–äººã€‚\n"}),a.add({id:129,href:"/tags/design/",title:"design",description:"",content:""}),a.add({id:130,href:"/tags/go/",title:"go",description:"",content:""}),a.add({id:131,href:"/blog/2021-06-23-go%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0%E7%B3%BB%E5%88%97%E6%96%87%E9%9B%86/",title:"goè®¾è®¡å®ç°ç³»åˆ—æ–‡é›†",description:"é™†ç»­çœ‹è¿‡ä¸€äº›goè¯­è¨€è®¾è®¡å®ç°çš„æ–‡ç« ï¼Œç¼–è¯‘å™¨ã€è¿è¡Œæ—¶è°ƒåº¦ã€å†…å­˜ç®¡ç†ã€åƒåœ¾å›æ”¶ã€raceæ£€æµ‹ã€ASTã€locksç­‰ç­‰å§ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç³»ç»Ÿã€‚æ”¶è—çš„è¿™äº›æ–‡ç« ï¼Œæè¿°éƒ½æ¯”è¾ƒå½¢è±¡ã€ç®€å•æ˜“æ‡‚ï¼Œå’ŒåŠ¨è¾„åˆ†æå¤§ç¯‡å¹…çš„æºç æ¥è¯´ï¼Œå¯¹åˆå­¦è€…æˆ–è€…å¸Œæœ›åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å­¦ä¹ çš„åŒå­¦æ¥è¯´ï¼Œä¼šæ¯”è¾ƒå‹å¥½ä¸€ç‚¹â€¦â€¦å°±åˆ†äº«ä¸€ä¸‹å§ã€‚",content:"é™†ç»­çœ‹è¿‡ä¸€äº›goè¯­è¨€è®¾è®¡å®ç°çš„æ–‡ç« ï¼Œç¼–è¯‘å™¨ã€è¿è¡Œæ—¶è°ƒåº¦ã€å†…å­˜ç®¡ç†ã€åƒåœ¾å›æ”¶ã€raceæ£€æµ‹ã€ASTã€locksç­‰ç­‰å§ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç³»ç»Ÿã€‚æ”¶è—çš„è¿™äº›æ–‡ç« ï¼Œæè¿°éƒ½æ¯”è¾ƒå½¢è±¡ã€ç®€å•æ˜“æ‡‚ï¼Œå’ŒåŠ¨è¾„åˆ†æå¤§ç¯‡å¹…çš„æºç æ¥è¯´ï¼Œå¯¹åˆå­¦è€…æˆ–è€…å¸Œæœ›åˆ©ç”¨ç¢ç‰‡åŒ–æ—¶é—´å­¦ä¹ çš„åŒå­¦æ¥è¯´ï¼Œä¼šæ¯”è¾ƒå‹å¥½ä¸€ç‚¹â€¦â€¦å°±åˆ†äº«ä¸€ä¸‹å§ã€‚\n"}),a.add({id:132,href:"/tags/internals/",title:"internals",description:"",content:""}),a.add({id:133,href:"/tags/%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/",title:"è®¾è®¡å®ç°",description:"",content:""}),a.add({id:134,href:"/tags/l4/",title:"L4",description:"",content:""}),a.add({id:135,href:"/tags/l4ka/",title:"L4Ka",description:"",content:""}),a.add({id:136,href:"/tags/microkernel/",title:"microkernel",description:"",content:""}),a.add({id:137,href:"/blog/2021-06-19-the-l4-microkernel/",title:"The L4 MicroKernel",description:"L4ç®€ä»‹ # L4æ˜¯åœ¨L3åŸºç¡€ä¸Šå¼€å‘çš„ï¼Œæ”¹è¿›äº†IOå’ŒIPCç­‰ï¼ŒL4è‡´åŠ›äºæ‰“é€ ä¸€ä¸ªé€šç”¨çš„å¾®å†…æ ¸ï¼Œä»¥ä¾¿å…è®¸åœ¨å…¶åŸºç¡€ä¸Šè¿›ä¸€æ­¥å®šåˆ¶åŒ–æ¥æ»¡è¶³åœºæ™¯éœ€æ±‚ï¼ŒL4è¡ç”Ÿäº†ä¸å°‘å¾®å†…æ ¸å®ç°ã€‚\nç°åœ¨ä¹Ÿæœ‰äº›å·¥ä½œç»„è‡´åŠ›äºå°†Linuxåœ¨L4ä¸Šè¿è¡Œèµ·æ¥ï¼ˆL4Linuxï¼‰ï¼Œå°†Windowsåœ¨L4ä¸Šè¿è¡Œèµ·æ¥ï¼ˆL4Windowsï¼‰ï¼Œè‘—åçš„GNU Hurdå·²ç»ä»è€çš„Machå¾®å†…æ ¸è¿ç§»åˆ°äº†L4å¾®å†…æ ¸ã€‚\nå†…æ ¸åˆ’åˆ†ä¾æ® # å¾®å†…æ ¸ç›¸æ¯”äºå®å†…æ ¸ï¼Œä¸»è¦æ˜¯å¾®å†…æ ¸æä¾›çš„æ ¸å¿ƒæ›´å°ï¼ŒåŒºåˆ«äºŒè€…çš„ä¾æ®å¹¶éæºç å¤šå°‘ï¼Œè€Œæ˜¯å†…æ ¸ä¸­æä¾›åŠŸèƒ½çš„å¤šå¯¡ã€‚GNU Hurdä¸­æœ‰æä¾›å®å†…æ ¸ã€å¾®å†…æ ¸ã€æ··åˆå†…æ ¸çš„å¯¹æ¯”ç¤ºæ„å›¾ï¼Œç‚¹å‡»æŸ¥çœ‹ã€‚æ³¨æ„ï¼Œå®å†…æ ¸æœ‰æ—¶è®°ä½œmonolithic kernelï¼Œä¹Ÿè®°ä½œmacro kernelã€‚\npsï¼šé€šå¸¸å¾®å†…æ ¸æºç ä¼šæ¯”å®å†…æ ¸å°‘å¾ˆå¤šï¼Œå¦‚L4::Pistachio/ia32åªæœ‰1w+å·¦å³çš„ä»£ç ï¼Œä½†æ˜¯Linuxæœ‰å‡ ç™¾ä¸‡è¡Œã€‚\nå¾®å†…æ ¸é€šå¸¸å°†å†…æ ¸åŠŸèƒ½é™å®šåœ¨ä¸‹é¢å‡ ä¸ªæ–¹é¢ï¼š\n è¿›ç¨‹ç®¡ç†ï¼› è™šæ‹Ÿå†…å­˜ç®¡ç†ï¼› è¿›ç¨‹é€šä¿¡ã€åŒæ­¥æœºåˆ¶ï¼›  å…¶ä»–å®å†…æ ¸ä¸­å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿã€è®¾å¤‡é©±åŠ¨ã€ç½‘ç»œåŠŸèƒ½åœ¨å¾®å†…æ ¸ä¸­éƒ½æ˜¯åœ¨ç”¨æˆ·æ€å®ç°ï¼Œè¿™äº›åŠŸèƒ½å¯èƒ½åœ¨single-serverä¸­å…¨éƒ¨å®ç°ï¼Œä¹Ÿå¯èƒ½åœ¨multi-serverä¸­å®ç°ï¼Œè¿›ç¨‹é€šè¿‡å†…æ ¸IPCæœºåˆ¶ä¸serverä¹‹é—´è¿›è¡Œé€šä¿¡æ¥ã€‚\nå› ä¸ºå¾®å†…æ ¸ä¸­ç”¨æˆ·ç¨‹åºè¯·æ±‚ä¸€äº›ç”¨æˆ·æ€çš„serverï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œç­‰æœåŠ¡ï¼‰éƒ½éœ€è¦å€ŸåŠ©IPCæ¥å®Œæˆï¼ŒIPCç”¨çš„éå¸¸å¤šï¼Œæ”¹è¿›å…¶æ€§èƒ½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚æ—©æœŸçš„å¾®å†…æ ¸å®ç°IPCæ€§èƒ½æ¯”è¾ƒå·®ï¼ŒL4åŠä»¥åçš„å¾®å†…æ ¸è®¾è®¡éƒ½å°†æå‡IPCæ€§èƒ½ä½œä¸ºä¸€ä¸ªé‡è¦æ–¹å‘ï¼ŒL4ä¸­å·²ç»åšçš„ä¸é”™äº†ï¼Œä¸€èµ·æ¥äº†è§£ä¸‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚\nå¾®å†…æ ¸ä¼˜ç¼ºç‚¹ # ä¼˜ç‚¹ #   robustnessï¼šå¾®å†…æ ¸ä¸­å°†å¾ˆå¤šåŠŸèƒ½åœ¨ç”¨æˆ·æ€å®ç°ï¼Œæ¯”å¦‚ä»¥multi-serverçš„æ–¹å¼å®ç°ï¼Œå‡å¦‚æ–‡ä»¶ç³»ç»ŸæœåŠ¡å‡ºæ•…éšœäº†ï¼Œç›´æ¥é‡å¯è¯¥æœåŠ¡å³å¯ï¼Œæ— éœ€é‡å¯æ•´ä¸ªå†…æ ¸ã€‚è€Œä¸”è¿™äº›æœåŠ¡æ˜¯åœ¨ç”¨æˆ·æ€è¿è¡Œçš„ï¼Œæ— æƒè®¿é—®æ ¸å¿ƒæ€æ•°æ®ï¼Œå¯¹æ•´ä¸ªå†…æ ¸æ— ç ´åæ€§ã€‚å¾®å†…æ ¸ä½“ç§¯å°ä¹Ÿæ›´æ–¹ä¾¿ç»´æŠ¤ã€è°ƒè¯•ã€å®šä½ã€ä¿®å¤ã€‚\n  securityï¼šå®‰å…¨æ˜¯ç³»ç»Ÿå¾ˆé‡è¦çš„æ–¹é¢ï¼Œrootç”¨æˆ·å¯ä»¥è®¿é—®ä¸€åˆ‡èµ„æºï¼Œå®å†…æ ¸ä¸­rootçš„æƒé™ã€å¯æ”¯é…èŒƒå›´ç›¸å½“å¤§ï¼Œrootæƒé™è¢«æ»¥ç”¨ä¼šå¯¼è‡´ä¸¥é‡é—®é¢˜ï¼Œå¦‚Linux 2.4ä»¥å‰ç‰ˆæœ¬ptraceå¯ä»¥åŠ è½½ä»»æ„æ¨¡å—åŒ…æ‹¬æ¶æ„æ¨¡å—ã€‚å¾®å†…æ ¸ä¸­è¿™æ ·å¯¹æƒé™æ”¶çš„æ›´ç´§ï¼Œæ²¡é‚£ä¹ˆå¤šç³»ç»Ÿè°ƒç”¨ï¼Œè‡ªç„¶è·å¾—rootæƒé™çš„å…¥å£æ›´å°‘ï¼Œæ›´å®¹æ˜“çº¦æŸã€‚\n  memory usageï¼šå†…æ ¸çš„ä»£ç ã€æ•°æ®éœ€è¦å¸¸é©»å†…å­˜ï¼Œå®å†…æ ¸ä¸­å³ä¾¿æŸäº›éƒ¨åˆ†ä¸å¸¸ç”¨åˆ°ä¹Ÿä¸èƒ½å¤Ÿæ¢å‡ºåˆ°äº¤æ¢åŒºï¼Œä¼šæµªè´¹å†…å­˜ç©ºé—´ï¼Œä¹Ÿå½±å“ç”¨æˆ·ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚åœ¨å¾®å†…æ ¸ä¸­ï¼Œå¾®å†…æ ¸æœ¬èº«ä½“ç§¯å°ï¼Œå®å†…æ ¸ä¸­çš„ä¸€äº›æ ¸å¿ƒæœåŠ¡è¢«æ”¾åˆ°ç”¨æˆ·æ€ä¸­å®ç°äº†ï¼Œä½¿ç”¨ä¸é¢‘ç¹çš„å†…å­˜åŒºå¯ä»¥æ¢å‡ºåˆ°äº¤æ¢åŒºã€‚\n  performanceï¼šå½“æƒ³åœ¨å¾®å†…æ ¸æ ¸å¿ƒæ€æ‰§è¡Œæ“ä½œæ—¶ï¼Œé€šå¸¸è¦å…³é—­ä¸­æ–­ï¼Œä»¥é¿å…ä¸€äº›é‡è¦çš„å¤„ç†è¿‡ç¨‹è¢«ä¸­æ–­ï¼Œè¿™ä¹ˆåšé¡¶å¤šä¼šå¯¼è‡´å½“å‰çš„ä¸€äº›ç¨‹åºã€æœåŠ¡æ²¡æœ‰å¤„ç†ä¸­æ–­è¯·æ±‚ã€‚å¦‚æœè€ƒè™‘å®æ—¶å¤„ç†çš„è¯ï¼Œåˆ™éœ€è¦è€ƒè™‘è¿™ç‚¹ã€‚\n  ç¼ºç‚¹ # å¾®å†…æ ¸çš„ç¼ºç‚¹å°±æ˜¯ç¨‹åºä¹‹é—´ã€ç¨‹åºå’ŒæŸäº›ç³»ç»ŸæœåŠ¡ä¹‹é—´çš„é€šä¿¡éƒ½éœ€è¦é€šè¿‡IPCæ¥å®Œæˆï¼Œå¦‚æœIPCæ€§èƒ½å·®åˆ™ä¼šå¯¼è‡´æ•´ä½“æ€§èƒ½å·®ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šç ”ç©¶å¦‚ä½•æé«˜IPCæ€§èƒ½çš„ç ”ç©¶ã€‚L4Kaçš„ç ”ç©¶äººå‘˜å¯ä»¥è¯æ˜ï¼Œèƒ½å¤Ÿå°†IPCçš„å¼€é”€ä»100msé™ä½åˆ°5msåŠä»¥ä¸‹ã€‚\nsee: https://www.youtube.com/watch?v=wCoLTnHUwEY.\nL4Kaçš„è®¾è®¡ # L4è¡¨ç¤ºç¬¬äºŒä»£å¾®å†…æ ¸ï¼Œå®ƒå¸æ”¶äº†ç¬¬ä¸€ä»£å¾®å†…æ ¸è®¾è®¡ä¸Šçš„ä¸€äº›ç»éªŒæ•™è®­ï¼Œç¬¬ä¸€ä»£å¾®å†…æ ¸ä¸­Machæ˜¯æœ€æœ‰åçš„å®ç°ä¹‹ä¸€ã€‚Machå’Œå½“æ—¶çš„å…¶ä»–å¾®å†…æ ¸å®ç°ç±»ä¼¼ï¼Œæ²¡æœ‰è‡ªåº•å‘ä¸Šåœ°æ€è€ƒåˆ°åº•å“ªäº›åŠŸèƒ½åº”è¯¥åœ¨å†…æ ¸ä¸­å®ç°ï¼Œå“ªäº›ä¸åº”è¯¥åœ¨å†…æ ¸ä¸­å®ç°ã€‚å…¶å®å®ƒä»¬çœ‹ä¸Šå»æ›´åƒæ˜¯æ‹¿åˆ°ä¸€ä¸ªå®å†…æ ¸ï¼Œç„¶åå†å°è¯•å°†ä¸€äº›å†…æ ¸ä¸­çš„ç³»ç»ŸæœåŠ¡æåˆ°ç”¨æˆ·å±‚å»ã€‚\nL4è€ƒè™‘äº†è¿™äº›é—®é¢˜ï¼Œæ¯”å¦‚å“ªäº›æœåŠ¡åœ¨ç”¨æˆ·æ€è¿è¡Œå¹¶ä¸”ä¸æŸå¤±å®‰å…¨æ€§å’ŒåŠŸèƒ½ã€‚æ¯”å¦‚L4å†…æ ¸ç”šè‡³éƒ½æ²¡å¿…è¦å¼•å…¥threadsæˆ–schedulerçš„æ¦‚å¿µï¼Œåªæä¾›å®ç°è¿›ç¨‹æŠ¢å çš„ç³»ç»Ÿè°ƒç”¨å°±å¯ä»¥ï¼ˆå°½ç®¡å®é™…æƒ…å†µæ˜¯L4æ”¯æŒç”¨æˆ·çº§çº¿ç¨‹ï¼‰ã€‚å¾®å†…æ ¸å°±æ˜¯è¿™æ ·ï¼Œæä¾›æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸­ç”¨æˆ·å¯ä»¥æ‰§è¡Œç‰¹å®šçš„ç­–ç•¥æ¥å®ç°æ›´åŠ å¤æ‚çš„åŠŸèƒ½ã€‚\nçœ‹L4Kaçš„è¯¦ç»†è®¾è®¡ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£å‡ ä¸ªæ¦‚å¿µã€‚\nL4KaåŸºæœ¬æ¦‚å¿µ #   threadsï¼šçº¿ç¨‹æ˜¯æœ€åŸºæœ¬çš„è°ƒåº¦å®ä½“ï¼Œåªæœ‰çº¿ç¨‹å¯ä»¥è¢«è°ƒåº¦ã€‚çº¿ç¨‹ä¹‹é—´çš„åŒå­¦æ˜¯é€šè¿‡IPCæ¥å®Œæˆçš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå¯„å­˜å™¨é›†åˆï¼ˆIPã€SPã€user-visible registersã€processor tableï¼‰ã€ä¸€ä¸ªå…³è”çš„taskã€è¿›ç¨‹åœ°å€ç©ºé—´ã€pagefault handlerï¼ˆé¡µå¼ç®¡ç†å™¨ï¼Œé€šè¿‡IPCæ¥æ”¶pagefaultè¯·æ±‚ï¼‰ã€exception handlerã€preempterså’Œä¸€äº›å…¶ä»–çš„è°ƒåº¦å‚æ•°ï¼ˆä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡ç­‰ï¼‰ã€‚\n  tasksï¼štaskæä¾›äº†è¿›ç¨‹æ‰§è¡Œéœ€è¦çš„ç¯å¢ƒï¼Œå®ƒåŒ…æ‹¬äº†ä¸€ä¸ªè™šåœ°å€ç©ºé—´ã€é€šä¿¡ç«¯å£ï¼Œä¸€ä¸ªtaskè‡³å°‘åŒ…æ‹¬äº†ä¸€ä¸ªthreadï¼Œæœ€æ–°çš„L4å®ç°ä¸é™åˆ¶çº¿ç¨‹æ•°é‡ã€‚taskä¸­åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹ï¼ˆé™¤äº†ä¸»çº¿ç¨‹ï¼‰åˆ›å»ºåéƒ½éœ€è¦æ˜¾ç¤ºå¯åŠ¨ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨lthread_ex_regs()æ¥å¯åŠ¨ã€‚ä¸€ä¸ªclanå¯ä»¥åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªtasksï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ˜¯chief taskï¼Œä¸€ä¸ªtaskåˆ›å»ºå¦ä¸€ä¸ªtaskï¼Œå‰è€…æˆä¸ºåè€…çš„chief taskã€‚taskåªå¯ä»¥è¢«chief task killæ‰ï¼Œæˆ–è€…å› ä¸ºchief taskè¢«killæ‰è€Œé—´æ¥è¢«killæ‰ã€‚\n  psï¼šè¿™é‡Œclanã€taskã€chief taskçš„å…³ç³»ï¼Œå¯ä»¥è”ç³»ä¸‹Linuxä¸‹çš„ä¼šè¯sessionã€ä¼šè¯é¦–è¿›ç¨‹ã€è¿›ç¨‹ç»„ã€ç»„é•¿è¿›ç¨‹ã€çˆ¶è¿›ç¨‹ä¹‹ç±»çš„æ¥ç†è§£ã€‚",content:"L4ç®€ä»‹ # L4æ˜¯åœ¨L3åŸºç¡€ä¸Šå¼€å‘çš„ï¼Œæ”¹è¿›äº†IOå’ŒIPCç­‰ï¼ŒL4è‡´åŠ›äºæ‰“é€ ä¸€ä¸ªé€šç”¨çš„å¾®å†…æ ¸ï¼Œä»¥ä¾¿å…è®¸åœ¨å…¶åŸºç¡€ä¸Šè¿›ä¸€æ­¥å®šåˆ¶åŒ–æ¥æ»¡è¶³åœºæ™¯éœ€æ±‚ï¼ŒL4è¡ç”Ÿäº†ä¸å°‘å¾®å†…æ ¸å®ç°ã€‚\nç°åœ¨ä¹Ÿæœ‰äº›å·¥ä½œç»„è‡´åŠ›äºå°†Linuxåœ¨L4ä¸Šè¿è¡Œèµ·æ¥ï¼ˆL4Linuxï¼‰ï¼Œå°†Windowsåœ¨L4ä¸Šè¿è¡Œèµ·æ¥ï¼ˆL4Windowsï¼‰ï¼Œè‘—åçš„GNU Hurdå·²ç»ä»è€çš„Machå¾®å†…æ ¸è¿ç§»åˆ°äº†L4å¾®å†…æ ¸ã€‚\nå†…æ ¸åˆ’åˆ†ä¾æ® # å¾®å†…æ ¸ç›¸æ¯”äºå®å†…æ ¸ï¼Œä¸»è¦æ˜¯å¾®å†…æ ¸æä¾›çš„æ ¸å¿ƒæ›´å°ï¼ŒåŒºåˆ«äºŒè€…çš„ä¾æ®å¹¶éæºç å¤šå°‘ï¼Œè€Œæ˜¯å†…æ ¸ä¸­æä¾›åŠŸèƒ½çš„å¤šå¯¡ã€‚GNU Hurdä¸­æœ‰æä¾›å®å†…æ ¸ã€å¾®å†…æ ¸ã€æ··åˆå†…æ ¸çš„å¯¹æ¯”ç¤ºæ„å›¾ï¼Œç‚¹å‡»æŸ¥çœ‹ã€‚æ³¨æ„ï¼Œå®å†…æ ¸æœ‰æ—¶è®°ä½œmonolithic kernelï¼Œä¹Ÿè®°ä½œmacro kernelã€‚\npsï¼šé€šå¸¸å¾®å†…æ ¸æºç ä¼šæ¯”å®å†…æ ¸å°‘å¾ˆå¤šï¼Œå¦‚L4::Pistachio/ia32åªæœ‰1w+å·¦å³çš„ä»£ç ï¼Œä½†æ˜¯Linuxæœ‰å‡ ç™¾ä¸‡è¡Œã€‚\nå¾®å†…æ ¸é€šå¸¸å°†å†…æ ¸åŠŸèƒ½é™å®šåœ¨ä¸‹é¢å‡ ä¸ªæ–¹é¢ï¼š\n è¿›ç¨‹ç®¡ç†ï¼› è™šæ‹Ÿå†…å­˜ç®¡ç†ï¼› è¿›ç¨‹é€šä¿¡ã€åŒæ­¥æœºåˆ¶ï¼›  å…¶ä»–å®å†…æ ¸ä¸­å¸¸è§çš„æ–‡ä»¶ç³»ç»Ÿã€è®¾å¤‡é©±åŠ¨ã€ç½‘ç»œåŠŸèƒ½åœ¨å¾®å†…æ ¸ä¸­éƒ½æ˜¯åœ¨ç”¨æˆ·æ€å®ç°ï¼Œè¿™äº›åŠŸèƒ½å¯èƒ½åœ¨single-serverä¸­å…¨éƒ¨å®ç°ï¼Œä¹Ÿå¯èƒ½åœ¨multi-serverä¸­å®ç°ï¼Œè¿›ç¨‹é€šè¿‡å†…æ ¸IPCæœºåˆ¶ä¸serverä¹‹é—´è¿›è¡Œé€šä¿¡æ¥ã€‚\nå› ä¸ºå¾®å†…æ ¸ä¸­ç”¨æˆ·ç¨‹åºè¯·æ±‚ä¸€äº›ç”¨æˆ·æ€çš„serverï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œç­‰æœåŠ¡ï¼‰éƒ½éœ€è¦å€ŸåŠ©IPCæ¥å®Œæˆï¼ŒIPCç”¨çš„éå¸¸å¤šï¼Œæ”¹è¿›å…¶æ€§èƒ½å°±æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚æ—©æœŸçš„å¾®å†…æ ¸å®ç°IPCæ€§èƒ½æ¯”è¾ƒå·®ï¼ŒL4åŠä»¥åçš„å¾®å†…æ ¸è®¾è®¡éƒ½å°†æå‡IPCæ€§èƒ½ä½œä¸ºä¸€ä¸ªé‡è¦æ–¹å‘ï¼ŒL4ä¸­å·²ç»åšçš„ä¸é”™äº†ï¼Œä¸€èµ·æ¥äº†è§£ä¸‹æ˜¯å¦‚ä½•å®ç°çš„ã€‚\nå¾®å†…æ ¸ä¼˜ç¼ºç‚¹ # ä¼˜ç‚¹ #   robustnessï¼šå¾®å†…æ ¸ä¸­å°†å¾ˆå¤šåŠŸèƒ½åœ¨ç”¨æˆ·æ€å®ç°ï¼Œæ¯”å¦‚ä»¥multi-serverçš„æ–¹å¼å®ç°ï¼Œå‡å¦‚æ–‡ä»¶ç³»ç»ŸæœåŠ¡å‡ºæ•…éšœäº†ï¼Œç›´æ¥é‡å¯è¯¥æœåŠ¡å³å¯ï¼Œæ— éœ€é‡å¯æ•´ä¸ªå†…æ ¸ã€‚è€Œä¸”è¿™äº›æœåŠ¡æ˜¯åœ¨ç”¨æˆ·æ€è¿è¡Œçš„ï¼Œæ— æƒè®¿é—®æ ¸å¿ƒæ€æ•°æ®ï¼Œå¯¹æ•´ä¸ªå†…æ ¸æ— ç ´åæ€§ã€‚å¾®å†…æ ¸ä½“ç§¯å°ä¹Ÿæ›´æ–¹ä¾¿ç»´æŠ¤ã€è°ƒè¯•ã€å®šä½ã€ä¿®å¤ã€‚\n  securityï¼šå®‰å…¨æ˜¯ç³»ç»Ÿå¾ˆé‡è¦çš„æ–¹é¢ï¼Œrootç”¨æˆ·å¯ä»¥è®¿é—®ä¸€åˆ‡èµ„æºï¼Œå®å†…æ ¸ä¸­rootçš„æƒé™ã€å¯æ”¯é…èŒƒå›´ç›¸å½“å¤§ï¼Œrootæƒé™è¢«æ»¥ç”¨ä¼šå¯¼è‡´ä¸¥é‡é—®é¢˜ï¼Œå¦‚Linux 2.4ä»¥å‰ç‰ˆæœ¬ptraceå¯ä»¥åŠ è½½ä»»æ„æ¨¡å—åŒ…æ‹¬æ¶æ„æ¨¡å—ã€‚å¾®å†…æ ¸ä¸­è¿™æ ·å¯¹æƒé™æ”¶çš„æ›´ç´§ï¼Œæ²¡é‚£ä¹ˆå¤šç³»ç»Ÿè°ƒç”¨ï¼Œè‡ªç„¶è·å¾—rootæƒé™çš„å…¥å£æ›´å°‘ï¼Œæ›´å®¹æ˜“çº¦æŸã€‚\n  memory usageï¼šå†…æ ¸çš„ä»£ç ã€æ•°æ®éœ€è¦å¸¸é©»å†…å­˜ï¼Œå®å†…æ ¸ä¸­å³ä¾¿æŸäº›éƒ¨åˆ†ä¸å¸¸ç”¨åˆ°ä¹Ÿä¸èƒ½å¤Ÿæ¢å‡ºåˆ°äº¤æ¢åŒºï¼Œä¼šæµªè´¹å†…å­˜ç©ºé—´ï¼Œä¹Ÿå½±å“ç”¨æˆ·ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚åœ¨å¾®å†…æ ¸ä¸­ï¼Œå¾®å†…æ ¸æœ¬èº«ä½“ç§¯å°ï¼Œå®å†…æ ¸ä¸­çš„ä¸€äº›æ ¸å¿ƒæœåŠ¡è¢«æ”¾åˆ°ç”¨æˆ·æ€ä¸­å®ç°äº†ï¼Œä½¿ç”¨ä¸é¢‘ç¹çš„å†…å­˜åŒºå¯ä»¥æ¢å‡ºåˆ°äº¤æ¢åŒºã€‚\n  performanceï¼šå½“æƒ³åœ¨å¾®å†…æ ¸æ ¸å¿ƒæ€æ‰§è¡Œæ“ä½œæ—¶ï¼Œé€šå¸¸è¦å…³é—­ä¸­æ–­ï¼Œä»¥é¿å…ä¸€äº›é‡è¦çš„å¤„ç†è¿‡ç¨‹è¢«ä¸­æ–­ï¼Œè¿™ä¹ˆåšé¡¶å¤šä¼šå¯¼è‡´å½“å‰çš„ä¸€äº›ç¨‹åºã€æœåŠ¡æ²¡æœ‰å¤„ç†ä¸­æ–­è¯·æ±‚ã€‚å¦‚æœè€ƒè™‘å®æ—¶å¤„ç†çš„è¯ï¼Œåˆ™éœ€è¦è€ƒè™‘è¿™ç‚¹ã€‚\n  ç¼ºç‚¹ # å¾®å†…æ ¸çš„ç¼ºç‚¹å°±æ˜¯ç¨‹åºä¹‹é—´ã€ç¨‹åºå’ŒæŸäº›ç³»ç»ŸæœåŠ¡ä¹‹é—´çš„é€šä¿¡éƒ½éœ€è¦é€šè¿‡IPCæ¥å®Œæˆï¼Œå¦‚æœIPCæ€§èƒ½å·®åˆ™ä¼šå¯¼è‡´æ•´ä½“æ€§èƒ½å·®ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šç ”ç©¶å¦‚ä½•æé«˜IPCæ€§èƒ½çš„ç ”ç©¶ã€‚L4Kaçš„ç ”ç©¶äººå‘˜å¯ä»¥è¯æ˜ï¼Œèƒ½å¤Ÿå°†IPCçš„å¼€é”€ä»100msé™ä½åˆ°5msåŠä»¥ä¸‹ã€‚\nsee: https://www.youtube.com/watch?v=wCoLTnHUwEY.\nL4Kaçš„è®¾è®¡ # L4è¡¨ç¤ºç¬¬äºŒä»£å¾®å†…æ ¸ï¼Œå®ƒå¸æ”¶äº†ç¬¬ä¸€ä»£å¾®å†…æ ¸è®¾è®¡ä¸Šçš„ä¸€äº›ç»éªŒæ•™è®­ï¼Œç¬¬ä¸€ä»£å¾®å†…æ ¸ä¸­Machæ˜¯æœ€æœ‰åçš„å®ç°ä¹‹ä¸€ã€‚Machå’Œå½“æ—¶çš„å…¶ä»–å¾®å†…æ ¸å®ç°ç±»ä¼¼ï¼Œæ²¡æœ‰è‡ªåº•å‘ä¸Šåœ°æ€è€ƒåˆ°åº•å“ªäº›åŠŸèƒ½åº”è¯¥åœ¨å†…æ ¸ä¸­å®ç°ï¼Œå“ªäº›ä¸åº”è¯¥åœ¨å†…æ ¸ä¸­å®ç°ã€‚å…¶å®å®ƒä»¬çœ‹ä¸Šå»æ›´åƒæ˜¯æ‹¿åˆ°ä¸€ä¸ªå®å†…æ ¸ï¼Œç„¶åå†å°è¯•å°†ä¸€äº›å†…æ ¸ä¸­çš„ç³»ç»ŸæœåŠ¡æåˆ°ç”¨æˆ·å±‚å»ã€‚\nL4è€ƒè™‘äº†è¿™äº›é—®é¢˜ï¼Œæ¯”å¦‚å“ªäº›æœåŠ¡åœ¨ç”¨æˆ·æ€è¿è¡Œå¹¶ä¸”ä¸æŸå¤±å®‰å…¨æ€§å’ŒåŠŸèƒ½ã€‚æ¯”å¦‚L4å†…æ ¸ç”šè‡³éƒ½æ²¡å¿…è¦å¼•å…¥threadsæˆ–schedulerçš„æ¦‚å¿µï¼Œåªæä¾›å®ç°è¿›ç¨‹æŠ¢å çš„ç³»ç»Ÿè°ƒç”¨å°±å¯ä»¥ï¼ˆå°½ç®¡å®é™…æƒ…å†µæ˜¯L4æ”¯æŒç”¨æˆ·çº§çº¿ç¨‹ï¼‰ã€‚å¾®å†…æ ¸å°±æ˜¯è¿™æ ·ï¼Œæä¾›æœ€åŸºç¡€çš„åŠŸèƒ½ï¼Œåœ¨ä¸åŒåœºæ™¯ä¸­ç”¨æˆ·å¯ä»¥æ‰§è¡Œç‰¹å®šçš„ç­–ç•¥æ¥å®ç°æ›´åŠ å¤æ‚çš„åŠŸèƒ½ã€‚\nçœ‹L4Kaçš„è¯¦ç»†è®¾è®¡ä¹‹å‰ï¼Œå…ˆæ¥äº†è§£å‡ ä¸ªæ¦‚å¿µã€‚\nL4KaåŸºæœ¬æ¦‚å¿µ #   threadsï¼šçº¿ç¨‹æ˜¯æœ€åŸºæœ¬çš„è°ƒåº¦å®ä½“ï¼Œåªæœ‰çº¿ç¨‹å¯ä»¥è¢«è°ƒåº¦ã€‚çº¿ç¨‹ä¹‹é—´çš„åŒå­¦æ˜¯é€šè¿‡IPCæ¥å®Œæˆçš„ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå¯„å­˜å™¨é›†åˆï¼ˆIPã€SPã€user-visible registersã€processor tableï¼‰ã€ä¸€ä¸ªå…³è”çš„taskã€è¿›ç¨‹åœ°å€ç©ºé—´ã€pagefault handlerï¼ˆé¡µå¼ç®¡ç†å™¨ï¼Œé€šè¿‡IPCæ¥æ”¶pagefaultè¯·æ±‚ï¼‰ã€exception handlerã€preempterså’Œä¸€äº›å…¶ä»–çš„è°ƒåº¦å‚æ•°ï¼ˆä¼˜å…ˆçº§ã€æ—¶é—´ç‰‡ç­‰ï¼‰ã€‚\n  tasksï¼štaskæä¾›äº†è¿›ç¨‹æ‰§è¡Œéœ€è¦çš„ç¯å¢ƒï¼Œå®ƒåŒ…æ‹¬äº†ä¸€ä¸ªè™šåœ°å€ç©ºé—´ã€é€šä¿¡ç«¯å£ï¼Œä¸€ä¸ªtaskè‡³å°‘åŒ…æ‹¬äº†ä¸€ä¸ªthreadï¼Œæœ€æ–°çš„L4å®ç°ä¸é™åˆ¶çº¿ç¨‹æ•°é‡ã€‚taskä¸­åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹ï¼ˆé™¤äº†ä¸»çº¿ç¨‹ï¼‰åˆ›å»ºåéƒ½éœ€è¦æ˜¾ç¤ºå¯åŠ¨ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨lthread_ex_regs()æ¥å¯åŠ¨ã€‚ä¸€ä¸ªclanå¯ä»¥åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªtasksï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªæ˜¯chief taskï¼Œä¸€ä¸ªtaskåˆ›å»ºå¦ä¸€ä¸ªtaskï¼Œå‰è€…æˆä¸ºåè€…çš„chief taskã€‚taskåªå¯ä»¥è¢«chief task killæ‰ï¼Œæˆ–è€…å› ä¸ºchief taskè¢«killæ‰è€Œé—´æ¥è¢«killæ‰ã€‚\n  psï¼šè¿™é‡Œclanã€taskã€chief taskçš„å…³ç³»ï¼Œå¯ä»¥è”ç³»ä¸‹Linuxä¸‹çš„ä¼šè¯sessionã€ä¼šè¯é¦–è¿›ç¨‹ã€è¿›ç¨‹ç»„ã€ç»„é•¿è¿›ç¨‹ã€çˆ¶è¿›ç¨‹ä¹‹ç±»çš„æ¥ç†è§£ã€‚\n flexpages and Virtual Address Spaceï¼šflexpagesæŒ‡çš„æ˜¯flexible large memory pagesï¼ŒL4é€šè¿‡è¿™äº›å†…å­˜æ¥è®¿é—®ä¸»å­˜å’Œè®¾å¤‡IOå†…å­˜ã€‚è¿›ç¨‹è™šåœ°å€ç©ºé—´ä¹Ÿæ˜¯ç”±flexpagesæ„æˆçš„ï¼Œæä¾›äº†ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æ¥ç®¡ç†flexpagesï¼šgrantã€mapã€flushã€‚grantå°†å†…å­˜é¡µä»ä¸€ä¸ªuseräº¤ç»™å¦ä¸€ä¸ªuserï¼Œå‰è€…å¤±å»è®¿é—®æƒé™ï¼›mapå°†å†…å­˜é¡µå…±äº«ç»™å¦ä¸€ä¸ªtaskï¼ŒäºŒè€…å‡å¯ä»¥è®¿é—®ï¼›å¦‚æœä¸€ä¸ªå†…å­˜é¡µå·²ç»æ˜ å°„ç»™å…¶ä»–ç”¨æˆ·ä½¿ç”¨äº†ï¼Œflushå°†æ¸…ç©ºå¯¹åº”åœ°å€ç©ºé—´ã€‚  IOå®ç° # L4å¹¶æ²¡æœ‰åœ¨å†…æ ¸ä¸­å®ç°IOï¼Œè€Œæ˜¯å°†å…¶æ”¾åˆ°äº†å†…æ ¸å¤–çš„ç”¨æˆ·å±‚å»å®ç°ã€‚å†…æ ¸åªæ˜¯æ¥å—IOç›¸å…³çš„ä¸­æ–­è¯·æ±‚ï¼ˆIPCè¯·æ±‚çš„å½¢å¼ï¼‰ï¼Œç„¶åå°†å…¶è½¬å‘ç»™å¯¹åº”çš„è®¾å¤‡é©±åŠ¨æ¥å®Œæˆå¤„ç†ã€‚è®¿é—®å¤–è®¾IOéƒ½æ˜¯ä»¥è¿™ç§æ–¹å¼è¿›è¡Œçš„ã€‚\nIPCå®ç° # å‡å¦‚task Açš„çº¿ç¨‹å‘é€ç»™task Bä¸­çš„çº¿ç¨‹ä¸€ä¸ªæ¶ˆæ¯Mï¼Œéœ€è¦ç»å†è¿™ä¹ˆå‡ æ­¥ï¼š\n A: load Bçš„id A: load data of M A: call kernel kernel: read IPC requestï¼Œload Bçš„id kernelï¼šswitch rsp to B\u0026rsquo;s rsp kernelï¼šswitch VMA to B\u0026rsquo;s VMA kernel: load Açš„idå¹¶è®¾ç½® kernelï¼šreturn to userspaceï¼ˆB\u0026rsquo;s VMA) B: receive Aå‘é€çš„Mï¼ˆæ¥è‡ªkernel load Açš„idå¹¶è®¾ç½®è¿™æ­¥ï¼‰  psï¼šè¿™é‡Œçš„è®¾è®¡å®ç°seeï¼šhttps://www.youtube.com/watch?v=mRr1lCJse_Iã€‚æ®è¯´ç°åœ¨å®å†…æ ¸ä¹‹æ‰€ä»¥è¿˜èƒ½æ´»çš„å¥½å¥½çš„ï¼Œä¸»è¦æ˜¯ä¹‹å‰çš„å¾®å†…æ ¸IPCæ€§èƒ½å®åœ¨å¤ªå·®ã€‚\nå¦‚æœæ˜¯å‘é€å°æ¶ˆæ¯ï¼Œæ‹·è´æ•°æ®åˆ°ç”¨æˆ·æ€æ·±åœ³å¯ä»¥ç”¨å¯„å­˜å™¨æ¥æå®šï¼Œé€Ÿåº¦å¿«ï¼›å¦‚æœæ˜¯å‘é€å¤§æ¶ˆæ¯ï¼Œåˆ™éœ€è¦å‡å°‘è¿™é‡Œçš„ä¸¤æ¬¡æ‹·è´åˆ°ä¸€æ¬¡æ‹·è´ï¼Œæ€ä¹ˆæå‘¢ï¼Ÿè®©Bå…ˆè®¾ç½®ä¸€ä¸ªå…±äº«å†…å­˜åŒºï¼Œç„¶åAå°†Må†™å…¥åcall kernelï¼Œå†…æ ¸ç›´æ¥åˆ‡æ¢åˆ°Bï¼Œä»å…±äº«å†…å­˜åŒºä¸­recieveæ•°æ®ã€‚\nLinuxä¸­çš„IPCæ¶‰åŠå¾ˆå¤šæ“ä½œï¼šæ•°æ®copyã€syscallã€ctxt switchã€blockingã€wakingï¼Œä½†æ˜¯å¾®å†…æ ¸L4è®¾è®¡ä¸­å¯ä»¥å»æ‰schedulerå¯¼è‡´çš„blockingã€wakingå¼€é”€ï¼Œæ•°æ®æ‹·è´ä¹Ÿå¯ä»¥åˆ†ä¸ºå¯„å­˜åŒºã€å…±äº«å†…å­˜åŒºæ–¹å¼æ¥å‡å°‘å¾€å†…æ ¸ç¼“å†²åŒºçš„ä¸€æ¬¡æ‹·è´ï¼Œç³»ç»Ÿè°ƒç”¨ä¸­åšçš„å·¥ä½œä¹Ÿç®€å•ï¼Œæ•´ä½“å¯ä»¥å»æ‰ä¸å°‘å¼€é”€ã€‚\næœ¬åˆ†æä¸­æµ‹è¯•ç»™å‡ºçš„æ•°æ®ï¼ˆä¸ç¡®å®šä¸€æ¬¡é€šä¿¡ä¼ è¾“äº†å¤šå°‘æ•°æ®ï¼‰ï¼š\n Linux IPCå¼€é”€~4500 cyclesï¼Œçº¦2å¾®ç§’ L4 IPCå¼€é”€~900 cyclesï¼Œçº¦0.33å¾®ç§’  L4 IPCæ€§èƒ½å¤§è‡´æ˜¯Linuxçš„5å€ï¼Œä¹‹å‰æœ‰ä¸ªL4 fast inter-process communicationçš„åˆ†äº«æåˆ°L4æ˜¯L3 IPCæ€§èƒ½çš„20å€ã€‚\nå¾®å†…æ ¸IPCè®¾è®¡åŠä¼˜åŒ–ï¼Œä¸æ­¢ä¸Šé¢è¿™ç‚¹ï¼Œè¯¦ç»†åœ°å¯ä»¥å‚è€ƒï¼šGW AdvOS: Microkernel IPC Design and Optimizationmã€‚\nå®‰å…¨æ€§å®ç° # L4å®‰å…¨æ€§æœºåˆ¶æ˜¯åŸºäºsecure domainsæ¥å®ç°çš„ï¼Œå³tasksã€clansã€chiefsã€‚ä¹‹å‰æœ‰æåˆ°è¿‡L4ä¸­è¿›ç¨‹é€šä¿¡ä¸æ˜¯åŸºäºchannelçš„è€Œæ˜¯åŸºäºIPCè¯·æ±‚çš„ã€‚å¦‚æœæ˜¯åŒä¸€ä¸ªclansä¸­çš„taské€šä¿¡ï¼Œé‚£ä¹ˆç›´æ¥ç”¨æ™®é€šçš„IPCé€šä¿¡å³å¯ï¼Œä½†æ˜¯å¦‚æœæ˜¯ä¸åŒclansä¸­çš„taské€šä¿¡ï¼ŒIPCæ¶ˆæ¯å¿…é¡»è½¬åˆ°å‘é€æ–¹çš„clansçš„chief taskå¤„ç†åï¼ˆchiefå¯ä»¥å¯¹æ¶ˆæ¯åšäº›æ“ä½œï¼‰ï¼Œæ‰èƒ½å‘é€ç»™è¯·æ±‚æ–¹æ‰€åœ¨clansçš„chief taskï¼Œç„¶åchief taskè½¬å‘ç»™ç›®æ ‡taskã€‚\nå¦‚æœæ˜¯è·¨è¶Šæœºå™¨çš„é€šä¿¡ï¼Œå¯ä»¥æŠŠIPCæ¢æˆåè®®TCP/IPã€‚\nps: è‡³äºä¸ºä»€ä¹ˆä¸ç”¨channelsæ¥é€šä¿¡çš„æ–¹å¼ï¼Œç®€å•æä¸€ä¸‹ï¼Œchannelsé€šä¿¡åŠ¿å¿…è¦å¼•å…¥chan senderã€receiverï¼Œsenderã€receiverè¦æ ¹æ®chançŠ¶æ€è¿›è¡ŒåŒæ­¥ï¼Œè¿˜è¦è€ƒè™‘é˜»å¡ã€å”¤é†’é—®é¢˜ï¼Œä¹Ÿä¸å¾—ä¸è€ƒè™‘schedulerçš„é—®é¢˜ï¼Œè¿™é‡Œçš„å¼€é”€å°±ä¸Šæ¥äº†ï¼Œä¼šå¯¼è‡´IPCæ€§èƒ½å¾ˆå·®ã€‚å‰é¢ä¹Ÿæè¿‡äº†ï¼Œå¾®å†…æ ¸IPCè®¾è®¡ä¸­ä¼˜åŒ–æ‰äº†éƒ¨åˆ†æ“ä½œæ¥å‡å°‘å¼€é”€ã€‚\næ€»ç»“ # æœ¬æ–‡ä»‹ç»äº†å¾®å†…æ ¸ã€å®å†…æ ¸çš„åˆ’åˆ†æ–¹æ³•ï¼Œä»‹ç»äº†L4çš„ä¸€äº›èƒŒæ™¯ï¼Œä»¥åŠL4ä¸­IOã€IPCã€å®‰å…¨æ€§çš„å®ç°æ–¹æ³•ã€‚\nå¾®å†…æ ¸ç›¸å¯¹äºå®å†…æ ¸æ¥è¯´ä¹Ÿå…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ï¼Œå¹¶ä¸”ç¬¬ä¸€ä»£å¾®å†…æ ¸IPCæ€§èƒ½å·®çš„é—®é¢˜å·²ç»å¾—åˆ°äº†æ˜æ˜¾æ”¹å–„ã€‚åœ¨å¦‚ä»Šä¸‡ç‰©äº’è”çš„è¶‹åŠ¿ä¸‹ï¼Œå¾®å†…æ ¸å¯¹èµ„æºå ç”¨å°çš„ä¼˜åŠ¿åº”è¯¥ä¹Ÿæ›´é€‚åˆèµ„æºæœ‰é™çš„IoTè®¾å¤‡ã€‚ç°åœ¨åä¸ºä¹Ÿåœ¨å¤§åŠ›æ¨åŠ¨è‡ªå·±é¸¿è’™å¾®å†…æ ¸liteos_açš„å¼€æºååŒï¼Œå¾®å†…æ ¸å°†æ¥è¿˜æ˜¯æœ‰å¾ˆå¤§çš„å¸‚åœºç©ºé—´çš„ã€‚\næœ¬æ–‡å°±ç®—æ˜¯ï¼Œæˆ‘è¿ˆå‡ºäº†è®¤çœŸå­¦ä¹ å¾®å†…æ ¸è®¾è®¡ã€å¼€å‘çš„ç¬¬ä¸€æ­¥å§ã€‚\nå‚è€ƒå†…å®¹ #  L4 and Fast Interprocess Communication, https://www.youtube.com/watch?v=mRr1lCJse_I GW AdvOS: Microkernel IPC Design and Optimizationm, https://www.youtube.com/watch?v=wCoLTnHUwEY  "}),a.add({id:138,href:"/blog/2021-06-15-go-map%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0%E5%8F%8A%E5%BA%94%E7%94%A8%E9%80%89%E5%9E%8B/",title:"go mapè®¾è®¡å®ç°åŠåº”ç”¨é€‰å‹",description:"mapå¤§è‡´å®ç° # buckets \u0026amp; overflow # æœ¬æ–‡ä»‹ç»äº†mapçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªæ¡¶8ä¸ªkvpairsï¼Œè¶…è¿‡äº†å¯ä»¥ç”¨æº¢å‡ºæ¡¶ï¼Œä½†æ˜¯æº¢å‡ºæ¡¶ä¼šé™ä½mapæ€§èƒ½ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºæ–°çš„bucketå°†æ•°æ®è¿åˆ°æ–°bucketé‡Œé¢ã€‚\nhash \u0026amp; top hash table # ä¸€ä¸ªkvpairså­˜å‚¨åœ¨å“ªä¸ªbucketé‡Œé¢å‘¢ï¼Œé¦–å…ˆæ ¹æ®keyè®¡ç®—hashï¼Œç„¶åå¯¹bucketsæ•°é‡å–ä½™ï¼Œå†æ”¾åˆ°å¯¹åº”æ¡¶é‡Œé¢ï¼Œå¦‚æœæœ‰ç©ºä½ç½®å°±æ”¾å…¥ï¼Œæ²¡æœ‰å°±éœ€è¦èµ°å‰é¢æåˆ°çš„æº¢å‡ºæ¡¶çš„é€»è¾‘ã€‚\næ ¹æ®keyè®¡ç®—å‡ºçš„hashé™¤äº†è®¡ç®—keyåˆ†å¸ƒåœ¨å“ªä¸ªæ¡¶ï¼Œè¿˜æœ‰å…¶ä»–ç”¨é€”ï¼Œæ¯ä¸ªæ¡¶é‡Œéƒ½æœ‰ä¸€ä¸ªtop hashæ„æˆçš„æ•°ç»„ï¼Œæ˜¯ä¸ºäº†mapè®¿é—®æ—¶åŠ å¿«æŸ¥è¯¢keyæ‰€åœ¨çš„æ•°ç»„ç´¢å¼•çš„ï¼Œé€šè¿‡å‡å°‘æ¯”è¾ƒkeyçš„è€—æ—¶æ¥åŠ é€Ÿè®¿é—®ã€‚\nmapaccess_faststr, mapaccess_fast64\u0026hellip;è®¿é—®mapä¸­å…ƒç´ æ—¶ï¼Œæ ¹æ®keyç±»å‹ä¸åŒç¼–è¯‘å™¨æ’å…¥ä¸åŒçš„å‡½æ•°è°ƒç”¨ï¼Œå‡½æ•°ååç¼€è¡¨ç¤ºkeyçš„ç±»å‹ï¼Œä¸ºä»€ä¹ˆæœ‰ä¸åŒçš„å‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†æé«˜keyçš„hashè®¡ç®—æ•ˆç‡å’Œæ¯”è¾ƒæ•ˆç‡ã€‚\nload factor # è£…å¡«å› å­ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶mapè£…å¡«çš„å…ƒç´ æ•°é‡ï¼Œå³å…ƒç´ æ•°é‡é™¤ä»¥æ¡¶æ•°é‡ã€‚è£…å¡«å› å­è¿‡å°å®¹æ˜“æµªè´¹å†…å­˜ç©ºé—´ï¼Œè¿‡å¤§å®¹æ˜“å¼•å‘æ›´å¤šçš„ç¢°æ’å†²çªå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\ninitialization \u0026amp;\u0026amp; lazy initialization # mapæå‰åˆå§‹åŒ–å†èµ‹å€¼ï¼Œæ¯”lazyåˆå§‹åŒ–åå†èµ‹å€¼æ•ˆç‡é«˜ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿlazyåˆå§‹åŒ–æ¡¶æ˜¯åé¢åˆ›å»ºçš„æ›´èŠ±æ—¶é—´ã€‚ä½†æ˜¯lazyåˆå§‹åŒ–ç›¸æ¯”è¾ƒè€Œè¨€å®¹æ˜“èŠ‚çœå†…å­˜ã€‚\nkvpairs padding # mapä¸­kvpairsçš„å­˜å‚¨æœ‰è€ƒè™‘å†…å­˜å ç”¨æ–¹é¢çš„ä¼˜åŒ–ï¼Œkeyçš„ç±»å‹å’Œvalueçš„ç±»å‹å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥åœ¨æ•°æ®å¯¹é½è¿‡ç¨‹ä¸­paddingä¼šæµªè´¹ä¸å°‘å†…å­˜ï¼Œæ‰€ä»¥go mapä¸­çš„keyså’Œvaluesæ˜¯åˆ†å¼€å­˜å‚¨çš„ï¼Œå…ˆå­˜å‚¨keyså†å­˜å‚¨valuesã€‚\nå¹¶å‘å®‰å…¨æ£€æµ‹ # mapä¸­çš„å¹¶å‘è¯»å†™é—®é¢˜ï¼Œgoæä¾›äº†å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ£€æŸ¥ï¼š\n  data race detectionï¼šé€šè¿‡é€‰é¡¹-raceæ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨data raceï¼Œå…³äºdata raceæ£€æµ‹çš„é—®é¢˜ï¼Œkavya joshiçš„åˆ†äº«é‡Œæœ‰ä»‹ç»ï¼›\n  concurrent map writesï¼šmapå¯¹åº”çš„æ•°æ®ç»“æ„hmapä¸­æœ‰ä¸ªå­—æ®µflagsæ¥è®°å½•å½“å‰çš„mapæ“ä½œï¼Œæ¯”å¦‚å½“å‰æ‰§è¡Œm[1]=1ï¼Œæ˜¯ä¸€ä¸ªkvçš„èµ‹å€¼ï¼Œå¯¹åº”çš„å‡½æ•°æ˜¯mapassign_fast64ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯delete(m, 1)ï¼Œå¯¹åº”çš„å‡½æ•°æ˜¯mapdelete_fast64ï¼Œè¿™é‡Œçš„mapä¿®æ”¹æ“ä½œå¯¹åº”çš„å‡½æ•°å†…éƒ¨ä¼šå°†hmap.flags^=hashWritingï¼Œå¦‚æœå·²ç»æœ‰ä¸€ä¸ªå†™æ“ä½œåœ¨æ‰§è¡Œï¼Œåé¢åˆæœ‰ä¸€ä¸ªå†™æ“ä½œæ‰§è¡Œï¼Œåé¢çš„å†™æ“ä½œå°±æœ‰å¾ˆå¤§æ¦‚ç‡æ£€æµ‹åˆ°flagsçš„hashWritingä½è¢«è®¾ç½®äº†ï¼Œæ­¤æ—¶å°±ä¼šæŠ›å‡ºé”™è¯¯â€œconcurrent map writesâ€é”™è¯¯ï¼›\n  å…³äºmapä¸ºä»€ä¹ˆä¸ç›´æ¥æä¾›å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬ï¼ŒåŸå› ä¹Ÿç®€å•ã€‚å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬æ˜¯æœ‰åŒæ­¥å¼€é”€çš„ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™å¹¶ä¸éœ€è¦å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬ï¼Œå¦‚æœé»˜è®¤å®ç°æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œæ€§èƒ½ä¸Šå°±è¦å¤§æ‰“æŠ˜æ‰£äº†ã€‚ä¸è€ƒè™‘å¹¶å‘å®‰å…¨é—®é¢˜çš„è¯ï¼Œmapæ¯”sync.Mapè¦å¿«7~10å€ã€‚\nå¹¶å‘å®‰å…¨å®ç° # sync.Mapæ˜¯å¹¶å‘å®‰å…¨çš„å®ç°ï¼Œå®ƒå¯¹æŸäº›åœºæ™¯ä¸‹çš„å¹¶å‘è¯»å†™åšäº†æ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–ï¼š\n \u0026ldquo;The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, (2) when multiple goroutines read, write and overwrite entries for disjoint sets of keys.",content:"mapå¤§è‡´å®ç° # buckets \u0026amp; overflow # æœ¬æ–‡ä»‹ç»äº†mapçš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªæ¡¶8ä¸ªkvpairsï¼Œè¶…è¿‡äº†å¯ä»¥ç”¨æº¢å‡ºæ¡¶ï¼Œä½†æ˜¯æº¢å‡ºæ¡¶ä¼šé™ä½mapæ€§èƒ½ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºæ–°çš„bucketå°†æ•°æ®è¿åˆ°æ–°bucketé‡Œé¢ã€‚\nhash \u0026amp; top hash table # ä¸€ä¸ªkvpairså­˜å‚¨åœ¨å“ªä¸ªbucketé‡Œé¢å‘¢ï¼Œé¦–å…ˆæ ¹æ®keyè®¡ç®—hashï¼Œç„¶åå¯¹bucketsæ•°é‡å–ä½™ï¼Œå†æ”¾åˆ°å¯¹åº”æ¡¶é‡Œé¢ï¼Œå¦‚æœæœ‰ç©ºä½ç½®å°±æ”¾å…¥ï¼Œæ²¡æœ‰å°±éœ€è¦èµ°å‰é¢æåˆ°çš„æº¢å‡ºæ¡¶çš„é€»è¾‘ã€‚\næ ¹æ®keyè®¡ç®—å‡ºçš„hashé™¤äº†è®¡ç®—keyåˆ†å¸ƒåœ¨å“ªä¸ªæ¡¶ï¼Œè¿˜æœ‰å…¶ä»–ç”¨é€”ï¼Œæ¯ä¸ªæ¡¶é‡Œéƒ½æœ‰ä¸€ä¸ªtop hashæ„æˆçš„æ•°ç»„ï¼Œæ˜¯ä¸ºäº†mapè®¿é—®æ—¶åŠ å¿«æŸ¥è¯¢keyæ‰€åœ¨çš„æ•°ç»„ç´¢å¼•çš„ï¼Œé€šè¿‡å‡å°‘æ¯”è¾ƒkeyçš„è€—æ—¶æ¥åŠ é€Ÿè®¿é—®ã€‚\nmapaccess_faststr, mapaccess_fast64\u0026hellip;è®¿é—®mapä¸­å…ƒç´ æ—¶ï¼Œæ ¹æ®keyç±»å‹ä¸åŒç¼–è¯‘å™¨æ’å…¥ä¸åŒçš„å‡½æ•°è°ƒç”¨ï¼Œå‡½æ•°ååç¼€è¡¨ç¤ºkeyçš„ç±»å‹ï¼Œä¸ºä»€ä¹ˆæœ‰ä¸åŒçš„å‡½æ•°å‘¢ï¼Ÿè¿™æ˜¯ä¸ºäº†æé«˜keyçš„hashè®¡ç®—æ•ˆç‡å’Œæ¯”è¾ƒæ•ˆç‡ã€‚\nload factor # è£…å¡«å› å­ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶mapè£…å¡«çš„å…ƒç´ æ•°é‡ï¼Œå³å…ƒç´ æ•°é‡é™¤ä»¥æ¡¶æ•°é‡ã€‚è£…å¡«å› å­è¿‡å°å®¹æ˜“æµªè´¹å†…å­˜ç©ºé—´ï¼Œè¿‡å¤§å®¹æ˜“å¼•å‘æ›´å¤šçš„ç¢°æ’å†²çªå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚\ninitialization \u0026amp;\u0026amp; lazy initialization # mapæå‰åˆå§‹åŒ–å†èµ‹å€¼ï¼Œæ¯”lazyåˆå§‹åŒ–åå†èµ‹å€¼æ•ˆç‡é«˜ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿlazyåˆå§‹åŒ–æ¡¶æ˜¯åé¢åˆ›å»ºçš„æ›´èŠ±æ—¶é—´ã€‚ä½†æ˜¯lazyåˆå§‹åŒ–ç›¸æ¯”è¾ƒè€Œè¨€å®¹æ˜“èŠ‚çœå†…å­˜ã€‚\nkvpairs padding # mapä¸­kvpairsçš„å­˜å‚¨æœ‰è€ƒè™‘å†…å­˜å ç”¨æ–¹é¢çš„ä¼˜åŒ–ï¼Œkeyçš„ç±»å‹å’Œvalueçš„ç±»å‹å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥åœ¨æ•°æ®å¯¹é½è¿‡ç¨‹ä¸­paddingä¼šæµªè´¹ä¸å°‘å†…å­˜ï¼Œæ‰€ä»¥go mapä¸­çš„keyså’Œvaluesæ˜¯åˆ†å¼€å­˜å‚¨çš„ï¼Œå…ˆå­˜å‚¨keyså†å­˜å‚¨valuesã€‚\nå¹¶å‘å®‰å…¨æ£€æµ‹ # mapä¸­çš„å¹¶å‘è¯»å†™é—®é¢˜ï¼Œgoæä¾›äº†å¦‚ä¸‹æ–¹å¼è¿›è¡Œæ£€æŸ¥ï¼š\n  data race detectionï¼šé€šè¿‡é€‰é¡¹-raceæ¥æ£€æµ‹æ˜¯å¦å­˜åœ¨data raceï¼Œå…³äºdata raceæ£€æµ‹çš„é—®é¢˜ï¼Œkavya joshiçš„åˆ†äº«é‡Œæœ‰ä»‹ç»ï¼›\n  concurrent map writesï¼šmapå¯¹åº”çš„æ•°æ®ç»“æ„hmapä¸­æœ‰ä¸ªå­—æ®µflagsæ¥è®°å½•å½“å‰çš„mapæ“ä½œï¼Œæ¯”å¦‚å½“å‰æ‰§è¡Œm[1]=1ï¼Œæ˜¯ä¸€ä¸ªkvçš„èµ‹å€¼ï¼Œå¯¹åº”çš„å‡½æ•°æ˜¯mapassign_fast64ï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯delete(m, 1)ï¼Œå¯¹åº”çš„å‡½æ•°æ˜¯mapdelete_fast64ï¼Œè¿™é‡Œçš„mapä¿®æ”¹æ“ä½œå¯¹åº”çš„å‡½æ•°å†…éƒ¨ä¼šå°†hmap.flags^=hashWritingï¼Œå¦‚æœå·²ç»æœ‰ä¸€ä¸ªå†™æ“ä½œåœ¨æ‰§è¡Œï¼Œåé¢åˆæœ‰ä¸€ä¸ªå†™æ“ä½œæ‰§è¡Œï¼Œåé¢çš„å†™æ“ä½œå°±æœ‰å¾ˆå¤§æ¦‚ç‡æ£€æµ‹åˆ°flagsçš„hashWritingä½è¢«è®¾ç½®äº†ï¼Œæ­¤æ—¶å°±ä¼šæŠ›å‡ºé”™è¯¯â€œconcurrent map writesâ€é”™è¯¯ï¼›\n  å…³äºmapä¸ºä»€ä¹ˆä¸ç›´æ¥æä¾›å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬ï¼ŒåŸå› ä¹Ÿç®€å•ã€‚å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬æ˜¯æœ‰åŒæ­¥å¼€é”€çš„ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™å¹¶ä¸éœ€è¦å¹¶å‘å®‰å…¨çš„ç‰ˆæœ¬ï¼Œå¦‚æœé»˜è®¤å®ç°æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œæ€§èƒ½ä¸Šå°±è¦å¤§æ‰“æŠ˜æ‰£äº†ã€‚ä¸è€ƒè™‘å¹¶å‘å®‰å…¨é—®é¢˜çš„è¯ï¼Œmapæ¯”sync.Mapè¦å¿«7~10å€ã€‚\nå¹¶å‘å®‰å…¨å®ç° # sync.Mapæ˜¯å¹¶å‘å®‰å…¨çš„å®ç°ï¼Œå®ƒå¯¹æŸäº›åœºæ™¯ä¸‹çš„å¹¶å‘è¯»å†™åšäº†æ€§èƒ½æ–¹é¢çš„ä¼˜åŒ–ï¼š\n \u0026ldquo;The Map type is optimized for two common use cases: (1) when the entry for a given key is only ever written once but read many times, as in caches that only grow, (2) when multiple goroutines read, write and overwrite entries for disjoint sets of keys. In these two cases, use of a Map may significantly reduce lock contention compared to a Go map paired with a separate Mutex or RWMutex.\u0026rdquo;\n æ„æ€å°±æ˜¯è¯´ï¼Œsync.Mapå¯¹äºåƒç¼“å­˜ï¼ˆcachesï¼‰è¿™ç§å†™ä¸€æ¬¡ï¼ˆæˆ–æ¬¡æ•°å¾ˆå°‘ï¼‰ä½†æ˜¯è¯»å–æ¬¡æ•°å¤šçš„åœºæ™¯å°±å¾ˆé€‚ç”¨ï¼Œæˆ–è€…å­˜åœ¨å¤šä¸ªgoroutineså¹¶å‘è¯»å†™ï¼Œä½†æ˜¯è¯»å†™çš„keysé›†åˆæ˜¯ä¸ç›¸äº¤çš„ã€‚\nç¬¬ä¸‰æ–¹å®ç°ï¼šShardedMap # sync.Mapå¯¹äºéœ€è¦é¢‘ç¹æ‰§è¡Œåˆ é™¤çš„åœºæ™¯ã€æ›´å¹¿æ³›çš„å†™åœºæ™¯ï¼Œæ²¡æœ‰å¯¹å…¶è¿›è¡Œè¶³å¤Ÿçš„ä¼˜åŒ–ï¼Œè¿™ä¸¤ä¸ªåœºæ™¯å¯ä»¥å‚è€ƒshardedmapå®ç°ã€‚\nBenchmarkåŠé€‰å‹ # å¯¹mapã€sync.Mapã€concurrent_mapï¼ˆshardedmapï¼‰è¿›è¡Œäº†benchmarkï¼Œç»“æœå¦‚ä¸‹ï¼š\nBenchmarkDeleteEmptyMap-8 20000000 86.9 ns/op BenchmarkDeleteEmptySyncMap-8 300000000 5.16 ns/op BenchmarkDeleteEmptyCMap-8 50000000 34.8 ns/op BenchmarkDeleteMap-8 10000000 131 ns/op BenchmarkDeleteSyncMap-8 10000000 135 ns/op BenchmarkDeleteCMap-8 30000000 37.0 ns/op BenchmarkLoadEmptyMap-8 20000000 87.9 ns/op BenchmarkLoadEmptySyncMap-8 300000000 5.03 ns/op BenchmarkLoadEmptyCMap-8 100000000 17.1 ns/op BenchmarkLoadMap-8 20000000 111 ns/op BenchmarkLoadSyncMap-8 100000000 12.8 ns/op BenchmarkLoadCMap-8 100000000 22.5 ns/op BenchmarkSetMap-8 10000000 187 ns/op BenchmarkSetSyncMap-8 5000000 396 ns/op BenchmarkSetCMap-8 20000000 84.9 ns/op  benchmarkç»“æœè¡¨æ˜ï¼š\n map+rwmutexè¿™ç§æ–¹å¼ï¼Œé”ç²’åº¦æ¯”åŠ å¤§ï¼Œå¢åˆ è¯¥æŸ¥æ“ä½œè€—æ—¶ç›¸å¯¹æ¥è¯´éƒ½æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼› sync.Mapè¿™ç§æ–¹å¼ï¼Œå†™å°‘è¯»å¤šçš„æƒ…å†µæ˜¯éå¸¸åˆé€‚çš„ï¼Œæ•ˆç‡æ¯”è¾ƒæ˜æ˜¾ï¼Œä¼˜äºmapã€concurrent_mapï¼› concurrent_mapï¼Œè€ƒè™‘äº†å¹¶å‘å†™æ¯”è¾ƒé¢‘ç¹çš„æƒ…å†µï¼Œç‰¹åˆ«æ˜¯åˆ é™¤ï¼Œå¤šshardæ‰§è¡Œåˆ é™¤æ“ä½œæ—¶æ•ˆç‡éå¸¸æ˜æ˜¾ï¼›  ä¸¾ä¸ªåº”ç”¨é€‰å‹çš„ä¾‹å­ï¼šè¿æ¥æ± æ˜æ˜æ˜¾å±äºè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå»ºè®®ç”¨sync.Mapä»£æ›¿ï¼ˆkeyä¸ºip:portï¼Œvalueä¸ºconnectionï¼‰ï¼Œåé¢transportå¦‚æœè¦å®ç°åŒå·¥æ¨¡å¼çš„æ—¶å€™ï¼Œéœ€è¦ç»´æŠ¤req.seqno\\reqçš„æ˜ å°„å…³ç³»ï¼Œå¢åˆ é¢‘ç¹ï¼Œå¯ä»¥è€ƒè™‘ç”¨concurrent_mapï¼ˆkeyä¸ºreq.seqnoï¼Œvalueä¸ºreqï¼‰ã€‚\nå‚è€ƒå†…å®¹ #  https://medium.com/a-journey-with-go/go-map-design-by-example-part-i-3f78a064a352?source=\u0026mdash;\u0026mdash;\u0026mdash;45\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026ndash; https://medium.com/a-journey-with-go/go-map-design-by-code-part-ii-50d111557c08 https://medium.com/a-journey-with-go/go-concurrency-access-with-maps-part-iii-8c0a0e4eb27e https://github.com/orcaman/concurrent-map/blob/master/concurrent_map.go https://golangexample.com/a-simple-and-efficient-thread-safe-sharded-hashmap-for-go/  "}),a.add({id:139,href:"/tags/map/",title:"map",description:"",content:""}),a.add({id:140,href:"/tags/shardedmap/",title:"ShardedMap",description:"",content:""}),a.add({id:141,href:"/tags/sync.map/",title:"sync.Map",description:"",content:""}),a.add({id:142,href:"/tags/runtime/",title:"runtime",description:"",content:""}),a.add({id:143,href:"/tags/syscall/",title:"syscall",description:"",content:""}),a.add({id:144,href:"/blog/2021-06-06-how-go-handles-syscall/",title:"syscallï¼šhow does go runtime handles syscall",description:"1 How go runtime handle syscall ? # æœ€è¿‘é‡åˆ°ä¸ªçº¿ä¸ŠæœåŠ¡é¢‘ç¹é™·å…¥ç³»ç»Ÿè°ƒç”¨å¯¼è‡´goè¿è¡Œæ—¶åˆ›å»ºäº†å¤§é‡çº¿ç¨‹ï¼Œå½±å“åˆ°äº†æœåŠ¡è´¨é‡ï¼Œå®šä½ã€è§£å†³é—®é¢˜ä¹‹åï¼Œå¸Œæœ›èƒ½è¿›ä¸€æ­¥æ¢ç©¶goè¿è¡Œæ—¶å¤„ç†ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿åŠ æ·±ç†è§£ã€‚å‚è€ƒäº†ä¸å°‘ç½‘å‹çš„åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯çŸ¥ä¹Golang Inernalä¸“æ ï¼Œç»“åˆä¸ªäººçš„å­¦ä¹ ç†è§£åœ¨æ­¤æ•´ç†è®°å½•ä¸€ä¸‹ï¼Œä¸å¤§å®¶åˆ†äº«ã€‚\n1.1 å‰è¨€ # åœ¨å¼€å§‹ç»“åˆæºç è¿›è¡Œåˆ†æä¹‹å‰ï¼Œå…ˆåšä¸‹ç®€å•çš„ä»‹ç»ï¼Œæ–¹ä¾¿å…ˆä»æ•´ä½“ä¸ŠæŠŠæ¡goå¯¹ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†è¿‡ç¨‹ï¼Œç„¶åä»ç¬¬äºŒéƒ¨åˆ†å¼€å§‹ï¼Œå†ç»“åˆæºç ä»‹ç»å…·ä½“çš„ç»†èŠ‚ã€‚\nç³»ç»Ÿè°ƒç”¨åˆ†ä¸ºé˜»å¡ç³»ç»Ÿè°ƒç”¨ã€éé˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼Œgoé‡Œé¢å¯¹è¿™äº›ç³»ç»Ÿè°ƒç”¨æœ‰å½’ç±»æ•´ç†ï¼Œè¯¦è§æºæ–‡ä»¶ï¼š/src/syscall/syscall_linux_amd64.goã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œsyså¼€å¤´çš„è¡¨ç¤ºçš„æ˜¯é˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šè°ƒç”¨Syscallï¼Œä»¥sysnbå¼€å¤´çš„æ˜¯éé˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šè°ƒç”¨RawSyscallï¼Œå…³äºSyscallå’ŒRawSyscallçš„åŒºåˆ«ä¸‹é¢æ•´ç†ã€‚é˜»å¡å‹çš„ç³»ç»Ÿè°ƒç”¨æœ¬èº«ä¼šé˜»å¡çº¿ç¨‹ï¼Œä¸ºäº†é¿å…çº¿ç¨‹é˜»å¡å¯¼è‡´åç¨‹ä¸å¯è°ƒåº¦ï¼Œgolangè¿è¡Œæ—¶è¦æ„ŸçŸ¥è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨å¹¶åšç‰¹æ®Šå¤„ç†ï¼Œéé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ç›´æ¥è°ƒå³å¯ï¼Œä¸éœ€è¦golangè¿è¡Œæ—¶å‚ä¸ã€‚ Syscallå®šä¹‰åœ¨asm_linux_amd64.sé‡Œé¢ï¼Œä»£ç ä¸­æœ‰runtime.entersyscall(SB)å’Œruntime.exitsyscall(SB)å‡½æ•°è°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯ä¸golangè¿è¡Œæ—¶è¿›è¡Œäº¤äº’çš„ï¼Œç”¨äºé€šçŸ¥golangè¿è¡Œæ—¶æˆ‘å³å°†å‘èµ·æˆ–è€…é€€å‡ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚\nå¯¹äºä¼šå¯¼è‡´é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œéƒ½è¦é€šè¿‡Syscallæ¥è°ƒç”¨æ¥é€šçŸ¥golangè¿è¡Œæ—¶ï¼Œä»¥ä¾¿golangè¿è¡Œæ—¶åšå¤„ç†ï¼Œå¦‚åˆ›å»ºæ–°çš„ç‰©ç†çº¿ç¨‹è°ƒåº¦å™¨å…¶å®ƒçš„goroutineï¼Œé¿å…æ•´ä¸ªè¿›ç¨‹æ— çº¿ç¨‹å¯è°ƒåº¦è€Œæœ€ç»ˆè¢«sysmonæ€æ­»è¿›ç¨‹ã€‚ å¯¹äºæŸäº›éé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°±ä¸å¿…å†ä¸golangè¿è¡Œæ—¶äº¤äº’äº†ï¼Œç›´æ¥è°ƒç”¨å°±å¯ä»¥ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸¤æ¬¡ä¸golangè¿è¡Œæ—¶äº¤äº’çš„å‡½æ•°è°ƒç”¨å¼€é”€ï¼Œè¿™é‡Œå°±æ‰çš„æ˜¯RawSyscallï¼š ç½‘ç»œioæ“ä½œæœ¬æ¥ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯å› ä¸ºsocket fdä¼šè¢«è®¾ç½®ä¸ºnon-blockingï¼Œç³»ç»Ÿè°ƒç”¨è™½ç„¶è¿˜æ˜¯é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯å·²ç»ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹äº†ï¼Œæ‰€ä»¥ä¹Ÿæ— æ‰€è°“äº†ã€‚\næœ‰ä¸ªè„šæœ¬mksyscall.plæ ¹æ®syscall_linux_amd64.goé‡Œé¢å®šä¹‰çš„ç³»é€šè°ƒç”¨åˆ—è¡¨ï¼Œå°±æ˜¯ç¬¬ä¸€å¼ å›¾é‚£äº›å¸¦æ³¨é‡Šçš„éƒ¨åˆ†ï¼Œè¿™ä¸ªplè„šæœ¬ä¼šè´Ÿè´£ç”Ÿæˆä¸ä¹‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œç”Ÿæˆåœ¨syscall/zsyscall_linux_amd64.goé‡Œé¢ã€‚å¯ä»¥æ‰¾å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„æ¥çœ‹ä¸‹ç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼š\næ¯”å¦‚sendfileæ˜¯é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼š æ¯”å¦‚settimeofdayæ˜¯éé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼š epollç›¸å…³çš„epollwaitä¹Ÿæ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯ç½‘ç»œsocket fdåœ¨goé‡Œé¢éƒ½ç»Ÿä¸€è®¾ç½®ä¸ºäº†nonblocking fdå¤„ç†äº†ï¼Œå› æ­¤å¹¶ä¸ä¼šé˜»å¡ã€‚ 1.2 å¼€å§‹åˆ†ææºç  # åœ¨è®²è¿°ç³»ç»Ÿè°ƒç”¨å‘ç”Ÿçš„åç¨‹è°ƒåº¦ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹goæ˜¯å¦‚ä½•è¿›å…¥ç³»ç»Ÿè°ƒç”¨çš„ï¼Œç†è§£äº†è¿™ä¸ªè®©æˆ‘ä»¬ä¸ä¼šå¯¹åé¢æ‰€è¯´çš„ä¸€äº›ä¸œè¥¿æ„Ÿåˆ°å¾ˆé™Œç”Ÿã€‚\ngolangå¯¹æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ä½œäº†å°è£…ï¼Œæä¾›äº†syscallè¿™æ ·çš„åº“è®©æˆ‘ä»¬æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚ï¼ŒReadç³»ç»Ÿè°ƒç”¨å®ç°å¦‚ä¸‹ï¼š\nfunc Read(fd int, p []byte) (n int, err error) { n, err = read(fd, p) if raceenabled { if n \u0026gt; 0 { ...... } ...... } return } // æœ€ç»ˆå°è£…äº†Syscall func read(fd int, p []byte) (n int, err error) { var _p0 unsafe.",content:"1 How go runtime handle syscall ? # æœ€è¿‘é‡åˆ°ä¸ªçº¿ä¸ŠæœåŠ¡é¢‘ç¹é™·å…¥ç³»ç»Ÿè°ƒç”¨å¯¼è‡´goè¿è¡Œæ—¶åˆ›å»ºäº†å¤§é‡çº¿ç¨‹ï¼Œå½±å“åˆ°äº†æœåŠ¡è´¨é‡ï¼Œå®šä½ã€è§£å†³é—®é¢˜ä¹‹åï¼Œå¸Œæœ›èƒ½è¿›ä¸€æ­¥æ¢ç©¶goè¿è¡Œæ—¶å¤„ç†ç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿åŠ æ·±ç†è§£ã€‚å‚è€ƒäº†ä¸å°‘ç½‘å‹çš„åˆ†äº«ï¼Œç‰¹åˆ«æ˜¯çŸ¥ä¹Golang Inernalä¸“æ ï¼Œç»“åˆä¸ªäººçš„å­¦ä¹ ç†è§£åœ¨æ­¤æ•´ç†è®°å½•ä¸€ä¸‹ï¼Œä¸å¤§å®¶åˆ†äº«ã€‚\n1.1 å‰è¨€ # åœ¨å¼€å§‹ç»“åˆæºç è¿›è¡Œåˆ†æä¹‹å‰ï¼Œå…ˆåšä¸‹ç®€å•çš„ä»‹ç»ï¼Œæ–¹ä¾¿å…ˆä»æ•´ä½“ä¸ŠæŠŠæ¡goå¯¹ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†è¿‡ç¨‹ï¼Œç„¶åä»ç¬¬äºŒéƒ¨åˆ†å¼€å§‹ï¼Œå†ç»“åˆæºç ä»‹ç»å…·ä½“çš„ç»†èŠ‚ã€‚\nç³»ç»Ÿè°ƒç”¨åˆ†ä¸ºé˜»å¡ç³»ç»Ÿè°ƒç”¨ã€éé˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼Œgoé‡Œé¢å¯¹è¿™äº›ç³»ç»Ÿè°ƒç”¨æœ‰å½’ç±»æ•´ç†ï¼Œè¯¦è§æºæ–‡ä»¶ï¼š/src/syscall/syscall_linux_amd64.goã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œsyså¼€å¤´çš„è¡¨ç¤ºçš„æ˜¯é˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šè°ƒç”¨Syscallï¼Œä»¥sysnbå¼€å¤´çš„æ˜¯éé˜»å¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¼šè°ƒç”¨RawSyscallï¼Œå…³äºSyscallå’ŒRawSyscallçš„åŒºåˆ«ä¸‹é¢æ•´ç†ã€‚é˜»å¡å‹çš„ç³»ç»Ÿè°ƒç”¨æœ¬èº«ä¼šé˜»å¡çº¿ç¨‹ï¼Œä¸ºäº†é¿å…çº¿ç¨‹é˜»å¡å¯¼è‡´åç¨‹ä¸å¯è°ƒåº¦ï¼Œgolangè¿è¡Œæ—¶è¦æ„ŸçŸ¥è¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨å¹¶åšç‰¹æ®Šå¤„ç†ï¼Œéé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ç›´æ¥è°ƒå³å¯ï¼Œä¸éœ€è¦golangè¿è¡Œæ—¶å‚ä¸ã€‚ Syscallå®šä¹‰åœ¨asm_linux_amd64.sé‡Œé¢ï¼Œä»£ç ä¸­æœ‰runtime.entersyscall(SB)å’Œruntime.exitsyscall(SB)å‡½æ•°è°ƒç”¨ï¼Œè¿™ä¸ªæ˜¯ä¸golangè¿è¡Œæ—¶è¿›è¡Œäº¤äº’çš„ï¼Œç”¨äºé€šçŸ¥golangè¿è¡Œæ—¶æˆ‘å³å°†å‘èµ·æˆ–è€…é€€å‡ºä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚\nå¯¹äºä¼šå¯¼è‡´é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œéƒ½è¦é€šè¿‡Syscallæ¥è°ƒç”¨æ¥é€šçŸ¥golangè¿è¡Œæ—¶ï¼Œä»¥ä¾¿golangè¿è¡Œæ—¶åšå¤„ç†ï¼Œå¦‚åˆ›å»ºæ–°çš„ç‰©ç†çº¿ç¨‹è°ƒåº¦å™¨å…¶å®ƒçš„goroutineï¼Œé¿å…æ•´ä¸ªè¿›ç¨‹æ— çº¿ç¨‹å¯è°ƒåº¦è€Œæœ€ç»ˆè¢«sysmonæ€æ­»è¿›ç¨‹ã€‚ å¯¹äºæŸäº›éé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå°±ä¸å¿…å†ä¸golangè¿è¡Œæ—¶äº¤äº’äº†ï¼Œç›´æ¥è°ƒç”¨å°±å¯ä»¥ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸¤æ¬¡ä¸golangè¿è¡Œæ—¶äº¤äº’çš„å‡½æ•°è°ƒç”¨å¼€é”€ï¼Œè¿™é‡Œå°±æ‰çš„æ˜¯RawSyscallï¼š ç½‘ç»œioæ“ä½œæœ¬æ¥ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯å› ä¸ºsocket fdä¼šè¢«è®¾ç½®ä¸ºnon-blockingï¼Œç³»ç»Ÿè°ƒç”¨è™½ç„¶è¿˜æ˜¯é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯å·²ç»ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹äº†ï¼Œæ‰€ä»¥ä¹Ÿæ— æ‰€è°“äº†ã€‚\næœ‰ä¸ªè„šæœ¬mksyscall.plæ ¹æ®syscall_linux_amd64.goé‡Œé¢å®šä¹‰çš„ç³»é€šè°ƒç”¨åˆ—è¡¨ï¼Œå°±æ˜¯ç¬¬ä¸€å¼ å›¾é‚£äº›å¸¦æ³¨é‡Šçš„éƒ¨åˆ†ï¼Œè¿™ä¸ªplè„šæœ¬ä¼šè´Ÿè´£ç”Ÿæˆä¸ä¹‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œç”Ÿæˆåœ¨syscall/zsyscall_linux_amd64.goé‡Œé¢ã€‚å¯ä»¥æ‰¾å‡ ä¸ªæœ‰ä»£è¡¨æ€§çš„æ¥çœ‹ä¸‹ç”Ÿæˆçš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼š\næ¯”å¦‚sendfileæ˜¯é˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼š æ¯”å¦‚settimeofdayæ˜¯éé˜»å¡çš„ç³»ç»Ÿè°ƒç”¨ï¼š epollç›¸å…³çš„epollwaitä¹Ÿæ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯ç½‘ç»œsocket fdåœ¨goé‡Œé¢éƒ½ç»Ÿä¸€è®¾ç½®ä¸ºäº†nonblocking fdå¤„ç†äº†ï¼Œå› æ­¤å¹¶ä¸ä¼šé˜»å¡ã€‚ 1.2 å¼€å§‹åˆ†ææºç  # åœ¨è®²è¿°ç³»ç»Ÿè°ƒç”¨å‘ç”Ÿçš„åç¨‹è°ƒåº¦ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹goæ˜¯å¦‚ä½•è¿›å…¥ç³»ç»Ÿè°ƒç”¨çš„ï¼Œç†è§£äº†è¿™ä¸ªè®©æˆ‘ä»¬ä¸ä¼šå¯¹åé¢æ‰€è¯´çš„ä¸€äº›ä¸œè¥¿æ„Ÿåˆ°å¾ˆé™Œç”Ÿã€‚\ngolangå¯¹æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ä½œäº†å°è£…ï¼Œæä¾›äº†syscallè¿™æ ·çš„åº“è®©æˆ‘ä»¬æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚ï¼ŒReadç³»ç»Ÿè°ƒç”¨å®ç°å¦‚ä¸‹ï¼š\nfunc Read(fd int, p []byte) (n int, err error) { n, err = read(fd, p) if raceenabled { if n \u0026gt; 0 { ...... } ...... } return } // æœ€ç»ˆå°è£…äº†Syscall func read(fd int, p []byte) (n int, err error) { var _p0 unsafe.Pointer if len(p) \u0026gt; 0 { _p0 = unsafe.Pointer(\u0026amp;p[0]) } else { _p0 = unsafe.Pointer(\u0026amp;_zero) } r0, _, e1 := Syscall(SYS_READ, uintptr(fd), uintptr(_p0), uintptr(len(p))) n = int(r0) if e1 != 0 { err = e1 } return } // æˆ‘ä»¬åªå…³å¿ƒè¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶è°ƒç”¨çš„runtimeÂ·entersyscall // å’Œé€€å‡ºæ—¶è°ƒç”¨çš„runtimeÂ·exitsyscall TEXT Â·Syscall(SB),NOSPLIT,$0-56 CALL runtimeÂ·entersyscall(SB) MOVQ 16(SP), DI MOVQ 24(SP), SI MOVQ 32(SP), DX MOVQ $0, R10 s MOVQ $0, R8 MOVQ $0, R9 MOVQ 8(SP), AX // syscall entry SYSCALL CMPQ AX, $0xfffffffffffff001 JLS ok MOVQ $-1, 40(SP) // r1 MOVQ $0, 48(SP) // r2 NEGQ AX MOVQ AX, 56(SP) // errno CALL runtimeÂ·exitsyscall(SB) RET  æˆ‘ä»¬å¹¶ä¸å…³å¿ƒç³»ç»Ÿè°ƒç”¨åˆ°åº•æ€ä¹ˆå®ç°ã€‚æˆ‘ä»¬åªå…³å¿ƒç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ä¸è°ƒåº¦å™¨ç›¸å…³å†…å®¹ï¼Œå› ä¸ºGolangè‡ªå·±æ¥ç®¡ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒåº¦å™¨ä¾¿å¯ä»¥åœ¨è¿›å‡ºç³»ç»Ÿè°ƒç”¨æ—¶åšä¸€äº›ä½ æ‰€ä¸æ˜ç™½çš„ä¼˜åŒ–ï¼Œè¿™é‡Œæˆ‘è¦å¸¦ä½ å¼„æ¸…æ¥šè°ƒåº¦å™¨æ€ä¹ˆåšä¼˜åŒ–çš„ã€‚\n1.3 è¿›å…¥ç³»ç»Ÿè°ƒç”¨å‰ # æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„è¿‡ç¨‹ã€‚ä¸€æ—¦Pä¸­çš„æŸä¸ªGè¿›å…¥ç³»ç»Ÿè°ƒç”¨çŠ¶æ€è€Œé˜»å¡äº†è¯¥På†…çš„å…¶ä»–åç¨‹ã€‚æ­¤æ—¶è°ƒåº¦å™¨å¿…é¡»å¾—åšç‚¹ä»€ä¹ˆå§ï¼Œè¿™å°±æ˜¯è°ƒåº¦å™¨åœ¨è¿›å…¥ç³»ç»Ÿè°ƒç”¨å‰call runtimeÂ·entersyscallç›®çš„æ‰€åœ¨ã€‚\n å…³äºè°ƒåº¦ç²˜æ€§ï¼ˆäº²å’Œæ€§ï¼‰é—®é¢˜ï¼Œè¿™é‡Œæä¸€å˜´ï¼š\nä¸‹æ–‡æè¿°çš„æ—¶å€™æœ‰ç‚¹åæ•…äº‹æ€§ï¼Œå…³äºGMPä¸‰è€…ä¹‹é—´çš„å…³ç³»ï¼Œè¯·åŠ¡å¿…æ³¨æ„goroutineã€threadè°ƒåº¦äº²å’Œæ€§é—®é¢˜ï¼Œè¿™æ ·å°±æ¯”è¾ƒå®¹æ˜“ç†è§£ä¸ºä»€ä¹ˆGæƒ³å†åŸæ¥çš„Mä¸Šæ‰§è¡Œï¼Œè€ŒMåˆæƒ³åœ¨åŸæ¥çš„Pä¸Šæ‰§è¡Œã€‚\npä¸Šæœ‰mcacheã€gFreeï¼Œmä¸Šæœ‰tlsï¼Œmè¿è¡Œgç”³è¯·å°äº32Kçš„å†…å­˜æ˜¯ä»p.mcacheä¸­åˆ†é…ï¼Œç»´æŒgã€mã€pä¹‹é—´çš„å…³ç³»æœ‰åŠ©äºå¤ç”¨ä¹‹å‰pä¸Šå»ºç«‹çš„mcacheï¼Œä¹Ÿæœ‰åŠ©äºmåˆ›å»ºæ–°çš„gæ—¶å¤ç”¨pä¸Šä¹‹å‰ç»´æŠ¤çš„ç©ºé—²gåˆ—è¡¨ã€‚\nå½“ç„¶å¯èƒ½è¿˜æœ‰ä¸€äº›å…¶ä»–çš„åŸå› ï¼Œè¿™é‡Œæš‚æ—¶å…ˆä¸å±•å¼€äº† seeï¼šhttps://sourcegraph.com/github.com/golang/go/-/blob/src/runtime/runtime2.go#L613ã€‚\n OKï¼Œæˆ‘ä»¬ç»§ç»­è®²è¿è¡Œæ—¶å¯¹ç³»ç»Ÿè°ƒç”¨çš„å¤„ç†ã€‚\nvoid Â·entersyscall(int32 dummy) { runtimeÂ·reentersyscall((uintptr)runtimeÂ·getcallerpc(\u0026amp;dummy), runtimeÂ·getcallersp(\u0026amp;dummy)); } void runtimeÂ·reentersyscall(uintptr pc, uintptr sp) { void (*fn)(void); // ä¸ºä»€ä¹ˆg-\u0026gt;m-\u0026gt;locks++? g-\u0026gt;m-\u0026gt;locks++; g-\u0026gt;stackguard0 = StackPreempt; g-\u0026gt;throwsplit = 1; // Leave SP around for GC and traceback. // save()åˆ°åº•åœ¨saveä»€ä¹ˆï¼Ÿ save(pc, sp); g-\u0026gt;syscallsp = sp; g-\u0026gt;syscallpc = pc; runtimeÂ·casgstatus(g, Grunning, Gsyscall); // è¿™äº›å †æ ˆä¹‹é—´åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ if(g-\u0026gt;syscallsp \u0026lt; g-\u0026gt;stack.lo || g-\u0026gt;stack.hi \u0026lt; g-\u0026gt;syscallsp) { fn = entersyscall_bad; runtimeÂ·onM(\u0026amp;fn); } // è¿™ä¸ªè¿˜ä¸çŸ¥é“æ˜¯å•¥æ„æ€ if(runtimeÂ·atomicload(\u0026amp;runtimeÂ·sched.sysmonwait)) { fn = entersyscall_sysmon; runtimeÂ·onM(\u0026amp;fn); save(pc, sp); } // è¿™é‡Œå¾ˆå…³é”®ï¼šPçš„Må·²ç»é™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œäºæ˜¯På¿ç—›æ”¾å¼ƒè¯¥M // ä½†æ˜¯è¯·æ³¨æ„ï¼šæ­¤æ—¶Mè¿˜æŒ‡å‘Pï¼Œåœ¨Mä»ç³»ç»Ÿè°ƒç”¨è¿”å›åè¿˜èƒ½æ‰¾åˆ°P g-\u0026gt;m-\u0026gt;mcache = nil; g-\u0026gt;m-\u0026gt;p-\u0026gt;m = nil; // Pçš„çŠ¶æ€å˜ä¸ºPsyscall runtimeÂ·atomicstore(\u0026amp;g-\u0026gt;m-\u0026gt;p-\u0026gt;status, Psyscall); if(runtimeÂ·sched.gcwaiting) { fn = entersyscall_gcwait; runtimeÂ·onM(\u0026amp;fn); save(pc, sp); } g-\u0026gt;stackguard0 = StackPreempt; g-\u0026gt;m-\u0026gt;locks--; }  ä¸Šé¢ä¸è°ƒåº¦å™¨ç›¸å…³çš„å†…å®¹å…¶å®å°±æ˜¯å°†Mä»På‰¥ç¦»å‡ºå»ï¼Œå‘Šè¯‰è°ƒåº¦å™¨ï¼Œæˆ‘å·²ç»æ”¾å¼ƒMäº†ï¼Œæˆ‘ä¸èƒ½é¥¿ç€æˆ‘çš„å­©å­ä»¬ï¼ˆGï¼‰ã€‚ä½†æ˜¯Må†…å¿ƒè¿˜æ˜¯è®°ç€Pçš„ï¼Œåœ¨ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼ŒMè¿˜å°½é‡æ‰¾å›åŸæ¥çš„Pï¼Œè‡³äºPæ˜¯ä¸æ˜¯å¦ç»“æ–°æ¬¢å°±å¾—çœ‹æƒ…å†µäº†ã€‚\næ³¨æ„è¿™æ—¶å€™Pæ”¾å¼ƒäº†å‰å¦»Mï¼Œä½†æ˜¯è¿˜æ²¡æœ‰ç»™å­©å­ä»¬æ‰¾åå¦ˆï¼ˆMï¼‰ï¼Œåªæ˜¯å°†Pçš„çŠ¶æ€æ ‡è®°ä¸ºPSyscallï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä»¥åŠæ€ä¹ˆæ ·ç»™å­©å­ä»¬æ‰¾åå¦ˆå‘¢ï¼Ÿæˆ‘ä»¬åœ¨åé¢è¯¦ç»†é˜è¿°ã€‚\n1.4 ä»ç³»ç»Ÿè°ƒç”¨è¿”å›å # ä»ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œä¹Ÿè¦å‘Šè¯‰è°ƒåº¦å™¨ï¼Œå› ä¸ºéœ€è¦è°ƒåº¦å™¨åšä¸€äº›äº‹æƒ…ï¼Œæ ¹æ®å‰é¢ç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼Œå…·ä½“å®ç°æ˜¯ï¼š\nvoid Â·exitsyscall(int32 dummy) { void (*fn)(G*); // è¿™ä¸ªgåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ g-\u0026gt;m-\u0026gt;locks++; // see comment in entersyscall if(runtimeÂ·getcallersp(\u0026amp;dummy) \u0026gt; g-\u0026gt;syscallsp) runtimeÂ·throw(\u0026quot;exitsyscall: syscall frame is no longer valid\u0026quot;); g-\u0026gt;waitsince = 0; // åˆ¤æ–­èƒ½å¦å¿«é€Ÿæ‰¾åˆ°å½’å± if(exitsyscallfast()) { g-\u0026gt;m-\u0026gt;p-\u0026gt;syscalltick++; // gçš„çŠ¶æ€ä»syscallå˜æˆrunningï¼Œç»§ç»­æ¬¢å¿«åœ°è·‘ç€ runtimeÂ·casgstatus(g, Gsyscall, Grunning); g-\u0026gt;syscallsp = (uintptr)nil; g-\u0026gt;m-\u0026gt;locks--; if(g-\u0026gt;preempt) { g-\u0026gt;stackguard0 = StackPreempt; } else { g-\u0026gt;stackguard0 = g-\u0026gt;stack.lo + StackGuard; } g-\u0026gt;throwsplit = 0; return; } g-\u0026gt;m-\u0026gt;locks--; // Call the scheduler. // å¦‚æœMå›æ¥å‘ç°På·²ç»æœ‰åˆ«äººæœåŠ¡äº†ï¼Œé‚£åªèƒ½å°†è‡ªå·±æŒ‚èµ· // ç­‰ç€æœåŠ¡åˆ«äººã€‚ fn = exitsyscall0; runtimeÂ·mcall(\u0026amp;fn); ...... } static bool exitsyscallfast(void) { void (*fn)(void); if(runtimeÂ·sched.stopwait) { g-\u0026gt;m-\u0026gt;p = nil; return false; } // å¦‚æœä¹‹å‰é™„å±çš„På°šæœªè¢«å…¶ä»–M,å°è¯•ç»‘å®šè¯¥P if(g-\u0026gt;m-\u0026gt;p \u0026amp;\u0026amp; g-\u0026gt;m-\u0026gt;p-\u0026gt;status == Psyscall \u0026amp;\u0026amp; runtimeÂ·cas(\u0026amp;g-\u0026gt;m-\u0026gt;p-\u0026gt;status, Psyscall, Prunning)) { g-\u0026gt;m-\u0026gt;mcache = g-\u0026gt;m-\u0026gt;p-\u0026gt;mcache; g-\u0026gt;m-\u0026gt;p-\u0026gt;m = g-\u0026gt;m; return true; } // Try to get any other idle P. // å¦åˆ™ä»ç©ºé—²Påˆ—è¡¨ä¸­éšä¾¿æä¸€ä¸ªå‡ºæ¥ g-\u0026gt;m-\u0026gt;p = nil; if(runtimeÂ·sched.pidle) { fn = exitsyscallfast_pidle; runtimeÂ·onM(\u0026amp;fn); if(g-\u0026gt;m-\u0026gt;scalararg[0]) { g-\u0026gt;m-\u0026gt;scalararg[0] = 0; return true; } } return false; }  Gä»ç³»ç»Ÿè°ƒç”¨è¿”å›çš„è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯å¤±è¶³å¦‡å¥³æ‰¾ç”·äººçš„é€»è¾‘ï¼š\n é¦–å…ˆçœ‹çœ‹èƒ½å¦å›åˆ°å½“åˆçˆ±äºº(P)çš„æ€€æŠ±ï¼šæ‰¾åˆ°å½“åˆè¢«æˆ‘æŠ›å¼ƒçš„ç”·äººï¼Œæˆ‘è¿™é‡Œè¿˜å­˜ç€å®ƒçš„åç‰‡(m-\u0026gt;p)ï¼Œå®¶åº­ä½å€ä»€ä¹ˆçš„æˆ‘éƒ½è¿˜çŸ¥é“ï¼› å¦‚æœçˆ±äººå—ä¸äº†å¯‚å¯å’ŒæŠšå…»å­©å­çš„å‹åŠ›å·²ç»å˜èŠ‚ï¼ˆPçš„çŠ¶æ€ä¸å†æ˜¯Psyscallï¼‰ï¼Œé‚£æˆ‘å°±éšä¾¿æ‰¾ä¸ªå•èº«å¾…è§£æ•‘ç”·äººä»äº†ä¹Ÿè¡Œï¼› å¦‚æœä¸Šé¢çš„1ã€2éƒ½æ‰¾ä¸åˆ°ï¼Œé‚£ä¹Ÿæ²¡åŠæ³•ï¼Œç”·äººéƒ½æ­»ç»äº†ï¼Œè€å¨˜åªå¥½å¦æƒ³ä»–æ³•ã€‚  ä»¥ä¸Šè¿‡ç¨‹1å’Œ2å…¶å®å°±æ˜¯exitsyscallfast()çš„ä¸»è¦æµç¨‹ï¼Œç”¨æ€€å­•äº†çš„å¤±è¶³å¦‡å¥³æ‰¾ç”·äººå†åˆé€‚ä¸è¿‡ã€‚ ä¸€ä¸ªå¥³äººç”±äºå¹´è½»ä¸æ‡‚äº‹å¤±è¶³ï¼ŒæŠ›å®¶å¼ƒå­ï¼ˆå®¶æ˜¯Pï¼Œå­æ˜¯Pçš„Gï¼‰ã€‚å½“æµªå­å›å¤´åï¼Œæ„æ¬²å¯»å›ä»å‰çš„å¤«å›ï¼Œåªèƒ½æœ‰ä¸¤ç§å¯èƒ½ï¼š\n ç­‰äº†å¾ˆä¹…å·²ç„¶å¿ƒç°æ„å†·çš„å¤«å›åœ¨å®¶äººçš„å®‰æ’ä¸‹å¦å¨¶ä»–äººï¼› ç—´æƒ…çš„å¤«å›å·²ç„¶å’Œå—·å—·å¾…å“ºçš„å­©å­ä»¬ä¾ç„¶åœ¨ç­‰å¾…å¥¹çš„å½’å›ã€‚  å½“ç„¶ç¬¬äºŒç§çš„ç»“å±€æ¯”è¾ƒåœ†æ»¡ï¼Œè¿™ä¸ªå¥³äººä»æ­¤æ­»å¿ƒå¡Œåœ°å®ˆç€è¿™ä¸ªå®¶ï¼Œäºæ˜¯p-\u0026gt;måˆå›æ¥äº†ï¼Œå­©å­ä»¬(g)åˆå¯ä»¥ç»§ç»­æ´»ä¸‹å»äº†ã€‚ ç¬¬ä¸€ç§å°±æ¯”è¾ƒéš¾åŠäº†ï¼Œå¥³äººï¼ˆmï¼‰å¿ƒç°æ„å†·ï¼Œå°†äº§ä¸‹çš„å„¿å­ï¼ˆé™·å…¥ç³»ç»Ÿè°ƒç”¨çš„gï¼‰äº¤äºä»–äººï¼ˆå…¨å±€gçš„è¿è¡Œé˜Ÿåˆ—ï¼‰æŠšå…»ï¼Œè¿œèµ°ä»–ä¹¡ï¼Œä»æ­¤æ¥æ”¶å‘½è¿çš„å®‰æ’ï¼ˆå‚ä¸è°ƒåº¦ï¼Œä»¥åå¯èƒ½æœåŠ¡äºåˆ«çš„pï¼‰ã€‚ å¯¹äºç¬¬äºŒç§å¯èƒ½æ€§ï¼Œåªèƒ½è¯´å¥³äººçš„å‘½è¿æ¯”è¾ƒæ‚²æƒ¨äº†ï¼š\nstatic void exitsyscall0(G *gp) { P *p; runtimeÂ·casgstatus(gp, Gsyscall, Grunnable); dropg(); runtimeÂ·lock(\u0026amp;runtimeÂ·sched.lock); // è¿™é‡ŒMå†æ¬¡å°è¯•ä¸ºè‡ªå·±æ‰¾ä¸ªå½’å®¿P p = pidleget(); // å¦‚æœæ²¡æ‰¾åˆ°Pï¼ŒMè®²è‡ªå·±æ”¾å…¥å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­ // åŒæ—¶å°†å®ƒçš„gæ”¾ç½®åˆ°å…¨å±€çš„P queueä¸­è¿›å»ï¼Œè‡ªå·±ä¸ç®¡äº† if(p == nil) globrunqput(gp); else if(runtimeÂ·atomicload(\u0026amp;runtimeÂ·sched.sysmonwait)) { runtimeÂ·atomicstore(\u0026amp;runtimeÂ·sched.sysmonwait, 0); runtimeÂ·notewakeup(\u0026amp;runtimeÂ·sched.sysmonnote); } runtimeÂ·unlock(\u0026amp;runtimeÂ·sched.lock); // å¦‚æœæ‰¾åˆ°äº†Pï¼Œå æœ‰På¹¶ä¸”å¼€å§‹æ‰§è¡ŒPå†…çš„gï¼Œæ°¸ä¸å›å¤´ if(p) { acquirep(p); execute(gp); // Never returns. } if(g-\u0026gt;m-\u0026gt;lockedg) { // Wait until another thread schedules gp and so m again. stoplockedm(); execute(gp); // Never returns. } // æ‰¾äº†ä¸€åœˆè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œé‡Šæ”¾æ‰Må½“å‰æ‰§è¡Œç¯å¢ƒï¼ŒMä¸å†åšäº‹ // stopmä¼šæš‚åœå½“å‰Mç›´åˆ°å…¶æ‰¾åˆ°äº†å¯è¿è¡Œçš„Pä¸ºæ­¢ // æ‰¾åˆ°ä»¥åè¿›å…¥scheduleï¼Œæ‰§è¡ŒPå†…çš„g stopm(); // mä»stopm()ä¸­è¿”å›ä»¥åï¼Œè¯´æ˜è¯¥mè¢«ç»‘å®šè‡³æŸä¸ªP,å¯ä»¥å¼€å§‹ // ç»§ç»­æ¬¢å¿«åœ°è·‘äº†,æ­¤æ—¶å°±éœ€è¦è°ƒåº¦æ‰¾åˆ°ä¸€ä¸ªgå»æ‰§è¡Œ // è¿™å°±æ˜¯è°ƒç”¨scheduleçš„ç›®çš„æ‰€åœ¨ schedule(); // Never returns. }  è¯è¯´åˆ°è¿™é‡Œï¼Œå…¶å®è¿™ä¸ªMå½“å‰æ²¡æœ‰è¿è¡Œçš„ä»·å€¼äº†ï¼ˆæ— æ³•æ‰¾åˆ°pè¿è¡Œå®ƒï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å°†å¥¹æŒ‚èµ·ï¼Œç›´åˆ°è¢«å…¶ä»–äººå”¤é†’ã€‚ mè¢«æŒ‚èµ·è°ƒç”¨çš„å‡½æ•°æ˜¯stopm()\n// Stops execution of the current m until new work is available. // Returns with acquired P. static void stopm(void) { if(g-\u0026gt;m-\u0026gt;locks) runtimeÂ·throw(\u0026quot;stopm holding locks\u0026quot;); if(g-\u0026gt;m-\u0026gt;p) runtimeÂ·throw(\u0026quot;stopm holding p\u0026quot;); if(g-\u0026gt;m-\u0026gt;spinning) { g-\u0026gt;m-\u0026gt;spinning = false; runtimeÂ·xadd(\u0026amp;runtimeÂ·sched.nmspinning, -1); } retry: runtimeÂ·lock(\u0026amp;runtimeÂ·sched.lock); // å°†mæ’å…¥åˆ°ç©ºé—²mé˜Ÿåˆ—ä¸­ï¼Œç»Ÿä¸€ç®¡ç† mput(g-\u0026gt;m); runtimeÂ·unlock(\u0026amp;runtimeÂ·sched.lock); // åœ¨è¿™é‡Œè¢«æŒ‚èµ·ï¼Œé˜»å¡åœ¨m-\u0026gt;parkä¸Šï¼Œä½äºlock_futex.go runtimeÂ·notesleep(\u0026amp;g-\u0026gt;m-\u0026gt;park); // ä»æŒ‚èµ·è¢«å”¤é†’åå¼€å§‹æ‰§è¡Œ runtimeÂ·noteclear(\u0026amp;g-\u0026gt;m-\u0026gt;park); if(g-\u0026gt;m-\u0026gt;helpgc) { runtimeÂ·gchelper(); g-\u0026gt;m-\u0026gt;helpgc = 0; g-\u0026gt;m-\u0026gt;mcache = nil; goto retry; } // m-\u0026gt;nextpæ˜¯ä»€ä¹ˆï¼Ÿ acquirep(g-\u0026gt;m-\u0026gt;nextp); g-\u0026gt;m-\u0026gt;nextp = nil; }  é‚£ä¹ˆè¯´åˆ°è¿™é‡Œï¼Œå…¶å®å¾ˆå¤šäº‹æƒ…éƒ½ä¸€ç›®äº†ç„¶ï¼Œå½“ä¸€ä¸ªMä»ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œé€šè¿‡å„ç§æ–¹å¼æƒ³æ‰¾åˆ°å¯ä»¥æ‰˜ä»˜çš„P(æ‰¾å‰å¤«â€”\u0026gt;æ‰¾é—²æ±‰)ï¼Œæ±‚ä¹‹ä¸å¾—æœ€ç»ˆåªèƒ½å°†è‡ªå·±æŒ‚èµ·ï¼Œç­‰å¾…ä¸‹æ¬¡ç³»ç»Ÿä¸­æœ‰ç©ºé—²çš„Pçš„æ—¶å€™è¢«å”¤é†’ã€‚\n1.5 sysmon # å‰é¢æˆ‘ä»¬é‡ç‚¹è®²äº†ä¸€ä¸ªmæ˜¯å¦‚ä½•é™·å…¥ç³»ç»Ÿè°ƒç”¨å’Œå¦‚ä½•è¿”å›çš„å¿ƒé…¸ä¹‹è·¯ã€‚æˆ‘ä»¬å¿½ç•¥äº†pçš„æ„Ÿæƒ…ï¼Œå› ä¸ºä»–æ‰æ˜¯çœŸæ­£çš„å—å®³è€…ï¼Œå®ƒè¢«å‰¥å¤ºäº†mï¼Œä»æ­¤æ— äººç†ä¼šå®ƒå—·å—·å¾…å“ºçš„å­©å­ä»¬(g)ï¼Œå¹¶ä¸”çŠ¶æ€è¿˜è¢«å˜æˆäº†Psyscallï¼Œç›¸å½“äºè´´ä¸Šäº†å±Œä¸æ ‡ç­¾ï¼Œåˆ«æ— ä»–æ³•ï¼Œåªèƒ½ç­‰å¾…é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„mè¿”å›ï¼Œå†ç»­å‰ç¼˜ã€‚ å½“ç„¶ï¼Œè¿™æ ·åšæ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºå¦‚æœmè¿›å…¥ç³»ç»Ÿè°ƒç”¨åä¹ä¸æ€èœ€ï¼Œé‚£Pçš„å­©å­ä»¬éƒ½å¾—é¥¿æ­»ï¼Œè¿™åœ¨ç°å®ç¤¾ä¼šä¸­å¯ä»¥å‘ç”Ÿï¼Œä½†åœ¨æ•°å­—ä¸–ç•Œé‡Œæ˜¯å†³ä¸å…è®¸çš„ã€‚ OKï¼Œç»„ç»‡ç»å¯¹ä¸ä¼šå¿½ç•¥è¿™ç§æƒ…å†µçš„ï¼Œäºæ˜¯ï¼Œä¿å§†ï¼ˆç®¡å®¶ï¼‰å‡ºç°äº†ï¼Œå®ƒå°±æ˜¯sysmonçº¿ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„mï¼Œä¸“é—¨ç›‘æ§ç³»ç»ŸçŠ¶æ€ã€‚ sysmonå‘¨æœŸæ€§é†’æ¥ï¼Œå¹¶ä¸”éå†æ‰€æœ‰çš„pï¼Œå¦‚æœå‘ç°æœ‰PsyscallçŠ¶æ€çš„på¹¶ä¸”å·²ç»å¤„äºè¯¥çŠ¶æ€è¶…è¿‡ä¸€å®šæ—¶é—´äº†ï¼Œé‚£å°±ä¸ç®¡é‚£ä¸ªè´Ÿå¿ƒçš„å‰å¦»ï¼Œå†æ¬¡på®‰æ’ä¸€ä¸ªmï¼Œè¿™æ ·på†…çš„ä»»åŠ¡åˆå¯ä»¥å¾—åˆ°å¤„ç†äº†ã€‚\nfunc sysmon() { ...... retake(now); ...... } // æˆ‘ä»¬åªæ‘˜å–äº†sysmonä¸­ä¸På¤„ç†ç›¸å…³çš„ä»£ç åˆ†æï¼š static uint32 retake(int64 now) { uint32 i, s, n; int64 t; P *p; Pdesc *pd; n = 0; // éå†æ‰€æœ‰çš„Pï¼Œæ ¹æ®å…¶çŠ¶æ€ä½œç›¸åº”å¤„ç†ï¼Œæˆ‘ä»¬åªå…³æ³¨Psyscall for(i = 0; i \u0026lt; runtimeÂ·gomaxprocs; i++) { p = runtimeÂ·allp[i]; if(p==nil) continue; pd = \u0026amp;pdesc[i]; s = p-\u0026gt;status; if(s == Psyscall) { t = p-\u0026gt;syscalltick; if(pd-\u0026gt;syscalltick != t) { pd-\u0026gt;syscalltick = t; pd-\u0026gt;syscallwhen = now; continue; } if(p-\u0026gt;runqhead == p-\u0026gt;runqtail \u0026amp;\u0026amp; runtimeÂ·atomicload(\u0026amp;runtimeÂ·sched.nmspinning) + runtimeÂ·atomicload(\u0026amp;runtimeÂ·sched.npidle) \u0026gt; 0 \u0026amp;\u0026amp; pd-\u0026gt;syscallwhen + 10*1000*1000 \u0026gt; now) continue; incidlelocked(-1); // å› ä¸ºéœ€è¦å°†Pé‡æ–°å®‰æ’mï¼Œæ‰€ä»¥çŠ¶æ€è½¬åŒ–ä¸ºPidle if(runtimeÂ·cas(\u0026amp;p-\u0026gt;status, s, Pidle)) { n++; handoffp(p); } incidlelocked(1); ...... }  æ‰¾åˆ°äº†å¤„äºPsyscallçŠ¶æ€çš„Påï¼Œç»§ç»­åˆ¤æ–­å®ƒç­‰å¾…çš„æ—¶é—´æ˜¯å¦å·²ç»å¤ªé•¿ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œå°±å‡†å¤‡æŠ›å¼ƒåŸæ¥çš„è¿˜é™·å…¥syscallçš„mï¼Œè°ƒç”¨handoff(p)ï¼Œå¼€å§‹ä¸ºpå‡†å¤‡æ–°ç”Ÿæ´»ã€‚\næˆ‘ä»¬æ¥ä¸‹æ¥ä»”ç»†åˆ†æä¸‹pæ˜¯æ€ä¹ˆè¿‡ä¸Šæ–°ç”Ÿæ´»çš„ï¼Œhandoffpæ— éå°±æ˜¯æ‰¾ä¸€ä¸ªæ–°çš„mï¼Œå°†mä¸è¯¥pç»‘å®šï¼Œæ¥ä¸‹æ¥å°†ç”±mç»§ç»­æ‰§è¡Œè¯¥på†…çš„gã€‚\nhandoffp()æ‰¾åˆ°çš„æ–°çš„må¯èƒ½æ˜¯åˆ«äººä»¥å‰çš„m(ç§ç”Ÿæ´»å¥½æ··ä¹±)ã€‚ç”±äºè¿™é‡Œè·å¾—çš„mæ˜¯å¤„äºidleçŠ¶æ€ï¼Œå¤„äºwaitçŠ¶æ€ï¼ˆåœ¨stopm()ä¸­è¢«sleepçš„ï¼‰ï¼Œåœ¨è¿™é‡Œï¼Œhandoffpä¸­ä¼šé€šè¿‡startm()æ¥å”¤é†’å®ƒï¼Œä¸€ä¸ªå¸¸è§é€»è¾‘å°±æ˜¯è¿™ä¸ªpé‡Œé¢è¿˜æœ‰gè¦æ‰§è¡Œé‚£ä¹ˆå°±ç›´æ¥startmï¼Œè¿™é‡Œçš„startmä¼šé€šè¿‡mgetè·å–ä¸€ä¸ªç©ºé—²çš„mï¼ˆå¦‚stopmæš‚åœçš„mï¼‰ï¼Œè·å–ä¸åˆ°å°±é€šè¿‡newm()åˆ›å»ºä¸€ä¸ªmã€‚\nè¿™é‡Œçš„startmä»¥è¢«å”¤é†’çš„mä¸ºä¾‹ç»§ç»­è¯´æ˜ï¼Œå…³äºæ–°åˆ›å»ºçš„mè¢«å”¤é†’çš„mç»§ç»­æ‰§è¡Œå®ƒè¢«é˜»å¡çš„ä¸‹ä¸€æ¡è¯­å¥ï¼š\nstopm() { ...... // ä»æŒ‚èµ·è¢«å”¤é†’åå¼€å§‹æ‰§è¡Œ runtimeÂ·noteclear(\u0026amp;g-\u0026gt;m-\u0026gt;park); if(g-\u0026gt;m-\u0026gt;helpgc) { runtimeÂ·gchelper(); g-\u0026gt;m-\u0026gt;helpgc = 0; g-\u0026gt;m-\u0026gt;mcache = nil; goto retry; } // å°†Må’ŒPç»‘å®š acquirep(g-\u0026gt;m-\u0026gt;nextp); g-\u0026gt;m-\u0026gt;nextp = nil; } // ç”±äºmåœ¨sleepå‰çš„è°ƒç”¨è·¯å¾„æ˜¯exitsyscall0() â€“\u0026gt; stopm()ï¼Œä»stopm()ä¸­è¿”å›è‡³exitsyscall0åï¼Œæ‰§è¡Œæ¥ä¸‹æ¥çš„è¯­å¥ func exitsyscall0(gp *g) { _g_ := getg() ...... stopm() // mç»§ç»­runèµ·æ¥åï¼Œæ‰§è¡Œä¸€æ¬¡schedule // æ‰¾åˆ°m-\u0026gt;pé‡Œé¢å¯è¿è¡Œçš„gå¹¶æ‰§è¡Œ schedule() // Never returns. } // One round of scheduler: find a runnable goroutine and execute it. // Never returns. func schedule() { _g_ := getg() ...... if gp == nil { gp, inheritTime = runqget(_g_.m.p.ptr()) if gp != nil \u0026amp;\u0026amp; _g_.m.spinning { throw(\u0026quot;schedule: spinning with local work\u0026quot;) } } if gp == nil { gp, inheritTime = findrunnable() resetspinning() } if gp.lockedm != nil { // Hands off own p to the locked m, // then blocks waiting for a new p. startlockedm(gp) goto top } // æ‰§è¡Œè¯¥gp execute(gp, inheritTime) }  1.6 æ€»ç»“ # æœ¬æ–‡ä»‹ç»äº†goå¯¹ç³»ç»Ÿè°ƒç”¨çš„å¤§è‡´å¤„ç†è¿‡ç¨‹ï¼Œæ„Ÿè°¢çŸ¥ä¹ç½‘å‹ä¸å‡¯åœ¨çŸ¥ä¹çš„åˆ†äº«ï¼Œç»“åˆä¸ªäººç†è§£ï¼Œç•¥ä½œæ•´ç†ä¹Ÿåˆ†äº«ç»™å¤§å®¶ã€‚\n"}),a.add({id:145,href:"/blog/2021-05-25-go%E6%8A%A2%E5%8D%A0%E5%BC%8F%E8%B0%83%E5%BA%A6/",title:"goæŠ¢å å¼è°ƒåº¦",description:"SIGURGï¼Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°runtime/signal_unix.go:sighandler(\u0026hellip;)å‡½æ•°ä¸­åˆçœ‹åˆ°å¯¹sigPreemptçš„å¤„ç†ã€‚\nSIGURGå®ç°æŠ¢å å¼è°ƒåº¦ï¼š å¯¹åº”è¿™ä¸ªå‡½æ•°doSigPreemptï¼Œæ£€æŸ¥å½“å‰gæ˜¯ä¸æ˜¯wantAsyncPreemptï¼Œokçš„è¯æ£€æŸ¥æ˜¯ä¸æ˜¯isAsyncSafePointï¼Œokçš„è¯ï¼Œsigctxt.pushCall(funcPC(asyncPreempt), newpc)ï¼Œè¿™ä¸ªå‡½æ•°è°ƒæ•´PCå¹¶æ³¨å…¥ä¸€ä¸ªå¯¹asyncPreemptçš„è°ƒç”¨ã€‚\nTODO wantAsyncPreemptå¯¹åº”çš„åˆ¤æ–­å‚æ•°æ˜¯è°å»è®¾ç½®çš„ï¼Œä»€ä¹ˆæ—¶å€™è®¾ç½®çš„ï¼Ÿ\nTODO isAsyncSafePointï¼Œsafepointçš„å«ä¹‰ï¼Ÿè¿™ä¸ªå‡½æ•°çš„æ³¨é‡Šä»¥åŠä»£ç ä¸­çš„if-elseå·²ç»è¶³å¤Ÿç»“å®æ¸…æ¥šä»€ä¹ˆæ˜¯safepointäº†ï¼Œä»¥åŠsafepointçš„æ„ä¹‰äº†ã€‚\nçœ‹ä¸‹asyncPreemptçš„é€»è¾‘ï¼Œè¯¥å‡½æ•°æ˜¯åœ¨æ±‡ç¼–ä¸­å®ç°çš„ï¼Œé¦–å…ˆä¿å­˜å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åè°ƒç”¨asyncPreempt2æ‰§è¡Œå…¶ä»–å¤„ç†ã€‚\ng.preemptStopå†³å®šæ˜¯æŒ‚èµ·gè¿˜æ˜¯é‡æ–°è°ƒåº¦gï¼š\n å¦‚æœè¢«æŠ¢å çš„gçš„g.preemptStopä¸ºtrueï¼Œåˆ™æ‰§è¡Œmcall(preemptPark)æŒ‚èµ·è¯¥gï¼Œgçš„çŠ¶æ€è¢«æ”¹ä¸ºpreemptedï¼Œåé¢ä»€ä¹ˆæ—¶æœºä¼šé‡æ–°è°ƒåº¦å®ƒå§ã€‚ç„¶åæ‰§è¡Œscheduleè°ƒåº¦å…¶ä»–goroutineæ‰§è¡Œï¼› å¦‚æœg.preemptStopä¸ºfalseï¼Œåˆ™mcall(gopreempt_m)å°†gä»runningæ”¹ä¸ºrunnableé‡æ–°è°ƒåº¦ä¸€æ¬¡ã€‚  å¤§è‡´çš„æŠ¢å å¼è°ƒåº¦é€»è¾‘å°±æ˜¯è¿™æ ·çš„ã€‚\nps: func mcall(fn func(*g))ï¼Œmcall switches from the g to the g0 stack and invokes fn(g), where g is the goroutine that made the call.",content:"SIGURGï¼Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°runtime/signal_unix.go:sighandler(\u0026hellip;)å‡½æ•°ä¸­åˆçœ‹åˆ°å¯¹sigPreemptçš„å¤„ç†ã€‚\nSIGURGå®ç°æŠ¢å å¼è°ƒåº¦ï¼š å¯¹åº”è¿™ä¸ªå‡½æ•°doSigPreemptï¼Œæ£€æŸ¥å½“å‰gæ˜¯ä¸æ˜¯wantAsyncPreemptï¼Œokçš„è¯æ£€æŸ¥æ˜¯ä¸æ˜¯isAsyncSafePointï¼Œokçš„è¯ï¼Œsigctxt.pushCall(funcPC(asyncPreempt), newpc)ï¼Œè¿™ä¸ªå‡½æ•°è°ƒæ•´PCå¹¶æ³¨å…¥ä¸€ä¸ªå¯¹asyncPreemptçš„è°ƒç”¨ã€‚\nTODO wantAsyncPreemptå¯¹åº”çš„åˆ¤æ–­å‚æ•°æ˜¯è°å»è®¾ç½®çš„ï¼Œä»€ä¹ˆæ—¶å€™è®¾ç½®çš„ï¼Ÿ\nTODO isAsyncSafePointï¼Œsafepointçš„å«ä¹‰ï¼Ÿè¿™ä¸ªå‡½æ•°çš„æ³¨é‡Šä»¥åŠä»£ç ä¸­çš„if-elseå·²ç»è¶³å¤Ÿç»“å®æ¸…æ¥šä»€ä¹ˆæ˜¯safepointäº†ï¼Œä»¥åŠsafepointçš„æ„ä¹‰äº†ã€‚\nçœ‹ä¸‹asyncPreemptçš„é€»è¾‘ï¼Œè¯¥å‡½æ•°æ˜¯åœ¨æ±‡ç¼–ä¸­å®ç°çš„ï¼Œé¦–å…ˆä¿å­˜å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åè°ƒç”¨asyncPreempt2æ‰§è¡Œå…¶ä»–å¤„ç†ã€‚\ng.preemptStopå†³å®šæ˜¯æŒ‚èµ·gè¿˜æ˜¯é‡æ–°è°ƒåº¦gï¼š\n å¦‚æœè¢«æŠ¢å çš„gçš„g.preemptStopä¸ºtrueï¼Œåˆ™æ‰§è¡Œmcall(preemptPark)æŒ‚èµ·è¯¥gï¼Œgçš„çŠ¶æ€è¢«æ”¹ä¸ºpreemptedï¼Œåé¢ä»€ä¹ˆæ—¶æœºä¼šé‡æ–°è°ƒåº¦å®ƒå§ã€‚ç„¶åæ‰§è¡Œscheduleè°ƒåº¦å…¶ä»–goroutineæ‰§è¡Œï¼› å¦‚æœg.preemptStopä¸ºfalseï¼Œåˆ™mcall(gopreempt_m)å°†gä»runningæ”¹ä¸ºrunnableé‡æ–°è°ƒåº¦ä¸€æ¬¡ã€‚  å¤§è‡´çš„æŠ¢å å¼è°ƒåº¦é€»è¾‘å°±æ˜¯è¿™æ ·çš„ã€‚\nps: func mcall(fn func(*g))ï¼Œmcall switches from the g to the g0 stack and invokes fn(g), where g is the goroutine that made the call.\n"}),a.add({id:146,href:"/tags/preemption/",title:"preemption",description:"",content:""}),a.add({id:147,href:"/tags/schedule/",title:"schedule",description:"",content:""}),a.add({id:148,href:"/blog/2021-05-25-go%E7%A8%8B%E5%BA%8F%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E8%BF%87%E7%A8%8B/",title:"goç¨‹åºä¿¡å·å¤„ç†è¿‡ç¨‹",description:"goä¿¡å·å¤„ç†åŸºç¡€ # go os.signal packageå¯¹ä¿¡å·å¤„ç†åšäº†å°è£…ï¼Œå…¶ä¸­ä¿¡å·SIGKILLã€SIGSTOPæ˜¯æ“ä½œç³»ç»Ÿè§„å®šçš„ä¸å…è®¸æ•è·çš„ä¿¡å·ï¼Œæ˜¯ä¸å—os.signalè¿™ä¸ªpackageå½±å“çš„\ngoä¸­å°†ä¿¡å·åˆ†ä¸ºä¸¤ç±»ï¼šåŒæ­¥ä¿¡å·å’Œå¼‚æ­¥ä¿¡å·ã€‚\n  åŒæ­¥ä¿¡å·ï¼šæŒ‡çš„æ˜¯goç¨‹åºè¿è¡Œæ—¶ç¨‹åºå†…éƒ¨é”™è¯¯è§¦å‘çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚SIGBUSã€SIGFPEã€SIGSEGVï¼Œè¿™äº›ä¿¡å·ä¼šè¢«è½¬æ¢æˆè¿è¡Œæ—¶panicä¿¡æ¯ï¼›\n  å¼‚æ­¥ä¿¡å·ï¼šé™¤äº†ä¸Šè¿°æåŠçš„ä¿¡å·ä¹‹å¤–çš„ä¿¡å·ï¼Œå°±æ˜¯å¼‚æ­¥ä¿¡å·äº†ã€‚å¼‚æ­¥ä¿¡å·ä¸æ˜¯ç¨‹åºå†…éƒ¨é”™è¯¯å¯¼è‡´çš„ï¼Œè€Œæ˜¯ç”±æ“ä½œç³»ç»Ÿæˆ–è€…å¤–éƒ¨å…¶ä»–ç¨‹åºå‘é€ç»™å®ƒçš„ã€‚\n  æœ‰å“ªäº›å¼‚æ­¥ä¿¡å·ï¼Ÿ #  å½“ç¨‹åºå¤±å»å¯¹æ§åˆ¶ç»ˆç«¯çš„æ§åˆ¶æ—¶ï¼Œä¼šæ”¶åˆ°SIGHUPä¿¡å·ï¼› åœ¨æ§åˆ¶ç»ˆç«¯ä¸­è¾“å…¥Ctrl+Cæ—¶ä¼šæ”¶åˆ°SIGINTä¿¡å·ï¼› åœ¨æ§åˆ¶ç»ˆç«¯ä¸­è¾“å…¥Ctrl+\\æ—¶ä¼šå—åˆ°SIGQUITä¿¡å·ï¼›  psï¼šé€šå¸¸æƒ³è®©ç¨‹åºé€€å‡ºçš„è¯ï¼ŒCtrl+Cå°±å¯ä»¥äº†ï¼Œå¦‚æœæƒ³è®©ç¨‹åºé€€å‡ºåŒæ—¶æ‰“å°æ ˆè½¬å‚¨ä¿¡æ¯ï¼Œé‚£å°±ç”¨Ctrl+\\ã€‚\né»˜è®¤çš„ä¿¡å·å¤„ç†æ–¹å¼ï¼Ÿ # æ¥æ”¶åˆ°ä¿¡å·ä¹‹åï¼Œè‚¯å®šæœ‰é»˜è®¤çš„å¤„ç†æ–¹å¼ï¼Œè¿™ä¸ªåœ¨å­¦ä¹ linuxä¿¡å·å¤„ç†æ—¶è‚¯å®šæœ‰äº†è§£è¿‡çš„ï¼Œåœ¨goç¨‹åºä¸­å¯èƒ½åªæ˜¯é»˜è®¤å¤„ç†æ–¹å¼æœ‰ç‚¹ä¸åŒï¼Œè¿™ä¸ªæœ‰éœ€è¦çš„æ—¶å€™å»äº†è§£å°±å¯ä»¥äº†ã€‚è¿™é‡Œä¸å±•å¼€äº†ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ä¿¡å·SIGPROFï¼Œè¿™ä¸ªä¿¡å·ç”¨äºå®ç°runtime.CPUProfileã€‚\nè‡ªå®šä¹‰ä¿¡å·å¤„ç†æ–¹å¼ï¼Ÿ # è‡ªå®šä¹‰ä¿¡å·å¤„ç†æ–¹å¼ï¼Œåœ¨linux signalå‡½æ•°ä¸­å¯ä»¥æŒ‡å®šä¿¡å·åŠå¯¹åº”å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œgoä¸­ç±»ä¼¼ï¼Œå®ƒå…è®¸é€šè¿‡os.NotifyæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªä¿¡å·chanï¼Œé‡Œé¢å¯ä»¥æ³¨å†Œæ„Ÿå…´è¶£çš„ä¿¡å·ï¼Œå½“æ”¶åˆ°è¿™äº›ä¿¡å·æ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„ä¿¡å·å¤„ç†é€»è¾‘ã€‚\nSIGPIPEä¿¡å·å¤„ç† # å½“ç¨‹åºwrite broken pipeæ—¶ï¼Œä¼šæ”¶åˆ°SIGPIPEä¿¡å·ï¼Œæ¯”å¦‚å†™ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¦‚æœä¸åšå¤„ç†é»˜è®¤å´©æºƒæ‰é‚£å°±å®Œè›‹äº†ã€‚goç¨‹åºä¸­å¯¹è¿™ä¸ªåšäº†ä¼˜åŒ–å¤„ç†ã€‚\nwrite broken pipeçš„è¡Œä¸ºä¸writeçš„file descriptorçš„fdæœ‰å…³ç³»ï¼š\n å¦‚æœfdæ˜¯stdoutã€stderrï¼Œé‚£ä¹ˆç¨‹åºæ”¶åˆ°SIGPIPEä¿¡å·ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯ç¨‹åºä¼šé€€å‡ºï¼› å¦‚æœæ˜¯å…¶ä»–fdï¼Œç¨‹åºæ”¶åˆ°SIGPIPEä¿¡å·ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯ä¸é‡‡å–ä»»ä½•åŠ¨ä½œï¼Œå¯¹åº”çš„writeæ“ä½œè¿”å›ä¸€ä¸ªEPIPEé”™è¯¯ï¼›  psï¼šåè€…å¾ˆé‡è¦ï¼Œå†™ç½‘ç»œè¿æ¥å¤±è´¥æ˜¯å¸¸æœ‰çš„äº‹æƒ…ï¼Œlinux cç¨‹åºå¦‚æœä¸æ˜¾ç¤ºå¤„ç†SIGPIPEä¿¡å·ï¼Œé»˜è®¤è¡Œä¸ºå°†æ˜¯ç¨‹åºç›´æ¥crashï¼Œgoç¨‹åºå¯¹æ­¤ä½œäº†ä¼˜åŒ–ï¼Œè®©writeè¿”å›errorè€Œécrashï¼Œå¯¹äºgoå°†æ„å»ºé«˜æ€§èƒ½ã€ç¨³å®šå¥å£®çš„ç½‘ç»œç¨‹åºçš„åˆè¡·æ¥è¯´æ˜¯æœ‰å¿…è¦çš„ã€‚\ncgoç¨‹åºä¿¡å·å¤„ç†ï¼Ÿ # æ¶‰åŠåˆ°cgoå°±è¦åˆ†å‡ ç§æƒ…å†µæ¥è®¨è®ºï¼Œè¿™é‡Œä¼šæœ‰ç‚¹éº»çƒ¦äº†ï¼Œæ¶‰åŠåˆ°ä¿¡å·å¤„ç†å‡½æ•°çš„é‡å¤æ³¨å†Œã€ä¿¡å·æ©ç è®¾ç½®ã€ä¿¡å·å¤„ç†å‡½æ•°çš„æ ˆç­‰é—®é¢˜ï¼Œåœ¨os/signal/doc.goé‡Œé¢æœ‰è¿™æ–¹é¢çš„æè¿°ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚\ngoä¿¡å·å¤„ç†è¿‡ç¨‹ # ä»‹ç»äº†goç¨‹åºå†…éƒ¨çš„ä¿¡å·å¤„ç†è¿‡ç¨‹ã€‚GMPè°ƒåº¦æ¨¡å‹é‡Œé¢ï¼Œæ¯ä¸ªMéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„gsignal goroutineï¼Œç³»ç»ŸæŠ•é€’ä¿¡å·ç»™è¿›ç¨‹æ—¶å®é™…ä¸Šæ˜¯æœ‰gsignal goroutineæ¥æ¥å—è¿™ä¸ªä¿¡å·ï¼Œç„¶åæ£€æŸ¥ä¸‹æ˜¯å¦å¯å¤„ç†ã€‚å¦‚æœå¯å¤„ç†å°±å°†å…¶pushåˆ°ä¸€ä¸ªä¿¡å·é˜Ÿåˆ—ä¸­ï¼Œç„¶åæœ‰ä¸€ä¸ªä¸“é—¨çš„goroutineæ‰§è¡Œsignal.loopï¼Œè¿™ä¸ªå‡½æ•°ä»ä¸Šè¿°ä¿¡å·é˜Ÿåˆ—ä¸­å–ä¿¡å·ï¼Œå¹¶è½¬ç§»åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„chan os.Signalä¸­ï¼Œå†ç”±æˆ‘ä»¬è‡ªå·±å†™çš„chan readä»£ç æ¶ˆè´¹ï¼Œå¹¶æ‰§è¡Œå¤„ç†ã€‚\nå¯¹åº”åˆ°æºç ä¸­ä¸»è¦æœ‰å‡ ä¸ªå‡½æ•°ï¼š\nå¯¹åº”åˆ°æºç ä¸­ä¸»è¦æœ‰å‡ ä¸ªå‡½æ•°ï¼š\n  os/signal/signal.goï¼šè¿™ä¸ªå‡½æ•°é‡Œé¢åœ¨func init()çš„æ—¶å€™æœ‰å¯åŠ¨ä¸€ä¸ªloopå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å†…è°ƒç”¨runtime.signal_recvæ¥ä¸åœåœ°æ¥æ”¶ä¿¡å·ï¼Œç„¶åæ£€æŸ¥ç¨‹åºé€šè¿‡os.Notifyä¸ºå“ªäº›chan os.Signalè®¢é˜…äº†è¯¥ä¿¡å·ï¼Œå°±å°†è¯¥ä¿¡å·pushåˆ°å¯¹åº”çš„chanä¸­ï¼Œåé¢åº”ç”¨ç¨‹åºå°±å¯ä»¥è‡ªè¡Œå¤„ç†äº†ï¼›\n  runtime/sigqueue.goï¼šruntime.sigsendã€runtime.signal_recvè¿™ä¸¤ä¸ªå‡½æ•°å¾ˆé‡è¦ï¼Œå‰è€…æ˜¯ç¨‹åºæ”¶åˆ°ç³»ç»Ÿå‘é€æ¥çš„ä¿¡å·æ—¶å°†ä¿¡å·å†™å…¥outgoing sigqueueä¸­ï¼Œå…¶å®å°±æ˜¯sigç»“æ„ä½“çš„maskå­—æ®µï¼Œåé¢signal_recvçš„æ—¶å€™ä¹Ÿæ˜¯ä»è¯¥maskå­—æ®µè¯»å–ï¼Œå¹¶å†™å…¥recvå­—æ®µä¸­ï¼Œrecvä¸­é0çš„åº”è¯¥å°±æ˜¯è¡¨ç¤ºæ”¶åˆ°äº†ä¿¡å·ï¼ˆä¿¡å·ç¼–å·ä¸ºç´¢å¼•å€¼ï¼‰ï¼›\n  runtime/signal_unix.goï¼šæœ‰ä¸ªå‡½æ•°sighandlerï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£å¯¹ä¸åŒçš„ä¿¡å·æ‰§è¡Œä¸åŒçš„å¤„ç†ï¼Œæ¯”å¦‚æŠ¢å å¼è°ƒåº¦SIGURGçš„å¤„ç†ï¼Œæ¯”å¦‚SIGPROFçš„å¤„ç†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„ä¸€äº›å¼‚æ­¥ä¿¡å·çš„å¤„ç†sigsendã€‚åœ¨goç¨‹åºä¸­ä¸ç®¡æ˜¯ä»€ä¹ˆä¿¡å·ï¼Œè¿™äº›ä¿¡å·æ˜¯åœ¨sighandleråšä¸åŒå¤„ç†ã€‚sighandlerè™½ç„¶åå­—æ˜¯ä¿¡å·å¤„ç†å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†é€šè¿‡setsigå°†æ‰€æœ‰ä¿¡å·å…¨éƒ¨è®¾ç½®sighandlerä¸ºä¿¡å·å¤„ç†å‡½æ•°ï¼Œä½†æ˜¯å…¶å®è¿™åªæ˜¯è¡¨ç°ã€‚setsigå‡½æ•°å†…éƒ¨åˆåšäº†ä¸€ä¸ªè½¬æ¢ï¼Œå°†ä¿¡å·çš„ä¿¡å·å¤„ç†å‡½æ•°è®¾ç½®ä¸ºäº†sigtrampæ´»ç€cgosigtrampï¼Œè¿™äº›å‡½æ•°å†…éƒ¨åˆè°ƒç”¨sighandlerã€‚ä¸‹é¢ä¼šæåˆ°sigtrampçš„é€»è¾‘ï¼›\n  runtime/runtime2.",content:"goä¿¡å·å¤„ç†åŸºç¡€ # go os.signal packageå¯¹ä¿¡å·å¤„ç†åšäº†å°è£…ï¼Œå…¶ä¸­ä¿¡å·SIGKILLã€SIGSTOPæ˜¯æ“ä½œç³»ç»Ÿè§„å®šçš„ä¸å…è®¸æ•è·çš„ä¿¡å·ï¼Œæ˜¯ä¸å—os.signalè¿™ä¸ªpackageå½±å“çš„\ngoä¸­å°†ä¿¡å·åˆ†ä¸ºä¸¤ç±»ï¼šåŒæ­¥ä¿¡å·å’Œå¼‚æ­¥ä¿¡å·ã€‚\n  åŒæ­¥ä¿¡å·ï¼šæŒ‡çš„æ˜¯goç¨‹åºè¿è¡Œæ—¶ç¨‹åºå†…éƒ¨é”™è¯¯è§¦å‘çš„ä¸€äº›é—®é¢˜ï¼Œå¦‚SIGBUSã€SIGFPEã€SIGSEGVï¼Œè¿™äº›ä¿¡å·ä¼šè¢«è½¬æ¢æˆè¿è¡Œæ—¶panicä¿¡æ¯ï¼›\n  å¼‚æ­¥ä¿¡å·ï¼šé™¤äº†ä¸Šè¿°æåŠçš„ä¿¡å·ä¹‹å¤–çš„ä¿¡å·ï¼Œå°±æ˜¯å¼‚æ­¥ä¿¡å·äº†ã€‚å¼‚æ­¥ä¿¡å·ä¸æ˜¯ç¨‹åºå†…éƒ¨é”™è¯¯å¯¼è‡´çš„ï¼Œè€Œæ˜¯ç”±æ“ä½œç³»ç»Ÿæˆ–è€…å¤–éƒ¨å…¶ä»–ç¨‹åºå‘é€ç»™å®ƒçš„ã€‚\n  æœ‰å“ªäº›å¼‚æ­¥ä¿¡å·ï¼Ÿ #  å½“ç¨‹åºå¤±å»å¯¹æ§åˆ¶ç»ˆç«¯çš„æ§åˆ¶æ—¶ï¼Œä¼šæ”¶åˆ°SIGHUPä¿¡å·ï¼› åœ¨æ§åˆ¶ç»ˆç«¯ä¸­è¾“å…¥Ctrl+Cæ—¶ä¼šæ”¶åˆ°SIGINTä¿¡å·ï¼› åœ¨æ§åˆ¶ç»ˆç«¯ä¸­è¾“å…¥Ctrl+\\æ—¶ä¼šå—åˆ°SIGQUITä¿¡å·ï¼›  psï¼šé€šå¸¸æƒ³è®©ç¨‹åºé€€å‡ºçš„è¯ï¼ŒCtrl+Cå°±å¯ä»¥äº†ï¼Œå¦‚æœæƒ³è®©ç¨‹åºé€€å‡ºåŒæ—¶æ‰“å°æ ˆè½¬å‚¨ä¿¡æ¯ï¼Œé‚£å°±ç”¨Ctrl+\\ã€‚\né»˜è®¤çš„ä¿¡å·å¤„ç†æ–¹å¼ï¼Ÿ # æ¥æ”¶åˆ°ä¿¡å·ä¹‹åï¼Œè‚¯å®šæœ‰é»˜è®¤çš„å¤„ç†æ–¹å¼ï¼Œè¿™ä¸ªåœ¨å­¦ä¹ linuxä¿¡å·å¤„ç†æ—¶è‚¯å®šæœ‰äº†è§£è¿‡çš„ï¼Œåœ¨goç¨‹åºä¸­å¯èƒ½åªæ˜¯é»˜è®¤å¤„ç†æ–¹å¼æœ‰ç‚¹ä¸åŒï¼Œè¿™ä¸ªæœ‰éœ€è¦çš„æ—¶å€™å»äº†è§£å°±å¯ä»¥äº†ã€‚è¿™é‡Œä¸å±•å¼€äº†ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ä¿¡å·SIGPROFï¼Œè¿™ä¸ªä¿¡å·ç”¨äºå®ç°runtime.CPUProfileã€‚\nè‡ªå®šä¹‰ä¿¡å·å¤„ç†æ–¹å¼ï¼Ÿ # è‡ªå®šä¹‰ä¿¡å·å¤„ç†æ–¹å¼ï¼Œåœ¨linux signalå‡½æ•°ä¸­å¯ä»¥æŒ‡å®šä¿¡å·åŠå¯¹åº”å¯¹åº”çš„å¤„ç†å‡½æ•°ï¼Œgoä¸­ç±»ä¼¼ï¼Œå®ƒå…è®¸é€šè¿‡os.NotifyæŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªä¿¡å·chanï¼Œé‡Œé¢å¯ä»¥æ³¨å†Œæ„Ÿå…´è¶£çš„ä¿¡å·ï¼Œå½“æ”¶åˆ°è¿™äº›ä¿¡å·æ—¶ï¼Œå°±å¯ä»¥æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„ä¿¡å·å¤„ç†é€»è¾‘ã€‚\nSIGPIPEä¿¡å·å¤„ç† # å½“ç¨‹åºwrite broken pipeæ—¶ï¼Œä¼šæ”¶åˆ°SIGPIPEä¿¡å·ï¼Œæ¯”å¦‚å†™ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¦‚æœä¸åšå¤„ç†é»˜è®¤å´©æºƒæ‰é‚£å°±å®Œè›‹äº†ã€‚goç¨‹åºä¸­å¯¹è¿™ä¸ªåšäº†ä¼˜åŒ–å¤„ç†ã€‚\nwrite broken pipeçš„è¡Œä¸ºä¸writeçš„file descriptorçš„fdæœ‰å…³ç³»ï¼š\n å¦‚æœfdæ˜¯stdoutã€stderrï¼Œé‚£ä¹ˆç¨‹åºæ”¶åˆ°SIGPIPEä¿¡å·ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯ç¨‹åºä¼šé€€å‡ºï¼› å¦‚æœæ˜¯å…¶ä»–fdï¼Œç¨‹åºæ”¶åˆ°SIGPIPEä¿¡å·ï¼Œé»˜è®¤è¡Œä¸ºæ˜¯ä¸é‡‡å–ä»»ä½•åŠ¨ä½œï¼Œå¯¹åº”çš„writeæ“ä½œè¿”å›ä¸€ä¸ªEPIPEé”™è¯¯ï¼›  psï¼šåè€…å¾ˆé‡è¦ï¼Œå†™ç½‘ç»œè¿æ¥å¤±è´¥æ˜¯å¸¸æœ‰çš„äº‹æƒ…ï¼Œlinux cç¨‹åºå¦‚æœä¸æ˜¾ç¤ºå¤„ç†SIGPIPEä¿¡å·ï¼Œé»˜è®¤è¡Œä¸ºå°†æ˜¯ç¨‹åºç›´æ¥crashï¼Œgoç¨‹åºå¯¹æ­¤ä½œäº†ä¼˜åŒ–ï¼Œè®©writeè¿”å›errorè€Œécrashï¼Œå¯¹äºgoå°†æ„å»ºé«˜æ€§èƒ½ã€ç¨³å®šå¥å£®çš„ç½‘ç»œç¨‹åºçš„åˆè¡·æ¥è¯´æ˜¯æœ‰å¿…è¦çš„ã€‚\ncgoç¨‹åºä¿¡å·å¤„ç†ï¼Ÿ # æ¶‰åŠåˆ°cgoå°±è¦åˆ†å‡ ç§æƒ…å†µæ¥è®¨è®ºï¼Œè¿™é‡Œä¼šæœ‰ç‚¹éº»çƒ¦äº†ï¼Œæ¶‰åŠåˆ°ä¿¡å·å¤„ç†å‡½æ•°çš„é‡å¤æ³¨å†Œã€ä¿¡å·æ©ç è®¾ç½®ã€ä¿¡å·å¤„ç†å‡½æ•°çš„æ ˆç­‰é—®é¢˜ï¼Œåœ¨os/signal/doc.goé‡Œé¢æœ‰è¿™æ–¹é¢çš„æè¿°ï¼Œè¿™é‡Œä¸èµ˜è¿°ã€‚\ngoä¿¡å·å¤„ç†è¿‡ç¨‹ # ä»‹ç»äº†goç¨‹åºå†…éƒ¨çš„ä¿¡å·å¤„ç†è¿‡ç¨‹ã€‚GMPè°ƒåº¦æ¨¡å‹é‡Œé¢ï¼Œæ¯ä¸ªMéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„gsignal goroutineï¼Œç³»ç»ŸæŠ•é€’ä¿¡å·ç»™è¿›ç¨‹æ—¶å®é™…ä¸Šæ˜¯æœ‰gsignal goroutineæ¥æ¥å—è¿™ä¸ªä¿¡å·ï¼Œç„¶åæ£€æŸ¥ä¸‹æ˜¯å¦å¯å¤„ç†ã€‚å¦‚æœå¯å¤„ç†å°±å°†å…¶pushåˆ°ä¸€ä¸ªä¿¡å·é˜Ÿåˆ—ä¸­ï¼Œç„¶åæœ‰ä¸€ä¸ªä¸“é—¨çš„goroutineæ‰§è¡Œsignal.loopï¼Œè¿™ä¸ªå‡½æ•°ä»ä¸Šè¿°ä¿¡å·é˜Ÿåˆ—ä¸­å–ä¿¡å·ï¼Œå¹¶è½¬ç§»åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„chan os.Signalä¸­ï¼Œå†ç”±æˆ‘ä»¬è‡ªå·±å†™çš„chan readä»£ç æ¶ˆè´¹ï¼Œå¹¶æ‰§è¡Œå¤„ç†ã€‚\nå¯¹åº”åˆ°æºç ä¸­ä¸»è¦æœ‰å‡ ä¸ªå‡½æ•°ï¼š\nå¯¹åº”åˆ°æºç ä¸­ä¸»è¦æœ‰å‡ ä¸ªå‡½æ•°ï¼š\n  os/signal/signal.goï¼šè¿™ä¸ªå‡½æ•°é‡Œé¢åœ¨func init()çš„æ—¶å€™æœ‰å¯åŠ¨ä¸€ä¸ªloopå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å†…è°ƒç”¨runtime.signal_recvæ¥ä¸åœåœ°æ¥æ”¶ä¿¡å·ï¼Œç„¶åæ£€æŸ¥ç¨‹åºé€šè¿‡os.Notifyä¸ºå“ªäº›chan os.Signalè®¢é˜…äº†è¯¥ä¿¡å·ï¼Œå°±å°†è¯¥ä¿¡å·pushåˆ°å¯¹åº”çš„chanä¸­ï¼Œåé¢åº”ç”¨ç¨‹åºå°±å¯ä»¥è‡ªè¡Œå¤„ç†äº†ï¼›\n  runtime/sigqueue.goï¼šruntime.sigsendã€runtime.signal_recvè¿™ä¸¤ä¸ªå‡½æ•°å¾ˆé‡è¦ï¼Œå‰è€…æ˜¯ç¨‹åºæ”¶åˆ°ç³»ç»Ÿå‘é€æ¥çš„ä¿¡å·æ—¶å°†ä¿¡å·å†™å…¥outgoing sigqueueä¸­ï¼Œå…¶å®å°±æ˜¯sigç»“æ„ä½“çš„maskå­—æ®µï¼Œåé¢signal_recvçš„æ—¶å€™ä¹Ÿæ˜¯ä»è¯¥maskå­—æ®µè¯»å–ï¼Œå¹¶å†™å…¥recvå­—æ®µä¸­ï¼Œrecvä¸­é0çš„åº”è¯¥å°±æ˜¯è¡¨ç¤ºæ”¶åˆ°äº†ä¿¡å·ï¼ˆä¿¡å·ç¼–å·ä¸ºç´¢å¼•å€¼ï¼‰ï¼›\n  runtime/signal_unix.goï¼šæœ‰ä¸ªå‡½æ•°sighandlerï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£å¯¹ä¸åŒçš„ä¿¡å·æ‰§è¡Œä¸åŒçš„å¤„ç†ï¼Œæ¯”å¦‚æŠ¢å å¼è°ƒåº¦SIGURGçš„å¤„ç†ï¼Œæ¯”å¦‚SIGPROFçš„å¤„ç†ï¼Œæ¯”å¦‚æˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„ä¸€äº›å¼‚æ­¥ä¿¡å·çš„å¤„ç†sigsendã€‚åœ¨goç¨‹åºä¸­ä¸ç®¡æ˜¯ä»€ä¹ˆä¿¡å·ï¼Œè¿™äº›ä¿¡å·æ˜¯åœ¨sighandleråšä¸åŒå¤„ç†ã€‚sighandlerè™½ç„¶åå­—æ˜¯ä¿¡å·å¤„ç†å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†é€šè¿‡setsigå°†æ‰€æœ‰ä¿¡å·å…¨éƒ¨è®¾ç½®sighandlerä¸ºä¿¡å·å¤„ç†å‡½æ•°ï¼Œä½†æ˜¯å…¶å®è¿™åªæ˜¯è¡¨ç°ã€‚setsigå‡½æ•°å†…éƒ¨åˆåšäº†ä¸€ä¸ªè½¬æ¢ï¼Œå°†ä¿¡å·çš„ä¿¡å·å¤„ç†å‡½æ•°è®¾ç½®ä¸ºäº†sigtrampæ´»ç€cgosigtrampï¼Œè¿™äº›å‡½æ•°å†…éƒ¨åˆè°ƒç”¨sighandlerã€‚ä¸‹é¢ä¼šæåˆ°sigtrampçš„é€»è¾‘ï¼›\n  runtime/runtime2.goï¼šè¿™é‡Œå®šä¹‰äº†GMPè°ƒåº¦æ¨¡å‹ä¸­çš„mï¼ŒmåŒ…å«ä¸€ä¸ªæˆå‘˜gsignalï¼Œå®ƒè¡¨ç¤ºä¿¡å·å¤„ç†ç”¨çš„goroutineã€‚os_linux.goä¸­mpreinitä¼šä¸ºåˆ›å»ºä¸€ä¸ªgoroutineï¼Œåç¨‹æ ˆè¢«åˆå§‹åŒ–ä¸€ä¸ª32KBå¤§å°çš„ä¿¡å·å¤„ç†æ ˆï¼Œå¾ˆå¤§è¿™æ˜¯ä¸ºäº†å…¼å®¹ä¸åŒæ“ä½œç³»ç»Ÿçš„ä¸€äº›é—®é¢˜ï¼Œlinuxè¦â‰¥2KBï¼ŒOSXè¦â‰¥8KB\u0026hellip;\n  sigtrampæ˜¯æ³¨å†Œåˆ°æ“ä½œç³»ç»Ÿçš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå½“æ“ä½œç³»ç»Ÿæ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶æ£€æŸ¥è¿›ç¨‹æœ‰æ²¡æœ‰ä¿¡å·åˆ°è¾¾ï¼Œæœ‰å¹¶ä¸”æ²¡æœ‰å±è”½ä¿¡å·åˆ™æ‰§è¡Œå¯¹åº”çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯åˆ‡åˆ°äº†ç”¨æˆ·æ€å»æ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•°ã€‚åœ¨æ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•°çš„æ—¶å€™æ¯”è¾ƒç‰¹æ®Šï¼Œgoéœ€è¦ä¸ºä¿¡å·å¤„ç†å‡½æ•°å‡†å¤‡ä¸€ä¸ªä¸åŒçš„æ ˆå¸§ï¼Œå³ä¿¡å·å¤„ç†æ ˆï¼Œè¿™ä¸ªå‰é¢æè¿‡äº†æ˜¯ä¸€ä¸ª32KBå¤§å°çš„æ ˆï¼Œç„¶åå°†å½“å‰m.gè®¾ç½®ä¸ºgsignalï¼ˆæ ˆå¤§å°ä¸º32KBï¼‰ï¼Œæ ˆå‡†å¤‡å¥½ä¹‹åï¼Œæ‰§è¡Œå‰é¢æè¿‡çš„sighandleræ‰§è¡Œä¿¡å·å¤„ç†ï¼Œå¤„ç†å®Œæˆè¿”å›åï¼Œå†å°†m.gè®¾ç½®ä¸ºåŸæ¥çš„gæ¢å¤æ­£å¸¸æ‰§è¡Œã€‚å…¶å®signhandleræ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œsigsendå‘é€åˆ°outgoing sigqueueï¼Œç„¶åsignal_recvæ”¶ä¿¡å·å‘é€åˆ°os.Notifyè®¢é˜…çš„chanï¼Œå°±å®Œäº‹äº†ï¼Œåé¢å°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„chan readå¹¶å¤„ç†é€»è¾‘äº†ã€‚\n  ç®—æ˜¯ä»‹ç»çš„æ¯”è¾ƒè¯¦ç»†äº†å§ï¼Œç¯‡å¹…ã€æ—¶é—´åŸå› å°±ä¸è´´æºç äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å¯¹ç€æåŠçš„æºç ä»”ç»†çœ‹çœ‹ã€æ±‚è¯ä¸€ä¸‹ã€‚\n"}),a.add({id:149,href:"/tags/signal/",title:"signal",description:"",content:""}),a.add({id:150,href:"/tags/goroutine/",title:"goroutine",description:"",content:""}),a.add({id:151,href:"/blog/2021-05-24-how-goroutine-created-and-started/",title:"how goroutine created and started",description:"goroutineåˆ›å»ºï¼šruntime.newproc(siz int32, fn *funcval)\n go fn()ï¼Œä¼ é€’ç»™fnçš„å‚æ•°å®é™…ä¸Šæ˜¯ç´§è·Ÿç€å­˜åœ¨fnå‹æ ˆåçš„åœ°å€åé¢ï¼Œåœ¨newproc1çš„æ ˆå¸§é‡Œé¢ï¼Œä½†æ˜¯ä¸å‡ºç°åœ¨ç­¾åå‚æ•°åˆ—è¡¨ä¸­ï¼Œå› ä¸ºè¿™äº›å‚æ•°ç±»å‹ã€æ•°é‡ä¸ä¸€æ ·ï¼Œä¹Ÿæ— æ³•å‡ºç°åœ¨ç­¾åå‚æ•°åˆ—è¡¨ä¸­ï¼› newproc1åˆ›å»ºgï¼› getg().m.p.ptr()æ‹¿åˆ°å½“å‰pï¼› runqputå°†å½“å‰gæ”¾å…¥pçš„local queueä¸­ï¼Œå¦‚æœæ»¡åˆ™æ”¾åˆ°global queueä¸­ï¼› gç­‰å¾…è¢«è°ƒåº¦å™¨è°ƒåº¦æ‰§è¡Œï¼›  å¤§è‡´åˆ›å»ºæ‰§è¡Œgoroutineçš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œä¸‹é¢çš„é€»è¾‘éƒ½æ˜¯åˆ‡åˆ°ç³»ç»Ÿæ ˆä¸Šå»æ‰§è¡Œçš„ã€‚\n1 newproc1é€»è¾‘\næŸ¥çœ‹æºç å‘ç°ï¼Œgoroutineåˆå§‹åˆ›å»ºæ—¶å¯¹å‡½æ•°å‚æ•°å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼Œå¦‚æœå‚æ•°å å†…å­˜ç©ºé—´å¾ˆå¤§ï¼Œæ¯”å¦‚è¶…è¿‡åˆå§‹æ ˆå¸§å¤§å°2KBï¼Œé‚£ä¹ˆgoroutineåˆ›å»ºä¼šå¤±è´¥ï¼š\u0026ldquo;fatal error: newproc: function arguments too large for new goroutine\u0026rdquo;ï¼Œæ¯”å¦‚ï¼Œgo func(a [1024]int) {}([1024]int{})ã€‚\næ¯ä¸ªpå†…éƒ¨éƒ½æœ‰ä¸€ä¸ªç©ºé—²goroutineé˜Ÿåˆ—gFreeï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥æ‰§è¡Œfnçš„goroutineï¼Œæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œä¸ç”¨çš„æ—¶å€™å¯ä»¥ä¸¢ç»™è°ƒåº¦å™¨schedt.gFreeä¾›å…¶ä»–på¤ç”¨ã€‚è¿™é‡Œç©ºé—²çš„goroutinesï¼Œä¸€éƒ¨åˆ†å­˜åœ¨äºp.gFreeï¼Œå¦‚æœgfput(p, gp)æ—¶å‘ç°p.gFreeé˜Ÿåˆ—å¤ªé•¿è¯´æ˜è¿‡å‰©äº†ï¼Œå°±è½¬ç§»ä¸€éƒ¨åˆ†åˆ°è°ƒåº¦å™¨schedt.gFreeä¸­ä¾›å…¶ä»–på¤ç”¨ã€‚\ngoroutineæ‰§è¡Œå®Œæ¯•åè¿è¡Œæ—¶å¹¶ä¸æ€¥äºå°†å…¶é”€æ¯ï¼Œè€Œæ˜¯ä¼šè€ƒè™‘goroutineçš„å¤ç”¨ï¼Œgfputï¼Œå‰é¢æè¿‡äº†ã€‚å¸Œæœ›go func()é€šè¿‡åç¨‹æ‰§è¡Œæ—¶ï¼Œä¹Ÿä¸å¿…æ¯æ¬¡åˆ›å»ºæ–°çš„goroutineï¼Œgfgetï¼Œå¯ä»¥å¤ç”¨p.gFreeä¸­çš„goroutineï¼Œå¦‚æœp.gFreeç©ºæˆ–è€…è¿‡å°‘ï¼ˆ32ï¼‰ä¸”è°ƒåº¦å™¨schedt.gFreeä¸­æœ‰ç©ºé—²ï¼Œåˆ™è½¬ç§»ä¸€éƒ¨åˆ†è¿‡æ¥ç»™på¤ç”¨ã€‚ä½†æ˜¯goroutineçš„æ ˆæœ‰å¯èƒ½ä¼šè¢«é”€æ¯ï¼Œå¦‚æœå¤ç”¨åˆ°æ ˆè¢«é”€æ¯çš„goroutineå°±éœ€è¦stackallocé‡æ–°ä¸ºå…¶åˆ†é…æ–°æ ˆå¸§ã€‚\nå¦‚æœæ²¡æœ‰ç©ºé—²çš„gå¯ä¾›å¤ç”¨ï¼Œé‚£å°±åªèƒ½malgä»å¤´æ–°å»ºä¸€ä¸ªgoroutineäº†ã€‚\ngoroutineåˆ›å»ºæˆåŠŸã€æ ˆç©ºé—´ä¹Ÿokäº†ä¹‹åï¼Œå°±è¦æŠŠgoroutineè¦æ‰§è¡Œçš„å‡½æ•°å¯¹åº”çš„å‡½æ•°å‚æ•°ç»™æ‹·è´åˆ°è¿™ä¸ªæ ˆç©ºé—´é‡Œé¢æ¥ï¼Œé€šè¿‡memmove(spArg, argp, uintptr(narg))æ¥å®Œæˆã€‚å®Œæˆåè°ƒæ•´newgçš„è°ƒåº¦ä¸Šä¸‹æ–‡ç›¸å…³çš„å¯„å­˜å™¨å€¼ï¼Œç­‰è°ƒåº¦å™¨è°ƒåº¦å®ƒæ—¶ï¼Œè¿˜åŸå…¶ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œpcå°±æŒ‡å‘å…¶å¯¹åº”çš„å‡½æ•°åœ°å€äº†ï¼Œå¯¹åº”çš„æ•°æ®ä¹Ÿä¼šæŒ‡å‘å…¶å¯¹åº”çš„æ ˆç©ºé—´ã€‚\nç„¶åï¼Œé€šè¿‡gostartcallfnâ†’gostartcall(buf, fn, ctxt)ï¼Œä¹‹å‰å·²ç»æ‹·è´äº†å‡½æ•°fnçš„å‚æ•°åˆ°goroutineæ ˆç©ºé—´äº†ï¼Œè¿™é‡Œé¢å†ç»§ç»­åœ¨æ ˆå†…è®¾ç½®fnè¿”å›åœ°å€ã€gobuf.sp+gobuf.pcä¿¡æ¯ã€‚\nä¸Šè¿°è°ƒæ•´å®Œæˆä¹‹åï¼Œå°†goroutineçš„çŠ¶æ€ä»_Gdeadè°ƒæ•´ä¸º_Grunnableï¼Œç­‰å¾…è°ƒåº¦å™¨è°ƒåº¦ã€‚æ–°åˆ›å»ºçš„æ—¶å€™å…¶çŠ¶æ€æ˜¯_Gidleï¼Œä¸€å®šä¼šå°†å…¶è°ƒæ•´ä¸º_Gdeadç„¶åå†è¿›è¡Œä¸Šè¿°å‡†å¤‡å·¥ä½œï¼Œä¸€åˆ‡å°±ç»ªåæ‰è°ƒæ•´ä¸º_Grunnableè®©å…¶å‚ä¸è°ƒåº¦ã€‚\n2 runqput(p, gp, next) è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼Œå¸Œæœ›å°†gpæ”¾åˆ°pçš„local queueä¸­ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¤´æ’ã€å°¾æ’ä¸¤ç§æ–¹å¼ã€‚\n å¦‚æœnextä¸ºtrueï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å¤´æ’ï¼Œå…¶å®æ˜¯æ”¾åˆ°p.runnextä¸­ï¼Œæ¯”p.queueä¸­çš„å¾—åˆ°ä¼˜å…ˆè°ƒåº¦ã€‚å¦‚æœä¹‹å‰p.runnextæœ‰å€¼ï¼Œè¿˜è¦è¯¥å€¼å¯¹åº”çš„gæ”¾å…¥p.queueä¸­ï¼› å¦‚æœnextä¸ºfalseï¼Œåˆ™å°è¯•å°†å…¶æ”¾ç½®åˆ°p.queueä¸­ï¼Œè¿™é‡Œä¹Ÿæœ‰å¿«æ…¢ä¸¤ç§æƒ…å†µï¼Œå¿«çš„æƒ…å†µå°±æ˜¯ï¼Œå› ä¸ºp.queueè¿™ä¸ªæœ¬åœ°é˜Ÿåˆ—é•¿åº¦æœ€å¤§ä¸º256ï¼Œå¦‚æœæœ‰ç©ºä½™ä½ç½®æ”¾å…¥å°±è¿”å›ï¼Œè¿™æ˜¯å¿«çš„æƒ…å†µã€‚æ…¢çš„æƒ…å†µå°±æ˜¯å¦‚æœp.queueæ»¡äº†å°±è¦å…ˆè½¬ç§»1/2åˆ°è°ƒåº¦å™¨å…¨å±€é˜Ÿåˆ—schedt.queueä¸­ï¼Œç„¶åå†æ”¾å…¥ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ…¢ä¸€äº›ã€‚  æ”¾ç½®è¿‡ç¨‹ä¸­ï¼Œå¦‚æœp.runqueueæ»¡äº†æ€ä¹ˆåŠï¼Œå°†å…¶æ”¾ç½®åˆ°è°ƒåº¦å™¨schedt.queueè¿™ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­ã€‚\n3 wakeup()é€»è¾‘\nè¿™ä¸ªå‡½æ•°å†…éƒ¨æ‰§è¡Œstartm(p, spinning)ï¼Œæ¥æ‰¾ä¸€ä¸ªmæ¥æ‰§è¡Œgoroutineï¼Œå…·ä½“æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ\n  å¦‚æœæ²¡æœ‰æŒ‡å®špï¼Œæ¯”å¦‚æ–°å»ºgoroutineæ—¶ï¼Œæ­¤æ—¶ä¼šå°è¯•æ£€æŸ¥æœ‰æ²¡æœ‰ç©ºé—²çš„pï¼Œæ²¡æœ‰çš„è¯å°±ç›´æ¥è¿”å›äº†ï¼Œç›¸å½“äºå½“å‰ä¸€æ¬¡æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåªèƒ½ä¸‹æ¬¡è°ƒåº¦çš„æ—¶å€™å†æ‰§è¡Œè¿™ä¸ªæ–°å»ºçš„goroutineäº†ï¼›\n  ç°åœ¨æœ‰ç©ºé—²çš„pï¼Œæˆ‘ä»¬è¿˜ç¼ºä»€ä¹ˆï¼Œmï¼ç„¶åmgetæ‰¾ä¸€ä¸ªç©ºé—²çš„mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±newmåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡cloneç³»ç»Ÿè°ƒç”¨åˆ›å»ºçš„æ–°çš„çº¿ç¨‹ã€‚ç„¶åå°†è¿™ä¸ªmå’Œè¿™ä¸ªpå…³è”èµ·æ¥ï¼Œm.nextp = pã€‚å€¼å¾—ä¸€æçš„æ˜¯cloneå‡ºæ¥çš„çº¿ç¨‹å¯¹åº”çš„çº¿ç¨‹å¤„ç†å‡½æ•°æ˜¯mstartï¼Œmstartä½¿ç”¨æ±‡ç¼–å†™çš„ï¼Œå†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯mstart0ï¼Œå®ƒå†…éƒ¨åˆè¯·æ±‚mstart1ï¼Œè·å–å½“å‰gï¼š\n  å¦‚æœg.m==\u0026amp;m0ï¼Œåˆ™æ‰§è¡Œmstartm0å®Œæˆä¿¡å·å¤„ç†æ³¨å†Œï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–ï¼›\n  è·å–å½“å‰m.",content:"goroutineåˆ›å»ºï¼šruntime.newproc(siz int32, fn *funcval)\n go fn()ï¼Œä¼ é€’ç»™fnçš„å‚æ•°å®é™…ä¸Šæ˜¯ç´§è·Ÿç€å­˜åœ¨fnå‹æ ˆåçš„åœ°å€åé¢ï¼Œåœ¨newproc1çš„æ ˆå¸§é‡Œé¢ï¼Œä½†æ˜¯ä¸å‡ºç°åœ¨ç­¾åå‚æ•°åˆ—è¡¨ä¸­ï¼Œå› ä¸ºè¿™äº›å‚æ•°ç±»å‹ã€æ•°é‡ä¸ä¸€æ ·ï¼Œä¹Ÿæ— æ³•å‡ºç°åœ¨ç­¾åå‚æ•°åˆ—è¡¨ä¸­ï¼› newproc1åˆ›å»ºgï¼› getg().m.p.ptr()æ‹¿åˆ°å½“å‰pï¼› runqputå°†å½“å‰gæ”¾å…¥pçš„local queueä¸­ï¼Œå¦‚æœæ»¡åˆ™æ”¾åˆ°global queueä¸­ï¼› gç­‰å¾…è¢«è°ƒåº¦å™¨è°ƒåº¦æ‰§è¡Œï¼›  å¤§è‡´åˆ›å»ºæ‰§è¡Œgoroutineçš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œä¸‹é¢çš„é€»è¾‘éƒ½æ˜¯åˆ‡åˆ°ç³»ç»Ÿæ ˆä¸Šå»æ‰§è¡Œçš„ã€‚\n1 newproc1é€»è¾‘\næŸ¥çœ‹æºç å‘ç°ï¼Œgoroutineåˆå§‹åˆ›å»ºæ—¶å¯¹å‡½æ•°å‚æ•°å¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼Œå¦‚æœå‚æ•°å å†…å­˜ç©ºé—´å¾ˆå¤§ï¼Œæ¯”å¦‚è¶…è¿‡åˆå§‹æ ˆå¸§å¤§å°2KBï¼Œé‚£ä¹ˆgoroutineåˆ›å»ºä¼šå¤±è´¥ï¼š\u0026ldquo;fatal error: newproc: function arguments too large for new goroutine\u0026rdquo;ï¼Œæ¯”å¦‚ï¼Œgo func(a [1024]int) {}([1024]int{})ã€‚\næ¯ä¸ªpå†…éƒ¨éƒ½æœ‰ä¸€ä¸ªç©ºé—²goroutineé˜Ÿåˆ—gFreeï¼Œè¿™ä¸ªå°±æ˜¯ç”¨æ¥æ‰§è¡Œfnçš„goroutineï¼Œæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œä¸ç”¨çš„æ—¶å€™å¯ä»¥ä¸¢ç»™è°ƒåº¦å™¨schedt.gFreeä¾›å…¶ä»–på¤ç”¨ã€‚è¿™é‡Œç©ºé—²çš„goroutinesï¼Œä¸€éƒ¨åˆ†å­˜åœ¨äºp.gFreeï¼Œå¦‚æœgfput(p, gp)æ—¶å‘ç°p.gFreeé˜Ÿåˆ—å¤ªé•¿è¯´æ˜è¿‡å‰©äº†ï¼Œå°±è½¬ç§»ä¸€éƒ¨åˆ†åˆ°è°ƒåº¦å™¨schedt.gFreeä¸­ä¾›å…¶ä»–på¤ç”¨ã€‚\ngoroutineæ‰§è¡Œå®Œæ¯•åè¿è¡Œæ—¶å¹¶ä¸æ€¥äºå°†å…¶é”€æ¯ï¼Œè€Œæ˜¯ä¼šè€ƒè™‘goroutineçš„å¤ç”¨ï¼Œgfputï¼Œå‰é¢æè¿‡äº†ã€‚å¸Œæœ›go func()é€šè¿‡åç¨‹æ‰§è¡Œæ—¶ï¼Œä¹Ÿä¸å¿…æ¯æ¬¡åˆ›å»ºæ–°çš„goroutineï¼Œgfgetï¼Œå¯ä»¥å¤ç”¨p.gFreeä¸­çš„goroutineï¼Œå¦‚æœp.gFreeç©ºæˆ–è€…è¿‡å°‘ï¼ˆ32ï¼‰ä¸”è°ƒåº¦å™¨schedt.gFreeä¸­æœ‰ç©ºé—²ï¼Œåˆ™è½¬ç§»ä¸€éƒ¨åˆ†è¿‡æ¥ç»™på¤ç”¨ã€‚ä½†æ˜¯goroutineçš„æ ˆæœ‰å¯èƒ½ä¼šè¢«é”€æ¯ï¼Œå¦‚æœå¤ç”¨åˆ°æ ˆè¢«é”€æ¯çš„goroutineå°±éœ€è¦stackallocé‡æ–°ä¸ºå…¶åˆ†é…æ–°æ ˆå¸§ã€‚\nå¦‚æœæ²¡æœ‰ç©ºé—²çš„gå¯ä¾›å¤ç”¨ï¼Œé‚£å°±åªèƒ½malgä»å¤´æ–°å»ºä¸€ä¸ªgoroutineäº†ã€‚\ngoroutineåˆ›å»ºæˆåŠŸã€æ ˆç©ºé—´ä¹Ÿokäº†ä¹‹åï¼Œå°±è¦æŠŠgoroutineè¦æ‰§è¡Œçš„å‡½æ•°å¯¹åº”çš„å‡½æ•°å‚æ•°ç»™æ‹·è´åˆ°è¿™ä¸ªæ ˆç©ºé—´é‡Œé¢æ¥ï¼Œé€šè¿‡memmove(spArg, argp, uintptr(narg))æ¥å®Œæˆã€‚å®Œæˆåè°ƒæ•´newgçš„è°ƒåº¦ä¸Šä¸‹æ–‡ç›¸å…³çš„å¯„å­˜å™¨å€¼ï¼Œç­‰è°ƒåº¦å™¨è°ƒåº¦å®ƒæ—¶ï¼Œè¿˜åŸå…¶ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œpcå°±æŒ‡å‘å…¶å¯¹åº”çš„å‡½æ•°åœ°å€äº†ï¼Œå¯¹åº”çš„æ•°æ®ä¹Ÿä¼šæŒ‡å‘å…¶å¯¹åº”çš„æ ˆç©ºé—´ã€‚\nç„¶åï¼Œé€šè¿‡gostartcallfnâ†’gostartcall(buf, fn, ctxt)ï¼Œä¹‹å‰å·²ç»æ‹·è´äº†å‡½æ•°fnçš„å‚æ•°åˆ°goroutineæ ˆç©ºé—´äº†ï¼Œè¿™é‡Œé¢å†ç»§ç»­åœ¨æ ˆå†…è®¾ç½®fnè¿”å›åœ°å€ã€gobuf.sp+gobuf.pcä¿¡æ¯ã€‚\nä¸Šè¿°è°ƒæ•´å®Œæˆä¹‹åï¼Œå°†goroutineçš„çŠ¶æ€ä»_Gdeadè°ƒæ•´ä¸º_Grunnableï¼Œç­‰å¾…è°ƒåº¦å™¨è°ƒåº¦ã€‚æ–°åˆ›å»ºçš„æ—¶å€™å…¶çŠ¶æ€æ˜¯_Gidleï¼Œä¸€å®šä¼šå°†å…¶è°ƒæ•´ä¸º_Gdeadç„¶åå†è¿›è¡Œä¸Šè¿°å‡†å¤‡å·¥ä½œï¼Œä¸€åˆ‡å°±ç»ªåæ‰è°ƒæ•´ä¸º_Grunnableè®©å…¶å‚ä¸è°ƒåº¦ã€‚\n2 runqput(p, gp, next) è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼Œå¸Œæœ›å°†gpæ”¾åˆ°pçš„local queueä¸­ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¤´æ’ã€å°¾æ’ä¸¤ç§æ–¹å¼ã€‚\n å¦‚æœnextä¸ºtrueï¼Œå¯ä»¥è®¤ä¸ºæ˜¯å¤´æ’ï¼Œå…¶å®æ˜¯æ”¾åˆ°p.runnextä¸­ï¼Œæ¯”p.queueä¸­çš„å¾—åˆ°ä¼˜å…ˆè°ƒåº¦ã€‚å¦‚æœä¹‹å‰p.runnextæœ‰å€¼ï¼Œè¿˜è¦è¯¥å€¼å¯¹åº”çš„gæ”¾å…¥p.queueä¸­ï¼› å¦‚æœnextä¸ºfalseï¼Œåˆ™å°è¯•å°†å…¶æ”¾ç½®åˆ°p.queueä¸­ï¼Œè¿™é‡Œä¹Ÿæœ‰å¿«æ…¢ä¸¤ç§æƒ…å†µï¼Œå¿«çš„æƒ…å†µå°±æ˜¯ï¼Œå› ä¸ºp.queueè¿™ä¸ªæœ¬åœ°é˜Ÿåˆ—é•¿åº¦æœ€å¤§ä¸º256ï¼Œå¦‚æœæœ‰ç©ºä½™ä½ç½®æ”¾å…¥å°±è¿”å›ï¼Œè¿™æ˜¯å¿«çš„æƒ…å†µã€‚æ…¢çš„æƒ…å†µå°±æ˜¯å¦‚æœp.queueæ»¡äº†å°±è¦å…ˆè½¬ç§»1/2åˆ°è°ƒåº¦å™¨å…¨å±€é˜Ÿåˆ—schedt.queueä¸­ï¼Œç„¶åå†æ”¾å…¥ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ…¢ä¸€äº›ã€‚  æ”¾ç½®è¿‡ç¨‹ä¸­ï¼Œå¦‚æœp.runqueueæ»¡äº†æ€ä¹ˆåŠï¼Œå°†å…¶æ”¾ç½®åˆ°è°ƒåº¦å™¨schedt.queueè¿™ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­ã€‚\n3 wakeup()é€»è¾‘\nè¿™ä¸ªå‡½æ•°å†…éƒ¨æ‰§è¡Œstartm(p, spinning)ï¼Œæ¥æ‰¾ä¸€ä¸ªmæ¥æ‰§è¡Œgoroutineï¼Œå…·ä½“æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ\n  å¦‚æœæ²¡æœ‰æŒ‡å®špï¼Œæ¯”å¦‚æ–°å»ºgoroutineæ—¶ï¼Œæ­¤æ—¶ä¼šå°è¯•æ£€æŸ¥æœ‰æ²¡æœ‰ç©ºé—²çš„pï¼Œæ²¡æœ‰çš„è¯å°±ç›´æ¥è¿”å›äº†ï¼Œç›¸å½“äºå½“å‰ä¸€æ¬¡æ²¡æœ‰æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆåªèƒ½ä¸‹æ¬¡è°ƒåº¦çš„æ—¶å€™å†æ‰§è¡Œè¿™ä¸ªæ–°å»ºçš„goroutineäº†ï¼›\n  ç°åœ¨æœ‰ç©ºé—²çš„pï¼Œæˆ‘ä»¬è¿˜ç¼ºä»€ä¹ˆï¼Œmï¼ç„¶åmgetæ‰¾ä¸€ä¸ªç©ºé—²çš„mï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„ï¼Œå°±newmåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯é€šè¿‡cloneç³»ç»Ÿè°ƒç”¨åˆ›å»ºçš„æ–°çš„çº¿ç¨‹ã€‚ç„¶åå°†è¿™ä¸ªmå’Œè¿™ä¸ªpå…³è”èµ·æ¥ï¼Œm.nextp = pã€‚å€¼å¾—ä¸€æçš„æ˜¯cloneå‡ºæ¥çš„çº¿ç¨‹å¯¹åº”çš„çº¿ç¨‹å¤„ç†å‡½æ•°æ˜¯mstartï¼Œmstartä½¿ç”¨æ±‡ç¼–å†™çš„ï¼Œå†…éƒ¨å®é™…è°ƒç”¨çš„æ˜¯mstart0ï¼Œå®ƒå†…éƒ¨åˆè¯·æ±‚mstart1ï¼Œè·å–å½“å‰gï¼š\n  å¦‚æœg.m==\u0026amp;m0ï¼Œåˆ™æ‰§è¡Œmstartm0å®Œæˆä¿¡å·å¤„ç†æ³¨å†Œï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–ï¼›\n  è·å–å½“å‰m.mstartfnï¼Œå³çº¿ç¨‹å¤„ç†å‡½æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ï¼Œå¦‚æœè¯¥å‡½æ•°ä¼šæ‰§è¡Œç»“æŸé‚£è¿˜è¦ç»§ç»­æ‰§è¡Œï¼›\n  å¦‚æœå½“å‰g.mä¸æ˜¯m0ï¼Œé‚£ä¹ˆè¦å°†g.m.nextpä¸å½“å‰må…³è”èµ·æ¥ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿmæ‰§è¡Œè°ƒåº¦æ—¶ç”¨è¿™ä¸ªpå‘—ï¼Œæ‰§è¡Œå®ƒçš„queueä¸­çš„goroutineå‘—ï¼›\n  æ‰§è¡Œè°ƒåº¦schedule()é€»è¾‘ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨ä¸€æ¬¡å°±æ˜¯æ‰§è¡Œä¸€è½®è°ƒåº¦ï¼Œé€»è¾‘å°±æ˜¯å¯»æ‰¾ä¸€ä¸ªå¯è¿è¡Œçš„goroutineç„¶åæ‰§è¡Œã€‚è¿™ä¸ªå‡½æ•°æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œæœ‰äº›goroutineæ˜¯é€šè¿‡lockOSThreadç»‘å®šäº†æ‰§è¡Œå®ƒçš„çº¿ç¨‹çš„ï¼Œè¿™æ ·çš„goroutineåªèƒ½ç”¨é‚£ä¸ªç»‘å®šçš„mæ¥æ‰§è¡Œï¼Œæœªç»‘å®šçš„åˆ™æ— æ­¤é™åˆ¶ã€‚ lockedgï¼šè¿™ä¸ªscheduleå‡½æ•°å…ˆè·å–å½“å‰gï¼Œå¦‚æœå‘ç°å½“å‰g.m.lockedgä¸ä¸º0ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªgé€šè¿‡lockOSThreadç»‘å®šåˆ°äº†g.mï¼Œè¿™ä¸ªæ—¶å€™å…ˆåœæ‰å½“å‰mï¼Œè®©å…¶æŠŠpäº¤å‡ºæ¥ï¼Œç­‰ä¸‹æ¬¡æœ‰çº¿ç¨‹scheduleé‡Œé¢è°ƒåº¦æ‰§è¡Œlockedgæ—¶å†å”¤é†’è¯¥mï¼Œæ­¤æ—¶mè¢«parkedï¼Œpè¢«ç©ºå‡ºæ¥äº†ã€‚å†è°ƒç”¨execute(lockedg, inheritTime)ï¼Œå°†è¯¥lockedgè®¾ç½®ä¸ºå½“å‰g.m.curgï¼Œå¹¶ä¿®æ”¹è£…æ”¹ä¸º_Grunningï¼Œç„¶åä¸‹é¢gogo(\u0026amp;gp.sched)æ¢å¤è¯¥å¾…æ‰§è¡Œgoroutineçš„ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œä¹‹ï¼Œexecuteå‡½æ•°never returnsã€‚å¯ä»¥æƒ³è±¡ä¸‹ï¼Œå¦‚æœä¸€ä¸ªmæœ‰g lockedï¼Œé‚£ä¹ˆæ¯æ¬¡è°ƒåº¦éƒ½ä¼šå…ˆä¼˜å…ˆæ‰§è¡Œè¯¥goroutineï¼Ÿ å‰©ä¸‹çš„é€»è¾‘ï¼šè·å–å½“å‰g.m.pï¼Œ\u0026hellip;..ä¸€å †æœ‰çš„æ²¡çš„é€»è¾‘ï¼Œä¼šé€šè¿‡findRunnableæ‰¾ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„gæ¥æ‰§è¡Œï¼Œæœ€åä¹Ÿæ˜¯è°ƒç”¨executeæ¥æ‰§è¡Œgpã€‚ netpollerï¼šå€¼å¾—ä¸€æçš„æ˜¯è¿™ä¸ªå‡½æ•°é‡Œé¢ä¼šé€šè¿‡findRunnableæ¥æŸ¥æ‰¾ä¸€ä¸ªå¯æ‰§è¡Œçš„gï¼Œé™¤äº†ä»p.queueã€schedt.queueã€å…¶ä»–p.queueä¸­æ‰¾å¯è¿è¡Œçš„goroutineå¤–ï¼Œä¹ŸåŒ…æ‹¬ä»netpollerä¸­è·å–ç­‰å¾…ç½‘ç»œIOäº‹ä»¶å°±ç»ªçš„gã€‚\n  åˆ°è¿™é‡Œå°±å¯ä»¥ç®—æ˜¯ç»“æŸäº†ï¼Œåˆ°è¿™é‡ŒåŸºæœ¬å°±äº†è§£äº†æ•´ä¸ªgoroutineä»åˆ›å»ºåˆ°æ‰§è¡Œçš„å®Œæ•´é€»è¾‘äº†ã€‚å½“ç„¶è¿™ä¸ªåé¢è¿˜æœ‰ç‚¹é€»è¾‘ï¼Œç›®å‰ä¹Ÿæ²¡ææ‡‚å†™æ¥å¹²å˜›çš„ï¼Œå…ˆä¸ç®¡åé¢è¿™ä¸ªé€»è¾‘å§ã€‚\n ç„¶ånotewakeupå”¤é†’é˜»å¡åœ¨\u0026amp;m.parkä¸Šçš„ä¸€ä¸ªprocï¼Œè¿™ä¸ªæ˜¯åšä»€ä¹ˆå‘¢ï¼Ÿæ„æ€æ˜¯è¯´ï¼Œå¦‚æœä¹‹å‰mæ‰§è¡Œï¼ˆæ‰§è¡ŒæŸä¸ªgoroutineçš„ä»£ç ï¼‰æ—¶ï¼Œå› ä¸ºæŸä¸ªåŸå› é˜»å¡äº†ï¼ˆè¿™ä¸ªåŸå› é€šå¸¸ç”¨ç›®æ ‡å¯¹è±¡çš„äº‹ä»¶åœ°å€æ¥è¡¨ç¤ºï¼Œå¦‚\u0026amp;m.parkï¼‰ï¼Œç°åœ¨è¿™ä¸ªæ¡ä»¶æ»¡è¶³äº†ï¼Œç°åœ¨å°†å…¶å”¤é†’ç»§ç»­æ‰§è¡Œã€‚æˆ‘ä»¬ä¸ç¦æƒ³é—®ï¼Œè¿™é‡Œçš„\u0026amp;m.parkè¡¨ç¤ºçš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ  psï¼šè¿™é‡Œç”¨åˆ°äº†futexæ¥å®ç°è½»é‡çº§åœ°é”è·å–+è·å–å¤±è´¥é˜»å¡ã€é”é‡Šæ”¾+å”¤é†’é˜»å¡çº¿ç¨‹æ“ä½œï¼Œsee https://lwn.net/Articles/360699/ã€‚\n"}),a.add({id:152,href:"/tags/garbage-collector/",title:"garbage collector",description:"",content:""}),a.add({id:153,href:"/tags/gc/",title:"GC",description:"",content:""}),a.add({id:154,href:"/blog/2021-05-01-gogc-prioritizing-low-latency-and-simplicity/",title:"GC: prioritizing low latency and simplicity",description:"go GC å¦‚ä½•å®ç°ä¸€ä¸ªé¢å‘æœªæ¥10å¹´çš„ä½å»¶è¿Ÿã€ç®€æ´çš„åƒåœ¾å›æ”¶å™¨ï¼Œæœ¬æ–‡æ‘˜è‡ªgolangå®˜æ–¹blogï¼Œä»‹ç»äº†goå›¢é˜Ÿé’ˆå¯¹GCæ‰€åšçš„ç³»åˆ—ä¼˜åŒ–",content:"åŸæ–‡åœ°å€ï¼šhttps://blog.golang.org/go15gc\nä»‹ç»äº†å½“å‰è½¯ç¡¬ä»¶å¤§è§„æ¨¡å‘å±•çš„è¶‹åŠ¿ä»¥åŠgo GCéœ€è¦ä¼˜å…ˆè§£å†³çš„é—®é¢˜ï¼šä½å»¶è¿Ÿå’Œç®€å•æ€§ï¼ˆé€šè¿‡ä¸€ä¸ªå‚æ•°å°±å¯ä»¥æ§åˆ¶ï¼Œè€ŒéåƒJVMè°ƒå‚é‚£æ ·ï¼‰ã€‚\ngoå›¢é˜Ÿçš„ç›®æ ‡æ˜¯è®¾è®¡ä¸€ä¸ªé¢å‘æœªæ¥åå¹´çš„åƒåœ¾å›æ”¶å™¨ï¼Œå€Ÿé‰´äº†åå‡ å¹´å‰å‘æ˜çš„ç®—æ³•ã€‚go GCä½¿ç”¨çš„æ˜¯å¹¶å‘ä¸‰è‰²æ ‡è®°æ¸…é™¤ç®—æ³•ï¼ˆconcurrent, tri-color, mark-sweep collectorï¼‰ï¼Œç”±Dijkstraåœ¨1978å¹´æå‡ºã€‚è¯¥ç®—æ³•ä¸ç°åœ¨å¤§å¤šæ•°ä¼ä¸šçº§çš„GCå®ç°ä¸åŒï¼Œä½†æ˜¯goå›¢é˜Ÿè®¤ä¸ºè¯¥ç®—æ³•æ›´é€‚åˆäºç°ä»£ç¡¬ä»¶çš„å‘å±•ï¼Œä¹Ÿæ›´æœ‰åŠ©äºå®ç°ç°ä»£è½¯ä»¶çš„GCä½å»¶è¿Ÿç›®æ ‡ã€‚\nè¯¥GCç®—æ³•ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡åªèƒ½æ˜¯whiteã€greyã€blackä¸­çš„å…¶ä¸­ä¸€ç§ï¼Œheapå¯ä»¥çœ‹åšæ˜¯äº’ç›¸è¿æ¥çš„å¯¹è±¡æ„æˆçš„ä¸€ä¸ªgraphã€‚GCç®—æ³•æµç¨‹æ˜¯ï¼š\n GCå¼€å§‹æ—¶ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯whiteï¼› GCéå†æ‰€æœ‰çš„rootså¯¹è±¡ï¼ˆæ¯”å¦‚å…¨å±€å˜é‡ã€æ ˆå˜é‡ï¼‰å°†å…¶æ ‡è®°ä¸ºç°è‰²ï¼› ç„¶åGCé€‰æ‹©ä¸€ä¸ªgreyå¯¹è±¡ï¼Œå°†å…¶æ ‡è®°ä¸ºblackï¼Œå¹¶æ‰«æï¼ˆscanï¼‰è¯¥å¯¹è±¡æ£€æŸ¥å®ƒå†…éƒ¨çš„æŒ‡å‘å…¶ä»–å¯¹è±¡çš„æŒ‡é’ˆã€‚å¦‚æœå‘ç°æœ‰æŒ‡é’ˆæŒ‡å‘å…¶ä»–whiteå¯¹è±¡ï¼Œå°†whiteå¯¹è±¡æ ‡è®°ä¸ºgreyï¼› è¯¥è¿‡ç¨‹é‡å¤æ‰§è¡Œï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•çš„ç°è‰²å¯¹è±¡ï¼› æœ€åï¼Œå‰©ä¸‹çš„ç™½è‰²å¯¹è±¡å³è®¤ä¸ºæ˜¯ä¸å¯è¾¾å¯¹è±¡ï¼Œå¯ä»¥è¢«å›æ”¶å†åˆ©ç”¨ï¼›  GCè¿‡ç¨‹å’Œåº”ç”¨ç¨‹åºæ‰§è¡Œæ˜¯å¹¶å‘è¿›è¡Œçš„ï¼Œåº”ç”¨ç¨‹åºä¹Ÿç§°ä¸ºmutatorï¼Œå®ƒä¼šåœ¨GCè¿è¡ŒæœŸé—´ä¿®æ”¹ä¸€äº›æŒ‡é’ˆçš„å€¼ã€‚mutatorå¿…é¡»éµå¾ªè¿™æ ·ä¸€æ¡è§„åˆ™ï¼Œå°±æ˜¯ä¸å…è®¸å‡ºç°ä¸€ä¸ªé»‘è‰²å¯¹è±¡æŒ‡å‘ä¸€ä¸ªç™½è‰²å¯¹è±¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´å¯¹è±¡è¢«é”™è¯¯åœ°å›æ”¶ã€‚ä¸ºäº†ä¿è¯è¯¥è§„åˆ™æˆç«‹ï¼Œå°±éœ€è¦å¼•å…¥å†™å±éšœï¼ˆwrite barrierï¼‰ï¼Œå®ƒæ˜¯ç¼–è¯‘é˜¶æ®µç”±ç¼–è¯‘å™¨å¯¹mutatoræŒ‡é’ˆæ“ä½œå®‰æ’çš„ä¸€äº›ç‰¹æ®ŠæŒ‡ä»¤ï¼Œç”¨æ¥è·Ÿè¸ªå¯¹æŒ‡é’ˆçš„ä¿®æ”¹ï¼Œwrite barrierå¦‚æœå‘ç°å½“å‰é»‘è‰²å¯¹è±¡çš„å†…éƒ¨æŒ‡é’ˆå­—æ®µæŒ‡å‘äº†å¤–éƒ¨çš„ä¸€ä¸ªç™½è‰²å¯¹è±¡ï¼Œåˆ™ä¼šå°†ç™½è‰²å¯¹è±¡æŸ“è‰²ä¸ºgreyï¼Œé¿å…å…¶è¢«é”™è¯¯åœ°GCæ‰ï¼Œä¹Ÿä¿è¯å…¶å¯ä»¥è¢«ç»§ç»­æ‰«æã€‚\næœ‰äº›GCç›¸å…³çš„é—®é¢˜ï¼š\n ä»€ä¹ˆæ—¶å€™å¯åŠ¨GCï¼Ÿ é€šè¿‡å“ªäº›æŒ‡æ ‡æ¥åˆ¤æ–­è¦å¯åŠ¨GCï¼Ÿ GCåº”è¯¥å¦‚ä½•ä¸schedulerè¿›è¡Œäº¤äº’ï¼Ÿ å¦‚ä½•æš‚åœä¸€ä¸ªmutatorçº¿ç¨‹è¶³å¤Ÿé•¿æ—¶é—´ï¼Œä»¥æ‰«æå™¨stackï¼Ÿ å¦‚ä½•è¡¨ç¤ºwhiteã€greyå’Œblackä¸‰ç§é¢œè‰²æ¥å®ç°é«˜æ•ˆåœ°æŸ¥æ‰¾ã€æ‰«ægreyå¯¹è±¡ï¼Ÿ å¦‚ä½•çŸ¥é“rootså¯¹è±¡åœ¨å“ªé‡Œï¼Ÿ å¦‚ä½•çŸ¥é“ä¸€ä¸ªæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆçš„ä½ç½®ï¼Ÿ å¦‚ä½•æœ€å°åŒ–å†…å­˜ç¢ç‰‡ï¼Ÿ å¦‚ä½•è§£å†³cacheæ€§èƒ½é—®é¢˜ï¼Ÿ heapåº”è¯¥è®¾ç½®ä¸ºå¤šå¤§ï¼Ÿ ç­‰ç­‰ã€‚  ä¸Šè¿°é—®é¢˜æœ‰äº›ä¸å†…å­˜åˆ†é…æœ‰å…³ï¼Œæœ‰äº›ä¸å¯è¾¾å¯¹è±¡åˆ†ææœ‰å…³ï¼Œæœ‰äº›ä¸goroutineè°ƒåº¦æœ‰å…³ï¼Œæœ‰äº›ä¸æ€§èƒ½æœ‰å…³ï¼Œå…³äºè¿™äº›å†…å®¹çš„è®¨è®ºè¿œè¿œè¶…å‡ºæœ¬æ–‡ç¯‡å¹…ï¼Œå¯ä»¥è‡ªå·±å‚è€ƒç›¸å…³çš„ææ–™ã€‚\nä¸ºäº†è§£å†³GCæ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ä¸ºæ¯ä¸€ç§ä¼˜åŒ–åŠ ä¸ªå‚æ•°æ¥æ§åˆ¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è‡ªå·±è°ƒæ•´è¿™é‡Œçš„å‚æ•°æ¥è¾¾åˆ°æƒ³è¦çš„ä¼˜åŒ–æ•ˆæœã€‚ä½†æ˜¯è¿™ç§åšæ³•æ—¶é—´ä¹…äº†ä¹‹åä¼šå‘ç°æœ‰éå¸¸å¤šçš„å‚æ•°ï¼Œè°ƒä¼˜å°±ä¼šå˜å¾—éå¸¸å›°éš¾ï¼Œæ¯”å¦‚JVMè°ƒä¼˜ã€‚goå›¢é˜Ÿä¸æƒ³èµ°è¿™æ ·çš„è€è·¯ï¼ŒåŠ›æ±‚ç®€å•é«˜æ•ˆã€‚\ngoé€šè¿‡GOGCè¿™ä¸ªç¯å¢ƒå˜é‡æ¥æ§åˆ¶æ•´ä¸ªå †å¤§å°ç›¸å¯¹äºç°é˜¶æ®µå¯è¾¾å¯¹è±¡å¤§å°çš„æ¯”ä¾‹ã€‚GOGCé»˜è®¤å€¼æ˜¯100%ï¼Œæ„å‘³ç€å½“å †å¤§å°å¢é•¿äº†å½“å‰å¯è¾¾å¯¹è±¡å¤§å°çš„1å€æ—¶ï¼ˆ2å€å¤§å°ï¼‰ï¼Œå°±ä¼šè§¦å‘GCï¼›200%åˆ™æ„å‘³ç€ç»§ç»­å¢é•¿äº†å½“å‰å¯è¾¾å¯¹è±¡çš„2å€æ—¶è§¦å‘GCï¼ˆ3å€å¤§å°ï¼‰ã€‚\n å¦‚æœæƒ³é™ä½GCèŠ±è´¹çš„æ—¶é—´ï¼Œå°±æŠŠè¿™ä¸ªå€¼è®¾ç½®çš„å¤§ä¸€ç‚¹ï¼Œå› ä¸ºè¿™æ ·ä¸å®¹æ˜“é¢‘ç¹è§¦å‘GCï¼› å¦‚æœæ„¿æ„èŠ±è´¹æ›´å¤šçš„GCæ—¶é—´æ¥æ¢å–æ›´å°‘çš„å†…å­˜å ç”¨ï¼Œå°±æŠŠè¿™ä¸ªå€¼è®¾ç½®çš„å°ä¸€ç‚¹ï¼Œå› ä¸ºè¿™æ ·èƒ½å¤Ÿæ›´åŠ é¢‘ç¹åœ°GCï¼›  å‰é¢æåˆ°goå›¢é˜Ÿè¦è®¾è®¡ä¸€ä¸ªé¢å‘æœªæ¥åå¹´çš„åƒåœ¾å›æ”¶å™¨ï¼Œæœªæ¥åå¹´æœºå™¨å†…å­˜å®¹é‡å¯èƒ½ä¼šç¿»å€æˆ–è€…æˆå€å¢é•¿ï¼Œç®€å•åœ°å°†GOGCè®¾ç½®ä¸ºä¸€å®šå€ç‡ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°å·¥ä½œï¼Œä¹Ÿä¸ç”¨åƒJVMè°ƒä¼˜é‚£æ ·é‡æ–°è®¾ç½®ä¸€å †åœ°å‚æ•°ï¼Œè°ƒå‚å¤§å†›å¥½æƒ¨ã€‚goå›¢é˜Ÿä¹Ÿå¯ä»¥å€¾å¬ç”¨æˆ·çœŸæ­£åœ°è¯‰æ±‚åœ¨è¿è¡Œæ—¶æ–¹é¢åšæ›´å¤šçš„ä¼˜åŒ–ã€‚\n"}),a.add({id:155,href:"/blog/09%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E5%92%8C%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9/",title:"09æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•ï¼šå¦‚ä½•é€‰æ‹©",description:"å¯¹æ¯”ä¸¤ç§ç±»å‹çš„ç´¢å¼• #  æ™®é€šç´¢å¼•ï¼Œå…è®¸å¤šæ¡è®°å½•ä¸­ç»„æˆç´¢å¼•çš„å­—æ®µå€¼å‡ºç°é‡å¤çš„æƒ…å†µï¼› å”¯ä¸€ç´¢å¼•ï¼Œä¸å…è®¸â€¦â€¦  ä¸¤ç§ç±»å‹ç´¢å¼•å®ç° # è‚¯å®šéƒ½æ˜¯ä¸€æ ·çš„å•Š\nä¸¤ç§ç±»å‹ç´¢å¼•æ•ˆç‡ # æˆ‘ä»¬ä»¥è¡¨userä¸ºä¾‹ï¼š\ncreate table `user` ( id int auto_increment, id_card varchar(64), name varchar(32), primary key(id), [uique|index] (id_card) -- åˆ›å»ºç´¢å¼•ï¼šå”¯ä¸€ç´¢å¼•æˆ–è€…æ™®é€šç´¢å¼• )  å…¶ä¸­id_cardå¯èƒ½æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¹Ÿå¯èƒ½æ˜¯æ™®é€šç´¢å¼•ã€‚\næŸ¥è¯¢æ•ˆç‡ # ä»¥è¿™æ¡æŸ¥è¯¢è¯­å¥ä¸ºä¾‹ï¼šselect name from user where id_card=?\n  æ™®é€šç´¢å¼•çš„æŸ¥è¯¢\né¡ºç€B+æ ‘æ ¹æ®id_cardæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åˆ°ç¬¬ä¸€æ¡è®°å½•ä¹‹åï¼Œå›è¡¨æŸ¥è¯¢å¯¹åº”çš„nameï¼ŒåŠ å…¥ç»“æœé›†ã€‚ç»§ç»­éå†å‘å³çš„æŒ‡é’ˆå¯¹åº”çš„è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€æ¡id_cardä¸åŒ¹é…çš„è®°å½•ä¸ºæ­¢ã€‚å› ä¸ºid_cardè‚¯å®šæ˜¯ä¸é‡å¤çš„ï¼Œæ‰€ä»¥è¿™é‡Œå‘å³çš„åŒ¹é…å¼€é”€é¡¶å¤šä¹Ÿå°±æ˜¯å¤šæ¯”è¾ƒä¸€æ¬¡ã€‚\nå½“ç„¶å¦‚æœåŒ¹é…åˆ°çš„è¿™æ¡è®°å½•å¦‚æœæ˜¯pageçš„æœ€åä¸€æ¡è®°å½•çš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½å‘å³çš„æŸ¥æ‰¾éœ€è¦åŠ è½½å¦ä¸€ä¸ªpageï¼Œè¿™æ˜¯æœ€åçš„æƒ…å†µäº†ã€‚\nå®é™…æƒ…å†µæ˜¯B+æ ‘ç§ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨éå¸¸å¤šçš„keyå’ŒæŒ‡é’ˆï¼ŒçœŸçš„å‡ºç°åŒ¹é…è®°å½•å‡ºç°åœ¨æœ€åä¸€ä¸ªçš„æƒ…å†µéå¸¸å°‘ã€‚\n  å”¯ä¸€ç´¢å¼•çš„æŸ¥è¯¢\næŸ¥æ‰¾è¿‡ç¨‹ä¹Ÿæ˜¯é¡ºç€B+æ ‘æ ¹æ®id_cardæŸ¥è¯¢ï¼Œç„¶åå†å›è¡¨ã€‚åŒºåˆ«æ˜¯å®ƒæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„èŠ‚ç‚¹ä¹‹åå°±åœæ­¢å‘å³çš„æŸ¥æ‰¾äº†ï¼Œå› ä¸ºå®ƒçŸ¥é“æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸å¯èƒ½æœ‰é‡å¤çš„è®°å½•å­˜åœ¨ã€‚\n  æ€§èƒ½å¯¹æ¯”\nçœ‹ä¸Šå»å”¯ä¸€ç´¢å¼•æŸ¥è¯¢æ€§èƒ½ä¼šé«˜ä¸€ç‚¹ï¼Œä½†æ˜¯å‰é¢ä¹Ÿåˆ†æäº†id_cardæœ¬èº«å…·å¤‡å”¯ä¸€æ€§ï¼Œæ™®é€šæŸ¥è¯¢ä¸­è¿™ç§ç»§ç»­å‘å³æŸ¥æ‰¾çš„æ“ä½œå¯¹æ€§èƒ½å½±å“å¼€é”€å¹¶ä¸å¤§ï¼Œå¾®ä¹å…¶å¾®ã€‚æ‰€ä»¥å¯¹äºè¿™ä¸¤ç§ç´¢å¼•ï¼Œå»ºè®®ä½¿ç”¨æ™®é€šç´¢å¼•æ¥ä»£æ›¿å”¯ä¸€ç´¢å¼•ã€‚\n  æ›´æ–°æ•ˆç‡ # æ›´æ–°è¯­å¥ä»¥è¿™ä¸ªä¸ºä¾‹ï¼šupdate user set name=\u0026quot;xxxx\u0026quot; where id_card=?\n  change buffer\nåœ¨mysqlæ‰§è¡Œæ•°æ®æ›´æ–°æ—¶ï¼Œä¼šå…ˆå†™redo logï¼Œç„¶åæ”¶åˆ°okåå‡†å¤‡æ›´æ–°æ•°æ®ã€‚è¿™ä¸ªè¦æ›´æ–°çš„è¡Œå¯¹åº”çš„é¡µæ•°æ®å¦‚æœåœ¨å†…å­˜ä¸­ï¼Œåˆ™ç›´æ¥æ›´æ–°å†…å†…å­˜ä¸­çš„ç›¸åº”å­—æ®µå°±å¯ä»¥äº†ã€‚",content:"å¯¹æ¯”ä¸¤ç§ç±»å‹çš„ç´¢å¼• #  æ™®é€šç´¢å¼•ï¼Œå…è®¸å¤šæ¡è®°å½•ä¸­ç»„æˆç´¢å¼•çš„å­—æ®µå€¼å‡ºç°é‡å¤çš„æƒ…å†µï¼› å”¯ä¸€ç´¢å¼•ï¼Œä¸å…è®¸â€¦â€¦  ä¸¤ç§ç±»å‹ç´¢å¼•å®ç° # è‚¯å®šéƒ½æ˜¯ä¸€æ ·çš„å•Š\nä¸¤ç§ç±»å‹ç´¢å¼•æ•ˆç‡ # æˆ‘ä»¬ä»¥è¡¨userä¸ºä¾‹ï¼š\ncreate table `user` ( id int auto_increment, id_card varchar(64), name varchar(32), primary key(id), [uique|index] (id_card) -- åˆ›å»ºç´¢å¼•ï¼šå”¯ä¸€ç´¢å¼•æˆ–è€…æ™®é€šç´¢å¼• )  å…¶ä¸­id_cardå¯èƒ½æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¹Ÿå¯èƒ½æ˜¯æ™®é€šç´¢å¼•ã€‚\næŸ¥è¯¢æ•ˆç‡ # ä»¥è¿™æ¡æŸ¥è¯¢è¯­å¥ä¸ºä¾‹ï¼šselect name from user where id_card=?\n  æ™®é€šç´¢å¼•çš„æŸ¥è¯¢\né¡ºç€B+æ ‘æ ¹æ®id_cardæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åˆ°ç¬¬ä¸€æ¡è®°å½•ä¹‹åï¼Œå›è¡¨æŸ¥è¯¢å¯¹åº”çš„nameï¼ŒåŠ å…¥ç»“æœé›†ã€‚ç»§ç»­éå†å‘å³çš„æŒ‡é’ˆå¯¹åº”çš„è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€æ¡id_cardä¸åŒ¹é…çš„è®°å½•ä¸ºæ­¢ã€‚å› ä¸ºid_cardè‚¯å®šæ˜¯ä¸é‡å¤çš„ï¼Œæ‰€ä»¥è¿™é‡Œå‘å³çš„åŒ¹é…å¼€é”€é¡¶å¤šä¹Ÿå°±æ˜¯å¤šæ¯”è¾ƒä¸€æ¬¡ã€‚\nå½“ç„¶å¦‚æœåŒ¹é…åˆ°çš„è¿™æ¡è®°å½•å¦‚æœæ˜¯pageçš„æœ€åä¸€æ¡è®°å½•çš„è¯ï¼Œé‚£ä¹ˆå¯èƒ½å‘å³çš„æŸ¥æ‰¾éœ€è¦åŠ è½½å¦ä¸€ä¸ªpageï¼Œè¿™æ˜¯æœ€åçš„æƒ…å†µäº†ã€‚\nå®é™…æƒ…å†µæ˜¯B+æ ‘ç§ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨éå¸¸å¤šçš„keyå’ŒæŒ‡é’ˆï¼ŒçœŸçš„å‡ºç°åŒ¹é…è®°å½•å‡ºç°åœ¨æœ€åä¸€ä¸ªçš„æƒ…å†µéå¸¸å°‘ã€‚\n  å”¯ä¸€ç´¢å¼•çš„æŸ¥è¯¢\næŸ¥æ‰¾è¿‡ç¨‹ä¹Ÿæ˜¯é¡ºç€B+æ ‘æ ¹æ®id_cardæŸ¥è¯¢ï¼Œç„¶åå†å›è¡¨ã€‚åŒºåˆ«æ˜¯å®ƒæ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„èŠ‚ç‚¹ä¹‹åå°±åœæ­¢å‘å³çš„æŸ¥æ‰¾äº†ï¼Œå› ä¸ºå®ƒçŸ¥é“æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œä¸å¯èƒ½æœ‰é‡å¤çš„è®°å½•å­˜åœ¨ã€‚\n  æ€§èƒ½å¯¹æ¯”\nçœ‹ä¸Šå»å”¯ä¸€ç´¢å¼•æŸ¥è¯¢æ€§èƒ½ä¼šé«˜ä¸€ç‚¹ï¼Œä½†æ˜¯å‰é¢ä¹Ÿåˆ†æäº†id_cardæœ¬èº«å…·å¤‡å”¯ä¸€æ€§ï¼Œæ™®é€šæŸ¥è¯¢ä¸­è¿™ç§ç»§ç»­å‘å³æŸ¥æ‰¾çš„æ“ä½œå¯¹æ€§èƒ½å½±å“å¼€é”€å¹¶ä¸å¤§ï¼Œå¾®ä¹å…¶å¾®ã€‚æ‰€ä»¥å¯¹äºè¿™ä¸¤ç§ç´¢å¼•ï¼Œå»ºè®®ä½¿ç”¨æ™®é€šç´¢å¼•æ¥ä»£æ›¿å”¯ä¸€ç´¢å¼•ã€‚\n  æ›´æ–°æ•ˆç‡ # æ›´æ–°è¯­å¥ä»¥è¿™ä¸ªä¸ºä¾‹ï¼šupdate user set name=\u0026quot;xxxx\u0026quot; where id_card=?\n  change buffer\nåœ¨mysqlæ‰§è¡Œæ•°æ®æ›´æ–°æ—¶ï¼Œä¼šå…ˆå†™redo logï¼Œç„¶åæ”¶åˆ°okåå‡†å¤‡æ›´æ–°æ•°æ®ã€‚è¿™ä¸ªè¦æ›´æ–°çš„è¡Œå¯¹åº”çš„é¡µæ•°æ®å¦‚æœåœ¨å†…å­˜ä¸­ï¼Œåˆ™ç›´æ¥æ›´æ–°å†…å†…å­˜ä¸­çš„ç›¸åº”å­—æ®µå°±å¯ä»¥äº†ã€‚\nå¦‚æœè¿™ä¸ªæ•°æ®æ²¡æœ‰åœ¨binlogä¸­ï¼Œä¹Ÿä¸ä¼šç«‹å³å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯ä»ä»ç£ç›˜åŠ è½½é€Ÿåº¦æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥å¯ä»¥å°†ä¸€äº›æ›´æ–°æ“ä½œï¼Œè®°å½•åˆ°change bufferä¸­ã€‚åé¢æœ‰è¯»æ•°æ®è¯·æ±‚ç­‰ç­‰æ—¶ï¼Œä¼šè§¦å‘ä»ç£ç›˜åŠ è½½æ–‡ä»¶ï¼ŒåŠ è½½æˆåŠŸåå†åº”ç”¨change bufferä¸­çš„æ•°æ®ã€‚\n  æ™®é€šç´¢å¼•æ›´æ–°\næ™®é€šç´¢å¼•æ›´æ–°çš„æ—¶å€™ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ä¸Šè¿°è¯´çš„è¿‡ç¨‹ï¼Œå®ƒæ˜¯å¯ä»¥ä½¿ç”¨change bufferçš„ã€‚\n  å”¯ä¸€ç´¢å¼•æ›´æ–°\nå”¯ä¸€ç´¢å¼•ï¼Œè¿™é‡Œçš„å”¯ä¸€æ„å‘³ç€æ¯æ¬¡æ“ä½œéƒ½è¦åˆ¤æ–­æ˜¯å¦ä¼šè¿åå”¯ä¸€æ€§è¿™ä¸ªçº¦æŸã€‚æ¯”å¦‚è¦æ’å…¥ä¸€è¡Œæ•°æ®(1,\u0026lsquo;id_card\u0026rsquo;,100)ï¼Œå°±è¦åˆ¤æ–­æ˜¯å¦å·²ç»æœ‰å°†â€œid_cardâ€å†™å…¥çš„è®°å½•ã€‚\nç±»ä¼¼åœ°ï¼Œè¦å¯¹id_card=\u0026lsquo;xxx\u0026rsquo;çš„è®°å½•åšæ›´æ–°ï¼Œå°±è¦èƒ½å¤Ÿæ‰¾åˆ°id_cardå¯¹åº”çš„è¡Œæ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ç›®æ ‡è¡Œæ•°è‚¯å®šæ˜¯è¦åŠ è½½åˆ°å†…å­˜ä¸­çš„ï¼Œæ‰€ä»¥å¯¹åº”çš„é¡µä¸€å®šåœ¨å†…å­˜ä¸­ã€‚\nè¿™ç§æƒ…å†µä¸‹ç›´æ¥æ›´æ–°å†…å­˜è‚¯å®šæ¯”æ›´æ–°change bufferè¦å¿«äº†ï¼Œchange bufferè¿˜å—é™äºbuffer poolå¤§å°æœºå™¨è®¾å®šçš„å¯å buffer poolçš„æ¯”ä¾‹å‘¢ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹å°±æ²¡å¿…è¦ä½¿ç”¨change bufferäº†ã€‚\næ‰€ä»¥å”¯ä¸€ç´¢å¼•ä¸ä½¿ç”¨change bufferã€‚\n  å¯¹æ¯”\nå®é™…æƒ…å†µæ˜¯ï¼Œå”¯ä¸€ç´¢å¼•çš„æ›´æ–°æ•ˆç‡ä¼šæ¯”æ™®é€šç´¢å¼•ä½ã€‚å› ä¸ºå®ƒå¿…é¡»è¦å°†è¡Œæ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­åˆ¤æ–­å¹¶æ›´æ–°ï¼Œä¸èƒ½å‘æ™®é€šç´¢å¼•é‚£æ ·ç›´æ¥å†™å®Œchange bufferå°±å®Œäº‹äº†ã€‚change bufferä¸­çš„ä¸€äº›æ“ä½œï¼Œä¼šåœ¨åç»­è¯»å–çš„æ—¶å€™åŠ è½½å®ŒåŸå§‹æ•°æ®ä¹‹åï¼Œç„¶ååº”ç”¨change bufferä¸­çš„æ“ä½œåˆ°åŸå§‹æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºmergeã€‚\n  changebufferåº”ç”¨åœºæ™¯ # ä¹Ÿä¸æ˜¯è¯´æ‰€æœ‰çš„åœºæ™¯éƒ½é€‚åˆä½¿ç”¨changebufferï¼Œå¦‚æœå†™å¤šè¯»å°‘çš„è¯ï¼Œå°±å¾ˆé€‚ç”¨äº†ã€‚åè¿‡æ¥çš„è¯ï¼Œè¯»å¤šå†™å°‘ï¼Œè¿™ç§å°±ä¸é€‚åˆä½¿ç”¨change bufferäº†ï¼Œå¯ä»¥è€ƒè™‘ç¦ç”¨ã€‚\nchangebufferæ˜¯é€šè¿‡buffer poolåˆ†é…çš„ï¼Œå¯ä»¥è®¾å®šä¸€ä¸ªå˜é‡æ¥æ§åˆ¶change bufferçš„å¤§å°ã€‚\n"}),a.add({id:156,href:"/tags/isolation/",title:"isolation",description:"",content:""}),a.add({id:157,href:"/tags/mvcc/",title:"mvcc",description:"",content:""}),a.add({id:158,href:"/categories/mysql%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/",title:"MySQLè®¾è®¡å®ç°",description:"",content:""}),a.add({id:159,href:"/tags/transaction/",title:"transaction",description:"",content:""}),a.add({id:160,href:"/blog/07%E9%87%8D%E8%A6%81%E7%9A%84%E9%9B%86%E7%BE%A4%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E4%B8%8A/",title:"07é‡è¦çš„é›†ç¾¤å‚æ•°é…ç½®",description:"ç•¥ï¼Œæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒï¼šhttps://time.geekbang.org/column/article/101171",content:"ç•¥ï¼Œæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒï¼šhttps://time.geekbang.org/column/article/101171\n"}),a.add({id:161,href:"/tags/kafka/",title:"kafka",description:"",content:""}),a.add({id:162,href:"/categories/kafka%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/",title:"kafkaæ ¸å¿ƒæŠ€æœ¯ä¸å®æˆ˜",description:"",content:""}),a.add({id:163,href:"/blog/06kafka%E7%BA%BF%E4%B8%8A%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%96%B9%E6%A1%88%E6%80%8E%E4%B9%88%E5%81%9A/",title:"06kafkaçº¿ä¸Šé›†ç¾¤éƒ¨ç½²æ–¹æ¡ˆæ€ä¹ˆåš",description:"kafkaçº¿ä¸Šé›†ç¾¤éƒ¨ç½²ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥ä»ä¸‹é¢å‡ ä¸ªå¤§çš„æ–¹å‘å…¥æ‰‹ã€‚\næ“ä½œç³»ç»Ÿé€‰å‹ # kafkaæ˜¯åŸºäºJavaã€Scalaå®ç°çš„è·¨å¹³å°çš„æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œè™½ç„¶æ˜¯è·¨å¹³å°çš„ï¼Œä½†æ˜¯çº¿ä¸Šéƒ¨ç½²kafkaç”¨çš„æœ€å¤šçš„æ“ä½œç³»ç»Ÿè¿˜æ˜¯Linuxï¼ŒWindowã€macOSåº”è¯¥éƒ½éå¸¸å°‘ï¼Œå¯èƒ½åªé€‚åˆç”¨æ¥å­¦ä¹ æµ‹è¯•ç”¨ï¼Œçº¿ä¸Šè¿˜æ˜¯è¦å°½é‡ç”¨Linuxã€‚\nLinuxæ“ä½œç³»ç»Ÿçš„ä¸€äº›äº®ç‚¹ï¼š\n IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ç°æ›´åŠ é«˜æ•ˆçš„ç½‘ç»œIOæ“ä½œï¼› é›¶æ‹·è´æŠ€æœ¯ï¼Œæ•°æ®ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼› åº”ç”¨éƒ¨ç½²å¹¿æ³›ï¼Œç¤¾åŒºæ”¯æŒåº¦æ¯”è¾ƒå¥½ï¼›  å…³äºé›¶æ‹·è´æŠ€æœ¯ï¼Œå…¬å¸åŒäº‹allanpanå†™è¿‡ä¸€ç¯‡éå¸¸å¥½çš„æ–‡ç« ï¼Œå¯ä¾›å‚è€ƒï¼š\n Linux I/O åŸç†å’Œ Zero-copy æŠ€æœ¯å…¨é¢æ­ç§˜  ç£ç›˜é€‰å‹ # é€‰æœºæ¢°ç¡¬ç›˜å‘¢ï¼Œè¿˜æ˜¯é€‰å›ºæ€ç¡¬ç›˜å‘¢ï¼ŸKafkaå·¥ä½œè¿‡ç¨‹ä¸­æ¯”è¾ƒå¤šçš„æ–¹å¼æ˜¯â€œé¡ºåºè¯»å†™â€æ“ä½œï¼Œæ™®é€šæœºæ¢°ç¡¬ç›˜é¡ºåºè¯»å†™æ•ˆç‡å·²ç»æ¯”è¾ƒé«˜äº†ï¼Œå› æ­¤ä½¿ç”¨æœºæ¢°ç¡¬ç›˜å°±å¯ä»¥äº†ã€‚\nkafkaä½¿ç”¨æœºæ¢°ç¡¬ç›˜ï¼Œä¸€ä¸ªæ˜¯æ€§èƒ½ä¸Šæœ‰ä¹Ÿä¸ä¼šæ¯”ä½¿ç”¨å›ºæ€ç¡¬ç›˜å·®å¤šå°‘ï¼ˆåº”è¯¥æ˜¯è¯´å›ºæ€ç¡¬ç›˜ä¹Ÿæ²¡ä»€ä¹ˆä¼˜åŠ¿ï¼‰ï¼Œå†ä¸€ä¸ªæ˜¯ä¾¿å®œï¼Œèƒ½é™ä½æˆæœ¬ã€‚\nå¦å¤–è¦æ³¨æ„å†—ä½™ï¼Œå€’ä¸æ˜¯è¯´å°±è¦ç”¨RAIDï¼Œå¯ä»¥å¤šåŠ å‡ ä¸ªç¡¬ç›˜åšå†—ä½™å°±è¡Œäº†ã€‚\nç£ç›˜å®¹é‡ # ç£ç›˜å®¹é‡è¦æ ¹æ®ä¸šåŠ¡å½“å‰ç°çŠ¶ï¼ŒåŠæœªæ¥å‘å±•æƒ…å†µï¼Œåˆç†åœ°è§„åˆ’å­˜å‚¨å®¹é‡ã€‚\nå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\n å†™å…¥çš„æ¶ˆæ¯æ ¼å¼æ˜¯æ€æ ·çš„ï¼Œå­˜å‚¨ä¸€æ¡æ¶ˆæ¯éœ€è¦å¤šå°‘å­—èŠ‚ï¼Ÿ å½“å‰ä¸šåŠ¡ä¸€å¤©éœ€è¦å†™å…¥å¤šå°‘æ¶ˆæ¯ï¼Œ10wæ¡ï¼Œ100wæ¡ï¼Œæœªæ¥å‘¢ï¼Ÿ æ¶ˆæ¯å¸Œæœ›ä¿ç•™å¤šé•¿æ—¶é—´ï¼Œ2å‘¨ï¼Œ1ä¸ªæœˆï¼Ÿ ç£ç›˜å†—ä½™å¤‡ä»½æ•°æ˜¯å¤šå°‘ï¼Œ2ï¼Ÿ3ï¼Ÿ ä½¿ç”¨å¯ç”¨å‹ç¼©ï¼Ÿç”¨å“ªç§å‹ç¼©ç®—æ³•ï¼Ÿå‹ç¼©ç‡å¤šå°‘ï¼Ÿ  å°å¿ƒè¯„ä¼°ä¸Šè¿°æ¯ä¸€ä¸ªé—®é¢˜ï¼Œæœ€åå°±èƒ½ç»™å‡ºä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒåˆç†åœ°é¢„ä¼°äº†ï¼Œå½“ç„¶è¦ç•™äº›bufferï¼Œä»¥åº”å¯¹é¢„æ–™ä¹‹å¤–çš„æƒ…å†µã€‚\nç½‘ç»œå¸¦å®½ # å½“æˆ‘ä»¬è¯´å¸¦å®½çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬è¦å¤„ç†ä¸€æ‰¹æ•°æ®ï¼Œæ¯”å¦‚kafkaä¸­çš„æ•°æ®ï¼Œæ¯å°æœºå™¨éƒ½æ˜¯åƒå…†ç½‘å¡ï¼Œæˆ‘ä»¬éœ€è¦å¤šå°‘å°æœºå™¨çš„åˆåŠ›ï¼Œæ‰èƒ½ä¿è¯å¯¹æ¶ˆæ¯çš„é«˜æ•ˆå¤„ç†ã€‚\nSoï¼Œæ¯å°æœºå™¨çš„ç½‘å¡å¸¦å®½æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å…³å¿ƒçš„å…¶å®æ˜¯å¤„ç†ä¸€æ‰¹æ•°æ®æˆ‘ä»¬éœ€è¦å¤šå°‘å°æœºå™¨çš„é—®é¢˜ã€‚\næ ¹æ®æ¶ˆæ¯ç”Ÿäº§é€Ÿç‡ï¼Œä»¥åŠå•æ¡æ¶ˆæ¯å¤§å°ï¼Œå¯ä»¥å¾ˆå®¹æ˜“è®¡ç®—å‡ºæ¯ç§’å¤§çº¦èƒ½ç”Ÿæˆå¤šå°‘æ•°æ®ï¼Œç°åœ¨æˆ‘ä»¬è¦å¤„ç†è¿™äº›æ•°æ®ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸èƒ½ä¸€ç›´å¤„äºç§¯å‹çŠ¶æ€ï¼Œé‚£æ„å‘³ç€å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§ï¼Œåé¢ä¼šå¤„ç†åœ°è¶Šæ¥è¶Šä¸åŠæ—¶ã€‚\næ€ä¹ˆåŠï¼Ÿå°±éœ€è¦æ ¹æ®æ¥å—æ¶ˆæ¯å¤„ç†çš„é€Ÿç‡ï¼Œæ¥è¯„ä¼°å¤§çº¦éœ€è¦æœºå™¨æ¥å¤„ç†ã€‚è€Œæ¥æ”¶æ¶ˆæ¯çš„é€Ÿç‡ï¼Œå•æœºå—é™äºç½‘å¡ï¼Œç”¨æ€»çš„ç”Ÿäº§æ•°æ®é‡ï¼ˆé€šå¸¸ç­‰äºæ¶ˆè´¹æ•°æ®é‡ï¼‰é™¤ä»¥ç½‘å¡å¸¦å®½ï¼Œå°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªæ¯”è¾ƒç²—ç³™çš„æœºå™¨æ•°é‡ã€‚\nçœŸå®æƒ…å†µæ˜¯ï¼Œè¦ä¸ºæ¯å°æœºå™¨é¢„ç•™ä¸€å®šçš„è´·æ¬¾ï¼Œæ¯”å¦‚æ¯å°æœºå™¨70%çš„å¸¦å®½ç”¨äºå¤„ç†æ•°æ®ï¼Œå…¶ä»– çš„ç•™ç»™ä¸€äº›ç³»ç»Ÿã€ç½‘ç»œæœåŠ¡ç­‰ã€‚",content:"kafkaçº¿ä¸Šé›†ç¾¤éƒ¨ç½²ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿå¯ä»¥ä»ä¸‹é¢å‡ ä¸ªå¤§çš„æ–¹å‘å…¥æ‰‹ã€‚\næ“ä½œç³»ç»Ÿé€‰å‹ # kafkaæ˜¯åŸºäºJavaã€Scalaå®ç°çš„è·¨å¹³å°çš„æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œè™½ç„¶æ˜¯è·¨å¹³å°çš„ï¼Œä½†æ˜¯çº¿ä¸Šéƒ¨ç½²kafkaç”¨çš„æœ€å¤šçš„æ“ä½œç³»ç»Ÿè¿˜æ˜¯Linuxï¼ŒWindowã€macOSåº”è¯¥éƒ½éå¸¸å°‘ï¼Œå¯èƒ½åªé€‚åˆç”¨æ¥å­¦ä¹ æµ‹è¯•ç”¨ï¼Œçº¿ä¸Šè¿˜æ˜¯è¦å°½é‡ç”¨Linuxã€‚\nLinuxæ“ä½œç³»ç»Ÿçš„ä¸€äº›äº®ç‚¹ï¼š\n IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå®ç°æ›´åŠ é«˜æ•ˆçš„ç½‘ç»œIOæ“ä½œï¼› é›¶æ‹·è´æŠ€æœ¯ï¼Œæ•°æ®ç½‘ç»œä¼ è¾“æ•ˆç‡ï¼› åº”ç”¨éƒ¨ç½²å¹¿æ³›ï¼Œç¤¾åŒºæ”¯æŒåº¦æ¯”è¾ƒå¥½ï¼›  å…³äºé›¶æ‹·è´æŠ€æœ¯ï¼Œå…¬å¸åŒäº‹allanpanå†™è¿‡ä¸€ç¯‡éå¸¸å¥½çš„æ–‡ç« ï¼Œå¯ä¾›å‚è€ƒï¼š\n Linux I/O åŸç†å’Œ Zero-copy æŠ€æœ¯å…¨é¢æ­ç§˜  ç£ç›˜é€‰å‹ # é€‰æœºæ¢°ç¡¬ç›˜å‘¢ï¼Œè¿˜æ˜¯é€‰å›ºæ€ç¡¬ç›˜å‘¢ï¼ŸKafkaå·¥ä½œè¿‡ç¨‹ä¸­æ¯”è¾ƒå¤šçš„æ–¹å¼æ˜¯â€œé¡ºåºè¯»å†™â€æ“ä½œï¼Œæ™®é€šæœºæ¢°ç¡¬ç›˜é¡ºåºè¯»å†™æ•ˆç‡å·²ç»æ¯”è¾ƒé«˜äº†ï¼Œå› æ­¤ä½¿ç”¨æœºæ¢°ç¡¬ç›˜å°±å¯ä»¥äº†ã€‚\nkafkaä½¿ç”¨æœºæ¢°ç¡¬ç›˜ï¼Œä¸€ä¸ªæ˜¯æ€§èƒ½ä¸Šæœ‰ä¹Ÿä¸ä¼šæ¯”ä½¿ç”¨å›ºæ€ç¡¬ç›˜å·®å¤šå°‘ï¼ˆåº”è¯¥æ˜¯è¯´å›ºæ€ç¡¬ç›˜ä¹Ÿæ²¡ä»€ä¹ˆä¼˜åŠ¿ï¼‰ï¼Œå†ä¸€ä¸ªæ˜¯ä¾¿å®œï¼Œèƒ½é™ä½æˆæœ¬ã€‚\nå¦å¤–è¦æ³¨æ„å†—ä½™ï¼Œå€’ä¸æ˜¯è¯´å°±è¦ç”¨RAIDï¼Œå¯ä»¥å¤šåŠ å‡ ä¸ªç¡¬ç›˜åšå†—ä½™å°±è¡Œäº†ã€‚\nç£ç›˜å®¹é‡ # ç£ç›˜å®¹é‡è¦æ ¹æ®ä¸šåŠ¡å½“å‰ç°çŠ¶ï¼ŒåŠæœªæ¥å‘å±•æƒ…å†µï¼Œåˆç†åœ°è§„åˆ’å­˜å‚¨å®¹é‡ã€‚\nå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\n å†™å…¥çš„æ¶ˆæ¯æ ¼å¼æ˜¯æ€æ ·çš„ï¼Œå­˜å‚¨ä¸€æ¡æ¶ˆæ¯éœ€è¦å¤šå°‘å­—èŠ‚ï¼Ÿ å½“å‰ä¸šåŠ¡ä¸€å¤©éœ€è¦å†™å…¥å¤šå°‘æ¶ˆæ¯ï¼Œ10wæ¡ï¼Œ100wæ¡ï¼Œæœªæ¥å‘¢ï¼Ÿ æ¶ˆæ¯å¸Œæœ›ä¿ç•™å¤šé•¿æ—¶é—´ï¼Œ2å‘¨ï¼Œ1ä¸ªæœˆï¼Ÿ ç£ç›˜å†—ä½™å¤‡ä»½æ•°æ˜¯å¤šå°‘ï¼Œ2ï¼Ÿ3ï¼Ÿ ä½¿ç”¨å¯ç”¨å‹ç¼©ï¼Ÿç”¨å“ªç§å‹ç¼©ç®—æ³•ï¼Ÿå‹ç¼©ç‡å¤šå°‘ï¼Ÿ  å°å¿ƒè¯„ä¼°ä¸Šè¿°æ¯ä¸€ä¸ªé—®é¢˜ï¼Œæœ€åå°±èƒ½ç»™å‡ºä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒåˆç†åœ°é¢„ä¼°äº†ï¼Œå½“ç„¶è¦ç•™äº›bufferï¼Œä»¥åº”å¯¹é¢„æ–™ä¹‹å¤–çš„æƒ…å†µã€‚\nç½‘ç»œå¸¦å®½ # å½“æˆ‘ä»¬è¯´å¸¦å®½çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœŸæ­£å…³å¿ƒçš„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬è¦å¤„ç†ä¸€æ‰¹æ•°æ®ï¼Œæ¯”å¦‚kafkaä¸­çš„æ•°æ®ï¼Œæ¯å°æœºå™¨éƒ½æ˜¯åƒå…†ç½‘å¡ï¼Œæˆ‘ä»¬éœ€è¦å¤šå°‘å°æœºå™¨çš„åˆåŠ›ï¼Œæ‰èƒ½ä¿è¯å¯¹æ¶ˆæ¯çš„é«˜æ•ˆå¤„ç†ã€‚\nSoï¼Œæ¯å°æœºå™¨çš„ç½‘å¡å¸¦å®½æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å…³å¿ƒçš„å…¶å®æ˜¯å¤„ç†ä¸€æ‰¹æ•°æ®æˆ‘ä»¬éœ€è¦å¤šå°‘å°æœºå™¨çš„é—®é¢˜ã€‚\næ ¹æ®æ¶ˆæ¯ç”Ÿäº§é€Ÿç‡ï¼Œä»¥åŠå•æ¡æ¶ˆæ¯å¤§å°ï¼Œå¯ä»¥å¾ˆå®¹æ˜“è®¡ç®—å‡ºæ¯ç§’å¤§çº¦èƒ½ç”Ÿæˆå¤šå°‘æ•°æ®ï¼Œç°åœ¨æˆ‘ä»¬è¦å¤„ç†è¿™äº›æ•°æ®ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸èƒ½ä¸€ç›´å¤„äºç§¯å‹çŠ¶æ€ï¼Œé‚£æ„å‘³ç€å¤„ç†é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§ï¼Œåé¢ä¼šå¤„ç†åœ°è¶Šæ¥è¶Šä¸åŠæ—¶ã€‚\næ€ä¹ˆåŠï¼Ÿå°±éœ€è¦æ ¹æ®æ¥å—æ¶ˆæ¯å¤„ç†çš„é€Ÿç‡ï¼Œæ¥è¯„ä¼°å¤§çº¦éœ€è¦æœºå™¨æ¥å¤„ç†ã€‚è€Œæ¥æ”¶æ¶ˆæ¯çš„é€Ÿç‡ï¼Œå•æœºå—é™äºç½‘å¡ï¼Œç”¨æ€»çš„ç”Ÿäº§æ•°æ®é‡ï¼ˆé€šå¸¸ç­‰äºæ¶ˆè´¹æ•°æ®é‡ï¼‰é™¤ä»¥ç½‘å¡å¸¦å®½ï¼Œå°±å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªæ¯”è¾ƒç²—ç³™çš„æœºå™¨æ•°é‡ã€‚\nçœŸå®æƒ…å†µæ˜¯ï¼Œè¦ä¸ºæ¯å°æœºå™¨é¢„ç•™ä¸€å®šçš„è´·æ¬¾ï¼Œæ¯”å¦‚æ¯å°æœºå™¨70%çš„å¸¦å®½ç”¨äºå¤„ç†æ•°æ®ï¼Œå…¶ä»– çš„ç•™ç»™ä¸€äº›ç³»ç»Ÿã€ç½‘ç»œæœåŠ¡ç­‰ã€‚\n"}),a.add({id:164,href:"/blog/05%E8%81%8A%E8%81%8Akafka%E7%9A%84%E7%89%88%E6%9C%AC%E5%8F%B7/",title:"05èŠèŠkafkaçš„ç‰ˆæœ¬å·",description:"äº†è§£kafkaçš„ç‰ˆæœ¬æ¼”è¿›ï¼ŒåŠå„ä¸ªç‰ˆæœ¬çš„ç‰¹æ€§ï¼Œæ›´æ–¹ä¾¿ç¡®å®šè‡ªå·±çš„ä¸šåŠ¡é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ã€‚\nkafkaç‰ˆæœ¬å·è¯´æ˜ï¼škafka-2.11-2.2.1.tgz\nkafkaçš„æœåŠ¡ç«¯æ˜¯ç”¨scalaç¼–å†™çš„ï¼Œå…¶ä¸­2.11è¡¨ç¤ºçš„æ˜¯scalaç¼–è¯‘å™¨å®ç°çš„ï¼Œå…¶ä¸­2.2.1æ‰æ˜¯kafkaçš„ç‰ˆæœ¬å·ï¼Œä¸»ç‰ˆæœ¬2ã€å‰¯ç‰ˆæœ¬2ã€ä¿®è®¢ç‰ˆæœ¬1ã€‚\näº†è§£å„ä¸ªç‰ˆæœ¬çš„æ¼”è¿›\nKafka ç›®å‰æ€»å…±æ¼”è¿›äº† 7 ä¸ªå¤§ç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯ 0.7ã€0.8ã€0.9ã€0.10ã€0.11ã€1.0 å’Œ 2.0ï¼Œå…¶ä¸­çš„å°ç‰ˆæœ¬å’Œ Patch ç‰ˆæœ¬å¾ˆå¤šã€‚å“ªäº›ç‰ˆæœ¬å¼•å…¥äº†å“ªäº›é‡å¤§çš„åŠŸèƒ½æ”¹è¿›ï¼Ÿå…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å»ºè®®ä½ æœ€å¥½èƒ½åšåˆ°å¦‚æ•°å®¶çã€‚\né¢ï¼Œå†å²ç‰ˆæœ¬æš‚æ—¶å…ˆä¸æ·±ç©¶äº†ã€‚\næœ€åè¿˜æœ‰ä¸ªå»ºè®®ï¼Œä¸è®ºä½ ç”¨çš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œéƒ½è¯·å°½é‡ä¿æŒæœåŠ¡å™¨ç«¯ç‰ˆæœ¬å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬ä¸€è‡´ï¼Œå¦åˆ™ä½ å°†æŸå¤±å¾ˆå¤š Kafka ä¸ºä½ æä¾›çš„æ€§èƒ½ä¼˜åŒ–æ”¶ç›Šã€‚",content:"äº†è§£kafkaçš„ç‰ˆæœ¬æ¼”è¿›ï¼ŒåŠå„ä¸ªç‰ˆæœ¬çš„ç‰¹æ€§ï¼Œæ›´æ–¹ä¾¿ç¡®å®šè‡ªå·±çš„ä¸šåŠ¡é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ã€‚\nkafkaç‰ˆæœ¬å·è¯´æ˜ï¼škafka-2.11-2.2.1.tgz\nkafkaçš„æœåŠ¡ç«¯æ˜¯ç”¨scalaç¼–å†™çš„ï¼Œå…¶ä¸­2.11è¡¨ç¤ºçš„æ˜¯scalaç¼–è¯‘å™¨å®ç°çš„ï¼Œå…¶ä¸­2.2.1æ‰æ˜¯kafkaçš„ç‰ˆæœ¬å·ï¼Œä¸»ç‰ˆæœ¬2ã€å‰¯ç‰ˆæœ¬2ã€ä¿®è®¢ç‰ˆæœ¬1ã€‚\näº†è§£å„ä¸ªç‰ˆæœ¬çš„æ¼”è¿›\nKafka ç›®å‰æ€»å…±æ¼”è¿›äº† 7 ä¸ªå¤§ç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯ 0.7ã€0.8ã€0.9ã€0.10ã€0.11ã€1.0 å’Œ 2.0ï¼Œå…¶ä¸­çš„å°ç‰ˆæœ¬å’Œ Patch ç‰ˆæœ¬å¾ˆå¤šã€‚å“ªäº›ç‰ˆæœ¬å¼•å…¥äº†å“ªäº›é‡å¤§çš„åŠŸèƒ½æ”¹è¿›ï¼Ÿå…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å»ºè®®ä½ æœ€å¥½èƒ½åšåˆ°å¦‚æ•°å®¶çã€‚\né¢ï¼Œå†å²ç‰ˆæœ¬æš‚æ—¶å…ˆä¸æ·±ç©¶äº†ã€‚\næœ€åè¿˜æœ‰ä¸ªå»ºè®®ï¼Œä¸è®ºä½ ç”¨çš„æ˜¯å“ªä¸ªç‰ˆæœ¬ï¼Œéƒ½è¯·å°½é‡ä¿æŒæœåŠ¡å™¨ç«¯ç‰ˆæœ¬å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬ä¸€è‡´ï¼Œå¦åˆ™ä½ å°†æŸå¤±å¾ˆå¤š Kafka ä¸ºä½ æä¾›çš„æ€§èƒ½ä¼˜åŒ–æ”¶ç›Šã€‚\n"}),a.add({id:165,href:"/blog/04%E6%88%91%E4%BB%AC%E5%BA%94%E8%AF%A5%E9%80%89%E6%8B%A9%E5%93%AA%E7%A7%8Dkafka/",title:"04æˆ‘ä»¬åº”è¯¥é€‰æ‹©å“ªç§kafka",description:"pkå…¶ä»–æµå¤„ç†å¹³å° # Apache Stormã€Apache Spark Streaming äº¦æˆ–æ˜¯ Apache Flinkï¼Œå®ƒä»¬åœ¨å¤§è§„æ¨¡æµå¤„ç†é¢†åŸŸå¯éƒ½æ˜¯å“å½“å½“çš„åå­—ã€‚\nä»¤äººé«˜å…´çš„æ˜¯ï¼ŒKafka ç»è¿‡è¿™ä¹ˆé•¿æ—¶é—´ä¸æ–­çš„è¿­ä»£ï¼Œç°åœ¨å·²ç»èƒ½å¤Ÿç¨ç¨æ¯”è‚©è¿™äº›æ¡†æ¶äº†ã€‚æˆ‘åœ¨è¿™é‡Œä½¿ç”¨äº†â€œç¨ç¨â€è¿™ä¸ªå­—çœ¼ï¼Œä¸€æ–¹é¢æƒ³è¡¨è¾¾ Kafka ç¤¾åŒºå¯¹äºè¿™äº›æ¡†æ¶å¿ƒå­˜æ•¬æ„ï¼›å¦ä¸€æ–¹é¢ä¹Ÿæƒ³è¡¨è¾¾ç›®å‰å›½å†…é²œæœ‰å¤§å‚å°† Kafka ç”¨äºæµå¤„ç†çš„å°´å°¬å¢ƒåœ°ï¼Œæ¯•ç«Ÿ Kafka æ˜¯ä»æ¶ˆæ¯å¼•æ“â€œåŠè·¯å‡ºå®¶â€è½¬å‹æˆæµå¤„ç†å¹³å°çš„ï¼Œå®ƒåœ¨æµå¤„ç†æ–¹é¢çš„è¡¨ç°è¿˜éœ€è¦ç»è¿‡æ—¶é—´çš„æ£€éªŒã€‚\n kafka connectï¼Œæ‰©å±•äº†kafkaçš„æµå¼å¤„ç†ç”Ÿæ€\n ä½ çŸ¥é“å‡ ç§kafkaï¼Ÿ #  apache kafkaï¼Œç¤¾åŒºç‰ˆï¼Œæ˜¯åç»­æ‰€æœ‰ç‰ˆæœ¬çš„åŸºç¡€ confluent kafkaï¼Œæä¾›äº†ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œå¦‚è·¨æ•°æ®ä¸­å¿ƒå¤‡ä»½ã€é›†ç¾¤ç›‘æ§å·¥å…·ç­‰ cloudera/hortonworks kafkaï¼Œæä¾›çš„CDHå’ŒHDPæ˜¯éå¸¸æœ‰åçš„å¤§æ•°æ®å¹³å°ï¼Œé‡Œé¢é›†æˆäº†ç›®å‰ä¸»æµçš„å¤§æ•°æ®æ¡†æ¶ï¼Œç°åœ¨ä¸¤ä¸ªå…¬å¸å·²ç»åˆå¹¶ï¼Œéƒ½é›†æˆäº†apache kafkaã€‚  apache kafkaçš„ä¼˜ç¼ºç‚¹ # ä¼˜ç‚¹ï¼š\n å¼€å‘äººæ•°å¤šã€æ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å¿«  ç¼ºç‚¹ï¼š\n ä»…ä»…æä¾›æœ€åŸºç¡€çš„ç»„ä»¶ kafka connectï¼Œä»…æä¾›ä¸€ç§è¯»å†™æ–‡ä»¶çš„è¿æ¥å™¨ï¼Œå…¶ä»–çš„è¦è‡ªå·±å®ç° æ²¡æœ‰ä»»ä½•ç›‘æ§æ¡†æ¶æˆ–è€…å·¥å…·ï¼Œè¦å€ŸåŠ©ç¬¬ä¸‰æ–¹ç›‘æ§æ¡†æ¶æ¥ç›‘æ§ï¼ˆå¦‚kafka managerï¼‰  confluent kafkaã€cdh/hdp kafkaçš„ä¼˜ç¼ºç‚¹å°±ä¸å¤šè¯´äº†ï¼Œå›½å†…å¤§å…¬å¸å¾ˆå°‘æœ‰ä½¿ç”¨çš„ã€‚",content:"pkå…¶ä»–æµå¤„ç†å¹³å° # Apache Stormã€Apache Spark Streaming äº¦æˆ–æ˜¯ Apache Flinkï¼Œå®ƒä»¬åœ¨å¤§è§„æ¨¡æµå¤„ç†é¢†åŸŸå¯éƒ½æ˜¯å“å½“å½“çš„åå­—ã€‚\nä»¤äººé«˜å…´çš„æ˜¯ï¼ŒKafka ç»è¿‡è¿™ä¹ˆé•¿æ—¶é—´ä¸æ–­çš„è¿­ä»£ï¼Œç°åœ¨å·²ç»èƒ½å¤Ÿç¨ç¨æ¯”è‚©è¿™äº›æ¡†æ¶äº†ã€‚æˆ‘åœ¨è¿™é‡Œä½¿ç”¨äº†â€œç¨ç¨â€è¿™ä¸ªå­—çœ¼ï¼Œä¸€æ–¹é¢æƒ³è¡¨è¾¾ Kafka ç¤¾åŒºå¯¹äºè¿™äº›æ¡†æ¶å¿ƒå­˜æ•¬æ„ï¼›å¦ä¸€æ–¹é¢ä¹Ÿæƒ³è¡¨è¾¾ç›®å‰å›½å†…é²œæœ‰å¤§å‚å°† Kafka ç”¨äºæµå¤„ç†çš„å°´å°¬å¢ƒåœ°ï¼Œæ¯•ç«Ÿ Kafka æ˜¯ä»æ¶ˆæ¯å¼•æ“â€œåŠè·¯å‡ºå®¶â€è½¬å‹æˆæµå¤„ç†å¹³å°çš„ï¼Œå®ƒåœ¨æµå¤„ç†æ–¹é¢çš„è¡¨ç°è¿˜éœ€è¦ç»è¿‡æ—¶é—´çš„æ£€éªŒã€‚\n kafka connectï¼Œæ‰©å±•äº†kafkaçš„æµå¼å¤„ç†ç”Ÿæ€\n ä½ çŸ¥é“å‡ ç§kafkaï¼Ÿ #  apache kafkaï¼Œç¤¾åŒºç‰ˆï¼Œæ˜¯åç»­æ‰€æœ‰ç‰ˆæœ¬çš„åŸºç¡€ confluent kafkaï¼Œæä¾›äº†ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œå¦‚è·¨æ•°æ®ä¸­å¿ƒå¤‡ä»½ã€é›†ç¾¤ç›‘æ§å·¥å…·ç­‰ cloudera/hortonworks kafkaï¼Œæä¾›çš„CDHå’ŒHDPæ˜¯éå¸¸æœ‰åçš„å¤§æ•°æ®å¹³å°ï¼Œé‡Œé¢é›†æˆäº†ç›®å‰ä¸»æµçš„å¤§æ•°æ®æ¡†æ¶ï¼Œç°åœ¨ä¸¤ä¸ªå…¬å¸å·²ç»åˆå¹¶ï¼Œéƒ½é›†æˆäº†apache kafkaã€‚  apache kafkaçš„ä¼˜ç¼ºç‚¹ # ä¼˜ç‚¹ï¼š\n å¼€å‘äººæ•°å¤šã€æ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å¿«  ç¼ºç‚¹ï¼š\n ä»…ä»…æä¾›æœ€åŸºç¡€çš„ç»„ä»¶ kafka connectï¼Œä»…æä¾›ä¸€ç§è¯»å†™æ–‡ä»¶çš„è¿æ¥å™¨ï¼Œå…¶ä»–çš„è¦è‡ªå·±å®ç° æ²¡æœ‰ä»»ä½•ç›‘æ§æ¡†æ¶æˆ–è€…å·¥å…·ï¼Œè¦å€ŸåŠ©ç¬¬ä¸‰æ–¹ç›‘æ§æ¡†æ¶æ¥ç›‘æ§ï¼ˆå¦‚kafka managerï¼‰  confluent kafkaã€cdh/hdp kafkaçš„ä¼˜ç¼ºç‚¹å°±ä¸å¤šè¯´äº†ï¼Œå›½å†…å¤§å…¬å¸å¾ˆå°‘æœ‰ä½¿ç”¨çš„ã€‚\n"}),a.add({id:166,href:"/blog/03kafka%E5%8F%AA%E6%98%AF%E6%B6%88%E6%81%AF%E5%BC%95%E6%93%8E%E7%B3%BB%E7%BB%9F%E5%90%97/",title:"03kafkaåªæ˜¯æ¶ˆæ¯å¼•æ“ç³»ç»Ÿå—",description:"å¦‚æœä¸€ä¸ªç‚¹ä¸€ä¸ªç‚¹çš„å­¦ä¹ ï¼Œè™½ç„¶äº†è§£äº†ä¸€ä¸ªä¸ªç‚¹çš„ä½œç”¨ï¼Œä½†æ˜¯ä¸èƒ½å¿«é€Ÿå»ºç«‹èµ·å…¨å±€çš„è®¤è¯†ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“ä¸§å¤±å­¦ä¹ å…´è¶£ï¼Œè¿˜æ˜¯å…ˆäº†è§£å…¨è²Œå†æ·±å…¥ç»†èŠ‚ï¼Œå­¦ä¹ æ•ˆæœä¼šæ›´å¥½ä¸€ç‚¹ã€‚\napache kafkaåªæ˜¯ä¸€ä¸ªæ¶ˆæ¯å¼•æ“ç³»ç»Ÿå— #  apache kafkaæ˜¯æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼› apache kafkaä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¼å¤„ç†å¹³å°ï¼ˆdistributed streaming platformï¼‰ï¼›  kafkaå‡ºè‡ªlinkedinï¼Œkafka ç¤¾åŒºå°†å…¶æ¸…æ™°åœ°å®šä½ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ã€åˆ†åŒºåŒ–ä¸”å¸¦å¤‡ä»½åŠŸèƒ½çš„æäº¤æ—¥å¿—ï¼ˆCommit Logï¼‰æœåŠ¡ã€‚\nKafka åœ¨è®¾è®¡ä¹‹åˆå°±æ—¨åœ¨æä¾›ä¸‰ä¸ªæ–¹é¢çš„ç‰¹æ€§ #  æä¾›ä¸€å¥— API å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼› é™ä½ç½‘ç»œä¼ è¾“å’Œç£ç›˜å­˜å‚¨å¼€é”€ï¼› å®ç°é«˜ä¼¸ç¼©æ€§æ¶æ„ã€‚  kafkaçš„åä¸½å˜èº« # æ‰€æœ‰çš„æ•°æ®å‡ ä¹éƒ½è¦ä»ä¸€ä¸ªç³»ç»Ÿæµå…¥ Kafka ç„¶åå†æµå‘ä¸‹æ¸¸çš„å¦ä¸€ä¸ªç³»ç»Ÿä¸­ã€‚è¿™æ ·çš„ä½¿ç”¨æ–¹å¼å±¡è§ä¸é²œä»¥è‡³äºå¼•å‘äº† Kafka ç¤¾åŒºçš„æ€è€ƒï¼šä¸å…¶æˆ‘æŠŠæ•°æ®ä»ä¸€ä¸ªç³»ç»Ÿä¼ é€’åˆ°ä¸‹ä¸€ä¸ªç³»ç»Ÿä¸­åšå¤„ç†ï¼Œæˆ‘ä¸ºä½•ä¸è‡ªå·±å®ç°ä¸€å¥—æµå¤„ç†æ¡†æ¶å‘¢ï¼ŸKafka Streamsè¯ç”Ÿäº†ï¼\nkafkaä¸å…¶ä»–ä¸»æµå¤§æ•°æ®æµå¼è®¡ç®—æ¡†æ¶ç›¸æ¯”ï¼Œä¼˜åŠ¿åœ¨å“ªé‡Œå‘¢ï¼Ÿ\n  æ›´å®¹æ˜“å®ç°ç«¯åˆ°ç«¯çš„æ­£ç¡®æ€§ï¼Œèƒ½å¤Ÿå®ç°ç«¯åˆ°ç«¯çš„ç²¾ç¡®ä¸€æ¬¡æ€§å¤„ç†è¯­ä¹‰ã€‚\n  è‡ªå·±å¯¹äºæµå¼è®¡ç®—çš„å®šä½ï¼Œå’Œå…¶ä»–çš„ä¸€äº›æµå¤±è®¡ç®—æ¡†æ¶ä¸åŒï¼Œå®ƒæ›´è½»é‡ï¼Œä¸æ¶‰åŠé›†ç¾¤è°ƒåº¦ç­‰ç­‰æ¯”è¾ƒé‡çš„ä¸œè¥¿ï¼Œæ¯”è¾ƒé€‚åˆä¸­å°ä¼ä¸šï¼›\n   psï¼škafkaä¸é€‚åˆå½“åšæœ€ç»ˆå­˜å‚¨ã€‚\n ",content:"å¦‚æœä¸€ä¸ªç‚¹ä¸€ä¸ªç‚¹çš„å­¦ä¹ ï¼Œè™½ç„¶äº†è§£äº†ä¸€ä¸ªä¸ªç‚¹çš„ä½œç”¨ï¼Œä½†æ˜¯ä¸èƒ½å¿«é€Ÿå»ºç«‹èµ·å…¨å±€çš„è®¤è¯†ï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“ä¸§å¤±å­¦ä¹ å…´è¶£ï¼Œè¿˜æ˜¯å…ˆäº†è§£å…¨è²Œå†æ·±å…¥ç»†èŠ‚ï¼Œå­¦ä¹ æ•ˆæœä¼šæ›´å¥½ä¸€ç‚¹ã€‚\napache kafkaåªæ˜¯ä¸€ä¸ªæ¶ˆæ¯å¼•æ“ç³»ç»Ÿå— #  apache kafkaæ˜¯æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼› apache kafkaä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æµå¼å¤„ç†å¹³å°ï¼ˆdistributed streaming platformï¼‰ï¼›  kafkaå‡ºè‡ªlinkedinï¼Œkafka ç¤¾åŒºå°†å…¶æ¸…æ™°åœ°å®šä½ä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ã€åˆ†åŒºåŒ–ä¸”å¸¦å¤‡ä»½åŠŸèƒ½çš„æäº¤æ—¥å¿—ï¼ˆCommit Logï¼‰æœåŠ¡ã€‚\nKafka åœ¨è®¾è®¡ä¹‹åˆå°±æ—¨åœ¨æä¾›ä¸‰ä¸ªæ–¹é¢çš„ç‰¹æ€§ #  æä¾›ä¸€å¥— API å®ç°ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼› é™ä½ç½‘ç»œä¼ è¾“å’Œç£ç›˜å­˜å‚¨å¼€é”€ï¼› å®ç°é«˜ä¼¸ç¼©æ€§æ¶æ„ã€‚  kafkaçš„åä¸½å˜èº« # æ‰€æœ‰çš„æ•°æ®å‡ ä¹éƒ½è¦ä»ä¸€ä¸ªç³»ç»Ÿæµå…¥ Kafka ç„¶åå†æµå‘ä¸‹æ¸¸çš„å¦ä¸€ä¸ªç³»ç»Ÿä¸­ã€‚è¿™æ ·çš„ä½¿ç”¨æ–¹å¼å±¡è§ä¸é²œä»¥è‡³äºå¼•å‘äº† Kafka ç¤¾åŒºçš„æ€è€ƒï¼šä¸å…¶æˆ‘æŠŠæ•°æ®ä»ä¸€ä¸ªç³»ç»Ÿä¼ é€’åˆ°ä¸‹ä¸€ä¸ªç³»ç»Ÿä¸­åšå¤„ç†ï¼Œæˆ‘ä¸ºä½•ä¸è‡ªå·±å®ç°ä¸€å¥—æµå¤„ç†æ¡†æ¶å‘¢ï¼ŸKafka Streamsè¯ç”Ÿäº†ï¼\nkafkaä¸å…¶ä»–ä¸»æµå¤§æ•°æ®æµå¼è®¡ç®—æ¡†æ¶ç›¸æ¯”ï¼Œä¼˜åŠ¿åœ¨å“ªé‡Œå‘¢ï¼Ÿ\n  æ›´å®¹æ˜“å®ç°ç«¯åˆ°ç«¯çš„æ­£ç¡®æ€§ï¼Œèƒ½å¤Ÿå®ç°ç«¯åˆ°ç«¯çš„ç²¾ç¡®ä¸€æ¬¡æ€§å¤„ç†è¯­ä¹‰ã€‚\n  è‡ªå·±å¯¹äºæµå¼è®¡ç®—çš„å®šä½ï¼Œå’Œå…¶ä»–çš„ä¸€äº›æµå¤±è®¡ç®—æ¡†æ¶ä¸åŒï¼Œå®ƒæ›´è½»é‡ï¼Œä¸æ¶‰åŠé›†ç¾¤è°ƒåº¦ç­‰ç­‰æ¯”è¾ƒé‡çš„ä¸œè¥¿ï¼Œæ¯”è¾ƒé€‚åˆä¸­å°ä¼ä¸šï¼›\n   psï¼škafkaä¸é€‚åˆå½“åšæœ€ç»ˆå­˜å‚¨ã€‚\n "}),a.add({id:167,href:"/blog/02%E5%BF%AB%E9%80%9F%E6%90%9E%E5%AE%9Akafka%E6%9C%AF%E8%AF%AD/",title:"02å¿«é€Ÿæå®škafkaæœ¯è¯­",description:"kafkaå±äºåˆ†å¸ƒå¼çš„æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æ˜¯æä¾›ä¸€å¥—å®Œå¤‡çš„æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…è§£å†³æ–¹æ¡ˆï¼š\n  å‘å¸ƒçš„è®¢é˜…çš„å¯¹è±¡æ˜¯ä¸»é¢˜ï¼Œtopicï¼›\n  clientç«¯\n æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼Œproducerï¼› æ¶ˆæ¯çš„æ¶ˆè´¹è€…ï¼Œconsumerï¼›    serverç«¯\n broker ä¸€ä¸ªbrokeré›†ç¾¤æœ‰å¤šä¸ªbrokerï¼Œå°†å¤šä¸ªbrokeréƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šï¼Œå½“å…¶ä¸­ä¸€ä¸ªæŒ‚äº†ï¼Œå¦ä¸€ä¸ªbrokerä¹Ÿä¾ç„¶èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™å°±æ˜¯kafkaå®ç°é«˜å¯ç”¨çš„æ‰‹æ®µä¹‹ä¸€ã€‚    å¤‡ä»½æœºåˆ¶ï¼Œreplication\n  å‰¯æœ¬ï¼Œreplicaï¼Œç›¸åŒçš„æ•°æ®åœ¨è¢«å­˜å‚¨åˆ°å¤šå°æœºå™¨ä¸Š\n  é¢†å¯¼è€…å‰¯æœ¬ï¼ˆleader replicaï¼‰ï¼Œå¯¹å¤–æä¾›æœåŠ¡ï¼ˆä¸å®¢æˆ·ç«¯äº¤äº’ï¼‰\n  è¿½éšè€…å‰¯æœ¬ï¼ˆfollower replicaï¼‰ï¼Œåªèƒ½è¢«åŠ¨åœ°è·Ÿéšé¢†å¯¼è€…å‰¯æœ¬ï¼Œä¸ä¸å¤–ç•Œäº¤äº’\nè¿½éšè€…å‰¯æœ¬è¯·æ±‚é¢†å¯¼è€…å‰¯æœ¬ï¼ŒæŠŠæœ€æ–°çš„æ›´æ–°æ“ä½œå‘é€ç»™å®ƒï¼Œä»¥å®ŒæˆåŒæ­¥\n    å¯ä¼¸ç¼©æ€§\n å°†æ¯ä¸ªtopicï¼Œåˆ’åˆ†æˆå¤šä¸ªåˆ†åŒºï¼ˆpartitionï¼‰ï¼Œåˆ†åŒºç¼–å·ä»0å¼€å§‹ï¼› å‰¯æœ¬æ˜¯åœ¨åˆ†åŒºè¿™ä¸ªå±‚çº§å®šä¹‰çš„ï¼Œå³æ¯ä¸ªåˆ†åŒºå¯ä»¥å®šä¹‰å‰¯æœ¬çš„æ•°é‡ï¼›    topic ï¼šæ¯ä¸ªä¸»é¢˜å¯ä»¥åŒ…å«å¤šä¸ªåˆ†åŒº\nâ€‹	\\\npartitionï¼šæ¯ä¸ªåˆ†åŒºå¯ä»¥é…ç½®å¤šä¸ªå‰¯æœ¬\nâ€‹	\\\nâ€‹	replica (leader/follower)ï¼šæ¯ä¸ªåˆ†åŒºçš„å¤šä¸ªå‰¯æœ¬ä¸­åªèƒ½æœ‰ä¸€ä¸ªä¸ºleaderï¼Œå¯¹å¤–æœåŠ¡\nâ€‹	\\\nâ€‹	offsetï¼šæ¶ˆæ¯æ›¾ï¼Œåˆ†åŒºä¸­åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯çš„ä½ç§»ä»0å¼€å§‹ï¼Œä¾æ¬¡é€’å¢\nclientåªèƒ½ä¸åˆ†åŒºçš„leader replicaè¿›è¡Œé€šä¿¡ã€‚\næ¶ˆè´¹ç»„é‡Œé¢å¯ä»¥è®¢é˜…\nkafka brokeré€šè¿‡è¿½åŠ å†™ï¼Œæ¥å®ç°æŒä¹…åŒ–ï¼Œæ¥é¿å…ç¼“æ…¢çš„éšæœºIOæ“ï¼Œåˆ©ç”¨äº†æ¯”è¾ƒå¥½çš„é¡ºåºå†™æ“ä½œã€‚\nå†æ¥å›é¡¾ä¸‹è¿™é‡Œçš„å¸¸è§æœ¯è¯­ï¼š\næ¶ˆæ¯ï¼šRecordã€‚Kafka æ˜¯æ¶ˆæ¯å¼•æ“å˜›ï¼Œè¿™é‡Œçš„æ¶ˆæ¯å°±æ˜¯æŒ‡ Kafka å¤„ç†çš„ä¸»è¦å¯¹è±¡ã€‚\nä¸»é¢˜ï¼šTopicã€‚ä¸»é¢˜æ˜¯æ‰¿è½½æ¶ˆæ¯çš„é€»è¾‘å®¹å™¨ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¤šç”¨æ¥åŒºåˆ†å…·ä½“çš„ä¸šåŠ¡ã€‚\nåˆ†åŒºï¼šPartitionã€‚ä¸€ä¸ªæœ‰åºä¸å˜çš„æ¶ˆæ¯åºåˆ—ã€‚æ¯ä¸ªä¸»é¢˜ä¸‹å¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºã€‚",content:"kafkaå±äºåˆ†å¸ƒå¼çš„æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æ˜¯æä¾›ä¸€å¥—å®Œå¤‡çš„æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…è§£å†³æ–¹æ¡ˆï¼š\n  å‘å¸ƒçš„è®¢é˜…çš„å¯¹è±¡æ˜¯ä¸»é¢˜ï¼Œtopicï¼›\n  clientç«¯\n æ¶ˆæ¯çš„ç”Ÿäº§è€…ï¼Œproducerï¼› æ¶ˆæ¯çš„æ¶ˆè´¹è€…ï¼Œconsumerï¼›    serverç«¯\n broker ä¸€ä¸ªbrokeré›†ç¾¤æœ‰å¤šä¸ªbrokerï¼Œå°†å¤šä¸ªbrokeréƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šï¼Œå½“å…¶ä¸­ä¸€ä¸ªæŒ‚äº†ï¼Œå¦ä¸€ä¸ªbrokerä¹Ÿä¾ç„¶èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™å°±æ˜¯kafkaå®ç°é«˜å¯ç”¨çš„æ‰‹æ®µä¹‹ä¸€ã€‚    å¤‡ä»½æœºåˆ¶ï¼Œreplication\n  å‰¯æœ¬ï¼Œreplicaï¼Œç›¸åŒçš„æ•°æ®åœ¨è¢«å­˜å‚¨åˆ°å¤šå°æœºå™¨ä¸Š\n  é¢†å¯¼è€…å‰¯æœ¬ï¼ˆleader replicaï¼‰ï¼Œå¯¹å¤–æä¾›æœåŠ¡ï¼ˆä¸å®¢æˆ·ç«¯äº¤äº’ï¼‰\n  è¿½éšè€…å‰¯æœ¬ï¼ˆfollower replicaï¼‰ï¼Œåªèƒ½è¢«åŠ¨åœ°è·Ÿéšé¢†å¯¼è€…å‰¯æœ¬ï¼Œä¸ä¸å¤–ç•Œäº¤äº’\nè¿½éšè€…å‰¯æœ¬è¯·æ±‚é¢†å¯¼è€…å‰¯æœ¬ï¼ŒæŠŠæœ€æ–°çš„æ›´æ–°æ“ä½œå‘é€ç»™å®ƒï¼Œä»¥å®ŒæˆåŒæ­¥\n    å¯ä¼¸ç¼©æ€§\n å°†æ¯ä¸ªtopicï¼Œåˆ’åˆ†æˆå¤šä¸ªåˆ†åŒºï¼ˆpartitionï¼‰ï¼Œåˆ†åŒºç¼–å·ä»0å¼€å§‹ï¼› å‰¯æœ¬æ˜¯åœ¨åˆ†åŒºè¿™ä¸ªå±‚çº§å®šä¹‰çš„ï¼Œå³æ¯ä¸ªåˆ†åŒºå¯ä»¥å®šä¹‰å‰¯æœ¬çš„æ•°é‡ï¼›    topic ï¼šæ¯ä¸ªä¸»é¢˜å¯ä»¥åŒ…å«å¤šä¸ªåˆ†åŒº\nâ€‹	\\\npartitionï¼šæ¯ä¸ªåˆ†åŒºå¯ä»¥é…ç½®å¤šä¸ªå‰¯æœ¬\nâ€‹	\\\nâ€‹	replica (leader/follower)ï¼šæ¯ä¸ªåˆ†åŒºçš„å¤šä¸ªå‰¯æœ¬ä¸­åªèƒ½æœ‰ä¸€ä¸ªä¸ºleaderï¼Œå¯¹å¤–æœåŠ¡\nâ€‹	\\\nâ€‹	offsetï¼šæ¶ˆæ¯æ›¾ï¼Œåˆ†åŒºä¸­åŒ…å«è‹¥å¹²æ¡æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯çš„ä½ç§»ä»0å¼€å§‹ï¼Œä¾æ¬¡é€’å¢\nclientåªèƒ½ä¸åˆ†åŒºçš„leader replicaè¿›è¡Œé€šä¿¡ã€‚\næ¶ˆè´¹ç»„é‡Œé¢å¯ä»¥è®¢é˜…\nkafka brokeré€šè¿‡è¿½åŠ å†™ï¼Œæ¥å®ç°æŒä¹…åŒ–ï¼Œæ¥é¿å…ç¼“æ…¢çš„éšæœºIOæ“ï¼Œåˆ©ç”¨äº†æ¯”è¾ƒå¥½çš„é¡ºåºå†™æ“ä½œã€‚\nå†æ¥å›é¡¾ä¸‹è¿™é‡Œçš„å¸¸è§æœ¯è¯­ï¼š\næ¶ˆæ¯ï¼šRecordã€‚Kafka æ˜¯æ¶ˆæ¯å¼•æ“å˜›ï¼Œè¿™é‡Œçš„æ¶ˆæ¯å°±æ˜¯æŒ‡ Kafka å¤„ç†çš„ä¸»è¦å¯¹è±¡ã€‚\nä¸»é¢˜ï¼šTopicã€‚ä¸»é¢˜æ˜¯æ‰¿è½½æ¶ˆæ¯çš„é€»è¾‘å®¹å™¨ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¤šç”¨æ¥åŒºåˆ†å…·ä½“çš„ä¸šåŠ¡ã€‚\nåˆ†åŒºï¼šPartitionã€‚ä¸€ä¸ªæœ‰åºä¸å˜çš„æ¶ˆæ¯åºåˆ—ã€‚æ¯ä¸ªä¸»é¢˜ä¸‹å¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºã€‚\næ¶ˆæ¯ä½ç§»ï¼šOffsetã€‚è¡¨ç¤ºåˆ†åŒºä¸­æ¯æ¡æ¶ˆæ¯çš„ä½ç½®ä¿¡æ¯ï¼Œæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢ä¸”ä¸å˜çš„å€¼ã€‚\nå‰¯æœ¬ï¼šReplicaã€‚Kafka ä¸­åŒä¸€æ¡æ¶ˆæ¯èƒ½å¤Ÿè¢«æ‹·è´åˆ°å¤šä¸ªåœ°æ–¹ä»¥æä¾›æ•°æ®å†—ä½™ï¼Œè¿™äº›åœ°æ–¹å°±æ˜¯æ‰€è°“çš„å‰¯æœ¬ã€‚å‰¯æœ¬è¿˜åˆ†ä¸ºé¢†å¯¼è€…å‰¯æœ¬å’Œè¿½éšè€…å‰¯æœ¬ï¼Œå„è‡ªæœ‰ä¸åŒçš„è§’è‰²åˆ’åˆ†ã€‚å‰¯æœ¬æ˜¯åœ¨åˆ†åŒºå±‚çº§ä¸‹çš„ï¼Œå³æ¯ä¸ªåˆ†åŒºå¯é…ç½®å¤šä¸ªå‰¯æœ¬å®ç°é«˜å¯ç”¨ã€‚\nç”Ÿäº§è€…ï¼šProducerã€‚å‘ä¸»é¢˜å‘å¸ƒæ–°æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚\næ¶ˆè´¹è€…ï¼šConsumerã€‚ä»ä¸»é¢˜è®¢é˜…æ–°æ¶ˆæ¯çš„åº”ç”¨ç¨‹åºã€‚\næ¶ˆè´¹è€…ä½ç§»ï¼šConsumer Offsetã€‚è¡¨å¾æ¶ˆè´¹è€…æ¶ˆè´¹è¿›åº¦ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½æœ‰è‡ªå·±çš„æ¶ˆè´¹è€…ä½ç§»ã€‚\næ¶ˆè´¹è€…ç»„ï¼šConsumer Groupã€‚å¤šä¸ªæ¶ˆè´¹è€…å®ä¾‹å…±åŒç»„æˆçš„ä¸€ä¸ªç»„ï¼ŒåŒæ—¶æ¶ˆè´¹å¤šä¸ªåˆ†åŒºä»¥å®ç°é«˜ååã€‚\né‡å¹³è¡¡ï¼šRebalanceã€‚æ¶ˆè´¹è€…ç»„å†…æŸä¸ªæ¶ˆè´¹è€…å®ä¾‹æŒ‚æ‰åï¼Œå…¶ä»–æ¶ˆè´¹è€…å®ä¾‹è‡ªåŠ¨é‡æ–°åˆ†é…è®¢é˜…ä¸»é¢˜åˆ†åŒºçš„è¿‡ç¨‹ã€‚Rebalance æ˜¯ Kafka æ¶ˆè´¹è€…ç«¯å®ç°é«˜å¯ç”¨çš„é‡è¦æ‰‹æ®µã€‚\n"}),a.add({id:168,href:"/blog/01%E6%B6%88%E6%81%AF%E5%BC%95%E6%93%8E%E7%B3%BB%E7%BB%9Fabc/",title:"01æ¶ˆæ¯å¼•æ“ç³»ç»Ÿ",description:"apache kafkaæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\n æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼ˆmessaging systemsï¼‰ğŸ†— è¿™ç§æè¿°æ›´åŠ å‡†ç¡®ï¼ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ˜¯ç”¨é˜Ÿåˆ—å®ç°çš„ï¼Ÿnot accurately) æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆmessaging middlewareï¼‰   ç±»ä¼¼åœ°ï¼Œæ¯”å¦‚consensus algorithmï¼Œç¿»è¯‘æˆå…±è¯†ç®—æ³•ï¼Œæ¯”ä¸€è‡´æ€§ç®—æ³•æ›´åˆé€‚ï¼Œä¸€è‡´æ€§å·²ç»è¢«ç”¨çš„æ³›æ»¥äº†ã€‚\n æ¶ˆæ¯ç¼–ç æ–¹å¼ï¼š #  æ¶ˆæ¯ç¼–ç æ ¼å¼ï¼Œcsvã€xmlã€jsonã€pbã€thriftï¼› kafkaä½¿ç”¨çš„æ˜¯çº¯äºŒè¿›åˆ¶çš„å­—èŠ‚åºåˆ—ï¼›  æ¶ˆæ¯ä¼ è¾“æ–¹å¼ï¼š #  ç‚¹å¯¹ç‚¹ï¼Œç³»ç»Ÿaå‘é€çš„æ¶ˆæ¯åªèƒ½è¢«bæ¥å—ï¼Œå…¶ä»–äººéƒ½ä¸èƒ½æ¥æ”¶ï¼› å‘å¸ƒè®¢é˜…ï¼Œå¯ä»¥æœ‰å¤šä¸ªå‘é€æ–¹ï¼ˆå‘å¸ƒè€…ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œæ¥æ”¶æ–¹ï¼ˆè®¢é˜…æ–¹ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œè¿™ç§èƒ½å¤Ÿå®ç°éå¸¸çµæ´»çš„ç³»ç»Ÿæ‰©å±•ï¼›  JMSï¼šä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯ä¸€ç§è§„èŒƒï¼Œè€Œä¸æ˜¯ä¸€ç§å®ç°ã€‚\næ¶ˆæ¯å¼•æ“çš„ä½œç”¨ï¼š #   å‰Šå³°å¡«è°·ï¼Œé¿å…ç”Ÿäº§è€…å‘é€è¿‡é‡æ¶ˆæ¯å†²å®ä¸‹æ¸¸ï¼Œä½¿å¾—ä¸‹æ¸¸èƒ½å¤Ÿå¹³æ»‘å¤„ç†å¤§é‡è¯·æ±‚ï¼›\nä¸ºä»€ä¹ˆä¸å¯¹ä¸Šæ¸¸è¿›è¡Œé™é€Ÿï¼Ÿé™åˆ¶åå½±å“åˆ°ç”¨æˆ·ä½“éªŒæ€ä¹ˆåŠï¼Ÿä¸ç°å®ï¼\n  è§£è€¦ï¼Œè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå®¹æ˜“å®ç°çµæ´»çš„æ‰©å±•ï¼›\næ¯”å¦‚é‡å¤§äº†ä¹‹åï¼ŒåŠ æ›´å¤šçš„æ¶ˆè´¹è€…æ¥æé«˜å¤„ç†æ•ˆç‡å°±è¡Œäº†å˜›ï¼ŒåŠ çš„æ…¢ä¹Ÿæ²¡å½±å“ï¼Œä¸ä¼šç›´æ¥å¯¹ç”¨æˆ·ä½“éªŒé€ æˆå½±å“ã€‚\n  ",content:"apache kafkaæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\n æ¶ˆæ¯å¼•æ“ç³»ç»Ÿï¼ˆmessaging systemsï¼‰ğŸ†— è¿™ç§æè¿°æ›´åŠ å‡†ç¡®ï¼ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæ˜¯ç”¨é˜Ÿåˆ—å®ç°çš„ï¼Ÿnot accurately) æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆmessaging middlewareï¼‰   ç±»ä¼¼åœ°ï¼Œæ¯”å¦‚consensus algorithmï¼Œç¿»è¯‘æˆå…±è¯†ç®—æ³•ï¼Œæ¯”ä¸€è‡´æ€§ç®—æ³•æ›´åˆé€‚ï¼Œä¸€è‡´æ€§å·²ç»è¢«ç”¨çš„æ³›æ»¥äº†ã€‚\n æ¶ˆæ¯ç¼–ç æ–¹å¼ï¼š #  æ¶ˆæ¯ç¼–ç æ ¼å¼ï¼Œcsvã€xmlã€jsonã€pbã€thriftï¼› kafkaä½¿ç”¨çš„æ˜¯çº¯äºŒè¿›åˆ¶çš„å­—èŠ‚åºåˆ—ï¼›  æ¶ˆæ¯ä¼ è¾“æ–¹å¼ï¼š #  ç‚¹å¯¹ç‚¹ï¼Œç³»ç»Ÿaå‘é€çš„æ¶ˆæ¯åªèƒ½è¢«bæ¥å—ï¼Œå…¶ä»–äººéƒ½ä¸èƒ½æ¥æ”¶ï¼› å‘å¸ƒè®¢é˜…ï¼Œå¯ä»¥æœ‰å¤šä¸ªå‘é€æ–¹ï¼ˆå‘å¸ƒè€…ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œæ¥æ”¶æ–¹ï¼ˆè®¢é˜…æ–¹ï¼Œå¯èƒ½æœ‰å¤šä¸ªï¼‰ï¼Œè¿™ç§èƒ½å¤Ÿå®ç°éå¸¸çµæ´»çš„ç³»ç»Ÿæ‰©å±•ï¼›  JMSï¼šä¸¥æ ¼æ¥è¯´ï¼Œæ˜¯ä¸€ç§è§„èŒƒï¼Œè€Œä¸æ˜¯ä¸€ç§å®ç°ã€‚\næ¶ˆæ¯å¼•æ“çš„ä½œç”¨ï¼š #   å‰Šå³°å¡«è°·ï¼Œé¿å…ç”Ÿäº§è€…å‘é€è¿‡é‡æ¶ˆæ¯å†²å®ä¸‹æ¸¸ï¼Œä½¿å¾—ä¸‹æ¸¸èƒ½å¤Ÿå¹³æ»‘å¤„ç†å¤§é‡è¯·æ±‚ï¼›\nä¸ºä»€ä¹ˆä¸å¯¹ä¸Šæ¸¸è¿›è¡Œé™é€Ÿï¼Ÿé™åˆ¶åå½±å“åˆ°ç”¨æˆ·ä½“éªŒæ€ä¹ˆåŠï¼Ÿä¸ç°å®ï¼\n  è§£è€¦ï¼Œè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå®¹æ˜“å®ç°çµæ´»çš„æ‰©å±•ï¼›\næ¯”å¦‚é‡å¤§äº†ä¹‹åï¼ŒåŠ æ›´å¤šçš„æ¶ˆè´¹è€…æ¥æé«˜å¤„ç†æ•ˆç‡å°±è¡Œäº†å˜›ï¼ŒåŠ çš„æ…¢ä¹Ÿæ²¡å½±å“ï¼Œä¸ä¼šç›´æ¥å¯¹ç”¨æˆ·ä½“éªŒé€ æˆå½±å“ã€‚\n  "}),a.add({id:169,href:"/blog/08%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E4%BA%8B%E5%8A%A1%E5%88%B0%E5%BA%95%E6%98%AF%E9%9A%94%E7%A6%BB%E7%9A%84%E8%BF%98%E6%98%AF%E4%B8%8D%E9%9A%94%E7%A6%BB%E7%9A%84/",title:"08äº‹åŠ¡éš”ç¦»ï¼šäº‹åŠ¡åˆ°åº•æ˜¯éš”ç¦»çš„è¿˜æ˜¯ä¸éš”ç¦»çš„",description:"å¯åŠ¨äº‹åŠ¡ # å¯åŠ¨äº‹åŠ¡çš„æ–¹å¼æœ‰å“ªäº›ï¼š\n autocommit=1ï¼Œæ¯æ¡è¯­å¥æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ï¼Œæ¯”å¦‚selectã€updateã€deleteï¼› é€šè¿‡begin/start transactionæ¥å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œä½†æ˜¯è¯¥è¯­å¥å¹¶ä¸æ˜¯äº‹åŠ¡çš„èµ·ç‚¹ï¼Œèµ·ç‚¹æ˜¯åœ¨åé¢çš„ç¬¬ä¸€æ¡sqlè¯­å¥æ‰§è¡Œçš„æ—¶å€™ï¼› start transaction with consistent snapshotï¼Œç«‹å³å¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå’Œbegin/start transactionä¸åŒï¼Œè¯¥è¯­å¥æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„èµ·ç‚¹ï¼›  è§†å›¾çš„æ¦‚å¿µ # åœ¨mysqlé‡Œï¼Œè§†å›¾ï¼Œæœ‰ä¸¤ç§æ„æ€ï¼š\n  ä¸€ä¸ªæ˜¯â€œviewâ€ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æŸ¥è¯¢è¯­å¥å®šä¹‰çš„è™šæ‹Ÿè¡¨ï¼Œå¦‚æ‰§è¡Œcreate view select * from tableï¼Œè¯¥è¯­å¥æ‰§è¡Œçš„æ—¶å€™æ‰§è¡ŒæŸ¥è¯¢è¯­å¥è·å¾—ç»“æœå¹¶åˆ›å»ºè§†å›¾ï¼Œå¯ä»¥åœ¨è§†å›¾ä¸Šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼ŒæŸ¥è¯¢è¯­æ³•ä¸åœ¨è¡¨ä¸Šçš„æŸ¥è¯¢æ–¹å¼ç±»ä¼¼ï¼›\n  å¦ä¸€ä¸ªæ˜¯InnoDBåœ¨å®ç°MVCCæ—¶ç”¨åˆ°çš„â€œä¸€è‡´æ€§è¯»è§†å›¾â€ï¼Œå³consistent read viewï¼Œç”¨äºæ”¯æŒRCï¼ˆread commitedï¼Œè¯»æäº¤ï¼‰å’ŒRRï¼ˆrepeatable readï¼Œå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«çš„å®ç°ï¼›\nå®ƒæ²¡æœ‰ç‰©ç†ç»“æ„ï¼Œä½œç”¨æ˜¯äº‹åŠ¡æ‰§è¡ŒæœŸé—´ç”¨æ¥å®šä¹‰â€œå½“å‰äº‹åŠ¡èƒ½çœ‹åˆ°ä»€ä¹ˆæ•°æ®â€ã€‚\n  â€œå¿«ç…§â€åœ¨MVCCé‡Œæ˜¯æ€ä¹ˆå·¥ä½œçš„ # åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™å°±â€œåˆ›å»ºäº†ä¸ªå¿«ç…§â€ï¼Œè¿™ä¸ªå¿«ç…§æ˜¯åŸºäºæ•´åº“çš„ã€‚\nä½†æ˜¯è¿™é‡Œçš„åˆ›å»ºå¿«ç…§ï¼Œå¹¶ä¸æ˜¯å¤åˆ¶ä¸€ä»½å®Œæ•´çš„æ•°æ®ä½œä¸ºåªè¯»ï¼Œè‚¯å®šä¸èƒ½è¿™æ ·å®ç°ï¼Œæƒ³æƒ³ä¸€ä¸‹ä¸€ä¸ªæ•°æ®åº“å¦‚æœæ•°é‡å¾ˆå¤§ï¼Œå¤åˆ¶çš„å­˜å‚¨å¼€é”€ä¹Ÿå¤ªå¤§äº†ã€‚\nmysql MVCCé‡Œå®ç°çš„è¿™ä¸ªå¿«ç…§éå¸¸èªæ˜ï¼š\n  InnoDBé‡Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œå«transaction idã€‚å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘InnoDBçš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œæ˜¯æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢çš„ã€‚\n  æ¯è¡Œæ•°æ®ä¹Ÿæ˜¯æœ‰å¤šä¸ªç‰ˆæœ¬çš„ï¼Œè¿™é‡Œçš„ç‰ˆæœ¬å°±ç”¨transaction idæ¥è¡¨ç¤ºã€‚å“ªä¸ªæ•°æ®ç‰ˆæœ¬æ›´åŠ æ–°ä¸€ç‚¹æ—§ä¸€ç‚¹ï¼Œè¿˜æ˜¯æ ¹æ®ç”Ÿæˆè¯¥ç‰ˆæœ¬æ—¶çš„é¡ºåºæ¥å†³å®šçš„ï¼Œæ¯è¡Œæ•°æ®çš„transaction idåˆ™ç”¨æ¥ç»´æŠ¤ä¸€ä¸ªä¸€è‡´æ€§è¯»è§†å›¾ï¼›\n  å½“å¯¹æŸè¡Œæ•°æ®è¿›è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œä¼šç”³è¯·ä¸€ä¸ªæ–°çš„äº‹åŠ¡idï¼Œå¹¶æ’å…¥æ–°è¡Œæ•°æ®ï¼Œå¹¶æ›´æ–°å­—æ®µtrx_idä¸ºäº‹åŠ¡idï¼Œæ­¤æ—¶ï¼Œæ’å…¥äº†æ–°çš„æ•°æ®å¹¶ä¸ä¼šåˆ é™¤æ—§çš„ï¼Œæ—§çš„è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚ä½†æ˜¯æ–°ç‰ˆçš„è¡Œæ•°æ®æœ‰åŠæ³•èƒ½æ‰¾åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼›\næ³¨æ„æ–°ç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬æ•°æ®æ—¶ï¼Œä¹Ÿä¼šæ’å…¥ä¸€è¡Œundo logï¼Œä¸€ä¸ªäº‹åŠ¡å¯ä»¥å€ŸåŠ©å…¶äº‹åŠ¡idï¼Œä»å½“å‰æ•°æ®ç‰ˆæœ¬å¼€å§‹è¯»ï¼Œç„¶åç»“åˆæ¯è¡Œæ•°æ®çš„trx_idå’Œundo logï¼Œæ¥è¯»å–åˆ°å½“å‰äº‹åŠ¡å¯è§çš„æ•°æ®ç‰ˆæœ¬ï¼Œæ¥å®ç°ä¸€è‡´æ€§è¯»è§†å›¾ï¼Œä¹Ÿå°±å®ç°äº†å¯é‡å¤è¯»ï¼›\nå°±æ˜¯å½“å‰äº‹åŠ¡idå¯èƒ½æ˜¯100ï¼Œç°åœ¨å¯¹åº”è¡Œçš„æ•°æ®å½“å‰ç‰ˆæœ¬æ˜¯102ï¼Œ100è¿™ä¸ªäº‹åŠ¡å°±é¡ºç€æ•°æ®è¡Œçš„å½“å‰ç‰ˆæœ¬å¼€å§‹æ‰¾ï¼Œç›´åˆ°å‘ç°ä¸€ä¸ªç‰ˆæœ¬\u0026lt;=100æ—¶æ‰è¡Œï¼Œä¹Ÿå°±ä¿è¯äº†ä¸€è‡´æ€§è¯»ï¼Œè¿™é‡Œå°±æ˜¯æ ¹æ®æ•°æ®è¡Œ102ç‰ˆæœ¬çš„undo logæ‰¾åˆ°å‰ä¸€æ¡æ•°æ®è¡Œï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°å‘ç°ä¸€ä¸ªç‰ˆæœ¬\u0026lt;=100ã€‚\n  é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ç°äº†ç§’çº§å¿«ç…§çš„èƒ½åŠ›ï¼\nå½“å‰è¯»ï¼ˆcurrent readï¼‰ # å¦‚æœäº‹åŠ¡ä¸­æ¶‰åŠåˆ°ä¸€äº›æ›´æ–°ç±»çš„æ“ä½œçš„è¯ï¼Œè¿™é‡Œçš„æ›´æ–°æ˜¯åœ¨æ•°æ®â€œæœ€æ–°ç‰ˆæœ¬â€ä¸Šè¿›è¡Œçš„æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨â€œå½“å‰è¯»â€çš„ç‰ˆæœ¬ä¸Šè¿›è¡Œæ›´æ–°ã€‚åç»­çš„è¯»ï¼Œçœ‹ä¸Šå»è¯»å–åˆ°çš„å°±æ˜¯æœ€æ–°å€¼ã€‚\nè¿™å¯èƒ½ä¼šè®©æˆ‘ä»¬è§‰å¾—ï¼Œä¸æˆ‘ä»¬ä¹‹å‰MVCCé‡Œé¢ä¸€è‡´æ€§è¯»æ—¶è¯´çš„ä¸€äº›æœ‰çŸ›ç›¾ã€‚å…¶å®æ²¡æœ‰çŸ›ç›¾çš„ï¼Œåªæ˜¯æ›´æ–°æ“ä½œçš„æ—¶å€™æ˜¯åœ¨å½“å‰è¯»çš„æœ€æ–°æ•°æ®ä¸Šè¿›è¡Œæ›´æ–°ã€‚è€Œåç»­è¯»å–çš„æ—¶å€™ä¾ç„¶æ˜¯æŒ‰ç…§MVCCé‡Œä¸€è‡´æ€§è¯»çš„æ–¹å¼æ¥çš„ã€‚\nå¦‚æœæ›´æ–°æ—¶ä¸æ˜¯æŒ‰ç…§å½“å‰è¯»æ¥æ›´æ–°ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆä»¥å‰å·²ç»æäº¤çš„äº‹åŠ¡æ›´æ–°æ“ä½œä¸¢å¤±äº†ã€‚\næœ‰å‡ ç§åŠæ³•å¯ä»¥å®ç°å½“å‰è¯»ï¼š\n æ›´æ–°æ“ä½œè‚¯å®šæ˜¯å½“å‰è¯»äº†ï¼› select + lock in share modï¼Œä¹Ÿæ˜¯å½“å‰è¯»ï¼› select + for updateï¼Œä¹Ÿæ˜¯å½“å‰è¯»ï¼›  ",content:"å¯åŠ¨äº‹åŠ¡ # å¯åŠ¨äº‹åŠ¡çš„æ–¹å¼æœ‰å“ªäº›ï¼š\n autocommit=1ï¼Œæ¯æ¡è¯­å¥æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡ï¼Œæ¯”å¦‚selectã€updateã€deleteï¼› é€šè¿‡begin/start transactionæ¥å¯åŠ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œä½†æ˜¯è¯¥è¯­å¥å¹¶ä¸æ˜¯äº‹åŠ¡çš„èµ·ç‚¹ï¼Œèµ·ç‚¹æ˜¯åœ¨åé¢çš„ç¬¬ä¸€æ¡sqlè¯­å¥æ‰§è¡Œçš„æ—¶å€™ï¼› start transaction with consistent snapshotï¼Œç«‹å³å¯åŠ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå’Œbegin/start transactionä¸åŒï¼Œè¯¥è¯­å¥æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„èµ·ç‚¹ï¼›  è§†å›¾çš„æ¦‚å¿µ # åœ¨mysqlé‡Œï¼Œè§†å›¾ï¼Œæœ‰ä¸¤ç§æ„æ€ï¼š\n  ä¸€ä¸ªæ˜¯â€œviewâ€ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”¨æŸ¥è¯¢è¯­å¥å®šä¹‰çš„è™šæ‹Ÿè¡¨ï¼Œå¦‚æ‰§è¡Œcreate view select * from tableï¼Œè¯¥è¯­å¥æ‰§è¡Œçš„æ—¶å€™æ‰§è¡ŒæŸ¥è¯¢è¯­å¥è·å¾—ç»“æœå¹¶åˆ›å»ºè§†å›¾ï¼Œå¯ä»¥åœ¨è§†å›¾ä¸Šæ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼ŒæŸ¥è¯¢è¯­æ³•ä¸åœ¨è¡¨ä¸Šçš„æŸ¥è¯¢æ–¹å¼ç±»ä¼¼ï¼›\n  å¦ä¸€ä¸ªæ˜¯InnoDBåœ¨å®ç°MVCCæ—¶ç”¨åˆ°çš„â€œä¸€è‡´æ€§è¯»è§†å›¾â€ï¼Œå³consistent read viewï¼Œç”¨äºæ”¯æŒRCï¼ˆread commitedï¼Œè¯»æäº¤ï¼‰å’ŒRRï¼ˆrepeatable readï¼Œå¯é‡å¤è¯»ï¼‰éš”ç¦»çº§åˆ«çš„å®ç°ï¼›\nå®ƒæ²¡æœ‰ç‰©ç†ç»“æ„ï¼Œä½œç”¨æ˜¯äº‹åŠ¡æ‰§è¡ŒæœŸé—´ç”¨æ¥å®šä¹‰â€œå½“å‰äº‹åŠ¡èƒ½çœ‹åˆ°ä»€ä¹ˆæ•°æ®â€ã€‚\n  â€œå¿«ç…§â€åœ¨MVCCé‡Œæ˜¯æ€ä¹ˆå·¥ä½œçš„ # åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™å°±â€œåˆ›å»ºäº†ä¸ªå¿«ç…§â€ï¼Œè¿™ä¸ªå¿«ç…§æ˜¯åŸºäºæ•´åº“çš„ã€‚\nä½†æ˜¯è¿™é‡Œçš„åˆ›å»ºå¿«ç…§ï¼Œå¹¶ä¸æ˜¯å¤åˆ¶ä¸€ä»½å®Œæ•´çš„æ•°æ®ä½œä¸ºåªè¯»ï¼Œè‚¯å®šä¸èƒ½è¿™æ ·å®ç°ï¼Œæƒ³æƒ³ä¸€ä¸‹ä¸€ä¸ªæ•°æ®åº“å¦‚æœæ•°é‡å¾ˆå¤§ï¼Œå¤åˆ¶çš„å­˜å‚¨å¼€é”€ä¹Ÿå¤ªå¤§äº†ã€‚\nmysql MVCCé‡Œå®ç°çš„è¿™ä¸ªå¿«ç…§éå¸¸èªæ˜ï¼š\n  InnoDBé‡Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡IDï¼Œå«transaction idã€‚å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘InnoDBçš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œæ˜¯æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢çš„ã€‚\n  æ¯è¡Œæ•°æ®ä¹Ÿæ˜¯æœ‰å¤šä¸ªç‰ˆæœ¬çš„ï¼Œè¿™é‡Œçš„ç‰ˆæœ¬å°±ç”¨transaction idæ¥è¡¨ç¤ºã€‚å“ªä¸ªæ•°æ®ç‰ˆæœ¬æ›´åŠ æ–°ä¸€ç‚¹æ—§ä¸€ç‚¹ï¼Œè¿˜æ˜¯æ ¹æ®ç”Ÿæˆè¯¥ç‰ˆæœ¬æ—¶çš„é¡ºåºæ¥å†³å®šçš„ï¼Œæ¯è¡Œæ•°æ®çš„transaction idåˆ™ç”¨æ¥ç»´æŠ¤ä¸€ä¸ªä¸€è‡´æ€§è¯»è§†å›¾ï¼›\n  å½“å¯¹æŸè¡Œæ•°æ®è¿›è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œä¼šç”³è¯·ä¸€ä¸ªæ–°çš„äº‹åŠ¡idï¼Œå¹¶æ’å…¥æ–°è¡Œæ•°æ®ï¼Œå¹¶æ›´æ–°å­—æ®µtrx_idä¸ºäº‹åŠ¡idï¼Œæ­¤æ—¶ï¼Œæ’å…¥äº†æ–°çš„æ•°æ®å¹¶ä¸ä¼šåˆ é™¤æ—§çš„ï¼Œæ—§çš„è¿˜æ˜¯ä¿å­˜ç€çš„ã€‚ä½†æ˜¯æ–°ç‰ˆçš„è¡Œæ•°æ®æœ‰åŠæ³•èƒ½æ‰¾åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ï¼›\næ³¨æ„æ–°ç”Ÿæˆä¸€ä¸ªç‰ˆæœ¬æ•°æ®æ—¶ï¼Œä¹Ÿä¼šæ’å…¥ä¸€è¡Œundo logï¼Œä¸€ä¸ªäº‹åŠ¡å¯ä»¥å€ŸåŠ©å…¶äº‹åŠ¡idï¼Œä»å½“å‰æ•°æ®ç‰ˆæœ¬å¼€å§‹è¯»ï¼Œç„¶åç»“åˆæ¯è¡Œæ•°æ®çš„trx_idå’Œundo logï¼Œæ¥è¯»å–åˆ°å½“å‰äº‹åŠ¡å¯è§çš„æ•°æ®ç‰ˆæœ¬ï¼Œæ¥å®ç°ä¸€è‡´æ€§è¯»è§†å›¾ï¼Œä¹Ÿå°±å®ç°äº†å¯é‡å¤è¯»ï¼›\nå°±æ˜¯å½“å‰äº‹åŠ¡idå¯èƒ½æ˜¯100ï¼Œç°åœ¨å¯¹åº”è¡Œçš„æ•°æ®å½“å‰ç‰ˆæœ¬æ˜¯102ï¼Œ100è¿™ä¸ªäº‹åŠ¡å°±é¡ºç€æ•°æ®è¡Œçš„å½“å‰ç‰ˆæœ¬å¼€å§‹æ‰¾ï¼Œç›´åˆ°å‘ç°ä¸€ä¸ªç‰ˆæœ¬\u0026lt;=100æ—¶æ‰è¡Œï¼Œä¹Ÿå°±ä¿è¯äº†ä¸€è‡´æ€§è¯»ï¼Œè¿™é‡Œå°±æ˜¯æ ¹æ®æ•°æ®è¡Œ102ç‰ˆæœ¬çš„undo logæ‰¾åˆ°å‰ä¸€æ¡æ•°æ®è¡Œï¼Œé‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œç›´åˆ°å‘ç°ä¸€ä¸ªç‰ˆæœ¬\u0026lt;=100ã€‚\n  é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå®ç°äº†ç§’çº§å¿«ç…§çš„èƒ½åŠ›ï¼\nå½“å‰è¯»ï¼ˆcurrent readï¼‰ # å¦‚æœäº‹åŠ¡ä¸­æ¶‰åŠåˆ°ä¸€äº›æ›´æ–°ç±»çš„æ“ä½œçš„è¯ï¼Œè¿™é‡Œçš„æ›´æ–°æ˜¯åœ¨æ•°æ®â€œæœ€æ–°ç‰ˆæœ¬â€ä¸Šè¿›è¡Œçš„æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨â€œå½“å‰è¯»â€çš„ç‰ˆæœ¬ä¸Šè¿›è¡Œæ›´æ–°ã€‚åç»­çš„è¯»ï¼Œçœ‹ä¸Šå»è¯»å–åˆ°çš„å°±æ˜¯æœ€æ–°å€¼ã€‚\nè¿™å¯èƒ½ä¼šè®©æˆ‘ä»¬è§‰å¾—ï¼Œä¸æˆ‘ä»¬ä¹‹å‰MVCCé‡Œé¢ä¸€è‡´æ€§è¯»æ—¶è¯´çš„ä¸€äº›æœ‰çŸ›ç›¾ã€‚å…¶å®æ²¡æœ‰çŸ›ç›¾çš„ï¼Œåªæ˜¯æ›´æ–°æ“ä½œçš„æ—¶å€™æ˜¯åœ¨å½“å‰è¯»çš„æœ€æ–°æ•°æ®ä¸Šè¿›è¡Œæ›´æ–°ã€‚è€Œåç»­è¯»å–çš„æ—¶å€™ä¾ç„¶æ˜¯æŒ‰ç…§MVCCé‡Œä¸€è‡´æ€§è¯»çš„æ–¹å¼æ¥çš„ã€‚\nå¦‚æœæ›´æ–°æ—¶ä¸æ˜¯æŒ‰ç…§å½“å‰è¯»æ¥æ›´æ–°ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆä»¥å‰å·²ç»æäº¤çš„äº‹åŠ¡æ›´æ–°æ“ä½œä¸¢å¤±äº†ã€‚\næœ‰å‡ ç§åŠæ³•å¯ä»¥å®ç°å½“å‰è¯»ï¼š\n æ›´æ–°æ“ä½œè‚¯å®šæ˜¯å½“å‰è¯»äº†ï¼› select + lock in share modï¼Œä¹Ÿæ˜¯å½“å‰è¯»ï¼› select + for updateï¼Œä¹Ÿæ˜¯å½“å‰è¯»ï¼›  "}),a.add({id:170,href:"/blog/07%E8%A1%8C%E9%94%81%E5%8A%9F%E8%BF%87%E6%80%8E%E4%B9%88%E5%87%8F%E5%B0%91%E8%A1%8C%E9%94%81%E5%AF%B9%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D/",title:"07è¡Œé”åŠŸè¿‡ï¼šæ€ä¹ˆå‡å°‘è¡Œé”å¯¹æ€§èƒ½çš„å½±å“",description:"è¡Œé” # è¡Œé”ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å¯¹è¡¨çš„è¡Œè¿›è¡ŒåŠ é”ï¼Œæ˜¯å­˜å‚¨å¼•æ“å±‚æ¥è®¾è®¡å®ç°çš„ï¼š\n MyISAMæ²¡æœ‰è¡Œé”ï¼Œå¯¹è¡¨æ‰§è¡Œæ›´æ–°æ—¶åªèƒ½åŠ è¡¨é”ï¼Œå¹¶å‘åº¦å°±æ¯”è¾ƒä½ InnoDBæ”¯æŒè¡Œé”ï¼Œå¹¶å‘åº¦å°±æ¯”MyISAMé«˜ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨InnoDBä»£æ›¿MyISAM   ps: å‡å°‘è¡Œé”çš„å†²çªï¼Œæœ‰åŠ©äºè¿›ä¸€æ­¥æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚\n ä¸¤é˜¶æ®µå°é”åè®® # åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼š\n åŠ é”ï¼Œæ˜¯åœ¨éœ€è¦çš„æ—¶å€™æŒ‰éœ€åŠ é”ï¼› é‡Šæ”¾é”ï¼Œæ˜¯åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™é‡Šæ”¾é”ï¼›  çŸ¥é“è¿™ä¸ªåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–ç æ—¶è¿›è¡Œä¸€ç‚¹ä¼˜åŒ–ã€‚\nå¦‚æœäº‹åŠ¡æ¶‰åŠåˆ°é”å®šå¤šä¸ªè¡Œçš„æƒ…å†µï¼Œå°½é‡å°†å¯èƒ½å¯¼è‡´é”å†²çªçš„è¡Œæ“ä½œå¾€åæ”¾ï¼Œè¿™æ ·å‡å°‘äº†é”æŒæœ‰æ—¶é—´ï¼Œä»è€Œé™ä½é”å†²çªã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨æœ‰ä¸ªé¡¾å®¢Aä»ç”µå½±é™¢Bä¹°ç”µå½±ç¥¨ï¼Œéœ€è¦æ‰§è¡Œï¼š\n  1ï¼šæ‰£è´¦æˆ·Aä½™é¢çš„æ“ä½œï¼›\n  2ï¼šéœ€è¦ç»™ç”µå½±é™¢Bå¢åŠ ä½™é¢çš„æ“ä½œï¼›\n  3ï¼šè®°å½•ä¸€æ¡äº¤æ˜“æ—¥å¿—ï¼›\n  é‚£è¿™å‡ ä¸ªæ“ä½œè¯¥å¦‚ä½•æ’åºå‘¢ï¼Ÿå› ä¸ºä¼šæœ‰å¾ˆå¤šäººä¹°ç”µå½±ç¥¨ï¼Œæ‰€ä»¥æ“ä½œ2çš„å†²çªæ¦‚ç‡æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ‰€ä»¥å°†2æ’åœ¨æœ€åï¼Œè€Œæ“ä½œ3æ˜¯åœ¨é¢å¤–çš„è¡¨ä¸­è¿½åŠ è®°å½•ï¼ŒåŸºæœ¬ä¸å­˜åœ¨è¡Œå†²çªï¼Œæ‰€ä»¥ä¸å¦‚æ”¾åœ¨æœ€å‰é¢ï¼ŒAå¯èƒ½é™¤äº†ä¹°ç”µå½±ç¥¨è¿˜å¯èƒ½ä¹°å…¶ä»–ï¼Œå†²çªæ¦‚ç‡æ¬¡ä¹‹ã€‚\næ‰€ä»¥æ’åºä¸º3ã€1ã€2æ¯”è¾ƒåˆç†ã€‚\næ­»é”å’Œæ­»é”æ£€æµ‹ # è°ƒæ•´ä¸Šé¢çš„æ“ä½œé¡ºåºï¼Œåªèƒ½å°½é‡å‡å°‘é”å†²çªï¼Œæé«˜å¹¶å‘åº¦ï¼Œä½†æ˜¯ä¸èƒ½å®Œå…¨ä¿è¯é¿å…æ­»é”ã€‚\næ­»é”åŸå›  # é€ æˆæ­»é”çš„åŸå› ï¼Œå°±æ˜¯å¤šä¸ªäº‹åŠ¡ä¸­åŠ é”é¡ºåºä¸ä¸€è‡´ï¼Œé€ æˆäº†å¾ªç¯ä¾èµ–ï¼šæ¯”å¦‚äº‹åŠ¡t1å·²ç»æŒæœ‰äº†é”aï¼Œç°åœ¨ç”³è¯·é”bï¼Œä½†æ˜¯é”bå‘¢å·²ç»è¢«äº‹åŠ¡t2æŒæœ‰ï¼Œäº‹åŠ¡t2è¿˜åœ¨ç”³è¯·é”aï¼Œä½†æ˜¯aå·²ç»è¢«tæŒæœ‰ã€‚è¿™æ ·äº‹åŠ¡t1ã€t2ç›¸äº’ç­‰å¾…å¯¹æ–¹ï¼Œéƒ½æ‹¿ä¸åˆ°é”ï¼Œå°±é€ æˆäº†æ­»é”ã€‚\næ­»é”æ£€æµ‹ # è§£å†³æ­»é”é—®é¢˜ï¼Œæœ‰è¿™ä¹ˆå‡ ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯æ­»é”é¿å…ï¼Œä¸€ç§æ˜¯æ­»é”æ£€æµ‹ã€‚\n  æ­»é”é¿å…ï¼Œå¯ä»¥è®©è·å–é”çš„æ“ä½œæœ‰ä¸€ä¸ªæœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±è¿”å›è·å–é”å¤±è´¥ï¼Œè®©äº‹åŠ¡é€€å‡ºï¼Œäº‹åŠ¡é€€å‡ºçš„æ—¶å€™é‡Šæ”¾æ‰å·²ç»æŒæœ‰çš„é”ï¼Œè¿™æ ·å°±é¿å…äº†æ­»é”ã€‚\nmysqlä¸­å¯ä»¥é€šè¿‡è®¾ç½®å˜é‡innodb_lock_wait_timeoutçš„å€¼æ¥è®¾å®šè¿™ä¸ªè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯50sï¼Œè¿™ä¸ªæ—¶é—´è¿˜æ˜¯å¾ˆé•¿çš„ï¼Œä¸€æ—¦çœŸçš„å‘ç”Ÿäº†æ­»é”ï¼Œå¯¹ä¸šåŠ¡ä¸å¯ç”¨æ—¶é—´ä¹Ÿæ¯”è¾ƒé•¿ï¼Œ50så•Šï¼\nå¦‚æœæŠŠè¿™ä¸ªå˜é‡è®¾ä¸º1så‘¢ï¼Œä¹Ÿä¸è¡Œï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„é”è·å–å¤±è´¥çš„æƒ…å†µï¼Œä½†æ˜¯å¯èƒ½æ˜¯æ­£å¸¸è·å–é”æ“ä½œï¼Œéæ­»é”ï¼Œä¼šé€ æˆå¾ˆå¤šè¯¯ä¼¤ï¼Œä¹Ÿä¸å¥½ï¼\n  æ­»é”æ£€æµ‹ï¼Œé€šè¿‡æ­»é”æ£€æµ‹ç®—æ³•æ¥æ£€æµ‹æ˜¯å¦ä¼šå‡ºç°æ­»é”æ“ä½œï¼Œæ¯”å¦‚è·å–ä¸€ä¸ªé”ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥è¿™ä¸ªé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰ï¼Œæ²¡æœ‰ä¹Ÿå°±æ­£å¸¸æ‹¿åˆ°é”äº†ï¼Œå¦‚æœè¢«çº¿ç¨‹t2æŒæœ‰ï¼Œç»§ç»­æ£€æŸ¥è¿™ä¸ªçº¿ç¨‹t2æœ‰æ²¡æœ‰è¦ç”³è¯·çš„é”è¢«å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å‘èµ·çš„åŠ é”è¯·æ±‚å°†ä¼šå¯¼è‡´ä¸€ä¸ªå¾ªç¯ä¾èµ–ï¼Œä¼šå‘ç”Ÿæ­»é”ã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥ç›´æ¥è®©å½“å‰äº‹åŠ¡å¤±è´¥ï¼Œé‡Šæ”¾é”ï¼Œæˆ–è€…å¹²æ‰å¦ä¸€ä¸ªäº‹åŠ¡t2è®©å®ƒé‡Šæ”¾é”ï¼Œä¹Ÿå°±é¿å…äº†æ­»é”ã€‚\næ­»é”æ£€æµ‹é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œinnodb_deadlock_detectï¼Œé€šè¿‡è¿™ä¸ªå˜é‡æ¥è®¾ç½®ã€‚\n  ç›¸å…³å¼€é”€ # æ­»é”é¿å…è™½ç„¶æ•ˆæœä¸æ€ä¹ˆä»¤äººæ»¡æ„ï¼Œä¸€èˆ¬è¿˜æ˜¯ä¼šå¼€å¯æ­»é”æ£€æµ‹çš„ï¼Œä½†æ˜¯æ­»é”æ£€æµ‹çš„è¿‡ç¨‹å‰é¢ä¹Ÿç®€å•æè¿°äº†ï¼Œå®é™…ä¸Šè¿™ä¸ªæ­»é”æ£€æµ‹çš„è¿‡ç¨‹ä¼šæ›´å¤æ‚ï¼Œå‡å¦‚æœ‰1000ä¸ªçº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹t1å¯èƒ½å¸Œæœ›è·å¾—çº¿ç¨‹t2ä¸Šçš„é”ï¼Œt2å¯èƒ½å¸Œæœ›è·å¾—t3ä¸Šçš„é”ï¼Œ\u0026hellip;.ï¼Œt1000å¯èƒ½å¸Œæœ›è·å¾—å½“å‰çº¿ç¨‹t1çš„é”â€¦â€¦å°±æ˜¯è¦åˆ†æåšå¾ˆå¤šåˆ†ææ‰èƒ½åˆ¤æ–­å‡ºä¼šä¸ä¼šå¯¼è‡´æ­»é”ã€‚\næœ‰çš„æ—¶å€™çº¿ç¨‹æ•°å¤šäº†ä¹‹åï¼Œæ­»é”æ£€æµ‹å¼€é”€ä¹Ÿä¼šæ¯”è¾ƒé«˜ï¼Œè¡¨ç°å°±æ˜¯CPUå ç”¨ç‡å¾ˆé«˜ï¼Œæ¯”å¦‚100%ï¼Œä½†æ˜¯æ¯ç§’å¹¶æ²¡æœ‰æ‰§è¡Œå‡ ä¸ªäº‹åŠ¡ã€‚\nçƒ­ç‚¹è®°å½• # å¯¹äºæŸäº›çƒ­ç‚¹è®°å½•ï¼Œæ›´æ–°é¢‘ç¹çš„è®°å½•ï¼Œè¿™æ ·çš„é”å†²çªçš„æƒ…å†µä¼šæ¯”è¾ƒå¤šï¼Œè€Œä¸”çº¿ç¨‹æ•°ä¹Ÿæ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œé—®é¢˜æ›´æ˜æ˜¾ï¼ŒCPUå ç”¨å¾ˆé«˜ï¼Œä½†æ˜¯æ‰§è¡Œä¸äº†å‡ ä¸ªäº‹åŠ¡ï¼Œå°½ç®¡æ²¡æœ‰çœŸçš„å‘ç”Ÿæ­»é”ã€‚\nå¯¹äºçƒ­ç‚¹è®°å½•å¦‚ä½•è§£å†³å‘¢ï¼Ÿ\n æ–¹æ³•ä¸€ï¼šå°†å¯¹ä¸€æ¡è®°å½•çš„æ“ä½œæ‹†åˆ†æˆå¯¹å¤šä¸ªè®°å½•ï¼Œæ¯æ¬¡æ›´æ–°æ—¶éšæœºé€‰ä¸€æ¡ï¼Œé™ä½é”å†²çªçš„æ¦‚ç‡ï¼Œæ¯”å¦‚æ”¹ä¸ºéšæœºæ›´æ–°10æ¡è®°å½•ä¸­çš„ä¸€æ¡ï¼Œå†²çªæ¦‚ç‡å°±ä¸‹é™ä¸ºåŸæ¥çš„1/10ï¼› æ–¹æ³•äºŒï¼šæ”¹æˆç”¨å†™å¢é‡æµæ°´æ—¥å¿—çš„æ–¹å¼ï¼Œå®šæœŸåœ°å–åˆå¹¶æ—¥å¿—ä¸­çš„æ“ä½œæ›´æ–°åˆ°åŸæ¥çš„é‚£ä¸€æ¡è®°å½•ï¼›  è¿™é‡Œçš„æ€æƒ³ï¼Œå¾ˆåˆ†å¸ƒå¼ç¼“å­˜çƒ­keyçš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè¦ä¹ˆå°±æ˜¯é€šè¿‡å†™å¤šä¸ªkeyæ¥è§£å†³ï¼Œè¦ä¹ˆå°±æ˜¯è®°å½•æµæ°´å¼‚æ­¥æ›´æ–°æ¥è§£å†³ã€‚",content:"è¡Œé” # è¡Œé”ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å¯¹è¡¨çš„è¡Œè¿›è¡ŒåŠ é”ï¼Œæ˜¯å­˜å‚¨å¼•æ“å±‚æ¥è®¾è®¡å®ç°çš„ï¼š\n MyISAMæ²¡æœ‰è¡Œé”ï¼Œå¯¹è¡¨æ‰§è¡Œæ›´æ–°æ—¶åªèƒ½åŠ è¡¨é”ï¼Œå¹¶å‘åº¦å°±æ¯”è¾ƒä½ InnoDBæ”¯æŒè¡Œé”ï¼Œå¹¶å‘åº¦å°±æ¯”MyISAMé«˜ï¼Œæ‰€ä»¥ä¸€èˆ¬ç”¨InnoDBä»£æ›¿MyISAM   ps: å‡å°‘è¡Œé”çš„å†²çªï¼Œæœ‰åŠ©äºè¿›ä¸€æ­¥æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚\n ä¸¤é˜¶æ®µå°é”åè®® # åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼š\n åŠ é”ï¼Œæ˜¯åœ¨éœ€è¦çš„æ—¶å€™æŒ‰éœ€åŠ é”ï¼› é‡Šæ”¾é”ï¼Œæ˜¯åœ¨äº‹åŠ¡æäº¤çš„æ—¶å€™é‡Šæ”¾é”ï¼›  çŸ¥é“è¿™ä¸ªåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–ç æ—¶è¿›è¡Œä¸€ç‚¹ä¼˜åŒ–ã€‚\nå¦‚æœäº‹åŠ¡æ¶‰åŠåˆ°é”å®šå¤šä¸ªè¡Œçš„æƒ…å†µï¼Œå°½é‡å°†å¯èƒ½å¯¼è‡´é”å†²çªçš„è¡Œæ“ä½œå¾€åæ”¾ï¼Œè¿™æ ·å‡å°‘äº†é”æŒæœ‰æ—¶é—´ï¼Œä»è€Œé™ä½é”å†²çªã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨æœ‰ä¸ªé¡¾å®¢Aä»ç”µå½±é™¢Bä¹°ç”µå½±ç¥¨ï¼Œéœ€è¦æ‰§è¡Œï¼š\n  1ï¼šæ‰£è´¦æˆ·Aä½™é¢çš„æ“ä½œï¼›\n  2ï¼šéœ€è¦ç»™ç”µå½±é™¢Bå¢åŠ ä½™é¢çš„æ“ä½œï¼›\n  3ï¼šè®°å½•ä¸€æ¡äº¤æ˜“æ—¥å¿—ï¼›\n  é‚£è¿™å‡ ä¸ªæ“ä½œè¯¥å¦‚ä½•æ’åºå‘¢ï¼Ÿå› ä¸ºä¼šæœ‰å¾ˆå¤šäººä¹°ç”µå½±ç¥¨ï¼Œæ‰€ä»¥æ“ä½œ2çš„å†²çªæ¦‚ç‡æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ‰€ä»¥å°†2æ’åœ¨æœ€åï¼Œè€Œæ“ä½œ3æ˜¯åœ¨é¢å¤–çš„è¡¨ä¸­è¿½åŠ è®°å½•ï¼ŒåŸºæœ¬ä¸å­˜åœ¨è¡Œå†²çªï¼Œæ‰€ä»¥ä¸å¦‚æ”¾åœ¨æœ€å‰é¢ï¼ŒAå¯èƒ½é™¤äº†ä¹°ç”µå½±ç¥¨è¿˜å¯èƒ½ä¹°å…¶ä»–ï¼Œå†²çªæ¦‚ç‡æ¬¡ä¹‹ã€‚\næ‰€ä»¥æ’åºä¸º3ã€1ã€2æ¯”è¾ƒåˆç†ã€‚\næ­»é”å’Œæ­»é”æ£€æµ‹ # è°ƒæ•´ä¸Šé¢çš„æ“ä½œé¡ºåºï¼Œåªèƒ½å°½é‡å‡å°‘é”å†²çªï¼Œæé«˜å¹¶å‘åº¦ï¼Œä½†æ˜¯ä¸èƒ½å®Œå…¨ä¿è¯é¿å…æ­»é”ã€‚\næ­»é”åŸå›  # é€ æˆæ­»é”çš„åŸå› ï¼Œå°±æ˜¯å¤šä¸ªäº‹åŠ¡ä¸­åŠ é”é¡ºåºä¸ä¸€è‡´ï¼Œé€ æˆäº†å¾ªç¯ä¾èµ–ï¼šæ¯”å¦‚äº‹åŠ¡t1å·²ç»æŒæœ‰äº†é”aï¼Œç°åœ¨ç”³è¯·é”bï¼Œä½†æ˜¯é”bå‘¢å·²ç»è¢«äº‹åŠ¡t2æŒæœ‰ï¼Œäº‹åŠ¡t2è¿˜åœ¨ç”³è¯·é”aï¼Œä½†æ˜¯aå·²ç»è¢«tæŒæœ‰ã€‚è¿™æ ·äº‹åŠ¡t1ã€t2ç›¸äº’ç­‰å¾…å¯¹æ–¹ï¼Œéƒ½æ‹¿ä¸åˆ°é”ï¼Œå°±é€ æˆäº†æ­»é”ã€‚\næ­»é”æ£€æµ‹ # è§£å†³æ­»é”é—®é¢˜ï¼Œæœ‰è¿™ä¹ˆå‡ ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯æ­»é”é¿å…ï¼Œä¸€ç§æ˜¯æ­»é”æ£€æµ‹ã€‚\n  æ­»é”é¿å…ï¼Œå¯ä»¥è®©è·å–é”çš„æ“ä½œæœ‰ä¸€ä¸ªæœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±è¿”å›è·å–é”å¤±è´¥ï¼Œè®©äº‹åŠ¡é€€å‡ºï¼Œäº‹åŠ¡é€€å‡ºçš„æ—¶å€™é‡Šæ”¾æ‰å·²ç»æŒæœ‰çš„é”ï¼Œè¿™æ ·å°±é¿å…äº†æ­»é”ã€‚\nmysqlä¸­å¯ä»¥é€šè¿‡è®¾ç½®å˜é‡innodb_lock_wait_timeoutçš„å€¼æ¥è®¾å®šè¿™ä¸ªè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯50sï¼Œè¿™ä¸ªæ—¶é—´è¿˜æ˜¯å¾ˆé•¿çš„ï¼Œä¸€æ—¦çœŸçš„å‘ç”Ÿäº†æ­»é”ï¼Œå¯¹ä¸šåŠ¡ä¸å¯ç”¨æ—¶é—´ä¹Ÿæ¯”è¾ƒé•¿ï¼Œ50så•Šï¼\nå¦‚æœæŠŠè¿™ä¸ªå˜é‡è®¾ä¸º1så‘¢ï¼Œä¹Ÿä¸è¡Œï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šçš„é”è·å–å¤±è´¥çš„æƒ…å†µï¼Œä½†æ˜¯å¯èƒ½æ˜¯æ­£å¸¸è·å–é”æ“ä½œï¼Œéæ­»é”ï¼Œä¼šé€ æˆå¾ˆå¤šè¯¯ä¼¤ï¼Œä¹Ÿä¸å¥½ï¼\n  æ­»é”æ£€æµ‹ï¼Œé€šè¿‡æ­»é”æ£€æµ‹ç®—æ³•æ¥æ£€æµ‹æ˜¯å¦ä¼šå‡ºç°æ­»é”æ“ä½œï¼Œæ¯”å¦‚è·å–ä¸€ä¸ªé”ä¹‹å‰ï¼Œå…ˆæ£€æŸ¥è¿™ä¸ªé”è¢«å“ªä¸ªçº¿ç¨‹æŒæœ‰ï¼Œæ²¡æœ‰ä¹Ÿå°±æ­£å¸¸æ‹¿åˆ°é”äº†ï¼Œå¦‚æœè¢«çº¿ç¨‹t2æŒæœ‰ï¼Œç»§ç»­æ£€æŸ¥è¿™ä¸ªçº¿ç¨‹t2æœ‰æ²¡æœ‰è¦ç”³è¯·çš„é”è¢«å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å‘èµ·çš„åŠ é”è¯·æ±‚å°†ä¼šå¯¼è‡´ä¸€ä¸ªå¾ªç¯ä¾èµ–ï¼Œä¼šå‘ç”Ÿæ­»é”ã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥ç›´æ¥è®©å½“å‰äº‹åŠ¡å¤±è´¥ï¼Œé‡Šæ”¾é”ï¼Œæˆ–è€…å¹²æ‰å¦ä¸€ä¸ªäº‹åŠ¡t2è®©å®ƒé‡Šæ”¾é”ï¼Œä¹Ÿå°±é¿å…äº†æ­»é”ã€‚\næ­»é”æ£€æµ‹é»˜è®¤æ˜¯å¼€å¯çš„ï¼Œinnodb_deadlock_detectï¼Œé€šè¿‡è¿™ä¸ªå˜é‡æ¥è®¾ç½®ã€‚\n  ç›¸å…³å¼€é”€ # æ­»é”é¿å…è™½ç„¶æ•ˆæœä¸æ€ä¹ˆä»¤äººæ»¡æ„ï¼Œä¸€èˆ¬è¿˜æ˜¯ä¼šå¼€å¯æ­»é”æ£€æµ‹çš„ï¼Œä½†æ˜¯æ­»é”æ£€æµ‹çš„è¿‡ç¨‹å‰é¢ä¹Ÿç®€å•æè¿°äº†ï¼Œå®é™…ä¸Šè¿™ä¸ªæ­»é”æ£€æµ‹çš„è¿‡ç¨‹ä¼šæ›´å¤æ‚ï¼Œå‡å¦‚æœ‰1000ä¸ªçº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹t1å¯èƒ½å¸Œæœ›è·å¾—çº¿ç¨‹t2ä¸Šçš„é”ï¼Œt2å¯èƒ½å¸Œæœ›è·å¾—t3ä¸Šçš„é”ï¼Œ\u0026hellip;.ï¼Œt1000å¯èƒ½å¸Œæœ›è·å¾—å½“å‰çº¿ç¨‹t1çš„é”â€¦â€¦å°±æ˜¯è¦åˆ†æåšå¾ˆå¤šåˆ†ææ‰èƒ½åˆ¤æ–­å‡ºä¼šä¸ä¼šå¯¼è‡´æ­»é”ã€‚\næœ‰çš„æ—¶å€™çº¿ç¨‹æ•°å¤šäº†ä¹‹åï¼Œæ­»é”æ£€æµ‹å¼€é”€ä¹Ÿä¼šæ¯”è¾ƒé«˜ï¼Œè¡¨ç°å°±æ˜¯CPUå ç”¨ç‡å¾ˆé«˜ï¼Œæ¯”å¦‚100%ï¼Œä½†æ˜¯æ¯ç§’å¹¶æ²¡æœ‰æ‰§è¡Œå‡ ä¸ªäº‹åŠ¡ã€‚\nçƒ­ç‚¹è®°å½• # å¯¹äºæŸäº›çƒ­ç‚¹è®°å½•ï¼Œæ›´æ–°é¢‘ç¹çš„è®°å½•ï¼Œè¿™æ ·çš„é”å†²çªçš„æƒ…å†µä¼šæ¯”è¾ƒå¤šï¼Œè€Œä¸”çº¿ç¨‹æ•°ä¹Ÿæ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œé—®é¢˜æ›´æ˜æ˜¾ï¼ŒCPUå ç”¨å¾ˆé«˜ï¼Œä½†æ˜¯æ‰§è¡Œä¸äº†å‡ ä¸ªäº‹åŠ¡ï¼Œå°½ç®¡æ²¡æœ‰çœŸçš„å‘ç”Ÿæ­»é”ã€‚\nå¯¹äºçƒ­ç‚¹è®°å½•å¦‚ä½•è§£å†³å‘¢ï¼Ÿ\n æ–¹æ³•ä¸€ï¼šå°†å¯¹ä¸€æ¡è®°å½•çš„æ“ä½œæ‹†åˆ†æˆå¯¹å¤šä¸ªè®°å½•ï¼Œæ¯æ¬¡æ›´æ–°æ—¶éšæœºé€‰ä¸€æ¡ï¼Œé™ä½é”å†²çªçš„æ¦‚ç‡ï¼Œæ¯”å¦‚æ”¹ä¸ºéšæœºæ›´æ–°10æ¡è®°å½•ä¸­çš„ä¸€æ¡ï¼Œå†²çªæ¦‚ç‡å°±ä¸‹é™ä¸ºåŸæ¥çš„1/10ï¼› æ–¹æ³•äºŒï¼šæ”¹æˆç”¨å†™å¢é‡æµæ°´æ—¥å¿—çš„æ–¹å¼ï¼Œå®šæœŸåœ°å–åˆå¹¶æ—¥å¿—ä¸­çš„æ“ä½œæ›´æ–°åˆ°åŸæ¥çš„é‚£ä¸€æ¡è®°å½•ï¼›  è¿™é‡Œçš„æ€æƒ³ï¼Œå¾ˆåˆ†å¸ƒå¼ç¼“å­˜çƒ­keyçš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè¦ä¹ˆå°±æ˜¯é€šè¿‡å†™å¤šä¸ªkeyæ¥è§£å†³ï¼Œè¦ä¹ˆå°±æ˜¯è®°å½•æµæ°´å¼‚æ­¥æ›´æ–°æ¥è§£å†³ã€‚\n"}),a.add({id:171,href:"/tags/locks/",title:"locks",description:"",content:""}),a.add({id:172,href:"/tags/row-lock/",title:"row lock",description:"",content:""}),a.add({id:173,href:"/blog/06%E5%85%A8%E5%B1%80%E9%94%81%E5%92%8C%E8%A1%A8%E9%94%81%E7%BB%99%E8%A1%A8%E5%8A%A0%E4%B8%AA%E5%AD%97%E6%AE%B5%E6%80%8E%E4%B9%88%E8%BF%99%E4%B9%88%E9%9A%BE/",title:"06å…¨å±€é”å’Œè¡¨é”ï¼šç»™è¡¨åŠ ä¸ªå­—æ®µæ€ä¹ˆè¿™ä¹ˆéš¾",description:"æ ¹æ®åŠ é”çš„èŒƒå›´ï¼Œmysqlä¸­çš„é”å¯ä»¥åˆ†ä¸ºï¼šå…¨å±€é”ã€è¡¨é”ã€è¡Œé” 3ç±»ã€‚\nå…¨å±€é” # å…¨å±€é”ï¼Œæ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹è¿›è¡ŒåŠ é”ï¼Œå¦‚é€šè¿‡å‘½ä»¤Flush tables with read lock (FTWRL)åŠ å…¨å±€è¯»é”ï¼Œé”å®šåï¼Œæ•°æ®æ›´æ–°ï¼ˆå¢åˆ æ”¹ï¼‰ã€æ•°æ®å®šä¹‰ï¼ˆå»ºè¡¨ã€ä¿®æ”¹è¡¨ç­‰ï¼‰éƒ½ä¼šè¢«é˜»å¡ã€‚\nå…¶ä½œç”¨ï¼Œä¸»è¦æ˜¯åšå…¨åº“é€»è¾‘å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯æŠŠå…¨è¡¨selectå‡ºæ¥å­˜æˆæ–‡æœ¬ã€‚\nåŠ å…¨å±€è¯»é”ä¹‹åï¼Œå†å¼€å§‹å¤‡ä»½ï¼Œä½†æ˜¯æœ‰é£é™©ï¼š\n å¦‚æœæ˜¯å¯¹ä¸»åº“å¤‡ä»½ï¼Œå¼€äº†å…¨å±€è¯»é”ä¹‹åï¼Œåº“ä¸èƒ½å†™å…¥ï¼Œæ„å‘³ç€ä¸šåŠ¡åŸºæœ¬ä¸å¯ç”¨ï¼› å¦‚æœæ˜¯å¯¹ä»åº“å¤‡ä»½ï¼Œå¼€äº†å…¨å±€è¯»é”ä¹‹åï¼Œä»åº“æ–°åŒæ­¥è¿‡æ¥çš„binlogå‡å¦‚æœ‰è¡¨ç»“æ„ä¿®æ”¹çš„æ“ä½œï¼Œä¼šå¯¼è‡´å› ä¸ºæ‹¿ä¸åˆ°MDLï¼ˆmetadata lockï¼‰è€Œé˜»å¡ï¼Œæ— æ³•ä¿®æ”¹è¡¨ç»“æ„è¿™ä¸€ä¸ªé˜»å¡è¿˜å¥½ï¼Œæ›´ä¸¥é‡çš„æ˜¯ä¼šå¯¼è‡´åç»­æ‰€æœ‰çš„æ‹¿MDLè¯»é”çš„æ“ä½œå¤±è´¥ï¼ŒåŒ…æ‹¬æ­£å¸¸çš„æ›´æ–°æ•°æ®ã€‚å› æ­¤è¿™ç§æ–¹æ³•å®¹æ˜“é€ æˆä¸»ä»åŒæ­¥å»¶è¿Ÿï¼›  **å¤‡ä»½æ•°æ®ï¼Œä¸ºä»€ä¹ˆè¦åŠ é”ï¼Œèƒ½ä¸èƒ½ä¸åŠ é”ï¼Ÿ**ä¸èƒ½ï¼æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œä¸è§£é‡Šï¼\næœ‰æ²¡æœ‰ä¸åŠ å…¨å±€é”çš„æ–¹æ³•ï¼Œæœ‰ï¼Œä½†æ˜¯è¦çœ‹å¼•æ“æ˜¯å¦æ”¯æŒäº‹åŠ¡ï¼š\n  MyISAMå¼•æ“ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œåªèƒ½ç”¨åŠ å…¨å±€è¯»é”çš„æ–¹å¼é”å®šä¹‹åå†å¼€å§‹å¤‡ä»½\n  InnoDBå¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡ï¼Œä¸»åº“å¤‡ä»½çš„æ—¶å€™é€šè¿‡\u0026ndash;single-transactionï¼Œå¼€å¯ç‹¬ç«‹çš„äº‹åŠ¡è¿›è¡Œå¤‡ä»½ï¼š\n å› ä¸ºå¤‡ä»½æ—¶å€™è®¾å®šçš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RRï¼ˆå¯é‡å¤è¯»ï¼‰ï¼Œä¸€è‡´æ€§é—®é¢˜ä¸ç”¨æ‹…å¿ƒäº†ï¼› å¤‡ä»½è¿‡ç¨‹ä¸­ä¹Ÿä¼šæ‹¿MDL lockè¯»é”ï¼Œå¦‚æœå¤‡ä»½è¿‡ç¨‹ä¸­æœ‰è¡¨ç»“æ„æ›´æ–°æ“ä½œï¼Œä¹Ÿå¯èƒ½ä¼šå› ä¸ºæ‹¿ä¸åˆ°MDLå†™é”è€Œé˜»å¡ï¼Œä¹Ÿä¼šé˜»å¡åç»­çš„æ‰€æœ‰æ•°æ®æ›´æ–°åŠ¨ä½œï¼› é’ˆå¯¹ä¸Šé¢é—®é¢˜ï¼ŒAliSQLæäº†ä¸ªPRå·²ç»åˆå…¥MariaDBï¼Œå³å°è¯•ä¿®æ”¹è¡¨çš„æ—¶å€™åŠ ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¿‡äº†è¶…æ—¶æ—¶é—´è¿˜æ²¡æœ‰æ‹¿åˆ°MDLé”ï¼Œåˆ™å¤±è´¥ï¼Œç­‰åç»­é‡è¯•ï¼Œè¿™æ ·è‡³å°‘ä¸ä¼šé˜»å¡æ­£å¸¸çš„æ•°æ®æ›´æ–°æ“ä½œï¼›   è¿™é‡Œæ¶‰åŠäº†è¡¨é”ä¸­çš„ä¸€ç§ï¼šMDLé”\n   åŠ å…¨å±€è¯»é”ï¼Œå¯ä»¥å°†æ•°æ®åº“è®¾ç½®ä¸ºåªè¯»ï¼Œè¿˜æœ‰ä¸€ç§åŠæ³•ï¼Œè®¾ç½®å…¨å±€å˜é‡set global readonly=trueï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ï¼Œé£é™©æ›´é«˜ï¼š\n é€šå¸¸è¿™ä¸ªå±æ€§è¿˜ç”¨æ¥åŒºåˆ†ä¸€ä¸ªæ•°æ®åº“æ˜¯ä¸»åº“è¿˜æ˜¯ä»ä»åº“ï¼Œå¦‚æœè´¸ç„¶ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œå¯èƒ½ä¼šé€ æˆä¸€äº›å…¶ä»–åº”ç”¨çš„è¯¯åˆ¤ï¼› å‡å¦‚å®¢æˆ·ç«¯ç”³è¯·äº†åŠ å…¨å±€é”ä¸”æˆåŠŸä¹‹åï¼Œå¦‚æœå®¢æˆ·ç«¯å´©æºƒäº†ï¼Œè¿™ä¸ªå…¨å±€é”è¿˜æ˜¯å¯ä»¥è‡ªåŠ¨è¢«é‡Šæ”¾æ‰çš„ï¼Œåº“è¿˜æ˜¯å¯ä»¥å†™å…¥çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯é€šè¿‡å…¨å±€å˜é‡å°†åº“è®¾ç½®ä¸ºäº†åªè¯»ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å´©æºƒåï¼Œåº“ä¹Ÿæ˜¯åªè¯»çš„ï¼Œä¸å¯å†™å…¥çš„ï¼›  è¡¨é” # åŠ è¡¨é”ï¼Œä¸»è¦æœ‰ä¸¤ç§å½¢å¼ï¼Œlock tables\u0026hellip; å’Œ MDL lockã€‚\nlock tables \u0026hellip; with read/write #   è¿™ç§åŠ é”æ–¹å¼ï¼Œå¯¹åº”çš„è§£é”æ–¹å¼æ˜¯ unlock tables\n  è¿™ç§åŠ é”æ–¹å¼ï¼Œå¯¹å…¶ä»–çº¿ç¨‹èƒ½å¦è¯»å†™ã€å½“å‰çº¿ç¨‹èƒ½å¦è¯»å†™éƒ½åšäº†æ˜ç¡®çš„é™åˆ¶ã€‚å‡å®šå½“å‰çº¿ç¨‹pè¯»è¡¨t1åŠ è¯»é”ã€å¯¹è¡¨t2åŠ å†™é”ï¼Œé‚£ä¹ˆï¼š\n å…¶ä»–çº¿ç¨‹qæ˜¯ä¸èƒ½å¯¹t1æ‰§è¡Œå†™æ“ä½œçš„ï¼Œå¯¹t2ä¹Ÿä¸èƒ½æ‰§è¡Œè¯»æ“ä½œï¼Œè¿™ä¸ªå¥½ç†è§£ï¼› å½“å‰çº¿ç¨‹pä¹Ÿæ˜¯ä¸èƒ½å¯¹t1æ‰§è¡Œå†™æ“ä½œçš„ï¼Œä¹Ÿä¸èƒ½å¯¹t2æ‰§è¡Œè¯»æ“ä½œï¼›   å¯ä»¥ç†è§£æˆæ²¡æœ‰è€ƒè™‘é”çš„é‡å…¥ã€è¯»å†™æ’ä»–æ€§ï¼›",content:"æ ¹æ®åŠ é”çš„èŒƒå›´ï¼Œmysqlä¸­çš„é”å¯ä»¥åˆ†ä¸ºï¼šå…¨å±€é”ã€è¡¨é”ã€è¡Œé” 3ç±»ã€‚\nå…¨å±€é” # å…¨å±€é”ï¼Œæ˜¯å¯¹æ•´ä¸ªæ•°æ®åº“å®ä¾‹è¿›è¡ŒåŠ é”ï¼Œå¦‚é€šè¿‡å‘½ä»¤Flush tables with read lock (FTWRL)åŠ å…¨å±€è¯»é”ï¼Œé”å®šåï¼Œæ•°æ®æ›´æ–°ï¼ˆå¢åˆ æ”¹ï¼‰ã€æ•°æ®å®šä¹‰ï¼ˆå»ºè¡¨ã€ä¿®æ”¹è¡¨ç­‰ï¼‰éƒ½ä¼šè¢«é˜»å¡ã€‚\nå…¶ä½œç”¨ï¼Œä¸»è¦æ˜¯åšå…¨åº“é€»è¾‘å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯æŠŠå…¨è¡¨selectå‡ºæ¥å­˜æˆæ–‡æœ¬ã€‚\nåŠ å…¨å±€è¯»é”ä¹‹åï¼Œå†å¼€å§‹å¤‡ä»½ï¼Œä½†æ˜¯æœ‰é£é™©ï¼š\n å¦‚æœæ˜¯å¯¹ä¸»åº“å¤‡ä»½ï¼Œå¼€äº†å…¨å±€è¯»é”ä¹‹åï¼Œåº“ä¸èƒ½å†™å…¥ï¼Œæ„å‘³ç€ä¸šåŠ¡åŸºæœ¬ä¸å¯ç”¨ï¼› å¦‚æœæ˜¯å¯¹ä»åº“å¤‡ä»½ï¼Œå¼€äº†å…¨å±€è¯»é”ä¹‹åï¼Œä»åº“æ–°åŒæ­¥è¿‡æ¥çš„binlogå‡å¦‚æœ‰è¡¨ç»“æ„ä¿®æ”¹çš„æ“ä½œï¼Œä¼šå¯¼è‡´å› ä¸ºæ‹¿ä¸åˆ°MDLï¼ˆmetadata lockï¼‰è€Œé˜»å¡ï¼Œæ— æ³•ä¿®æ”¹è¡¨ç»“æ„è¿™ä¸€ä¸ªé˜»å¡è¿˜å¥½ï¼Œæ›´ä¸¥é‡çš„æ˜¯ä¼šå¯¼è‡´åç»­æ‰€æœ‰çš„æ‹¿MDLè¯»é”çš„æ“ä½œå¤±è´¥ï¼ŒåŒ…æ‹¬æ­£å¸¸çš„æ›´æ–°æ•°æ®ã€‚å› æ­¤è¿™ç§æ–¹æ³•å®¹æ˜“é€ æˆä¸»ä»åŒæ­¥å»¶è¿Ÿï¼›  **å¤‡ä»½æ•°æ®ï¼Œä¸ºä»€ä¹ˆè¦åŠ é”ï¼Œèƒ½ä¸èƒ½ä¸åŠ é”ï¼Ÿ**ä¸èƒ½ï¼æ•°æ®ä¸€è‡´æ€§ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œä¸è§£é‡Šï¼\næœ‰æ²¡æœ‰ä¸åŠ å…¨å±€é”çš„æ–¹æ³•ï¼Œæœ‰ï¼Œä½†æ˜¯è¦çœ‹å¼•æ“æ˜¯å¦æ”¯æŒäº‹åŠ¡ï¼š\n  MyISAMå¼•æ“ï¼Œä¸æ”¯æŒäº‹åŠ¡ï¼Œåªèƒ½ç”¨åŠ å…¨å±€è¯»é”çš„æ–¹å¼é”å®šä¹‹åå†å¼€å§‹å¤‡ä»½\n  InnoDBå¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡ï¼Œä¸»åº“å¤‡ä»½çš„æ—¶å€™é€šè¿‡\u0026ndash;single-transactionï¼Œå¼€å¯ç‹¬ç«‹çš„äº‹åŠ¡è¿›è¡Œå¤‡ä»½ï¼š\n å› ä¸ºå¤‡ä»½æ—¶å€™è®¾å®šçš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯RRï¼ˆå¯é‡å¤è¯»ï¼‰ï¼Œä¸€è‡´æ€§é—®é¢˜ä¸ç”¨æ‹…å¿ƒäº†ï¼› å¤‡ä»½è¿‡ç¨‹ä¸­ä¹Ÿä¼šæ‹¿MDL lockè¯»é”ï¼Œå¦‚æœå¤‡ä»½è¿‡ç¨‹ä¸­æœ‰è¡¨ç»“æ„æ›´æ–°æ“ä½œï¼Œä¹Ÿå¯èƒ½ä¼šå› ä¸ºæ‹¿ä¸åˆ°MDLå†™é”è€Œé˜»å¡ï¼Œä¹Ÿä¼šé˜»å¡åç»­çš„æ‰€æœ‰æ•°æ®æ›´æ–°åŠ¨ä½œï¼› é’ˆå¯¹ä¸Šé¢é—®é¢˜ï¼ŒAliSQLæäº†ä¸ªPRå·²ç»åˆå…¥MariaDBï¼Œå³å°è¯•ä¿®æ”¹è¡¨çš„æ—¶å€™åŠ ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå¦‚æœè¿‡äº†è¶…æ—¶æ—¶é—´è¿˜æ²¡æœ‰æ‹¿åˆ°MDLé”ï¼Œåˆ™å¤±è´¥ï¼Œç­‰åç»­é‡è¯•ï¼Œè¿™æ ·è‡³å°‘ä¸ä¼šé˜»å¡æ­£å¸¸çš„æ•°æ®æ›´æ–°æ“ä½œï¼›   è¿™é‡Œæ¶‰åŠäº†è¡¨é”ä¸­çš„ä¸€ç§ï¼šMDLé”\n   åŠ å…¨å±€è¯»é”ï¼Œå¯ä»¥å°†æ•°æ®åº“è®¾ç½®ä¸ºåªè¯»ï¼Œè¿˜æœ‰ä¸€ç§åŠæ³•ï¼Œè®¾ç½®å…¨å±€å˜é‡set global readonly=trueï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ï¼Œé£é™©æ›´é«˜ï¼š\n é€šå¸¸è¿™ä¸ªå±æ€§è¿˜ç”¨æ¥åŒºåˆ†ä¸€ä¸ªæ•°æ®åº“æ˜¯ä¸»åº“è¿˜æ˜¯ä»ä»åº“ï¼Œå¦‚æœè´¸ç„¶ä¿®æ”¹è¿™ä¸ªå˜é‡ï¼Œå¯èƒ½ä¼šé€ æˆä¸€äº›å…¶ä»–åº”ç”¨çš„è¯¯åˆ¤ï¼› å‡å¦‚å®¢æˆ·ç«¯ç”³è¯·äº†åŠ å…¨å±€é”ä¸”æˆåŠŸä¹‹åï¼Œå¦‚æœå®¢æˆ·ç«¯å´©æºƒäº†ï¼Œè¿™ä¸ªå…¨å±€é”è¿˜æ˜¯å¯ä»¥è‡ªåŠ¨è¢«é‡Šæ”¾æ‰çš„ï¼Œåº“è¿˜æ˜¯å¯ä»¥å†™å…¥çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯é€šè¿‡å…¨å±€å˜é‡å°†åº“è®¾ç½®ä¸ºäº†åªè¯»ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å´©æºƒåï¼Œåº“ä¹Ÿæ˜¯åªè¯»çš„ï¼Œä¸å¯å†™å…¥çš„ï¼›  è¡¨é” # åŠ è¡¨é”ï¼Œä¸»è¦æœ‰ä¸¤ç§å½¢å¼ï¼Œlock tables\u0026hellip; å’Œ MDL lockã€‚\nlock tables \u0026hellip; with read/write #   è¿™ç§åŠ é”æ–¹å¼ï¼Œå¯¹åº”çš„è§£é”æ–¹å¼æ˜¯ unlock tables\n  è¿™ç§åŠ é”æ–¹å¼ï¼Œå¯¹å…¶ä»–çº¿ç¨‹èƒ½å¦è¯»å†™ã€å½“å‰çº¿ç¨‹èƒ½å¦è¯»å†™éƒ½åšäº†æ˜ç¡®çš„é™åˆ¶ã€‚å‡å®šå½“å‰çº¿ç¨‹pè¯»è¡¨t1åŠ è¯»é”ã€å¯¹è¡¨t2åŠ å†™é”ï¼Œé‚£ä¹ˆï¼š\n å…¶ä»–çº¿ç¨‹qæ˜¯ä¸èƒ½å¯¹t1æ‰§è¡Œå†™æ“ä½œçš„ï¼Œå¯¹t2ä¹Ÿä¸èƒ½æ‰§è¡Œè¯»æ“ä½œï¼Œè¿™ä¸ªå¥½ç†è§£ï¼› å½“å‰çº¿ç¨‹pä¹Ÿæ˜¯ä¸èƒ½å¯¹t1æ‰§è¡Œå†™æ“ä½œçš„ï¼Œä¹Ÿä¸èƒ½å¯¹t2æ‰§è¡Œè¯»æ“ä½œï¼›   å¯ä»¥ç†è§£æˆæ²¡æœ‰è€ƒè™‘é”çš„é‡å…¥ã€è¯»å†™æ’ä»–æ€§ï¼›\n   MDL lock # è¡¨çš„å®šä¹‰éƒ½è®°å½•åœ¨è¡¨çš„å…ƒä¿¡æ¯é‡Œï¼Œè¦å¯¹è¡¨æ‰§è¡Œå¢åˆ æ”¹æŸ¥ç­‰DMLæ“ä½œï¼Œæˆ–è€…å¯¹è¡¨æ‰§è¡Œè¡¨ç»“æ„ä¿®æ”¹ç­‰DDLæ“ä½œæ—¶ï¼Œéƒ½éœ€è¦ç°è·å–è¡¨çš„MDLé”ã€‚å¢åˆ æ”¹æŸ¥å°±æ˜¯MDLè¯»é”ï¼Œä¿®æ”¹è¡¨ç»“æ„å°±æ˜¯æ‹¿MDLå†™é”ã€‚\nMDLé”ä¹Ÿæ˜¯æ˜¯æœ‰å¯èƒ½å¯¼è‡´æ•°æ®åº“æ“ä½œé˜»å¡çš„ã€‚åœ¨å‰é¢æè¿°æ•°æ®åº“å¤‡ä»½æ“ä½œæ—¶ï¼Œæˆ‘ä»¬ä»‹ç»äº†InnoDBé€šè¿‡\u0026ndash;single-transactionæ¥è¿›è¡Œå¤‡ä»½çš„æ–¹æ³•ï¼Œå…¶ä¸­æè¿°äº†MDLè¯»å†™é”æ’ä»–æ€§å¯¹å¤‡ä»½è¿‡ç¨‹ã€binlogä¸»å¤‡åŒæ­¥å»¶è¿Ÿçš„å½±å“ã€‚\nä¹Ÿä»‹ç»äº†å¦‚ä½•å°½é‡è§„é¿è¿™ä¸ªé—®é¢˜ï¼šå°è¯•ä¿®æ”¹è¡¨ç»“æ„ï¼ˆMDLå†™é”ï¼‰æ—¶åŠ ä¸ªè¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡è¿›è€Œå¯¼è‡´åç»­çš„æ•°æ®æ›´æ–°æ“ä½œå¤±è´¥ï¼ˆæˆ–è€…ï¼Œå¯¼è‡´ä¸»å¤‡åŒæ­¥å»¶è¿Ÿè¿‡å¤§ï¼‰ã€‚\nè¡Œé” # è¡Œé”ï¼ŒInnoDBæ‰§è¡Œå¼•æ“æ”¯æŒå¯¹åŠ è¡Œé”ï¼Œä»¥å‰ä¸æ”¯æŒè¡Œé”çš„æ—¶å€™ï¼Œå°±è¦é€šè¿‡è¡¨é”æ¥è§£å†³ï¼Œå…ˆé”è¡¨ï¼Œå†ä¿®æ”¹ã€å†è§£é”è¡¨ï¼Œè¿™ç§æ•ˆç‡æ¯”è¾ƒä½ã€‚\n æ‰§è¡Œå¼•æ“ï¼šæ¨èç°åœ¨æ²¡æœ‰ä½¿ç”¨InnoDBæ‰§è¡Œå¼•æ“çš„æ›´æ¢æ•°æ®åº“å¼•æ“ä¸ºInnoDBï¼› ä»£ç å†™æ³•ï¼šæœ‰äº›è™½ç„¶æ›´æ¢äº†å¼•æ“ï¼Œä½†æ˜¯ä»£ç ä¸­è¿˜æ˜¯ç”¨çš„lock tablesã€unlock tablesï¼Œè¿™ç§ä¸€èˆ¬æ›¿æ¢æˆbeginã€commitå°±å¯ä»¥äº†ï¼›  "}),a.add({id:174,href:"/tags/global-lock/",title:"global lock",description:"",content:""}),a.add({id:175,href:"/tags/lock-tables/",title:"lock tables",description:"",content:""}),a.add({id:176,href:"/tags/mdl-lock/",title:"mdl lock",description:"",content:""}),a.add({id:177,href:"/tags/table-lock/",title:"table lock",description:"",content:""}),a.add({id:178,href:"/blog/05%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95%E4%B8%8B/",title:"05ç´¢å¼•åŸç†ï¼šæ·±å…¥æµ…å‡ºç´¢å¼•ï¼ˆä¸‹ï¼‰",description:"å‰é¢ä»‹ç»äº†å¸¸è§çš„æŸ¥è¯¢ç±»å‹ï¼Œæ”¯æŒæŸ¥è¯¢çš„å¸¸ç”¨æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œç„¶åä»‹ç»äº†InnoDBæ‰§è¡Œå¼•æ“B+æ ‘çš„ä¼˜åŠ¿ï¼Œä¸»è¦æ˜¯å’Œæœºæ¢°ç¡¬ç›˜çš„ç‰¹æ€§ç»“åˆèµ·æ¥å®ç°é«˜æ€§èƒ½çš„è¯»å†™ï¼Œä¹Ÿæè¿°äº†B+æ ‘å±‚é«˜ä¸å¯å­˜å‚¨çš„æ•°æ®é‡çš„è®¡ç®—æ–¹å¼ï¼Œç­‰ç­‰å§ã€‚\nè¿™é‡Œé‡ç‚¹ä»‹ç»ä¸‹ç´¢å¼•çš„è®¾è®¡ã€ä½¿ç”¨æ–¹é¢çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œä¸‹é¢è®¨è®ºçš„éƒ½æ˜¯InnoDB B+æ ‘ã€‚\nuser(id,name,age), pk(id),index(name)\n  ä¸»é”®ç´¢å¼•\nb+æ ‘ä¸­ç´¢å¼•èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å…³é”®å­—ä»¥åŠæŒ‡é’ˆï¼ŒæŒ‡å‘æŒ‡å‘ç´¢å¼•èŠ‚ç‚¹æˆ–è€…æ•°æ®èŠ‚ç‚¹çš„pageã€‚ç´¢å¼•ä¸­çš„å…³é”®å­—ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåˆ—å­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªåˆ—å­—æ®µï¼Œå¦‚æœæ˜¯å¤šä¸ªåˆ—å­—æ®µçš„è¯ï¼Œå®ƒä»¬å‡ºç°çš„é¡ºåºå°±æ˜¯å®šä¹‰ç´¢å¼•æ—¶å†™çš„é¡ºåºã€‚\ninnodbä¸»é”®ç´¢å¼•æ˜¯èšé›†ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹ä¸­çš„æ•°æ®ç›´æ¥åŒ…å«äº†è®°å½•è¡Œçš„æ•°æ®ã€‚\n  æ™®é€šç´¢å¼•\nå…¶ä»–æ™®é€šç´¢å¼•ï¼Œæ¯”å¦‚idä¸ºä¸»é”®ï¼Œåœ¨nameä¸Šåˆ›å»ºç´¢å¼•ï¼Œè¿™ç§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­è®°å½•çš„ä¸»é”®çš„idï¼Œå¦‚æœè¦é€šè¿‡nameå»æŸ¥ageä¹‹ç±»çš„å…¶ä»–å­—æ®µä¿¡æ¯ï¼Œè¦å…ˆé€šè¿‡è¿™é‡Œçš„nameç´¢å¼•æŸ¥åˆ°idï¼Œç„¶åå›è¡¨ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥æ‰¾åˆ°å¯¹åº”çš„è®°å½•åï¼ˆå®é™…ä¸Šæ˜¯ä¸»é”®ç´¢å¼•æŸ¥æ‰¾åˆ°æŒ‡é’ˆå¯¹åº”çš„pageï¼Œç„¶åéå†pageé‡Œé¢çš„å„ä¸ªè®°å½•æ‰¾åˆ°çš„ï¼‰ï¼Œå†å»æ‹¿åˆ°ageç­‰å…¶ä»–ä¿¡æ¯ã€‚\næ‰€ä»¥æ™®é€šç´¢å¼•è¿™æ ·æŸ¥èµ·æ¥ä¼šå¤šä¸€æ¬¡å›è¡¨çš„æ“ä½œã€‚\n  è¦†ç›–ç´¢å¼•\nå‡å¦‚è¯´ç°åœ¨æˆ‘æƒ³é€šè¿‡nameï¼Œç›´æ¥æŸ¥æ‰¾åˆ°å¯¹åº”çš„ageè¡Œä¸è¡Œå•Šï¼Œä¸æƒ³å…ˆæŸ¥åˆ°idï¼Œå†å›è¡¨æŸ¥ã€‚ä¸å›è¡¨çš„è¯ï¼Œå°±å¯ä»¥è€ƒè™‘ç´¢å¼•è¦†ç›–ï¼Œæ¯”å¦‚åˆ›å»ºä¸ªç´¢å¼•index(name,age)ï¼Œè¿™æ ·å°±ä¼šå…ˆé€šè¿‡è¿™ä¸ªç»„åˆç´¢å¼•ä¸­çš„nameæ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹ä¸­ä¹ŸåŒ…å«äº†ageè¿™ä¸ªå…³é”®å­—ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ageã€‚\nå½“ç„¶nameæœ‰å¯èƒ½é‡å¤ï¼Œæ‰€ä»¥å¯èƒ½æŸ¥è¯¢ç»“æœä¸æ˜¯å•æ¡è®°å½•ï¼Œé‚£è¿˜å¾—æ²¿ç€è¿™ä¸ªç¬¬ä¸€æ¬¡æ‰¾åˆ°çš„èŠ‚ç‚¹ï¼Œå‘å³éå†å¶å­èŠ‚ç‚¹åˆ—è¡¨ï¼ŒçŸ¥é“nameä¸æ»¡è¶³ä¸ºæ­¢ã€‚\nç”±äºç´¢å¼•ä¸­åŒ…å«äº†ageï¼Œä¹Ÿå°±ä¸éœ€è¦å›è¡¨äº†ã€‚\n  æœ€å·¦å‰ç¼€åŸåˆ™\nåˆ›å»ºç»„åˆï¼ˆè”åˆï¼‰ç´¢å¼•ä¹‹åï¼ŒæŸ¥è¯¢çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ï¼Œè¦ç”¨æœ€å·¦åŒ¹é…åŸåˆ™æ‰èƒ½åº”ç”¨ç´¢å¼•ï¼Œå¦åˆ™ç”¨ä¸ä¸Šç´¢å¼•ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬å®šä¹‰ç´¢å¼•çš„æ—¶å€™æ˜¯index(name,age)ï¼Œé‚£ä¹ˆä½ æŸ¥è¯¢åˆ°æ—¶å€™where age=xxx and name=yyyï¼Œè¿™ç§å°±æ²¡æœ‰ä¼˜å…ˆç”¨nameï¼ŒæŸ¥è¯¢æ¯”è¾ƒçš„æ—¶å€™å°±ç”¨ä¸ä¸Šç´¢å¼•ï¼Œä½†æ˜¯where name=yyy and age=xxxå°±èƒ½ç”¨ä¸Šç´¢å¼•ã€‚\nä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿb+æ•°ç´¢å¼•èŠ‚ç‚¹ä¸­å…³é”®å­—ï¼Œæ˜¯æŒ‰ç…§å®šä¹‰ç´¢å¼•æ—¶å­—æ®µçš„é¡ºåºè®¾ç½®çš„ï¼Œæ¯”è¾ƒçš„æ—¶å€™ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥æ¯”è¾ƒã€‚\n å¦‚ä½•å®‰æ’ç»„åˆç´¢å¼•å†…çš„å­—æ®µé¡ºåºï¼Ÿå°†æ›´å®¹æ˜“ç”¨åˆ°çš„æ”¾å‰é¢ï¼Œè¿™æ ·å¯ä»¥æé«˜å¤ç”¨çš„ç¨‹åº¦ã€‚ ç”±äºå»ºç«‹äº†ç´¢å¼•index(a,b)ï¼Œæœ€å·¦å‰ç¼€å¯ä»¥åœ¨aä¸Šå¼•ç”¨ç´¢å¼•ï¼Œä¹Ÿå°±ä¸éœ€è¦å†å•ç‹¬ä¸ºaå»ºç«‹ç´¢å¼•index(a)äº†ã€‚ å¦å¤–å°±æ˜¯è¦è€ƒè™‘ç©ºé—´åŸåˆ™ï¼Œæ˜¯ä¸æ˜¯ä¸€å®šè¦(nameï¼Œage)å»ºè”åˆç´¢å¼•ï¼Œé‚£å°±å¾—è€ƒè™‘ç”¨çš„é¢‘ç‡äº†ï¼Œå¦‚æœè¿™ç§æŸ¥è¯¢åœºæ™¯ä¸å¤šï¼ŒæŸ¥è¯¢æ•ˆç‡è¦æ±‚ä¹Ÿä¸é«˜ï¼Œé‚£ä¹ˆç¡®å®ä¸é€‚åˆå»ºç«‹è”åˆç´¢å¼•ï¼Œæµªè´¹å­˜å‚¨ç©ºé—´å•Šã€‚ä½†æ˜¯ä¹Ÿä¸èƒ½å…¨è¡¨æ‰«æé‚£ä¹ˆæ…¢å§ï¼Œè¿™ä¸ªæ—¶å€™ä¸ºnameå»ºä¸ªç´¢å¼•ï¼Œå›è¡¨æŸ¥ageï¼Œè¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚    ç´¢å¼•ä¸‹æ¨\nå¯¹äºç»„åˆç´¢å¼•index(a,b,c)ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨æœ€å·¦å‰ç¼€åŒ¹é…çš„æ–¹å¼æ¥åº”ç”¨ç´¢å¼•ï¼Œé‚£ä¹ˆå¦‚æœæŸ¥è¯¢çš„æ—¶å€™ç¬¬ä¸€åˆ—æ˜¯åŒ¹é…çš„ï¼Œç¬¬äºŒåˆ—ä¸é…çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ\n5.6ä»¥å‰çš„è¯ï¼Œä¼šç›´æ¥æ ¹æ®åŒ¹é…åˆ°çš„aå›è¡¨ï¼ŒæŸ¥å‡ºè®°å½•åå†å¯¹æ¯”bæ˜¯å¦åŒ¹é…ï¼Œä¸åŒ¹é…å†è¿‡æ»¤æ‰ï¼Œå¾ˆæ˜æ˜¾è¿™ç§æ•ˆç‡æ˜¯æ¯”è¾ƒä½çš„ã€‚\n5.6ä»¥åçš„è¯ï¼Œå¼•å…¥äº†ç´¢å¼•ä¸‹æ¨ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Œå°±æ˜¯åœ¨ç»„åˆç´¢å¼•ä¸Šéå†çš„æ—¶å€™å°±ç›´æ¥æ¯”è¾ƒå…¶ä»–å‡ ä¸ªç´¢å¼•åˆ—å­—æ®µæ˜¯å¦åŒ¹é…ï¼Œä¸åŒ¹é…ç›´æ¥è¿‡æ»¤æ‰ï¼Œä¹Ÿä¸ç”¨å›è¡¨äº†ï¼Œå‡å°‘äº†å›è¡¨æ¬¡æ•°ï¼Œæ•ˆç‡è‡ªç„¶ä¹Ÿå°±é«˜äº†ã€‚\nèŒƒå›´æŸ¥è¯¢ï¼šè¯´ä¸‹èŒƒå›´æŸ¥è¯¢å¤§è‡´æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ\næœ€åè¯´ä¸‹èŒƒå›´æŸ¥è¯¢ï¼Œæ¯”å¦‚ userè¡¨ä¸Šçš„ç´¢å¼•æœ‰pk(id), age(name)ï¼Œç°åœ¨æŸ¥è¯¢select name,age from user where age\u0026gt;25 and age\u0026lt;30 ï¼Œè¿™ä¸ªæ—¶å€™ä¼šç°åœ¨index(age)è¿™ä¸ªç´¢å¼•ä¸Šæ‰¾åˆ°age\u0026gt;25çš„ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œç„¶åä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹ï¼Œæ²¿ç€å¶å­èŠ‚ç‚¹é“¾è¡¨ï¼Œç›´æ¥å‘å³éå†ï¼Œå› ä¸ºéƒ½æ˜¯æŒ‰ç…§ageæœ‰åºçš„å˜›ï¼Œæ¯éå†ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå›è¡¨æŸ¥è¯¢nameå‡å¦‚ç»“æœé›†ï¼Œç›´åˆ°å‘ç°age\u0026lt;30ä¸æˆç«‹ç»“æŸã€‚\n  g",content:"å‰é¢ä»‹ç»äº†å¸¸è§çš„æŸ¥è¯¢ç±»å‹ï¼Œæ”¯æŒæŸ¥è¯¢çš„å¸¸ç”¨æ•°æ®ç»“æ„å’Œç®—æ³•ï¼Œç„¶åä»‹ç»äº†InnoDBæ‰§è¡Œå¼•æ“B+æ ‘çš„ä¼˜åŠ¿ï¼Œä¸»è¦æ˜¯å’Œæœºæ¢°ç¡¬ç›˜çš„ç‰¹æ€§ç»“åˆèµ·æ¥å®ç°é«˜æ€§èƒ½çš„è¯»å†™ï¼Œä¹Ÿæè¿°äº†B+æ ‘å±‚é«˜ä¸å¯å­˜å‚¨çš„æ•°æ®é‡çš„è®¡ç®—æ–¹å¼ï¼Œç­‰ç­‰å§ã€‚\nè¿™é‡Œé‡ç‚¹ä»‹ç»ä¸‹ç´¢å¼•çš„è®¾è®¡ã€ä½¿ç”¨æ–¹é¢çš„ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œä¸‹é¢è®¨è®ºçš„éƒ½æ˜¯InnoDB B+æ ‘ã€‚\nuser(id,name,age), pk(id),index(name)\n  ä¸»é”®ç´¢å¼•\nb+æ ‘ä¸­ç´¢å¼•èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯å…³é”®å­—ä»¥åŠæŒ‡é’ˆï¼ŒæŒ‡å‘æŒ‡å‘ç´¢å¼•èŠ‚ç‚¹æˆ–è€…æ•°æ®èŠ‚ç‚¹çš„pageã€‚ç´¢å¼•ä¸­çš„å…³é”®å­—ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªåˆ—å­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªåˆ—å­—æ®µï¼Œå¦‚æœæ˜¯å¤šä¸ªåˆ—å­—æ®µçš„è¯ï¼Œå®ƒä»¬å‡ºç°çš„é¡ºåºå°±æ˜¯å®šä¹‰ç´¢å¼•æ—¶å†™çš„é¡ºåºã€‚\ninnodbä¸»é”®ç´¢å¼•æ˜¯èšé›†ç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹ä¸­çš„æ•°æ®ç›´æ¥åŒ…å«äº†è®°å½•è¡Œçš„æ•°æ®ã€‚\n  æ™®é€šç´¢å¼•\nå…¶ä»–æ™®é€šç´¢å¼•ï¼Œæ¯”å¦‚idä¸ºä¸»é”®ï¼Œåœ¨nameä¸Šåˆ›å»ºç´¢å¼•ï¼Œè¿™ç§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ä¸­è®°å½•çš„ä¸»é”®çš„idï¼Œå¦‚æœè¦é€šè¿‡nameå»æŸ¥ageä¹‹ç±»çš„å…¶ä»–å­—æ®µä¿¡æ¯ï¼Œè¦å…ˆé€šè¿‡è¿™é‡Œçš„nameç´¢å¼•æŸ¥åˆ°idï¼Œç„¶åå›è¡¨ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥æ‰¾åˆ°å¯¹åº”çš„è®°å½•åï¼ˆå®é™…ä¸Šæ˜¯ä¸»é”®ç´¢å¼•æŸ¥æ‰¾åˆ°æŒ‡é’ˆå¯¹åº”çš„pageï¼Œç„¶åéå†pageé‡Œé¢çš„å„ä¸ªè®°å½•æ‰¾åˆ°çš„ï¼‰ï¼Œå†å»æ‹¿åˆ°ageç­‰å…¶ä»–ä¿¡æ¯ã€‚\næ‰€ä»¥æ™®é€šç´¢å¼•è¿™æ ·æŸ¥èµ·æ¥ä¼šå¤šä¸€æ¬¡å›è¡¨çš„æ“ä½œã€‚\n  è¦†ç›–ç´¢å¼•\nå‡å¦‚è¯´ç°åœ¨æˆ‘æƒ³é€šè¿‡nameï¼Œç›´æ¥æŸ¥æ‰¾åˆ°å¯¹åº”çš„ageè¡Œä¸è¡Œå•Šï¼Œä¸æƒ³å…ˆæŸ¥åˆ°idï¼Œå†å›è¡¨æŸ¥ã€‚ä¸å›è¡¨çš„è¯ï¼Œå°±å¯ä»¥è€ƒè™‘ç´¢å¼•è¦†ç›–ï¼Œæ¯”å¦‚åˆ›å»ºä¸ªç´¢å¼•index(name,age)ï¼Œè¿™æ ·å°±ä¼šå…ˆé€šè¿‡è¿™ä¸ªç»„åˆç´¢å¼•ä¸­çš„nameæ‰¾åˆ°å¯¹åº”çš„å¶å­èŠ‚ç‚¹ï¼Œå¶å­èŠ‚ç‚¹ä¸­ä¹ŸåŒ…å«äº†ageè¿™ä¸ªå…³é”®å­—ï¼Œå°±å¯ä»¥ç›´æ¥è¿”å›ageã€‚\nå½“ç„¶nameæœ‰å¯èƒ½é‡å¤ï¼Œæ‰€ä»¥å¯èƒ½æŸ¥è¯¢ç»“æœä¸æ˜¯å•æ¡è®°å½•ï¼Œé‚£è¿˜å¾—æ²¿ç€è¿™ä¸ªç¬¬ä¸€æ¬¡æ‰¾åˆ°çš„èŠ‚ç‚¹ï¼Œå‘å³éå†å¶å­èŠ‚ç‚¹åˆ—è¡¨ï¼ŒçŸ¥é“nameä¸æ»¡è¶³ä¸ºæ­¢ã€‚\nç”±äºç´¢å¼•ä¸­åŒ…å«äº†ageï¼Œä¹Ÿå°±ä¸éœ€è¦å›è¡¨äº†ã€‚\n  æœ€å·¦å‰ç¼€åŸåˆ™\nåˆ›å»ºç»„åˆï¼ˆè”åˆï¼‰ç´¢å¼•ä¹‹åï¼ŒæŸ¥è¯¢çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ï¼Œè¦ç”¨æœ€å·¦åŒ¹é…åŸåˆ™æ‰èƒ½åº”ç”¨ç´¢å¼•ï¼Œå¦åˆ™ç”¨ä¸ä¸Šç´¢å¼•ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬å®šä¹‰ç´¢å¼•çš„æ—¶å€™æ˜¯index(name,age)ï¼Œé‚£ä¹ˆä½ æŸ¥è¯¢åˆ°æ—¶å€™where age=xxx and name=yyyï¼Œè¿™ç§å°±æ²¡æœ‰ä¼˜å…ˆç”¨nameï¼ŒæŸ¥è¯¢æ¯”è¾ƒçš„æ—¶å€™å°±ç”¨ä¸ä¸Šç´¢å¼•ï¼Œä½†æ˜¯where name=yyy and age=xxxå°±èƒ½ç”¨ä¸Šç´¢å¼•ã€‚\nä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿb+æ•°ç´¢å¼•èŠ‚ç‚¹ä¸­å…³é”®å­—ï¼Œæ˜¯æŒ‰ç…§å®šä¹‰ç´¢å¼•æ—¶å­—æ®µçš„é¡ºåºè®¾ç½®çš„ï¼Œæ¯”è¾ƒçš„æ—¶å€™ä¹Ÿæ˜¯æŒ‰ç…§è¿™ä¸ªé¡ºåºæ¥æ¯”è¾ƒã€‚\n å¦‚ä½•å®‰æ’ç»„åˆç´¢å¼•å†…çš„å­—æ®µé¡ºåºï¼Ÿå°†æ›´å®¹æ˜“ç”¨åˆ°çš„æ”¾å‰é¢ï¼Œè¿™æ ·å¯ä»¥æé«˜å¤ç”¨çš„ç¨‹åº¦ã€‚ ç”±äºå»ºç«‹äº†ç´¢å¼•index(a,b)ï¼Œæœ€å·¦å‰ç¼€å¯ä»¥åœ¨aä¸Šå¼•ç”¨ç´¢å¼•ï¼Œä¹Ÿå°±ä¸éœ€è¦å†å•ç‹¬ä¸ºaå»ºç«‹ç´¢å¼•index(a)äº†ã€‚ å¦å¤–å°±æ˜¯è¦è€ƒè™‘ç©ºé—´åŸåˆ™ï¼Œæ˜¯ä¸æ˜¯ä¸€å®šè¦(nameï¼Œage)å»ºè”åˆç´¢å¼•ï¼Œé‚£å°±å¾—è€ƒè™‘ç”¨çš„é¢‘ç‡äº†ï¼Œå¦‚æœè¿™ç§æŸ¥è¯¢åœºæ™¯ä¸å¤šï¼ŒæŸ¥è¯¢æ•ˆç‡è¦æ±‚ä¹Ÿä¸é«˜ï¼Œé‚£ä¹ˆç¡®å®ä¸é€‚åˆå»ºç«‹è”åˆç´¢å¼•ï¼Œæµªè´¹å­˜å‚¨ç©ºé—´å•Šã€‚ä½†æ˜¯ä¹Ÿä¸èƒ½å…¨è¡¨æ‰«æé‚£ä¹ˆæ…¢å§ï¼Œè¿™ä¸ªæ—¶å€™ä¸ºnameå»ºä¸ªç´¢å¼•ï¼Œå›è¡¨æŸ¥ageï¼Œè¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚    ç´¢å¼•ä¸‹æ¨\nå¯¹äºç»„åˆç´¢å¼•index(a,b,c)ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨æœ€å·¦å‰ç¼€åŒ¹é…çš„æ–¹å¼æ¥åº”ç”¨ç´¢å¼•ï¼Œé‚£ä¹ˆå¦‚æœæŸ¥è¯¢çš„æ—¶å€™ç¬¬ä¸€åˆ—æ˜¯åŒ¹é…çš„ï¼Œç¬¬äºŒåˆ—ä¸é…çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ\n5.6ä»¥å‰çš„è¯ï¼Œä¼šç›´æ¥æ ¹æ®åŒ¹é…åˆ°çš„aå›è¡¨ï¼ŒæŸ¥å‡ºè®°å½•åå†å¯¹æ¯”bæ˜¯å¦åŒ¹é…ï¼Œä¸åŒ¹é…å†è¿‡æ»¤æ‰ï¼Œå¾ˆæ˜æ˜¾è¿™ç§æ•ˆç‡æ˜¯æ¯”è¾ƒä½çš„ã€‚\n5.6ä»¥åçš„è¯ï¼Œå¼•å…¥äº†ç´¢å¼•ä¸‹æ¨ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Œå°±æ˜¯åœ¨ç»„åˆç´¢å¼•ä¸Šéå†çš„æ—¶å€™å°±ç›´æ¥æ¯”è¾ƒå…¶ä»–å‡ ä¸ªç´¢å¼•åˆ—å­—æ®µæ˜¯å¦åŒ¹é…ï¼Œä¸åŒ¹é…ç›´æ¥è¿‡æ»¤æ‰ï¼Œä¹Ÿä¸ç”¨å›è¡¨äº†ï¼Œå‡å°‘äº†å›è¡¨æ¬¡æ•°ï¼Œæ•ˆç‡è‡ªç„¶ä¹Ÿå°±é«˜äº†ã€‚\nèŒƒå›´æŸ¥è¯¢ï¼šè¯´ä¸‹èŒƒå›´æŸ¥è¯¢å¤§è‡´æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ\næœ€åè¯´ä¸‹èŒƒå›´æŸ¥è¯¢ï¼Œæ¯”å¦‚ userè¡¨ä¸Šçš„ç´¢å¼•æœ‰pk(id), age(name)ï¼Œç°åœ¨æŸ¥è¯¢select name,age from user where age\u0026gt;25 and age\u0026lt;30 ï¼Œè¿™ä¸ªæ—¶å€™ä¼šç°åœ¨index(age)è¿™ä¸ªç´¢å¼•ä¸Šæ‰¾åˆ°age\u0026gt;25çš„ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œç„¶åä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹ï¼Œæ²¿ç€å¶å­èŠ‚ç‚¹é“¾è¡¨ï¼Œç›´æ¥å‘å³éå†ï¼Œå› ä¸ºéƒ½æ˜¯æŒ‰ç…§ageæœ‰åºçš„å˜›ï¼Œæ¯éå†ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œå›è¡¨æŸ¥è¯¢nameå‡å¦‚ç»“æœé›†ï¼Œç›´åˆ°å‘ç°age\u0026lt;30ä¸æˆç«‹ç»“æŸã€‚\n  g\n"}),a.add({id:179,href:"/blog/04%E7%B4%A2%E5%BC%95%E5%8E%9F%E7%90%86%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%B4%A2%E5%BC%95%E4%B8%8A/",title:"04ç´¢å¼•åŸç†ï¼šæ·±å…¥æµ…å‡ºç´¢å¼•ï¼ˆä¸Šï¼‰",description:"ç´¢å¼•çš„å‡ºç°å…¶å®å°±æ˜¯ä¸ºäº†æé«˜æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå°±åƒä¹¦çš„ç›®å½•ä¸€æ ·ã€‚ç›´æ¥åœ¨å‡ ç™¾é¡µçš„ä¹¦æ‰¾ä¸€ä¸ªå…³é”®è¯å¯èƒ½è¦æ‰¾å¾ˆä¹…ï¼Œä½†æ˜¯é€šè¿‡é™„å½•ä¸­å…ˆé€šè¿‡é¦–å­—æ¯æ‰¾åˆ°å¯¹åº”çš„å…³é”®è¯ï¼Œå†é€šè¿‡å…³é”®è¯å¯¹åº”é¡µç æ‰¾åˆ°ä¹¦ä¸­å¯¹åº”é¡µã€å¯¹åº”å†…å®¹ï¼Œå°±ä¼šæ¯”è¾ƒå¿«ã€‚æŸ¥è¯å…¸ã€æŸ¥ç”µè¯æœ¬ï¼Œéƒ½æ˜¯ç±»ä¼¼çš„æ€æƒ³ã€‚\næŸ¥è¯¢ç±»å‹ï¼š\n ç­‰å€¼æŸ¥è¯¢ï¼› åŒºé—´æŸ¥è¯¢ï¼›  å‡ ç§ç´¢å¼•æ¨¡å‹ï¼š\n  hash\nè¿™ç§åªé€‚åˆç­‰å€¼æŸ¥è¯¢ï¼Œæ¥è¿‘O(1)çš„æ—¶é—´å¤æ‚åº¦ï¼Œä¸é€‚åˆèŒƒå›´æŸ¥è¯¢ï¼ˆæ¯”å¦‚keyä»‹äº[k1,k2]ä¹‹é—´çš„å°±å¾—å…¨é‡æ‰«æäº†ï¼‰ã€‚è¿™ç±»å­˜å‚¨ï¼Œä¸»è¦æœ‰memcachedåŠå…¶ä»–ä¸€äº›nosqlå­˜å‚¨ï¼›\n  æœ‰åºæ•°ç»„\nåœ¨ç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢åœºæ™¯ä¸­ï¼Œæ€§èƒ½éƒ½æ¯”è¾ƒå¥½ï¼ŒåŸºæœ¬å¯ä»¥åœ¨O(log(n))æ—¶é—´å¤æ‚åº¦å†…æå®šã€‚å½“ç„¶æ•°æ®æœ‰åºã€æ²¡æœ‰é‡å¤ç­‰æƒ…å†µä¸‹ï¼Œå¹³å‡å¤æ‚åº¦è¦åä¸€ç‚¹ã€‚ä½†æ˜¯è€ƒè™‘åˆ°æ’å…¥çš„åœºæ™¯ï¼Œæ’å…¥ç‚¹ä½ç½®åŠä»¥åçš„æ•°æ®è¦ç§»åŠ¨çš„ï¼Œä»£ä»·æ¯”è¾ƒé«˜ã€‚\næœ‰åºæ•°ç»„ï¼Œåªé€‚ç”¨äºé™æ€å­˜å‚¨å¼•æ“ï¼Œä¸æ€ä¹ˆå˜åŒ–çš„é‚£ç§å­˜å‚¨ã€‚\n  æœç´¢æ ‘\næ ¹æ®å¯¹æ ‘ä¸­ç´¢å¼•èŠ‚ç‚¹keyçš„æ•°é‡ä»¥åŠå¯¹æ ‘çš„é«˜åº¦çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºå¥½å‡ ç§ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰äºŒå‰æœç´¢æ ‘ã€äºŒå‰å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘ï¼Œè¿™äº›éƒ½æ˜¯äºŒå‰çš„ï¼Œæ—¶é—´å¤æ‚åº¦åŸºæœ¬éƒ½æ˜¯O(log(n))ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å¹³å‡æ—¶é—´å¤æ‚åº¦äºŒå‰å¹³è¡¡æ ‘æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯å®ƒçš„æ’å…¥æ“ä½œæ¶‰åŠåˆ°å¤§é‡çš„æ ‘è°ƒæ•´æ­¥éª¤ï¼Œå¼€é”€è¾ƒå¤§ï¼Œæ™®é€šäºŒå‰æœç´¢æ ‘çš„è¯åˆæœ‰å¯èƒ½é€€åŒ–ä¸ºä¸€ä¸ªå•æ”¯çš„é“¾è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½é€€åŒ–ä¸ºO(n)ã€‚çº¢é»‘æ ‘æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ï¼Œä½¿ç”¨ä¹Ÿæ¯”è¾ƒå¹¿ï¼Œå®ƒé€šè¿‡æ–½åŠ ä¸€äº›çº¦æŸé™åˆ¶äº†å·¦ã€å³å­æ ‘é«˜åº¦ä¸ä¼šæˆä¸ºå¦ä¸€ä¸ªçš„ä¸¤å€ï¼Œè¿™æ¯”äºŒå‰å¹³è¡¡æ ‘å·¦å³å­æ ‘é«˜åº¦å·®æœ€å¤šä¸º1å¯æ¾å¤šäº†ï¼Œå‡è½»äº†æ ‘è°ƒæ•´çš„å¼€é”€ã€‚çº¢é»‘æ ‘æ˜¯ç”¨çš„æ¯”è¾ƒå¤šçš„ã€‚\næ ‘çš„æœç´¢æ•ˆç‡å–å†³äºæ ‘çš„é«˜åº¦ï¼Œå¦‚æœæ ‘é«˜åº¦å¾ˆé«˜ï¼Œé‚£ä¹ˆæŸ¥è¯¢æ•ˆç‡è‡ªç„¶å°±ä¼šæ¯”è¾ƒä½ã€‚è€ƒè™‘åˆ°æœºæ¢°ç¡¬ç›˜éšæœºè®¿é—®æ…¢çš„ç‰¹æ€§ï¼Œæ¯ä¸ªç´¢å¼•èŠ‚ç‚¹éƒ½è¦å–æœºæ¢°ç¡¬ç›˜é‡Œé¢å»åŠ è½½çš„ï¼Œè¿™ä¸ªå¾ˆæ…¢çš„ã€‚æ•°æ®åº“è®¾è®¡å‡ºæ¥æ˜¯è¦å­˜å‚¨å¤§é‡æ•°æ®çš„ï¼Œç´¢å¼•å…³é”®å­—åŒºåˆ†åº¦å†é«˜ï¼ŒäºŒå‰æ ‘å‡ºåº¦å¤ªä½ï¼Œæ ‘è¿˜æ˜¯ä¼šå¾ˆé«˜çš„ï¼Œè¿™å¯¹å­˜å‚¨å¤§é‡æ•°æ®ï¼ˆå‡ åƒä¸‡ä¸Šäº¿ï¼‰çš„æ•°æ®åº“ç³»ç»Ÿæ¥è¯´ï¼ŒäºŒå‰æ ‘æœ‰ç‚¹åƒä¸æ¶ˆï¼Œæ‰€ä»¥Bæ ‘ã€B+æ ‘å‡ºç°äº†ã€‚\nè¯•æƒ³ä¸‹ï¼ŒäºŒå‰æ ‘çš„æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹å¤šäº†ä¹‹åï¼Œæ ‘é«˜åº¦ä¼šå¾ˆé«˜çš„ï¼Œæ¯ä¸ªç´¢å¼•èŠ‚ç‚¹éƒ½å¯èƒ½å­˜å‚¨åœ¨æœºæ¢°ç¡¬ç›˜ä¸Šç¦»æ•£çš„ä½ç½®ï¼Œè¯»å–æ¯ä¸ªç´¢å¼•èŠ‚ç‚¹ä¼šå¾ˆè€—æ—¶çš„ã€‚\nBæ ‘æ˜¯må‰æ ‘ï¼Œä½†æ˜¯Bæ ‘ä¸­çš„éå¶å­èŠ‚ç‚¹æ—¢å¯èƒ½æ˜¯ç´¢å¼•èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯æ•°æ®èŠ‚ç‚¹ï¼Œæ•°æ®èŠ‚ç‚¹ä¹‹é—´æ²¡æœ‰å½¢æˆä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼Œæ²¡æœ‰å……åˆ†è€ƒè™‘åˆ°æœºæ¢°ç¡¬ç›˜é¡ºåºè¯»å–æ•ˆç‡é«˜çš„ç‰¹ç‚¹ï¼ŒB+æ ‘è€ƒè™‘åˆ°äº†ï¼Œæ‰€æœ‰éå¶å­èŠ‚ç‚¹éƒ½æ˜¯ç´¢å¼•èŠ‚ç‚¹ï¼Œæ‰€æœ‰ï¼Œå¶å­èŠ‚ç‚¹å‡ä¸ºæ•°æ®èŠ‚ç‚¹ï¼Œä¸”æ„æˆäº†ä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ï¼Œæ­£å¥½èƒ½è§£å†³æœºæ¢°ç¡¬ç›˜éšæœºè®¿é—®æ…¢çš„é—®é¢˜ï¼Œä¹Ÿèƒ½åˆ©ç”¨ç¡¬ç›˜é¡ºåºè¯»å–å¿«çš„ä¼˜åŠ¿ã€‚\n  må‰æ ‘ä¸­çš„è¿™ä¸ªmåº”è¯¥å¤šå¤§å‘¢ï¼Ÿè¿™ä¸ªå–å†³äºæ•°æ®å—çš„å¤§å°ï¼Œä»¥InnoDBçš„ä¸€ä¸ªæ•´æ•°å­—æ®µç´¢å¼•ä¸ºä¾‹ï¼Œè¿™ä¸ªNå·®ä¸å¤šæ˜¯1200ã€‚æ ‘é«˜4å±‚çš„æ—¶å€™ï¼Œå°±å·®ä¸å¤šå¯ä»¥å­˜å‚¨17äº¿æ¡æ•°æ®äº†ã€‚\npsï¼šç±»ä¼¼çš„æ€ä¹ˆè®¡ç®—å‘¢ï¼Ÿ\nå­¦ä¹ ä¸‹æ€ä¹ˆè®¡ç®—çš„ï¼šhttps://www.programmersought.com/article/65874297377/\nç°ä»£æœºæ¢°ç¡¬ç›˜æœ€å¤§ä¸çŸ¥é“å¤šå°‘ï¼Œinnodbé‡Œé¢å®šä¹‰çš„æ˜¯ç´¢å¼•ä¸­æŒ‡é’ˆå¤§å°æ˜¯6ä¸ªå­—èŠ‚ï¼Œæ„å‘³ç€2^(6*8)/2^40=256TBï¼Œè¿™é‡Œçš„æŒ‡é’ˆå¤§å°è¡¨ç¤ºçš„æ˜¯æ•°æ®åœ¨è¡¨ç©ºé—´ä¸­çš„åç§»é‡ï¼Œå¯ä»¥ç†è§£æˆå¯ä»¥å¯»å€256TBçš„ç¡¬ç›˜ç©ºé—´ï¼Ÿ\ninnodbé»˜è®¤çš„pagesizeæ˜¯16KBï¼Œokï¼\n å…ˆç®—ä¸€ä¸ªç´¢å¼•å¯ä»¥å­˜å¤šå°‘æŒ‡é’ˆï¼šå‡å®šæˆ‘ä»¬ç”¨bigintä½œä¸ºä¸»é”®ï¼Œ8ä¸ªå­—èŠ‚ï¼ŒæŒ‡é’ˆ6å­—èŠ‚ï¼Œé‚£ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹å¯ä»¥å­˜å‚¨16KB/14B=1170ä¸ªå…³é”®å­—å’ŒæŒ‡é’ˆã€‚ å†ç®—ä¸€ä¸ªå¶å­èŠ‚ç‚¹å¯ä»¥å­˜å¤šå°‘è®°å½•ï¼šèšé›†ç´¢å¼•é‡Œé¢å¶å­èŠ‚ç‚¹ä¸­ï¼Œç´¢å¼•å…³é”®å­—æ˜¯æ•°æ®è®°å½•çš„ä¸€éƒ¨åˆ†ï¼Œè‡³å°‘å¤§äº8ä¸ªå­—èŠ‚äº†ï¼Œæˆ‘ä»¬å°±å‡å®šä¸€è¡Œè®°å½•å¤§çº¦ä¹ˆä¸º1KBå§ã€‚é‚£ä¹ˆä¸€ä¸ªå¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨è®°å½•æ•°é‡ä¸º16KB/1KB=16ã€‚  ç°åœ¨æˆ‘ä»¬ç¬¼ç»Ÿç®—æ³•ä¸‹ï¼š\n  å‡å¦‚æ ‘æœ€å¤§é«˜åº¦ä¸º2ï¼Œé‚£ä¹ˆå°±æ˜¯æ ¹èŠ‚ç‚¹æŒ‡é’ˆæ•°é‡*æ¯ä¸ªå¶å­èŠ‚ç‚¹è®°å½•æ•°é‡ï¼Œå¯ä»¥å­˜å‚¨1170x16=18720\n  å‡å¦‚æ•°æœ€å¤§é«˜åº¦ä¸º3ï¼Œé‚£ä¹ˆå°±æ˜¯1170^2*16=21902400=2190w\n  å‡å¦‚æ•°æœ€å¤§é«˜åº¦ä¸º4ï¼Œé‚£ä¹ˆå°±æ˜¯1170^3*16=25625808000=256äº¿\n  å®é™…æƒ…å†µä¸€èˆ¬3å±‚å°±å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†åœºæ™¯ä½¿ç”¨äº†ï¼Œæ•°æ®é‡å¤§çš„è¯ï¼Œä¹Ÿæå°‘æœ‰ä¸šåŠ¡ä¼šè¶…è¿‡4å±‚ã€‚æ‰€ä»¥å­˜å‚¨å¾ˆå¤šçš„æ•°æ®ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¹ŸåŸºæœ¬ä¸Šæ˜¯æœ‰ä¿è¯çš„ã€‚\næ¯æ¬¡æŸ¥è¯¢ç´¢å¼•èŠ‚ç‚¹ï¼Œéƒ½ä»£è¡¨äº†ä¸€æ¬¡ç£ç›˜IOï¼Œæ‰€ä»¥é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢ï¼Œä¼šæ¯”å€ŸåŠ©å…¶ä»–è¾…åŠ©ç´¢å¼•æŸ¥è¯¢ã€å†å›è¡¨çš„æ–¹å¼è¦å¿«ä¸€äº›ã€‚\næŒ‡é’ˆ6ä¸ªå­—èŠ‚ï¼Œæ„å‘³ç€å¯ä»¥å¯»å€çš„ç´¢å¼•åœ°å€ç©ºé—´å¾ˆå¤§çš„ï¼Œ256TBï¼Œå“ªæœ‰è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œè¿™ä¸ªä¸œè¥¿ä¹Ÿå¯ä»¥ç†è§£æˆç£ç›˜ä¸Šç´¢å¼•çš„åç§»é‡ï¼Œ256TBçš„ç¡¬ç›˜ã€‚\nä½†æ˜¯çœ‹å¾—å‡ºæ¥ï¼Œç´¢å¼•å¯èƒ½ä¹Ÿå¾ˆå¤§ï¼Œä¸ä¸€å®šèƒ½å®Œå…¨åœ¨ç¡¬ç›˜ä¸­å­˜å‚¨çš„ä¸‹ï¼Œä¹Ÿæ˜¯æŒ‰éœ€åŠ è½½çš„ï¼\npsï¼šä¸ºä»€ä¹ˆè¦ç”¨è‡ªå¢idä½œä¸ºä¸»é”®ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä¸»è¦æ˜¯ä¸ºäº†é¿å…æ’å…¥æ—¶é¡µåˆ†è£‚ï¼Œb+æ ‘è°ƒæ•´å¯¼è‡´çš„æ•ˆç‡ä½ä¸‹ï¼šhttps://zhuanlan.zhihu.com/p/71022670\npsï¼šinnodb b+treeç´¢å¼•ç»“æ„ï¼šhttps://www.programmersought.com/article/1411118316/",content:"ç´¢å¼•çš„å‡ºç°å…¶å®å°±æ˜¯ä¸ºäº†æé«˜æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå°±åƒä¹¦çš„ç›®å½•ä¸€æ ·ã€‚ç›´æ¥åœ¨å‡ ç™¾é¡µçš„ä¹¦æ‰¾ä¸€ä¸ªå…³é”®è¯å¯èƒ½è¦æ‰¾å¾ˆä¹…ï¼Œä½†æ˜¯é€šè¿‡é™„å½•ä¸­å…ˆé€šè¿‡é¦–å­—æ¯æ‰¾åˆ°å¯¹åº”çš„å…³é”®è¯ï¼Œå†é€šè¿‡å…³é”®è¯å¯¹åº”é¡µç æ‰¾åˆ°ä¹¦ä¸­å¯¹åº”é¡µã€å¯¹åº”å†…å®¹ï¼Œå°±ä¼šæ¯”è¾ƒå¿«ã€‚æŸ¥è¯å…¸ã€æŸ¥ç”µè¯æœ¬ï¼Œéƒ½æ˜¯ç±»ä¼¼çš„æ€æƒ³ã€‚\næŸ¥è¯¢ç±»å‹ï¼š\n ç­‰å€¼æŸ¥è¯¢ï¼› åŒºé—´æŸ¥è¯¢ï¼›  å‡ ç§ç´¢å¼•æ¨¡å‹ï¼š\n  hash\nè¿™ç§åªé€‚åˆç­‰å€¼æŸ¥è¯¢ï¼Œæ¥è¿‘O(1)çš„æ—¶é—´å¤æ‚åº¦ï¼Œä¸é€‚åˆèŒƒå›´æŸ¥è¯¢ï¼ˆæ¯”å¦‚keyä»‹äº[k1,k2]ä¹‹é—´çš„å°±å¾—å…¨é‡æ‰«æäº†ï¼‰ã€‚è¿™ç±»å­˜å‚¨ï¼Œä¸»è¦æœ‰memcachedåŠå…¶ä»–ä¸€äº›nosqlå­˜å‚¨ï¼›\n  æœ‰åºæ•°ç»„\nåœ¨ç­‰å€¼æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢åœºæ™¯ä¸­ï¼Œæ€§èƒ½éƒ½æ¯”è¾ƒå¥½ï¼ŒåŸºæœ¬å¯ä»¥åœ¨O(log(n))æ—¶é—´å¤æ‚åº¦å†…æå®šã€‚å½“ç„¶æ•°æ®æœ‰åºã€æ²¡æœ‰é‡å¤ç­‰æƒ…å†µä¸‹ï¼Œå¹³å‡å¤æ‚åº¦è¦åä¸€ç‚¹ã€‚ä½†æ˜¯è€ƒè™‘åˆ°æ’å…¥çš„åœºæ™¯ï¼Œæ’å…¥ç‚¹ä½ç½®åŠä»¥åçš„æ•°æ®è¦ç§»åŠ¨çš„ï¼Œä»£ä»·æ¯”è¾ƒé«˜ã€‚\næœ‰åºæ•°ç»„ï¼Œåªé€‚ç”¨äºé™æ€å­˜å‚¨å¼•æ“ï¼Œä¸æ€ä¹ˆå˜åŒ–çš„é‚£ç§å­˜å‚¨ã€‚\n  æœç´¢æ ‘\næ ¹æ®å¯¹æ ‘ä¸­ç´¢å¼•èŠ‚ç‚¹keyçš„æ•°é‡ä»¥åŠå¯¹æ ‘çš„é«˜åº¦çš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºå¥½å‡ ç§ï¼Œæ¯”è¾ƒå¸¸è§çš„æœ‰äºŒå‰æœç´¢æ ‘ã€äºŒå‰å¹³è¡¡æ ‘ã€çº¢é»‘æ ‘ï¼Œè¿™äº›éƒ½æ˜¯äºŒå‰çš„ï¼Œæ—¶é—´å¤æ‚åº¦åŸºæœ¬éƒ½æ˜¯O(log(n))ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å¹³å‡æ—¶é—´å¤æ‚åº¦äºŒå‰å¹³è¡¡æ ‘æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯å®ƒçš„æ’å…¥æ“ä½œæ¶‰åŠåˆ°å¤§é‡çš„æ ‘è°ƒæ•´æ­¥éª¤ï¼Œå¼€é”€è¾ƒå¤§ï¼Œæ™®é€šäºŒå‰æœç´¢æ ‘çš„è¯åˆæœ‰å¯èƒ½é€€åŒ–ä¸ºä¸€ä¸ªå•æ”¯çš„é“¾è¡¨ï¼ŒæŸ¥è¯¢æ€§èƒ½é€€åŒ–ä¸ºO(n)ã€‚çº¢é»‘æ ‘æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ï¼Œä½¿ç”¨ä¹Ÿæ¯”è¾ƒå¹¿ï¼Œå®ƒé€šè¿‡æ–½åŠ ä¸€äº›çº¦æŸé™åˆ¶äº†å·¦ã€å³å­æ ‘é«˜åº¦ä¸ä¼šæˆä¸ºå¦ä¸€ä¸ªçš„ä¸¤å€ï¼Œè¿™æ¯”äºŒå‰å¹³è¡¡æ ‘å·¦å³å­æ ‘é«˜åº¦å·®æœ€å¤šä¸º1å¯æ¾å¤šäº†ï¼Œå‡è½»äº†æ ‘è°ƒæ•´çš„å¼€é”€ã€‚çº¢é»‘æ ‘æ˜¯ç”¨çš„æ¯”è¾ƒå¤šçš„ã€‚\næ ‘çš„æœç´¢æ•ˆç‡å–å†³äºæ ‘çš„é«˜åº¦ï¼Œå¦‚æœæ ‘é«˜åº¦å¾ˆé«˜ï¼Œé‚£ä¹ˆæŸ¥è¯¢æ•ˆç‡è‡ªç„¶å°±ä¼šæ¯”è¾ƒä½ã€‚è€ƒè™‘åˆ°æœºæ¢°ç¡¬ç›˜éšæœºè®¿é—®æ…¢çš„ç‰¹æ€§ï¼Œæ¯ä¸ªç´¢å¼•èŠ‚ç‚¹éƒ½è¦å–æœºæ¢°ç¡¬ç›˜é‡Œé¢å»åŠ è½½çš„ï¼Œè¿™ä¸ªå¾ˆæ…¢çš„ã€‚æ•°æ®åº“è®¾è®¡å‡ºæ¥æ˜¯è¦å­˜å‚¨å¤§é‡æ•°æ®çš„ï¼Œç´¢å¼•å…³é”®å­—åŒºåˆ†åº¦å†é«˜ï¼ŒäºŒå‰æ ‘å‡ºåº¦å¤ªä½ï¼Œæ ‘è¿˜æ˜¯ä¼šå¾ˆé«˜çš„ï¼Œè¿™å¯¹å­˜å‚¨å¤§é‡æ•°æ®ï¼ˆå‡ åƒä¸‡ä¸Šäº¿ï¼‰çš„æ•°æ®åº“ç³»ç»Ÿæ¥è¯´ï¼ŒäºŒå‰æ ‘æœ‰ç‚¹åƒä¸æ¶ˆï¼Œæ‰€ä»¥Bæ ‘ã€B+æ ‘å‡ºç°äº†ã€‚\nè¯•æƒ³ä¸‹ï¼ŒäºŒå‰æ ‘çš„æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹å¤šäº†ä¹‹åï¼Œæ ‘é«˜åº¦ä¼šå¾ˆé«˜çš„ï¼Œæ¯ä¸ªç´¢å¼•èŠ‚ç‚¹éƒ½å¯èƒ½å­˜å‚¨åœ¨æœºæ¢°ç¡¬ç›˜ä¸Šç¦»æ•£çš„ä½ç½®ï¼Œè¯»å–æ¯ä¸ªç´¢å¼•èŠ‚ç‚¹ä¼šå¾ˆè€—æ—¶çš„ã€‚\nBæ ‘æ˜¯må‰æ ‘ï¼Œä½†æ˜¯Bæ ‘ä¸­çš„éå¶å­èŠ‚ç‚¹æ—¢å¯èƒ½æ˜¯ç´¢å¼•èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯æ•°æ®èŠ‚ç‚¹ï¼Œæ•°æ®èŠ‚ç‚¹ä¹‹é—´æ²¡æœ‰å½¢æˆä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼Œæ²¡æœ‰å……åˆ†è€ƒè™‘åˆ°æœºæ¢°ç¡¬ç›˜é¡ºåºè¯»å–æ•ˆç‡é«˜çš„ç‰¹ç‚¹ï¼ŒB+æ ‘è€ƒè™‘åˆ°äº†ï¼Œæ‰€æœ‰éå¶å­èŠ‚ç‚¹éƒ½æ˜¯ç´¢å¼•èŠ‚ç‚¹ï¼Œæ‰€æœ‰ï¼Œå¶å­èŠ‚ç‚¹å‡ä¸ºæ•°æ®èŠ‚ç‚¹ï¼Œä¸”æ„æˆäº†ä¸€ä¸ªæœ‰åºçš„é“¾è¡¨ï¼Œæ­£å¥½èƒ½è§£å†³æœºæ¢°ç¡¬ç›˜éšæœºè®¿é—®æ…¢çš„é—®é¢˜ï¼Œä¹Ÿèƒ½åˆ©ç”¨ç¡¬ç›˜é¡ºåºè¯»å–å¿«çš„ä¼˜åŠ¿ã€‚\n  må‰æ ‘ä¸­çš„è¿™ä¸ªmåº”è¯¥å¤šå¤§å‘¢ï¼Ÿè¿™ä¸ªå–å†³äºæ•°æ®å—çš„å¤§å°ï¼Œä»¥InnoDBçš„ä¸€ä¸ªæ•´æ•°å­—æ®µç´¢å¼•ä¸ºä¾‹ï¼Œè¿™ä¸ªNå·®ä¸å¤šæ˜¯1200ã€‚æ ‘é«˜4å±‚çš„æ—¶å€™ï¼Œå°±å·®ä¸å¤šå¯ä»¥å­˜å‚¨17äº¿æ¡æ•°æ®äº†ã€‚\npsï¼šç±»ä¼¼çš„æ€ä¹ˆè®¡ç®—å‘¢ï¼Ÿ\nå­¦ä¹ ä¸‹æ€ä¹ˆè®¡ç®—çš„ï¼šhttps://www.programmersought.com/article/65874297377/\nç°ä»£æœºæ¢°ç¡¬ç›˜æœ€å¤§ä¸çŸ¥é“å¤šå°‘ï¼Œinnodbé‡Œé¢å®šä¹‰çš„æ˜¯ç´¢å¼•ä¸­æŒ‡é’ˆå¤§å°æ˜¯6ä¸ªå­—èŠ‚ï¼Œæ„å‘³ç€2^(6*8)/2^40=256TBï¼Œè¿™é‡Œçš„æŒ‡é’ˆå¤§å°è¡¨ç¤ºçš„æ˜¯æ•°æ®åœ¨è¡¨ç©ºé—´ä¸­çš„åç§»é‡ï¼Œå¯ä»¥ç†è§£æˆå¯ä»¥å¯»å€256TBçš„ç¡¬ç›˜ç©ºé—´ï¼Ÿ\ninnodbé»˜è®¤çš„pagesizeæ˜¯16KBï¼Œokï¼\n å…ˆç®—ä¸€ä¸ªç´¢å¼•å¯ä»¥å­˜å¤šå°‘æŒ‡é’ˆï¼šå‡å®šæˆ‘ä»¬ç”¨bigintä½œä¸ºä¸»é”®ï¼Œ8ä¸ªå­—èŠ‚ï¼ŒæŒ‡é’ˆ6å­—èŠ‚ï¼Œé‚£ä¸€ä¸ªç´¢å¼•èŠ‚ç‚¹å¯ä»¥å­˜å‚¨16KB/14B=1170ä¸ªå…³é”®å­—å’ŒæŒ‡é’ˆã€‚ å†ç®—ä¸€ä¸ªå¶å­èŠ‚ç‚¹å¯ä»¥å­˜å¤šå°‘è®°å½•ï¼šèšé›†ç´¢å¼•é‡Œé¢å¶å­èŠ‚ç‚¹ä¸­ï¼Œç´¢å¼•å…³é”®å­—æ˜¯æ•°æ®è®°å½•çš„ä¸€éƒ¨åˆ†ï¼Œè‡³å°‘å¤§äº8ä¸ªå­—èŠ‚äº†ï¼Œæˆ‘ä»¬å°±å‡å®šä¸€è¡Œè®°å½•å¤§çº¦ä¹ˆä¸º1KBå§ã€‚é‚£ä¹ˆä¸€ä¸ªå¶å­èŠ‚ç‚¹å¯ä»¥å­˜å‚¨è®°å½•æ•°é‡ä¸º16KB/1KB=16ã€‚  ç°åœ¨æˆ‘ä»¬ç¬¼ç»Ÿç®—æ³•ä¸‹ï¼š\n  å‡å¦‚æ ‘æœ€å¤§é«˜åº¦ä¸º2ï¼Œé‚£ä¹ˆå°±æ˜¯æ ¹èŠ‚ç‚¹æŒ‡é’ˆæ•°é‡*æ¯ä¸ªå¶å­èŠ‚ç‚¹è®°å½•æ•°é‡ï¼Œå¯ä»¥å­˜å‚¨1170x16=18720\n  å‡å¦‚æ•°æœ€å¤§é«˜åº¦ä¸º3ï¼Œé‚£ä¹ˆå°±æ˜¯1170^2*16=21902400=2190w\n  å‡å¦‚æ•°æœ€å¤§é«˜åº¦ä¸º4ï¼Œé‚£ä¹ˆå°±æ˜¯1170^3*16=25625808000=256äº¿\n  å®é™…æƒ…å†µä¸€èˆ¬3å±‚å°±å¯ä»¥æ»¡è¶³ç»å¤§éƒ¨åˆ†åœºæ™¯ä½¿ç”¨äº†ï¼Œæ•°æ®é‡å¤§çš„è¯ï¼Œä¹Ÿæå°‘æœ‰ä¸šåŠ¡ä¼šè¶…è¿‡4å±‚ã€‚æ‰€ä»¥å­˜å‚¨å¾ˆå¤šçš„æ•°æ®ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¹ŸåŸºæœ¬ä¸Šæ˜¯æœ‰ä¿è¯çš„ã€‚\næ¯æ¬¡æŸ¥è¯¢ç´¢å¼•èŠ‚ç‚¹ï¼Œéƒ½ä»£è¡¨äº†ä¸€æ¬¡ç£ç›˜IOï¼Œæ‰€ä»¥é€šè¿‡ä¸»é”®ç´¢å¼•æŸ¥è¯¢ï¼Œä¼šæ¯”å€ŸåŠ©å…¶ä»–è¾…åŠ©ç´¢å¼•æŸ¥è¯¢ã€å†å›è¡¨çš„æ–¹å¼è¦å¿«ä¸€äº›ã€‚\næŒ‡é’ˆ6ä¸ªå­—èŠ‚ï¼Œæ„å‘³ç€å¯ä»¥å¯»å€çš„ç´¢å¼•åœ°å€ç©ºé—´å¾ˆå¤§çš„ï¼Œ256TBï¼Œå“ªæœ‰è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œè¿™ä¸ªä¸œè¥¿ä¹Ÿå¯ä»¥ç†è§£æˆç£ç›˜ä¸Šç´¢å¼•çš„åç§»é‡ï¼Œ256TBçš„ç¡¬ç›˜ã€‚\nä½†æ˜¯çœ‹å¾—å‡ºæ¥ï¼Œç´¢å¼•å¯èƒ½ä¹Ÿå¾ˆå¤§ï¼Œä¸ä¸€å®šèƒ½å®Œå…¨åœ¨ç¡¬ç›˜ä¸­å­˜å‚¨çš„ä¸‹ï¼Œä¹Ÿæ˜¯æŒ‰éœ€åŠ è½½çš„ï¼\npsï¼šä¸ºä»€ä¹ˆè¦ç”¨è‡ªå¢idä½œä¸ºä¸»é”®ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œä¸»è¦æ˜¯ä¸ºäº†é¿å…æ’å…¥æ—¶é¡µåˆ†è£‚ï¼Œb+æ ‘è°ƒæ•´å¯¼è‡´çš„æ•ˆç‡ä½ä¸‹ï¼šhttps://zhuanlan.zhihu.com/p/71022670\npsï¼šinnodb b+treeç´¢å¼•ç»“æ„ï¼šhttps://www.programmersought.com/article/1411118316/\n"}),a.add({id:180,href:"/blog/03%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E6%94%B9%E4%BA%86%E6%88%91%E8%BF%98%E7%9C%8B%E4%B8%8D%E8%A7%81/",title:"03äº‹åŠ¡éš”ç¦»ï¼šä¸ºä»€ä¹ˆä½ æ”¹äº†æˆ‘è¿˜çœ‹ä¸è§",description:"æ•°æ®åº“äº‹åŠ¡ï¼ˆåˆšæ€§äº‹åŠ¡ï¼‰\näº‹åŠ¡ç‰¹æ€§ï¼šACID\n Atomic Consistency Isolation Durability  äº‹åŠ¡éš”ç¦»æ€§åŠäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š\n read uncommited read committed repeatable read serializable  åœ¨å®ç°ä¸Šï¼Œæ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†ã€‚\n åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚ åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ªSQLè¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µï¼› è€Œâ€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”ï¼ˆè¯»å†™å†²çªã€å†™å†™å†²çªï¼‰çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚  äº‹åŠ¡éš”ç¦»æ€§çº§åˆ«é€šè¿‡å˜é‡ transaction_isolation æ¥è®¾ç½®ã€‚\nMVCCï¼š\nåœ¨æ‰§è¡Œæ›´æ–°æ“ä½œçš„æ—¶å€™ï¼Œä¹Ÿä¼šå¯¹åº”çš„æ’å…¥ä¸€è¡Œâ€œå›æ»šè®°å½•â€ï¼Œç”¨äºMVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ä¸­æ„å»ºä¸åŒæ—¶é—´å¯åŠ¨çš„äº‹åŠ¡çš„è§†å›¾ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†ç»´æŒä¸€ä¸ªå¯é‡å¤è¯»çš„è§†å›¾ã€‚\næ¯”å¦‚ç°åœ¨æ‰§è¡Œæ“ä½œå‡å¦‚ç°åœ¨c=1ï¼Œæ‰§è¡Œupdate c=2, c=3, c=4çš„æ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„å°±ä¼šæ’å…¥å››è¡Œå›æ»šè®°å½•ï¼Œå°†2å›æ»šä¸º1ï¼Œå°†3å›æ»šä¸º2ï¼Œå°†4å›æ»šä¸º3ã€‚\nä¸‰ä¸ªæ›´æ–°æ“ä½œçš„æ—¶åˆ»t1ã€t2ã€t3ï¼Œç›¸å½“äºç¡®ç«‹äº†ä¸‰ä¸ªè¾¹ç•Œï¼Œè¾¹ç•Œæ—¶é—´ç‚¹å‰åå¯èƒ½ä¼šæœ‰ä¸åŒçš„äº‹åŠ¡å¯åŠ¨ã€ç»“æŸã€‚é‚£äº›ä¾ç„¶è¿˜æœªç»“æŸçš„äº‹åŠ¡ï¼Œé€šè¿‡ä»–ä»¬çš„å¯åŠ¨æ—¶é—´ä¸å›æ»šè®°å½•æ’å…¥æ—¶çš„æ—¶é—´åšå¯¹æ¯”ï¼Œå°±å¯ä»¥æ‰¾åˆ°åº”è¯¥ä¾æ¬¡æ‰§è¡Œå“ªäº›å›æ»šè®°å½•æ¥æ¢å¤åˆ°å¯åŠ¨äº‹åŠ¡æ—¶çš„æ•°æ®åº“çŠ¶æ€ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥é‡å»ºä¸€ä¸ªå¯é‡å¤è¯»çš„è§†å›¾ã€‚\nè¿™å°±æ˜¯MVCCçš„è¦ä¹‰ã€‚\nè¿™äº›å›æ»šæ—¥å¿—ï¼Œå¤šäº†ä¹‹åä¹Ÿä¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œæµªè´¹èµ„æºï¼Œéœ€è¦æ¸…é™¤ï¼Ÿä½†æ˜¯å‡å¦‚æœ‰ä¸ªäº‹åŠ¡æ˜¯æ—¶åˆ»tå¯åŠ¨çš„ï¼Œé‚£ä¹ˆæ—¶åˆ»tä¹‹åçš„å›æ»šæ—¥å¿—éƒ½æ˜¯è¦ä¿ç•™çš„ï¼Œå¦‚æœè¿™ä¸ªäº‹åŠ¡æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼Œå°±ä¼šå¯¼è‡´å›æ»šæ—¥å¿—ç§¯ç´¯å¾ˆå¤šï¼Œæµªè´¹èµ„æºã€‚å› æ­¤ä¸å»ºè®®ä½¿ç”¨é•¿äº‹åŠ¡ã€‚\næŸ¥æ‰¾æ‰§è¡Œæ—¶é—´è¶…è¿‡60sçš„é•¿äº‹åŠ¡ï¼š\nselect * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))\u0026gt;60  äº†è§£ä¸‹è¿™ä¸ªäº‹åŠ¡ç»Ÿè®¡è¡¨å‡ ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„å­—æ®µï¼š\nmysql\u0026gt; desc innodb_trx; +----------------------------+-----------------+------+-----+---------+-------+ | Field | Type | Null | | +----------------------------+-----------------+------+-----+---------+-------+ | trx_id | bigint unsigned | NO | äº‹åŠ¡id | | trx_state | varchar(13) | NO | äº‹åŠ¡çŠ¶æ€ï¼Œå¦‚RUNNING | | trx_started | datetime | NO | äº‹åŠ¡å¯åŠ¨æ—¶é—´ | .",content:"æ•°æ®åº“äº‹åŠ¡ï¼ˆåˆšæ€§äº‹åŠ¡ï¼‰\näº‹åŠ¡ç‰¹æ€§ï¼šACID\n Atomic Consistency Isolation Durability  äº‹åŠ¡éš”ç¦»æ€§åŠäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š\n read uncommited read committed repeatable read serializable  åœ¨å®ç°ä¸Šï¼Œæ•°æ®åº“é‡Œé¢ä¼šåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œè®¿é—®çš„æ—¶å€™ä»¥è§†å›¾çš„é€»è¾‘ç»“æœä¸ºå‡†ã€‚\n åœ¨â€œå¯é‡å¤è¯»â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨äº‹åŠ¡å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œæ•´ä¸ªäº‹åŠ¡å­˜åœ¨æœŸé—´éƒ½ç”¨è¿™ä¸ªè§†å›¾ã€‚ åœ¨â€œè¯»æäº¤â€éš”ç¦»çº§åˆ«ä¸‹ï¼Œè¿™ä¸ªè§†å›¾æ˜¯åœ¨æ¯ä¸ªSQLè¯­å¥å¼€å§‹æ‰§è¡Œçš„æ—¶å€™åˆ›å»ºçš„ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œâ€œè¯»æœªæäº¤â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥è¿”å›è®°å½•ä¸Šçš„æœ€æ–°å€¼ï¼Œæ²¡æœ‰è§†å›¾æ¦‚å¿µï¼› è€Œâ€œä¸²è¡ŒåŒ–â€éš”ç¦»çº§åˆ«ä¸‹ç›´æ¥ç”¨åŠ é”ï¼ˆè¯»å†™å†²çªã€å†™å†™å†²çªï¼‰çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®ã€‚  äº‹åŠ¡éš”ç¦»æ€§çº§åˆ«é€šè¿‡å˜é‡ transaction_isolation æ¥è®¾ç½®ã€‚\nMVCCï¼š\nåœ¨æ‰§è¡Œæ›´æ–°æ“ä½œçš„æ—¶å€™ï¼Œä¹Ÿä¼šå¯¹åº”çš„æ’å…¥ä¸€è¡Œâ€œå›æ»šè®°å½•â€ï¼Œç”¨äºMVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ä¸­æ„å»ºä¸åŒæ—¶é—´å¯åŠ¨çš„äº‹åŠ¡çš„è§†å›¾ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†ç»´æŒä¸€ä¸ªå¯é‡å¤è¯»çš„è§†å›¾ã€‚\næ¯”å¦‚ç°åœ¨æ‰§è¡Œæ“ä½œå‡å¦‚ç°åœ¨c=1ï¼Œæ‰§è¡Œupdate c=2, c=3, c=4çš„æ“ä½œï¼Œé‚£ä¹ˆå¯¹åº”çš„å°±ä¼šæ’å…¥å››è¡Œå›æ»šè®°å½•ï¼Œå°†2å›æ»šä¸º1ï¼Œå°†3å›æ»šä¸º2ï¼Œå°†4å›æ»šä¸º3ã€‚\nä¸‰ä¸ªæ›´æ–°æ“ä½œçš„æ—¶åˆ»t1ã€t2ã€t3ï¼Œç›¸å½“äºç¡®ç«‹äº†ä¸‰ä¸ªè¾¹ç•Œï¼Œè¾¹ç•Œæ—¶é—´ç‚¹å‰åå¯èƒ½ä¼šæœ‰ä¸åŒçš„äº‹åŠ¡å¯åŠ¨ã€ç»“æŸã€‚é‚£äº›ä¾ç„¶è¿˜æœªç»“æŸçš„äº‹åŠ¡ï¼Œé€šè¿‡ä»–ä»¬çš„å¯åŠ¨æ—¶é—´ä¸å›æ»šè®°å½•æ’å…¥æ—¶çš„æ—¶é—´åšå¯¹æ¯”ï¼Œå°±å¯ä»¥æ‰¾åˆ°åº”è¯¥ä¾æ¬¡æ‰§è¡Œå“ªäº›å›æ»šè®°å½•æ¥æ¢å¤åˆ°å¯åŠ¨äº‹åŠ¡æ—¶çš„æ•°æ®åº“çŠ¶æ€ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥é‡å»ºä¸€ä¸ªå¯é‡å¤è¯»çš„è§†å›¾ã€‚\nè¿™å°±æ˜¯MVCCçš„è¦ä¹‰ã€‚\nè¿™äº›å›æ»šæ—¥å¿—ï¼Œå¤šäº†ä¹‹åä¹Ÿä¼šå ç”¨å­˜å‚¨ç©ºé—´ï¼Œæµªè´¹èµ„æºï¼Œéœ€è¦æ¸…é™¤ï¼Ÿä½†æ˜¯å‡å¦‚æœ‰ä¸ªäº‹åŠ¡æ˜¯æ—¶åˆ»tå¯åŠ¨çš„ï¼Œé‚£ä¹ˆæ—¶åˆ»tä¹‹åçš„å›æ»šæ—¥å¿—éƒ½æ˜¯è¦ä¿ç•™çš„ï¼Œå¦‚æœè¿™ä¸ªäº‹åŠ¡æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼Œå°±ä¼šå¯¼è‡´å›æ»šæ—¥å¿—ç§¯ç´¯å¾ˆå¤šï¼Œæµªè´¹èµ„æºã€‚å› æ­¤ä¸å»ºè®®ä½¿ç”¨é•¿äº‹åŠ¡ã€‚\næŸ¥æ‰¾æ‰§è¡Œæ—¶é—´è¶…è¿‡60sçš„é•¿äº‹åŠ¡ï¼š\nselect * from information_schema.innodb_trx where TIME_TO_SEC(timediff(now(),trx_started))\u0026gt;60  äº†è§£ä¸‹è¿™ä¸ªäº‹åŠ¡ç»Ÿè®¡è¡¨å‡ ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„å­—æ®µï¼š\nmysql\u0026gt; desc innodb_trx; +----------------------------+-----------------+------+-----+---------+-------+ | Field | Type | Null | | +----------------------------+-----------------+------+-----+---------+-------+ | trx_id | bigint unsigned | NO | äº‹åŠ¡id | | trx_state | varchar(13) | NO | äº‹åŠ¡çŠ¶æ€ï¼Œå¦‚RUNNING | | trx_started | datetime | NO | äº‹åŠ¡å¯åŠ¨æ—¶é—´ | ... | trx_tables_locked | bigint unsigned | NO | å¢åˆ è®°å½•ä¼šé”è¡¨çš„ | ... | trx_rows_locked | bigint unsigned | NO | æ›´æ–°è®°å½•ä¼šé”è¡Œçš„ | | trx_rows_modified | bigint unsigned | NO | ä¿®æ”¹çš„è¡Œæ•°é‡ | ... | trx_isolation_level | varchar(16) | NO | å½“å‰äº‹åŠ¡éš”ç¦»çº§åˆ« | ... +----------------------------+-----------------+------+-----+---------+-------+  "}),a.add({id:181,href:"/blog/02%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%E4%B8%80%E6%9D%A1sql%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/",title:"02ä¸€æ¡SQLæ›´æ–°è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„",description:"è¿™é‡Œæ¶‰åŠçš„æ—¥å¿—ç±»å‹ï¼š\n  æ‰§è¡Œå¼•æ“å±‚ï¼šinnodb redolog\n  mysqlæœåŠ¡å±‚ï¼šmysql binlog\n  ä¹°ä¸œè¥¿èµŠè´¦ä¸ºä¾‹ï¼Œè€æ¿é€šå¸¸æœ‰ä¸ªè´¦æœ¬ï¼Œä¸Šé¢è®°å½•äº†æ‰€æœ‰äººæ€»çš„èµŠè´¦æƒ…å†µï¼Œä½†æ˜¯å¿™çš„æ—¶å€™æ˜¯æ¥ä¸åŠæŸ¥ã€è®¡ç®—çš„ï¼Œå¯èƒ½å°±ä¼šåœ¨ä¸€ä¸ªç²‰æ¿ä¸Šè®°å½•å½“å‰æ¬¡çš„èµŠè´¦æƒ…å†µï¼Œç­‰æ‰“çƒŠä¹‹åå†å»ç®—ï¼Œç®—å®Œæ›´æ–°åˆ°è´¦æœ¬ä¸Šã€‚\nmysqlçš„è®¾è®¡è€…ï¼Œé‡‡ç”¨äº†ç±»ä¼¼è€æ¿è®°è´¦çš„æ–¹å¼ï¼Œæ¥æé«˜æ›´æ–°æ•ˆç‡ã€‚\nWALï¼šwrite ahead logï¼Œå…³é”®ç‚¹å°±æ˜¯ï¼š\n å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ ä¹Ÿå°±æ˜¯å…ˆå†™ç²‰æ¿ï¼Œä¸å¿™çš„æ—¶å€™å†å†™è´¦æœ¬ï¼›   WAL logå†™æ“ä½œåŸºæœ¬åªæ˜¯è¿½åŠ ï¼Œç£ç›˜é¡ºåºå†™ï¼Œæ•ˆç‡é«˜ï¼›å†™è®°å½•åˆ°ç£ç›˜è¿˜è¦è€ƒè™‘B+æ ‘ç‰¹æ€§ã€ç£ç›˜ç‰¹æ€§ï¼Œè¦æ‰¾åˆ°åœ¨å“ªé‡Œæ’å…¥ï¼Œæ¶‰åŠåˆ°å¤šæ¬¡éšæœºè¯»ï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒå·®çš„ã€‚\næ‰€ä»¥è¯´å…ˆå†™WALè¿™é‡Œæ˜¯æé«˜æ›´æ–°æ•ˆç‡æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå½“ç„¶äº†ï¼Œä¹Ÿæä¾›äº†å´©æºƒåæ¢å¤çš„ä¸€ç§ä¿è¯ã€‚\n å…·ä½“è¯´ï¼Œå°±æ˜¯innodbå¼•æ“ä¼šï¼š\n å…ˆæŠŠè®°å½•å†™åˆ°redo logé‡Œé¢ï¼› å†æ›´æ–°å†…å­˜ï¼Œï¼ˆè¿™ä¸ªæ—¶å€™å°±ç®—æ›´æ–°å®Œæˆäº†ï¼‰ï¼› ç„¶åæ¯”è¾ƒç©ºé—²çš„æ—¶å€™å†å†™å›ç£ç›˜ã€‚  ä½†æ˜¯å¦‚æœç²‰æ¿å†™æ»¡äº†æ€ä¹ˆåŠå‘¢ï¼Ÿè€æ¿åªèƒ½åœä¸‹æ‰‹ä¸­çš„æ´»ï¼Œå…ˆæŠŠç²‰æ¿ä¸Šçš„èµŠè´¦è®°å½•ç®—å®Œè…¾åˆ°è´¦æœ¬ä¸Šï¼Œç„¶åæ“¦æ‰ç²‰æ¿è…¾å‡ºæ–°çš„ç©ºé—´ï¼Œç„¶åå†ç»§ç»­èµŠè´¦ã€‚\nç±»ä¼¼åœ°ï¼Œinnodbçš„redo logä¹Ÿæ˜¯å›ºå®šå¤§å°çš„ï¼ˆå’Œç²‰æ¿ç±»ä¼¼ï¼‰ï¼Œä»å¤´åˆ°å°¾å†™æ»¡äº†ï¼Œå°±å¾—å†ä»å¤´å†™ã€‚redologç»´æŠ¤äº†ä¸¤ä¸ªæŒ‡é’ˆï¼š\n write posï¼Œå†™æœ€æ–°èµŠè´¦è®°å½•çš„ä½ç½®ï¼Œ++ï¼Œåˆ°å¤´åå†å¼€å§‹ï¼› checkpointï¼Œè¡¨ç¤ºå·²ç»å°†å¯¹åº”æ“ä½œåŒæ­¥åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶çš„ä½ç½®ï¼Œç›¸å½“äºè…¾ç©ºçš„ç²‰æ¿ä½ç½®ï¼Œå¯ä»¥ç»§ç»­è®°å½•èµŠè´¦ä½ç½®ã€‚  å½“writeposè¿½ä¸Šcheckpointçš„æ—¶å€™ï¼Œè¡¨ç¤ºå†™æ»¡äº†ï¼Œè¿™æ—¶å€™mysqlå°±å¾—å’Œè€æ¿ä¸€æ ·åœä¸‹æ¥ç®—è´¦ï¼Œä¸èƒ½æ¥å—æ–°çš„æ›´æ–°è¯·æ±‚ï¼Œè¿™æ ·æŠŠcheckpointæ¨è¿›ä»¥ä¸‹ä¹‹åï¼Œå†ç»§ç»­æ¥å—æ›´æ–°è¯·æ±‚ã€‚\nè¿™æ ·å³ä½¿æ•°æ®åº“è¿è¡ŒæœŸé—´å´©æºƒäº†ï¼Œä½†æ˜¯æœ‰äº†è¿™ä¸ªredologï¼Œå°±å¯ä»¥å°†ä¹‹å‰çš„æ“ä½œå…¨éƒ¨æ¢å¤ï¼Œä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¹‹ä¸ºcrash-safeã€‚\nè¿™é‡Œçš„write posã€checkpointçš„ä½œç”¨ï¼Œæ˜¯ä¸ºäº†æé«˜æ›´æ–°æ•ˆç‡ï¼Œå»¶æ—¶å†™å…¥ç£ç›˜ç”¨çš„ã€‚\nä¸€ä¸ªæ›´æ–°æ“ä½œæ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ\n  å½“æ‰§è¡Œä¸€ä¸ªæ›´æ–°æ“ä½œæ—¶ï¼Œæ‰§è¡Œå™¨æ‰¾åˆ°è®°å½•å¯¹åº”çš„è¡Œï¼Œè¯·æ±‚æ‰§è¡Œå¼•æ“è¿”å›è¡Œæ•°æ®ï¼Œå¦‚æœè¡Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ‰§è¡Œå¼•æ“å°±ä»å†…å­˜ç›´æ¥è¿”å›ï¼Œåä¹‹è¿˜éœ€è¦ä»ç£ç›˜ä¸Šè¯»å›æ¥è¿”å›ã€‚æ‰§è¡Œå™¨æ‹¿åˆ°è¡Œæ•°æ®ä¹‹åå®Œæˆæ›´æ–°ï¼Œæ¯”å¦‚æŸåˆ—N=N+1ï¼Œå¹¶è¯·æ±‚æ‰§è¡Œå¼•æ“æ›´æ–°è¡Œæ•°æ®ã€‚\n  æ‰§è¡Œå¼•æ“å°†æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†™redo logï¼Œç„¶åè¿”å›ç»™æ‰§è¡Œå¼•æ“æˆåŠŸï¼Œè¡¨ç¤ºè¿›å…¥prepareçŠ¶æ€ï¼Œéšæ—¶å¯æäº¤ã€‚\n ä¸ºä»€ä¹ˆä¸å…ˆå†™redologï¼Œå†å†™å†…å­˜ï¼Ÿ\næ²¡æœ‰å®è´¨åŒºåˆ«å§ï¼Œä¸éƒ½å†™äº†å†…å­˜å˜›ã€‚æ˜¯æ‹…å¿ƒæ•°æ®ä¸ä¸€è‡´é—®é¢˜å—ï¼Ÿåˆ«æ‹…å¿ƒï¼Œmysqlç”¨äº†MVCCçš„ï¼Œï¼ˆå¯é‡å¤è¯»çº§åˆ«ï¼‰ä¸ä¼šå‡ºç°ä¸å¯é‡å¤è¯»çš„ã€‚\n   æ‰§è¡Œå™¨æ”¶åˆ°æ­£å¸¸å“åº”åï¼Œç”Ÿæˆbinlogå¹¶å†™å…¥ç£ç›˜binlogæ–‡ä»¶ï¼Œç„¶åå¯¹åˆšæ‰çš„æ“ä½œç»§ç»­è¯·æ±‚ç½®å¼•æ“å‘èµ·commitæ“ä½œã€‚\n å¦‚æœå†™binlogå¤±è´¥ä¼šæ€æ ·ï¼Ÿmysqlä¸­æœ‰ä¸ªé€‰é¡¹binlog_error_actionï¼Œç”¨æ¥æ§åˆ¶å¦‚æœbinlogå†™å¤±è´¥ï¼š\n  ä¸Šè¿°å˜é‡ï¼Œå…¶é»˜è®¤å€¼æ˜¯ABORT_SERVERï¼Œå³mysqldé€€å‡ºã€‚éœ€è¦æ’é™¤binlogå†™å¤±è´¥åŸå› ï¼ˆå¦‚ç£ç›˜æ»¡ã€inodeè€—å…‰ç­‰ï¼‰åå†å¯åŠ¨èµ·æ¥ã€‚\n  è¿˜å¯ä»¥å°†ä¸Šè¿°å˜é‡è®¾ç½®ä¸ºIGNORE_ERRORï¼Œå°±æ˜¯å†™binlogå¤±è´¥å°±å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´æ²¡æœ‰ç”Ÿæˆbinlogï¼Œæ— æ³•åŒæ­¥ç»™slaveï¼Œmaster-slaveæ•°æ®å°±ä¼šå˜å¾—ä¸ä¸€è‡´ã€‚è€Œä¸”ä¹Ÿä¼šå½±å“åˆ°æ•°æ®å¤‡ä»½ã€‚ä¸€èˆ¬æ˜¯ä¸å¤ªèƒ½æ¥å—çš„ã€‚\n  é‡å¯åï¼Œinnodbä¸­æœ‰prepareé˜¶æ®µçš„redo logï¼ˆæœªcommitedï¼‰ï¼Œè¿™ä¸ªæ—¶å€™binlogä¸­åˆæ²¡æœ‰å¯¹åº”çš„binlogï¼Œæ­¤æ—¶å°±ä¼šrollbackæ‰ã€‚",content:"è¿™é‡Œæ¶‰åŠçš„æ—¥å¿—ç±»å‹ï¼š\n  æ‰§è¡Œå¼•æ“å±‚ï¼šinnodb redolog\n  mysqlæœåŠ¡å±‚ï¼šmysql binlog\n  ä¹°ä¸œè¥¿èµŠè´¦ä¸ºä¾‹ï¼Œè€æ¿é€šå¸¸æœ‰ä¸ªè´¦æœ¬ï¼Œä¸Šé¢è®°å½•äº†æ‰€æœ‰äººæ€»çš„èµŠè´¦æƒ…å†µï¼Œä½†æ˜¯å¿™çš„æ—¶å€™æ˜¯æ¥ä¸åŠæŸ¥ã€è®¡ç®—çš„ï¼Œå¯èƒ½å°±ä¼šåœ¨ä¸€ä¸ªç²‰æ¿ä¸Šè®°å½•å½“å‰æ¬¡çš„èµŠè´¦æƒ…å†µï¼Œç­‰æ‰“çƒŠä¹‹åå†å»ç®—ï¼Œç®—å®Œæ›´æ–°åˆ°è´¦æœ¬ä¸Šã€‚\nmysqlçš„è®¾è®¡è€…ï¼Œé‡‡ç”¨äº†ç±»ä¼¼è€æ¿è®°è´¦çš„æ–¹å¼ï¼Œæ¥æé«˜æ›´æ–°æ•ˆç‡ã€‚\nWALï¼šwrite ahead logï¼Œå…³é”®ç‚¹å°±æ˜¯ï¼š\n å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ ä¹Ÿå°±æ˜¯å…ˆå†™ç²‰æ¿ï¼Œä¸å¿™çš„æ—¶å€™å†å†™è´¦æœ¬ï¼›   WAL logå†™æ“ä½œåŸºæœ¬åªæ˜¯è¿½åŠ ï¼Œç£ç›˜é¡ºåºå†™ï¼Œæ•ˆç‡é«˜ï¼›å†™è®°å½•åˆ°ç£ç›˜è¿˜è¦è€ƒè™‘B+æ ‘ç‰¹æ€§ã€ç£ç›˜ç‰¹æ€§ï¼Œè¦æ‰¾åˆ°åœ¨å“ªé‡Œæ’å…¥ï¼Œæ¶‰åŠåˆ°å¤šæ¬¡éšæœºè¯»ï¼Œæ•ˆç‡æ˜¯æ¯”è¾ƒå·®çš„ã€‚\næ‰€ä»¥è¯´å…ˆå†™WALè¿™é‡Œæ˜¯æé«˜æ›´æ–°æ•ˆç‡æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå½“ç„¶äº†ï¼Œä¹Ÿæä¾›äº†å´©æºƒåæ¢å¤çš„ä¸€ç§ä¿è¯ã€‚\n å…·ä½“è¯´ï¼Œå°±æ˜¯innodbå¼•æ“ä¼šï¼š\n å…ˆæŠŠè®°å½•å†™åˆ°redo logé‡Œé¢ï¼› å†æ›´æ–°å†…å­˜ï¼Œï¼ˆè¿™ä¸ªæ—¶å€™å°±ç®—æ›´æ–°å®Œæˆäº†ï¼‰ï¼› ç„¶åæ¯”è¾ƒç©ºé—²çš„æ—¶å€™å†å†™å›ç£ç›˜ã€‚  ä½†æ˜¯å¦‚æœç²‰æ¿å†™æ»¡äº†æ€ä¹ˆåŠå‘¢ï¼Ÿè€æ¿åªèƒ½åœä¸‹æ‰‹ä¸­çš„æ´»ï¼Œå…ˆæŠŠç²‰æ¿ä¸Šçš„èµŠè´¦è®°å½•ç®—å®Œè…¾åˆ°è´¦æœ¬ä¸Šï¼Œç„¶åæ“¦æ‰ç²‰æ¿è…¾å‡ºæ–°çš„ç©ºé—´ï¼Œç„¶åå†ç»§ç»­èµŠè´¦ã€‚\nç±»ä¼¼åœ°ï¼Œinnodbçš„redo logä¹Ÿæ˜¯å›ºå®šå¤§å°çš„ï¼ˆå’Œç²‰æ¿ç±»ä¼¼ï¼‰ï¼Œä»å¤´åˆ°å°¾å†™æ»¡äº†ï¼Œå°±å¾—å†ä»å¤´å†™ã€‚redologç»´æŠ¤äº†ä¸¤ä¸ªæŒ‡é’ˆï¼š\n write posï¼Œå†™æœ€æ–°èµŠè´¦è®°å½•çš„ä½ç½®ï¼Œ++ï¼Œåˆ°å¤´åå†å¼€å§‹ï¼› checkpointï¼Œè¡¨ç¤ºå·²ç»å°†å¯¹åº”æ“ä½œåŒæ­¥åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶çš„ä½ç½®ï¼Œç›¸å½“äºè…¾ç©ºçš„ç²‰æ¿ä½ç½®ï¼Œå¯ä»¥ç»§ç»­è®°å½•èµŠè´¦ä½ç½®ã€‚  å½“writeposè¿½ä¸Šcheckpointçš„æ—¶å€™ï¼Œè¡¨ç¤ºå†™æ»¡äº†ï¼Œè¿™æ—¶å€™mysqlå°±å¾—å’Œè€æ¿ä¸€æ ·åœä¸‹æ¥ç®—è´¦ï¼Œä¸èƒ½æ¥å—æ–°çš„æ›´æ–°è¯·æ±‚ï¼Œè¿™æ ·æŠŠcheckpointæ¨è¿›ä»¥ä¸‹ä¹‹åï¼Œå†ç»§ç»­æ¥å—æ›´æ–°è¯·æ±‚ã€‚\nè¿™æ ·å³ä½¿æ•°æ®åº“è¿è¡ŒæœŸé—´å´©æºƒäº†ï¼Œä½†æ˜¯æœ‰äº†è¿™ä¸ªredologï¼Œå°±å¯ä»¥å°†ä¹‹å‰çš„æ“ä½œå…¨éƒ¨æ¢å¤ï¼Œä¸ä¼šä¸¢å¤±ï¼Œè¿™ä¸ªèƒ½åŠ›ç§°ä¹‹ä¸ºcrash-safeã€‚\nè¿™é‡Œçš„write posã€checkpointçš„ä½œç”¨ï¼Œæ˜¯ä¸ºäº†æé«˜æ›´æ–°æ•ˆç‡ï¼Œå»¶æ—¶å†™å…¥ç£ç›˜ç”¨çš„ã€‚\nä¸€ä¸ªæ›´æ–°æ“ä½œæ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ\n  å½“æ‰§è¡Œä¸€ä¸ªæ›´æ–°æ“ä½œæ—¶ï¼Œæ‰§è¡Œå™¨æ‰¾åˆ°è®°å½•å¯¹åº”çš„è¡Œï¼Œè¯·æ±‚æ‰§è¡Œå¼•æ“è¿”å›è¡Œæ•°æ®ï¼Œå¦‚æœè¡Œæ•°æ®åœ¨å†…å­˜ä¸­ï¼Œæ‰§è¡Œå¼•æ“å°±ä»å†…å­˜ç›´æ¥è¿”å›ï¼Œåä¹‹è¿˜éœ€è¦ä»ç£ç›˜ä¸Šè¯»å›æ¥è¿”å›ã€‚æ‰§è¡Œå™¨æ‹¿åˆ°è¡Œæ•°æ®ä¹‹åå®Œæˆæ›´æ–°ï¼Œæ¯”å¦‚æŸåˆ—N=N+1ï¼Œå¹¶è¯·æ±‚æ‰§è¡Œå¼•æ“æ›´æ–°è¡Œæ•°æ®ã€‚\n  æ‰§è¡Œå¼•æ“å°†æ•°æ®æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œç„¶åå†™redo logï¼Œç„¶åè¿”å›ç»™æ‰§è¡Œå¼•æ“æˆåŠŸï¼Œè¡¨ç¤ºè¿›å…¥prepareçŠ¶æ€ï¼Œéšæ—¶å¯æäº¤ã€‚\n ä¸ºä»€ä¹ˆä¸å…ˆå†™redologï¼Œå†å†™å†…å­˜ï¼Ÿ\næ²¡æœ‰å®è´¨åŒºåˆ«å§ï¼Œä¸éƒ½å†™äº†å†…å­˜å˜›ã€‚æ˜¯æ‹…å¿ƒæ•°æ®ä¸ä¸€è‡´é—®é¢˜å—ï¼Ÿåˆ«æ‹…å¿ƒï¼Œmysqlç”¨äº†MVCCçš„ï¼Œï¼ˆå¯é‡å¤è¯»çº§åˆ«ï¼‰ä¸ä¼šå‡ºç°ä¸å¯é‡å¤è¯»çš„ã€‚\n   æ‰§è¡Œå™¨æ”¶åˆ°æ­£å¸¸å“åº”åï¼Œç”Ÿæˆbinlogå¹¶å†™å…¥ç£ç›˜binlogæ–‡ä»¶ï¼Œç„¶åå¯¹åˆšæ‰çš„æ“ä½œç»§ç»­è¯·æ±‚ç½®å¼•æ“å‘èµ·commitæ“ä½œã€‚\n å¦‚æœå†™binlogå¤±è´¥ä¼šæ€æ ·ï¼Ÿmysqlä¸­æœ‰ä¸ªé€‰é¡¹binlog_error_actionï¼Œç”¨æ¥æ§åˆ¶å¦‚æœbinlogå†™å¤±è´¥ï¼š\n  ä¸Šè¿°å˜é‡ï¼Œå…¶é»˜è®¤å€¼æ˜¯ABORT_SERVERï¼Œå³mysqldé€€å‡ºã€‚éœ€è¦æ’é™¤binlogå†™å¤±è´¥åŸå› ï¼ˆå¦‚ç£ç›˜æ»¡ã€inodeè€—å…‰ç­‰ï¼‰åå†å¯åŠ¨èµ·æ¥ã€‚\n  è¿˜å¯ä»¥å°†ä¸Šè¿°å˜é‡è®¾ç½®ä¸ºIGNORE_ERRORï¼Œå°±æ˜¯å†™binlogå¤±è´¥å°±å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´æ²¡æœ‰ç”Ÿæˆbinlogï¼Œæ— æ³•åŒæ­¥ç»™slaveï¼Œmaster-slaveæ•°æ®å°±ä¼šå˜å¾—ä¸ä¸€è‡´ã€‚è€Œä¸”ä¹Ÿä¼šå½±å“åˆ°æ•°æ®å¤‡ä»½ã€‚ä¸€èˆ¬æ˜¯ä¸å¤ªèƒ½æ¥å—çš„ã€‚\n  é‡å¯åï¼Œinnodbä¸­æœ‰prepareé˜¶æ®µçš„redo logï¼ˆæœªcommitedï¼‰ï¼Œè¿™ä¸ªæ—¶å€™binlogä¸­åˆæ²¡æœ‰å¯¹åº”çš„binlogï¼Œæ­¤æ—¶å°±ä¼šrollbackæ‰ã€‚\n   æ‰§è¡Œå¼•æ“æŠŠåˆšæ‰å†™å…¥çš„redologçš„çŠ¶æ€ä¿®æ”¹ä¸ºcommitçŠ¶æ€ï¼Œæ›´æ–°å®Œæˆã€‚\n ä¸‡ä¸€è¿™ä¸€æ­¥æ‰§è¡Œçš„æ—¶å€™ï¼ŒæœåŠ¡crashäº†æ€ä¹ˆåŠï¼Ÿè¿™ä¸ªæ—¶å€™innodbä¹Ÿå†™äº†redo logäº†ï¼ŒæœåŠ¡å±‚ä¹Ÿå†™äº†binlogäº†ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ\n  å¦‚æœredo logé‡Œé¢å·²ç»ä¿®æ”¹æˆcommitedäº†ï¼Œé‡å¯åï¼Œcrash recoverçš„æ—¶å€™innodbæ˜¯å¯ä»¥æ¢å¤è¿™ä¸ªæ•°æ®çš„ï¼›\n  å¦‚æœredo logé‡Œé¢æ²¡æœ‰æ”¹æˆcommitedå‘¢ï¼Ÿä»¥ä¸ºéƒ½æ˜¯ä¸¤é˜¶æ®µæäº¤ï¼Œå› ä¸ºbinlogé‡Œé¢æœ‰è®°å½•ï¼Œä½†æ˜¯redo logæ²¡æœ‰æ”¹æˆcommitedï¼Œæ‰€ä»¥å¯èƒ½è¦æœåŠ¡å±‚å‘èµ·commitæ“ä½œï¼Ÿ\nfixme ä»¥åå†ç¡®å®šä¸‹è¿™ä¸ªé—®é¢˜å§ï¼\n     æ‰§è¡Œå¼•æ“åœ¨åˆé€‚çš„ï¼ˆé€šå¸¸æ˜¯ç©ºé—²çš„ï¼‰æ—¶å€™å°†redologä¸­æ•°æ®åŒæ­¥åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶ã€‚\n  æ³¨æ„è¿™é‡Œå°† redolog æ‹†æˆä¸¤éƒ¨åˆ†prepare+commitï¼Œè¿™å°±æ˜¯å…¸å‹çš„ä¸¤é˜¶æ®µæäº¤ã€‚ä¸ºä»€ä¹ˆè¦ä¸¤é˜¶æ®µæäº¤ï¼Œæ˜¯ä¸ºäº†ä¿æŒä¸¤ä»½æ—¥å¿—æ–‡ä»¶çš„å®Œæ•´æ€§ï¼Œè®©ä¸¤ä»½æ—¥å¿—æ–‡ä»¶ä¹‹é—´çš„é€»è¾‘ä¸€è‡´ã€‚\nä¸å¦¨ä»æ¢å¤æ•°æ®åº“åˆ°åŠä¸ªæœˆå†…ä»»æ„ä¸€ç§’tçš„çŠ¶æ€ï¼Œä»è¿™ä¸ªè§’åº¦æ¥æ€è€ƒè¿™ä¸ªé—®é¢˜ï¼Ÿ\n å¦‚ä½•æ¢å¤ï¼Ÿé¦–å…ˆtä¹‹å‰çš„æœ€è¿‘çš„ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œå…ˆæ¢å¤åˆ°ä¸´æ—¶æ•°æ®åº“ä¸­ï¼Œç„¶åæ‰¾è¿™æ¬¡å…¨é‡å¤‡ä»½ä¹‹åtä¹‹å‰çš„binlogï¼Œå¹¶æ¢å¤åˆ°ä¸´æ—¶æ•°æ®åº“ä¸­ã€‚ç„¶åå°†ä¸´æ—¶æ•°æ®åº“ä¸­çš„æ•°æ®æ¢å¤åˆ°çº¿ä¸Šã€‚ å†çœ‹ä¸ºä»€ä¹ˆç”¨ä¸¤é˜¶æ®µæäº¤ï¼Ÿä¸ç”¨å°±ä¸èƒ½ä¿è¯ä¸¤ä¸ªæ—¥å¿—æ–‡ä»¶çš„å®Œæ•´æ€§ï¼ˆc=c+1ï¼‰ï¼š  å‡å¦‚å…ˆå†™å®Œredologå†å†™binlogï¼Œredologå°†c=0æ”¹æˆäº†1ï¼Œä½†æ˜¯binlogå†™æˆåŠŸå‰æŒ‚æ‰äº†ï¼Œè¿™æ ·æœ¬åœ°æ•°æ®æ˜¯c=1ï¼Œä½†æ˜¯å½’æ¡£æ—¥å¿—åŒæ­¥ç»™åˆ«äººåä¸¢äº†ä¸€ä¸ªäº‹åŠ¡æ“ä½œï¼Œæˆ–è€…è‡ªå·±é‡å¯åæ¢å¤çš„æ—¶å€™ä¹Ÿä¸¢äº†ä¸€ä¸ªæ“ä½œcå˜æˆäº†0ã€‚ å‡å¦‚å…ˆå†™å®Œbinlogåå†å†™redologï¼Œbinlogä¸­è®°å½•äº†c=c+1=1ï¼Œä½†æ˜¯redologå†™å¤±è´¥äº†ï¼Œæ­¤æ—¶åº“ä¸­æ•°æ®å…¶å®æ˜¯0ï¼Œå¦‚æœbinlogåŒæ­¥ç»™åˆ«äººï¼ŒæŒ‰binlogæ¢å¤å‡ºçš„æ•°æ®æ˜¯1ï¼Œè€Œä¸æ˜¯0ï¼Œä¹Ÿä¸ä¸€è‡´ã€‚å¦‚æœæ˜¯æŒ‚æ‰ä¹‹åæ¢å¤ï¼Œèƒ½ä¸€è‡´éƒ½æ˜¯1ã€‚    å¯è§å¦‚æœä¸é€‚ç”¨prepare-commitä¸¤é˜¶æ®µæäº¤çš„è¯ï¼Œæ—¥å¿—ä¸­è®°å½•çš„çŠ¶æ€å’ŒçœŸå®çš„å­˜å‚¨æƒ…å†µå°±ä¼šå‡ºç°ä¸ä¸€è‡´ã€‚\nä¸åªæ˜¯æ•°æ®åº“è¯¯åˆ è¡¨ä¹‹ç±»çš„æ‰ä¼šæœ‰æ¢å¤çš„éœ€è¦ï¼Œå…¶å®mysqlé›†ç¾¤æ‰©å®¹ï¼Œæ¯”å¦‚å¤šåŠ å‡ ä¸ªè¯»å‰¯æœ¬ï¼Œä¹Ÿæ˜¯éœ€è¦è¿™é‡Œçš„å…¨é‡å¤‡ä»½+binlogåŒæ­¥æ¥å®Œæˆâ€œæ•°æ®æ¢å¤â€çš„ã€‚\nbinlogæ˜¯mysqlæœåŠ¡å±‚é¢è®°å½•çš„åŸå§‹æ“ä½œæ—¥å¿—ï¼Œæ¯”å¦‚ç»™æŸåˆ—+1ï¼Œinnodbçš„redologæ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯åœ¨å“ªä¸ªç‰©ç†é¡µä¸Šå†™ä»€ä¹ˆæ•°æ®ï¼Œbinlogæ‰æ˜¯master-slaveåŒæ­¥ç”¨çš„ï¼Œè¿™ä¸ªåœ¨åŠŸèƒ½ä¸Šæ˜¯å’Œraftä¸­çš„wal logåŠŸèƒ½å®šä½ä¸€è‡´çš„ã€‚\nrelogçš„åˆè¡·ï¼Œåªæ˜¯ä¸ºäº†æé«˜æ›´æ–°çš„æ•ˆç‡ï¼Œè€Œéå®ç°master-slaveçš„æ•°æ®ä¸€è‡´æ€§ã€‚binlogæ‰æ˜¯ä¸ºäº†è¿½æ±‚æ•°æ®ä¸€è‡´æ€§çš„ã€‚walåªæ˜¯ä¸€ç§æ“ä½œä¸Šçš„æè¿°ï¼Œraftä¸­çš„ä¹Ÿæ˜¯å«walï¼Œä½†æ˜¯ä¹Ÿåº”è¯¥çœ‹åˆ°éƒ½å«walï¼Œä½†æ˜¯è¿™åªæ˜¯ä¸€ç§ç­–ç•¥ï¼Œå®ç°å‡ºæ¥çš„å®é™…åŠŸèƒ½ã€å®šä½å¯èƒ½æ˜¯å®Œå…¨ä¸åŒçš„ã€‚\nredologç©ºé—´æ˜¯æœ‰é™çš„ï¼Œæ¯•ç«Ÿå®ƒæ˜¯ä¸ºäº†æé«˜æ›´æ–°æ•ˆç‡ç”¨çš„ï¼Œmysqlæ˜¯è¿½åŠ å†™çš„ï¼Œå†™å®Œä¸€ä¸ªbinlogæ–‡ä»¶ç»§ç»­å†™ä¸‹ä¸€ä¸ªbinlogæ–‡ä»¶ï¼Œä¸ä¼šè¦†ç›–ä»¥å‰çš„ï¼Œå®ƒçš„å®šä½æ˜¯è¦å®ç°ä¸»ä»èŠ‚ç‚¹çš„æ•°æ®åŒæ­¥ï¼Œæ‰€ä»¥binlogæ—¥å¿—ä¹Ÿç§°ä¸ºå½’æ¡£æ—¥å¿—ï¼Œæ˜¯å½’æ¡£ç”¨çš„ï¼Œç”¨æ¥å®ç°ä¸»ä»é—´æ•°æ®åŒæ­¥çš„ã€‚\nä¸¾ä¸€åä¸‰ï¼š\nè”æƒ³åˆ°äº†raftç®—æ³•ä¸­ï¼Œä¸ºäº†ä¿è¯æ•°æ®å¼ºä¸€è‡´çš„æ•ˆæœï¼Œä¹Ÿé‡‡å–äº†WALçš„æ–¹å¼ã€‚æ¯”å¦‚masteræ”¶åˆ°ä¸€ä¸ªæ›´æ–°è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä¼šå†™æœ¬åœ°logï¼Œå¹¶ç»´æŠ¤äº†å‡ ä¸ªç´¢å¼•å€¼nextIndexã€commitIndexï¼ŒnextIndexæ˜¯ä¸‹æ¬¡å‡†å¤‡åŒæ­¥ç»™slaveèŠ‚ç‚¹çš„æ—¥å¿—çš„ç´¢å¼•ä½ç½®ï¼Œä½†æ˜¯åŒæ­¥ç»™å¾ˆå¤šslaveèŠ‚ç‚¹çš„è¿‡ç¨‹æ˜¯å¹¶å‘çš„ï¼Œå¯èƒ½æœ‰çš„æ—¥å¿—ç´¢å¼•é¡¹åœ¨æŸäº›èŠ‚ç‚¹ä¸Šæœ‰å†²çªï¼Œæ²¡æœ‰æ”¶åˆ°å¤šæ•°æŠ•ç¥¨ï¼Œæˆ–è€…masteræ›´æ–°æ¯”è¾ƒå¿«ï¼Œè¿™éƒ½ä¼šå¯¼è‡´masterè¿™è¾¹çš„commitIndex\u0026lt;nextIndexã€‚commitIndexè¡¨ç¤ºæ”¶åˆ°äº†å¤šæ•°çš„æŠ•ç¥¨masterå·²ç»æäº¤åˆ°çŠ¶æ€æœºçš„æ—¥å¿—é¡¹çš„ç´¢å¼•ä½ç½®ã€‚commitIndexä¹Ÿä¼šåŒæ­¥ç»™å…¶ä»–çš„èŠ‚ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹å¯ä»¥æŠŠcommitIndexå½“åšä¸ºä¸€ä¸ªå¯ä»¥å¯é çš„å¯¹æœ¬åœ°logè¿›è¡ŒæŒä¹…åŒ–çš„å‚è€ƒå€¼ï¼ŒcommitIndexä¹‹å‰çš„æ—¥å¿—é¡¹éƒ½å¯ä»¥æäº¤åˆ°çŠ¶æ€æœºï¼Œå†™å…¥åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶ï¼Œå®ŒæˆæŒä¹…åŒ–ã€‚è€ŒcommitIndexä¹‹åçš„æ—¥å¿—æ¡ç›®ï¼Œéƒ½æ˜¯æœ‰å¯èƒ½ä¼šè¢«ä½œä¸ºçš„ï¼Œè¿™é€šå¸¸å’Œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å‡ºç°åˆ†åŒºæœ‰å…³ç³»ã€‚\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„walæ—¥å¿—ï¼Œwrite ahead logï¼Œå…¶æœ¬è´¨å°±æ˜¯åœ¨çœŸæ­£çš„å®Œæˆä¸€é¡¹æ“ä½œä¹‹å‰ï¼Œå…ˆæ—¥å¿—è®°å½•æˆåŠŸï¼Œåç»­å°±å¯ä»¥æœ‰ä¸ªä¿è¯ï¼Œå³å‡ºç°å¤±è´¥åä¹Ÿå¯ä»¥è¿›è¡Œå¯é åœ°é‡è¯•ï¼Œä¸è‡³äºæ•°æ®å‡ºç°ä¸¢å¤±ã€‚\nä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„å‚æ•°ï¼š\n  redo log ç”¨äºä¿è¯ crash-safe èƒ½åŠ›ã€‚innodb_flush_log_at_trx_commit è¿™ä¸ªå‚æ•°è®¾ç½®æˆ 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡çš„ redo log éƒ½ç›´æ¥æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™ä¸ªå‚æ•°æˆ‘å»ºè®®ä½ è®¾ç½®æˆ 1ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ MySQL å¼‚å¸¸é‡å¯ä¹‹åæ•°æ®ä¸ä¸¢å¤±ã€‚\n  sync_binlog è¿™ä¸ªå‚æ•°è®¾ç½®æˆ 1 çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡çš„ binlog éƒ½æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚è¿™ä¸ªå‚æ•°æˆ‘ä¹Ÿå»ºè®®ä½ è®¾ç½®æˆ 1ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ MySQL å¼‚å¸¸é‡å¯ä¹‹å binlog ä¸ä¸¢å¤±ã€‚\n  å¦å¤–ï¼Œâ€œä¸¤é˜¶æ®µæäº¤â€ä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¿è¯â€œæ•°æ®é€»è¾‘â€ä¸€è‡´æ€§çš„å¸¸ç”¨æ–¹æ¡ˆã€‚\nå¦å¤–å¤‡ä»½çš„é¢‘ç‡æ€ä¹ˆå†³å®šå‘¢ï¼Ÿä¸€å‘¨ä¸€æ¬¡å…¨é‡å¤‡ä»½ï¼Œè¿˜æ˜¯ä¸€å¤©ä¸€æ¬¡ã€‚è¿™ä¸ªè¦æ ¹æ®â€œä¸šåŠ¡é‡è¦æ€§â€ã€â€œæˆæœ¬â€ã€ä»¥åŠâ€œå¯å…è®¸çš„æœ€é•¿æ¢å¤æ—¶é—´â€æ¥å†³å®šã€‚\n ä¸šåŠ¡é‡è¦ï¼Œé¢„ç®—å®¢è§‚ï¼Œé‚£å°±å°½é‡å‡å°‘æ¢å¤æ—¶é—´ï¼Œä¸€å¤©ä¸€æ¬¡å¤‡ä»½ï¼› å¦‚æœä¸æ˜¯é‚£ä¹ˆé‡è¦ï¼Œé¢„ç®—åƒç´§ï¼Œä¹Ÿå¯¹è¾ƒé•¿çš„æ•°æ®æ¢å¤æ—¶é—´æœ‰ä¸€å®šçš„å®¹å¿åº¦ï¼Œé‚£ä¹ˆå°±ä¸€ä¼šèµ°ä¸€æ¬¡å¤‡ä»½ã€‚  "}),a.add({id:182,href:"/tags/update/",title:"update",description:"",content:""}),a.add({id:183,href:"/blog/01%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E4%B8%80%E6%9D%A1sql%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84/",title:"01ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„",description:"MySQLåŸºç¡€æ¶æ„\nmysqlåŸºç¡€æ¶æ„ç¤ºæ„å›¾ï¼ŒåŠä¸»è¦æµç¨‹ä»‹ç»\nmysql è¿æ¥åŠå†…å­˜ç®¡ç†\nmysql 8.0åˆ é™¤äº†æŸ¥è¯¢ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆï¼šhttps://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/\nä¼˜åŒ–å™¨ï¼šå­˜åœ¨å¤šä¸ªç´¢å¼•ï¼Œåº”è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ\nmysql selectè¯­å¥ä¸­ä¸å­˜åœ¨çš„åˆ—ï¼Œæ˜¯åœ¨å“ªä¸ªé˜¶æ®µåˆ†æå‡ºæ¥çš„å‘¢ï¼Ÿåˆ†æå™¨\nmysqldç¨‹åºå…¥å£:\n main: https://sourcegraph.com/github.com/mysql/mysql-server/-/blob/sql/main.cc#L23:12 mysqld_main: https://sourcegraph.com/github.com/mysql/mysql-server/-/blob/sql/mysqld.cc#L7680:5  ",content:"MySQLåŸºç¡€æ¶æ„\nmysqlåŸºç¡€æ¶æ„ç¤ºæ„å›¾ï¼ŒåŠä¸»è¦æµç¨‹ä»‹ç»\nmysql è¿æ¥åŠå†…å­˜ç®¡ç†\nmysql 8.0åˆ é™¤äº†æŸ¥è¯¢ç¼“å­˜ï¼Œä¸ºä»€ä¹ˆï¼šhttps://mysqlserverteam.com/mysql-8-0-retiring-support-for-the-query-cache/\nä¼˜åŒ–å™¨ï¼šå­˜åœ¨å¤šä¸ªç´¢å¼•ï¼Œåº”è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ\nmysql selectè¯­å¥ä¸­ä¸å­˜åœ¨çš„åˆ—ï¼Œæ˜¯åœ¨å“ªä¸ªé˜¶æ®µåˆ†æå‡ºæ¥çš„å‘¢ï¼Ÿåˆ†æå™¨\nmysqldç¨‹åºå…¥å£:\n main: https://sourcegraph.com/github.com/mysql/mysql-server/-/blob/sql/main.cc#L23:12 mysqld_main: https://sourcegraph.com/github.com/mysql/mysql-server/-/blob/sql/mysqld.cc#L7680:5  "}),a.add({id:184,href:"/tags/select/",title:"select",description:"",content:""}),a.add({id:185,href:"/tags/cas/",title:"cas",description:"",content:""}),a.add({id:186,href:"/tags/cmpxchg/",title:"cmpxchg",description:"",content:""}),a.add({id:187,href:"/tags/futex/",title:"futex",description:"",content:""}),a.add({id:188,href:"/categories/go%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/",title:"goè®¾è®¡å®ç°",description:"",content:""}),a.add({id:189,href:"/blog/2021-04-17-locks%E5%AE%9E%E7%8E%B0%E9%82%A3%E4%BA%9B%E4%B8%8D%E4%B8%BA%E4%BA%BA%E7%9F%A5%E7%9A%84%E6%95%85%E4%BA%8B/",title:"Lockså®ç°:èƒŒåä¸ä¸ºäººçŸ¥çš„æ•…äº‹",description:"ä»äº‹è½¯ä»¶å¼€å‘å¤šå¹´çš„ä½ ï¼ŒçœŸçš„äº†è§£locksèƒŒåçš„é‚£äº›æ•…äº‹å—ï¼Ÿé”æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ— é”çœŸçš„æ˜¯æ²¡æœ‰ä»»ä½•åŒæ­¥å—ï¼Œä¸ºä»€ä¹ˆæ€»æ˜¯è°ˆé”è‰²å˜ï¼Œé”ç©¶ç«Ÿæœ‰å“ªäº›å¼€é”€ã€‚æœ¬æ–‡å°†ç»“åˆgo sync.Mutexè®¨è®ºä¸‹è¿™äº›é—®é¢˜ã€‚",content:"ä»äº‹è½¯ä»¶å¼€å‘å¤šå¹´çš„ä½ ï¼ŒçœŸçš„ç†è§£locksèƒŒåçš„é‚£äº›æ•…äº‹å—ï¼Ÿé”æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæ— é”æŒ‡çš„åˆæ˜¯ä»€ä¹ˆï¼Œæ— é”çœŸçš„ç§»é™¤äº†ä»»ä½•åŒæ­¥æ“ä½œå—ï¼Ÿä¸ºä»€ä¹ˆå¤§å®¶æ€»æ˜¯è°ˆé”è‰²å˜ï¼Œé”çš„å¼€é”€çœŸçš„æœ‰é‚£ä¹ˆå¤§å—ï¼Œå¹³æ—¶ç¼–ç ä¸­åˆè¯¥æ³¨æ„äº›ä»€ä¹ˆå‘¢ï¼Ÿæœ¬æ–‡å°†ç»“åˆgo sync.Mutexå¯¹è¿™äº›é—®é¢˜è¿›è¡Œè®¨è®ºã€‚\nå¹¶å‘ï¼šæˆ‘ä»¬å…³å¿ƒä»€ä¹ˆ # å¹¶å‘ç¼–ç¨‹ï¼Œå¼€å‘äººå‘˜åº”è¯¥å¯¹åŸå­æ€§ã€æŒ‡ä»¤é‡æ’æœ‰æ·±åˆ»çš„è®¤è¯†ã€‚\nåŸå­æ€§ # å¤§å®¶éƒ½äº†è§£è¿‡æ•°æ®åº“äº‹åŠ¡çš„åŸå­æ€§ï¼Œç±»ä¼¼åœ°ï¼Œç¨‹åºä¸­ä¹Ÿç»å¸¸æœ‰äº›æ“ä½œä¹Ÿéœ€è¦è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœâ€”â€”è¢«æŸç§ç±»ä¼¼äº‹åŠ¡çš„æœºåˆ¶â€œä¿æŠ¤â€èµ·æ¥ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚é€šå¸¸æˆ‘ä»¬å°†è¿™æ ·éœ€è¦ä¿æŠ¤çš„ä»£ç æ®µç§°ä¸ºä¸´ç•ŒåŒºã€‚æˆ‘ä»¬å¸Œæœ›ä¸´ç•ŒåŒºå†…çš„ä»£ç è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œè¾¾åˆ°è¿™ç§åŸå­æ€§çš„æ•ˆæœã€‚\nå…¶å®ä¸åªæ˜¯ä»£ç æ®µï¼Œç»™ä¸€ä¸ªintå˜é‡èµ‹å€¼ï¼Œä¹Ÿéœ€è¦è€ƒè™‘åŸå­æ€§ï¼Œå› ä¸ºåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿã€å¤„ç†å™¨å¹³å°ä¸Šï¼Œå¯èƒ½ä¸€ä¸ªç®€å•çš„intå˜é‡èµ‹å€¼éœ€è¦æ¶‰åŠå¤šæ¡æœºå™¨æŒ‡ä»¤ï¼Œè€Œåœ¨å¤šæ¡æŒ‡ä»¤æ‰§è¡ŒæœŸé—´ï¼Œåˆ™å¯èƒ½å‘ç”Ÿå„ç§äº‹ä»¶ï¼Œæ¯”å¦‚è¢«å…¶ä»–CPUæ ¸çš„èµ‹å€¼æŒ‡ä»¤å†™ä¹±äº†åŒä¸€å˜é‡çš„æ•°æ®ã€‚è®¾æƒ³ä¸‹ä¸€ä¸ªintå˜é‡4å­—èŠ‚ï¼Œä½†æ˜¯å¤„ç†å™¨å¹³å°åªæœ‰16ä½movæŒ‡ä»¤ã€‚å†æˆ–è€…æ‰§è¡Œi++ï¼ˆiä¸ºintç±»å‹ï¼‰æ“ä½œï¼Œå®é™…ä¸Šæ˜¯åŒ…å«äº†read-modify-writeä¸‰ä¸ªæ“ä½œï¼Œè¿™å‡ ä¸ªæ“ä½œä¸­é—´ä¹Ÿå¯èƒ½æ’å…¥å…¶ä»–æŒ‡ä»¤æ‰§è¡Œã€‚å½“ç„¶ä¸€æ¡æœºå™¨æŒ‡ä»¤ä¹Ÿå¯èƒ½ä¸æ˜¯åŸå­çš„ï¼Œæ¯”å¦‚add src, dstï¼Œsrcå’Œdstéƒ½æ˜¯å†…å­˜åœ°å€ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°è¯»å–srcå’Œdstã€è®¡ç®—ã€å†™å›dstçš„å¤šä¸ªæ“ä½œâ€¦â€¦æ›´ä¸ç”¨è¯´ä¸€ä¸ªåŒ…å«äº†å¤šä¸ªå­—æ®µçš„structç»“æ„ä½“çš„èµ‹å€¼äº†ã€‚\nè¿™ç±»åŸå­æ€§é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä¸€äº›ç›¸å½“ä½çº§çš„åŸå­æ“ä½œæ¥ä¿è¯ï¼Œå¦‚intå˜é‡i++ï¼Œå¯ä»¥è€ƒè™‘lock addæŒ‡ä»¤ï¼ˆå‡å®šæ“ä½œæ•°ä½å®½å’Œintå˜é‡ç›¸åŒï¼‰ï¼Œç¨å¤æ‚çš„æ•°æ®ç»“æ„ï¼ˆå¦‚structï¼‰ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€äº›â€œé«˜çº§é”â€æ¥åšåŒæ­¥ä¿è¯ï¼Œå¦‚goä¸­çš„sync.Mutexã€‚\næŒ‡ä»¤é‡æ’ # æŒ‡ä»¤é‡æ’çš„æ ¹æºåœ¨äºCPUçš„è®¾è®¡ï¼Œå¤è€çš„CPUåªæœ‰ä¸€æ¡å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œã€è®¿å­˜ã€å†™å›çš„åŠŸèƒ½ç”µè·¯ã€‚è”æƒ³ä¸‹å‡å¦‚ä¸€ä¸ªå•çº¿ç¨‹ç¨‹åºæ‰§è¡Œé˜»å¡ç½‘ç»œIOçš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œæ•´ä¸ªç¨‹åºå…¨é˜»å¡åœ¨è¿™é‡Œå¹²ä¸äº†å…¶ä»–çš„ã€‚CPUä¹Ÿå­˜åœ¨ç±»ä¼¼é—®é¢˜ï¼Œå‡å¦‚ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­å› ä¸ºæ•°æ®æ²¡readyçš„é—®é¢˜ä¸èƒ½æ‰§è¡Œï¼Œæˆ–è€…ç¢°åˆ°å¤šCPUå¤šæ ¸é—´cacheä¸€è‡´æ€§åŒæ­¥ï¼Œé‚£CPUä¼šstallï¼Œåç»­çš„æŒ‡ä»¤éƒ½æ— æ³•æ‰§è¡Œã€‚\næ‰€ä»¥CPUä¸ºäº†æé«˜æŒ‡ä»¤ååï¼Œå¢åŠ äº†å¤šæ¡æµæ°´çº¿è®¾è®¡ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œå¤šæ¡æŒ‡ä»¤çš„å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œã€è®¿å­˜ã€å†™å›ï¼Œå½“ç„¶è¿™å…¶ä¸­æœ‰äº›æŒ‡ä»¤æ˜¯æœ‰æ•°æ®ä¾èµ–çš„ï¼Œç°ä»£å¤„ç†å™¨æ”¯æŒå¯„å­˜å™¨é‡å‘½åã€æŒ‡ä»¤ä¹±åºæ‰§è¡Œã€é‡æ’åºç¼“å†²ç­‰åŠŸèƒ½ï¼Œéƒ½æ˜¯ä¿è¯CPUæ‰§è¡Œæ•ˆç‡çš„å¸¸ç”¨æ‰‹æ®µã€‚å¦‚æœæƒ³äº†è§£è¿™æ–¹é¢çš„å†…å®¹ï¼Œsee Computer Architecture: Dynamic Execution CoreåŠç³»åˆ—è¯¾ç¨‹Computer Architectureã€‚è¿™é‡Œè´´ä¸€å¼ è¶…æ ‡é‡å¤„ç†å™¨çš„ç®€å›¾ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£è¿™äº›ä¼˜åŒ–æ‰‹æ®µæ‰€åœ¨çš„ä½ç½®ï¼š\n ä¸ºä»€ä¹ˆè¦æŒ‡ä»¤é‡æ’ï¼š\nä¸ºä»€ä¹ˆè¦æŒ‡ä»¤é‡æ’å‘¢ï¼Ÿ\nå› ä¸ºå¸Œæœ›æé«˜cpuæŒ‡ä»¤ååï¼Œå°±è¦å¹¶è¡Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œè¦å¹¶è¡Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œå°±è¦åˆ†æå‡ºå“ªäº›æŒ‡ä»¤ä¹‹é—´æœ‰æ•°æ®ä¾èµ–çš„ï¼Œè¡¨é¢ä¸Šä¸€ä¸ªæ¶æ„å¯„å­˜å™¨RAXå¯èƒ½è¢«ç›¸é‚»å¤šæ¡æŒ‡ä»¤ä½¿ç”¨ï¼Œä½†æ˜¯å¯èƒ½æ˜¯ä¸€ä¸ªä¼ªæ•°æ®ä¾èµ–ï¼Œå°±éœ€è¦é€šè¿‡åˆ†æã€å¯„å­˜å™¨é‡å‘½åï¼ˆå¦‚RAXé‡å‘½åä¸ºç‰©ç†å¯„å­˜å™¨R11ï¼‰æ¥æ¶ˆé™¤ä¼ªæ•°æ®ä¾èµ–ï¼Œä»è€Œå…è®¸å…¶åœ¨æ‰§è¡Œé˜¶æ®µå¹¶è¡Œæ‰§è¡Œï¼ˆout-of-orderï¼‰ã€‚\nä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¼šåˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œæœ‰äº›é˜¶æ®µæ˜¯æŒ‰åºæ‰§è¡Œçš„ï¼ˆin-orderï¼‰ï¼Œæœ‰äº›åˆ™æ˜¯ä¹±åºæ‰§è¡Œçš„ï¼ˆout-of-orderï¼‰ã€‚åœ¨æŒ‡ä»¤ä¹±åºæ‰§è¡Œä¹‹åï¼Œå¯èƒ½ä¼šå¯¹ç¨‹åºæ­£ç¡®æ€§é€ æˆå½±å“ï¼Ÿå½±å“ç©¶ç«Ÿæœ‰å¤šå¤§ï¼Œå°±éœ€è¦å‚è€ƒç¡¬ä»¶å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ï¼Œæ¯”å¦‚Intel x86å¤„ç†å™¨é‡‡ç”¨çš„æ˜¯TSOæ¨¡å‹ï¼ˆTotal Store Orderï¼‰, see x86-TSO: A Rigorous and Usable Programmer\u0026rsquo;s Model for x86 Multiprocessorsã€‚\næŒ‡ä»¤é‡æ’å¸¦æ¥çš„é—®é¢˜ï¼š\næŒ‡ä»¤åœ¨CPUä¹±åºæ‰§è¡Œï¼Œåœ¨æŸäº›å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸€äº›å¾®å¦™çš„é—®é¢˜ã€‚æ¯”å¦‚ï¼š\ntype num struct { a int b int } n := \u0026amp;num{} go func() { n.a = 1; n.b = 2; }() // g1 go func() { n.a = 2; n.b = 1; }() // g2  ä½ ä»¬è¯´æœ€ç»ˆn.aï¼Œn.bçš„ç»“æœæ˜¯å¤šå°‘å‘¢ï¼Ÿä¸ç¡®å®šçš„ï¼Œè™½ç„¶goç°åœ¨æ”¯æŒ64ä½ç³»ç»Ÿï¼Œç°åœ¨å¤„ç†å™¨åŸºæœ¬ä¹Ÿéƒ½æœ‰64ä½movæŒ‡ä»¤ï¼Œå¯¹aã€bå•ç‹¬èµ‹å€¼éƒ½æ˜¯åŸå­çš„ï¼Œä½†æ˜¯å¯¹næ•´ä½“çš„èµ‹å€¼ä¸æ˜¯ã€‚ç”±äºæ²¡æœ‰å¯¹nåšä¿æŠ¤ï¼Œg1ã€g2ä¸­çš„èµ‹å€¼æŒ‡ä»¤ä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ•°æ®ä¸€æ¥ï¼Œåˆ°æ—¶å€™ä¹±åºæ‰§è¡Œï¼Œg1 g2æ‰§è¡Œå®Œæˆåï¼Œ\u0026lt;n.a,n.b\u0026gt;çš„å¯èƒ½ç»“æœæ˜¯ï¼š\u0026lt;1, 2\u0026gt; \u0026lt;1, 1\u0026gt; \u0026lt;2,1\u0026gt; \u0026lt;2,2\u0026gt;ï¼Œè¿™å‡ ç§éƒ½æœ‰å¯èƒ½ï¼Œè€Œä¸åªæ˜¯æœ‰\u0026lt;1,2\u0026gt; \u0026lt;2,1\u0026gt;ä¸¤ç§å¯èƒ½ã€‚\nè¿™å°±æ˜¯æŒ‡ä»¤é‡æ’é€ æˆçš„å½±å“ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å‡ºç°äº†æŒ‡ä»¤é‡æ’çš„æƒ…å†µä¸‹ï¼Œå»åšä¸€äº›å…³é”®çš„åˆ¤æ–­é€»è¾‘ï¼Œå¯èƒ½å°±ä¼šå¸¦æ¥ä¸¥é‡çš„bugã€‚\nè¿™é‡Œé‡æ–°å›é¡¾äº†ä¸‹åŸå­æ€§ã€æŒ‡ä»¤é‡æ’çš„å«ä¹‰ï¼Œä»¥åŠå¯¹ç¨‹åºæ­£ç¡®æ€§å¯èƒ½å¸¦æ¥çš„å½±å“ï¼Œä¸‹é¢æˆ‘ä»¬å°†å°è¯•è¿›ä¸€æ­¥è€ƒè™‘å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜ã€‚\nå†…å­˜å±éšœï¼šé˜»æ­¢æŒ‡ä»¤é‡æ’ # é¦–å…ˆï¼Œæˆ‘ä»¬çœ‹å¦‚ä½•è§£å†³æŒ‡ä»¤é‡æ’åºé—®é¢˜ï¼Œè§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼ŒCPUæµæ°´çº¿ä¹±åºæ‰§è¡Œå¸¦æ¥çš„é—®é¢˜ï¼Œè¿˜éœ€è¦CPUè‡ªå·±æä¾›è§£å†³æ–¹æ¡ˆã€‚CPUå¦‚ä½•é˜»æ­¢æŒ‡ä»¤é‡æ’åºå‘¢ï¼Ÿ\nå†…å­˜å±éšœï¼Œå¯ä»¥ç”¨æ¥é˜»æ­¢å±éšœå‰åçš„æŒ‡ä»¤å…±åŒå‚ä¸é‡æ’åºï¼Œä¿è¯å±éšœåçš„æŒ‡ä»¤ä¸ä¼šå‡ºç°åœ¨å±éšœå‰æ‰§è¡Œï¼Œä¿è¯å±éšœå‰çš„æŒ‡ä»¤ä¸ä¼šåœ¨å±éšœåæ‰§è¡Œã€‚ç›¸å½“äºå±éšœä¹‹å‰å’Œä¹‹åç¡®ç«‹äº†happens-beforeå…³ç³»ï¼Œä¿è¯äº†å±éšœä¹‹å‰çš„æ“ä½œå¯¹å±éšœä¹‹åçš„æ“ä½œéƒ½æ˜¯å¯è§çš„ã€‚\nCPUä¸­é€šå¸¸æä¾›äº†å¦‚ä¸‹å‡ æ¡æŒ‡ä»¤ï¼Œç”¨ä»¥å»ºç«‹å†…å­˜å±éšœï¼š\n lockï¼šæŒ‡ä»¤å‰ç¼€ï¼Œä¿®é¥°æŒ‡ä»¤ä¿è¯æŒ‡ä»¤æ‰§è¡Œæ—¶çš„æ’ä»–æ€§ã€åŸå­æ€§å’Œå®Œå…¨å†…å­˜å±éšœ lock cmpxchgï¼šcmpxchgæ¯”è¾ƒå¹¶äº¤æ¢ï¼Œé…åˆlockå‰ç¼€å®ç°CAS mfenceï¼šå®Œå…¨å†…å­˜å±éšœï¼ˆload+storeï¼‰ lfenceï¼šè¯»å†…å­˜å±éšœï¼ˆloadï¼‰ sfenceï¼šå†™å†…å­˜å±éšœï¼ˆstoreï¼‰  ä¸€äº›åº“å‡½æ•°æˆ–è€…ç¼–ç¨‹è¯­è¨€æä¾›çš„æ ‡å‡†åº“ï¼Œå¯ä»¥é€‰æ‹©ä¸Šè¿°æŸæ±‡ç¼–æŒ‡ä»¤æ¥å®ç°å†…å­˜å±éšœï¼Œæˆ–è€…å®ç°CASï¼ˆåŸºæœ¬æ˜¯åŒ…è£…ä¸‹lock cmpxchgï¼‰ï¼Œå¹¶è¿›ä¸€æ­¥å®ç°å„ç§é«˜çº§é”ï¼Œå¦‚spinlockã€sync.Mutexã€‚\nåœ¨ç»§ç»­ä»‹ç»å†…å­˜å±éšœçš„å†…å®¹ä¹‹å‰ï¼Œå…ˆè¯´æ˜ä¸‹lock prefixçš„å·¥ä½œåŸç†ã€‚lock prefixçš„ä½¿ç”¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯åœ¨ä¸€äº›æ¶‰åŠè®¿å­˜çš„æŒ‡ä»¤æ—¶ï¼Œç¼–ç æ—¶åœ¨æŒ‡ä»¤å‰é¢æ·»åŠ ä¸€ä¸ªå‰ç¼€lockã€‚\nè¿™ä¸ªå‰ç¼€æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¤„ç†å™¨ç¢°åˆ°lockå‰ç¼€çš„æŒ‡ä»¤æ—¶ä¼šç”Ÿæˆä¸€ä¸ªlockä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·ä¼šå‘é€åˆ°æ€»çº¿ä¸Šå¯¹è¦è®¿é—®çš„æ“ä½œæ•°åœ°å€è¿›è¡Œé”å®šï¼Œæ„æ€å°±æ˜¯åœ¨å½“å‰è¿™æ¡æŒ‡ä»¤ç»“æŸä¹‹å‰ï¼Œå…¶æ“ä½œæ•°æ‰€åœ¨çš„å†…å­˜åŒºåŸŸä¸å…è®¸è¢«å…¶ä»–æŒ‡ä»¤è®¿é—®ã€‚\né€šè¿‡è¿™ç§æ–¹å¼ä¿è¯äº†å½“å‰è¿™æ¡æŒ‡ä»¤æ“ä½œçš„åŸå­æ€§ã€‚\nå†…å­˜å±éšœï¼šåˆ°åº•æ˜¯ä»€ä¹ˆ # å†™å¹¶å‘ç¨‹åºï¼ŒHappens-Beforeå…³ç³»ç»å¸¸æŒ‚å˜´è¾¹ï¼ŒHappens-Beforeå…³ç³»æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªç¼–ç¨‹è¯­è¨€çš„å†…å­˜æ¨¡å‹æ˜ç¡®å®šä¹‰çš„ï¼ŒåƒJavaã€Goéƒ½æœ‰å¯¹å†…å­˜æ¨¡å‹çš„æ¸…æ™°å®šä¹‰ï¼Œä½†æ˜¯æœ‰çš„è¯­è¨€æ²¡æœ‰ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼šgoä¸­åŒ…çº§åˆ«å˜é‡çš„åˆå§‹åŒ–æ“ä½œä¸åŒ…å†…func init()ä¹‹é—´å­˜åœ¨Happens-Beforeå…³ç³»ï¼Œä¸€ä¸ªé”çš„Unlockå’Œä¸‹æ¬¡çš„Lockä¹‹é—´ä¹Ÿå­˜åœ¨HBå…³ç³»ï¼Œchançš„sendã€recvä¹‹é—´ä¹Ÿå­˜åœ¨HBå…³ç³»â€¦â€¦\næˆ‘ä»¬æƒ³è¦ç†è§£çš„æ˜¯Happens-Beforeå®šä¹‰å¥½ä¹‹åï¼Œæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå½“ç„¶æ˜¯å€ŸåŠ©å†…å­˜å±éšœäº†ã€‚é‚£å†…å­˜å±éšœæ€ä¹ˆå®ç°çš„ï¼Œé€šè¿‡å¤„ç†å™¨æä¾›çš„ä¸Šè¿°å‡ æ¡æŒ‡ä»¤ã€‚é‚£æˆ‘æƒ³å†é—®ä¸‹è¿™å‡ æ¡æŒ‡ä»¤å¹²äº†å•¥ï¼Œä¸ºä»€ä¹ˆè¿™å‡ æ¡æŒ‡ä»¤å°±å¯ä»¥å®ç°å†…å­˜å±éšœã€‚\nè®¡ç®—æœºä¸­åŒ…å«äº†å¤ªå¤šåˆ†å±‚çš„è®¾è®¡æ€æƒ³ï¼Œç¡¬ä»¶å¯¹å¤§å¤šæ•°è½¯ä»¶å¼€å‘äººå‘˜æ¥è¯´æ˜¯ä¸ªé»‘ç›’ï¼Œä¼¼ä¹ç®¡å¥½åˆ†å†…çš„äº‹ï¼Œæ°¸è¿œå°†å®ƒå½“åšä¸€ä¸ªé»‘ç›’å°±å¥½äº†ã€‚\nWellï¼Œå¤„ç†å™¨åˆ°åº•æ€ä¹ˆå®ç°å†…å­˜å±éšœçš„è¿˜æ˜¯æ¯”è¾ƒå¸å¼•æˆ‘ï¼Œä¸Šé¢çš„æ‰€æœ‰å›ç­”ï¼Œå¯¹æˆ‘æ²¡æœ‰ä»€ä¹ˆå®è´¨çš„å¸®åŠ©ï¼Œé‚£å°±æ¥çœ‹çœ‹ç¡¬ä»¶å±‚é¢æ˜¯æ€ä¹ˆå®ç°çš„ã€‚å¦‚æœä¸äº†è§£ç¡¬ä»¶è®¾è®¡ã€å·¥ä½œåŸç†ï¼Œåªç«™åœ¨è½¯ä»¶è§’åº¦ï¼Œæ˜¯å¾ˆéš¾ææ˜ç™½çš„ï¼Œè¿™ä¸ªæ˜¯å¾ˆç°å®çš„é—®é¢˜ï¼Œå°½ç®¡äº†è§£äº†ä¹‹åä¼šå‘ç°å¾ˆç®€å•ï¼Œä½†æ˜¯é’»åˆ°è¿™é‡Œä¹Ÿç¡®å®éœ€è¦æ—¶é—´ã€‚\nå†…å­˜å±éšœç±»å‹ #  å…¨å†…å­˜å±éšœï¼ˆmfenceï¼‰ï¼šbarrierä¹‹å‰çš„load/storeæ“ä½œå‡æ¯”ä¹‹åçš„å…ˆå®Œæˆï¼Œä¸”å‰åçš„æŒ‡ä»¤ä¸èƒ½å…±åŒå‚ä¸æŒ‡ä»¤é‡æ’åºï¼› è¯»å±éšœï¼ˆlfenceï¼‰ï¼šbarrierä¹‹å‰çš„loadæ¯”ä¹‹åçš„loadå…ˆå®Œæˆï¼› å†™å±éšœï¼ˆsfenceï¼‰ï¼šbarrierä¹‹å‰çš„storeæ¯”ä¹‹åçš„storeå…ˆå®Œæˆï¼›  ä¸åŒçš„å¤„ç†å™¨ï¼Œå‡æä¾›äº†è‡ªå·±çš„å±éšœæŒ‡ä»¤ï¼Œä½†æ˜¯è¿™äº›æŒ‡ä»¤ä¸ç®¡æœ‰ä»€ä¹ˆå¼‚åŒï¼Œæœ€ç»ˆéƒ½ä¸ç¡¬ä»¶è®¾è®¡ç›¸å…³ï¼Œæ‰€ä»¥æ¥çœ‹ä¸‹ç°ä»£å¤„ç†å™¨çš„ä¸€ä¸ªå¤§è‡´è®¾è®¡ã€‚\nå¤„ç†å™¨æ¶æ„ # ä¸‹é¢æ˜¯ä¸€ä¸ªç”¨æ¥è§£é‡Šå†…å­˜å±éšœçš„ç²¾ç®€çš„å¤„ç†å™¨æ¶æ„ç¤ºæ„å›¾ï¼Œå¤§çº¦åŒ…å«å¦‚ä¸‹å‡ éƒ¨åˆ†ã€‚\n  å¤šä¸ªCPUæˆ–CPU Coreä¹‹é—´é€šè¿‡æ€»çº¿è¿æ¥ï¼› CPUé€šè¿‡æ€»çº¿ä¸ä¸»å­˜ï¼ˆmemoryï¼‰è¿æ¥ï¼› æ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„æœ¬åœ°cacheï¼Œé€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼ˆå¦‚MESI/MESIFï¼‰ä¸å…¶ä»–CPU Coreç»´æŠ¤ä¸€ä¸ªä¸€è‡´çš„æ•°æ®è§†å›¾ï¼›  è¯´èµ·è¿™é‡Œçš„ä¸€è‡´æ€§è§†å›¾ï¼Œæˆ‘å»ºè®®è¯»è€…å°è¯•äº†è§£ä¸‹ï¼Œä¼šæ›´å¥½ï¼š\n ç¡¬ä»¶å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹  ä¸‹é¢ç»“åˆä¸Šå›¾ï¼Œæˆ‘ä»¬ä»‹ç»ä¸‹ä¸€æ­¤æ•°æ®æ›´æ–°æ“ä½œæ¶‰åŠçš„è¿‡ç¨‹ã€‚\nå¼•å…¥store buffer # CPUå¯¹cachelineçš„ä¿®æ”¹ï¼Œè‹¥ç›´æ¥è½cacheï¼Œä¸€è‡´æ€§åè®®ä¼šå¼•å…¥ä¸å°çš„å¼€é”€ï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼ŒCPUä¼šstallæ‰§è¡Œçš„æŒ‡ä»¤ã€‚ä¸ºäº†æé«˜æŒ‡ä»¤ååï¼Œè¿™é‡Œå¼•å…¥äº†store bufferã€‚\næ•°æ®æ›´æ–°ä¸ç›´æ¥å†™cachelineè€Œæ˜¯å…ˆå†™åˆ°store bufferï¼Œåé¢éœ€è¦æ—¶å†è½cacheå¹¶é€šçŸ¥å…¶ä»–cacheå¤±æ•ˆï¼ˆæ‰§è¡Œcacheä¸€è‡´æ€§åè®®ï¼‰ï¼Œè¿™æ ·CPUå°±å¯ä»¥å‡å°‘stallç»§ç»­æ‰§è¡ŒæŒ‡ä»¤ã€‚\n å¼•å…¥invalidate queue # CPU cacheæ›´æ–°cachelineåï¼Œé€šçŸ¥å…¶ä»–CPUæ›´æ–°cacheï¼Œéœ€é€šè¿‡cacheä¸€è‡´æ€§åè®®ï¼Œå¦‚MESI/MESIFæ¶ˆæ¯invalidateã€‚\næ­£å¸¸æ¥è¯´ï¼Œæ”¶åˆ°æ­¤é€šçŸ¥çš„CPUåº”ä»cacheä¸­å°†å¯¹åº”cachelineæ ‡è®°ä¸ºæ— æ•ˆï¼Œä½†æ˜¯å¦‚æœç«‹å³æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œçš„è¯ï¼ŒCPUä¼šé¢‘ç¹è¢«é˜»æ–­æ‰§è¡Œï¼Œæ‰€ä»¥CPUä¸­å¼•å…¥äº†invalidate queueï¼Œæ”¶åˆ°invalidateé€šçŸ¥åç¼“å­˜èµ·æ¥å¹¶ç«‹å³å›å¤ACKï¼Œä½†å»¶è¿Ÿå¤„ç†ã€‚\nå¿…è¦æ€§åŠå¼•å…¥çš„é—®é¢˜ # è¿™ä¹ˆè®¾è®¡çš„å¿…è¦æ€§ï¼š\n å‡å°‘CPUæ›´æ–°æœ¬åœ°cachelineã€å“åº”ä¸€è‡´æ€§åè®®invalidateé€šçŸ¥å¯¼è‡´çš„CPU stallé—®é¢˜ï¼Œæé«˜CPUæ•´ä½“åˆ©ç”¨ç‡ã€‚ å¦å¤–storebufferã€invalidate queueä½¿æˆ‘ä»¬æœ‰äº†æŒ‡ä»¤é‡æ’çš„å¥‘æœºã€‚  è¿™ä¹ˆè®¾è®¡å¼•å…¥çš„é—®é¢˜ï¼š\n store bufferï¼šæœ¬åœ°cacheæ›´æ–°ä¸èƒ½ç«‹å³è¢«å…¶ä»–CPUæˆ–è€…CPU coreè§‚æµ‹åˆ°äº†ï¼Œå†™æ“ä½œå¯¹å¤–ä¸å¯è§ï¼› invalidate queueï¼šæœ¬åœ°cacheæ²¡æœ‰ç«‹å³æ›´æ–°æ•°æ®ï¼Œä¸Šå±‚åº”ç”¨çœ‹ä¸åˆ°å…¶ä»–CPUæ›´æ–°çš„æ•°æ®ï¼› cacheä¸€è‡´æ€§åè®®ï¼šå®ƒå°±æ˜¯ç”¨æ¥è§£å†³å¤šä¸ªCPUå…±äº«ä¸€è‡´æ€§è§†å›¾è€Œè®¾è®¡çš„ï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªåè®®ï¼Œå…·ä½“ä¸åŒç¡¬ä»¶è®¾è®¡çš„æ—¶å€™ï¼ŒæŸäº›å±éšœæŒ‡ä»¤å®ç°çš„æ—¶å€™è¦é€šè¿‡è¿™é‡Œçš„cacheä¸€è‡´æ€§åè®®æ¥ä¿è¯å¤šCPUã€å¤šæ ¸æ•°æ®è§†å›¾çš„ä¸€è‡´æ€§ï¼ˆå¯ä»¥å‚è€ƒç¡¬ä»¶å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ã€cacheä¸€è‡´æ€§åè®®ç›¸å…³çš„çŸ¥è¯†ï¼ŒåŠ æ·±ç†è§£ï¼‰ï¼›  å¤„ç†å™¨æ‰§è¡Œæ“ä½œå˜åŒ– # å¦‚æœæ²¡æœ‰store bufferã€invalidate queueï¼ŒMESIå’Œcacheå¦‚ä½•å·¥ä½œï¼Ÿ\n å½“åŒ…å«å˜é‡açš„cachelineï¼Œå…¶è¢«CPU 0å’ŒCPU 1å…±äº«ï¼Œå½“CPU 0æ›´æ–°è¯¥cachelineä¹‹åï¼Œä¼šå‘é€invalidateç»™CPU 1ï¼ŒCPU 1éšå³æŠŠå¯¹åº”çš„cachelineæ ‡è®°ä¸ºinvalidateï¼› å½“CPU 1ä¸‹æ¬¡è¯»å–å˜é‡açš„cachelineæ—¶ï¼Œå‘ç°æ ‡è®°ä¸ºäº†æ— æ•ˆï¼Œæ­¤æ—¶å‘å‡ºreadè¯·æ±‚ï¼ŒCPU 0è§‚æµ‹åˆ°è‡ªå·±è¿™è¾¹å¯¹åº”çš„cachelineæ˜¯modifiedçŠ¶æ€ï¼Œcachelineæ˜¯æœ€æ–°çš„ï¼Œæ­¤æ—¶ä¼šå°†å¯¹åº”cachelineæ•°æ®å‘é€ç»™CPU 1ï¼Œè¿™æ ·CPU 1å°±è§‚æµ‹åˆ°äº†æœ€æ–°çš„æ•°æ®ï¼› CPU 0ä¸­cachelineä½•æ—¶å†™å›ä¸»å­˜ï¼Ÿå¯èƒ½æ˜¯è¢«æ·˜æ±°çš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ«äººreadçš„æ—¶å€™ï¼Œè¿™ä¸ªæˆ‘ä»¬å…ˆä¸å…³å¿ƒã€‚  å¦‚æœå¼•å…¥äº†store bufferã€invalidate queueä¹‹åï¼Œåˆè¯¥å¦‚ä½•å·¥ä½œå‘¢ï¼Ÿ\n å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†è¯¥store bufferä¸­çš„æ›´æ–°ï¼Œé€šçŸ¥åˆ°å…¶ä»–CPUï¼Œè¿™å°±æ˜¯write barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 0æ‰§è¡Œï¼Œå¹¶å°†CPU 0æŠŠstore bufferä¸­è®°å½•çš„ä¸€äº›æ›´æ–°åº”ç”¨åˆ°cacheä¸­ï¼Œæ­¤æ—¶ä¼šè§¦å‘cacheä¸€è‡´æ€§åè®®MESIé€šçŸ¥CPU 1 cacheline invalidateï¼› å¿…é¡»è¦æœ‰åŠæ³•ï¼Œå°†CPU 1ä¸­invalidate queueè®°å½•ä¸‹æ¥çš„invalidateå¯¹åº”çš„cachelineåŠæ—¶æ¸…ç†æ‰ï¼Œè¿™å°±æ˜¯read barrierå¹²çš„äº‹æƒ…ã€‚å®ƒå°±æ˜¯æš‚åœCPU 1æ‰§è¡Œï¼Œå°†å…¶invalidate queueä¸­çš„æ¯ä¸ªinvalidateè¯·æ±‚å¯¹åº”çš„cachelineå…¨éƒ¨æ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸‹æ¬¡è¯»å–æ—¶ä»å†…å­˜æˆ–è€…CPU 0è¯»å–æœ€æ–°æ•°æ®ï¼›  å¤„ç†å™¨å±éšœæŒ‡ä»¤ # æ€»ç»“ä¸€ä¸‹ï¼š\n è¿™é‡Œçš„è¯»å†™å±éšœè¦ä¾èµ–å¤„ç†å™¨æä¾›çš„å±éšœæŒ‡ä»¤ åœ¨å±éšœæŒ‡ä»¤ä¹‹ä¸Šï¼Œå†…æ ¸å¯ä»¥æŒ‰éœ€é€‰æ‹©ï¼Œå¦‚Linuxåœ¨x86å¹³å°é€‰æ‹©ç”¨ lock; addlæ¥å®ç°è¯»å†™å±éšœ smp_mb/smp_rmb/smp_wmbï¼Œx86å…¶å®ä¹Ÿæä¾›äº†mfenceã€lfenceã€sfenceã€‚è‡³äºLinuxä¸ºä»€ä¹ˆè¿™ä¹ˆé€‰æ‹©ï¼Œåº”è¯¥æ˜¯è·Ÿx86å®ç°æœ‰å…³ç³»ï¼Œä¸€æ¡æŒ‡ä»¤lock;addlåŒæ—¶å®ç°å…¨å±éšœ/è¯»å±éšœ/å†™å±éšœè¶³çŸ£ã€‚ å…¶ä»–ç¼–ç¨‹è¯­è¨€å†…å­˜æ¨¡å‹ï¼Œé€šå¸¸ä¼šå®šä¹‰ä¸€äº›Happens-Beforeå…³ç³»ï¼Œè¿™é‡Œé¢å°±éšå«äº†å„ç§å±éšœçš„åº”ç”¨ã€‚åŸºäºå±éšœå®ç°çš„å„ç§åŒæ­¥åŸè¯­å¦‚mutexã€semaphoreç­‰å°±æ¯”è¾ƒå¸¸è§äº†ã€‚  gcå±éšœ isn\u0026rsquo;t å†…å­˜å±éšœ # psï¼šæœ‰äº›äººè¿˜æŠŠGC Barrierå’ŒMemory Barrierææ··äº†ï¼Œç¢°åˆ°ä¸æ­¢ä¸€ä¸ªåŒå­¦äº†ï¼š\n GC Barrierï¼Œæ˜¯ç¼–è¯‘å™¨æ’å…¥çš„ä¸€äº›ä»£ç ç‰‡æ®µï¼Œç”¨æ¥è·Ÿè¸ªmutatorå¯¹heapåšçš„ä¿®æ”¹ï¼› Memory Barrierï¼Œåˆ™å°±æ˜¯æœ¬æ–‡è®¨è®ºæ¶‰åŠçš„å†…å®¹ï¼Œæ˜¯å¤„ç†å™¨æä¾›çš„ä¸€ç§ä½çº§çš„å¹¶å‘åŒæ­¥æ“ä½œï¼›  Lock prefix VS Locks # CASï¼Œä¸€èˆ¬éƒ½æ˜¯åŸºäºå¤„ç†å™¨æŒ‡ä»¤ lock cmpxchgæ¥å®ç°çš„ï¼Œè¿™é‡Œä¸€å®šè¦ææ˜ç™½ï¼Œè¿™é‡Œè™½ç„¶æŒ‡ä»¤ä¿®é¥°å‰ç¼€çš„å­—é¢å«ä¹‰ä¹Ÿæ˜¯lockï¼Œç¿»è¯‘è¿‡æ¥ä¹Ÿæ˜¯é”ï¼Œä½†è¿™å¹¶éæˆ‘ä»¬é€šä¿—æ„ä¹‰ä¸Šçš„é”ã€‚\næˆ‘ä»¬å¹³æ—¶è¯´çš„è½»é‡çº§é”ã€é‡é‡çº§é”ï¼Œæ¯”å¦‚spinlockã€futexç­‰ï¼Œæˆ–è€…sync.Mutex, sync.RWMutexï¼Œè¿™äº›é”éƒ½æ˜¯â€œé«˜çº§é”â€ï¼Œè€Œå¤„ç†å™¨æŒ‡ä»¤çš„lock prefixåªæ˜¯å¯¹å•æ¡æŒ‡ä»¤æ‰§è¡Œçš„æ’ä»–æ€§è¿›è¡Œæ§åˆ¶ã€‚\nåè€…ä¸ºå‰è€…å®ç°æä¾›äº†åŸºç¡€æ”¯æŒï¼Œä½†æ˜¯ä¸æ˜¯ä¸€å›äº‹ã€‚æ¯”å¦‚ï¼Œlock+cmpxchgåŸºç¡€ä¸Šå¯ä»¥åŒ…è£…å¸¸ç”¨çš„casæ“ä½œï¼Œå¦‚golangä¸­çš„atomic.CompareAndSwap(\u0026hellip;)ï¼Œæˆ–è€…å¯ä»¥åŒ…è£…è§£å†³ABAé—®é¢˜çš„CASæ“ä½œã€‚\næ¥çœ‹ä¸€ä¸‹golangä¸­CASæ“ä½œå®ç°ï¼š\n# filename: atomic_amd64.go //go:noescape func Cas64(ptr *uint64, old, new uint64) bool # filename: atomic/doc.go func CompareAndSwapInt64(ptr *uint64, old, new uint64) bool # filename: atomic_amd64.s // bool	Â·Cas64(uint64 *val, uint64 old, uint64 new) // Atomically: //	if(*val == *old){ //	*val = new; //	return 1; //	} else { //	return 0; //	} TEXT Â·Cas64(SB), NOSPLIT, $0-25 MOVQ	ptr+0(FP), BX MOVQ	old+8(FP), AX MOVQ	new+16(FP), CX LOCK # LOCK CMPXCHGQ, æ’ä»–æ€§æ¯”è¾ƒå¹¶äº¤æ¢ CMPXCHGQ	CX, 0(BX) SETEQ	ret+24(FP) RET TEXT Â·CompareAndSwapInt64(SB),NOSPLIT,$0 JMP	runtimeâˆ•internalâˆ•atomicÂ·Cas64(SB) # è°ƒç”¨çš„æ˜¯ä¸Šé¢çš„Cas64  å¯ä»¥çœ‹åˆ°ï¼Œå®ƒå°±æ˜¯ç”¨lock cmpxchgæ¥å®ç°çš„ï¼Œå¸¸ç”¨çš„atomic.CompareAndSwapä¹Ÿå·®ä¸å¤šäº†å¤šå°‘ï¼Œè¿˜æ˜¯è°ƒç”¨çš„Cas64ã€‚\nç„¶åæˆ‘ä»¬å†æ¥çœ‹å‡ ä¸ªatomicåŒ…ä¸‹çš„æ“ä½œï¼Œæ¥å¼ºåŒ–ä¸‹å¯¹lockæŒ‡ä»¤å‰ç¼€çš„ç†è§£ï¼Œè¿™é‡Œç›´æ¥å¯¹ADDQæ“ä½œè¿›è¡Œäº†lockå®ç°äº†åŸå­çš„åŠ æ“ä½œã€‚\nTEXT Â·AddInt64(SB),NOSPLIT,$0 JMP	runtimeâˆ•internalâˆ•atomicÂ·Xadd64(SB) // uint64 Xadd64(uint64 volatile *val, int64 delta) // Atomically: //	*val += delta; //	return *val; TEXT Â·Xadd64(SB), NOSPLIT, $0-24 MOVQ	ptr+0(FP), BX MOVQ	delta+8(FP), AX MOVQ	AX, CX LOCK # LOCK XADDQï¼Œæ’ä»–æ€§çš„addæ“ä½œ XADDQ	AX, 0(BX) ADDQ	CX, AX MOVQ	AX, ret+16(FP) RET  é€šå¸¸æˆ‘ä»¬è‡ªå·±è¦åº”ç”¨casçš„è¯ï¼Œæ¯”å¦‚å®ç°ä¸€ä¸ªmetrics gaugeï¼Œå¯èƒ½ä¼šè¿™ä¹ˆå†™ï¼š\n// Gauge æ—¶åˆ»é‡ type Gauge struct { v uint64 } // IncrBy æ—¶åˆ»é‡+v func (g *gauge) IncrBy(v float64) { for { oldBits := atomic.LoadUint64(\u0026amp;g.valBits) fv := math.Float64frombits(oldBits) + v newBits := math.Float64bits(fv) if atomic.CompareAndSwapUint64(\u0026amp;g.valBits, oldBits, newBits) { atomic.StoreUint32(\u0026amp;g.dirty, 1) return } } } ...  å…ˆè¯»å–åŸå§‹å€¼ï¼Œè®¡ç®—ï¼Œç„¶åå‡†å¤‡å†™å›ï¼Œå†™å›çš„æ—¶å€™ç”¨äº†CASï¼Œä¸€æ¬¡CASæ“ä½œä¸ä¸€å®šæˆåŠŸï¼Œå› ä¸ºå¯èƒ½å…¶ä»–åç¨‹ä¹Ÿåœ¨å°è¯•æ›´æ–°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè¦ç»“åˆä¸€ä¸ªå¾ªç¯ï¼ˆè‡ªæ—‹ï¼Œspinï¼‰æ¥ä¿è¯é‡è¯•æˆåŠŸã€‚åŸºäºCASçš„ç©æ³•ä¸€èˆ¬éƒ½æ˜¯è¿™ä¹ˆå®ç°çš„ã€‚\nLocks VS Lock-free # è¿™é‡Œè¯»è€…ä¹Ÿåº”è¯¥æ„è¯†åˆ°äº†ï¼Œå‰é¢CASä¹Ÿæ˜¯åŸºäºåº•å±‚å¤„ç†å™¨çš„lock cmpxchgå®ç°çš„ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯è¯´CASæ“ä½œå°±æ²¡æœ‰ä»»ä½•çš„åŒæ­¥æªæ–½ã€‚\næœ‰äº›lockfreeçš„æ•°æ®ç»“æ„+ç®—æ³•ï¼Œä¹Ÿæ˜¯åŸºäºCASå®ç°çš„ï¼Œä¹Ÿå¹¶ä¸æ˜¯å°±çœŸçš„æ²¡æœ‰ä»»ä½•åŒæ­¥æªæ–½ã€‚åªæ˜¯æ²¡æœ‰ç”¨é‚£äº›é€šä¿—æ„ä¹‰ä¸Šçš„â€œé”â€ï¼ˆå¦‚æ²¡æœ‰ç”¨å¯èƒ½å¯¼è‡´çº¿ç¨‹é˜»å¡çš„äº’æ–¥é‡ã€ä¿¡å·é‡ï¼‰ã€‚\nå¤šçº¿ç¨‹ç¼–ç¨‹æ—¶ï¼Œå¯¹lockså’Œlock-freeå¯¹æ¯”ï¼Œä¸€ç§æ¯”è¾ƒå¥½ç†è§£çš„è¯´æ³•æ˜¯ï¼š\n locksï¼Œcontention managed by 3rd party (OS Kernel) lock-free, contention managed by the users (threads)  CASå’Œé€šä¿—æ„ä¹‰çš„é”ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œå®ƒçš„ä¸´ç•ŒåŒºéå¸¸å°ï¼ˆå•æ¡æŒ‡ä»¤ï¼‰ï¼Œä¸”ä¸å­˜åœ¨â€œé”â€é‚£æ ·å¯¼è‡´è¿›ç¨‹ã€çº¿ç¨‹ã€åç¨‹çš„æŒ‚èµ·ã€æ¢å¤æ“ä½œï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡åˆ‡æ¢æ‰€å¼•å…¥çš„å¼€é”€ã€è°ƒåº¦å»¶è¿Ÿï¼Œæ‰€ä»¥å¼€é”€æ›´å°ä¸€ç‚¹ã€‚\nèƒ½ç”¨CASä»£æ›¿mutexä¹‹ç±»é”çš„åœ°æ–¹ï¼Œè¿˜æ˜¯ç”¨CASï¼Œå› ä¸ºmutexä¹‹ç±»çš„ä¼šæŠŠè¿›ç¨‹çº¿ç¨‹ç»™æŒ‚èµ·ï¼Œå³ä¾¿æ˜¯sync.MutexåªæŒ‚èµ·åç¨‹ï¼Œä½†æ˜¯æ¶‰åŠåˆ°go runtime schedulerçš„ä»‹å…¥ï¼Œå¼€é”€ä¹Ÿæ˜¯æ¯”å•çº¯çš„CASè¦å¤§å¾ˆå¤šçš„ã€‚åœ¨é”ç«äº‰æ¯”è¾ƒä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œsync.Mutexä¹Ÿä¼šç»å†ä¸€ä¸ªé”è†¨èƒ€çš„è¿‡ç¨‹ï¼ŒCAS-\u0026gt;Spin-\u0026gt;Semaphore-\u0026gt;futex (spin+block threads)ã€‚\nä¸Šé¢æäº†åŸºäºCASå®ç°ä¸€äº›lock-freeç®—æ³•ï¼Œå…¶å®lock-freeç®—æ³•çš„æ€è·¯æœ‰å¾ˆå¤šï¼š\n State Machines CAS operations - However contention lurks here! @Contended Annotation - JEP 142 Wait-Free in addition to Lock-Free Algorithms Thread Affinity x86 and busy spinning and back-off TSX (Transactional Synchronization Extensions)  see https://youtu.be/_uUkApe_yIk?t=2451\nå®ç°ä¸€ä¸ªé” # ç†è§£äº†CPU lock+cmpxchgçš„ä½œç”¨ä»¥åŠåº”ç”¨ä¹‹åï¼Œå°±å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šå®ç°ä¸€ä¸ªç®€å•çš„é”ã€‚\nè‡ªæ—‹ï¼šspinlock # type SpinLock struct{ v int64 } func (s *SpinLock) Lock() bool { for { if atomic.CompareAndSwap(\u0026amp;s.v, 0, 1) { return true } } } func (s *SpinLock) UnLock() { atomic.StoreInt64(\u0026amp;s.v, 0) }  ç°åœ¨å°±å¯ä»¥æ‹¿è¿™ä¸ªé”å»å½“åšä¸€ä¸ªç®€å•çš„é”å»ç”¨äº†ï¼Œä½†æ˜¯ï¼Œè¿™ç§å¿™è½®è¯¢çš„æ–¹å¼å¯¹CPUæ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸¥é‡çš„æµªè´¹ï¼Œå¯ä»¥è€ƒè™‘ä¸€ä¸‹å¦‚æœé•¿æ—¶é—´æŒæœ‰ä¸äº†é”ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥è®©å‡ºCPUç»™å…¶ä»–åç¨‹æ‰§è¡Œå‘¢ï¼Ÿå¯ä»¥ï¼Œä¸ºäº†åˆ©ç”¨å¥½CPUå¹²æœ‰ä»·å€¼çš„äº‹æƒ…ï¼Œå°±åº”è¯¥è®©å‡ºå»ã€‚\nCAS ABAé—®é¢˜ # åœ¨è¿™é‡Œæä¸€å˜´å§ï¼Œåœ¨ä½¿ç”¨CASçš„æ—¶å€™ï¼Œåº”è¯¥å…³æ³¨ABAé—®é¢˜ã€‚ä»€ä¹ˆæ˜¯ABAé—®é¢˜ã€‚å‡å®šæœ‰ä¸ªvolatileå˜é‡vï¼ˆåˆå§‹å€¼5ï¼‰ï¼Œç°åœ¨æˆ‘ä»¬å¹¶å‘åœ°å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œå‡å¦‚å‡ºç°äº†è¿™æ ·å¯¹vçš„ä¸€ä¸ªæ“ä½œåºåˆ—ï¼š-1 +1ï¼Œç°åœ¨vçš„å€¼è¿˜æ˜¯5ã€‚\n æœ‰äº›åœºæ™¯ä¸èƒ½æ¥å—ABAé—®é¢˜  æœ‰äº›åœºæ™¯æ˜¯ä¸èƒ½æ¥å—ABAé—®é¢˜çš„ï¼Œæ¯”å¦‚ä½ è¦é€šè¿‡è¿™ä¸ªå€¼çš„å˜åŒ–æ¥åˆ¤æ–­æ˜¯å¦æœ‰å‘ç”Ÿè¿‡ä»€ä¹ˆ+1 -1çš„æ“ä½œï¼Œå› ä¸ºè¿™é‡Œçš„å€¼vçš„å˜åŒ–æ˜¯éå•è°ƒçš„ï¼Œæœ‰å¢æœ‰å‡ï¼Œè¿™æ ·è‚¯å®šåŒºåˆ†ä¸äº†æ˜¯å¦å‘ç”Ÿè¿‡ä»€ä¹ˆï¼Œå°±å¾—æƒ³å…¶ä»–åŠæ³•ã€‚\næ¯”å¦‚ä½ çš„å€¼vç”¨32ä½è¶³å¤Ÿï¼Œé‚£ä½ å¯ä»¥è€ƒè™‘ç”¨ä¸ª64ä½çš„int64ï¼Œå…¶ä¸­å¤šå‡ºæ¥çš„32ä½ç”¨æ¥è®°å½•æ•°æ®ç‰ˆæœ¬ï¼Œç„¶åç”¨Cas64æ“ä½œæ¥ä»£æ›¿ä¹‹å‰çš„Cas32æ“ä½œã€‚\n æœ‰äº›åœºæ™¯å¯ä»¥æ¥å—ABAé—®é¢˜  ä½ æ¯”å¦‚å‰é¢æŠ¢åˆ°çš„é‚£ä¸ªè‡ªæ—‹é”å®ç°ï¼ŒSpinLock.vçš„å€¼ä¸€ç›´åœ¨0 1 0 1çš„å˜åŒ–ï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œæˆ‘ä»¬ä»…ç”¨å®ƒæ¥åšä¸€ä¸ªå½“å‰çŠ¶æ€çš„åˆ¤æ–­ï¼Œè€Œä¸æ˜¯ç”¨å®ƒçš„å½“å‰å€¼æ¥åˆ¤æ–­ä»¥å‰çš„æ“ä½œå†å²ï¼Œå¦‚ç°åœ¨ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰äººæŒæœ‰é”ï¼Œä½†æˆ‘ä»¬å¹¶ä¸ä¼šå»å…³å¿ƒä»¥å‰æœ‰æ²¡æœ‰äººæŒæœ‰è¿‡é”ã€‚\nå‰¥å¤ºCPUï¼šfutexï¼Ÿ # ç°åœ¨æˆ‘ä»¬æƒ³æŠŠä¸å¹²æ´»çš„ä»»åŠ¡æŒ‚èµ·ï¼Œè¿™é‡Œçš„ä»»åŠ¡å¯èƒ½æ˜¯è¿›ç¨‹ã€çº¿ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯åç¨‹ã€‚è¿›ç¨‹çº¿ç¨‹æŒ‚èµ·å¯ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼ŒæŒ‚èµ·ã€æ¢å¤çš„å¼€é”€å¤ªé‡äº†ã€‚\nä¸Šå›¾æ˜¯ä¸€ä¸ªä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€æµ‹è¯„å¯¹æ¯”ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œsee measuring context switching and memory overheads for linux threadsã€‚\nä¸€èˆ¬çš„é”å®ç°ï¼Œæ‹¿ä¸åˆ°é”æœ€åè¦ä¹ˆè‡ªæ—‹ï¼Œè¦ä¹ˆå°†å½“å‰ä»»åŠ¡ç»™æŒ‚èµ·ï¼Œæ¯”å¦‚æŠŠè¿›ç¨‹ã€çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰åç»­é”è¢«é‡Šæ”¾äº†æ‰å¯ä»¥å”¤èµ·ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æŸä¸ªè¿›ç¨‹ã€çº¿ç¨‹ï¼Œæ¢å¤è°ƒåº¦æ‰§è¡Œè®©å…¶ç»§ç»­æŠ¢é”ã€‚ä¸Šå›¾ä¸­ä¹Ÿçœ‹åˆ°äº†è¿›ç¨‹ã€çº¿ç¨‹ã€CPUäº²å’Œæ€§ä¸åŒåœºæ™¯ä¸‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ã€‚\næ‰€ä»¥æ¯”è¾ƒèªæ˜çš„é”ï¼Œéƒ½ä¸ä¼šä¸€ä¸‹å­å°±æŒ‚èµ·ä»»åŠ¡ã€‚\næ··åˆé”å®ç° # ç»“åˆspinå’Œfutexçš„ç‰¹ç‚¹ï¼Œå®ç°ä¸€ä¸ªæ··åˆé”ï¼š\n spinlockï¼Œè‡ªæ—‹è€—cpuï¼Œè¿˜ä¸å¹²æ´»ï¼ˆæ— æ³•æ¨è¿›ç¨‹åºæ‰§è¡Œï¼‰ã€‚è‡ªæ—‹å¯ä»¥ç†è§£æˆä¸ºäº†ä¸è®©å‡ºcpuè®©cpuä¸€ç›´å¹²äº›æ‚æ´»ï¼Œæ¯”å¦‚å°†ä¸€ä¸ªæ•°ä»1åŠ åˆ°100ï¼ŒåŠ å®Œäº†ä»å¤´å†åŠ åˆ°100ï¼Œå¤šæ¥å‡ éâ€¦â€¦çº¯ç²¹æ˜¯ä¸ºäº†ç­‰é”è¢«æŒæœ‰è€…é‡Šæ”¾ã€‚è‡ªæ—‹é”å°±æ˜¯è‡ªæ—‹ä¹‹åå†CASæŠ¢é”è¯•ä¸‹ã€‚ä½†æ˜¯é”ç«äº‰ä¸ä¸¥é‡çš„æƒ…å†µä¸‹ï¼Œspinlockä¸€èˆ¬ä¼šæˆåŠŸï¼Œæ•ˆç‡ä¹Ÿé«˜ã€‚ futexï¼Œé˜»å¡çº¿ç¨‹ï¼Œå®ƒæ˜¯Linuxå†…æ ¸ä¸ºç”¨æˆ·ä»£ç å®ç°åŒæ­¥æä¾›çš„ä¸€ç§æ”¯æŒï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªwaitersé˜Ÿåˆ—ï¼Œæ”¯æŒç­‰å¾…ã€å”¤é†’ã€å®šæ—¶å”¤é†’ï¼Œä¸ºå®ç°é”æä¾›äº†æ–¹ä¾¿ã€‚å¼€å‘è‡ªå·±å†™ä»£ç æ—¶ä¸€èˆ¬ä¸ç”¨è¿™ç©æ„ï¼Œè€Œæ˜¯å¼•ç”¨åœ¨è¿è¡Œæ—¶æˆ–è€…æ ‡å‡†åº“åœ¨futexåŸºç¡€ä¸Šå°è£…çš„æ–¹æ³•ã€‚ hybrid approachï¼Œå…ˆcasï¼Œä¸è¡Œå†spinlockï¼Œå†ä¸è¡Œfutexï¼Œåˆ†åˆ«é€‚åº”æ²¡æœ‰é”ç«äº‰ã€å°‘é‡é”ç«äº‰ã€ä¸¥é‡é”ç«äº‰åœºæ™¯ã€‚  goè¯­è¨€ä¸­ä¼šæ€ä¹ˆåšå‘¢ï¼Œæ¯”å¦‚sync.Mutexï¼Ÿgoä¸­ä¼šåšç±»ä¼¼çš„å¤„ç†å—ï¼Ÿå¯¹é”çš„ä¼˜åŒ–ä¸Šå¤§è‡´æ€è·¯å·®ä¸å¤šã€‚åªä¸è¿‡ï¼Œgoè¦æ”¯æŒè½»é‡çº§åç¨‹ï¼Œä¸ºäº†è¿½æ±‚æ•ˆç‡ï¼Œä¼šæ¯”å¸¸è§çš„é”å®ç°æ›´ç»†è…»ä¸€ç‚¹ï¼Œä¸ä¼šåœ¨ä¸è¯¥é˜»å¡çš„æ—¶å€™æŠŠçº¿ç¨‹ç»™é˜»å¡äº†ã€‚\nsync.Mutex # ç»ˆäºæ¥åˆ°äº†goè¯­è¨€ç›¸å…³çš„è®¾è®¡å®ç°ï¼Œgoä¸­sync.Mutexçš„è®¾è®¡æœ‰äº›æ¯”è¾ƒç»†è…»çš„è€ƒé‡ï¼Œæœ¬æ¥æˆ‘å°è¯•è§£è¯»ä¸‹æºç ï¼Œå‘ç°æºç mutex.Lock()/mutex.Unlock() slowpathç¯‡å¹…æ¯”è¾ƒé•¿ï¼Œå¾ˆå®¹æ˜“è¿·å¤±åœ¨ä»£ç ä¸­æŠ“ä¸ä½ä¸»çº¿ã€‚\næ‰€ä»¥æˆ‘æŠŠè§£é‡Šè¿‡çš„æºç éƒ¨åˆ†åˆ é™¤äº†ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ€»ç»“ä¸‹ä¸€äº›å…³é”®çš„ç‚¹ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±è¯»æºç ï¼šsee https://sourcegraph.com/github.com/golang/go/-/blob/src/sync/mutex.go#L72\né¦–å…ˆï¼Œçœ‹ä¸‹sync.Mutexå®šä¹‰ï¼š\ntype Mutex struct { state int32	// é”çŠ¶æ€ï¼Œ0:unlocked,1:locked,2:woken,4:starvation,é«˜ä½ sema uint32	// ä¸ºä»€ä¹ˆæ˜¯uint32? see 'man 2 futex' }  é”è†¨èƒ€è¿‡ç¨‹ # å¯¹ç…§ç€è¿™ä¸ªç»“æ„æè¿°ä¸‹mutex.Lock()è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„ä¸€äº›äº‹æƒ…ï¼š\n  è¿™é‡Œçš„stateå°±æ˜¯è¡¨ç¤ºé”çš„çŠ¶æ€ï¼Œå¯¹åº”ç€ä¸€äº›åŠ è§£é”ç›¸å…³çš„CASã€Spinlockä¸­çš„æ“ä½œï¼›\n  semaæ˜¯åœ¨CASã€Spinlockå¤±è´¥æ—¶è¿›è¡Œçš„ä¸€é“é”è†¨èƒ€å¤„ç†ï¼Œå¦‚æœä½ ä¸äº†è§£futexï¼Œsee https://eli.thegreenplace.net/2018/basics-of-futexes/ï¼Œé”å®ç°ä¸­å¸¸ç”¨çš„futexæ“ä½œå°±æ˜¯futex_waitå°†å½“å‰çº¿ç¨‹æŒ‚èµ·ï¼Œfutex_wakeå°†çº¿ç¨‹å”¤é†’ï¼Œæ¶‰åŠåˆ°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¼€é”€è¾ƒå¤§ã€‚semaå¯ä»¥è¯´æ˜¯æ¨¡ä»¿Linux futexçš„ä¸€ç§å®ç°ï¼Œå®ƒæŒ‚èµ·ã€æ¢å¤çš„æ˜¯goroutineï¼Œè€Œéçº¿ç¨‹ã€‚\nsemaé‡Œé¢ä¹Ÿæ˜¯ä¼˜å…ˆå°è¯•èµ°CASã€Spinè·¯çº¿ï¼Œå°½å¯èƒ½é¿å…æŒ‚èµ·åç¨‹ï¼Œåç¨‹åˆ‡æ¢çš„å¼€é”€ä¹Ÿä¸èƒ½å¿½ç•¥ã€‚\nsee: https://sourcegraph.com/github.com/golang/go/-/blob/src/runtime/sema.go\ntype semaRoot struct{	lock mutex treap *sudog nwait uint32 } func (root *semaRoot) queue(addr *uint32, s *sudog, lifo bool) { ... } func (root *semaRoot) dequeue(addr *uint32) (found *sudog, now int64) { ... }    åœ¨æ²¡æœ‰é”ç«äº‰çš„æ—¶å€™ï¼Œå¤§æ¦‚ç‡ä¸€æ¬¡CASèƒ½æˆåŠŸï¼›é”ç«äº‰ä¸ä¸¥é‡çš„æ—¶å€™ï¼Œå¯èƒ½è‡ªæ—‹å‡ æ¬¡ä¹Ÿèƒ½æˆåŠŸï¼Œå†ä¸è¡ŒæŒ‚èµ·åç¨‹ã€å”¤é†’åå†å»æŠ¢é”ä¹Ÿè¯´ä¸å®šèƒ½æˆåŠŸã€‚ä½†æ˜¯é”ç«äº‰å¾ˆä¸¥é‡çš„æ—¶å€™ï¼Œä½ å°±æ˜¯æŠ¢ä¸åˆ°ï¼Œé‚£å…¶ä»–çº¿ç¨‹æŠ¢ä»€ä¹ˆå‘¢ï¼Ÿç¡è§‰å»å§ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šç”¨ä¸Šfutexã€‚ä½†æ˜¯æƒ³å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œgoæºç ä¸­çš„futexæ˜¯åœ¨Linux futexä¸ŠåˆåŒ…äº†ä¸€ä¸‹ï¼Œä¹Ÿæ˜¯èµ°CASã€spinè·¯çº¿ï¼Œå®åœ¨ä¸è¡Œäº†ï¼Œå†è°ƒç”¨Linux futexç¡çœ ã€‚\n#include \u0026lt;linux/futex.h\u0026gt; #include \u0026lt;sys/time.h\u0026gt; int futex(int *uaddr, int futex_op, int val, const struct timespec *timeout, /* or: uint32_t val2 */ int *uaddr2, int val3); futex_op: - FUTEX_WAIT ä¿æŒæŒ‚èµ·çº¿ç¨‹ï¼Œé™¤é *uaddr != valï¼Œæˆ–è€…å®šæ—¶å™¨è¶…æ—¶ - FUTEX_WAKE å”¤èµ·é˜»å¡åœ¨uaddrä¸Šçš„çº¿ç¨‹ - ...    è¿™å°±æ˜¯sync.Mutexé”è†¨èƒ€çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ³¨æ„æœ€åfutexes uses spin-locksè¿™é‡Œï¼Œå¦‚æœspin-lockså¤±è´¥ï¼Œå°±ä¼šç”¨Linux futexï¼\nåç¨‹è°ƒåº¦ä¼˜åŒ– # å¦å¤–ï¼Œgo sync.Mutexä¹Ÿåšäº†äº›åç¨‹è°ƒåº¦ç›¸å…³çš„ä¼˜åŒ–ï¼Œå¤§è‡´æ€»ç»“ä¸€ä¸‹ã€‚sync.Mutexæœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šnormal mode å’Œ starvation modeï¼Œä¸¤ç§æ¨¡å¼å¯¹æ‰§è¡ŒLockã€Unlockçš„goroutineä¼šäº§ç”Ÿä¸åŒçš„å½±å“ã€‚\n  normal mode\nè¯¥æ¨¡å¼ä¸‹ï¼Œwaitersï¼ˆgoroutinesï¼‰ä¼šæŒ‰ç…§ç”³è¯·åŠ é”çš„é¡ºåºè¿›å…¥ä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªè¢«å”¤é†’çš„waiterä¸ä¸€å®šèƒ½å¤Ÿç«‹å³æŒæœ‰é”ï¼Œå®ƒè¦å’Œæ‰€æœ‰æ–°çš„å‘èµ·åŠ é”è¯·æ±‚çš„goroutinesç«äº‰ã€‚æ–°åˆ°è¾¾çš„goroutinesé€šå¸¸æœ‰ä¸€ä¸ªä¼˜åŠ¿â€”â€”å®ƒä»¬å·²ç»åœ¨CPUä¸Šè¿è¡Œäº†ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥ä¸€ä¸ªåˆšè¢«å”¤é†’çš„waiterå¤§æ¦‚ç‡ä¼šç«äº‰é”å¤±è´¥ã€‚\nè¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå¤±è´¥çš„waiterä¼šè¢«åŠ å…¥åˆ°è¿™ä¸ªFIFOé˜Ÿåˆ—çš„é˜Ÿé¦–ï¼Œå½“æœ‰goroutineé‡Šæ”¾é”å¹¶å°è¯•å”¤é†’ä¸€ä¸ªwaiteræ—¶ï¼Œå°±ä¼šä»ä¼˜å…ˆå”¤é†’é˜Ÿé¦–çš„waiterï¼Œä½†æ˜¯ä¹Ÿåªæ˜¯å°†å…¶æ ‡è®°ä¸ºrunnableä¹‹åä¸¢åˆ°global queueè€Œå·²ï¼Œä»€ä¹ˆæ—¶å€™è¢«è°ƒåº¦åˆ°è¿˜æœªå¯çŸ¥ã€‚\nè€Œå¦‚æœä¸€ä¸ªwaiterç«äº‰é”è¶…è¿‡1msè¿˜æ²¡æœ‰æˆåŠŸï¼Œå°±ä¼šå°†mutexä»normal modeåˆ‡æ¢ä¸ºstartvation modeï¼Œä¸‹æ¬¡æœ‰goroutineé‡Šæ”¾é”æ—¶ï¼Œä¼šé‡‡å–æ›´æ¿€è¿›çš„æ–¹æ³•ä»¥ä¾¿è®©é˜Ÿé¦–çš„waiterå¿«é€Ÿå¾—åˆ°æ‰§è¡Œã€‚\n  starvation mode\nè¯¥æ¨¡å¼ä¸‹ï¼Œå½“ä¸€ä¸ªgoroutineé‡Šæ”¾é”æ—¶ï¼Œé”çš„æ‹¥æœ‰è€…ç«‹å³ä»è¯¥goroutineè½¬äº¤ç»™é˜Ÿé¦–çš„waiterã€‚æ–°åˆ°è¾¾çš„goroutinesä¸ä¼šå°è¯•è·å¾—é”ï¼Œå°½ç®¡å®ƒèƒ½è§‚å¯Ÿåˆ°é”å¥½åƒè¢«é‡Šæ”¾æ‰äº†ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ–°åˆ°è¾¾çš„goroutinesä¼šè¿½åŠ åˆ°FIFOçš„é˜Ÿåˆ—çš„æœ«å°¾ã€‚å¹¶ä¸”ï¼Œè¿™ä¸ªæ‹¿åˆ°é”çš„é˜Ÿé¦–çš„waiterï¼Œä¼šè¢«æ ‡è®°ä¸ºrunnableç„¶åæ”¾å…¥å½“å‰g.Pçš„runnextä¸­ï¼Œå¹¶ä¸”æŠŠå½“å‰gçš„æ—¶é—´ç‰‡ä¹Ÿä¸€å¹¶ä¼ ç»™å®ƒä½¿ç”¨ï¼Œå½“å‰gæ‰§è¡Œgoyieldè®©å‡ºPã€Mä¹‹åï¼ŒMå°†ç«‹å³æ‰§è¡Œp.runnextã€‚ç®€è¨€ä¹‹ï¼Œé¥¥é¥¿æ¨¡å¼ä¸‹é‡Šæ”¾é”çš„gç›´æ¥å°†é”handleoffç»™é˜Ÿé¦–çš„waiterï¼Œå¹¶è®©å…¶æ›´å¿«åœ°å¾—åˆ°æ‰§è¡Œã€‚\n  å½“ä¸€ä¸ªwaiteræ”¶åˆ°ä¸€ä¸ªmutexçš„æ‹¥æœ‰è€…æƒé™æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ï¼Œå¦‚æœï¼š1ï¼‰å®ƒæ˜¯è¿™ä¸ªé”ç«äº‰ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªwaiterï¼›æˆ–è€… 2ï¼‰å®ƒçš„åŠ é”ç­‰å¾…æ—¶é—´å°äº1msï¼Œæ­¤æ—¶å°†æŠŠmutexä»starvation modeåˆ‡æ¢ä¸ºnormal modeã€‚\nä¸é¥¥é¥¿æ¨¡å¼ç›¸æ¯”ï¼Œæ­£å¸¸æ¨¡å¼ä¸‹çš„äº’æ–¥é”èƒ½å¤Ÿæä¾›æ›´å¥½çš„æ€§èƒ½ï¼Œé¥¥é¥¿æ¨¡å¼åˆ™èƒ½ç¼©å‡goroutine ç”±äºç­‰å¾…è·å–é”è¿‡ä¹…é€ æˆçš„å»¶æ—¶ã€‚\næ€»ç»“ # æœ¬æ–‡ä»‹ç»äº†å¹¶å‘ä¸­é‡è¦çš„åŸå­æ€§ã€æŒ‡ä»¤é‡æ’é—®é¢˜ï¼Œä»¥åŠå¸¦æ¥çš„å®‰å…¨ç¼–ç é£é™©ï¼Œç„¶åä»‹ç»äº†å¤„ç†å™¨æä¾›çš„ä¸€äº›å±éšœæŒ‡ä»¤ï¼Œä»¥åŠä»ç¡¬ä»¶è§’åº¦ä»‹ç»äº†å±éšœçš„å·¥ä½œåŸç†ï¼Œç„¶åä»‹ç»äº†CASåŠå…¶ä½¿ç”¨ï¼Œå¼•å‡ºäº†è¿›ä¸€æ­¥çš„é”ã€æ— é”ã€CASçš„å¼‚åŒç‚¹ï¼Œç„¶åæˆ‘ä»¬ç®€å•æäº†ä¸‹futexé‡é‡çº§é”å¯¼è‡´çš„è¿›ç¨‹çº¿ç¨‹æŒ‚èµ·ã€æ¢å¤å¼€é”€å¤§å®¶ï¼Œæœ€åå¼•å‡ºäº†go sync.Mutexçš„è®¾è®¡å®ç°åŠä¸€ç³»åˆ—é’ˆå¯¹åç¨‹è°ƒåº¦å»¶è¿Ÿçš„ä¼˜åŒ–ã€‚\nå¸Œæœ›æœ¬æ–‡å¯¹åŠ æ·±å¤§å®¶å¯¹é”çš„è®¤è¯†æœ‰å¸®åŠ©ï¼\nå‚è€ƒå†…å®¹ #  Memory Barriers: a Hardware View for Software Hackers,http://www.puppetmastertrading.com/images/hwViewForSwHackers.pdf how cpu lock cmpxchg works: http://heather.cs.ucdavis.edu/~matloff/50/PLN/lock.pdf don\u0026rsquo;t mix high-level locks with low-level CPU feature that happened to be renamed LOCK,https://stackoverflow.com/a/27856649/3817040 cpu-memory, https://akkadia.org/drepper/cpumemory.pdf src/runtime/internal/atomic/atomic_386.s, https://sourcegraph.com/github.com/golang/go/-/blob/src/runtime/internal/atomic/atomic_386.s#L23 sync.Mutex, https://sourcegraph.com/github.com/golang/go/-/blob/src/sync/mutex.go#L81:4 Let\u0026rsquo;s talk locks, Kavya Joshi, https://www.youtube.com/watch?v=tjpncm3xTTc Atomic Operations in Hardware, https://courses.cs.washington.edu/courses/cse378/07au/lectures/L25-Atomic-Operations.pdf Atomic Operation, https://wiki.osdev.org/Atomic_operation Lock-free Algorithms for Ultimate Performance, https://www.youtube.com/watch?v=_uUkApe_yIk Fear and Loathing in Lock-Free Programming, https://medium.com/@tylerneely/fear-and-loathing-in-lock-free-programming-7158b1cdd50c measuring context switching and memory overheads for linux threads, https://eli.thegreenplace.net/2018/measuring-context-switching-and-memory-overheads-for-linux-threads/ basis of futexes, https://eli.thegreenplace.net/2018/basics-of-futexes/ Computer Architecture: Dynamic Execution Core, https://youtu.be/XuCu9EEHBtk?t=1087 x86-TSO: A Rigorous and Usable Programmer\u0026rsquo;s Model for x86 Multiprocessors, https://www.cl.cam.ac.uk/~pes20/weakmemory/cacm.pdf Memory Consistency Models: A Tutorial, https://www.cs.utexas.edu/~bornholt/post/memory-models.html  "}),a.add({id:190,href:"/tags/sync.mutex/",title:"sync.Mutex",description:"",content:""}),a.add({id:191,href:"/tags/exception/",title:"exception",description:"",content:""}),a.add({id:192,href:"/tags/panic/",title:"panic",description:"",content:""}),a.add({id:193,href:"/tags/try-catch/",title:"try-catch",description:"",content:""}),a.add({id:194,href:"/blog/2021-04-16-%E5%A6%82%E4%BD%95%E7%9C%8B%E5%BE%85gopanic%E5%8F%8A%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/",title:"å¦‚ä½•çœ‹å¾…gopanicåŠå¼‚å¸¸å¤„ç†",description:"æœ€è¿‘å‘ç°æœ‰äº›åŒå­¦å¯¹äºgo panicçš„ç†è§£æœ‰è¯¯ï¼Œåˆ†ä¸æ¸…ä»€ä¹ˆæ—¶å€™ç”¨panicï¼Œä»€ä¹ˆæ—¶å€™ç”¨errorï¼Œç”šè‡³æ˜¯ä¸€äº›goè€æ‰‹ä¹Ÿä¼šå‡ºç°ä¸åŠ é€‰æ‹©ä¹±ç”¨çš„æƒ…å†µï¼Œgo panicæœ‰å…¶æ˜ç¡®çš„ä½¿ç”¨å®šä½ï¼Œä½†æ˜¯ä¸åŒäºå…¶ä»–è¯­è¨€ä¸­çš„å¼‚å¸¸å¤„ç†ã€‚",content:"Background # æœ€è¿‘æœ‰åŒå­¦æé—®ï¼Œå¤§æ„æ˜¯ï¼šâ€œgoä¸­ä»€ä¹ˆæ—¶å€™ç”¨panicã€ä»€ä¹ˆæ—¶å€™ç”¨errorï¼Œèƒ½ä¸èƒ½åƒå…¶ä»–è¯­è¨€ä¸­çš„try-catchä¸€æ ·ç”¨panic-recoveræ¥ä»£æ›¿å±‚å±‚return errï¼Œæˆ–è€…åº”ä¸åº”è¯¥recoverä¸€ä¸ªpanicä¹‹åè½¬æ¢ä¸ºerrorï¼Ÿâ€\nè¿™ä¸ªé—®é¢˜å¼•èµ·äº†å¹¿æ³›çš„è®¨è®ºï¼Œåœ¨å¯¹è¿™å‡ ä¸ªé—®é¢˜çš„ç†è§£ä¸Šï¼Œæˆ‘æœ¬ä»¥ä¸ºå¤§å®¶åº”è¯¥ä¼šè®¤è¯†åˆ°ä½çš„ï¼Œæ²¡æƒ³åˆ°å¾ˆå¤šäººè®¤è¯†å¾ˆæ¨¡ç³Šã€‚å½“ç„¶ï¼Œå¥½çš„åœ°æ–¹å°±æ˜¯æ€»æœ‰æœ‰è§è¯†çš„åŒå­¦ç«™å‡ºæ¥æŒ‡å‡ºå¤§å®¶çš„é—®é¢˜ã€‚\nå¯¹äºé‚£äº›æœ‰çµæ€§çš„åŒå­¦ï¼Œå‹¤å®è·µå‹¤æ€è€ƒçš„åŒå­¦ï¼Œä»–ä¼šè‡ªç„¶è€Œç„¶æ„è¯†åˆ°å“ªç§error handling patternæ›´å¥½ï¼Œä¹Ÿä¼šæœ‰æ„è¯†åœ°å»åŒºåˆ†ä¸åŒpatternçš„å®šä½å’Œåº”ç”¨åœºæ™¯ã€‚è¿™ç±»åŒå­¦è™½ç„¶æ²¡æœ‰ä»€ä¹ˆç†è®ºæœ¯è¯­æ”¯æ’‘ï¼Œä½†æ˜¯ä»–ä»¬çš„â€œç»éªŒâ€æ˜¯è´´è¿‘æ›´å¥½çš„è®¾è®¡æ€æƒ³ã€æœ€ä½³å®è·µçš„ã€‚å¦‚æœæ›´è¿›ä¸€æ­¥ï¼Œèƒ½æ„¿æ„æ¥å—ä¸€äº›è®¾è®¡æ€æƒ³çš„æ´—ç¤¼ï¼Œåˆ™å¯ä»¥å°†â€œç»éªŒâ€ä¸Šå‡åˆ°â€œæ¨¡å¼â€ï¼Œä»¥æŒ‡å¯¼æ›´å¤šäººã€‚\npanic != exception # go panicä¸åŒäºå…¶ä»–è¯­è¨€ä¸­çš„exceptionï¼Œåœ¨è®¾è®¡ã€å®šä½ä¸Šæ˜¯æœ‰æ˜ç¡®çš„åŒºåˆ«çš„ï¼Œsee: https://dave.cheney.net/2012/01/18/why-go-gets-exceptions-rightã€‚\n panics are always fatal to your program. In panicing you never assume that your caller can solve the problem. Hence panic is only used in exceptional circumstances, ones where it is not possible for your code, or anyone integrating your code to continue.\n go panicæ˜¯ç”¨æ¥è¡¨ç¤ºç¨‹åºå‡ºç°äº†ååˆ†è‡´å‘½çš„é”™è¯¯ï¼Œå¹¶ä¸”ä½ ä¸èƒ½å‡å®šè¿™ä¸ªé”™è¯¯èƒ½è¢«è§£å†³ã€‚æ‰€ä»¥panicåªåœ¨å¾ˆå°‘çš„åœºæ™¯ä¸‹æ‰ä¼šè¢«ç”¨åˆ°ï¼Œå¹¶ä¸”å‡ºç°panicæ—¶ï¼Œä½ çš„ä»£ç è§£å†³ä¸äº†ï¼Œå¼•ç”¨è¿™éƒ¨åˆ†ä»£ç çš„å…¶ä»–ä»£ç ä¹Ÿè§£å†³ä¸äº†ã€‚\næ‰€ä»¥ï¼Œpanicå¹¶éä¸€èˆ¬æ„ä¹‰ä¸Šçš„errorï¼Œæ›´ä¸èƒ½ç”¨panic-recoverä»£æ›¿å±‚å±‚å‘ä¸Šä¼ é€’errorï¼\nå¯¹äºï¼Œä¸ºäº†è‡ªèº«ç¨‹åºçš„å¥å£®æ€§ï¼Œè€Œåœ¨å¯åŠ¨æ–°çš„goroutineæ—¶ï¼Œæˆ–è€…è°ƒç”¨å¤–éƒ¨ä¾èµ–çš„å¯¼å‡ºå‡½æ•°ã€æ–¹æ³•æ—¶ï¼Œå¯èƒ½é€‰æ‹©recoverä¸€äº›é¢„æ–™ä¹‹å¤–çš„panicï¼Œå¹¶è½¬æ¢ä¸ºerrorå¤„ç†ã€‚\næœ‰è¿½æ±‚çš„å¼€å‘äººå‘˜ï¼Œåœ¨panicçš„ä½¿ç”¨ä¸Šåº”è¯¥å§‹ç»ˆéµå¾ªgoè®¾è®¡ç†å¿µï¼ŒåŒæ—¶åœ¨ç¨‹åºçš„å¥å£®æ€§ä¸Šä¹Ÿä¼šé‡‡ç”¨äº›é˜²å¾¡æ€§ç¼–ç¨‹çš„æ‰‹æ®µã€‚\npanic vs exception # æˆ‘ä»¬å¾ˆå¤šå¼€å‘äººå‘˜éƒ½æ¥è§¦è¿‡å¤šé—¨è¯­è¨€ï¼Œæ¯”å¦‚Javaã€C++ï¼Œç­‰ç­‰ï¼Œè¿™ç±»è¯­è¨€éƒ½æœ‰å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œé‡åˆ°ä¸€äº›æ„å¤–äº‹ä»¶æ—¶å¯ä»¥æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå¼‚å¸¸é€šå¸¸ç”±try-catch blockæ•è·å¹¶å¤„ç†ã€‚\nåˆå­¦è€…é˜¶æ®µï¼Œå¾ˆå¤šåŒå­¦ä¼šåŠªåŠ›å»å­¦ä¹ å¼‚å¸¸å¤„ç†çš„æ­£ç¡®ç¼–ç æ–¹å¼ï¼Œç”šè‡³æ˜¯å¼‚å¸¸å¤„ç†çš„å®ç°åŸç†ï¼Œå¯¹æ€§èƒ½çš„å½±å“ï¼Œç­‰ç­‰ï¼Œä½†æ˜¯ç”±äºå®é™…ç¼ºä¹å®é™…çš„å¤§è§„æ¨¡å·¥ç¨‹ä¾›é”»ç‚¼å®è·µï¼Œä¹Ÿå¾ˆå°‘æœ‰äººä¼šå»æ€è€ƒä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼š\n  QAï¼šæˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸ï¼Ÿ\n å±‚å±‚è¿”å›errorï¼Œç¼–ç ä¸æ–¹ä¾¿ï¼Œå¸Œæœ›æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†é€»è¾‘ï¼Œä¿è¯ä¸»é€»è¾‘æ›´æ¸…æ™°ã€‚    QAï¼šå¼‚å¸¸è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ\n é¿å…äº†å±‚å±‚ä¼ é€’errorï¼Œå¼‚å¸¸åœ¨ç»Ÿä¸€ä½ç½®å¤„ç†ã€‚    QAï¼šå¼‚å¸¸å¼•å…¥äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ\n  åŒºåˆ†å¼‚å¸¸å‘ç”Ÿçš„ä½ç½®ï¼Œå°±è¦æ¯ä¸ªä½ç½®å®šä¹‰ä¸€ä¸ªå¼‚å¸¸ç±»å‹ï¼Œè¿™ä¸ªæ•°é‡åº”è¯¥æŒºå¤§çš„ã€‚\n  è€Œä¸”ç”±äºå®é™…ç¼–ç ä¸­åŒä¸€ä¸ªå¼‚å¸¸ä¼šåœ¨å¤šå¤„è¢«æŠ›å‡ºï¼Œå®é™…ä¸Šçœ‹åˆ°ä»£ç ä¸­æ•è·ä¸€ä¸ªå¼‚å¸¸ç±»å‹æ—¶ï¼Œä½ å¾ˆéš¾æ–­å®šå®ƒæ˜¯å“ªä¸ªæ“ä½œæŠ›å‡ºçš„ã€‚\n  è€Œä¸”æ¯ä¸ªå¯èƒ½æ•è·è¿™ä¸ªå¼‚å¸¸çš„åœ°æ–¹ï¼Œéƒ½éœ€è¦æ‹·è´å¼‚å¸¸å¤„ç†ä»£ç ã€‚\n  å¦‚æœæ²¡æœ‰æ•è·å¼‚å¸¸ï¼Œé€šå¸¸è¿›ç¨‹ä¼šæŒ‚æ‰ï¼Œèƒ½å¦è¯†åˆ«ä¸€ä¸ªå‡½æ•°æ˜¯å¦ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ŒJavaä¸­æœ‰checked exceptionã€unchecked exceptionï¼Œå‰è€…å¯ä»¥åœ¨ç¼–è¯‘æ—¶å¸®åŠ©ç¡®å®šæ˜¯å¦æœ‰é—æ¼çš„try-catchï¼Œä½†æ˜¯ä»ç„¶æœ‰unchecked exceptionã€‚\n    QAï¼šå¼‚å¸¸çœŸçš„è§£å†³äº†é—®é¢˜ä¹ˆï¼Ÿ\n å¼‚å¸¸è¡¨é¢è§£å†³äº†è€é—®é¢˜ï¼Œä½†æ˜¯å´æœ‰å¼•å…¥äº†æ–°é—®é¢˜ï¼Œè€Œä¸”æ–°é—®é¢˜ä¼¼ä¹æ›´ä¸¥é‡ã€‚    å¼‚å¸¸+try-catchï¼Œæœ¬è´¨ä¸Šå°†å½“å‰æ“ä½œçš„é”™è¯¯å¤„ç†é€»è¾‘è½¬æ¢ä¸ºäº†callerè¦è§£å†³çš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰å°‘å†™å¤šå°‘é”™è¯¯å¤„ç†ä»£ç ï¼Œåè€Œï¼ŒåŒä¸€å¼‚å¸¸å¤„ç†ä»£ç åœ¨å¤šä¸ªtry-catchä¸­è¢«æ‹·è´ï¼Œè€Œä¸”å¯è¯»æ€§æ›´å·®äº†ã€‚é”™è¯¯å‘ç”Ÿåœ°ã€é”™è¯¯å¤„ç†åœ°åˆ†æ•£åœ¨ä¸åŒåœ°æ–¹ï¼Œèƒ½è¯´æ˜¯å¯è¯»æ€§å¥½å—ï¼Ÿæˆ‘ä¸è¿™ä¹ˆè®¤ä¸ºã€‚\ndon\u0026rsquo;t need exception? # å¼‚å¸¸å¤„ç†ï¼ŒçœŸçš„æ˜¯ä¸ªå¥½ä¸œè¥¿ä¹ˆï¼Ÿå®ƒçœŸçš„è§£å†³äº†é—®é¢˜ä¹ˆï¼Ÿ\nä¹‹å‰åŒå›°æƒ‘c++å¼‚å¸¸æ˜¯è§£å†³äº†é—®é¢˜è¿˜æ˜¯å¼•å…¥äº†æ–°é—®é¢˜ï¼Œä¸ºæ­¤ä¹Ÿå¤šæ–¹äº†è§£ï¼Œç›´åˆ°åæ¥çœ‹åˆ°zmqä¹‹çˆ¶Martin Sustrikçš„æ–‡ç« ï¼ŒWhy should I have written ZeroMQ in C, not C++ã€‚Martinè¯¦ç»†ä»‹ç»äº†åœ¨é”™è¯¯å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡‡ç”¨C++å¼‚å¸¸å¤„ç†ä¼šå¸¦æ¥æ€æ ·çš„éº»çƒ¦ï¼Œè€Œå¦‚æœç›´æ¥ä½¿ç”¨errorå¤„ç†ä¼šæœ‰å“ªäº›å¥½å¤„ã€‚æœ€ç»ˆMartinåœ¨å®ç°zmqæ—¶é‡‡ç”¨äº† c++ minus exceptionçš„æŠ€æœ¯è·¯çº¿ï¼Œå³ä½¿ç”¨C++ä½†æ˜¯ä¸é€‚ç”¨C++å¼‚å¸¸å¤„ç†ã€‚\nåŸºäºä»¥å‰çš„æ²‰æ€ï¼ŒMartinåé¢ä½¿ç”¨Cæœ‰é‡æ–°å†™äº†ä¸€ä¸ªzmqçš„è¿›åŒ–ç‰ˆæœ¬nanomsg ï¼ŒCæ²¡æœ‰å¼‚å¸¸å¤„ç† :)\nè¿™é‡Œä¸æƒ³å¼•æˆ˜ï¼Œä¹Ÿä¸æƒ³åšäºŒå…ƒçš„åˆ¤å®šï¼Œå¼ºçƒˆæ¨èè¯»è€…æœ‹å‹ä»¬é˜…è¯»ä¸‹Daveã€Martin Sustrikçš„æ–‡ç« ï¼Œç›¸ä¿¡ä¼šå¯¹panicã€errorã€exceptionçš„è®¾è®¡ç†è§£æ›´é€å½»ã€‚\nReferences #  Why go gets exceptions right, https://dave.cheney.net/2012/01/18/why-go-gets-exceptions-right Why should I have written ZeroMQ in C, not C++, https://250bpm.com/blog:4/  "}),a.add({id:195,href:"/tags/bcc/",title:"bcc",description:"",content:""}),a.add({id:196,href:"/tags/bpf/",title:"bpf",description:"",content:""}),a.add({id:197,href:"/tags/cgo/",title:"cgo",description:"",content:""}),a.add({id:198,href:"/blog/2021-04-14-go%E7%A8%8B%E5%BA%8F%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E9%97%AE%E9%A2%98%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8D/",title:"Goç¨‹åºå†…å­˜æ³„éœ²é—®é¢˜å¿«é€Ÿå®šä½",description:".myimg { width: 680px; padding-bottom: 1rem; }  å‰å‡ å¤©æœ‰åŒå­¦åé¦ˆäº†cgoå†…å­˜æ³„éœ²é—®é¢˜ï¼Œè‡ªå·±ä¹Ÿé’ˆå¯¹è¿™ä¸ªé—®é¢˜æ¢ç´¢äº†ä¸€ç•ªï¼Œç®—æ˜¯ä¸ºä»¥åè§£å†³ç±»ä¼¼é—®é¢˜æå‰æ”’ç‚¹ç»éªŒå§ã€‚ä¹Ÿè¶æœºæ•´ç†äº†ä¸€ä¸‹goå¼€å‘è¿‡ç¨‹ä¸­å†…å­˜æ³„éœ²é—®é¢˜çš„ä¸€äº›å¸¸ç”¨æ’æŸ¥æ–¹æ³•ï¼Œä¹Ÿå¸Œæœ›å¯¹æ–°æ¥è§¦goçš„åŒå­¦æœ‰æ‰€å¸®åŠ©ã€‚æ•´ç†ä¹‹ä½™ï¼Œbccå·¥å…·ä¹‹ä¸°å¯Œä¹Ÿè®©æˆ‘æœ‰ç‚¹æƒŠè®¶ï¼Œä¹Ÿå¸Œæœ›å¯¹è‡ªå·±æ—¥åçš„å·¥ä½œæœ‰æ‰€å¸®åŠ©å§ã€‚\nå†…å­˜æ³„æ¼ # å†…å­˜æ³„éœ²ï¼Œä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œä½†å³ä¾¿æ˜¯è€æ‰‹ä¹Ÿä¼šçŠ¯ä¸€äº›ä½çº§é”™è¯¯ã€‚å¦‚æœæ²¡æœ‰å¯é çš„ç ”å‘æµç¨‹ä¿è¯åœ¨æµ‹è¯•é˜¶æ®µå‘ç°é—®é¢˜ï¼Œé—®é¢˜å°±å®¹æ˜“è¢«å¸¦åˆ°çº¿ä¸Šã€‚è®¡ç®—èµ„æºå§‹ç»ˆæ˜¯æœ‰é™çš„ï¼Œé—®é¢˜ä¹Ÿä¸ä¼šå› ä¸ºèµ„æºå……è£•å°±æ¶ˆå¤±ä¸è§ï¼Œäº§ç”Ÿå½±å“åªæ˜¯æ—¶é—´é—®é¢˜ã€‚å½±å“æœ‰å¤šå¤§ï¼Œå°±è¦ç»“åˆåœºæ™¯æ¥è¯´äº†ã€‚\nå†…å­˜æ³„æ¼ï¼Œæœ€å¯èƒ½çš„å½±å“å°±æ˜¯å†…å­˜ç”³è¯·å¤±è´¥ã€‚ä½†å®é™…ä¸Šæ“ä½œç³»ç»Ÿæ›´èªæ˜ï¼Œç»“åˆç³»ç»Ÿæ•´ä½“è´Ÿè½½æƒ…å†µï¼Œå®ƒä¼šä¸ºæ¯ä¸ªè¿›ç¨‹è®¡ç®—ä¸€ä¸ªoom_scoreï¼Œå¹¶åœ¨å†…å­˜èµ„æºç´§å¼ æ—¶é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è¿›ç¨‹æ€æ­»å¹¶å›æ”¶å†…å­˜èµ„æºï¼Œsee how does the oom killer decide which process to kill firstã€‚\næ‰€ä»¥ï¼Œå†…å­˜æ³„éœ²çš„æœ€ç»ˆç»“æœï¼Œå¤§æ¦‚ç‡ä¼šè¢«æ“ä½œç³»ç»Ÿkillï¼Œé€šå¸¸è¿›ç¨‹æŒ‚æ‰åï¼Œç¡®è®¤å…¶æ˜¯å¦æ˜¯å› ä¸ºoomé—®é¢˜è¢«killï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ /proc/messages æ¥ç¡®è®¤æ˜¯å¦æœ‰å¯¹åº”æ—¥å¿—ã€‚æœ‰çš„è¯ï¼Œé‚£å°±åå®äº†oom killedï¼ˆä½†æ˜¯è¢«oom killedçš„è¿›ç¨‹ä¸ä¸€å®šæ„å‘³ç€å­˜åœ¨å†…å­˜æ³„éœ²ï¼‰ã€‚\næœåŠ¡è´¨é‡ # ç»“åˆè¿ç»´æ‰‹æ®µçš„å˜åŒ–ï¼Œæ¥çœ‹çœ‹æ˜¯å¦å†…å­˜æ³„æ¼é—®é¢˜å¯¹æœåŠ¡è´¨é‡é€ æˆçš„å½±å“ã€‚\n ä¼ ç»Ÿäººå·¥æ–¹å¼ï¼Œé€šè¿‡æ„ŸçŸ¥å‘Šè­¦ã€äººä¸ºä»‹å…¥è¿™ç§æ–¹å¼ï¼Œæ•ˆç‡ä½ï¼Œè¦åå‡ åˆ†é’Ÿï¼› é€šè¿‡è™šæ‹Ÿæœºè‡ªåŠ¨åŒ–éƒ¨ç½²çš„æ–¹å¼ï¼Œæ„ŸçŸ¥å¼‚å¸¸è‡ªåŠ¨é‡å¯è™šæ‹Ÿæœºï¼Œè€—æ—¶å¤§çº¦è¦åˆ†é’Ÿçº§ï¼› é€šè¿‡dockerå®¹å™¨åŒ–éƒ¨ç½²çš„æ–¹å¼ï¼Œæ„ŸçŸ¥å¼‚å¸¸è‡ªåŠ¨é‡å¯å®¹å™¨ï¼Œè€—æ—¶å¤§çº¦åœ¨ç§’çº§ï¼›  çœ‹ä¸Šå»ç°ä»£è¿ç»´æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯ï¼Œè¿™ä¹Ÿè¦åˆ†æƒ…å†µï¼š\n å¦‚æœå†…å­˜æ³„éœ²çš„ä»£ç è·¯å¾„ä¸å®¹æ˜“è¢«è§¦å‘ï¼Œé‚£å¯èƒ½è¦è·‘å¾ˆä¹…æ‰èƒ½è§¦å‘oom killï¼Œå¦‚ä¸€å‘¨ï¼›ä½†æ˜¯å¦‚æœä»£ç è·¯å¾„åœ¨å…³é”®ä»£ç è·¯å¾„ä¸Šï¼Œä¸”è¯·æ±‚é‡å¤§ï¼Œé¢‘ç¹è§¦å‘å†…å­˜æ³„éœ²ï¼Œé‚£å¯èƒ½è·‘ä¸ªå‡ åˆ†é’Ÿå°±ä¼šæŒ‚æ‰ï¼› è·Ÿæ¯æ¬¡å†…å­˜æ³„éœ²çš„å†…å­˜å¤§å°ä¹Ÿæœ‰å…³ç³»ï¼Œå¦‚æœæ³„éœ²çš„å°‘ï¼Œå¤šè‹Ÿæ´»ä¸€é˜µå­ï¼Œåä¹‹å®¹æ˜“æš´æ¯™ï¼› è¿›ç¨‹ä¸€æ—¦æŒ‚æ‰ï¼Œè¿™æ®µæ—¶é—´å°±ä¸èƒ½å“åº”äº†ï¼ŒæœåŠ¡çš„å¥åº·ç›‘æµ‹ã€åå­—æœåŠ¡ã€è´Ÿè½½å‡è¡¡ç­‰æªæ–½éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½æ„ŸçŸ¥åˆ°ï¼Œå¦‚æœè¯·æ±‚é‡å¤§ï¼ŒæœåŠ¡ä¸å¯ç”¨ä¾ç„¶ä¼šå¸¦æ¥æ¯”è¾ƒå¤§çš„å½±å“ã€‚  æœåŠ¡è´¨é‡ä¿è¯æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥åˆ«ç®¡ç”¨äº†ä»€ä¹ˆè¿ç»´æ‰‹æ®µï¼Œé—®é¢˜ç»ˆç©¶æ˜¯é—®é¢˜ï¼Œä¹Ÿæ˜¯è¦è§£å†³çš„ã€‚\nGoå†…å­˜æ³„æ¼ # åƒåœ¾å›æ”¶ # è‡ªåŠ¨å†…å­˜ç®¡ç†å‡è½»äº†å¼€å‘äººå‘˜ç®¡ç†å†…å­˜çš„å¤æ‚æ€§ï¼Œä¸éœ€è¦åƒC\\C++å¼€å‘è€…é‚£æ ·æ˜¾ç¤ºmallocã€freeï¼Œæˆ–è€…newã€deleteã€‚åƒåœ¾å›æ”¶å€ŸåŠ©äºä¸€äº›åƒåœ¾å›æ”¶ç®—æ³•å®Œæˆå¯¹æ— ç”¨å†…å­˜çš„æ¸…ç†ï¼Œåƒåœ¾å›æ”¶ç®—æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šå¼•ç”¨è®¡æ•°ã€æ ‡è®°æ¸…é™¤ã€æ‹·è´ã€åˆ†ä»£ç­‰ç­‰ã€‚\nGoä¸­åƒåœ¾å›æ”¶å™¨é‡‡ç”¨çš„æ˜¯â€œå¹¶å‘ä¸‰è‰²æ ‡è®°æ¸…é™¤â€ç®—æ³•ï¼Œsee:\n Garbage Collection In Go : Part I - Semantics Garbage Collection In Go : Part II - GC Traces Garbage Collection In Go : Part III - GC Pacing  Goè¯­è¨€æ”¯æŒè‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œé‚£è¿˜å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜å—ï¼Ÿ",content:" .myimg { width: 680px; padding-bottom: 1rem; }  å‰å‡ å¤©æœ‰åŒå­¦åé¦ˆäº†cgoå†…å­˜æ³„éœ²é—®é¢˜ï¼Œè‡ªå·±ä¹Ÿé’ˆå¯¹è¿™ä¸ªé—®é¢˜æ¢ç´¢äº†ä¸€ç•ªï¼Œç®—æ˜¯ä¸ºä»¥åè§£å†³ç±»ä¼¼é—®é¢˜æå‰æ”’ç‚¹ç»éªŒå§ã€‚ä¹Ÿè¶æœºæ•´ç†äº†ä¸€ä¸‹goå¼€å‘è¿‡ç¨‹ä¸­å†…å­˜æ³„éœ²é—®é¢˜çš„ä¸€äº›å¸¸ç”¨æ’æŸ¥æ–¹æ³•ï¼Œä¹Ÿå¸Œæœ›å¯¹æ–°æ¥è§¦goçš„åŒå­¦æœ‰æ‰€å¸®åŠ©ã€‚æ•´ç†ä¹‹ä½™ï¼Œbccå·¥å…·ä¹‹ä¸°å¯Œä¹Ÿè®©æˆ‘æœ‰ç‚¹æƒŠè®¶ï¼Œä¹Ÿå¸Œæœ›å¯¹è‡ªå·±æ—¥åçš„å·¥ä½œæœ‰æ‰€å¸®åŠ©å§ã€‚\nå†…å­˜æ³„æ¼ # å†…å­˜æ³„éœ²ï¼Œä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œä½†å³ä¾¿æ˜¯è€æ‰‹ä¹Ÿä¼šçŠ¯ä¸€äº›ä½çº§é”™è¯¯ã€‚å¦‚æœæ²¡æœ‰å¯é çš„ç ”å‘æµç¨‹ä¿è¯åœ¨æµ‹è¯•é˜¶æ®µå‘ç°é—®é¢˜ï¼Œé—®é¢˜å°±å®¹æ˜“è¢«å¸¦åˆ°çº¿ä¸Šã€‚è®¡ç®—èµ„æºå§‹ç»ˆæ˜¯æœ‰é™çš„ï¼Œé—®é¢˜ä¹Ÿä¸ä¼šå› ä¸ºèµ„æºå……è£•å°±æ¶ˆå¤±ä¸è§ï¼Œäº§ç”Ÿå½±å“åªæ˜¯æ—¶é—´é—®é¢˜ã€‚å½±å“æœ‰å¤šå¤§ï¼Œå°±è¦ç»“åˆåœºæ™¯æ¥è¯´äº†ã€‚\nå†…å­˜æ³„æ¼ï¼Œæœ€å¯èƒ½çš„å½±å“å°±æ˜¯å†…å­˜ç”³è¯·å¤±è´¥ã€‚ä½†å®é™…ä¸Šæ“ä½œç³»ç»Ÿæ›´èªæ˜ï¼Œç»“åˆç³»ç»Ÿæ•´ä½“è´Ÿè½½æƒ…å†µï¼Œå®ƒä¼šä¸ºæ¯ä¸ªè¿›ç¨‹è®¡ç®—ä¸€ä¸ªoom_scoreï¼Œå¹¶åœ¨å†…å­˜èµ„æºç´§å¼ æ—¶é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è¿›ç¨‹æ€æ­»å¹¶å›æ”¶å†…å­˜èµ„æºï¼Œsee how does the oom killer decide which process to kill firstã€‚\næ‰€ä»¥ï¼Œå†…å­˜æ³„éœ²çš„æœ€ç»ˆç»“æœï¼Œå¤§æ¦‚ç‡ä¼šè¢«æ“ä½œç³»ç»Ÿkillï¼Œé€šå¸¸è¿›ç¨‹æŒ‚æ‰åï¼Œç¡®è®¤å…¶æ˜¯å¦æ˜¯å› ä¸ºoomé—®é¢˜è¢«killï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ /proc/messages æ¥ç¡®è®¤æ˜¯å¦æœ‰å¯¹åº”æ—¥å¿—ã€‚æœ‰çš„è¯ï¼Œé‚£å°±åå®äº†oom killedï¼ˆä½†æ˜¯è¢«oom killedçš„è¿›ç¨‹ä¸ä¸€å®šæ„å‘³ç€å­˜åœ¨å†…å­˜æ³„éœ²ï¼‰ã€‚\næœåŠ¡è´¨é‡ # ç»“åˆè¿ç»´æ‰‹æ®µçš„å˜åŒ–ï¼Œæ¥çœ‹çœ‹æ˜¯å¦å†…å­˜æ³„æ¼é—®é¢˜å¯¹æœåŠ¡è´¨é‡é€ æˆçš„å½±å“ã€‚\n ä¼ ç»Ÿäººå·¥æ–¹å¼ï¼Œé€šè¿‡æ„ŸçŸ¥å‘Šè­¦ã€äººä¸ºä»‹å…¥è¿™ç§æ–¹å¼ï¼Œæ•ˆç‡ä½ï¼Œè¦åå‡ åˆ†é’Ÿï¼› é€šè¿‡è™šæ‹Ÿæœºè‡ªåŠ¨åŒ–éƒ¨ç½²çš„æ–¹å¼ï¼Œæ„ŸçŸ¥å¼‚å¸¸è‡ªåŠ¨é‡å¯è™šæ‹Ÿæœºï¼Œè€—æ—¶å¤§çº¦è¦åˆ†é’Ÿçº§ï¼› é€šè¿‡dockerå®¹å™¨åŒ–éƒ¨ç½²çš„æ–¹å¼ï¼Œæ„ŸçŸ¥å¼‚å¸¸è‡ªåŠ¨é‡å¯å®¹å™¨ï¼Œè€—æ—¶å¤§çº¦åœ¨ç§’çº§ï¼›  çœ‹ä¸Šå»ç°ä»£è¿ç»´æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯ï¼Œè¿™ä¹Ÿè¦åˆ†æƒ…å†µï¼š\n å¦‚æœå†…å­˜æ³„éœ²çš„ä»£ç è·¯å¾„ä¸å®¹æ˜“è¢«è§¦å‘ï¼Œé‚£å¯èƒ½è¦è·‘å¾ˆä¹…æ‰èƒ½è§¦å‘oom killï¼Œå¦‚ä¸€å‘¨ï¼›ä½†æ˜¯å¦‚æœä»£ç è·¯å¾„åœ¨å…³é”®ä»£ç è·¯å¾„ä¸Šï¼Œä¸”è¯·æ±‚é‡å¤§ï¼Œé¢‘ç¹è§¦å‘å†…å­˜æ³„éœ²ï¼Œé‚£å¯èƒ½è·‘ä¸ªå‡ åˆ†é’Ÿå°±ä¼šæŒ‚æ‰ï¼› è·Ÿæ¯æ¬¡å†…å­˜æ³„éœ²çš„å†…å­˜å¤§å°ä¹Ÿæœ‰å…³ç³»ï¼Œå¦‚æœæ³„éœ²çš„å°‘ï¼Œå¤šè‹Ÿæ´»ä¸€é˜µå­ï¼Œåä¹‹å®¹æ˜“æš´æ¯™ï¼› è¿›ç¨‹ä¸€æ—¦æŒ‚æ‰ï¼Œè¿™æ®µæ—¶é—´å°±ä¸èƒ½å“åº”äº†ï¼ŒæœåŠ¡çš„å¥åº·ç›‘æµ‹ã€åå­—æœåŠ¡ã€è´Ÿè½½å‡è¡¡ç­‰æªæ–½éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½æ„ŸçŸ¥åˆ°ï¼Œå¦‚æœè¯·æ±‚é‡å¤§ï¼ŒæœåŠ¡ä¸å¯ç”¨ä¾ç„¶ä¼šå¸¦æ¥æ¯”è¾ƒå¤§çš„å½±å“ã€‚  æœåŠ¡è´¨é‡ä¿è¯æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥åˆ«ç®¡ç”¨äº†ä»€ä¹ˆè¿ç»´æ‰‹æ®µï¼Œé—®é¢˜ç»ˆç©¶æ˜¯é—®é¢˜ï¼Œä¹Ÿæ˜¯è¦è§£å†³çš„ã€‚\nGoå†…å­˜æ³„æ¼ # åƒåœ¾å›æ”¶ # è‡ªåŠ¨å†…å­˜ç®¡ç†å‡è½»äº†å¼€å‘äººå‘˜ç®¡ç†å†…å­˜çš„å¤æ‚æ€§ï¼Œä¸éœ€è¦åƒC\\C++å¼€å‘è€…é‚£æ ·æ˜¾ç¤ºmallocã€freeï¼Œæˆ–è€…newã€deleteã€‚åƒåœ¾å›æ”¶å€ŸåŠ©äºä¸€äº›åƒåœ¾å›æ”¶ç®—æ³•å®Œæˆå¯¹æ— ç”¨å†…å­˜çš„æ¸…ç†ï¼Œåƒåœ¾å›æ”¶ç®—æ³•æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šå¼•ç”¨è®¡æ•°ã€æ ‡è®°æ¸…é™¤ã€æ‹·è´ã€åˆ†ä»£ç­‰ç­‰ã€‚\nGoä¸­åƒåœ¾å›æ”¶å™¨é‡‡ç”¨çš„æ˜¯â€œå¹¶å‘ä¸‰è‰²æ ‡è®°æ¸…é™¤â€ç®—æ³•ï¼Œsee:\n Garbage Collection In Go : Part I - Semantics Garbage Collection In Go : Part II - GC Traces Garbage Collection In Go : Part III - GC Pacing  Goè¯­è¨€æ”¯æŒè‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œé‚£è¿˜å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜å—ï¼Ÿ\nç†è®ºä¸Šï¼Œåƒåœ¾å›æ”¶ï¼ˆgcï¼‰ç®—æ³•èƒ½å¤Ÿå¯¹å †å†…å­˜è¿›è¡Œæœ‰æ•ˆçš„æ¸…ç†ï¼Œè¿™ä¸ªæ˜¯æ²¡ä»€ä¹ˆå¯è´¨ç–‘çš„ã€‚ä½†æ˜¯è¦ç†è§£ï¼Œåƒåœ¾å›æ”¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œçš„å‰ææ˜¯ï¼Œç¨‹åºä¸­å¿…é¡»è§£é™¤å¯¹å†…å­˜çš„å¼•ç”¨ï¼Œè¿™æ ·åƒåœ¾å›æ”¶æ‰ä¼šå°†å…¶åˆ¤å®šä¸ºå¯å›æ”¶å†…å­˜å¹¶å›æ”¶ã€‚\nå†…å­˜æ³„æ¼åœºæ™¯ # å®é™…æƒ…å†µæ˜¯ï¼Œç¼–ç ä¸­ç¡®å®å­˜åœ¨ä¸€äº›åœºæ™¯ï¼Œä¼šé€ æˆâ€œä¸´æ—¶æ€§â€æˆ–è€…â€œæ°¸ä¹…æ€§â€å†…å­˜æ³„éœ²ï¼Œæ˜¯éœ€è¦å¼€å‘äººå‘˜åŠ æ·±å¯¹ç¼–ç¨‹è¯­è¨€è®¾è®¡å®ç°ã€ç¼–è¯‘å™¨ç‰¹æ€§çš„ç†è§£ä¹‹åæ‰èƒ½ä¼˜åŒ–æ‰çš„ï¼Œseeï¼šgo memory leaking scenariosã€‚\nå³ä¾¿æ˜¯ä¸´æ—¶æ€§å†…å­˜æ³„æ¼ï¼Œè€ƒè™‘åˆ°æœ‰é™çš„å†…å­˜èµ„æºã€å†…å­˜ç”³è¯·å¤§å°ã€ç”³è¯·é¢‘ç‡ã€é‡Šæ”¾é¢‘ç‡å› ç´ ï¼Œä¹Ÿä¼šé€ æˆè¿›ç¨‹oom killedçš„ç»“æœã€‚æ‰€ä»¥ï¼Œå¼€å‘äººå‘˜å¯¹å¾…æ¯ä¸€è¡Œä»£ç è¿˜æ˜¯è¦å¿ƒå­˜æ•¬ç•ï¼Œå¯¹å¾…å†…å­˜èµ„æºä¹Ÿè¿˜æ˜¯è¦æ…é‡ã€‚\nå¸¸è§çš„å†…å­˜æ³„éœ²åœºæ™¯ï¼Œgo101è¿›è¡Œäº†è®¨è®ºï¼Œæ€»ç»“äº†å¦‚ä¸‹å‡ ç§ï¼š\n Kind of memory leaking caused by substrings Kind of memory leaking caused by subslices Kind of memory leaking caused by not resetting pointers in lost slice elements Real memory leaking caused by hanging goroutines real memory leadking caused by not stopping time.Ticker values which are not used any more Real memory leaking caused by using finalizers improperly Kind of resource leaking by deferring function calls  ç®€å•å½’çº³ä¸€ä¸‹ï¼Œè¿˜æ˜¯â€œä¸´æ—¶æ€§â€å†…å­˜æ³„éœ²å’Œâ€œæ°¸ä¹…æ€§â€å†…å­˜æ³„éœ²ï¼š\n ä¸´æ—¶æ€§æ³„éœ²ï¼ŒæŒ‡çš„æ˜¯è¯¥é‡Šæ”¾çš„å†…å­˜èµ„æºæ²¡æœ‰åŠæ—¶é‡Šæ”¾ï¼Œå¯¹åº”çš„å†…å­˜èµ„æºä»ç„¶æœ‰æœºä¼šåœ¨æ›´æ™šäº›æ—¶å€™è¢«é‡Šæ”¾ï¼Œå³ä¾¿å¦‚æ­¤åœ¨å†…å­˜èµ„æºç´§å¼ æƒ…å†µä¸‹ï¼Œä¹Ÿä¼šæ˜¯ä¸ªé—®é¢˜ã€‚è¿™ç±»ä¸»è¦æ˜¯stringã€sliceåº•å±‚bufferçš„é”™è¯¯å…±äº«ï¼Œå¯¼è‡´æ— ç”¨æ•°æ®å¯¹è±¡æ— æ³•åŠæ—¶é‡Šæ”¾ï¼Œæˆ–è€…deferå‡½æ•°å¯¼è‡´çš„èµ„æºæ²¡æœ‰åŠæ—¶é‡Šæ”¾ã€‚ æ°¸ä¹…æ€§æ³„éœ²ï¼ŒæŒ‡çš„æ˜¯åœ¨è¿›ç¨‹åç»­ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæ³„éœ²çš„å†…å­˜éƒ½æ²¡æœ‰æœºä¼šå›æ”¶ï¼Œå¦‚goroutineå†…éƒ¨é¢„æœŸä¹‹å¤–çš„for-loopæˆ–è€…chan select-caseå¯¼è‡´çš„æ— æ³•é€€å‡ºçš„æƒ…å†µï¼Œå¯¼è‡´åç¨‹æ ˆåŠå¼•ç”¨å†…å­˜æ°¸ä¹…æ³„éœ²é—®é¢˜ã€‚  å†…å­˜æ³„éœ²æ’æŸ¥ # åˆæ­¥æ€€ç–‘ç¨‹åºå­˜åœ¨å†…å­˜æ³„éœ²é—®é¢˜ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¿›ç¨‹oom killedï¼Œæˆ–è€…æ˜¯å› ä¸ºtopæ˜¾ç¤ºå†…å­˜å ç”¨æŒç»­å¢åŠ æ— æ³•ç¨³å®šåœ¨ä¸€ä¸ªåˆç†å€¼ã€‚ä¸ç®¡å¦‚ä½•å‘ç°çš„ï¼Œæ˜ç¡®å­˜åœ¨è¿™ä¸€é—®é¢˜ä¹‹åï¼Œå°±éœ€è¦åŠæ—¶é€‰æ‹©åˆé€‚çš„æ–¹æ³•å®šä½åˆ°é—®é¢˜çš„æ ¹æºï¼Œå¹¶åŠæ—¶ä¿®å¤ã€‚\nå€ŸåŠ©pprofæ’æŸ¥ # pprofç±»å‹ # goæä¾›äº†pprofå·¥å…·æ–¹ä¾¿å¯¹è¿è¡Œä¸­çš„goç¨‹åºè¿›è¡Œé‡‡æ ·åˆ†æï¼Œæ”¯æŒå¯¹å¤šç§ç±»å‹çš„é‡‡æ ·åˆ†æï¼š\n goroutine - stack traces of all current goroutines heap - a sampling of all heap allocations threadcreate - stack traces that led to the creation of new OS threads block - stack traces that led to blocking on synchronization primitives mutex - stack traces of holders of contended mutexes profile - cpu profile trace - allows collecting all the profiles for a certain duration  pprofæ“ä½œ # ç°åœ¨å¾ˆå¤šrpcæ¡†æ¶æœ‰å†…ç½®ç®¡ç†æ¨¡å—ï¼Œå…è®¸è®¿é—®ç®¡ç†ç«¯å£é€šè¿‡/debug/pprofå¯¹æœåŠ¡è¿›è¡Œé‡‡æ ·åˆ†æï¼ˆpprofä¼šæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œæœ€å¥½åˆ†æå‰å°†è´Ÿè½½å‡è¡¡æƒé‡è°ƒä½ï¼‰ã€‚\né›†æˆpproféå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨å·¥ç¨‹ä¸­å¼•å…¥å¦‚ä¸‹ä»£ç å³å¯ï¼š\nimport _ \u0026quot;net/http/pprof\u0026quot; go func() { log.Println(http.ListenAndServe(\u0026quot;localhost:6060\u0026quot;, nil)) }()  ç„¶åè¿è¡Œgo tool pprofè¿›è¡Œé‡‡æ ·ï¼š\ngo tool pprof -seconds=10 -http=:9999 http://localhost:6060/debug/pprof/heap  æœ‰æ—¶å¯èƒ½å­˜åœ¨ç½‘ç»œéš”ç¦»é—®é¢˜ï¼Œä¸èƒ½ç›´æ¥ä»å¼€å‘æœºè®¿é—®æµ‹è¯•æœºã€çº¿ä¸Šæœºå™¨ï¼Œæˆ–è€…æµ‹è¯•æœºã€çº¿ä¸Šæœºå™¨æ²¡æœ‰å®‰è£…goï¼Œé‚£ä¹Ÿå¯ä»¥è¿™ä¹ˆåšï¼š\ncurl http://localhost:6060/debug/pprof/heap?seconds=30 \u0026gt; heap.out # szä¸‹è½½heap.outåˆ°æœ¬åœ° go tool pprof heap.out  go tool pprofå¯ä»¥æ”¶é›†ä¸¤ç±»é‡‡æ ·æ•°æ®ï¼š\n  in_useï¼Œæ”¶é›†è¿›ç¨‹å½“å‰ä»åœ¨ä½¿ç”¨ä¸­çš„å†…å­˜ï¼›   allocï¼Œæ”¶é›†è‡ªè¿›ç¨‹å¯åŠ¨åçš„æ€»çš„å†…å­˜åˆ†é…æƒ…å†µï¼ŒåŒ…æ‹¬å·²ç»é‡Šæ”¾æ‰çš„å†…å­˜ï¼›   go tool pprofå±•ç¤ºé‡‡æ ·ä¿¡æ¯æ—¶ï¼Œç”³è¯·å†…å­˜ä»¥â€œçº¢è‰²â€æ˜¾ç¤ºï¼Œé‡Šæ”¾å†…å­˜ä»¥â€œç»¿è‰²â€æ˜¾ç¤ºã€‚\nå…è®¸é‡‡æ ·å®Œæˆåæ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨é¡µé¢ï¼ˆé€šè¿‡ip:portè®¿é—®ï¼‰ï¼Œäº¤äº’å¼åœ°æŸ¥çœ‹é‡‡æ ·ç»“æœä¿¡æ¯ï¼Œä¾‹å¦‚callgraphã€flamegraphã€topä¿¡æ¯ã€‚\npprofç¤ºä¾‹ï¼šåç¨‹æ³„éœ² # å…¶ä¸­æœ‰2æ¡çº¢è‰²çš„å¾ˆé†’ç›®çš„è·¯å¾„ï¼Œè¿™æ˜¯é€ æˆå†…å­˜å ç”¨å‡é«˜çš„ä¸»è¦è·¯å¾„ï¼Œéœ€è¦é‡ç‚¹åˆ†æã€‚ä»¥å³è¾¹è¿™æ¡çº¢è‰²è·¯å¾„ä¸ºä¾‹ï¼Œæœ€ç»ˆèµ°åˆ°äº†runtime.malgï¼Œç¢°åˆ°è¿™ä¸ªå‡½æ•°ï¼Œè”æƒ³å‰é¢æ€»ç»“çš„å¸¸è§å†…å­˜æ³„éœ²åœºæ™¯ï¼Œè¦æœ‰è¿™æ ·çš„æ„è¯†ï¼šâ€œè¿™é‡Œå¯èƒ½æ¶‰åŠåˆ°goroutineæ³„éœ²â€ï¼Œå³goroutineåˆ›å»ºäº†å¾ˆå¤šï¼Œä½†æ˜¯goroutineæ²¡æœ‰æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œå¯¹åº”çš„åç¨‹ä½¿ç”¨çš„å†…å­˜æ²¡æœ‰é‡Šæ”¾ã€‚\næ­¤æ—¶æ ¹æ®ä¸Šè¿°callgraphä¸­çš„çº¿ç´¢æ£€æŸ¥ç¨‹åºä¸­å¯åŠ¨goroutineçš„åœ°æ–¹ï¼Œä»¥åŠgoroutineæ˜¯å¦æœ‰æ­£å¸¸é€€å‡ºçš„é€»è¾‘ä¿è¯ï¼Œå°±èƒ½æ¯”è¾ƒæ–¹ä¾¿åœ°å®šä½åˆ°æ³„éœ²åŸå› äº†ã€‚\nä¸Šè¿°callgraphä¸­å±•ç¤ºäº†ä¸¤æ¡å¯¼è‡´å†…å­˜åˆ†é…å ç”¨é«˜çš„è·¯å¾„ï¼Œä½†æ˜¯å…¶ä¸­å·¦è¾¹ä¸€æ¡å¯èƒ½æ˜¯æ­£å¸¸æƒ…å†µä¸‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œè€Œå³è¾¹è¿™æ¡å¯èƒ½æ˜¯å¼‚å¸¸æƒ…å†µã€‚åœ¨åˆ†æé˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦æœ‰èƒ½åŠ›åŒºåˆ†å“ªäº›å†…å­˜åˆ†é…æ˜¯æ­£å¸¸æƒ…å†µï¼Œå“ªäº›æƒ…å†µæ˜¯å¼‚å¸¸æƒ…å†µã€‚pprofæä¾›äº†å¦å¤–ä¸€ä¸ªæœ‰ç”¨çš„é€‰é¡¹-diff_baseï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰æœåŠ¡æ²¡æœ‰è¯·æ±‚æ—¶é‡‡æ ·30sç”Ÿæˆä¸€ä¸ªé‡‡æ ·æ–‡ä»¶ï¼Œç„¶åæœ‰è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬å†é‡‡æ ·30sç”Ÿæˆå¦ä¸€ä¸ªé‡‡æ ·æ–‡ä»¶ï¼Œå¹¶å°†ä¸¤ä¸ªé‡‡æ ·æ–‡ä»¶è¿›è¡Œå¯¹æ¯”ã€‚è¿™æ ·å°±å®¹æ˜“åˆ†æå‡ºè¯·æ±‚å‡ºç°æ—¶ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚\ngo tool pprof -http=':8081' \\ -diff_base heap-new-16:22:04:N.out \\ heap-new-17:32:38:N.out  è¿™æ ·é—®é¢˜çœ‹èµ·æ¥å°±æ›´éå¸¸æ˜ç¡®äº†ï¼Œè¯·æ±‚å‡ºç°æ—¶å¤„ç†è¯·æ±‚çš„è¿‡ç¨‹ä¸­å¯åŠ¨äº†æ–°åç¨‹æ‰§è¡Œå¤„ç†ã€‚runtime.malgå°±æ˜¯åˆ›å»ºæ–°åç¨‹ï¼Œå…¶å†…éƒ¨ä¼šåˆ†é…åç¨‹æ ˆï¼Œè¿™ä¸ªæ ˆåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šåŠ¨æ€ä¼¸ç¼©ï¼Œå¹¶åœ¨åç¨‹é€€å‡ºæ—¶æ‰ä¼šè¢«é”€æ¯ã€‚\nç”±pprof heapç¡®å®šäº†å­˜åœ¨goroutineæ³„éœ²é—®é¢˜ï¼Œä½†æˆ‘ä»¬è¿˜ä¸çŸ¥é“æ­¤goroutineåœ¨ä½•å¤„å¯åŠ¨çš„ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬ç»§ç»­pprof goroutineã€‚\ngo tool pprof -seconds=10 \\ -http=:8081 \\ http://localhost:6060/debug/pprof/goroutines  ç°åœ¨é€šè¿‡ä¸Šè¿°callgraphæˆ‘ä»¬å¾ˆå®¹æ˜“å®šä½åˆ°goroutineæ˜¯åœ¨å“ªé‡Œå¯åŠ¨çš„äº†ï¼Œå›åˆ°æºç ä¸­è¿›ä¸€æ­¥ç¡®è®¤ï¼š\nvar ticker = time.NewTicker(time.Second) go func() { for { select { case \u0026lt;-ticker.C: // doSomething } } }() func somefunc(...) { ticker.Stop() }  åŸæ¥å½“å‰åç¨‹å› ä¸ºticker.Cè¿™ä¸ªchan readæ“ä½œé˜»å¡äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯time.Ticker.Stop()ä¹‹åï¼Œticker.Cè¿™ä¸ªchanä¸ä¼šè¢«å…³é—­ï¼Œæœ€å¥½åœ¨æ‰§è¡Œticker.Stop()çš„æ—¶å€™ï¼ŒåŒæ—¶è®¾ç½®ä¸€ä¸ªé€šçŸ¥chanï¼Œcloseè¯¥chanæ¥è¡¨ç¤ºtickeråœæ­¢ã€‚\nvar ticker = time.NewTicker(time.Second) var chdone = make(chan int, 1) go func() { for { select { case \u0026lt;-ticker.C: sa.read() case \u0026lt;- chdone: return } } }() func somefunc(...) { ticker.Stop() close(chdone) }  è¿™é‡Œä»‹ç»äº†pprofçš„ä½¿ç”¨æ–¹æ³•ï¼Œpprofæ˜¯æ¯ä¸ªgoå¼€å‘äººå‘˜éƒ½åº”è¯¥æŒæ¡çš„ã€‚å¸Œæœ›è¯»è€…å€ŸåŠ©è¿™é‡Œçš„ç¤ºä¾‹èƒ½å¸®åŠ©è¯»è€…äº†è§£pprofçš„æ“ä½œã€åˆ†æè¿‡ç¨‹ï¼Œè¾¾åˆ°çµæ´»è¿ç”¨çš„ç¨‹åº¦è¿˜éœ€è¦æ—¥å¸¸å¼€å‘å·¥ä½œä¸­å¤šå®è·µã€‚\nå€ŸåŠ©bccæ’æŸ¥ # pprofï¼šè¿™ä¸ªæˆ‘å¹²ä¸äº† # pprofå¯¹äºåˆ†æçº¯goç¨‹åºæ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼Œä½†æ˜¯å¯¹äºcgoæœ‰ç‚¹æ— èƒ½ä¸ºåŠ›ï¼Œcgoéƒ¨åˆ†çš„ä»£ç å·²ç»è·³å‡ºäº†goå†…å­˜åˆ†é…å™¨çš„èŒƒå›´ï¼Œé‡‡æ ·ä¹Ÿæ²¡ç”¨ï¼Œé‚£cgoéƒ¨åˆ†å‡ºç°å†…å­˜æ³„éœ²è¯¥å¦‚ä½•æ’æŸ¥å‘¢ï¼Ÿ\n è¦ç¡®å®šè¿›ç¨‹æ˜¯å¦å‡ºç°äº†å†…å­˜æ³„éœ²ï¼Œå¯ä»¥è§‚å¯Ÿè¿›ç¨‹è¿è¡ŒæœŸé—´çš„å†…å­˜å ç”¨æƒ…å†µï¼Œå¦‚å€ŸåŠ©topã€free -mï¼Œæˆ–è€…å…¶ä»–è¿ç»´å¹³å°çš„ç›‘æ§ç³»ç»Ÿï¼Œä¸€èˆ¬k8séƒ½é›†æˆäº†prometheuså¯¹å®¹å™¨è¿è¡Œæƒ…å†µè¿›è¡Œäº†ç›‘è§†ã€‚å¦‚æœå†…å­˜å ç”¨éšç€æ—¶é—´å»¶é•¿ä¸€ç›´å¢é•¿ï¼Œæ²¡æœ‰åœ¨åˆç†çš„å†…å­˜å ç”¨å€¼é™„è¿‘ç¨³å®šä¸‹æ¥ï¼Œæˆ–è€…å·²ç»å‡ºç°äº†oom killedã€å®¹å™¨é‡å¯çš„é—®é¢˜å‡ºç°ï¼Œåˆ™å¯ä»¥åˆæ­¥åˆ¤å®šè¿›ç¨‹å­˜åœ¨å†…å­˜æ³„éœ²ï¼› ç»§ç»­å€ŸåŠ©pprofå·¥å…·æ’æŸ¥goç¨‹åºï¼Œå¦‚æœpprofå¯ä»¥æ’æŸ¥å‡ºæ˜æ˜¾çš„å†…å­˜æ³„éœ²é—®é¢˜ï¼Œåˆ™å†…å­˜æ³„æ¼é—®é¢˜å¯èƒ½æ˜¯çº¯goéƒ¨åˆ†ä»£ç å¼•èµ·ï¼Œé‡‡ç”¨å‰é¢æè¿°çš„åˆ†æã€å®šä½æ–¹æ³•æ¥è§£å†³ï¼› å¦‚æœpprofå·¥å…·é‡‡æ ·ä¹‹åï¼Œæ²¡æœ‰å‘ç°æ˜æ˜¾çš„å†…å­˜æ³„éœ²çš„ç«¯å€ªï¼Œä¸”ç¨‹åºä¸­å­˜åœ¨cgoéƒ¨åˆ†çš„ä»£ç ï¼Œæ€€ç–‘cgoéƒ¨åˆ†çš„ä»£ç å­˜åœ¨å†…å­˜æ³„éœ²ï¼Œæ­¤æ—¶åˆ™éœ€å€ŸåŠ©å…¶ä»–æ‰‹æ®µï¼ˆpprofæ— èƒ½ä¸ºåŠ›äº†ï¼‰æ¥è¿›ä¸€æ­¥åˆ†æcgoéƒ¨åˆ†çš„å¯èƒ½å¼‚å¸¸ï¼›  åº“å‡½æ•°ï¼šhookåº“å‡½æ•° # è¦åˆ†æå†…å­˜æ˜¯å¦å­˜åœ¨æ³„æ¼ï¼Œä¹Ÿå¯ä»¥è€ƒè™‘è‡ªå·±hookä¸€ä¸‹åº“å‡½æ•°ï¼Œè‡ªå·±å®ç°è¿™ç§æˆ‘ä»¬å°±ä¸å±•å¼€è®¨è®ºäº†ã€‚è¿˜æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰è¶æ‰‹çš„å¥½å·¥å…·ï¼Œèƒ½å®å®åœ¨åœ¨åœ°ã€é è°±åœ°å¸®æˆ‘ä»¬è§£å†³å®é™…é—®é¢˜ï¼ˆå°½ç®¡è¶æ‰‹çš„å·¥å…·ä¹Ÿå¯èƒ½ä¹Ÿæ˜¯åŸºäºæŸç§hookçš„èƒ½åŠ›å®ç°çš„ï¼‰ã€‚\nKernelï¼šè°èƒ½é€ƒè„±æˆ‘çš„æ³•çœ¼ # å†…å­˜åˆ†é…æ“ä½œï¼Œä¸€èˆ¬ä¼šå€ŸåŠ©ä¸€äº›åº“å‡½æ•°æ¥å®Œæˆï¼Œå†…å­˜åˆ†é…å™¨ä¹Ÿä¼šåšä¸€äº›åˆ†é…ç®—æ³•çš„ä¼˜åŒ–ï¼Œè¿™é‡Œä¸å…³å¿ƒè¿™äº›ï¼Œæœ€ç»ˆçš„å†…å­˜ç”³è¯·æ“ä½œè¿˜æ˜¯è¦ç”±æ“ä½œç³»ç»Ÿæ¥ä»£åŠ³ï¼Œè€Œè¯·æ±‚å†…æ ¸æœåŠ¡çš„æ“ä½œåˆ™æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ã€‚\næ“ä½œç³»ç»Ÿæä¾›äº†ä¸€äº›æœåŠ¡ï¼Œå…è®¸å¯¹è¿è¡Œä¸­çš„è¿›ç¨‹è¿›è¡Œè§‚æµ‹ï¼Œä»¥Linuxä¸ºä¾‹ï¼Œå€ŸåŠ©ptraceç³»ç»Ÿè°ƒç”¨+PTRACE_SYSCALLï¼Œå…è®¸æˆ‘ä»¬å¯¹ä¸€ä¸ªè¿è¡Œä¸­çš„è¿›ç¨‹æ‰§è¡Œçš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè§‚æµ‹ï¼Œltraceã€straceå°±æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šå®ç°çš„ã€‚\neBPFï¼ˆextended BPFï¼‰çš„å‰è¾ˆæ˜¯BPFï¼ˆBerkeley Packet Filteringï¼‰ï¼ŒBPFæ˜¯ä¸€ä¸ªByteCode VMï¼Œå®ƒçš„æ•°æ®æ¨¡å‹é™åˆ¶äºpacketï¼Œç»å¸¸ç”¨æ¥åšä¸€äº›åŒ…åˆ†æï¼Œç»å…¸çš„å¦‚tcpdumpã€‚eBPFç›¸æ¯”BPFï¼Œå…¶æ•°æ®æ¨¡å‹ä¸å†å—é™äºå•ä¸€çš„packetï¼Œä¹Ÿä¸å†åªæ˜¯ç”¨æ¥åˆ†æpacketçš„å•ä¸€åŠŸèƒ½ï¼Œå¯ä»¥åˆ©ç”¨å®ƒå°†eBPF programæŒ‚åˆ°ä»»æ„çš„tracepointæˆ–è€…kprobeå»æ‰§è¡Œåˆ†æå¤„ç†ã€‚è¿™ä¸€ä¸‹å­æ‰“å¼€äº†eBPFçš„ä¸‡èŠ±ç­’ï¼Œä½¿å¾—èƒ½å¤Ÿå¯¹å†…æ ¸å„ä¸ªå­ç³»ç»Ÿåšè§‚æµ‹ã€åšæ€§èƒ½åˆ†æï¼Œç­‰ç­‰ã€‚\nå„ç§æµ‹é‡ã€æ€§èƒ½åˆ†æå·¥å…·ï¼ŒçœŸæ˜¯äº®çæˆ‘çš„çœ¼ç›ã€‚\nBCC (eBPF toolkit)ï¼šæµ‹é‡ã€æ€§èƒ½åˆ†æ # å¦‚ä½•åŸºäºeBPFå†™eBPF programæ¥å®Œæˆå¸Œæœ›çš„æµ‹é‡ã€åˆ†æå‘¢ï¼Œsee iovisor/bccï¼š\n BCC is a toolkit for creating efficient kernel tracing and manipulation programs, and includes several useful tools and examples. It makes use of extended BPF (Berkeley Packet Filters), formally known as eBPF, a new feature that was first added to Linux 3.15.\neBPF was described by Ingo MolnÃ¡r as:\n One of the more interesting features in this cycle is the ability to attach eBPF programs (user-defined, sandboxed bytecode executed by the kernel) to kprobes. This allows user-defined instrumentation on a live kernel image that can never crash, hang or interfere with the kernel negatively.\n BCC makes BPF programs easier to write, with kernel instrumentation in C (and includes a C wrapper around LLVM), and front-ends in Python and lua. It is suited for many tasks, including performance analysis and network traffic control.\n BCCç®—æ˜¯ä¸€ä¸ªå¼€å‘å¥—ä»¶ï¼Œåœ¨å®ƒåŸºç¡€ä¸Šå¼€å‘eBPF programä¼šæ›´ç®€å•ï¼Œè¯¥ä»“åº“å†…å½“å‰å·²ç»æ‹¥æœ‰äº†éå¸¸ä¸°å¯Œçš„æµ‹é‡ã€åˆ†æå·¥å…·ï¼Œå·¥å…·ä¹‹ä¸°å¯Œï¼Œåªå·®æˆ‘èƒ½ä¸èƒ½å…¨éƒ¨æŒæ¡äº†ï¼Œä¹Ÿæƒ³æˆä¸ºåƒBrendan Greggä¸€æ ·çš„æ€§èƒ½åˆ†æä¸“å®¶ã€‚\n Brendan Gregg: Understanding all the Linux tracers to make a rational decision between them a huge undertaking. (I may be the only person who has come close to doing this.)\n è‡³äºå¦‚ä½•å®ç°ä¸€ä¸ªBCCå·¥å…·ï¼Œåˆ™éå¸¸ç®€å•ï¼Œå®é™…ä¸Šå°±æ˜¯å†™ä¸€ä¸ªpythonæ–‡ä»¶ï¼Œå†…éƒ¨ä¸€ä¸ªå­—ç¬¦ä¸²åŒ…å«ä¸€ä¸ªcç¨‹åºï¼Œcç¨‹åºå†…è°ƒç”¨å°è£…çš„eBPF APIï¼Œçœ‹ä¸€ä¸ªç®€å•çš„demoï¼š\n#file: hello-open-world-1.py from bcc import BPF program = \u0026quot;\u0026quot;\u0026quot; #include \u0026lt;asm/ptrace.h\u0026gt; // for struct pt_regs #include \u0026lt;linux/types.h\u0026gt; // for mode_t int kprobe__sys_open(struct pt_regs *ctx, char __user* pathname, int flags, mode_t mode) { bpf_trace_printk(\u0026quot;sys_open called.\\\\n\u0026quot;); return 0; } \u0026quot;\u0026quot;\u0026quot; b = BPF(text=program) b.trace_print()  è¿è¡Œå®ƒï¼š\n$ sudo python hello-open-world-1.py  OKï¼ŒBCCå¥—ä»¶é‡Œé¢æä¾›äº†å·¥å…·memleakï¼Œç”¨æ¥å¯¹å†…å­˜æ³„éœ²è¿›è¡Œåˆ†æï¼Œä¸‹é¢ç»“åˆä¸€ä¸ªcgoå†…å­˜æ³„éœ²çš„ç¤ºä¾‹åˆ†æï¼Œæ¥äº†è§£ä¸‹å¦‚ä½•æ˜¯ä½¿ç”¨ã€‚\nå»ºè®®èƒ½èŠ±ç‚¹æ—¶é—´äº†è§£ä¸‹linux tracing systemsï¼Œsee linux tracing systems \u0026amp; how they fit together ï¼Œç†æ¸…ä¸‹kprobe/uprobe/dtrace probes/kernel tracepointsçš„å«ä¹‰åŠå·¥ä½œåŸç†ï¼Œè¿›è€Œæ‰èƒ½è®¤è¯†åˆ°eBPFçš„å¼ºå¤§ä¹‹å¤„ï¼Œä¸å†å±•å¼€äº†ï¼Œçœ‹ä¸ªç¤ºä¾‹ã€‚\nBCCï¼šå†…å­˜æ³„éœ²ç¤ºä¾‹ # ä¸‹é¢å…ˆçœ‹ä¸€ä¸ªcgoç¤ºä¾‹å·¥ç¨‹æ˜¯å¦‚ä½•ç»„ç»‡çš„ï¼Œç¤ºä¾‹é¡¹ç›®å–è‡ªhttps://github.com/2Dou/cgo-exampleï¼Œæ‚¨å¯ä»¥ç›´æ¥ä»è¿™é‡Œä¸‹è½½ã€‚\nc-so/ â”œâ”€â”€ Makefile â”œâ”€â”€ add â”‚Â â”œâ”€â”€ Makefile â”‚Â â”œâ”€â”€ add.go â”‚Â â””â”€â”€ src â”‚Â â”œâ”€â”€ add.c â”‚Â â””â”€â”€ add.h â””â”€â”€ main.go  ä¸Šè¿°å·¥ç¨‹ä¸­ï¼Œadd/src/ä¸‹add.h/add.cå®ç°äº†ä¸€ä¸ªaddå‡½æ•°ï¼Œadd/add.goä¸­å®šä¹‰äº†å¯å¯¼å‡ºçš„å‡½æ•°Add(a, b int) intï¼Œå†…éƒ¨é€šè¿‡cgoè°ƒç”¨srcä¸‹å®šä¹‰çš„int add(int, int)ï¼Œadd/Makefileå°†æŠŠaddä¸‹çš„æºæ–‡ä»¶æ•´ä¸ªç¼–è¯‘æ„å»ºæ‰“åŒ…æˆä¸€ä¸ªå…±äº«åº“æ–‡ä»¶libadd.soï¼Œä¾›c-so/main.goè°ƒç”¨ã€‚\nc-so/main.goå¼•ç”¨ç›®å½•addä¸‹å®šä¹‰çš„package addä¸­çš„Addå‡½æ•°ï¼Œc-so/Makefileåªæ˜¯ç®€å•çš„go buildç¼–è¯‘åŠ¨ä½œï¼Œç¼–è¯‘å®Œæˆå./c-soè¿è¡Œä¼šæç¤ºåº“æ–‡ä»¶libadd.soä¸å­˜åœ¨ï¼Œè¿™æ˜¯å› ä¸ºåº“è·¯å¾„åŠ è½½é—®é¢˜ï¼Œæ‰§è¡ŒLD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd -p) ./c-soå³å¯ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œã€‚\nOKï¼Œç°åœ¨ç®€å•åœ°ç¯¡æ”¹ä¸‹src/add.cï¼Œå°†å…¶å†…å®¹ä¿®æ”¹å¦‚ä¸‹ï¼Œæ’å…¥äº†ä¸€æ®µä¸åœç”³è¯·å†…å­˜çš„ä»£ç ï¼š\n#include \u0026quot;add.h\u0026quot; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; int add(int a, int b) { /******* insert memory leakage start ********/ int i = 0; int max = 0x7fffffff; for (; i\u0026lt;max; i++) { int *p = (int *)malloc(sizeof(int) * 8); sleep(1); if (i % 2 == 0) { free(p) } } /******* insert memory leakage end ********/ return a+b; }  ç°åœ¨é‡æ–°æ‰§è¡Œmakeç¼–è¯‘ä¹‹åï¼Œå†æ¬¡è¿è¡Œï¼Œç¨‹åºä¸æ–­åœ°mallocä½†æ˜¯ä»æ¥ä¸freeï¼Œå†…å­˜ä¸€ç‚¹ç‚¹è¢«æ³„éœ²ï¼Œç°åœ¨æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å€ŸåŠ©memleakåˆ†æå†…å­˜æ³„éœ²çš„ä½ç½®ï¼š\n$ /usr/share/bcc/tools/memleak -p $(pid of c-so)  è¿è¡Œä¸€æ®µæ—¶é—´ä»¥åï¼ŒmemleakæŠ¥å‘Šäº†å†…å­˜åˆ†é…çš„æƒ…å†µï¼Œæ˜¾ç¤ºçš„æ˜¯â€œtop10çš„è¿˜æ²¡æœ‰é‡Šæ”¾çš„å†…å­˜åˆ†é…â€çš„ä½ç½®ä¿¡æ¯ï¼š\n Trace outstanding memory allocations that weren\u0026rsquo;t freed.\nSupports both user-mode allocations made with libc functions and kernel-mode allocations made with kmalloc/kmem_cache_alloc/get_free_pages and corresponding memory release functions.\n ä»memleakæŠ¥å‘Šçš„æœ€åä¸€æ¡ä¿¡æ¯æ¥çœ‹ï¼š\n c-soè¿™ä¸ªç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨äº†å…±äº«åº“libadd.soä¸­çš„addå‡½æ•°ï¼› è¿™ä¸ªaddå‡½æ•°æ‰§è¡Œäº†345+æ¬¡å†…å­˜åˆ†é…æ“ä½œï¼Œæ¯æ¬¡ç”³è¯·sizeof(int)*8 bytesï¼Œæ€»å…±åˆ†é…äº†11048æ¬¡å†…å­˜ï¼› å†…å­˜åˆ†é…mallocæ“ä½œçš„ä½ç½®å¤§çº¦å°±æ˜¯addå‡½æ•°èµ·å§‹å¤„+0x28çš„æŒ‡ä»¤ä½ç½®ï¼Œå¯ä»¥é€šè¿‡objdump -dS libadd.soæ±‚è¯ã€‚  ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…å­˜åˆ†é…çš„ä½ç½®ã€æ¬¡æ•°ã€å†…å­˜æ•°é‡ï¼Œä½†æ˜¯è¿™ä¸ªæŠ¥å‘Šä¸­æŠ¥é“çš„å¹¶éå®é™…æ³„éœ²çš„å†…å­˜æ•°é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¹Ÿæœ‰freeï¼Œæ€ä¹ˆæ²¡æœ‰ç»Ÿè®¡åˆ°å‘¢ï¼Ÿè¿è¡Œmemleak -hæŸ¥çœ‹ä¸‹æœ‰å“ªäº›é€‰é¡¹å§ï¼\n$ /usr/share/bcc/tools/memleak -p $(pid of c-so) -t  ç°åœ¨å¯ä»¥çœ‹åˆ°æŠ¥å‘Šä¿¡æ¯ä¸­åŒ…å«äº†alloc entered/exitedï¼Œfree entered/exitedï¼Œå¯ä»¥æ–­å®šmemleakä¹Ÿè·Ÿè¸ªäº†å†…å­˜é‡Šæ”¾ï¼Œä½†æ˜¯è¿™é‡Œçš„æŠ¥å‘Šè¿˜æ˜¯ä¸å¤Ÿç›´è§‚ï¼Œèƒ½å¦ç›´æ¥æ˜¾ç¤ºæ³„éœ²çš„å†…å­˜ä¿¡æ¯å‘¢ï¼Ÿå¯ä»¥ä½†æ˜¯è¦ç¨å¾®ä¿®æ”¹ä¸‹ï¼Œä¸‹é¢çœ‹ä¸‹å®ç°ï¼Œä½ ä¼šå‘ç°ç°æœ‰çš„æŠ¥å‘Šä¿¡æ¯ä¹Ÿä¸å¦¨ç¢åˆ†æã€‚\nbcc/memleakå®ç° # ä¸çœ‹ä¸‹æºç ï¼Œæ€»æ„Ÿè§‰å¿ƒé‡Œæœ‰ç‚¹è™šï¼Œçœ‹ä¸‹memleakè¿™ä¸ªeBPF programä¸­çš„éƒ¨åˆ†é€»è¾‘ï¼š\nè·Ÿè¸ªmallocï¼š\nint malloc_enter(struct pt_regs *ctx, size_t size) \\-\u0026gt; static inline int gen_alloc_enter(struct pt_regs *ctx, size_t size) : å†…éƒ¨ä¼šæ›´æ–°è¢«è§‚æµ‹è¿›ç¨‹å·²åˆ†é…çš„å†…å­˜æ•°é‡ï¼ˆsizesè®°å½•ï¼‰ int malloc_exit(struct pt_regs *ctx) \\-\u0026gt; static inline int gen_alloc_exit(struct pt_regs *ctx) \\-\u0026gt; static inline int gen_alloc_exit2(struct pt_regs *ctx, u64 address) ï¼šå†…éƒ¨ä¼šè®°å½•å½“å‰ç”³è¯·çš„å†…å­˜åœ°å€ï¼ˆallocsè®°å½•ï¼‰ \\-\u0026gt; stack_traces.get_stackid(ctx, STACK_FLAGS) ï¼šè®°å½•å½“å‰å†…å­˜åˆ†é…åŠ¨ä½œçš„è°ƒç”¨æ ˆä¿¡æ¯ï¼ˆallocsä¸­è®°å½•ï¼‰  è·Ÿè¸ªfreeï¼š\nint free_enter(struct pt_regs *ctx, void *address) \\-\u0026gt; static inline int gen_free_enter(struct pt_regs *ctx, void *address) ï¼šä»allocsä¸­åˆ é™¤å·²ç»é‡Šæ”¾çš„å†…å­˜åœ°å€  memleakå‘¨æœŸæ€§åœ°å¯¹allocsè¿›è¡Œæ’åºï¼Œå¹¶æŒ‰ç…§sizesåˆ†é…å†…å­˜å¤šå°‘é™åºæ’åˆ—æ‰“å°å‡ºæ¥ï¼Œå› ä¸ºmemleakåŒæ—¶è·Ÿè¸ªäº†mallocã€freeï¼Œæ‰€ä»¥ä¸€æ®µæ—¶é—´åï¼Œå‘¨æœŸæ€§æ‰“å°çš„å†…å­˜åˆ†é…è°ƒç”¨æ ˆä½ç½®ï¼Œå³å¯ä»¥è®¤ä¸ºæ˜¯æ²¡æœ‰é‡Šæ”¾æ‰ï¼ˆæ³„éœ²æ‰ï¼‰çš„å†…å­˜åˆ†é…ä½ç½®ã€‚\nå€ŸåŠ©pmap/gdbæ’æŸ¥ # è¿™ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ’æŸ¥æ–¹å¼ï¼Œåœ¨æ’æŸ¥å†…å­˜æ³„éœ²é—®é¢˜æ—¶ï¼Œæ ¹æ®å®é™…æƒ…å†µï¼ˆæ¯”å¦‚ç¯å¢ƒé—®é¢˜æ— æ³•å®‰è£…goï¼Œbccä¹‹ç±»åˆ†æå·¥å…·ç­‰ç­‰ï¼‰ç”šè‡³å¯è€ƒè™‘å…ˆé€šè¿‡pmapè¿™ç§æ–¹å¼æ¥åˆ†æä¸€ä¸‹ã€‚æ€»ä¹‹ï¼Œçµæ´»é€‰æ‹©åˆé€‚çš„æ–¹å¼å§ã€‚\nå†…å­˜åŠpmapåŸºç¡€ # è¿›ç¨‹ä¸­çš„å†…å­˜åŒºåŸŸåˆ†ç±»å¯ä»¥æŒ‰ä¸‹é¢å‡ ä¸ªç»´åº¦æ¥åˆ’åˆ†ï¼Œå¦‚æœå¯¹è¿™ä¸ªä¸ç†Ÿï¼Œå»ºè®®å‚è€ƒä»¥ä¸‹æ–‡ç« ï¼Œsee:\n Memory Types Understanding Process Memory Managing Memory      Private Shared     Anonymous stack\nmalloc\nmmap(anon+private)\nbrk/sbrk mmap(anon+shared)   File-backed mmap(fd, private)\nbinary/shared libraries mmap(fd, shared)    å€ŸåŠ©pmapå¯ä»¥æŸ¥çœ‹è¿›ç¨‹å†…å­˜ç©ºé—´åˆ†å¸ƒæƒ…å†µï¼ŒåŒ…æ‹¬åœ°å€èŒƒå›´ã€å¤§å°ã€å†…å­˜æ˜ å°„æƒ…å†µï¼Œå¦‚ï¼š\n$ pmap -p \u0026lt;pid\u0026gt; # /proc/\u0026lt;pid\u0026gt;/maps 3009: ./blah 0000000000400000 4K r-x-- /home/fruneau/blah 0000000000401000 4K rw--- /home/fruneau/blah 00007fbb5da87000 51200K rw-s- /dev/zero (deleted) 00007fbb60c87000 1536K r-x-- /lib/x86_64-linux-gnu/libc-2.13.so 00007fbb60e07000 2048K ----- /lib/x86_64-linux-gnu/libc-2.13.so 00007fbb61007000 16K r---- /lib/x86_64-linux-gnu/libc-2.13.so 00007fbb6100b000 4K rw--- /lib/x86_64-linux-gnu/libc-2.13.so 00007fbb6100c000 20K rw--- [ anon ] 00007fbb61011000 128K r-x-- /lib/x86_64-linux-gnu/ld-2.13.so 00007fbb61221000 12K rw--- [ anon ] 00007fbb6122e000 8K rw--- [ anon ] 00007fbb61230000 4K r---- /lib/x86_64-linux-gnu/ld-2.13.so 00007fbb61231000 4K rw--- /lib/x86_64-linux-gnu/ld-2.13.so 00007fbb61232000 4K rw--- [ anon ] 00007fff9350f000 132K rw--- [ stack ] 00007fff9356e000 4K r-x-- [ anon ] ffffffffff600000 4K r-x-- [ anon ] total 55132K  $ pmap -x -p \u0026lt;pid\u0026gt; # /proc/\u0026lt;pid\u0026gt;/smaps Address Kbytes RSS Dirty Mode Mapping 0000000000400000 4 4 4 r-x-- blah 0000000000401000 4 4 4 rw--- blah 00007fc3b50df000 51200 51200 51200 rw-s- zero (deleted) 00007fc3b82df000 1536 188 0 r-x-- libc-2.13.so 00007fc3b845f000 2048 0 0 ----- libc-2.13.so 00007fc3b865f000 16 16 16 r---- libc-2.13.so 00007fc3b8663000 4 4 4 rw--- libc-2.13.so 00007fc3b8664000 20 12 12 rw--- [ anon ] 00007fc3b8669000 128 108 0 r-x-- ld-2.13.so 00007fc3b8879000 12 12 12 rw--- [ anon ] 00007fc3b8886000 8 8 8 rw--- [ anon ] 00007fc3b8888000 4 4 4 r---- ld-2.13.so 00007fc3b8889000 4 4 4 rw--- ld-2.13.so 00007fc3b888a000 4 4 4 rw--- [ anon ] 00007fff7e6ef000 132 12 12 rw--- [ stack ] 00007fff7e773000 4 4 0 r-x-- [ anon ] ffffffffff600000 4 0 0 r-x-- [ anon ] ---------------- ------ ------ ------ total kB 55132 51584 51284  ä¸Šè¿°å‘½ä»¤åªæ˜¯è¾“å‡ºä¿¡æ¯çš„è¯¦ç»†ç¨‹åº¦ä¸åŒï¼Œåœ¨æˆ‘ä»¬ç†è§£äº†è¿›ç¨‹çš„å†…å­˜ç±»å‹ã€pmapçš„ä½¿ç”¨ä¹‹åï¼Œå°±å¯ä»¥å¯¹å‘ç”Ÿå†…å­˜æ³„éœ²çš„ç¨‹åºè¿›è¡Œä¸€å®šçš„åˆ†æã€‚\næ’æŸ¥ç¤ºä¾‹ï¼šç”¨ä¾‹å‡†å¤‡ # æ¯”å¦‚ç°åœ¨å†™ä¸€ä¸ªæµ‹è¯•ç”¨çš„ç¨‹åºï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\nleaks |-- conf | `-- load.go |-- go.mod |-- leaks |-- main.go `-- task `-- load.go  file: main.goï¼Œè¯¥æ–‡ä»¶å¯åŠ¨confã€taskä¸‹çš„ä¸¤ä¸ªé€»è¾‘ï¼Œconf.LoadConfigä¸­å¯åŠ¨ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡ç”³è¯·1KBå†…å­˜å¹¶å…¨éƒ¨è®¾ç½®ä¸ºå­—ç¬¦Cï¼Œtask.NewTaskå¯åŠ¨ä¸€ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡ç”³è¯·1KBå†…å­˜å¹¶è®¾ç½®ä¸ºå­—ç¬¦Tã€‚ conf.LoadConfigå¾ªç¯ä½“æ¯æ¬¡è¿­ä»£é—´éš”1sï¼Œtask.NewTaskå¾ªç¯ä½“æ¯æ¬¡è¿­ä»£é—´éš”2sã€‚\npackage main import ( \u0026quot;leaks/conf\u0026quot; \u0026quot;leaks/task\u0026quot; ) func main() { conf.LoadConfig(\u0026quot;aaa\u0026quot;) task.NewTask(\u0026quot;bbb\u0026quot;) select {} }  file: conf/load.go:\npackage conf import ( \u0026quot;time\u0026quot; ) type Config struct { A string B string C string } func LoadConfig(fp string) (*Config, error) { kb := 1 \u0026lt;\u0026lt; 10 go func() { for { p := make([]byte, kb, kb) for i := 0; i \u0026lt; kb; i++ { p[i] = 'C' } time.Sleep(time.Second * 1) println(\u0026quot;conf\u0026quot;) } }() return \u0026amp;Config{}, nil }  file: task/load.go\npackage task import ( \u0026quot;time\u0026quot; ) type Task struct { A string B string C string } func NewTask(name string) (*Task, error) { kb := 1 \u0026lt;\u0026lt; 10 // start async process go func() { for { p := make([]byte, kb, kb) for i := 0; i \u0026lt; kb; i++ { p[i] = 'T' } time.Sleep(time.Second * 2) println(\u0026quot;task\u0026quot;) } }() return \u0026amp;Task{}, nil }  ç„¶åç¼–è¯‘æ„å»º go build è¾“å‡ºå¯æ‰§è¡Œæ–‡ä»¶ leaksï¼Œå¤§å®¶å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œæˆ‘è¿™æ ·çš„å†™æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ï¼Œæ˜¯ä¼šè¢«garbage collectorå›æ”¶æ‰çš„ï¼Œé¡¶å¤šæ˜¯å›æ”¶å¿«æ…¢è€Œå·²ã€‚\næ˜¯çš„ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è§£é‡Špmapæ’æŸ¥æ–¹æ³•çš„è¿ç”¨ï¼Œæˆ‘ä»¬å‡å®šè¿™é‡Œçš„å†…å­˜æ³„éœ²æ‰äº†ï¼Œæ€ä¹ˆä¸ªå‡å®šæ³•å‘¢ï¼Ÿæˆ‘ä»¬å…³é—­gcï¼Œè¿è¡Œç¨‹åºçš„æ—¶å€™ GOGC=off ./leaks.\nä½ å¯ä»¥ç”¨ top -p $(pidof leaks) éªŒè¯ä¸‹RSSé£æ¶¨ã€‚\næ’æŸ¥ç¤ºä¾‹ï¼šæœç´¢å¯ç–‘å†…å­˜åŒº # æ¯”å¦‚ï¼Œä½ å‘ç°æœ‰æ®µanonå†…å­˜åŒºåŸŸï¼Œå®ƒçš„å ç”¨å†…å­˜æ•°é‡åœ¨å¢åŠ ï¼Œæˆ–è€…è¿™æ ·çš„åŒºæ®µæ•°é‡å†å¢åŠ ï¼ˆå¯ä»¥å¯¹æ¯”å‰åä¸¤æ¬¡çš„pmapè¾“å‡ºæ¥å‘ç°ï¼‰:\n$ pmap -x $(pidof leaks) \u0026gt; 1.txt $ pmap -x $(pidof leaks) \u0026gt; 2.txt 86754: ./leaks/leaks 86754: ./leaks/leaks Address Kbytes RSS Dirty Mode Mapping Address Kbytes RSS Dirty Mode Mapping 0000000000400000 372 372 0 r-x-- leaks 0000000000400000 372 372 0 r-x-- leaks 000000000045d000 496 476 0 r---- leaks 000000000045d000 496 476 0 r---- leaks 00000000004d9000 16 16 16 rw--- leaks 00000000004d9000 16 16 16 rw--- leaks 00000000004dd000 176 36 36 rw--- [ anon ] 00000000004dd000 176 36 36 rw--- [ anon ] 000000c000000000 131072 98508 98508 rw--- [ anon ] | 000000c000000000 131072 104652 104652 rw--- [ anon ] 00007f26010ad000 39816 3236 3236 rw--- [ anon ] | 00007f26010ad000 39816 3432 3432 rw--- [ anon ] 00007f260378f000 263680 0 0 ----- [ anon ] 00007f260378f000 263680 0 0 ----- [ anon ] 00007f261390f000 4 4 4 rw--- [ anon ] 00007f261390f000 4 4 4 rw--- [ anon ] 00007f2613910000 293564 0 0 ----- [ anon ] 00007f2613910000 293564 0 0 ----- [ anon ] 00007f26257bf000 4 4 4 rw--- [ anon ] 00007f26257bf000 4 4 4 rw--- [ anon ] 00007f26257c0000 36692 0 0 ----- [ anon ] 00007f26257c0000 36692 0 0 ----- [ anon ] 00007f2627b95000 4 4 4 rw--- [ anon ] 00007f2627b95000 4 4 4 rw--- [ anon ] 00007f2627b96000 4580 0 0 ----- [ anon ] 00007f2627b96000 4580 0 0 ----- [ anon ] 00007f262800f000 4 4 4 rw--- [ anon ] 00007f262800f000 4 4 4 rw--- [ anon ] 00007f2628010000 508 0 0 ----- [ anon ] 00007f2628010000 508 0 0 ----- [ anon ] 00007f262808f000 384 44 44 rw--- [ anon ] 00007f262808f000 384 44 44 rw--- [ anon ] 00007ffcdd81c000 132 12 12 rw--- [ stack ] 00007ffcdd81c000 132 12 12 rw--- [ stack ] 00007ffcdd86d000 12 0 0 r---- [ anon ] 00007ffcdd86d000 12 0 0 r---- [ anon ] 00007ffcdd870000 8 4 0 r-x-- [ anon ] 00007ffcdd870000 8 4 0 r-x-- [ anon ] ffffffffff600000 4 0 0 r-x-- [ anon ] ffffffffff600000 4 0 0 r-x-- [ anon ] ---------------- ------- ------- ------- ---------------- ------- ------- ------- total kB 771528 102720 101868 | total kB 771528 109060 108208  æˆ‘ä»¬æ³¨æ„åˆ°èµ·å§‹åœ°å€ä¸º000000c000000000 å’Œ 00007f26010ad000çš„åŒºé—´ï¼ŒRSSå†…å­˜æ•°é‡æ¶¨äº†ï¼Œè¿™è¯´æ˜è¿™é‡Œç‰©ç†å†…å­˜å ç”¨å¢åŠ äº†ï¼Œåœ¨æ˜ç¡®ç¨‹åºå­˜åœ¨å†…å­˜æ³„éœ²çš„å‰æä¸‹ï¼Œè¿™æ ·çš„å†…å­˜åŒºåŸŸå¯ä»¥ä½œä¸ºå¯ç–‘å†…å­˜åŒºå»åˆ†æä¸€ä¸‹ã€‚æˆ–è€…ï¼Œæ˜¯æœ‰è¿ç»­çš„å¤§å†…å­˜åŒºå—ï¼Œä¹Ÿæ˜¯å¾…åˆ†æçš„å¯ç–‘å¯¹è±¡ï¼Œæˆ–è€…è¿™æ ·çš„å†…å­˜åŒºå—æ•°é‡æ¯”è¾ƒå¤šï¼Œä¹Ÿåº”è¯¥ä½œä¸ºå¯ç–‘çš„åˆ†æå¯¹è±¡ã€‚\næ‰¾åˆ°å¯ç–‘å†…å­˜åŒºåŸŸä¹‹åï¼Œå°±å°è¯•é‡Œé¢çš„å†…å®¹å¯¼å‡ºï¼Œå¯¼å‡ºåå†å€ŸåŠ©stringsã€hexdumpç­‰å·¥å…·è¿›è¡Œåˆ†æï¼Œé€šå¸¸ä¼šæ‰“å°å‡ºä¸€äº›å­—ç¬¦ä¸²ç›¸å…³çš„ä¿¡æ¯ï¼Œä¸€èˆ¬è¿™äº›ä¿¡æ¯ä¼šå¸®æˆ‘ä»¬è”æƒ³èµ·ï¼Œè¿™äº›æ•°æ®å¤§çº¦å¯¹åº”ç€ç¨‹åºä¸­çš„å“ªäº›æ•°æ®ç»“æ„ã€ä»£ç é€»è¾‘ã€‚\nå…ˆæ‰§è¡Œ gdb -p $(pidof leaks) attach ç›®æ ‡è¿›ç¨‹ï¼Œç„¶åæ‰§è¡Œä¸‹é¢ä¸¤æ¡å‘½ä»¤å¯¼å‡ºå¯ç–‘å†…å­˜åŒºï¼š\ngdb\u0026gt; dump binary memory leaks.p1 0x000000c000000000 0x000000c000000000+131072*1024 gdb\u0026gt; dump binary memory leaks.p2 0x00007f26010ad000 0x00007f26010ad000+39816*1024  ç„¶åå°è¯•ç”¨stringsæˆ–è€…hexdump\n$ strings leaks.p1 ... e[0;34m\\]\\W\\[$(git_color)\\]$(git_branch) \\[\\e[0;37m\\]$\\[\\e[0m\\] SXPFD EXPF e[0;34m\\]\\W\\[$(git_color)\\]$(git_branch) \\[\\e[0;37m\\]$\\[\\e[0m\\] SXPFD EXPF TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT...CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC...TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT....CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC...TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC...TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC...TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT ...  or\n$ hexdump -C leaks.p1 ... 0008e030 00 00 00 00 00 00 00 00 08 9d f0 00 35 43 00 00 |............5C..| 0008e040 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................| 0008e050 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................| * 00090000 00 e0 08 00 c0 00 00 00 00 00 00 00 00 00 00 00 |................| 00090010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 |................| * 00100000 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 |TTTTTTTTTTTTTTTT| * 00200000 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 |CCCCCCCCCCCCCCCC| * 00400000 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 |TTTTTTTTTTTTTTTT| * 00500000 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 |CCCCCCCCCCCCCCCC| * 00700000 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 |TTTTTTTTTTTTTTTT| * 00800000 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 |CCCCCCCCCCCCCCCC| * 00a00000 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 |TTTTTTTTTTTTTTTT| * 00b00000 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 |CCCCCCCCCCCCCCCC| * 00d00000 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 |TTTTTTTTTTTTTTTT| * 00e00000 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 43 |CCCCCCCCCCCCCCCC| * 01000000 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 54 |TTTTTTTTTTTTTTTT| * ...  é€šè¿‡è¿™é‡Œçš„è¾“å‡ºï¼Œå‡å®šè¿™é‡Œçš„è¾“å‡ºçš„ä¸€äº›å­—ç¬¦ä¸²ä¿¡æ¯CCCCCCC or TTTTTTTTTæ˜¯ä¸€äº›æ›´æœ‰æ„ä¹‰çš„ä¿¡æ¯ï¼Œé‚£å®ƒå¯èƒ½å¸®åŠ©æˆ‘ä»¬å’Œç¨‹åºä¸­çš„ä¸€äº›æ•°æ®ç»“æ„ã€ä»£ç é€»è¾‘å»ºç«‹èµ·è”ç³»ï¼Œæ¯”å¦‚çœ‹åˆ°è¿™é‡Œçš„å­—ç¬¦ä¸²Cï¼Œå°±æƒ³åˆ°äº†é…ç½®åŠ è½½conf.LoadConfigï¼Œçœ‹åˆ°å­—ç¬¦ä¸²Tï¼Œå°±æƒ³åˆ°äº†task.NewTaskï¼Œç„¶åè¿›å»è¿½æŸ¥ä¸€ä¸‹ä¸€èˆ¬ä¹Ÿèƒ½å®šä½åˆ°é—®é¢˜æ‰€åœ¨ã€‚\nä½¿ç”¨ gcoreè½¬å‚¨æ•´ä¸ªè¿›ç¨‹ï¼ŒåŸç†ç±»ä¼¼ï¼Œgcoreä¼šåœ¨è½¬å‚¨å®Œåç«‹å³detachè¿›ç¨‹ï¼Œæ¯”æ‰‹åŠ¨dumpé€Ÿåº¦å¿«ï¼Œå¯¹tracedè¿›ç¨‹çš„å½±å“æ—¶é—´çŸ­ï¼Œä½†æ˜¯è½¬å‚¨æ–‡ä»¶ä¸€èˆ¬æ¯”è¾ƒå¤§ï¼ˆè®°å¾—ulimit -cè®¾ç½®ä¸‹ï¼‰ï¼Œcoreæ–‡ä»¶ä½¿ç”¨hexdumpåˆ†æçš„æ—¶å€™ä¹Ÿå¯ä»¥é€‰æ‹©æ€§è·³è¿‡ä¸€äº›å­—èŠ‚ï¼Œä»¥åˆ†ææ„Ÿå…´è¶£çš„å¯ç–‘å†…å­˜åŒºã€‚\nå…¶ä»–æ–¹å¼ # å†…å­˜æ³„éœ²çš„æ’æŸ¥æ–¹å¼æœ‰å¾ˆå¤šï¼Œå·¥å…·ä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚æ¯”è¾ƒæœ‰åçš„valgrindï¼Œä½†æ˜¯æˆ‘æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œvalgrindæ²¡æœ‰åƒbccé‚£æ ·ç²¾ç¡®åœ°å®šä½åˆ°å†…å­˜æ³„éœ²çš„ä½ç½®ï¼Œå¯èƒ½æ˜¯æˆ‘çš„ä½¿ç”¨æ–¹å¼æœ‰é—®é¢˜ã€‚see debugging cgo memory leaksï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±ç ”ç©¶ä¸‹ã€‚è¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚\næ€»ç»“ # æœ¬æ–‡ä»‹ç»äº†å†…å­˜æ³„éœ²ç›¸å…³çš„å®šä½åˆ†ææ–¹æ³•ï¼Œè™½ç„¶æ˜¯é¢å‘goå¼€å‘ä»‹ç»çš„ï¼Œä½†æ˜¯ä¹Ÿä¸å±€é™äºgoï¼Œç‰¹åˆ«æ˜¯ebpf-memleakçš„åº”ç”¨ï¼Œåº”ç”¨é¢åº”è¯¥ä¼šæ¯”è¾ƒå¹¿ã€‚eBPFå¯¹Linuxå†…æ ¸ç‰ˆæœ¬æ˜¯æœ‰ä¸¥æ ¼è¦æ±‚çš„ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦æ³¨æ„ï¼ŒeBPFçš„ä¼˜åŠ¿åœ¨äºå®ƒä¸ºè§‚æµ‹ã€æµ‹é‡æä¾›äº†å¼ºå¤§çš„åŸºç¡€æ”¯æŒï¼Œæ‰€ä»¥bccæ‰ä¼šæœ‰é‚£ä¹ˆå¤šçš„åˆ†æå·¥å…·ï¼Œæ˜¯ä¸å¯å¤šå¾—åˆ©å™¨ã€‚\næœ¬æ–‡ä¹Ÿç®—æ˜¯è‡ªå·±å¯¹eBPFçš„ä¸€ä¸ªåˆæ­¥å°è¯•å§ï¼Œå¸Œæœ›æŒæ¡å®ƒå¯¹è‡ªå·±ä»¥åçš„å·¥ä½œæœ‰å¸®åŠ©ã€‚å¼€å‘äººå‘˜æ‰‹ä¸Šå¯ä»¥ç”¨çš„å·¥å…·ä¸å°‘ï¼Œä½†æ˜¯çœŸçš„å¥½ç”¨ã€çœå¿ƒçš„ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤šï¼Œå¦‚æœèƒ½bccä¸€è¡Œä»£ç å®šä½åˆ°ä½ç½®ï¼Œæˆ‘æƒ³æˆ‘ä¹Ÿä¸ä¼šæ„¿æ„pmapã€gdb gcoreã€gdb dumpã€strings+hexdump\u0026hellip;æ¥åˆ†æå†…å­˜æ³„éœ²ä½ç½®ï¼Œå½“ç„¶å¦‚æœæƒ…å†µä¸å…è®¸ï¼Œæ¯”å¦‚å†…æ ¸ç‰ˆæœ¬ä¸æ”¯æŒbccï¼Œé‚£è¿˜æ˜¯çµæ´»é€‰æ‹©åˆé€‚çš„æ–¹å¼ã€‚\né™¤äº†æŒæ¡ä¸Šè¿°åˆ†ææ–¹æ³•ï¼Œè§£å†³å·²ç»å¼•å…¥çš„å†…å­˜æ³„éœ²é—®é¢˜ï¼Œç ”å‘æµç¨‹ä¸Šä¹Ÿåº”è¯¥å¤šå…³æ³¨ä¸Šçº¿å‰æµ‹è¯•ã€CRç­‰åŸºç¡€çš„è§„èŒƒï¼Œå°½é‡å°†ä¸€äº›é—®é¢˜å‰ç½®ï¼Œæ—©å‘ç°æ—©è§£å†³ã€‚\nå‚è€ƒå†…å®¹ #  memory leaking, https://go101.org/article/memory-leaking.html golang memory leaks, https://yuriktech.com/2020/11/07/Golang-Memory-Leaks/#:~:text=A%20goroutine%20leak%20happens%20when,an%20out%20of%20memory%20exception. finding memory leak in cgo, https://kirshatrov.com/2019/11/04/finding-memory-leak-in-cgo/ dive-into-bpf, https://qmonnet.github.io/whirl-offload/2016/09/01/dive-into-bpf/ introduction to xdp and ebpf, https://blogs.igalia.com/dpino/2019/01/07/introduction-to-xdp-and-ebpf/ debugging cgo memory leaks, https://www.youtube.com/watch?v=jiSWxpcuGPw choosing a linux tracer, http://www.brendangregg.com/blog/2015-07-08/choosing-a-linux-tracer.html taming tracepoints in the linux kernel, https://blogs.oracle.com/linux/taming-tracepoints-in-the-linux-kernel linux tracing systems \u0026amp; how they fit together, https://jvns.ca/blog/2017/07/05/linux-tracing-systems/  "}),a.add({id:199,href:"/tags/pprof/",title:"pprof",description:"",content:""}),a.add({id:200,href:"/tags/%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2/",title:"å†…å­˜æ³„éœ²",description:"",content:""}),a.add({id:201,href:"/tags/2020/",title:"2020",description:"",content:""}),a.add({id:202,href:"/tags/%E6%80%BB%E7%BB%93/",title:"æ€»ç»“",description:"",content:""}),a.add({id:203,href:"/blog/2020-04-03-%E8%BF%9F%E5%88%B0%E7%9A%842020%E5%B9%B4%E6%80%BB%E7%BB%93/",title:"è¿Ÿåˆ°çš„2020å¹´æ€»ç»“",description:"summary of 2020",content:"ç»“å©š # é”»ç‚¼ # ç§¯è“„ # èµ°å‡ºå» # å…¬å¸å†… # å…¬å¸å¤– # "}),a.add({id:204,href:"/tags/clock/",title:"clock",description:"",content:""}),a.add({id:205,href:"/tags/clock-skew/",title:"clock skew",description:"",content:""}),a.add({id:206,href:"/tags/leap-second/",title:"leap second",description:"",content:""}),a.add({id:207,href:"/tags/%E6%97%B6%E9%92%9F/",title:"æ—¶é’Ÿ",description:"",content:""}),a.add({id:208,href:"/tags/%E6%97%B6%E9%92%9F%E6%BC%82%E7%A7%BB/",title:"æ—¶é’Ÿæ¼‚ç§»",description:"",content:""}),a.add({id:209,href:"/blog/2021-03-09-%E8%81%8A%E8%81%8A%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%97%B6%E9%97%B4/",title:"èŠèŠè®¡ç®—æœºç³»ç»Ÿä¸­çš„æ—¶é—´",description:"æˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½æ˜¯æ—¶é—´ç®¡ç†å¤§å¸ˆï¼Œå‡ ä¹æ‰€æœ‰äººéƒ½çŸ¥é“ç”Ÿæ´»ä¸­å¦‚ä½•è¿ç”¨æ—¶é—´ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡å¾ˆå¤šäººå¹¶ä¸çŸ¥é“è¿™ä¸ªä¸–ç•Œçš„æ—¶é—´æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\nä½ äº†è§£æ—¶é—´å— # å¦‚æœä¸ç›¸ä¿¡ï¼Œé‚£æˆ‘é—®å‡ ä¸ªé—®é¢˜ï¼Œçœ‹è¯»è€…çŸ¥é“ä¸ï¼Ÿ\n ä½ å¬è¯´è¿‡çŸ³è‹±æ™¶ä½“å—ï¼Ÿ ä½ å¬è¯´è¿‡æ™¶æŒ¯æŒ¯è¡å‘¨æœŸå—ï¼Ÿ ä½ å¬è¯´è¿‡æ—¶é’Ÿä¸­æ–­å—ï¼Ÿ ä½ å¬è¯´è¿‡è®¡æ—¶ç”µè·¯å—ï¼Ÿ ä½ å¬è¯´è¿‡æ—¶é’Ÿæ¼‚ç§»å—ï¼Ÿ ä½ å¬è¯´è¿‡é“¯åŸå­é’Ÿå—ï¼Ÿ ä½ å¬è¯´è¿‡BIHè¿™ä¸ªæœºæ„å—ï¼Ÿ ä½ å¬è¯´è¿‡é—°ç§’å—ï¼Ÿ ä½ å¬è¯´è¿‡NTPåè®®å—ï¼Ÿ etc.  å¦‚æœï¼Œä½ ä¸èƒ½ä¸€ä¸€å›ç­”ä¸Šè¿°é—®é¢˜ï¼Œé‚£è¿™ä¸ªåœ°çƒä¸Šçš„æ—¶é—´æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½ å¯èƒ½å¹¶ä¸å¤ªæ¸…æ¥š :)ã€‚\næˆ‘ä»¬æ—¥å‡ºè€Œå‡ºã€æ—¥è½è€Œæ¯ï¼Œæˆ‘ä»¬è§„åˆ’å·¥ä½œäº‹é¡¹ï¼Œæˆ‘ä»¬åè°ƒé‡è¦å·¥ä½œï¼Œæˆ‘ä»¬å®‰æ’è®¡ç®—æœºç¨‹åºç²¾å¯†åä½œâ€¦â€¦æ—¶é—´æ˜¯éå¸¸é‡è¦çš„ï¼Œä»¥è‡³äºæˆ‘ä»¬ç”Ÿç‰©è¿›åŒ–è¿‡ç¨‹ä¸­å½¢æˆäº†â€œç”Ÿç‰©é’Ÿâ€æ¥é€‚åº”ï¼Œå®ƒæ— å½±æ— å½¢ï¼Œå®ƒæ— å¤„ä¸åœ¨ã€‚\næˆ‘ä»¬å¦‚ä½•æµ‹é‡æ—¶é—´çš„ # å‡­æ„Ÿè§‰ä¸é è°± # å…ˆä»‹ç»ä¸‹ï¼Œæˆ‘ä»¬è¯•å¦‚ä½•æµ‹é‡æ—¶é—´çš„ã€‚è¿™å¹¶ä¸åƒå¤§å¤šæ•°äººæƒ³è±¡çš„é‚£æ ·ç®€å•ï¼Œçƒ§ä¸€ç‚·é¦™ï¼Ÿä¸ªæ—¶è¾°ï¼Œæˆ–è€…æ¥ä¸ªæ²™æ¼ä¸€åªæ¤°å­é¸¡ç‚–ç†Ÿäº†ï¼Œè¿™ä¸ªæœ‰ä¸€å®šçš„å®ç”¨ä»·å€¼ï¼Œä½†æ˜¯éå¸¸ä¸ç²¾ç¡®ï¼Œå¯¹äºç²¾åº¦è¦æ±‚è¾ƒé«˜æ—¶æ›´æ˜¯å¦‚æ­¤ã€‚\nå¤©æ–‡å­¦æµ‹é‡æ–¹å¼ # è‡ªåŠ¨17ä¸–çºªæœºæ¢°é’Ÿå‘æ˜ä»¥æ¥ï¼Œæˆ‘ä»¬å°±ä¸€ç›´åœ¨ç”¨å¤©æ–‡å­¦çš„æ–¹æ³•æµ‹é‡æ—¶é—´ã€‚æ¯å¤©å¤ªé˜³éƒ½æ˜¯ä»ä¸œæ–¹åœ°å¹³çº¿ä¸Šå‡èµ·ï¼Œç„¶åå‡åˆ°å¤©ç©ºçš„æœ€é«˜å¤„ï¼Œæœ€åå†è½åˆ°è¥¿è¾¹ã€‚å¤ªé˜³åˆ°è¾¾å¤©ç©ºä¸­çš„æœ€é«˜ç‚¹æ—¶ï¼Œç§°ä¸ºâ€œä¸­å¤©â€ï¼ˆtransit of the sunï¼‰ï¼Œå®ƒåœ¨æ¯å¤©æ­£åˆè¾¾åˆ°æœ€é«˜ç‚¹ã€‚ä¸¤æ¬¡è¿ç»­çš„å¤ªé˜³ä¸­å¤©ä¹‹é—´çš„æ—¶é—´ç§°ä¸ºä¸€ä¸ªâ€œå¤ªé˜³æ—¥â€ï¼ˆsolar dayï¼‰ã€‚å› ä¸ºæ¯å¤©éƒ½ä¼šæœ‰24å°æ—¶ï¼Œæ¯å°æ—¶éƒ½æœ‰3600sï¼Œæ‰€ä»¥ä¸€ä¸ªâ€œå¤ªé˜³ç§’â€ï¼ˆsolar secondï¼‰è¢«ç²¾ç¡®å®šä¹‰ä¸º 1/86400 ä¸ªå¤ªé˜³æ—¥ã€‚\né‚£ä¹ˆå¹³å‡å¤ªé˜³æ—¥çš„å‡ ä½•ç®—æ³•ï¼Œåˆ™å¯ä»¥ç”±ä¸‹å›¾æ‰€ç¤ºï¼š\npsï¼šæœ‰äº›äººæƒ³ä¸ºä»€ä¹ˆä¸åœ°çƒè‡ªè½¬ä¸€å‘¨ç®—1å¤©ï¼Ÿå…¶å®è¿™å°±æ˜¯ä¸Šå›¾ä¸­çš„â€œæ’æ˜Ÿæ—¥â€ï¼ˆsidereal dayï¼‰ï¼Œä»¥é¥è¿œçš„æ’æ˜Ÿä¸ºå‚è€ƒç‰©ï¼Œæ¯å¤©è½¬åˆ°è¿™ä¸ªæ–¹ä½ç®—æ˜¯ä¸€ä¸ªæ’æ˜Ÿæ—¥ã€‚ä½†æ˜¯æˆ‘ä»¬è‡ªç„¶ä¸‡ç‰©å‘é˜³è€Œç”Ÿï¼Œä»¥å¤ªé˜³è¿™é¢—å¤§æ’æ˜Ÿä½œä¸ºå‚è€ƒç³»ä¼¼ä¹æ˜¯æ›´åˆç†çš„è®¡æ—¶æ–¹æ³•ã€‚\nåœ¨20ä¸–çºª40å¹´ä»£ï¼Œç§‘å­¦å®¶ä»¬è¯å®äº†åœ°çƒçš„è‡ªè½¬å‘¨æœŸå¹¶éå¸¸æ•°ï¼ˆconst valueï¼Œå›ºå®šå€¼ï¼‰ã€‚ç”±äºæ½®æ±æ‘©æ“¦å’Œå¤§æ°”çš„é˜»åŠ›ï¼Œåœ°çƒçš„è‡ªè½¬é€Ÿåº¦æ­£åœ¨å˜æ…¢ã€‚åŸºäºå¯¹è¿œå¤æ—¶ä»£çŠç‘šçš„ç”Ÿé•¿å›¾æ¡ˆçš„ç ”ç©¶ï¼Œä½è´¨å­¦å®¶ç°åœ¨ç›¸ä¿¡ï¼Œåœ¨3äº¿å¹´å‰æ¯å¹´å¤§çº¦æœ‰400å¤©ï¼ˆå¤ªé˜³æ—¥ï¼‰ã€‚å¹´çš„é•¿åº¦ï¼ˆåœ°çƒç»•å¤ªé˜³ä¸€å‘¨çš„æ—¶é—´ï¼‰è¢«è®¤ä¸ºæ˜¯ä¸å˜çš„ï¼Œé‚£ä¹ˆæ¯å¤©çš„æ—¶é—´å°±ç®€å•åœ°è¾¹é•¿äº†ã€‚é™¤äº†è¿™ç§é•¿æœŸå˜åŒ–è¶‹åŠ¿ï¼Œä¹Ÿå­˜åœ¨ä¸€ç‚¹é•¿çŸ­çš„çŸ­æœŸå˜åŒ–ï¼Œè¿™å¯èƒ½æ˜¯æ˜¯ç”±äºåœ°çƒåœ°æ ¸å±‚ç†”å²©çš„å‰§çƒˆæ²¸è…¾è€Œå¼•èµ·çš„ã€‚\nè¿™äº›å‘ç°ï¼Œä¿ƒä½¿å¤©æ–‡å­¦å®¶ä»¬åœ¨è®¡ç®—å¤©çš„é•¿åº¦æ—¶è¦æµ‹é‡å¾ˆå¤šå¤©çš„é•¿åº¦ï¼Œç„¶åå†å¯¹å®ƒä»¬å–å¹³å‡å€¼ï¼Œæœ€åé™¤ä»¥86400å¾—åˆ°çš„ç»“æœç§°ä¸ºâ€œå¹³å‡å¤ªé˜³ç§’â€ï¼ˆmean solar secondï¼‰ã€‚\nç‰©ç†å­¦æµ‹é‡æ–¹å¼ # 1948å¹´çš„æ—¶å€™ï¼ŒåŸå­é’Ÿè¯ç”Ÿï¼Œå®ƒä½¿æ›´ç²¾ç¡®åœ°æµ‹é‡æ—¶é—´æˆä¸ºå¯èƒ½ã€‚åŸå­é’Ÿä¸å—åœ°çƒçš„æ‘†åŠ¨å’ŒæŒ¯åŠ¨çš„å½±å“ï¼Œè€Œæ˜¯é€šè¿‡é“¯133åŸå­çš„è·ƒè¿æ¥è®¡æ—¶ã€‚ç‰©ç†å­¦å®¶ä»å¤©æ–‡å­¦å®¶çš„æ‰‹ä¸­æ¥ç®¡äº†è®¡æ—¶çš„å·¥ä½œï¼Œå®šä¹‰1ç§’æ˜¯é“¯133åŸå­åš9192631770æ¬¡è·ƒè¿æ‰€ç”¨çš„æ—¶é—´ã€‚é€‰æ‹©9192631770æ˜¯ä¸ºäº†æ˜¯åŸå­ç§’ä¸å¼•å…¥åŸå­ç§’é‚£ä¸€å¹´çš„å¹³å‡å¤ªé˜³ç§’ç›¸ç­‰ã€‚\nç›®å‰ä¸–ç•Œä¸Šå¤§çº¦æœ‰50ä¸ªå®éªŒå®¤æ‹¥æœ‰é“¯133åŸå­é’Ÿã€‚æ¯ä¸ªå®éªŒå®¤éƒ½å®šæœŸå‘å·´é»çš„BIHï¼ˆBureau International Heureï¼‰æŠ¥å‘Šå…¶æ—¶é’Ÿæ»´ç­”æ•°ã€‚BIHå°†è¿™äº›å€¼å¹³å‡èµ·æ¥äº§ç”Ÿâ€œå›½é™…åŸå­æ—¶é—´â€ï¼ˆinternational atomic timeï¼Œç®€ç§°TAIï¼‰ã€‚è¿™æ ·TAIå°±æ˜¯é“¯133åŸå­é’Ÿä»1958å¹´1æœˆ1æ—¥åˆå¤œï¼ˆèµ·å§‹æ—¶é—´ï¼‰ä»¥æ¥è¢«9192631770é™¤åçš„å¹³å‡æ»´ç­”æ•°ã€‚\nå°½ç®¡TAIç›¸å½“ç¨³å®šï¼Œå¹¶ä¸”ä»»ä½•äººåªè¦æ„¿æ„ï¼Œéƒ½å¯ä»¥ä¹°åˆ°ä¸€åªé“¯åŸå­é’Ÿï¼Œä½†æ˜¯å®ƒä»ç„¶å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯86400ä¸ªTAIç§’æ¯”ç°åœ¨ä¸€ä¸ªå¹³å‡å¤ªé˜³æ—¥è¦å°‘3å¾®ç§’ï¼ˆå› ä¸ºå¹³å‡å¤ªé˜³æ—¥è¶Šæ¥è¶Šé•¿äº†ï¼‰ã€‚ä½¿ç”¨TAIè®¡æ—¶å°†æ„å‘³ç€å¤šå¹´ä»¥åï¼Œä¸­åˆä¼šå‡ºç°åœ°è¶Šæ¥è¶Šæ—©ï¼Œç›´åˆ°æœ€ç»ˆå‡ºç°åœ¨å‡Œæ™¨ï¼ˆå¤ªé˜³è¿˜ä¸çŸ¥é“åœ¨å“ªç¡è§‰ï¼ŒTAIç§’å´æ˜¾ç¤ºå·²ç»ä¸­åˆäº†ï¼‰ã€‚\nUTCä¸é—°ç§’ # äººä»¬ä¹Ÿè®¸æ—©æ™šä¼šæ³¨æ„åˆ°è¿™äº›å˜åŒ–ï¼Œä»Šåå¯èƒ½å°†ä¼šå‘ç”Ÿä¸1582å¹´å¤ç½—é©¬æ•™çš‡Pope Gregoryåä¸‰ä¸–å®£å¸ƒä»æ—¥å†ä¸­åˆ é™¤10å¤©æ—¶ç±»ä¼¼çš„æƒ…å†µã€‚è¿™ä¸€äº‹ä»¶å¯¼è‡´äº†è¡—å¤´æš´åŠ¨ï¼Œå› ä¸ºåœ°ä¸»è¦æ”¶ä¸€ä¸ªæ•´æœˆçš„åœ°ç§Ÿï¼Œé“¶è¡Œå®¶è¦æ”¶ä¸€ä¸ªæ•´æœˆçš„åˆ©æ¯ï¼Œè€Œé›‡ä¸»æ‹’ç»å‘é›‡å‘˜æ”¯ä»˜ä»–ä»¬æ²¡æœ‰å·¥ä½œçš„é‚£10å¤©çš„å·¥èµ„ï¼Œè¿™é‡Œåªæ˜¯æåˆ°äº†å…¶ä¸­çš„å‡ ä¸ªå†²çªã€‚åœ¨ä¸€äº›æ–°æ•™åŒºï¼Œäººä»¬æ‹’ç»ä»»ä½•ä¸æ•™çš‡æ³•ä»¤ç›¸å…³çš„äº‹æƒ…ï¼Œæœ‰é•¿è¾¾170å¹´ä¸æ¥å—ç½—é©¬æ•™çš‡é¢å¸ƒçš„æ—¥å†ã€‚\nBIHé€šè¿‡å¼•å…¥â€œé—°ç§’â€ï¼ˆleap secondï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé¿å…ä»¥åå‡ºç°ç±»ä¼¼ç½—é©¬æ•™çš‡ä¸€æ¬¡åˆ 10å¤©æ—¥å†çš„æƒ…å†µï¼Œä¹Ÿé¿å…é€ æˆä¸–ç•ŒèŒƒå›´å†…éš¾ä»¥åè°ƒã€é¢„æ–™çš„ç¾éš¾ã€‚é—°ç§’ä»€ä¹ˆæ„æ€å‘¢ï¼Œå³å½“TAIå’Œå¤ªé˜³ç§’è®¡æ—¶ä¹‹é—´çš„å·®å¢åŠ åˆ°800å¾®ç§’çš„æ—¶å€™å°±è¦ä½¿ç”¨ä¸€æ¬¡é—°ç§’ã€‚é—°ç§’çš„ä½¿ç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å³åœ¨ç®­å¤´æŒ‡å‘çš„æ—¶åˆ»å¤„ï¼ŒTAIå’Œå¤ªé˜³ç§’ç›¸å·®è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œåœ¨UTCä¸­åº”ç”¨ä¸€æ¬¡é—°ç§’ï¼Œä½¿å¾—UTCä¿æŒåŒæ­¥ã€‚\nè¿™ç§ä¿®æ­£ï¼Œäº§ç”Ÿäº†ä¸€ç§æ—¶é—´ç³»ç»Ÿï¼Œè¯¥æ—¶é—´ç³»ç»ŸåŸºäºæ’å®šé•¿åº¦çš„TAIç§’ï¼Œå¹¶åŠ›æ±‚å’Œå¤ªé˜³çš„è¿åŠ¨ä¿æŒä¸€è‡´ï¼Œå®ƒè¢«ç§°ä¸ºâ€œç»Ÿä¸€åè°ƒæ—¶é—´â€ï¼ˆuniversal coordinated timeï¼Œç®€ç§°UTCï¼‰ã€‚UTCæ˜¯ç°ä»£äººè®¡æ—¶çš„åŸºç¡€ã€‚å®ƒä»æ ¹æœ¬ä¸Šå–ä»£äº†åŸæœ‰çš„æ ‡å‡†â€œæ ¼æ—å°¼æ²»å¤©æ–‡æ—¶é—´â€ï¼ˆgreenwich mean timeï¼‰ï¼Œæ ¼æ—å°¼æ²»å¤©æ–‡æ—¶é—´æ˜¯ä¸€ç§å¤©æ–‡æ—¶é—´ã€‚\né—°ç§’çš„\u0026quot;é˜´æš—é¢\u0026quot; # å€¼å¾—ä¸€æçš„æ˜¯ï¼Œé—°ç§’æœ‰æ­£æœ‰è´Ÿï¼Œå› ä¸ºåœ°çƒè‡ªè½¬å—å¾ˆå¤šå› ç´ å½±å“ï¼Œæœ‰æ—¶å˜å¿«æœ‰æ—¶å˜æ…¢ï¼ˆæ˜¾ç„¶æˆ‘ä»¬å¾ˆéš¾ç›´è§‚å¯Ÿè§‰åˆ°ï¼‰ï¼Œä¸åŒçš„æ—¶é—´æ®µå†…æƒ…å†µä¹Ÿä¸åŒï¼Œæ¯”å¦‚ä»1972å¹´åˆ°2020å¹´å¹³å‡æ¯21ä¸ªæœˆå°±æœ‰ä¸€æ¬¡é—°ç§’å‡ºç°ï¼Œä½†æ˜¯æœ‰çš„æ—¶é—´æ®µå†…åˆ™æ²¡æœ‰é—°ç§’ã€‚\n é—°ç§’ä¸ºæ­£çš„æƒ…å†µï¼ŒUTCæ—¶é—´æˆ³å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æ—¶é—´åºåˆ—ï¼š23:59:59 -\u0026gt; 23:59:60 -\u0026gt; 00:00:00 é—°ç§’ä¸ºè´Ÿçš„æƒ…å†µï¼ŒUTCæ—¶é—´æˆ³å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æ—¶é—´åºåˆ—ï¼š23:59:59 -\u0026gt; 23:59:58 -\u0026gt; 00:00:00  å¯¹äºè®¡ç®—æœºç³»ç»Ÿä¸­çš„çŸ³è‹±æ™¶ä½“ï¼Œç”±äºå…¶ç²¾åº¦çš„é—®é¢˜ï¼Œä¼šå¯¼è‡´æ—¶é—´ä¸Šå‡ºç°åå·®ï¼ˆè¿‡å¿«æˆ–è¿‡æ…¢éƒ½æœ‰å¯èƒ½ï¼‰ï¼Œè®¡ç®—æœºç³»ç»Ÿé€šè¿‡NTPåè®®ï¼ˆnetwork time protocolï¼‰ä¸æ—¶é—´æœåŠ¡å™¨ï¼ˆtime serverï¼‰è¿›è¡Œé€šä¿¡æ¥åŒæ­¥æœ€æ–°çš„æ—¶é—´ã€‚å½“å‡ºç°é—°ç§’æ—¶ï¼ŒNTPæœåŠ¡å™¨ä¸€èˆ¬ä¼šå‘ŠçŸ¥å®¢æˆ·ç«¯å‡ºç°äº†é—°ç§’ï¼ˆé€šè¿‡Leap Indicatorå‘ŠçŸ¥å®¢æˆ·ç«¯ï¼‰ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åè¦è¿›è¡Œé€‚å½“çš„å¤„ç†ï¼Œå½“ç„¶ä¸åŒçš„æ“ä½œç³»ç»Ÿå¤„ç†æ–¹å¼ä¸ä¸€æ ·ã€‚",content:"æˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½æ˜¯æ—¶é—´ç®¡ç†å¤§å¸ˆï¼Œå‡ ä¹æ‰€æœ‰äººéƒ½çŸ¥é“ç”Ÿæ´»ä¸­å¦‚ä½•è¿ç”¨æ—¶é—´ï¼Œä½†æ˜¯æˆ‘ç›¸ä¿¡å¾ˆå¤šäººå¹¶ä¸çŸ¥é“è¿™ä¸ªä¸–ç•Œçš„æ—¶é—´æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\nä½ äº†è§£æ—¶é—´å— # å¦‚æœä¸ç›¸ä¿¡ï¼Œé‚£æˆ‘é—®å‡ ä¸ªé—®é¢˜ï¼Œçœ‹è¯»è€…çŸ¥é“ä¸ï¼Ÿ\n ä½ å¬è¯´è¿‡çŸ³è‹±æ™¶ä½“å—ï¼Ÿ ä½ å¬è¯´è¿‡æ™¶æŒ¯æŒ¯è¡å‘¨æœŸå—ï¼Ÿ ä½ å¬è¯´è¿‡æ—¶é’Ÿä¸­æ–­å—ï¼Ÿ ä½ å¬è¯´è¿‡è®¡æ—¶ç”µè·¯å—ï¼Ÿ ä½ å¬è¯´è¿‡æ—¶é’Ÿæ¼‚ç§»å—ï¼Ÿ ä½ å¬è¯´è¿‡é“¯åŸå­é’Ÿå—ï¼Ÿ ä½ å¬è¯´è¿‡BIHè¿™ä¸ªæœºæ„å—ï¼Ÿ ä½ å¬è¯´è¿‡é—°ç§’å—ï¼Ÿ ä½ å¬è¯´è¿‡NTPåè®®å—ï¼Ÿ etc.  å¦‚æœï¼Œä½ ä¸èƒ½ä¸€ä¸€å›ç­”ä¸Šè¿°é—®é¢˜ï¼Œé‚£è¿™ä¸ªåœ°çƒä¸Šçš„æ—¶é—´æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä½ å¯èƒ½å¹¶ä¸å¤ªæ¸…æ¥š :)ã€‚\næˆ‘ä»¬æ—¥å‡ºè€Œå‡ºã€æ—¥è½è€Œæ¯ï¼Œæˆ‘ä»¬è§„åˆ’å·¥ä½œäº‹é¡¹ï¼Œæˆ‘ä»¬åè°ƒé‡è¦å·¥ä½œï¼Œæˆ‘ä»¬å®‰æ’è®¡ç®—æœºç¨‹åºç²¾å¯†åä½œâ€¦â€¦æ—¶é—´æ˜¯éå¸¸é‡è¦çš„ï¼Œä»¥è‡³äºæˆ‘ä»¬ç”Ÿç‰©è¿›åŒ–è¿‡ç¨‹ä¸­å½¢æˆäº†â€œç”Ÿç‰©é’Ÿâ€æ¥é€‚åº”ï¼Œå®ƒæ— å½±æ— å½¢ï¼Œå®ƒæ— å¤„ä¸åœ¨ã€‚\næˆ‘ä»¬å¦‚ä½•æµ‹é‡æ—¶é—´çš„ # å‡­æ„Ÿè§‰ä¸é è°± # å…ˆä»‹ç»ä¸‹ï¼Œæˆ‘ä»¬è¯•å¦‚ä½•æµ‹é‡æ—¶é—´çš„ã€‚è¿™å¹¶ä¸åƒå¤§å¤šæ•°äººæƒ³è±¡çš„é‚£æ ·ç®€å•ï¼Œçƒ§ä¸€ç‚·é¦™ï¼Ÿä¸ªæ—¶è¾°ï¼Œæˆ–è€…æ¥ä¸ªæ²™æ¼ä¸€åªæ¤°å­é¸¡ç‚–ç†Ÿäº†ï¼Œè¿™ä¸ªæœ‰ä¸€å®šçš„å®ç”¨ä»·å€¼ï¼Œä½†æ˜¯éå¸¸ä¸ç²¾ç¡®ï¼Œå¯¹äºç²¾åº¦è¦æ±‚è¾ƒé«˜æ—¶æ›´æ˜¯å¦‚æ­¤ã€‚\nå¤©æ–‡å­¦æµ‹é‡æ–¹å¼ # è‡ªåŠ¨17ä¸–çºªæœºæ¢°é’Ÿå‘æ˜ä»¥æ¥ï¼Œæˆ‘ä»¬å°±ä¸€ç›´åœ¨ç”¨å¤©æ–‡å­¦çš„æ–¹æ³•æµ‹é‡æ—¶é—´ã€‚æ¯å¤©å¤ªé˜³éƒ½æ˜¯ä»ä¸œæ–¹åœ°å¹³çº¿ä¸Šå‡èµ·ï¼Œç„¶åå‡åˆ°å¤©ç©ºçš„æœ€é«˜å¤„ï¼Œæœ€åå†è½åˆ°è¥¿è¾¹ã€‚å¤ªé˜³åˆ°è¾¾å¤©ç©ºä¸­çš„æœ€é«˜ç‚¹æ—¶ï¼Œç§°ä¸ºâ€œä¸­å¤©â€ï¼ˆtransit of the sunï¼‰ï¼Œå®ƒåœ¨æ¯å¤©æ­£åˆè¾¾åˆ°æœ€é«˜ç‚¹ã€‚ä¸¤æ¬¡è¿ç»­çš„å¤ªé˜³ä¸­å¤©ä¹‹é—´çš„æ—¶é—´ç§°ä¸ºä¸€ä¸ªâ€œå¤ªé˜³æ—¥â€ï¼ˆsolar dayï¼‰ã€‚å› ä¸ºæ¯å¤©éƒ½ä¼šæœ‰24å°æ—¶ï¼Œæ¯å°æ—¶éƒ½æœ‰3600sï¼Œæ‰€ä»¥ä¸€ä¸ªâ€œå¤ªé˜³ç§’â€ï¼ˆsolar secondï¼‰è¢«ç²¾ç¡®å®šä¹‰ä¸º 1/86400 ä¸ªå¤ªé˜³æ—¥ã€‚\né‚£ä¹ˆå¹³å‡å¤ªé˜³æ—¥çš„å‡ ä½•ç®—æ³•ï¼Œåˆ™å¯ä»¥ç”±ä¸‹å›¾æ‰€ç¤ºï¼š\npsï¼šæœ‰äº›äººæƒ³ä¸ºä»€ä¹ˆä¸åœ°çƒè‡ªè½¬ä¸€å‘¨ç®—1å¤©ï¼Ÿå…¶å®è¿™å°±æ˜¯ä¸Šå›¾ä¸­çš„â€œæ’æ˜Ÿæ—¥â€ï¼ˆsidereal dayï¼‰ï¼Œä»¥é¥è¿œçš„æ’æ˜Ÿä¸ºå‚è€ƒç‰©ï¼Œæ¯å¤©è½¬åˆ°è¿™ä¸ªæ–¹ä½ç®—æ˜¯ä¸€ä¸ªæ’æ˜Ÿæ—¥ã€‚ä½†æ˜¯æˆ‘ä»¬è‡ªç„¶ä¸‡ç‰©å‘é˜³è€Œç”Ÿï¼Œä»¥å¤ªé˜³è¿™é¢—å¤§æ’æ˜Ÿä½œä¸ºå‚è€ƒç³»ä¼¼ä¹æ˜¯æ›´åˆç†çš„è®¡æ—¶æ–¹æ³•ã€‚\nåœ¨20ä¸–çºª40å¹´ä»£ï¼Œç§‘å­¦å®¶ä»¬è¯å®äº†åœ°çƒçš„è‡ªè½¬å‘¨æœŸå¹¶éå¸¸æ•°ï¼ˆconst valueï¼Œå›ºå®šå€¼ï¼‰ã€‚ç”±äºæ½®æ±æ‘©æ“¦å’Œå¤§æ°”çš„é˜»åŠ›ï¼Œåœ°çƒçš„è‡ªè½¬é€Ÿåº¦æ­£åœ¨å˜æ…¢ã€‚åŸºäºå¯¹è¿œå¤æ—¶ä»£çŠç‘šçš„ç”Ÿé•¿å›¾æ¡ˆçš„ç ”ç©¶ï¼Œä½è´¨å­¦å®¶ç°åœ¨ç›¸ä¿¡ï¼Œåœ¨3äº¿å¹´å‰æ¯å¹´å¤§çº¦æœ‰400å¤©ï¼ˆå¤ªé˜³æ—¥ï¼‰ã€‚å¹´çš„é•¿åº¦ï¼ˆåœ°çƒç»•å¤ªé˜³ä¸€å‘¨çš„æ—¶é—´ï¼‰è¢«è®¤ä¸ºæ˜¯ä¸å˜çš„ï¼Œé‚£ä¹ˆæ¯å¤©çš„æ—¶é—´å°±ç®€å•åœ°è¾¹é•¿äº†ã€‚é™¤äº†è¿™ç§é•¿æœŸå˜åŒ–è¶‹åŠ¿ï¼Œä¹Ÿå­˜åœ¨ä¸€ç‚¹é•¿çŸ­çš„çŸ­æœŸå˜åŒ–ï¼Œè¿™å¯èƒ½æ˜¯æ˜¯ç”±äºåœ°çƒåœ°æ ¸å±‚ç†”å²©çš„å‰§çƒˆæ²¸è…¾è€Œå¼•èµ·çš„ã€‚\nè¿™äº›å‘ç°ï¼Œä¿ƒä½¿å¤©æ–‡å­¦å®¶ä»¬åœ¨è®¡ç®—å¤©çš„é•¿åº¦æ—¶è¦æµ‹é‡å¾ˆå¤šå¤©çš„é•¿åº¦ï¼Œç„¶åå†å¯¹å®ƒä»¬å–å¹³å‡å€¼ï¼Œæœ€åé™¤ä»¥86400å¾—åˆ°çš„ç»“æœç§°ä¸ºâ€œå¹³å‡å¤ªé˜³ç§’â€ï¼ˆmean solar secondï¼‰ã€‚\nç‰©ç†å­¦æµ‹é‡æ–¹å¼ # 1948å¹´çš„æ—¶å€™ï¼ŒåŸå­é’Ÿè¯ç”Ÿï¼Œå®ƒä½¿æ›´ç²¾ç¡®åœ°æµ‹é‡æ—¶é—´æˆä¸ºå¯èƒ½ã€‚åŸå­é’Ÿä¸å—åœ°çƒçš„æ‘†åŠ¨å’ŒæŒ¯åŠ¨çš„å½±å“ï¼Œè€Œæ˜¯é€šè¿‡é“¯133åŸå­çš„è·ƒè¿æ¥è®¡æ—¶ã€‚ç‰©ç†å­¦å®¶ä»å¤©æ–‡å­¦å®¶çš„æ‰‹ä¸­æ¥ç®¡äº†è®¡æ—¶çš„å·¥ä½œï¼Œå®šä¹‰1ç§’æ˜¯é“¯133åŸå­åš9192631770æ¬¡è·ƒè¿æ‰€ç”¨çš„æ—¶é—´ã€‚é€‰æ‹©9192631770æ˜¯ä¸ºäº†æ˜¯åŸå­ç§’ä¸å¼•å…¥åŸå­ç§’é‚£ä¸€å¹´çš„å¹³å‡å¤ªé˜³ç§’ç›¸ç­‰ã€‚\nç›®å‰ä¸–ç•Œä¸Šå¤§çº¦æœ‰50ä¸ªå®éªŒå®¤æ‹¥æœ‰é“¯133åŸå­é’Ÿã€‚æ¯ä¸ªå®éªŒå®¤éƒ½å®šæœŸå‘å·´é»çš„BIHï¼ˆBureau International Heureï¼‰æŠ¥å‘Šå…¶æ—¶é’Ÿæ»´ç­”æ•°ã€‚BIHå°†è¿™äº›å€¼å¹³å‡èµ·æ¥äº§ç”Ÿâ€œå›½é™…åŸå­æ—¶é—´â€ï¼ˆinternational atomic timeï¼Œç®€ç§°TAIï¼‰ã€‚è¿™æ ·TAIå°±æ˜¯é“¯133åŸå­é’Ÿä»1958å¹´1æœˆ1æ—¥åˆå¤œï¼ˆèµ·å§‹æ—¶é—´ï¼‰ä»¥æ¥è¢«9192631770é™¤åçš„å¹³å‡æ»´ç­”æ•°ã€‚\nå°½ç®¡TAIç›¸å½“ç¨³å®šï¼Œå¹¶ä¸”ä»»ä½•äººåªè¦æ„¿æ„ï¼Œéƒ½å¯ä»¥ä¹°åˆ°ä¸€åªé“¯åŸå­é’Ÿï¼Œä½†æ˜¯å®ƒä»ç„¶å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯86400ä¸ªTAIç§’æ¯”ç°åœ¨ä¸€ä¸ªå¹³å‡å¤ªé˜³æ—¥è¦å°‘3å¾®ç§’ï¼ˆå› ä¸ºå¹³å‡å¤ªé˜³æ—¥è¶Šæ¥è¶Šé•¿äº†ï¼‰ã€‚ä½¿ç”¨TAIè®¡æ—¶å°†æ„å‘³ç€å¤šå¹´ä»¥åï¼Œä¸­åˆä¼šå‡ºç°åœ°è¶Šæ¥è¶Šæ—©ï¼Œç›´åˆ°æœ€ç»ˆå‡ºç°åœ¨å‡Œæ™¨ï¼ˆå¤ªé˜³è¿˜ä¸çŸ¥é“åœ¨å“ªç¡è§‰ï¼ŒTAIç§’å´æ˜¾ç¤ºå·²ç»ä¸­åˆäº†ï¼‰ã€‚\nUTCä¸é—°ç§’ # äººä»¬ä¹Ÿè®¸æ—©æ™šä¼šæ³¨æ„åˆ°è¿™äº›å˜åŒ–ï¼Œä»Šåå¯èƒ½å°†ä¼šå‘ç”Ÿä¸1582å¹´å¤ç½—é©¬æ•™çš‡Pope Gregoryåä¸‰ä¸–å®£å¸ƒä»æ—¥å†ä¸­åˆ é™¤10å¤©æ—¶ç±»ä¼¼çš„æƒ…å†µã€‚è¿™ä¸€äº‹ä»¶å¯¼è‡´äº†è¡—å¤´æš´åŠ¨ï¼Œå› ä¸ºåœ°ä¸»è¦æ”¶ä¸€ä¸ªæ•´æœˆçš„åœ°ç§Ÿï¼Œé“¶è¡Œå®¶è¦æ”¶ä¸€ä¸ªæ•´æœˆçš„åˆ©æ¯ï¼Œè€Œé›‡ä¸»æ‹’ç»å‘é›‡å‘˜æ”¯ä»˜ä»–ä»¬æ²¡æœ‰å·¥ä½œçš„é‚£10å¤©çš„å·¥èµ„ï¼Œè¿™é‡Œåªæ˜¯æåˆ°äº†å…¶ä¸­çš„å‡ ä¸ªå†²çªã€‚åœ¨ä¸€äº›æ–°æ•™åŒºï¼Œäººä»¬æ‹’ç»ä»»ä½•ä¸æ•™çš‡æ³•ä»¤ç›¸å…³çš„äº‹æƒ…ï¼Œæœ‰é•¿è¾¾170å¹´ä¸æ¥å—ç½—é©¬æ•™çš‡é¢å¸ƒçš„æ—¥å†ã€‚\nBIHé€šè¿‡å¼•å…¥â€œé—°ç§’â€ï¼ˆleap secondï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé¿å…ä»¥åå‡ºç°ç±»ä¼¼ç½—é©¬æ•™çš‡ä¸€æ¬¡åˆ 10å¤©æ—¥å†çš„æƒ…å†µï¼Œä¹Ÿé¿å…é€ æˆä¸–ç•ŒèŒƒå›´å†…éš¾ä»¥åè°ƒã€é¢„æ–™çš„ç¾éš¾ã€‚é—°ç§’ä»€ä¹ˆæ„æ€å‘¢ï¼Œå³å½“TAIå’Œå¤ªé˜³ç§’è®¡æ—¶ä¹‹é—´çš„å·®å¢åŠ åˆ°800å¾®ç§’çš„æ—¶å€™å°±è¦ä½¿ç”¨ä¸€æ¬¡é—°ç§’ã€‚é—°ç§’çš„ä½¿ç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å³åœ¨ç®­å¤´æŒ‡å‘çš„æ—¶åˆ»å¤„ï¼ŒTAIå’Œå¤ªé˜³ç§’ç›¸å·®è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œåœ¨UTCä¸­åº”ç”¨ä¸€æ¬¡é—°ç§’ï¼Œä½¿å¾—UTCä¿æŒåŒæ­¥ã€‚\nè¿™ç§ä¿®æ­£ï¼Œäº§ç”Ÿäº†ä¸€ç§æ—¶é—´ç³»ç»Ÿï¼Œè¯¥æ—¶é—´ç³»ç»ŸåŸºäºæ’å®šé•¿åº¦çš„TAIç§’ï¼Œå¹¶åŠ›æ±‚å’Œå¤ªé˜³çš„è¿åŠ¨ä¿æŒä¸€è‡´ï¼Œå®ƒè¢«ç§°ä¸ºâ€œç»Ÿä¸€åè°ƒæ—¶é—´â€ï¼ˆuniversal coordinated timeï¼Œç®€ç§°UTCï¼‰ã€‚UTCæ˜¯ç°ä»£äººè®¡æ—¶çš„åŸºç¡€ã€‚å®ƒä»æ ¹æœ¬ä¸Šå–ä»£äº†åŸæœ‰çš„æ ‡å‡†â€œæ ¼æ—å°¼æ²»å¤©æ–‡æ—¶é—´â€ï¼ˆgreenwich mean timeï¼‰ï¼Œæ ¼æ—å°¼æ²»å¤©æ–‡æ—¶é—´æ˜¯ä¸€ç§å¤©æ–‡æ—¶é—´ã€‚\né—°ç§’çš„\u0026quot;é˜´æš—é¢\u0026quot; # å€¼å¾—ä¸€æçš„æ˜¯ï¼Œé—°ç§’æœ‰æ­£æœ‰è´Ÿï¼Œå› ä¸ºåœ°çƒè‡ªè½¬å—å¾ˆå¤šå› ç´ å½±å“ï¼Œæœ‰æ—¶å˜å¿«æœ‰æ—¶å˜æ…¢ï¼ˆæ˜¾ç„¶æˆ‘ä»¬å¾ˆéš¾ç›´è§‚å¯Ÿè§‰åˆ°ï¼‰ï¼Œä¸åŒçš„æ—¶é—´æ®µå†…æƒ…å†µä¹Ÿä¸åŒï¼Œæ¯”å¦‚ä»1972å¹´åˆ°2020å¹´å¹³å‡æ¯21ä¸ªæœˆå°±æœ‰ä¸€æ¬¡é—°ç§’å‡ºç°ï¼Œä½†æ˜¯æœ‰çš„æ—¶é—´æ®µå†…åˆ™æ²¡æœ‰é—°ç§’ã€‚\n é—°ç§’ä¸ºæ­£çš„æƒ…å†µï¼ŒUTCæ—¶é—´æˆ³å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æ—¶é—´åºåˆ—ï¼š23:59:59 -\u0026gt; 23:59:60 -\u0026gt; 00:00:00 é—°ç§’ä¸ºè´Ÿçš„æƒ…å†µï¼ŒUTCæ—¶é—´æˆ³å¯èƒ½ä¼šå‡ºç°è¿™æ ·çš„æ—¶é—´åºåˆ—ï¼š23:59:59 -\u0026gt; 23:59:58 -\u0026gt; 00:00:00  å¯¹äºè®¡ç®—æœºç³»ç»Ÿä¸­çš„çŸ³è‹±æ™¶ä½“ï¼Œç”±äºå…¶ç²¾åº¦çš„é—®é¢˜ï¼Œä¼šå¯¼è‡´æ—¶é—´ä¸Šå‡ºç°åå·®ï¼ˆè¿‡å¿«æˆ–è¿‡æ…¢éƒ½æœ‰å¯èƒ½ï¼‰ï¼Œè®¡ç®—æœºç³»ç»Ÿé€šè¿‡NTPåè®®ï¼ˆnetwork time protocolï¼‰ä¸æ—¶é—´æœåŠ¡å™¨ï¼ˆtime serverï¼‰è¿›è¡Œé€šä¿¡æ¥åŒæ­¥æœ€æ–°çš„æ—¶é—´ã€‚å½“å‡ºç°é—°ç§’æ—¶ï¼ŒNTPæœåŠ¡å™¨ä¸€èˆ¬ä¼šå‘ŠçŸ¥å®¢æˆ·ç«¯å‡ºç°äº†é—°ç§’ï¼ˆé€šè¿‡Leap Indicatorå‘ŠçŸ¥å®¢æˆ·ç«¯ï¼‰ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åè¦è¿›è¡Œé€‚å½“çš„å¤„ç†ï¼Œå½“ç„¶ä¸åŒçš„æ“ä½œç³»ç»Ÿå¤„ç†æ–¹å¼ä¸ä¸€æ ·ã€‚\nä½†æ˜¯ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå¾ˆå¤šåº”ç”¨ç¨‹åºéƒ½æ˜¯ä½¿ç”¨Unixæ—¶é—´æˆ³ï¼ˆæ²¡æœ‰è€ƒè™‘é—°ç§’çš„ï¼‰æ¥ä½œä¸ºåº”ç”¨ç¨‹åºä¸­çš„æ—¶é—´çš„ï¼Œå¦‚æœæ“ä½œç³»ç»Ÿè´¸ç„¶æ’å…¥1sæˆ–è€…å‡å»1séƒ½ä¼šå¯¹æ—¶é—´æ•æ„Ÿçš„åº”ç”¨é€ æˆä¸¥é‡åæœã€‚ç”¨æˆ·å…ˆåå‘èµ·äº†ä¸¤ä¸ªæ“ä½œï¼Œä¿®æ”¹è®¢å•ã€ä¸‹å•è¯·æ±‚ï¼Œè¯·æ±‚é‡Œé¢éƒ½å¸¦æœ‰æ—¶é—´æˆ³ï¼Œä½†æ˜¯å¦‚æœå–æ¶ˆè®¢å•æ—¶å› ä¸ºé—°ç§’çš„åŸå› å¯¼è‡´æ—¶é—´å‘è¿‡å»è·³äº†1sï¼Œé€ æˆæœåŠ¡ç«¯çœ‹æ¥ç”¨æˆ·æ˜¯å…ˆä¸‹å•ï¼Œåä¿®æ”¹è®¢å•ï¼Œé‚£ä¹ˆå°†å¯¼è‡´è®¢å•ä¿®æ”¹å¤±è´¥ï¼ˆé€šå¸¸æ˜¯ä¸‹å•åæ— æ³•ä¿®æ”¹çš„ï¼‰ã€‚\nps: æ¯”è¿™ä¸ªé—®é¢˜ä¸¥é‡çš„å¤šçš„åœºæ™¯å¤šçš„æ˜¯ï¼Œå½“ç„¶å¥å£®çš„ç³»ç»Ÿä¼šè€ƒè™‘é‡‡ç”¨é€»è¾‘æ—¶é’Ÿç­‰æ‰‹æ®µæ¥è§£å†³ï¼Œå¦‚å‘é‡æ—¶é’Ÿï¼Œè¿™é‡Œä¸å¤šè¯´äº†ã€‚\nä¸ºäº†é¿å…åº”ç”¨ç¨‹åºå¤„ç†è¿™ä¸ªé—°ç§’é—®é¢˜çš„å¤æ‚æ€§ï¼Œå±è”½ä¸åŒæ“ä½œç³»ç»Ÿçš„å·®å¼‚ï¼Œæœ‰äº›å¤§å‚ä¼šè‡ªå»ºNTPæœåŠ¡å™¨ï¼Œåœ¨æ”¶åˆ°ä¸Šæ¸¸NTPæœåŠ¡å™¨çš„é—°ç§’äº‹ä»¶æ—¶ï¼Œä¼šé€šè¿‡leap smearçš„æ–¹å¼ï¼Œå°†è¿™ä¸ªé—°ç§’äº‹ä»¶çš„å½±å“å‡åŒ€åœ°æ‰“æ•£åˆ°æ¥ä¸‹æ¥çš„æ—¶é—´é‡Œï¼Œä½¿å¾—æ—¶é—´ä¸€ç›´æ˜¯åªå¢ä¸å‡çš„ã€‚è¿™æ ·å…¬å¸å†…éƒ¨ä»è‡ªå»ºNTPæœåŠ¡å™¨ä¸ŠåŒæ­¥è¿‡å»çš„æ—¶é—´è™½ç„¶å¯èƒ½ä¼šæœ‰ç‚¹ç‚¹ä¸é‚£ä¹ˆç²¾å‡†ï¼Œä½†æ˜¯å´å¾ˆæœ‰æ•ˆåœ°è§£å†³äº†é—°ç§’å¯èƒ½å¸¦æ¥çš„æ½œåœ¨çš„ç¾éš¾ã€‚\nGoogleå†…éƒ¨å°±æ˜¯å€ŸåŠ©leap smearçš„æ–¹å¼æ¥åšçš„ï¼Œå½“æ¥æ”¶åˆ°é€šçŸ¥æŸå¤©æœ‰é—°ç§’å‡ºç°ï¼Œè‡ªå»ºNTPæœåŠ¡å™¨ï¼ˆä¿®æ”¹ä»£ç æ”¯æŒleap smearï¼‰å°†é—°ç§’æ‰“æ•£åˆ°å…¨å¤©ï¼Œä¿è¯æ—¶é—´æ…¢æ…¢å¢åŠ ï¼Œå†…éƒ¨æœåŠ¡å™¨éƒ½ç”¨è¿™ä¸ªæ—¶é—´ï¼Œå°±ä¸ç”¨å¤„ç†é—°ç§’å¸¦æ¥çš„è·³å˜çš„é—®é¢˜äº†ã€‚Amazoné‡‡å–äº†ç±»ä¼¼çš„æ–¹å¼ï¼Œç¨æœ‰ä¸åŒï¼Œä»¥åŠå…¶ä»–çš„ä¸€äº›åšæ³•ï¼Œå¯ä»¥å‚è€ƒç»´åŸºç™¾ç§‘ã€‚\né‰´äºUTCå¼•å…¥leap secondæ‰€å¸¦æ¥çš„çš„é—®é¢˜ï¼Œæ¯”å¦‚å¯¹è®¡ç®—æœºç³»ç»Ÿã€åˆ†å¸ƒå¼ç³»ç»Ÿç­‰ç­‰ï¼Œå›½é™…ä¼šè®®ä¹Ÿåœ¨è®¨è®ºè¦ä¸è¦è€ƒè™‘æ›´å¥½çš„æ–¹å¼ï¼Œæ¯”å¦‚åº”ç”¨ç¨‹åºä¸­å¸Œæœ›ä½¿ç”¨ç²¾ç¡®æ—¶é—´æ—¶æ€»æ˜¯ä½¿ç”¨TAIï¼Œè€Œåœ¨å¸Œæœ›äººç±»å¯è¯»çš„åœºæ™¯ä¸‹å°†å…¶è½¬æ¢æˆUTCæ˜¾ç¤ºã€‚å…¶å®Googleé‡‡ç”¨çš„leap smearçš„æ–¹å¼ä¹Ÿæ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„å®è·µã€‚\nè®¡ç®—æœºå¦‚ä½•æµ‹é‡æ—¶é—´çš„ # è®¡ç®—æœºçš„ç‰©ç†æ—¶é’Ÿ # è®¡ç®—æœºä¸­æœ‰ä¸€ä¸ªè®¡æ—¶ç”µè·¯ï¼Œå°½ç®¡é€šå¸¸ä½¿ç”¨â€œæ—¶é’Ÿâ€è¿™ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯ç”¨â€œè®¡æ—¶å™¨ï¼ˆtimerï¼‰â€æ›´æ°å½“ä¸€ç‚¹ã€‚è®¡ç®—æœºçš„è®¡æ—¶å™¨é€šå¸¸æ˜¯ä¸€ä¸ªç²¾å¯†åŠ å·¥çš„çŸ³è‹±æ™¶ä½“ï¼ŒçŸ³è‹±æ™¶ä½“åœ¨å…¶å¼ åŠ›é™åº¦å†…ä»¥ä¸€å®šçš„é¢‘ç‡æŒ¯è¡ï¼Œè¿™ä¸ªé¢‘ç‡å–å†³äºæ™¶ä½“æœ¬èº«å¦‚ä½•è¢«åˆ‡å‰²åŠå…¶å—åˆ°çš„å¼ åŠ›çš„å¤§å°ã€‚\næœ‰ä¸¤ä¸ªå¯„å­˜å™¨ä¸æ¯ä¸ªçŸ³è‹±æ™¶ä½“ç›¸å…³è”ï¼Œä¸€ä¸ªæ˜¯è®¡æ•°å™¨ï¼ˆcounterï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯ä¿æŒå¯„å­˜å™¨ï¼ˆholding registerï¼‰ã€‚çŸ³è‹±æ™¶ä½“çš„æ¯æ¬¡æŒ¯è¡ä½¿è®¡æ•°å™¨-1ï¼Œå½“å‡ä¸º0æ—¶åˆ™è§¦å‘ä¸€ä¸ªä¸­æ–­ï¼›ç„¶åï¼Œè®¡æ•°å™¨ä»ä¿æŒå¯„å­˜å™¨ä¸­é‡æ–°è£…å…¥åˆå§‹å€¼ã€‚æ¯æ¬¡ä¸­æ–­ç§°ä¸ºä¸€ä¸ªæ—¶é’Ÿæ»´ç­”ã€‚\nç³»ç»Ÿåˆæ¬¡å¯åŠ¨æ—¶ï¼Œé€šå¸¸è¦æ±‚ç”¨æˆ·è¾“å…¥æ—¥æœŸå’Œæ—¶é—´ï¼Œç„¶åå°†å®ƒä»¬è½¬æ¢æˆæŸä¸€ä¸ªå·²çŸ¥èµ·å§‹æ—¶é—´åçš„æ—¶é’Ÿæ»´ç­”æ¬¡æ•°ï¼Œå¹¶å°†å®ƒå­˜å‚¨åœ¨å­˜å‚¨å™¨ä¸­ã€‚è®¸å¤šè®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç”µæ± æ”¯æŒçš„CMOS RAMï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ä»¥åå¯åŠ¨æ—¶ä¸å†éœ€è¦è¾“å…¥æ—¥æœŸå’Œæ—¶é—´ã€‚\næ—¶é’Ÿæ¯æ»´ç­”ä¸€æ¬¡ï¼Œå°±äº§ç”Ÿä¸€ä¸ªæ—¶é’Ÿä¸­æ–­ï¼Œæ—¶é’Ÿä¸­æ–­æœåŠ¡ç¨‹åºå°±ä½¿å­˜å‚¨åœ¨å­˜å‚¨å™¨é‡Œé¢çš„æ—¶é—´å€¼+1ã€‚ç”¨è¿™ç§æ–¹æ³•è¿›è¡Œï¼ˆè½¯ï¼‰æ—¶é’Ÿè®¡æ—¶ã€‚\npsï¼šå¤šCPUç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªCPUéƒ½æœ‰è‡ªå·±çš„æ—¶é’Ÿã€‚\nå¤§å®¶äº†è§£åˆ°æˆ‘ä»¬ç°åœ¨å·²ç»ç”¨åŸå­é’Ÿæµ‹é‡æ—¶é—´äº†ï¼Œæˆ‘ä»¬ä¸ç¦è¦é—®ï¼Œè¿™ä¸ªæ™¶æŒ¯æŒ¯è¡å‘¨æœŸè§„å¾‹ä¹ˆã€ç²¾å‡†å—ï¼Ÿä¸ç²¾å‡†ï¼æ—¶é—´ä¹…äº†ï¼Œè®¡ç®—æœºçš„ç‰©ç†æ—¶é’Ÿæ—¶é—´ä¸ä¸–ç•ŒçœŸå®æ—¶é—´å°±æœ‰äº†åå·®ï¼Œç§°ä¹‹ä¸ºâ€æ—¶é—´åç§»â€œï¼ˆtime skewï¼‰ã€‚\nåˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬è¿˜æœ‰è®¡ç®—æœºç½‘ç»œï¼Œæˆ‘ä»¬å¯ä»¥è®©è®¡ç®—æœºé€šè¿‡è®¡ç®—æœºç½‘ç»œä¸æ—¶é—´æ›´ç²¾å‡†çš„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ¥åŒæ­¥æ—¶é—´ã€‚\nç½‘ç»œæ—¶é—´åè®®NTP # æˆ‘ä»¬å¯ä»¥è®©è‡ªå·±çš„æœåŠ¡å™¨ä¸æ—¶é—´æœåŠ¡å™¨ï¼ˆtime serverï¼‰è¿›è¡Œé€šä¿¡å®Œæˆæ—¶é—´çš„åŒæ­¥ã€‚æ—¶é—´æœåŠ¡å™¨å¯ä»¥ç²¾ç¡®åœ°æä¾›å½“å‰æ—¶é—´ï¼Œå› ä¸ºå®ƒè£…å¤‡äº†ä¸€ä¸ªWWVæ¥æ”¶å™¨æˆ–ä¸€ä¸ªç²¾ç¡®çš„æ—¶é’Ÿã€‚\nps: WWVï¼ˆshortwave radio stationï¼‰æ¥æ”¶å™¨ï¼Œä½¿å¾—å®‰è£…æœ‰è¯¥è®¾å¤‡çš„æ¥æ”¶å™¨å¯ä»¥é€šè¿‡GPSå…¨çƒå®šä½ç³»ç»Ÿæ¥åŒæ­¥æ—¶é—´ï¼Œå£°ç§°è¯¯å·®åœ¨20~35nsè¯¯å·®èŒƒå›´å†…ï¼Œå¯ä»¥è¯´æ˜¯ç›¸å½“ç²¾ç¡®äº†ã€‚GPSå«æ˜Ÿä¸Šä¹Ÿæ˜¯å®‰è£…çš„åŸå­é’Ÿã€‚å¦‚æœæƒ³äº†è§£å¦‚ä½•å€ŸåŠ©GPSå…¨çƒå®šä½ç³»ç»Ÿå®ç°æ—¶é—´åŒæ­¥ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚\nå½“ç„¶ï¼Œé—®é¢˜æ˜¯ï¼Œä½•æ—¶ä¸è¯¥æœåŠ¡å™¨è”ç³»ï¼Œæ¶ˆæ¯å»¶æ—¶ä¼šä½¿å¾—æŠ¥å‘Šçš„æ—¶é—´è¿‡æ—¶ï¼Œè¿™é‡Œæœ‰ä¸ªæŠ€å·§ï¼Œå°±æ˜¯ç»™æ¶ˆæ¯å¸¦ä¸Šæ—¶é—´æˆ³ï¼Œå¥½è®©æˆ‘ä»¬å¯¹æ¶ˆæ¯çš„ä¼ è¾“å»¶æ—¶åšå‡ºå¾ˆå¥½çš„ä¼°è®¡ã€‚æ¯”å¦‚åƒä¸‹å›¾è¿™æ ·ï¼š\nè¦æ±‚client Aã€server Bå‘é€æ¥æ”¶æ¶ˆæ¯æ—¶éƒ½å¸¦ä¸Šå½“æ—¶æ—¶åˆ»çš„æ—¶é—´ä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¤§è‡´ç®—å‡ºclient Aå‘é€è¯·æ±‚åˆ°server Bæ¥æ”¶çš„ä¼ è¾“æ—¶å»¶ä¸ºT2-T1ï¼ŒåŒç†å¯çŸ¥server Bå‘é€å“åº”ç»™client Açš„ä¼ è¾“æ—¶å»¶ä¸ºT4-T3ï¼Œæˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡è¿™ä¸¤æ¬¡ä¼ è¾“çš„æ—¶é—´åº”è¯¥ç›¸å·®æ— å‡ ï¼Œä¸ºäº†è®©ä¼ è¾“æ—¶å»¶å½±å“æ›´å°ï¼Œå°±å–å¹³å‡å€¼ä½œä¸ºä¼ è¾“æ—¶å»¶å§ã€‚ç„¶ååŸºäºT3è¿™ä¸ªå“åº”çš„æ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬ç›¸ä¿¡T3æ˜¯NTP serverçš„å‡†ç¡®æ—¶é—´ï¼Œæ‰€ä»¥å°±å¯ä»¥è®¡ç®—å‡ºå½“å‰client AåŒæ­¥åˆ°çš„æ—¶é—´ä¸ºï¼š\nT = T3 + ((T2-T1)+(T4-T3))/2  è¿™ä¸ªå¾ˆå¥½ç†è§£ã€‚\nä¸è¦é«˜å…´å¤ªæ—©ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ„è¯†åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ—¶é—´ä¸å…è®¸åé€€çš„é—®é¢˜ã€‚æ—¶é—´ä¸€æ—¦å‡ºç°åé€€ï¼Œå¯¹æ— æ•°çš„ç”µå­è®¾å¤‡ã€è®¡ç®—æœºç³»ç»Ÿè€Œè¨€å°†æ˜¯åè¶³çš„ç¾éš¾ã€‚\nè¿™é‡Œçš„åŒæ­¥åˆ°çš„æ—¶é—´Tç›¸å¯¹æœ¬åœ°å½“å‰æ—¶é—´è€Œè¨€ï¼Œæ˜¯æ›´å¿«çš„è¯ï¼Œç›´æ¥è®¾ç½®å½“å‰æ—¶é—´ä¸ºTå°±è¡Œäº†ï¼Ÿä¼¼ä¹æ²¡é—®é¢˜ã€‚é‚£å¦‚æœæ˜¯æ…¢äº†å‘¢ï¼Ÿç›´æ¥è°ƒæ…¢è¡Œå—ï¼Œå‰é¢è¯´äº†ï¼Œä¸è¡Œï¼Œè¿™å›è®©æ—¶é—´å€’é€€ã€‚\nå®é™…ä¸Šï¼Œè®¡ç®—æœºç³»ç»Ÿå¯ä»¥é‡‡ç”¨ä¸€ç§é€æ­¥è°ƒæ•´çš„æ–¹å¼ã€‚æ¯”å¦‚ï¼Œå‡è®¾è®¡æ—¶å™¨è®¾ç½®ä¸ºæ¯ç§’äº§ç”Ÿ100ä¸ªä¸­æ–­ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¯ä¸ªä¸­æ–­å°†æ·»åŠ 10msï¼Œå½“å‡æ…¢æ—¶ï¼Œæ¯ä¸ªä¸­æ–­ä¾‹ç¨‹åªæ·»åŠ 9msï¼Œç›´åˆ°æ ¡æ­£å®Œæˆä¸ºæ­¢ã€‚åŒæ ·çš„ï¼Œé€šè¿‡åœ¨æ¯ä¸ªä¸­æ–­ä¸­æ·»åŠ 11msï¼Œæ—¶é’Ÿä¹Ÿå¯ä»¥é€æ­¥å¾€å‰è°ƒå¿«ã€‚\nç½‘ç»œæ—¶é—´åè®®åœ¨æœåŠ¡å™¨ä¹‹é—´åˆ›å»ºäº†ä¸¤æ¡è¿æ¥ï¼Œæ¯”å¦‚ä¸Šé¢è®²äº†Aå¯ä»¥å‚è€ƒBçš„æ—¶é—´è°ƒæ•´è‡ªå·±çš„æ—¶é—´ï¼ŒåŸåˆ™ä¸ŠBä¹Ÿå¯ä»¥å‚ç…§Açš„è°ƒæ•´è‡ªå·±çš„å‘€ï¼æ˜¯è¿™æ ·å—ï¼Œå¦‚æœBä¸Šé¢è£…äº†WWVæ¥æ”¶å™¨æˆ–è€…åŸå­é’Ÿï¼Œé‚£ä¹ˆä¸€ä¸ªæ‹¥æœ‰ç²¾ç¡®æ—¶é—´çš„NTPå»å‚è€ƒä¸€ä¸ªé æ™®é€šçŸ³è‹±æ™¶ä½“ç»´æŠ¤æ—¶é—´çš„NTPï¼Œè¿™ä¸æ˜¯çŠ¯å‚»å—ï¼Ÿæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\nNTPæœåŠ¡å™¨ä¹Ÿæ˜¯åˆ†å±‚çš„ï¼Œé€šå¸¸æ‹¥æœ‰WWVæ¥æ”¶å™¨æˆ–è€…åŸå­é’Ÿçš„ï¼Œç§°ä¸º1å±‚æœåŠ¡å™¨ï¼Œé‚£0å±‚æ˜¯è°ï¼ŸOKï¼Œ0å±‚æŒ‡çš„æ˜¯æ—¶é’Ÿæœ¬èº«ã€‚å…¶ä»–kå±‚ï¼ˆk\u0026gt;1ï¼‰æœåŠ¡å™¨å¯ä»¥å‚è€ƒk-1å±‚çš„æœåŠ¡å™¨æ¥å®Œæˆæ—¶é—´åŒæ­¥ï¼Œåè¿‡æ¥åˆ™ä¸è¡Œã€‚å¦‚æœä¸€ä¸ªNTPæœåŠ¡å™¨æ˜¯kå±‚æœåŠ¡å™¨ï¼Œå¦ä¸€ä¸ªæœåŠ¡å™¨æ˜¯k+2å±‚æœåŠ¡å™¨ï¼Œå…¶å¦‚æœé€šè¿‡kå±‚æœåŠ¡å™¨è°ƒæ•´åï¼Œå®ƒå°†ä»k+2å±‚å˜ä¸ºk+1å±‚ã€‚\nNTPä¸­è¿˜æ˜¯æœ‰å¾ˆå¤šé‡è¦çš„ç‰¹æ€§çš„ï¼Œå¹¶ä¸æ˜¯åƒæˆ‘ä»¬æƒ³è±¡çš„é‚£ä¹ˆç®€å•ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å‚è€ƒç›¸å…³èµ„æ–™ã€‚\nå¦‚ä½•è§£å†³æ—¶é—´æ¼‚ç§»é—®é¢˜ # å‰é¢æˆ‘ä»¬ä»‹ç»äº†æµ‹é‡æ—¶é—´çš„æ–¹å¼ï¼Œä»ç»éªŒä¸»ä¹‰ï¼Œåˆ°å¤©æ–‡å­¦æµ‹é‡ï¼Œåˆ°ç‰©ç†å­¦æµ‹é‡ï¼Œä»¥åŠå…¼é¡¾ç‰©ç†å­¦ã€å¤©æ–‡å­¦çš„æµ‹é‡ï¼Œæ–¹å¼ä¹Ÿä¸€æ­¥æ­¥æ›´åŠ ç²¾ç¡®ã€å®Œå–„ã€å®ç”¨ã€‚æˆ‘ä»¬è¿˜è°ˆåˆ°äº†è®¡ç®—æœºç³»ç»Ÿä¸­çš„æ—¶é—´ç³»ç»Ÿæ˜¯å¦‚ä½•æ›´æ–°çš„ã€‚æƒ³å¿…å¤§å®¶æ„Ÿè§‰å¯¹äºè¿™ä¸ªæ˜Ÿçƒä¸Šçš„æ—¶é—´ç³»ç»Ÿçš„å·¥ä½œåŸç†æ›´æ¸…æ™°äº†ã€‚\nè¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ—¶é—´æ¼‚ç§»é—®é¢˜ã€‚å°½ç®¡æˆ‘ä»¬å‰é¢æåŠäº†ç²¾ç¡®æµ‹é‡æ—¶é—´ã€æ—¶é—´åŒæ­¥åè®®ç­‰å°½å¯èƒ½ä¿è¯æ—¶é—´å‡†ç¡®çš„æ–¹å¼ï¼Œä½†æ˜¯æ•ˆæœä¹Ÿæ˜¯â€å°½å¯èƒ½â€è®©å…¶ç²¾ç¡®ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸èƒ½ç™¾åˆ†ç™¾åœ°ä¿è¯å…¨çƒæ‰€æœ‰ç”µå­è®¾å¤‡ã€åˆ†å¸ƒå¼ç³»ç»Ÿä¸­èŠ‚ç‚¹çš„æ—¶é—´æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œç”šè‡³æ˜¯åŒä¸€ä¸ªè®¡ç®—æœºä½†æ˜¯æ˜¯å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­çš„å¤šä¸ªæ—¶é’Ÿä¹Ÿä¸æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚\nè¿™å›å¸¦æ¥ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æœè¿è¡Œå…¶ä¸Šçš„ç³»ç»Ÿï¼Œä¾èµ–â€œæ—¶é—´â€å¯¹æ“ä½œé¡ºåºæ‰§è¡Œå…ˆååšåˆ¤æ–­ï¼Œé‚£è¿™æ ·çš„ç³»ç»Ÿå¾ˆå¯èƒ½æ˜¯å­˜åœ¨é—®é¢˜çš„ã€‚\nåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨â€œé€»è¾‘æ—¶é’Ÿâ€ã€â€œå‘é‡æ—¶é’Ÿâ€ç­‰æ–¹å¼æ¥ä»£æ›¿çœŸå®æ—¶é’Ÿï¼Œæ¥ä½œä¸ºæ“ä½œé¡ºåºæ‰§è¡Œå…ˆåçš„åˆ¤æ–­ä¾æ®ã€‚è¿™é‡Œçš„å†…å®¹æœ‰å¾ˆå¤šï¼Œåé¢æˆ‘ä»¬æœ‰æœºä¼šå†å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»ã€‚\næ€»ç»“ # æœ¬æ–‡å¼€å¤´ç»™å¤§å®¶æ³¼äº†ç‚¹å†·æ°´ï¼Œå¾ˆå¯èƒ½è®©éƒ¨åˆ†è¯»è€…å¯¹è‡ªä¿¡äº†è§£çš„æ—¶é—´æ²¡äº†ä¿¡å¿ƒ :) ï¼Œç„¶åæˆ‘ä»¬ä»‹ç»äº†æ—¶é—´æµ‹é‡æ–¹å¼çš„ä¸€äº›æ¼”å˜ï¼Œä»¥åŠè®¡ç®—æœºç³»ç»Ÿä¸­å¦‚ä½•ä¿æŒæ—¶é—´çš„åŒæ­¥ï¼Œæœ€ååˆæŠ›å‡ºäº†å¦ä¸€ä¸ªå€¼å¾—æ·±æ€çš„é—®é¢˜ï¼Œå¦‚ä½•è§£å†³æ—¶é—´æ¼‚ç§»é—®é¢˜åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿã€åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¦æ¥çš„æ—¶åºç›¸å…³çš„é—®é¢˜ã€‚\nç›¸ä¿¡å¤§å®¶å¯¹æ—¶é—´æœ‰äº†ä¸€ä¸ªæ›´æ·±çš„è®¤è¯†ï¼Œä¹Ÿå¸Œæœ›æ¿€å‘äº†å¤§å®¶å¯¹æ—¶é—´çš„è¿›ä¸€æ­¥æ€è€ƒå§ã€‚\nå‚è€ƒæ–‡çŒ®ï¼š\n leap second five different ways handle leap seconds what is a leap second leapsecond.com interesting info on leap second gps network time synchonization  "}),a.add({id:210,href:"/tags/%E9%97%B0%E7%A7%92/",title:"é—°ç§’",description:"",content:""}),a.add({id:211,href:"/tags/invalidate-queue/",title:"invalidate queue",description:"",content:""}),a.add({id:212,href:"/tags/memory-barrier/",title:"memory barrier",description:"",content:""}),a.add({id:213,href:"/tags/store-buffer/",title:"store buffer",description:"",content:""}),a.add({id:214,href:"/blog/2020-12-15-%E7%A1%AC%E4%BB%B6%E8%A7%86%E8%A7%92%E5%89%96%E6%9E%90%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/",title:"ç¡¬ä»¶è§†è§’å‰–æå†…å­˜å±éšœå®ç°åŸç†",description:"å†…å­˜å±éšœç±»å‹ # è½¯ä»¶å¼€å‘ä¸­åˆ›å»ºå±éšœ # ç¡¬ä»¶è§†è§’çœ‹å±éšœå®ç° # æ€»ç»“ # text goes here",content:"å†…å­˜å±éšœç±»å‹ # è½¯ä»¶å¼€å‘ä¸­åˆ›å»ºå±éšœ # ç¡¬ä»¶è§†è§’çœ‹å±éšœå®ç° # æ€»ç»“ # text goes here\n"}),a.add({id:215,href:"/tags/%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/",title:"ä»£ç è§„èŒƒ",description:"",content:""}),a.add({id:216,href:"/tags/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/",title:"ä»£ç è´¨é‡",description:"",content:""}),a.add({id:217,href:"/tags/%E5%8F%AF%E8%AF%BB%E6%80%A7/",title:"å¯è¯»æ€§",description:"",content:""}),a.add({id:218,href:"/blog/2020-10-16-%E5%81%B7%E6%87%92%E4%BB%8E%E6%8F%90%E5%8D%87%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%BC%80%E5%A7%8B/",title:"å¦‚ä½•â€œå·æ‡’â€ï¼šä»æå‡ä»£ç è´¨é‡å¼€å§‹",description:"å¦‚æœä¸€ä»¶äº‹æƒ…åªéœ€è¦åšä¸€æ¬¡ï¼Œæˆ‘ä»¬å¯èƒ½æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ï¼Œä½†æ˜¯å¦‚æœä¸€ä»¶äº‹æƒ…è¦é‡å¤åƒç™¾éï¼Œæ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥å°±ä¼šå˜æˆç¾éš¾ã€‚å¯¹èº«ä½“ï¼Œå¯¹æ—¶é—´ï¼Œå¯¹å›¢é˜Ÿã€‚åœä¸‹æ¥æƒ³æƒ³è¿‡å»åšçš„ä¸€äº›äº‹æƒ…ï¼Œéƒ½æ˜¯ä¸ºäº†åšå¥½äº‹æƒ…çš„åŒæ—¶ï¼Œèƒ½è®©è‡ªå·±æ›´å¥½åœ°æ…¢ä¸‹æ¥ï¼Œè®©èº«ä½“å¯ä»¥å·æ‡’ã€‚æœ¬æ–‡å…ˆä»æå‡ä»£ç è´¨é‡å¼€å§‹è°ˆèµ·ã€‚\nLinus Torvardsåœ¨ä¸€æ¬¡é‡‡è®¿ä¸­ï¼Œä¸»æŒäººè´´äº†ä¸¤ä¸ªé“¾è¡¨æ“ä½œçš„å®ç°ï¼Œè®©å…¶è¯„ä»·å“ªä¸€ç§æ›´å¥½ä¸€ç‚¹ï¼ŒTorvardsè¯´æ›´å–œæ¬¢æ¶ˆé™¤äº†ç‰¹æ®Šé€»è¾‘çš„é‚£ç§ï¼Œå¹¶å°†è¿™ç§åå¥½ç§°ä¸ºâ€œtasteâ€ã€‚æ¯ä¸ªäººçš„tasteä¸åŒï¼Œä¹Ÿä¸æ–¹ä¾¿è¯„ä»·å¥½ä¸åï¼Œä½†æ˜¯â€œè„‘ç­‹æ€¥è½¬å¼¯ä¼¼â€çš„åšæ³•ä¸€ç‚¹éƒ½ä¸â€œèªæ˜â€ã€‚å¥½çš„æ€è·¯å¾ˆå¤šéƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸å¥½çš„ä¸œè¥¿åƒå·®ä¸‡åˆ«çš„å‰å®³ã€‚\nç«™åœ¨å·¨äººè‚©è†€ä¸Š # ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Œæˆ‘å¼€å§‹æ€è€ƒå¦‚ä½•åœ¨æœ‰é™çš„æ—¶é—´é‡Œæ¶‰çŒæ›´å¤šçš„ä¸œè¥¿ï¼Œawesomeã€101ã€patternsã€slideshareã€best practices\u0026hellip;ä¼¼ä¹æœ‰é™çš„æ—¶é—´è¢«å»¶é•¿äº†ï¼Œæˆ‘ä»¬æ²¡å¿…è¦ä¸€ä¸ªä¸ªå‘çš„è¸©è¿‡æ¥æ‘¸ç´¢ä¸­å‰è¿›ï¼Œåˆ«æŠŠåˆ«äººå¤´ç ´è¡€æµæ€»ç»“å‡ºçš„ç»éªŒæ•™è®­ä¸å½“å›äº‹ã€‚ä»¥å‰æˆ‘å¥‰è¡Œâ€œçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ã€ç»çŸ¥æ­¤äº‹è¦èº¬è¡Œâ€ï¼Œå¾ˆå¥½ï¼Œä½†æ˜¯ç”Ÿå‘½æ˜¯æœ‰é™çš„ã€‚\næƒ³è¦æ›´å¤§çš„ä¸–ç•Œï¼Œå¿…é¡»æ‡‚å¾—å€ŸåŠ›ï¼Œå¸æ”¶ç»éªŒæ•™è®­ï¼Œå¥½çš„åçš„å…¨éƒ¨ç»Ÿç»Ÿå¸çº³æ»‹å…»è‡ªå·±ã€‚\nå¯¹å¼‚å¸¸å…³æ³¨ä¸è¶³ï¼Œæœªå…»æˆå®‰å…¨ç¼–ç¨‹ä¹ æƒ¯ # ç»å¸¸çœ‹åˆ° if ok {...} else {...} è¿™æ ·çš„ä»£ç ï¼Œæ²¡æœ‰å…»æˆä¼˜å…ˆå¤„ç†å¼‚å¸¸çš„ä¹ æƒ¯ã€‚å¯¼è‡´å‡ºç°å¤šä½™çš„if-elseåˆ†æ”¯æ˜¯å°äº‹ï¼Œæ€•çš„æ˜¯ï¼Œè¿™ä¹ˆä¹ æƒ¯äº†å®¹æ˜“äº§ç”Ÿä¸‹é¢çš„é—®é¢˜ï¼šifä¸­å…ˆå¤„ç†æ­£å¸¸é€»è¾‘ï¼Œelseä¸­å†äº‹åè¡¥å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œè€Œå¯¹å¼‚å¸¸æƒ…æ™¯çš„ç»†åˆ†ï¼Œä¹Ÿå¯èƒ½ä¼šå› ä¸ºâ€œåŠŸèƒ½å·²å®Œæˆã€å¼‚å¸¸å“ªæœ‰é‚£ä¹ˆå·§å‡ºç°â€çš„ä¾¥å¹¸å¿ƒç†è€Œæœ‰æ‰€å€¦æ€ ï¼Œå¦‚rpcé”™è¯¯æ˜¯ç½‘ç»œé”™è¯¯ã€è¶…æ—¶è¿˜æ˜¯é€»è¾‘é€»è¾‘ï¼Œæ¯ç§è¯¥ä½œä½•å¤„ç†ï¼Œå¯èƒ½ä¼šè‰è‰äº†äº‹ã€‚ä¸èƒ½è¯´è¿™ç§æ‹…å¿ƒæ˜¯å¤šä½™çš„ï¼Œäººéƒ½æ˜¯å±é©´çš„ï¼Œè‡ªå·±ä¹Ÿä¼šæœ‰è¿™ç§æƒ°æ€§ã€‚\nå¯¹è¾“å…¥ä¸åšæ ¡éªŒï¼Œâ€œä¸å¤§å¯èƒ½â€ï¼Œè¿™ä¸èƒ½ç®—æ˜¯ä¸€ä¸ªåˆç†çš„ç†ç”±ï¼Œâ€œè°ƒç”¨æ–¹åˆ¤æ–­â€ï¼Œè¿™æ›´ä¸åˆç†ã€‚è¿™å°±å¥½æ¯”æˆ‘æƒ³åƒé¥­äº†ï¼Œä»å•†å®¶ä¹°åˆ°è¿‡ä¿è´¨æœŸçš„é£Ÿç‰©ï¼Œé‚£æˆ‘ä½œä¸ºæ´»åŠ¨çš„å‘èµ·æ–¹ï¼ˆè°ƒç”¨æ–¹ï¼‰æˆ‘è‚¯å®šä¼šæ£€æŸ¥ä¸‹é£Ÿç‰©ä¿è´¨æœŸï¼Œä½†æ˜¯å•†å®¶ä¹Ÿä¸èƒ½ä¸ç®¡ä¿è´¨æœŸå°±å–ç»™æˆ‘å§ã€‚é‚£è¿™ä¹ˆçœ‹ï¼Œæ˜¯è°ƒç”¨æ–¹æ£€æŸ¥ï¼Œè¿˜æ˜¯æä¾›æ–¹æ£€æŸ¥ï¼Œè¿˜æ˜¯æ²¡å¿…è¦ã€‚è‡ªå·±çš„å‡½æ•°å‘è‡ªå·±çš„æœåŠ¡ï¼Œä¹Ÿæ˜¯å‘ã€‚\næ¯æ¯æåŠâ€œé«˜å¯ç”¨â€ã€5ä¸ª9ï¼Œå¤§å®¶å°±ç«–èµ·è€³æœµå¬ï¼Œå¯æ˜¯è¿åŸºæœ¬çš„è¿›ç¨‹çº§çš„å¥å£®æ€§éƒ½ä¸ä¸‹åŠŸå¤«ï¼Œåˆæ€ä¹ˆå»å¥¢æ±‚è¯—å’Œè¿œæ–¹ã€‚\nå†™çš„è™½ç„¶æ˜¯ä»£ç ï¼Œä½†å…¶å®æ˜¯é€»è¾‘çš„è¡¨è¾¾ # å‘æ˜é«˜çº§è¯­è¨€çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºäº†æ›´å¥½çš„è¡¨è¾¾ï¼Œä½†æ˜¯æˆ‘ä»¬å­¦ä¼šäº†ç¼–ç¨‹è¯­è¨€ï¼Œå´å¿˜äº†æ€ä¹ˆè¡¨è¾¾ã€‚\næˆ‘æƒ³äº†æƒ³é‚£äº›å¥½çš„æ–‡ç« æ˜¯æ€ä¹ˆå†™çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¸ç›çš„æ ‡é¢˜æ¥æƒ¹äººå…³æ³¨ï¼Œéœ€è¦æ—¶åˆ»ä¸å¿˜ä¸­å¿ƒæ€æƒ³é¿å…è®ºè¿°è¿‡äºæ¶£æ•£ï¼Œè¿˜éœ€è¦å‡¤å¤´çŒªè‚šè±¹å°¾æ¥å±‚å±‚è®ºè¿°ï¼Œæ¯ä¸ªæ®µè½ä¹Ÿè¦æœ‰æçº²æŒˆé¢†çš„ä¸­å¿ƒå¥ã€‚å¦‚æœè¯´æ˜¯ä¸€æœ¬ä¹¦ï¼Œä¹Ÿè¿˜æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯åˆæœ‰äº†å…¶ä»–çš„è¦æ±‚ï¼Œç« èŠ‚å¹¶ä¸æ˜¯ç¡¬æ€§çš„åˆ‡å‰²ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å‰è¨€é‡Œä¼šçœ‹åˆ°ï¼Œæ‚¨å¯ä»¥æ ¹æ®æƒ…å†µè‡ªä¸»é€‰æ‹©æ„Ÿå…´è¶£çš„ç« èŠ‚é˜…è¯»ï¼Œé‚£æ˜¯å› ä¸ºå„ä¸ªç« èŠ‚ç›¸å¯¹ç‹¬ç«‹ï¼Œç»“åˆèµ·æ¥åˆå½¢æˆä¸€ä¸ªæ›´å®Œå¤‡çš„è®ºè¿°ã€‚\né‚£ï¼Œä»£ç è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ\nä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰é€»è¾‘ï¼Œå¹³é“ºåœ¨ä¸€ä¸ªå·¥ç¨‹ä¸‹çš„æºæ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰ä»»ä½•æ¨¡å—åŒ–çš„ç»„ç»‡ï¼Œæ¯”å¦‚goé¡¹ç›®æ²¡æœ‰ä»»ä½•packageï¼Œé‚£æˆ‘ä»¬çš„é€»è¾‘æ˜¯å˜å¤æ‚äº†è¿˜æ˜¯å˜ç®€å•äº†ï¼Ÿ å‡½æ•°ã€æ–¹æ³•è°ƒç”¨ä½“ç°çš„æ˜¯ä¸€ç§é€šä¿¡ï¼Œå½“æˆ‘ä»¬å»å’Œåˆ«äººæ²Ÿé€šæ—¶ï¼Œæˆ‘ä»¬ä¸€å®šæ˜¯æ¸…æ™°åœ°çŸ¥é“åˆ«äººèƒ½æä¾›æˆ‘ä»¬éœ€è¦çš„æœåŠ¡ï¼Œæ‰ä¼šå»é€‰æ‹©ä¸å…¶æ²Ÿé€šï¼Œè€Œä¸”ä¸ºäº†æœ‰æ•ˆç‡çš„æ²Ÿé€šï¼Œè¿˜è¦è¨€ç®€æ„èµ…ã€‚é‚£ä¸€ä¸ªpackageã€receiverä¸‹çš„å‡½æ•°ã€æ–¹æ³•ä¸åŒºåˆ†å¯¼å‡ºã€éå¯¼å‡ºï¼Œé‚£è¯¥é€‰æ‹©å“ªä¸ªå‘èµ·é€šä¿¡å‘¢ï¼Ÿè€Œä¸”å†…éƒ¨çš„ä¸€äº›å®ç°ç»†èŠ‚ä¹Ÿä¸å…³å¿ƒï¼Œæˆ‘åªå…³å¿ƒèƒ½ä¸èƒ½ä¹°åˆ°æœåŠ¡ã€‚ å®Œæˆä¸€é¡¹ä»»åŠ¡ï¼Œæ€»å¯ä»¥æ‹†åˆ†æˆå‡ ä¸ªæ­¥éª¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå†™ä¼ªä»£ç åˆ—å‡ºtodolistï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€é¡¹todoéƒ½æ˜¯ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é€»è¾‘ï¼Œè¿˜å¯ä»¥ä¸ºæ¯ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é€»è¾‘åŠ ä¸€è¡Œç®€å•çš„æ³¨é‡Šï¼Œæœ«å°¾åŠ ç©ºè¡Œéš”å¼€ï¼Œä»¥ä½“ç°å‡ºé€»è¾‘åŒºå—ã€‚éš¾é“ä»å¤´æ’¸åˆ°å°¾èƒ½å°†é€»è¾‘è¡¨è¾¾çš„æ›´æ¸…æ™°ï¼Ÿæƒ³è±¡ä¸€ç¯‡æ²¡æœ‰æ ‡ç‚¹çš„ä½œæ–‡è¯¥æ€æ ·é˜…è¯»ï¼Ÿ â€¦â€¦ æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è¯´ç¼–ç å¥½åæ˜¯ä¹ æƒ¯é—®é¢˜ï¼Œæ˜¯tasteï¼Œä½†æˆ‘è§‰å¾—æ˜¯æ€ç»´ä¹ æƒ¯çš„é—®é¢˜ã€‚è¿™æ ·çš„ä¹ æƒ¯æ—¥ç§¯æœˆç´¯ï¼Œè´Ÿé¢å½±å“å¯èƒ½ä¼šæ›´å¤§ã€‚\nç®€å•ç‚¹å†ç®€å•ç‚¹ï¼Œç®€å•å¯ä¾èµ– # ä»€ä¹ˆæ˜¯ç®€å•ï¼Ÿæ˜¯æ–¹ä¾¿ï¼Œæ˜¯çœå¿ƒï¼Ÿæˆ‘è§‰å¾—æ˜¯è¯šå®ä¸éšç’ï¼Œæ˜¯å°±æ˜¯ï¼Œä¸æ˜¯å°±ä¸æ˜¯ã€‚æœ€æ¨çš„å°±æ˜¯é‚£äº›è¡¨é¢å…‰æ­£èƒŒåæå°åŠ¨ä½œçš„ä»£ç ã€‚\næœ‰äº›ä»£ç è¡¨é‡Œä¸ä¸€ï¼Œè¡¨é¢æ˜¯ä¸€å¥—ï¼ŒèƒŒåæ˜¯ä¸€å¥—ã€‚å‘½åè¯´æ˜¯åšè¿™ä¸ªï¼Œç»“æœèƒŒåä¸å¹²è¿™ä¸ªï¼Œæˆ–è€…é™¤äº†å¹²è¿™ä¸ªè¿˜å¹²åˆ«çš„ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ä¸€äº›æ ‡å‡†åº“çš„apiçš„æ—¶å€™å°±æ„¿æ„é€‰æ‹©ç›¸ä¿¡å®ƒï¼Œä½†æ˜¯çœ‹æˆ‘ä»¬è‡ªå·±ä»£ç çš„æ—¶å€™å°±ä¸å¾—ä¸é¢‘ç¹åœ°è·³æ¥è·³å»å‘¢ï¼Ÿ\nä¸ç›¸ä¿¡å†™çš„ä»£ç ï¼ŒåŸå› è·Ÿä¸‹é¢ç»å¸¸é‡åˆ°çš„é—®é¢˜ç›¸å…³ï¼Œç»è¿‡äº†ç°å®çš„æ¶æ‰“åªèƒ½å…ˆâ€œå¦çœ¼ç›¸çœ‹â€ï¼› å¯¼å‡ºç±»å‹ã€æ–¹æ³•ã€å‡½æ•°ã€å˜é‡ã€å¸¸é‡ç¼ºä¹å¿…è¦çš„æ³¨é‡Šï¼Œä¸å¾—å·²åªèƒ½è·³è¿‡å»çœ‹ä»£ç ï¼› å‡½æ•°ç­¾åå¤šè¿”å›å€¼æ²¡æœ‰å¿…è¦è¯´æ˜ï¼Œå¦‚è¿”å›å€¼å˜é‡åï¼Œé™¤äº†æœ€åä¸€ä¸ªæ˜¯errorä¸çŸ¥å…¶ä»–å¹²å˜›çš„ï¼Œåªèƒ½è·³è¿‡å»çœ‹returnï¼Œé—®é¢˜æ˜¯è¿˜æœ‰å¤šä¸ªreturnå‡ºå£ï¼› å‡½æ•°ç­¾åå‚æ•°åˆ—è¡¨ï¼Œshorter \u0026amp; simplerï¼Œå¦‚æœæœ‰è¿‘10ä¸ªã€20æ¥ä¸ªå‚æ•°ï¼Œæ€ä¹ˆè®°å¾—ä½å½¢å‚ï¼Ÿä¼ å®å‚çš„æ—¶å€™ä¼šä¸ä¼šå¯¹åº”é”™è¯¯ï¼Ÿå“ªäº›å‚æ•°æ˜¯å¿…å¡«ã€é€‰å¡«ï¼Ÿå‘½åæ˜¯å¦èƒ½å‡†ç¡®æ¸…æ™°åœ°è¦†ç›–è¿™äº›å‚æ•°ï¼Ÿ hacké€»è¾‘ï¼Œå¦‚ç¡¬ç¼–ç ï¼Œè¿™äº›æŸå¤±çš„ä¸åªæ˜¯çµæ´»æ€§ï¼Œä¹Ÿæ¤å…¥äº†ä¸€äº›æš—é»‘æ“ä½œã€‚ä¸€ä¸ªå¥½çš„è½¯ä»¶æ¶æ„å¸ˆåº”è¯¥åšåˆ°â€œmake the invisible visibleâ€ï¼Œinvisibleçš„ä¸€ä¸ªç›´è§‚çš„å®³å¤„å°±æ˜¯ï¼Œè¶Šä¿ä»£åº–çš„äº‹æƒ…ä¼šå˜å¾—æ™®éï¼Œæœ¬æ¥å¯ä»¥ç”±è°ƒç”¨æ–¹æ”¯é…çš„ä¸€äº›æ§åˆ¶å‚æ•°ï¼Œè¢«ç‹¬æ–­ä¸“è¡Œäº†ï¼Œæœ¬æ¥åº”è¯¥ä¸Šå‡åˆ°ç³»ç»Ÿå±‚é¢çš„é—®é¢˜ï¼Œè¢«ä¸€ä¸ªæ¨¡å—å·å·ä»£è¡¨äº†ï¼› â€¦â€¦ æˆ‘çš„é€»è¾‘æ˜¯ï¼Œåªè¦é˜…è¯»ä»£ç çš„æ—¶å€™æœ‰éå¸¸é¢‘ç¹çš„è·³è½¬ã€æ¨å¯¼ã€å‡è®¾ã€éªŒè¯çš„è¿‡ç¨‹ï¼Œé‚£è¿™ä¸ªä»£ç çš„å¯è¯»æ€§å°±çœŸçš„ä¸æ€ä¹ˆæ ·ã€‚\nå…¬å¸ä»£ç è§„èŒƒ # åªè¦æ˜¯è§„èŒƒï¼Œå°±æœ‰å±€é™æ€§ã€æ»åæ€§ã€‚æˆ‘ç†è§£ï¼Œè§„èŒƒä¸æ˜¯è®©æˆ‘ä»¬è¿½æ±‚å®Œç¾ä¸»ä¹‰ï¼Œè€Œæ˜¯è¿½æ±‚better codeï¼Œbetter practicesã€‚å¦‚æœä¸€ä¸ªå¼€å‘è€…æœ‰å¥½çš„tasteï¼Œä»–å†™å‡ºæ¥çš„ä»£ç å¯èƒ½å·²ç»æ¥è¿‘æˆ–è¾¾åˆ°è§„èŒƒçš„è¦æ±‚äº†ã€‚ä½†æ˜¯å¹¶ä¸æ˜¯æ¯ä¸ªå¼€å‘è€…éƒ½æœ‰è¿™æ ·çš„tasteï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦è§„èŒƒæ¥çº¦æŸæˆ‘ä»¬åšä¸€ä»¶å…±åŒçš„äº‹æƒ…ã€‚\néµå®ˆä»£ç è§„èŒƒçš„ä¸€ä¸ªæ˜æ˜¾çš„å¥½å¤„æ˜¯ï¼Œå¯è¯»æ€§ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„æå‡ï¼Œè¿™æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚å¯è¯»æ€§æå‡ï¼Œæ„å‘³ç€ç»´æŠ¤æˆæœ¬é™ä½ï¼Œæ„å‘³ç€çœä¸‹æ—¶é—´ï¼Œæ„å‘³ç€å¯ä»¥åœ¨æ­£å¸¸å·¥ä½œæ—¶é—´åšæ›´å¤šäº‹æƒ…ï¼Œå¯ä»¥æ—©ä¸‹ç­ä¼‘æ¯ã€å……ç”µã€‚è¿™å¯èƒ½ä¸æ˜¯å¯¹æ¯ä¸ªäººéƒ½æ˜¯ä¸ªå¥½äº‹æƒ…ï¼Œä½†æ˜¯æ˜¯å¯¹å›¢é˜Ÿæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œå¯¹å¤šæ•°äººæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œå°±åº”è¯¥åšæŒï¼\næœ€å # å¤šå¹´å‰ç¿»é˜…Linuxæ–‡æ¡£ï¼ŒTorvardsè§£é‡Šä¸ºä»€ä¹ˆä¸€ä¸ªTabéè¦8ä¸ªç©ºæ ¼è€Œéé€šç”¨çš„4ä¸ªï¼Œä»–è¯´ï¼Œæˆ‘å°±æ˜¯è¦è®©é‚£äº›çˆ±å†™åµŒå¥—å¤šå±‚ä»£ç çš„äººâ€œéš¾å—â€â€¦â€¦\nçœä¸‹å¤§æŠŠè‡ªå·±ã€å¤§å®¶çš„æ—¶é—´ï¼Œè¿™éš¾é“ä¸æ˜¯ä¸€ç§å¾ˆèªæ˜çš„â€œå·æ‡’â€è¡Œä¸ºï¼Ÿ",content:"å¦‚æœä¸€ä»¶äº‹æƒ…åªéœ€è¦åšä¸€æ¬¡ï¼Œæˆ‘ä»¬å¯èƒ½æ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥ï¼Œä½†æ˜¯å¦‚æœä¸€ä»¶äº‹æƒ…è¦é‡å¤åƒç™¾éï¼Œæ€ä¹ˆæ–¹ä¾¿æ€ä¹ˆæ¥å°±ä¼šå˜æˆç¾éš¾ã€‚å¯¹èº«ä½“ï¼Œå¯¹æ—¶é—´ï¼Œå¯¹å›¢é˜Ÿã€‚åœä¸‹æ¥æƒ³æƒ³è¿‡å»åšçš„ä¸€äº›äº‹æƒ…ï¼Œéƒ½æ˜¯ä¸ºäº†åšå¥½äº‹æƒ…çš„åŒæ—¶ï¼Œèƒ½è®©è‡ªå·±æ›´å¥½åœ°æ…¢ä¸‹æ¥ï¼Œè®©èº«ä½“å¯ä»¥å·æ‡’ã€‚æœ¬æ–‡å…ˆä»æå‡ä»£ç è´¨é‡å¼€å§‹è°ˆèµ·ã€‚\nLinus Torvardsåœ¨ä¸€æ¬¡é‡‡è®¿ä¸­ï¼Œä¸»æŒäººè´´äº†ä¸¤ä¸ªé“¾è¡¨æ“ä½œçš„å®ç°ï¼Œè®©å…¶è¯„ä»·å“ªä¸€ç§æ›´å¥½ä¸€ç‚¹ï¼ŒTorvardsè¯´æ›´å–œæ¬¢æ¶ˆé™¤äº†ç‰¹æ®Šé€»è¾‘çš„é‚£ç§ï¼Œå¹¶å°†è¿™ç§åå¥½ç§°ä¸ºâ€œtasteâ€ã€‚æ¯ä¸ªäººçš„tasteä¸åŒï¼Œä¹Ÿä¸æ–¹ä¾¿è¯„ä»·å¥½ä¸åï¼Œä½†æ˜¯â€œè„‘ç­‹æ€¥è½¬å¼¯ä¼¼â€çš„åšæ³•ä¸€ç‚¹éƒ½ä¸â€œèªæ˜â€ã€‚å¥½çš„æ€è·¯å¾ˆå¤šéƒ½æ˜¯ç›¸åŒçš„ï¼Œä¸å¥½çš„ä¸œè¥¿åƒå·®ä¸‡åˆ«çš„å‰å®³ã€‚\nç«™åœ¨å·¨äººè‚©è†€ä¸Š # ä»ä»€ä¹ˆæ—¶å€™å¼€å§‹ï¼Œæˆ‘å¼€å§‹æ€è€ƒå¦‚ä½•åœ¨æœ‰é™çš„æ—¶é—´é‡Œæ¶‰çŒæ›´å¤šçš„ä¸œè¥¿ï¼Œawesomeã€101ã€patternsã€slideshareã€best practices\u0026hellip;ä¼¼ä¹æœ‰é™çš„æ—¶é—´è¢«å»¶é•¿äº†ï¼Œæˆ‘ä»¬æ²¡å¿…è¦ä¸€ä¸ªä¸ªå‘çš„è¸©è¿‡æ¥æ‘¸ç´¢ä¸­å‰è¿›ï¼Œåˆ«æŠŠåˆ«äººå¤´ç ´è¡€æµæ€»ç»“å‡ºçš„ç»éªŒæ•™è®­ä¸å½“å›äº‹ã€‚ä»¥å‰æˆ‘å¥‰è¡Œâ€œçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ã€ç»çŸ¥æ­¤äº‹è¦èº¬è¡Œâ€ï¼Œå¾ˆå¥½ï¼Œä½†æ˜¯ç”Ÿå‘½æ˜¯æœ‰é™çš„ã€‚\næƒ³è¦æ›´å¤§çš„ä¸–ç•Œï¼Œå¿…é¡»æ‡‚å¾—å€ŸåŠ›ï¼Œå¸æ”¶ç»éªŒæ•™è®­ï¼Œå¥½çš„åçš„å…¨éƒ¨ç»Ÿç»Ÿå¸çº³æ»‹å…»è‡ªå·±ã€‚\nå¯¹å¼‚å¸¸å…³æ³¨ä¸è¶³ï¼Œæœªå…»æˆå®‰å…¨ç¼–ç¨‹ä¹ æƒ¯ # ç»å¸¸çœ‹åˆ° if ok {...} else {...} è¿™æ ·çš„ä»£ç ï¼Œæ²¡æœ‰å…»æˆä¼˜å…ˆå¤„ç†å¼‚å¸¸çš„ä¹ æƒ¯ã€‚å¯¼è‡´å‡ºç°å¤šä½™çš„if-elseåˆ†æ”¯æ˜¯å°äº‹ï¼Œæ€•çš„æ˜¯ï¼Œè¿™ä¹ˆä¹ æƒ¯äº†å®¹æ˜“äº§ç”Ÿä¸‹é¢çš„é—®é¢˜ï¼šifä¸­å…ˆå¤„ç†æ­£å¸¸é€»è¾‘ï¼Œelseä¸­å†äº‹åè¡¥å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œè€Œå¯¹å¼‚å¸¸æƒ…æ™¯çš„ç»†åˆ†ï¼Œä¹Ÿå¯èƒ½ä¼šå› ä¸ºâ€œåŠŸèƒ½å·²å®Œæˆã€å¼‚å¸¸å“ªæœ‰é‚£ä¹ˆå·§å‡ºç°â€çš„ä¾¥å¹¸å¿ƒç†è€Œæœ‰æ‰€å€¦æ€ ï¼Œå¦‚rpcé”™è¯¯æ˜¯ç½‘ç»œé”™è¯¯ã€è¶…æ—¶è¿˜æ˜¯é€»è¾‘é€»è¾‘ï¼Œæ¯ç§è¯¥ä½œä½•å¤„ç†ï¼Œå¯èƒ½ä¼šè‰è‰äº†äº‹ã€‚ä¸èƒ½è¯´è¿™ç§æ‹…å¿ƒæ˜¯å¤šä½™çš„ï¼Œäººéƒ½æ˜¯å±é©´çš„ï¼Œè‡ªå·±ä¹Ÿä¼šæœ‰è¿™ç§æƒ°æ€§ã€‚\nå¯¹è¾“å…¥ä¸åšæ ¡éªŒï¼Œâ€œä¸å¤§å¯èƒ½â€ï¼Œè¿™ä¸èƒ½ç®—æ˜¯ä¸€ä¸ªåˆç†çš„ç†ç”±ï¼Œâ€œè°ƒç”¨æ–¹åˆ¤æ–­â€ï¼Œè¿™æ›´ä¸åˆç†ã€‚è¿™å°±å¥½æ¯”æˆ‘æƒ³åƒé¥­äº†ï¼Œä»å•†å®¶ä¹°åˆ°è¿‡ä¿è´¨æœŸçš„é£Ÿç‰©ï¼Œé‚£æˆ‘ä½œä¸ºæ´»åŠ¨çš„å‘èµ·æ–¹ï¼ˆè°ƒç”¨æ–¹ï¼‰æˆ‘è‚¯å®šä¼šæ£€æŸ¥ä¸‹é£Ÿç‰©ä¿è´¨æœŸï¼Œä½†æ˜¯å•†å®¶ä¹Ÿä¸èƒ½ä¸ç®¡ä¿è´¨æœŸå°±å–ç»™æˆ‘å§ã€‚é‚£è¿™ä¹ˆçœ‹ï¼Œæ˜¯è°ƒç”¨æ–¹æ£€æŸ¥ï¼Œè¿˜æ˜¯æä¾›æ–¹æ£€æŸ¥ï¼Œè¿˜æ˜¯æ²¡å¿…è¦ã€‚è‡ªå·±çš„å‡½æ•°å‘è‡ªå·±çš„æœåŠ¡ï¼Œä¹Ÿæ˜¯å‘ã€‚\næ¯æ¯æåŠâ€œé«˜å¯ç”¨â€ã€5ä¸ª9ï¼Œå¤§å®¶å°±ç«–èµ·è€³æœµå¬ï¼Œå¯æ˜¯è¿åŸºæœ¬çš„è¿›ç¨‹çº§çš„å¥å£®æ€§éƒ½ä¸ä¸‹åŠŸå¤«ï¼Œåˆæ€ä¹ˆå»å¥¢æ±‚è¯—å’Œè¿œæ–¹ã€‚\nå†™çš„è™½ç„¶æ˜¯ä»£ç ï¼Œä½†å…¶å®æ˜¯é€»è¾‘çš„è¡¨è¾¾ # å‘æ˜é«˜çº§è¯­è¨€çš„ç›®çš„ï¼Œå°±æ˜¯ä¸ºäº†æ›´å¥½çš„è¡¨è¾¾ï¼Œä½†æ˜¯æˆ‘ä»¬å­¦ä¼šäº†ç¼–ç¨‹è¯­è¨€ï¼Œå´å¿˜äº†æ€ä¹ˆè¡¨è¾¾ã€‚\næˆ‘æƒ³äº†æƒ³é‚£äº›å¥½çš„æ–‡ç« æ˜¯æ€ä¹ˆå†™çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¸ç›çš„æ ‡é¢˜æ¥æƒ¹äººå…³æ³¨ï¼Œéœ€è¦æ—¶åˆ»ä¸å¿˜ä¸­å¿ƒæ€æƒ³é¿å…è®ºè¿°è¿‡äºæ¶£æ•£ï¼Œè¿˜éœ€è¦å‡¤å¤´çŒªè‚šè±¹å°¾æ¥å±‚å±‚è®ºè¿°ï¼Œæ¯ä¸ªæ®µè½ä¹Ÿè¦æœ‰æçº²æŒˆé¢†çš„ä¸­å¿ƒå¥ã€‚å¦‚æœè¯´æ˜¯ä¸€æœ¬ä¹¦ï¼Œä¹Ÿè¿˜æ˜¯ç±»ä¼¼çš„ï¼Œä½†æ˜¯åˆæœ‰äº†å…¶ä»–çš„è¦æ±‚ï¼Œç« èŠ‚å¹¶ä¸æ˜¯ç¡¬æ€§çš„åˆ‡å‰²ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å‰è¨€é‡Œä¼šçœ‹åˆ°ï¼Œæ‚¨å¯ä»¥æ ¹æ®æƒ…å†µè‡ªä¸»é€‰æ‹©æ„Ÿå…´è¶£çš„ç« èŠ‚é˜…è¯»ï¼Œé‚£æ˜¯å› ä¸ºå„ä¸ªç« èŠ‚ç›¸å¯¹ç‹¬ç«‹ï¼Œç»“åˆèµ·æ¥åˆå½¢æˆä¸€ä¸ªæ›´å®Œå¤‡çš„è®ºè¿°ã€‚\né‚£ï¼Œä»£ç è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ\nä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰é€»è¾‘ï¼Œå¹³é“ºåœ¨ä¸€ä¸ªå·¥ç¨‹ä¸‹çš„æºæ–‡ä»¶ä¸­ï¼Œæ²¡æœ‰ä»»ä½•æ¨¡å—åŒ–çš„ç»„ç»‡ï¼Œæ¯”å¦‚goé¡¹ç›®æ²¡æœ‰ä»»ä½•packageï¼Œé‚£æˆ‘ä»¬çš„é€»è¾‘æ˜¯å˜å¤æ‚äº†è¿˜æ˜¯å˜ç®€å•äº†ï¼Ÿ å‡½æ•°ã€æ–¹æ³•è°ƒç”¨ä½“ç°çš„æ˜¯ä¸€ç§é€šä¿¡ï¼Œå½“æˆ‘ä»¬å»å’Œåˆ«äººæ²Ÿé€šæ—¶ï¼Œæˆ‘ä»¬ä¸€å®šæ˜¯æ¸…æ™°åœ°çŸ¥é“åˆ«äººèƒ½æä¾›æˆ‘ä»¬éœ€è¦çš„æœåŠ¡ï¼Œæ‰ä¼šå»é€‰æ‹©ä¸å…¶æ²Ÿé€šï¼Œè€Œä¸”ä¸ºäº†æœ‰æ•ˆç‡çš„æ²Ÿé€šï¼Œè¿˜è¦è¨€ç®€æ„èµ…ã€‚é‚£ä¸€ä¸ªpackageã€receiverä¸‹çš„å‡½æ•°ã€æ–¹æ³•ä¸åŒºåˆ†å¯¼å‡ºã€éå¯¼å‡ºï¼Œé‚£è¯¥é€‰æ‹©å“ªä¸ªå‘èµ·é€šä¿¡å‘¢ï¼Ÿè€Œä¸”å†…éƒ¨çš„ä¸€äº›å®ç°ç»†èŠ‚ä¹Ÿä¸å…³å¿ƒï¼Œæˆ‘åªå…³å¿ƒèƒ½ä¸èƒ½ä¹°åˆ°æœåŠ¡ã€‚ å®Œæˆä¸€é¡¹ä»»åŠ¡ï¼Œæ€»å¯ä»¥æ‹†åˆ†æˆå‡ ä¸ªæ­¥éª¤ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å…ˆå†™ä¼ªä»£ç åˆ—å‡ºtodolistï¼ŒåŸºæœ¬ä¸Šæ¯ä¸€é¡¹todoéƒ½æ˜¯ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é€»è¾‘ï¼Œè¿˜å¯ä»¥ä¸ºæ¯ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é€»è¾‘åŠ ä¸€è¡Œç®€å•çš„æ³¨é‡Šï¼Œæœ«å°¾åŠ ç©ºè¡Œéš”å¼€ï¼Œä»¥ä½“ç°å‡ºé€»è¾‘åŒºå—ã€‚éš¾é“ä»å¤´æ’¸åˆ°å°¾èƒ½å°†é€»è¾‘è¡¨è¾¾çš„æ›´æ¸…æ™°ï¼Ÿæƒ³è±¡ä¸€ç¯‡æ²¡æœ‰æ ‡ç‚¹çš„ä½œæ–‡è¯¥æ€æ ·é˜…è¯»ï¼Ÿ â€¦â€¦ æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬è¯´ç¼–ç å¥½åæ˜¯ä¹ æƒ¯é—®é¢˜ï¼Œæ˜¯tasteï¼Œä½†æˆ‘è§‰å¾—æ˜¯æ€ç»´ä¹ æƒ¯çš„é—®é¢˜ã€‚è¿™æ ·çš„ä¹ æƒ¯æ—¥ç§¯æœˆç´¯ï¼Œè´Ÿé¢å½±å“å¯èƒ½ä¼šæ›´å¤§ã€‚\nç®€å•ç‚¹å†ç®€å•ç‚¹ï¼Œç®€å•å¯ä¾èµ– # ä»€ä¹ˆæ˜¯ç®€å•ï¼Ÿæ˜¯æ–¹ä¾¿ï¼Œæ˜¯çœå¿ƒï¼Ÿæˆ‘è§‰å¾—æ˜¯è¯šå®ä¸éšç’ï¼Œæ˜¯å°±æ˜¯ï¼Œä¸æ˜¯å°±ä¸æ˜¯ã€‚æœ€æ¨çš„å°±æ˜¯é‚£äº›è¡¨é¢å…‰æ­£èƒŒåæå°åŠ¨ä½œçš„ä»£ç ã€‚\næœ‰äº›ä»£ç è¡¨é‡Œä¸ä¸€ï¼Œè¡¨é¢æ˜¯ä¸€å¥—ï¼ŒèƒŒåæ˜¯ä¸€å¥—ã€‚å‘½åè¯´æ˜¯åšè¿™ä¸ªï¼Œç»“æœèƒŒåä¸å¹²è¿™ä¸ªï¼Œæˆ–è€…é™¤äº†å¹²è¿™ä¸ªè¿˜å¹²åˆ«çš„ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨ä¸€äº›æ ‡å‡†åº“çš„apiçš„æ—¶å€™å°±æ„¿æ„é€‰æ‹©ç›¸ä¿¡å®ƒï¼Œä½†æ˜¯çœ‹æˆ‘ä»¬è‡ªå·±ä»£ç çš„æ—¶å€™å°±ä¸å¾—ä¸é¢‘ç¹åœ°è·³æ¥è·³å»å‘¢ï¼Ÿ\nä¸ç›¸ä¿¡å†™çš„ä»£ç ï¼ŒåŸå› è·Ÿä¸‹é¢ç»å¸¸é‡åˆ°çš„é—®é¢˜ç›¸å…³ï¼Œç»è¿‡äº†ç°å®çš„æ¶æ‰“åªèƒ½å…ˆâ€œå¦çœ¼ç›¸çœ‹â€ï¼› å¯¼å‡ºç±»å‹ã€æ–¹æ³•ã€å‡½æ•°ã€å˜é‡ã€å¸¸é‡ç¼ºä¹å¿…è¦çš„æ³¨é‡Šï¼Œä¸å¾—å·²åªèƒ½è·³è¿‡å»çœ‹ä»£ç ï¼› å‡½æ•°ç­¾åå¤šè¿”å›å€¼æ²¡æœ‰å¿…è¦è¯´æ˜ï¼Œå¦‚è¿”å›å€¼å˜é‡åï¼Œé™¤äº†æœ€åä¸€ä¸ªæ˜¯errorä¸çŸ¥å…¶ä»–å¹²å˜›çš„ï¼Œåªèƒ½è·³è¿‡å»çœ‹returnï¼Œé—®é¢˜æ˜¯è¿˜æœ‰å¤šä¸ªreturnå‡ºå£ï¼› å‡½æ•°ç­¾åå‚æ•°åˆ—è¡¨ï¼Œshorter \u0026amp; simplerï¼Œå¦‚æœæœ‰è¿‘10ä¸ªã€20æ¥ä¸ªå‚æ•°ï¼Œæ€ä¹ˆè®°å¾—ä½å½¢å‚ï¼Ÿä¼ å®å‚çš„æ—¶å€™ä¼šä¸ä¼šå¯¹åº”é”™è¯¯ï¼Ÿå“ªäº›å‚æ•°æ˜¯å¿…å¡«ã€é€‰å¡«ï¼Ÿå‘½åæ˜¯å¦èƒ½å‡†ç¡®æ¸…æ™°åœ°è¦†ç›–è¿™äº›å‚æ•°ï¼Ÿ hacké€»è¾‘ï¼Œå¦‚ç¡¬ç¼–ç ï¼Œè¿™äº›æŸå¤±çš„ä¸åªæ˜¯çµæ´»æ€§ï¼Œä¹Ÿæ¤å…¥äº†ä¸€äº›æš—é»‘æ“ä½œã€‚ä¸€ä¸ªå¥½çš„è½¯ä»¶æ¶æ„å¸ˆåº”è¯¥åšåˆ°â€œmake the invisible visibleâ€ï¼Œinvisibleçš„ä¸€ä¸ªç›´è§‚çš„å®³å¤„å°±æ˜¯ï¼Œè¶Šä¿ä»£åº–çš„äº‹æƒ…ä¼šå˜å¾—æ™®éï¼Œæœ¬æ¥å¯ä»¥ç”±è°ƒç”¨æ–¹æ”¯é…çš„ä¸€äº›æ§åˆ¶å‚æ•°ï¼Œè¢«ç‹¬æ–­ä¸“è¡Œäº†ï¼Œæœ¬æ¥åº”è¯¥ä¸Šå‡åˆ°ç³»ç»Ÿå±‚é¢çš„é—®é¢˜ï¼Œè¢«ä¸€ä¸ªæ¨¡å—å·å·ä»£è¡¨äº†ï¼› â€¦â€¦ æˆ‘çš„é€»è¾‘æ˜¯ï¼Œåªè¦é˜…è¯»ä»£ç çš„æ—¶å€™æœ‰éå¸¸é¢‘ç¹çš„è·³è½¬ã€æ¨å¯¼ã€å‡è®¾ã€éªŒè¯çš„è¿‡ç¨‹ï¼Œé‚£è¿™ä¸ªä»£ç çš„å¯è¯»æ€§å°±çœŸçš„ä¸æ€ä¹ˆæ ·ã€‚\nå…¬å¸ä»£ç è§„èŒƒ # åªè¦æ˜¯è§„èŒƒï¼Œå°±æœ‰å±€é™æ€§ã€æ»åæ€§ã€‚æˆ‘ç†è§£ï¼Œè§„èŒƒä¸æ˜¯è®©æˆ‘ä»¬è¿½æ±‚å®Œç¾ä¸»ä¹‰ï¼Œè€Œæ˜¯è¿½æ±‚better codeï¼Œbetter practicesã€‚å¦‚æœä¸€ä¸ªå¼€å‘è€…æœ‰å¥½çš„tasteï¼Œä»–å†™å‡ºæ¥çš„ä»£ç å¯èƒ½å·²ç»æ¥è¿‘æˆ–è¾¾åˆ°è§„èŒƒçš„è¦æ±‚äº†ã€‚ä½†æ˜¯å¹¶ä¸æ˜¯æ¯ä¸ªå¼€å‘è€…éƒ½æœ‰è¿™æ ·çš„tasteï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰éœ€è¦è§„èŒƒæ¥çº¦æŸæˆ‘ä»¬åšä¸€ä»¶å…±åŒçš„äº‹æƒ…ã€‚\néµå®ˆä»£ç è§„èŒƒçš„ä¸€ä¸ªæ˜æ˜¾çš„å¥½å¤„æ˜¯ï¼Œå¯è¯»æ€§ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„æå‡ï¼Œè¿™æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚å¯è¯»æ€§æå‡ï¼Œæ„å‘³ç€ç»´æŠ¤æˆæœ¬é™ä½ï¼Œæ„å‘³ç€çœä¸‹æ—¶é—´ï¼Œæ„å‘³ç€å¯ä»¥åœ¨æ­£å¸¸å·¥ä½œæ—¶é—´åšæ›´å¤šäº‹æƒ…ï¼Œå¯ä»¥æ—©ä¸‹ç­ä¼‘æ¯ã€å……ç”µã€‚è¿™å¯èƒ½ä¸æ˜¯å¯¹æ¯ä¸ªäººéƒ½æ˜¯ä¸ªå¥½äº‹æƒ…ï¼Œä½†æ˜¯æ˜¯å¯¹å›¢é˜Ÿæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œå¯¹å¤šæ•°äººæœ‰æ„ä¹‰çš„äº‹æƒ…ï¼Œå°±åº”è¯¥åšæŒï¼\næœ€å # å¤šå¹´å‰ç¿»é˜…Linuxæ–‡æ¡£ï¼ŒTorvardsè§£é‡Šä¸ºä»€ä¹ˆä¸€ä¸ªTabéè¦8ä¸ªç©ºæ ¼è€Œéé€šç”¨çš„4ä¸ªï¼Œä»–è¯´ï¼Œæˆ‘å°±æ˜¯è¦è®©é‚£äº›çˆ±å†™åµŒå¥—å¤šå±‚ä»£ç çš„äººâ€œéš¾å—â€â€¦â€¦\nçœä¸‹å¤§æŠŠè‡ªå·±ã€å¤§å®¶çš„æ—¶é—´ï¼Œè¿™éš¾é“ä¸æ˜¯ä¸€ç§å¾ˆèªæ˜çš„â€œå·æ‡’â€è¡Œä¸ºï¼Ÿ\n"}),a.add({id:219,href:"/tags/uml/",title:"uml",description:"",content:""}),a.add({id:220,href:"/tags/visualize/",title:"visualize",description:"",content:""}),a.add({id:221,href:"/blog/2020-10-06-visualizing-your-go-code/",title:"Visualizing Your Go Code",description:"ä»£ç å¯è¯»æ€§ # ä½œä¸ºä¸€åå¼€å‘äººå‘˜ï¼Œä»£ç å¯è¯»æ€§æ˜¯æˆ‘ä»¬å¸¸å¸¸æŒ‚åœ¨å˜´è¾¹çš„ã€‚ä»£ç å†™å‡ºæ¥é™¤äº†è®©è®¡ç®—æœºèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œä»¥å¤–ï¼Œç»ˆç©¶è¿˜æ˜¯è¦è®©äººèƒ½å¤Ÿç†è§£å®ƒï¼Œåç»­æ‰èƒ½åšè¿›ä¸€æ­¥çš„ç»´æŠ¤å·¥ä½œã€‚å¦‚æœä»£ç å†™å‡ºæ¥ï¼Œåªæœ‰å®ƒçš„ä½œè€…èƒ½å¤Ÿçœ‹å¾—æ‡‚ï¼Œé‚£åªèƒ½è¯´æ˜è¿™ä¸ªä½œè€…é€»è¾‘è¡¨è¾¾èƒ½åŠ›æœ‰é—®é¢˜ï¼Œé€è¿‡å…¶ä»£ç éš¾ä»¥çœ‹å‡ºè§£å†³é—®é¢˜çš„æ€è·¯ã€‚è¿™æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­è¦å°½åŠ›é¿å…çš„ã€‚\nåœ¨è½¯ä»¶å·¥ç¨‹æ–¹æ³•è®ºæŒ‡å¯¼ä¸‹ï¼Œä¸ºäº†å°½å¯èƒ½è®©ä»£ç å¯è¯»æ€§è¾¾æ ‡ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæ ¹æ®ä¸€äº›æœ€ä½³å®è·µæ‹Ÿå®šä¸€äº›å¤§å¤šæ•°äººè®¤å¯çš„æ ‡å‡†ï¼Œè®©æ‰€æœ‰å¼€å‘äººå‘˜éµå®ˆï¼Œç„¶åé€šè¿‡ä»£ç è¯„å®¡ã€ä»£ç è§„èŒƒæ£€æŸ¥ã€æŒç»­é›†æˆäº¤ä»˜æµæ°´çº¿ç­‰ç»¼åˆèµ·æ¥ï¼Œä»¥å°½å¯èƒ½é€¼è¿‘è¿™ä¸€ç›®æ ‡ã€‚å½“ç»å¤§å¤šæ•°äººèƒ½å¤Ÿåœ¨çº¦å®šçš„æ¡†æ¶ä¸‹ï¼Œä¿è´¨ä¿é‡æäº¤ä»£ç æ—¶ï¼Œæˆ‘ä»¬å·²ç»åœ¨ä»£ç å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§æ–¹é¢å‰è¿›äº†ä¸€å¤§æ­¥ã€‚\nç„¶è€Œï¼Œè¿™æ ·è¶³å¤Ÿäº†å—ï¼Ÿæˆ‘è®¤ä¸ºè¿˜ä¸å¤Ÿã€‚\nä»£ç æ˜¯æ€ç»´çš„è¡¨è¾¾ # ä»£ç ï¼Œä¸è¿‡æ˜¯é€šè¿‡ä¸€ç§å¤§å®¶éƒ½ç†è§£çš„è¯­è¨€ä¹¦å†™å‡ºæ¥çš„ç¯‡ç« ã€‚å°±å¥½æ¯”å†™æ–‡ç« ä¸€æ ·ï¼Œè¦æœ‰ä¸­å¿ƒæ€æƒ³ï¼Œç„¶åå›´ç»•ä¸­å¿ƒæ€æƒ³è¦å±•å¼€å±‚å±‚æè¿°ã€‚å†™ä»£ç ä¸€æ ·ï¼Œä¸­å¿ƒæ€æƒ³å°±æ˜¯æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜ï¼Œå›´ç»•ä¸­å¿ƒæ€æƒ³çš„å±‚å±‚æè¿°å°±æ˜¯æˆ‘ä»¬è§£å†³é—®é¢˜çš„æ€è·¯ã€‚æ‰€ä»¥ï¼Œä»£ç æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ï¼Œå®ƒæ˜¯äººç±»æ€ç»´çš„è¡¨è¾¾ã€‚\næˆ‘ä»¬æ˜¯å¦‚ä½•å¿«é€Ÿç†è§£ä¸€ç¯‡æ–‡ç« çš„å‘¢ï¼Ÿ\n å…ˆçœ‹æ ‡é¢˜ï¼ŒæŒæ¡å…¶æ ¸å¿ƒå…³é”®è¯ï¼› çœ‹ä¸‹ç¬¬ä¸€æ®µè½çš„å†…å®¹ï¼Œå¾€å¾€ç¬¬ä¸€æ®µä¼šå¼•å‡ºé—®é¢˜ï¼› çœ‹ä¸‹å…¶ä½™æ®µè½çš„é¦–å¥ã€æœ«å¥ï¼Œå¾€å¾€ä¼šç»™å‡ºè¯¥æ®µè½çš„ä¸­å¿ƒæ€æƒ³ï¼› çœ‹ä¸‹æœ€åä¸€æ®µçš„å†…å®¹ï¼Œä¸€èˆ¬ä¼šç»™å‡ºä¸€ä¸ªç»“è®ºï¼› é€šç¯‡ä¸²ä¸‹ï¼Œäº†è§£æ–‡ç« æ•´ä½“å«ä¹‰ï¼›  ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šé€šè¿‡è¿™ç§æ–¹å¼ï¼Ÿå› ä¸ºä¸€ç¯‡å¥½çš„æ–‡ç« ä¸€å®šæœ‰æ‰¿ä¸Šå¯ä¸‹ã€è¿‡æ¸¡ã€‚è¿™ç§å¾ªåºæ¸è¿›çš„æ–¹å¼ï¼Œæ­¥æ­¥é€¼è¿‘ä¸­å¿ƒæ€æƒ³ã€‚\né‚£ä»£ç å‘¢ï¼ŸæŸç§ç¨‹åº¦ä¸Šï¼Œä»£ç ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚\n ä»¥goè¯­è¨€ä¸ºä¾‹ï¼Œé€šå¸¸å¯¹äºä¸€ä¸ªpackageï¼Œæˆ‘ä»¬ä¼šæä¾›packageæ³¨é‡Šæ¥è¡¨ç¤ºå½“å‰packageè¦è§£å†³çš„é—®é¢˜ï¼› æ¯ä¸ªpackageå†…éƒ¨åˆåŒ…å«äº†ä¸åŒçš„typesã€variablesã€functionsï¼Œå®ƒä»¬ç»“åˆèµ·æ¥æ¥è§£å†³ä¸€ä¸ªé—®é¢˜ï¼› æ¯ä¸€ä¸ªfunctionå†…éƒ¨åˆåˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸€æ­¥å®Œæˆä¸€ä¸ªå°åŠŸèƒ½ï¼Œä¸ºä¸‹ä¸€æ­¥åšå¥½å‡†å¤‡ï¼› æ¯ä¸€ä¸ªå°åŠŸèƒ½ã€æ­¥éª¤å¯èƒ½æ˜¯if-else, switch-case, for-loopâ€¦â€¦ä¹‹ç±»çš„è¯­è¨€ç»“æ„ï¼› åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šæä¾›æµ‹è¯•ç”¨ä¾‹ï¼Œæ¥éªŒè¯ä¸Šè¿°æ–¹æ¡ˆçš„æ­£ç¡®æ€§ã€‚  æœ‰æ²¡æœ‰è§‰å¾—å¾ˆç›¸ä¼¼ï¼Œæˆ–è®¸æˆ‘ä»¬åº”è¯¥é‡‡ç”¨å·²æœ‰çš„è¯»ä¹¦çš„ç»éªŒæ¥è¾…åŠ©æ›´å¥½åœ°ç†è§£ç¨‹åºï¼Ÿ\nOOPæ€æƒ³è®¤è¯†ä¸–ç•Œ # ä»£ç ï¼Œå’Œæ–‡ç« ä¸åŒçš„æ˜¯ï¼Œå®ƒè™½ç„¶æœ‰æ˜æ˜¾çš„ç¨‹åºæ„é€ ï¼Œä½†æ˜¯å´æ²¡æœ‰æ˜æ˜¾çš„æ®µè½ä¹‹åˆ†ã€‚\né‚£æˆ‘å¦‚ä½•æ‰èƒ½å€Ÿé‰´å¤šå¹´æ¥å…»æˆçš„è¿˜ä¸é”™çš„é˜…è¯»ä¹ æƒ¯ï¼Œæ¥å¸®åŠ©æˆ‘ç†è§£ä»£ç å‘¢ï¼Ÿå½“ç„¶ä¸èƒ½ç›²ç›®å¥—ç”¨ï¼Œä¸è¿‡ä¿—è¯è¯´ï¼Œèƒ½å·¥æ‘¹å½¢ï¼Œå·§åŒ çªƒæ„ï¼Œæ€æƒ³å¾ˆå¤šåœ°æ–¹è¿˜æ˜¯å¯ä»¥ç›¸é€šçš„ã€‚\nå¦‚ä½•æ›´å¥½åœ°ç†è§£è¿™ä¸ªä¸–ç•Œï¼Œå¯¹å„ç§å„æ ·çš„é—®é¢˜è¿›è¡ŒæŠ½è±¡å‘¢ï¼Ÿæ¯”å¦‚ä¸€è¾†æ‘©æ‰˜è½¦ï¼Œå®ƒæœ‰ç¦»åˆå™¨ã€å‘åŠ¨æœºã€é“¾æ¡ã€è½®æ¯‚ã€è½®èƒã€å‡éœ‡ã€æ²¹ç®±ã€æ’æ°”ç­‰å¾ˆå¤šéƒ¨ä»¶æ„æˆï¼Œæˆ‘å¬è¯´å®é©¬æ°´é¸Ÿç”µå­æ§åˆ¶å¾ˆå‰å®³ï¼Œå¯ä»¥å®ç°æ— äººé©¾é©¶ï¼Œé‚£å¯æ˜¯ä¸¤è½®çš„400å¤šæ–¤çš„å¤§æœºå™¨ã€‚é‚£å®ƒçš„ç”µå­æ§åˆ¶ç³»ç»Ÿæ€ä¹ˆåšåˆ°çš„ï¼Ÿè‡³å°‘è¦èƒ½ç†è§£ä¸€ä¸ªæ‘©æ‰˜è½¦æœ‰æ ¸å¿ƒéƒ¨ä»¶ï¼Œæ•´ä½“è¿è½¬èµ·æ¥å¦‚ä½•ç†è§£å…¶çŠ¶æ€ï¼Œå¦‚ä½•æ§åˆ¶ä¸ªåˆ«éƒ¨ä»¶ä»¥å½±å“å…¶ä»–éƒ¨ä»¶è¿›è€Œæ§åˆ¶æ•´ä½“çŠ¶æ€ã€‚é‚£å®ƒå¦‚ä½•æ§åˆ¶éƒ¨ä»¶å‘¢ï¼Ÿç”µå­æ“ä½œæˆ–æœºæ¢°æ“ä½œã€‚\næ‰¯è¿œäº†ï¼Œæˆ‘åªæ˜¯æœ‰ç‚¹å–œæ¬¢æ°´é¸Ÿè€Œå·²ã€‚æ•´ä¸ªä¸–ç•Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªä¸ªå¯¹è±¡åŠå…¶ä¹‹é—´çš„è”ç³»æ‰€æ„æˆï¼Œä»£ç ä¹Ÿä¸ä¾‹å¤–ã€‚\né“æ³•è‡ªç„¶ï¼ŒOOPçš„æ€æƒ³ä¸è¿‡æ˜¯å€Ÿé‰´äº†äººç±»è®¤è¯†ä¸–ç•Œçš„æ–¹å¼ï¼Œå°†å…¶è¿ç”¨åˆ°äº†è½¯ä»¶å·¥ç¨‹é¢†åŸŸï¼Œä»¥æ›´å¥½åœ°å¯¹é—®é¢˜è¿›è¡ŒæŠ½è±¡ï¼Œä»è€Œæ„å»ºå‡ºè®¾è®¡æ›´åˆç†çš„è½¯ä»¶ã€‚é‚£ä»£ç é‡Œé¢æœ‰å“ªäº›è¯­è¨€æ„é€ ä½“ç°äº†OOPçš„æ€æƒ³å‘¢ã€‚\n ç±»å‹ä¸å¯¹è±¡ï¼Œç”Ÿç‰©å­¦é‡ŒåŒºåˆ†ç‰©ç§ã€ç§ç¾¤ã€ä¸ªä½“ï¼Œé‚£æ˜¯å› ä¸ºå®ƒä»¬æ—¢æœ‰å…±æ€§ï¼Œä¹Ÿæœ‰ä¸ªæ€§ï¼› é€šä¿¡çš„æ–¹å¼ï¼Œè‡ªç„¶ç•Œä¸ªä½“ä¹‹é—´çš„äº¤äº’ä¹Ÿæœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚é›„ç‹®æ’’æ³¡å°¿æ ‡è®°é¢†åœ°ä¹Ÿä¸ç®¡å…¥ä¾µè€…è®¤ä¸è®¤åŒï¼Œæˆ–è€…ä½å¼é©±èµ¶å…¥ä¾µè€…ç¦»å¼€ï¼Œäººå’Œäººç”¨å¬å¾—æ‡‚çš„è¯­è¨€æ²Ÿé€šï¼› éšç§ä¸è·ç¦»ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„éšç§ï¼Œå¦‚æœä½ çš„æœ‹å‹è·Ÿä½ å€Ÿ100å—é’±ä½ å¯èƒ½ç»™äº†ï¼Œä½†æ˜¯ä»–å¦‚æœé—®æ˜¯ä½ è€å©†ç»™çš„è¿˜æ˜¯ä½ è‡ªå·±çš„ï¼Œä½ å¯èƒ½å°±ä¸æƒ³å€Ÿç»™ä»–äº†ï¼Œç»™ä½ å°±è¡Œäº†ä½ ç®¡é‚£ä¹ˆå¤šå¹²å˜›å‘¢ï¼Œæˆ‘è¿˜ä¸æƒ³æ‹¿è‡ªå®¶çš„å€Ÿä½ å‘¢ï¼Œè¯´ä¸å®šå€Ÿä½ è€å©†çš„ç»™ä½ çš„å‘¢ã€‚æ¯ä¸ªäººåœ¨ä¸€å‰¯å¤–è¡¨ä¸‹æ€»æœ‰äº›ä¸æ„¿æ„è¢«äººè§¦ç¢°ã€é è¿‘çš„åœ°æ–¹ã€‚  äº†è§£ä¸€ä¸ªäººï¼Œå…¶å®ä½ ä¸éœ€è¦æ·±å…¥ä»–çš„å®¶åº­æœ¬èº«å»äº†è§£ï¼Œçœ‹çœ‹ä»–å¤©å¤©æ¥è§¦ä»€ä¹ˆäººï¼Œè¯´äº›ä»€ä¹ˆè¯ï¼Œä½ ä¹Ÿå°±å¤§è‡´æ¸…æ¥šäº†ã€‚æ„Ÿå…´è¶£å°±ç»§ç»­äº†è§£ï¼Œä¸æ„Ÿå…´è¶£ä¹Ÿå°±æ‹‰å€’äº†ã€‚æˆ‘æƒ³ç»å¤§å¤šæ•°äººéƒ½ä¸æ˜¯çª¥è§†ç‹‚ï¼Œåœ¨æ‹¥æœ‰ä¸€å®šåˆ¤æ–­åŠ›çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ä¸€äº›å±€éƒ¨çš„ä¿¡æ¯æ˜¯å¯ä»¥äº†è§£å¤§è‡´çš„æ•´ä½“ä¿¡æ¯çš„ã€‚\nç†è§£ä»£ç æœ‰ç›¸åŒä¹‹å¤„ï¼Ÿ\næµç¨‹æ§åˆ¶ + ç»„ä»¶äº¤äº’ # æŸç§ç¨‹åº¦ä¸Šï¼Œæˆ‘è®¤ä¸ºç†è§£ä»£ç ä¹Ÿæœ‰ç›¸ä¼¼ä¹‹å¤„ã€‚\nå¦‚æœèƒ½å¤Ÿæ‹å‡ºé‚£äº›æ¯”è¾ƒé‡è¦çš„å¯¹è±¡ï¼ˆobjectsï¼‰ï¼Œä»¥åŠä»–ä»¬ä¹‹é—´çš„é€šä¿¡ï¼ˆfunction call, chan send/recvï¼‰ï¼Œæˆ–è€…ä»–ä»¬çš„ç§å¯†ä¿¡æ¯ï¼ˆæ³¨é‡Šï¼‰ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½å¤Ÿå¤§è‡´æœ‰ä¸ªäº†è§£å‘¢ï¼Ÿ\nå¦‚æœæƒ³æ›´æ·±å…¥äº†è§£ä¸‹ï¼ŒåŠ ä¸Šäº‹æƒ…çš„è„‰ç»œï¼ˆæ§åˆ¶ç»“æ„ï¼Œif-else, switch-case, for-loopï¼‰å‘¢ï¼Ÿ\nå…¶ä»–ä¿¡æ¯? æˆ‘ç›¸ä¿¡è¿˜æœ‰å…¶ä»–æœ‰ç”¨çš„æœ‰ç”¨ä¿¡æ¯ï¼Œèƒ½å¤Ÿé€šè¿‡ä¸€äº›æ›´åŠ æœ‰æ•ˆç‡çš„æ–¹å¼å‘ˆç°å‡ºæ¥ã€‚\nè®¤è¯† go/ast # è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ï¼Œæœ‰å¤šå°‘ç§ï¼Ÿæˆ‘è®¤ä¸ºåªæœ‰ä¸€ç§ï¼Œå°±æ˜¯äººç±»å¯ä»¥ç†è§£çš„è¯­è¨€ã€‚æœ‰è¶£çš„æ˜¯ï¼Œç¼–ç¨‹è¯­è¨€ä¹‹å¤šå¯ä»¥è¦†ç›–å…ƒç´ å‘¨æœŸè¡¨ï¼Œä¸ä¿¡æ¥ç§ç§ã€‚\n       è¯­è¨€æ˜¯ä»€ä¹ˆï¼Ÿè¯­è¨€æœ‰ç²¾ç¡®çš„æ•°å­¦å®šä¹‰ï¼Œå®ƒä¸æ˜¯èƒ¡ç¼–ä¹±é€ ï¼Œå°¤å…¶æ˜¯ç¼–ç¨‹è¯­è¨€ï¼› ç¼–ç¨‹è¯­è¨€æ›´ç²¾ç¡®ï¼Ÿé‚£å€’æœªå¿…ï¼Œäººç±»ç¤¾ä¼šå¤šå§¿å¤šå½©ä¹‹å¤„ï¼Œå°±åœ¨äºä¼šæ¼”ç»å‡ºæ›´åŠ ä¸°å¯Œå¤šå½©çš„å†…å®¹ï¼ŒåŒ…æ‹¬å¯¹è¯­è¨€çš„ç ´åæ€§â€œåˆ›é€ â€ï¼Œäººè„‘çº é”™èƒ½åŠ›å¤ªå¼ºäº†ï¼Œæˆ‘ä»¬ç”šè‡³æ²¡æœ‰å¯Ÿè§‰åˆ°è‡ªå·±çŠ¯äº†é”™è¯¯ï¼Œå¦‚ç½‘ä¸Šæ´¥æ´¥ä¹é“çš„å±±ä¸œäººå€’è£…ç©æ³•ï¼› æˆ‘èƒ½å‘æ˜ä¸€é—¨è¯­è¨€å—ï¼Ÿå½“ç„¶ï¼Œåªè¦ä½ èƒ½ç»™å‡ºä¸¥è°¨çš„æ•°å­¦å®šä¹‰ï¼Œæ²¡æœ‰æ­§ä¹‰ï¼Œæ‰¾åˆ°ä¸€ç¾¤äººå­¦ä¼šå¹¶å¼€å§‹ç”¨å®ƒäº¤æµï¼Œå§‘ä¸”å¯ä»¥ç§°ä¸ºè¯­è¨€äº†ï¼Œæ¯”å¦‚ç”Ÿæ´»å¤§çˆ†ç‚¸è°¢è€³æœµä»–è€å©†ï¼› è¯­è¨€ä¸æ˜¯ä¸»è°“å®¾ä¹‹ç±»çš„å—ï¼Ÿä¸»è°“å®¾ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥å½¢å¼åŒ–ï¼Œæ•°å­¦ä¹‹ç¾ä¹Ÿè®©æˆ‘æ„Ÿåˆ°æƒŠå¹ï¼›  So\u0026hellip;å‡å¦‚æˆ‘ç”¨ç¼–ç¨‹è¯­è¨€å†™äº†ä¸€æ®µä»£ç ï¼Œå¦‚ä½•çŸ¥é“æˆ‘æœ‰æ²¡æœ‰çŠ¯é”™è¯¯å‘¢ï¼Ÿé‚£å°±æ˜¯ç¼–è¯‘å™¨çš„å·¥ä½œï¼Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æï¼Œä¸€åˆ‡OKä¹‹åä¼šè¿›å…¥ä¸­é—´ä»£ç ç”Ÿæˆã€ä»£ç ä¼˜åŒ–ã€ç”Ÿæˆæœ€ç»ˆä»£ç ã€‚é€šå¸¸ä¸€èˆ¬åœ¨è¯­æ³•åˆ†æä¼šæ„å»ºè¯­æ³•åˆ†ææ ‘ASTï¼ˆAbstract Syntax Treeï¼‰ï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸æ„å»ºå‡ºASTï¼Œè¡¨ç¤ºä»£ç æ˜¯æŒ‰ç…§è¯­è¨€å¯¹åº”ç”Ÿæˆè§„åˆ™æ¥å†™çš„ï¼Œå°±æ²¡ä»€ä¹ˆå¤§é—®é¢˜ï¼Œåä¹‹åˆ™å¯èƒ½åˆè‡ªæˆ‘â€œå‘æŒ¥â€çŠ¯é”™äº†ã€‚",content:"ä»£ç å¯è¯»æ€§ # ä½œä¸ºä¸€åå¼€å‘äººå‘˜ï¼Œä»£ç å¯è¯»æ€§æ˜¯æˆ‘ä»¬å¸¸å¸¸æŒ‚åœ¨å˜´è¾¹çš„ã€‚ä»£ç å†™å‡ºæ¥é™¤äº†è®©è®¡ç®—æœºèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œä»¥å¤–ï¼Œç»ˆç©¶è¿˜æ˜¯è¦è®©äººèƒ½å¤Ÿç†è§£å®ƒï¼Œåç»­æ‰èƒ½åšè¿›ä¸€æ­¥çš„ç»´æŠ¤å·¥ä½œã€‚å¦‚æœä»£ç å†™å‡ºæ¥ï¼Œåªæœ‰å®ƒçš„ä½œè€…èƒ½å¤Ÿçœ‹å¾—æ‡‚ï¼Œé‚£åªèƒ½è¯´æ˜è¿™ä¸ªä½œè€…é€»è¾‘è¡¨è¾¾èƒ½åŠ›æœ‰é—®é¢˜ï¼Œé€è¿‡å…¶ä»£ç éš¾ä»¥çœ‹å‡ºè§£å†³é—®é¢˜çš„æ€è·¯ã€‚è¿™æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­è¦å°½åŠ›é¿å…çš„ã€‚\nåœ¨è½¯ä»¶å·¥ç¨‹æ–¹æ³•è®ºæŒ‡å¯¼ä¸‹ï¼Œä¸ºäº†å°½å¯èƒ½è®©ä»£ç å¯è¯»æ€§è¾¾æ ‡ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæ ¹æ®ä¸€äº›æœ€ä½³å®è·µæ‹Ÿå®šä¸€äº›å¤§å¤šæ•°äººè®¤å¯çš„æ ‡å‡†ï¼Œè®©æ‰€æœ‰å¼€å‘äººå‘˜éµå®ˆï¼Œç„¶åé€šè¿‡ä»£ç è¯„å®¡ã€ä»£ç è§„èŒƒæ£€æŸ¥ã€æŒç»­é›†æˆäº¤ä»˜æµæ°´çº¿ç­‰ç»¼åˆèµ·æ¥ï¼Œä»¥å°½å¯èƒ½é€¼è¿‘è¿™ä¸€ç›®æ ‡ã€‚å½“ç»å¤§å¤šæ•°äººèƒ½å¤Ÿåœ¨çº¦å®šçš„æ¡†æ¶ä¸‹ï¼Œä¿è´¨ä¿é‡æäº¤ä»£ç æ—¶ï¼Œæˆ‘ä»¬å·²ç»åœ¨ä»£ç å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§æ–¹é¢å‰è¿›äº†ä¸€å¤§æ­¥ã€‚\nç„¶è€Œï¼Œè¿™æ ·è¶³å¤Ÿäº†å—ï¼Ÿæˆ‘è®¤ä¸ºè¿˜ä¸å¤Ÿã€‚\nä»£ç æ˜¯æ€ç»´çš„è¡¨è¾¾ # ä»£ç ï¼Œä¸è¿‡æ˜¯é€šè¿‡ä¸€ç§å¤§å®¶éƒ½ç†è§£çš„è¯­è¨€ä¹¦å†™å‡ºæ¥çš„ç¯‡ç« ã€‚å°±å¥½æ¯”å†™æ–‡ç« ä¸€æ ·ï¼Œè¦æœ‰ä¸­å¿ƒæ€æƒ³ï¼Œç„¶åå›´ç»•ä¸­å¿ƒæ€æƒ³è¦å±•å¼€å±‚å±‚æè¿°ã€‚å†™ä»£ç ä¸€æ ·ï¼Œä¸­å¿ƒæ€æƒ³å°±æ˜¯æˆ‘ä»¬è¦è§£å†³çš„é—®é¢˜ï¼Œå›´ç»•ä¸­å¿ƒæ€æƒ³çš„å±‚å±‚æè¿°å°±æ˜¯æˆ‘ä»¬è§£å†³é—®é¢˜çš„æ€è·¯ã€‚æ‰€ä»¥ï¼Œä»£ç æ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ï¼Œå®ƒæ˜¯äººç±»æ€ç»´çš„è¡¨è¾¾ã€‚\næˆ‘ä»¬æ˜¯å¦‚ä½•å¿«é€Ÿç†è§£ä¸€ç¯‡æ–‡ç« çš„å‘¢ï¼Ÿ\n å…ˆçœ‹æ ‡é¢˜ï¼ŒæŒæ¡å…¶æ ¸å¿ƒå…³é”®è¯ï¼› çœ‹ä¸‹ç¬¬ä¸€æ®µè½çš„å†…å®¹ï¼Œå¾€å¾€ç¬¬ä¸€æ®µä¼šå¼•å‡ºé—®é¢˜ï¼› çœ‹ä¸‹å…¶ä½™æ®µè½çš„é¦–å¥ã€æœ«å¥ï¼Œå¾€å¾€ä¼šç»™å‡ºè¯¥æ®µè½çš„ä¸­å¿ƒæ€æƒ³ï¼› çœ‹ä¸‹æœ€åä¸€æ®µçš„å†…å®¹ï¼Œä¸€èˆ¬ä¼šç»™å‡ºä¸€ä¸ªç»“è®ºï¼› é€šç¯‡ä¸²ä¸‹ï¼Œäº†è§£æ–‡ç« æ•´ä½“å«ä¹‰ï¼›  ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¼šé€šè¿‡è¿™ç§æ–¹å¼ï¼Ÿå› ä¸ºä¸€ç¯‡å¥½çš„æ–‡ç« ä¸€å®šæœ‰æ‰¿ä¸Šå¯ä¸‹ã€è¿‡æ¸¡ã€‚è¿™ç§å¾ªåºæ¸è¿›çš„æ–¹å¼ï¼Œæ­¥æ­¥é€¼è¿‘ä¸­å¿ƒæ€æƒ³ã€‚\né‚£ä»£ç å‘¢ï¼ŸæŸç§ç¨‹åº¦ä¸Šï¼Œä»£ç ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚\n ä»¥goè¯­è¨€ä¸ºä¾‹ï¼Œé€šå¸¸å¯¹äºä¸€ä¸ªpackageï¼Œæˆ‘ä»¬ä¼šæä¾›packageæ³¨é‡Šæ¥è¡¨ç¤ºå½“å‰packageè¦è§£å†³çš„é—®é¢˜ï¼› æ¯ä¸ªpackageå†…éƒ¨åˆåŒ…å«äº†ä¸åŒçš„typesã€variablesã€functionsï¼Œå®ƒä»¬ç»“åˆèµ·æ¥æ¥è§£å†³ä¸€ä¸ªé—®é¢˜ï¼› æ¯ä¸€ä¸ªfunctionå†…éƒ¨åˆåˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸€æ­¥å®Œæˆä¸€ä¸ªå°åŠŸèƒ½ï¼Œä¸ºä¸‹ä¸€æ­¥åšå¥½å‡†å¤‡ï¼› æ¯ä¸€ä¸ªå°åŠŸèƒ½ã€æ­¥éª¤å¯èƒ½æ˜¯if-else, switch-case, for-loopâ€¦â€¦ä¹‹ç±»çš„è¯­è¨€ç»“æ„ï¼› åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šæä¾›æµ‹è¯•ç”¨ä¾‹ï¼Œæ¥éªŒè¯ä¸Šè¿°æ–¹æ¡ˆçš„æ­£ç¡®æ€§ã€‚  æœ‰æ²¡æœ‰è§‰å¾—å¾ˆç›¸ä¼¼ï¼Œæˆ–è®¸æˆ‘ä»¬åº”è¯¥é‡‡ç”¨å·²æœ‰çš„è¯»ä¹¦çš„ç»éªŒæ¥è¾…åŠ©æ›´å¥½åœ°ç†è§£ç¨‹åºï¼Ÿ\nOOPæ€æƒ³è®¤è¯†ä¸–ç•Œ # ä»£ç ï¼Œå’Œæ–‡ç« ä¸åŒçš„æ˜¯ï¼Œå®ƒè™½ç„¶æœ‰æ˜æ˜¾çš„ç¨‹åºæ„é€ ï¼Œä½†æ˜¯å´æ²¡æœ‰æ˜æ˜¾çš„æ®µè½ä¹‹åˆ†ã€‚\né‚£æˆ‘å¦‚ä½•æ‰èƒ½å€Ÿé‰´å¤šå¹´æ¥å…»æˆçš„è¿˜ä¸é”™çš„é˜…è¯»ä¹ æƒ¯ï¼Œæ¥å¸®åŠ©æˆ‘ç†è§£ä»£ç å‘¢ï¼Ÿå½“ç„¶ä¸èƒ½ç›²ç›®å¥—ç”¨ï¼Œä¸è¿‡ä¿—è¯è¯´ï¼Œèƒ½å·¥æ‘¹å½¢ï¼Œå·§åŒ çªƒæ„ï¼Œæ€æƒ³å¾ˆå¤šåœ°æ–¹è¿˜æ˜¯å¯ä»¥ç›¸é€šçš„ã€‚\nå¦‚ä½•æ›´å¥½åœ°ç†è§£è¿™ä¸ªä¸–ç•Œï¼Œå¯¹å„ç§å„æ ·çš„é—®é¢˜è¿›è¡ŒæŠ½è±¡å‘¢ï¼Ÿæ¯”å¦‚ä¸€è¾†æ‘©æ‰˜è½¦ï¼Œå®ƒæœ‰ç¦»åˆå™¨ã€å‘åŠ¨æœºã€é“¾æ¡ã€è½®æ¯‚ã€è½®èƒã€å‡éœ‡ã€æ²¹ç®±ã€æ’æ°”ç­‰å¾ˆå¤šéƒ¨ä»¶æ„æˆï¼Œæˆ‘å¬è¯´å®é©¬æ°´é¸Ÿç”µå­æ§åˆ¶å¾ˆå‰å®³ï¼Œå¯ä»¥å®ç°æ— äººé©¾é©¶ï¼Œé‚£å¯æ˜¯ä¸¤è½®çš„400å¤šæ–¤çš„å¤§æœºå™¨ã€‚é‚£å®ƒçš„ç”µå­æ§åˆ¶ç³»ç»Ÿæ€ä¹ˆåšåˆ°çš„ï¼Ÿè‡³å°‘è¦èƒ½ç†è§£ä¸€ä¸ªæ‘©æ‰˜è½¦æœ‰æ ¸å¿ƒéƒ¨ä»¶ï¼Œæ•´ä½“è¿è½¬èµ·æ¥å¦‚ä½•ç†è§£å…¶çŠ¶æ€ï¼Œå¦‚ä½•æ§åˆ¶ä¸ªåˆ«éƒ¨ä»¶ä»¥å½±å“å…¶ä»–éƒ¨ä»¶è¿›è€Œæ§åˆ¶æ•´ä½“çŠ¶æ€ã€‚é‚£å®ƒå¦‚ä½•æ§åˆ¶éƒ¨ä»¶å‘¢ï¼Ÿç”µå­æ“ä½œæˆ–æœºæ¢°æ“ä½œã€‚\næ‰¯è¿œäº†ï¼Œæˆ‘åªæ˜¯æœ‰ç‚¹å–œæ¬¢æ°´é¸Ÿè€Œå·²ã€‚æ•´ä¸ªä¸–ç•Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªä¸ªå¯¹è±¡åŠå…¶ä¹‹é—´çš„è”ç³»æ‰€æ„æˆï¼Œä»£ç ä¹Ÿä¸ä¾‹å¤–ã€‚\né“æ³•è‡ªç„¶ï¼ŒOOPçš„æ€æƒ³ä¸è¿‡æ˜¯å€Ÿé‰´äº†äººç±»è®¤è¯†ä¸–ç•Œçš„æ–¹å¼ï¼Œå°†å…¶è¿ç”¨åˆ°äº†è½¯ä»¶å·¥ç¨‹é¢†åŸŸï¼Œä»¥æ›´å¥½åœ°å¯¹é—®é¢˜è¿›è¡ŒæŠ½è±¡ï¼Œä»è€Œæ„å»ºå‡ºè®¾è®¡æ›´åˆç†çš„è½¯ä»¶ã€‚é‚£ä»£ç é‡Œé¢æœ‰å“ªäº›è¯­è¨€æ„é€ ä½“ç°äº†OOPçš„æ€æƒ³å‘¢ã€‚\n ç±»å‹ä¸å¯¹è±¡ï¼Œç”Ÿç‰©å­¦é‡ŒåŒºåˆ†ç‰©ç§ã€ç§ç¾¤ã€ä¸ªä½“ï¼Œé‚£æ˜¯å› ä¸ºå®ƒä»¬æ—¢æœ‰å…±æ€§ï¼Œä¹Ÿæœ‰ä¸ªæ€§ï¼› é€šä¿¡çš„æ–¹å¼ï¼Œè‡ªç„¶ç•Œä¸ªä½“ä¹‹é—´çš„äº¤äº’ä¹Ÿæœ‰å¤šç§æ–¹å¼ï¼Œæ¯”å¦‚é›„ç‹®æ’’æ³¡å°¿æ ‡è®°é¢†åœ°ä¹Ÿä¸ç®¡å…¥ä¾µè€…è®¤ä¸è®¤åŒï¼Œæˆ–è€…ä½å¼é©±èµ¶å…¥ä¾µè€…ç¦»å¼€ï¼Œäººå’Œäººç”¨å¬å¾—æ‡‚çš„è¯­è¨€æ²Ÿé€šï¼› éšç§ä¸è·ç¦»ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„éšç§ï¼Œå¦‚æœä½ çš„æœ‹å‹è·Ÿä½ å€Ÿ100å—é’±ä½ å¯èƒ½ç»™äº†ï¼Œä½†æ˜¯ä»–å¦‚æœé—®æ˜¯ä½ è€å©†ç»™çš„è¿˜æ˜¯ä½ è‡ªå·±çš„ï¼Œä½ å¯èƒ½å°±ä¸æƒ³å€Ÿç»™ä»–äº†ï¼Œç»™ä½ å°±è¡Œäº†ä½ ç®¡é‚£ä¹ˆå¤šå¹²å˜›å‘¢ï¼Œæˆ‘è¿˜ä¸æƒ³æ‹¿è‡ªå®¶çš„å€Ÿä½ å‘¢ï¼Œè¯´ä¸å®šå€Ÿä½ è€å©†çš„ç»™ä½ çš„å‘¢ã€‚æ¯ä¸ªäººåœ¨ä¸€å‰¯å¤–è¡¨ä¸‹æ€»æœ‰äº›ä¸æ„¿æ„è¢«äººè§¦ç¢°ã€é è¿‘çš„åœ°æ–¹ã€‚  äº†è§£ä¸€ä¸ªäººï¼Œå…¶å®ä½ ä¸éœ€è¦æ·±å…¥ä»–çš„å®¶åº­æœ¬èº«å»äº†è§£ï¼Œçœ‹çœ‹ä»–å¤©å¤©æ¥è§¦ä»€ä¹ˆäººï¼Œè¯´äº›ä»€ä¹ˆè¯ï¼Œä½ ä¹Ÿå°±å¤§è‡´æ¸…æ¥šäº†ã€‚æ„Ÿå…´è¶£å°±ç»§ç»­äº†è§£ï¼Œä¸æ„Ÿå…´è¶£ä¹Ÿå°±æ‹‰å€’äº†ã€‚æˆ‘æƒ³ç»å¤§å¤šæ•°äººéƒ½ä¸æ˜¯çª¥è§†ç‹‚ï¼Œåœ¨æ‹¥æœ‰ä¸€å®šåˆ¤æ–­åŠ›çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ä¸€äº›å±€éƒ¨çš„ä¿¡æ¯æ˜¯å¯ä»¥äº†è§£å¤§è‡´çš„æ•´ä½“ä¿¡æ¯çš„ã€‚\nç†è§£ä»£ç æœ‰ç›¸åŒä¹‹å¤„ï¼Ÿ\næµç¨‹æ§åˆ¶ + ç»„ä»¶äº¤äº’ # æŸç§ç¨‹åº¦ä¸Šï¼Œæˆ‘è®¤ä¸ºç†è§£ä»£ç ä¹Ÿæœ‰ç›¸ä¼¼ä¹‹å¤„ã€‚\nå¦‚æœèƒ½å¤Ÿæ‹å‡ºé‚£äº›æ¯”è¾ƒé‡è¦çš„å¯¹è±¡ï¼ˆobjectsï¼‰ï¼Œä»¥åŠä»–ä»¬ä¹‹é—´çš„é€šä¿¡ï¼ˆfunction call, chan send/recvï¼‰ï¼Œæˆ–è€…ä»–ä»¬çš„ç§å¯†ä¿¡æ¯ï¼ˆæ³¨é‡Šï¼‰ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿèƒ½å¤Ÿå¤§è‡´æœ‰ä¸ªäº†è§£å‘¢ï¼Ÿ\nå¦‚æœæƒ³æ›´æ·±å…¥äº†è§£ä¸‹ï¼ŒåŠ ä¸Šäº‹æƒ…çš„è„‰ç»œï¼ˆæ§åˆ¶ç»“æ„ï¼Œif-else, switch-case, for-loopï¼‰å‘¢ï¼Ÿ\nå…¶ä»–ä¿¡æ¯? æˆ‘ç›¸ä¿¡è¿˜æœ‰å…¶ä»–æœ‰ç”¨çš„æœ‰ç”¨ä¿¡æ¯ï¼Œèƒ½å¤Ÿé€šè¿‡ä¸€äº›æ›´åŠ æœ‰æ•ˆç‡çš„æ–¹å¼å‘ˆç°å‡ºæ¥ã€‚\nè®¤è¯† go/ast # è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ï¼Œæœ‰å¤šå°‘ç§ï¼Ÿæˆ‘è®¤ä¸ºåªæœ‰ä¸€ç§ï¼Œå°±æ˜¯äººç±»å¯ä»¥ç†è§£çš„è¯­è¨€ã€‚æœ‰è¶£çš„æ˜¯ï¼Œç¼–ç¨‹è¯­è¨€ä¹‹å¤šå¯ä»¥è¦†ç›–å…ƒç´ å‘¨æœŸè¡¨ï¼Œä¸ä¿¡æ¥ç§ç§ã€‚\n       è¯­è¨€æ˜¯ä»€ä¹ˆï¼Ÿè¯­è¨€æœ‰ç²¾ç¡®çš„æ•°å­¦å®šä¹‰ï¼Œå®ƒä¸æ˜¯èƒ¡ç¼–ä¹±é€ ï¼Œå°¤å…¶æ˜¯ç¼–ç¨‹è¯­è¨€ï¼› ç¼–ç¨‹è¯­è¨€æ›´ç²¾ç¡®ï¼Ÿé‚£å€’æœªå¿…ï¼Œäººç±»ç¤¾ä¼šå¤šå§¿å¤šå½©ä¹‹å¤„ï¼Œå°±åœ¨äºä¼šæ¼”ç»å‡ºæ›´åŠ ä¸°å¯Œå¤šå½©çš„å†…å®¹ï¼ŒåŒ…æ‹¬å¯¹è¯­è¨€çš„ç ´åæ€§â€œåˆ›é€ â€ï¼Œäººè„‘çº é”™èƒ½åŠ›å¤ªå¼ºäº†ï¼Œæˆ‘ä»¬ç”šè‡³æ²¡æœ‰å¯Ÿè§‰åˆ°è‡ªå·±çŠ¯äº†é”™è¯¯ï¼Œå¦‚ç½‘ä¸Šæ´¥æ´¥ä¹é“çš„å±±ä¸œäººå€’è£…ç©æ³•ï¼› æˆ‘èƒ½å‘æ˜ä¸€é—¨è¯­è¨€å—ï¼Ÿå½“ç„¶ï¼Œåªè¦ä½ èƒ½ç»™å‡ºä¸¥è°¨çš„æ•°å­¦å®šä¹‰ï¼Œæ²¡æœ‰æ­§ä¹‰ï¼Œæ‰¾åˆ°ä¸€ç¾¤äººå­¦ä¼šå¹¶å¼€å§‹ç”¨å®ƒäº¤æµï¼Œå§‘ä¸”å¯ä»¥ç§°ä¸ºè¯­è¨€äº†ï¼Œæ¯”å¦‚ç”Ÿæ´»å¤§çˆ†ç‚¸è°¢è€³æœµä»–è€å©†ï¼› è¯­è¨€ä¸æ˜¯ä¸»è°“å®¾ä¹‹ç±»çš„å—ï¼Ÿä¸»è°“å®¾ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥å½¢å¼åŒ–ï¼Œæ•°å­¦ä¹‹ç¾ä¹Ÿè®©æˆ‘æ„Ÿåˆ°æƒŠå¹ï¼›  So\u0026hellip;å‡å¦‚æˆ‘ç”¨ç¼–ç¨‹è¯­è¨€å†™äº†ä¸€æ®µä»£ç ï¼Œå¦‚ä½•çŸ¥é“æˆ‘æœ‰æ²¡æœ‰çŠ¯é”™è¯¯å‘¢ï¼Ÿé‚£å°±æ˜¯ç¼–è¯‘å™¨çš„å·¥ä½œï¼Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æï¼Œä¸€åˆ‡OKä¹‹åä¼šè¿›å…¥ä¸­é—´ä»£ç ç”Ÿæˆã€ä»£ç ä¼˜åŒ–ã€ç”Ÿæˆæœ€ç»ˆä»£ç ã€‚é€šå¸¸ä¸€èˆ¬åœ¨è¯­æ³•åˆ†æä¼šæ„å»ºè¯­æ³•åˆ†ææ ‘ASTï¼ˆAbstract Syntax Treeï¼‰ï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸æ„å»ºå‡ºASTï¼Œè¡¨ç¤ºä»£ç æ˜¯æŒ‰ç…§è¯­è¨€å¯¹åº”ç”Ÿæˆè§„åˆ™æ¥å†™çš„ï¼Œå°±æ²¡ä»€ä¹ˆå¤§é—®é¢˜ï¼Œåä¹‹åˆ™å¯èƒ½åˆè‡ªæˆ‘â€œå‘æŒ¥â€çŠ¯é”™äº†ã€‚\nä»¥ä¸‹é¢çš„goç¨‹åºä¸ºä¾‹ï¼š\npackage main import ( \u0026quot;fmt\u0026quot; ) func add(a, b int) int { return a + b } func main() { c := add(1, 2) fmt.Printf(\u0026quot;1 + 2 = %d\\n\u0026quot;, c) }  ä»¥ä¸‹æ˜¯ä¸¤ä¸ªä¸é”™çš„astå¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥å°†ä¸Šè¿°ä»£ç æ‹·è´ä»¥ä¸‹ä»¥æŸ¥çœ‹å¯¹åº”çš„ASTã€‚\n ast-explorer goast-viewer  ps: æ¨èå‰è€…ï¼Œå®ç°äº†ç±»ä¼¼chrome inspect elementæ—¶é€‰ä¸­åŒºåŸŸæŸ¥çœ‹å¯¹åº”ä»£ç çš„æ“ä½œï¼Œå…‰æ ‡ç§»åˆ°å¯¹åº”ä»£ç åŒºåŸŸï¼Œå³å¯é«˜äº®æ˜¾ç¤ºå¯¹åº”çš„ASTéƒ¨åˆ†åŒºåŸŸã€‚\næ¯”å¦‚ç°åœ¨æˆ‘ä»¬é€‰ä¸­äº†importç›¸å…³çš„éƒ¨åˆ†ï¼Œå¯¹åº”å³è¾¹å±•ç¤ºå‡ºäº†importå£°æ˜å¯¹åº”çš„ASTä¸­çš„éƒ¨åˆ†å­æ ‘ï¼Œå¯¹åº”çš„å°±æ˜¯ä¸€ä¸ªGenDeclç»“æ„ã€‚å‡½æ•°å£°æ˜ä¹Ÿæœ‰å¯¹åº”çš„FuncDeclï¼Œç±»å‹ä¹Ÿæœ‰å¯¹åº”çš„\u0026hellip;\nps: ASTå±•ç¤ºå½¢å¼ç«Ÿç„¶ä¸æ˜¯ä¸€æ£µæ ‘ï¼Ÿå®ƒç¡®å®æ˜¯ä¸€æ£µæ ‘ï¼Œåªä¸è¿‡ï¼ŒASTæ˜¯éå¸¸åºå¤§çš„ï¼Œå¦‚æœé€šè¿‡æ ‘çš„å½¢å¼æ¥å±•ç¤ºï¼Œç¯‡å¹…å¤ªå¤§ï¼Œåè€Œä¸æ–¹ä¾¿æŸ¥çœ‹ã€‚\ngoæ ‡å‡†åº“æä¾›äº†ä¸€ä¸ªpackage go/astï¼Œç”¨å®ƒæ¥å¯¹æºç è¿›è¡Œåˆ†æå¹¶æ„å»ºå‡ºASTï¼Œç„¶ååŸºäºASTå¯ä»¥å¯¹æºç ç»“æ„è¿›è¡Œç†è§£åŠ å·¥ï¼Œä¸¾å‡ ä¸ªå¸¸è§çš„ç”¨é€”ï¼š\n goæ ‡å‡†åº“æœ‰é¢‘ç‡ä¸é«˜çš„packageè¿ç§»ã€æ–¹æ³•ç­¾åå˜åŒ–ã€å…¶ä»–æƒ…å†µï¼Œgo fixå®ç°äº†æ—§ä»£ç åƒæ–°ä»£ç çš„å¿«é€Ÿè¿ç§»ï¼Œå…¶å®å°±æ˜¯é€šè¿‡å¯¹ASTæ“ä½œå®ç°çš„ï¼› ä»£ç ä¸­æ£€æµ‹errorå¤„ç†ã€æ˜¯å¦æœ‰åˆç†æ³¨é‡Šç­‰ï¼Œä¹Ÿå¯ä»¥åŸºäºASTè¿›è¡Œåˆ†æï¼Œå¼€å‘å¯èƒ½ä¸€ä¸å°å¿ƒå¿½ç•¥å¯¹errorå¤„ç†ã€goroutine panicå¤„ç†ï¼Œæœ‰äº›ä¸‰æ–¹åº“å°±å¯ä»¥åŸºäºASTåˆ†ææœ‰æ²¡æœ‰ä¸Šè¿°æƒ…å†µï¼Œä»¥å¯¹æºç ä¸­çš„é—®é¢˜è¿›è¡Œè‡ªåŠ¨ä¿®å¤ï¼› æå–å…³é”®æ“ä½œä¿¡æ¯è¿›è¡Œå¯è§†åŒ–ï¼Œå¦‚apitest.devå°†HTTPæ“ä½œã€DBæ“ä½œä½œä¸ºé‡ç‚¹å…³æ³¨å¯¹è±¡å¯¹ä»£ç ä¸­çš„ç›¸å…³äº¤äº’è¿›è¡Œæå–ã€å¯è§†åŒ–å±•ç¤ºï¼ŒBallerinaæ¡†æ¶ä¸­ä¹Ÿæœ‰ç±»ä¼¼å®ç°ã€‚ æå–å…³é”®çš„ç½‘ç»œè°ƒç”¨æ“ä½œï¼Œè‡ªåŠ¨åŒ–opentracingåŸ‹ç‚¹ï¼ŒInstrumenting Go code via ASTã€‚ å…¶ä»–ï¼›  å¯è§äº†è§£ go/astï¼Œå°†æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°ç†è§£ä»£ç ï¼Œå¹¶ä½œå‡ºä¸€äº›æ›´æœ‰åˆ›æ„çš„å·¥å…·ã€‚\nå¾®æœåŠ¡å¯è§†åŒ– # æˆ‘æ­£åœ¨è°ƒç ”ä¸€äº›ä¸šç•Œæµè¡Œçš„å¾®æœåŠ¡æ¡†æ¶ï¼Œå¸æ”¶ä¸€äº›æ¯”è¾ƒå¥½çš„åˆ›æ„ï¼Œåœ¨æˆ‘ä»äº‹çš„å›¢é˜Ÿï¼Œç°åœ¨åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨å¾®æœåŠ¡æ¶æ„è®¾è®¡ã€å¼€å‘ã€éƒ¨ç½²äº†ï¼ŒæŸç§ç¨‹åº¦ä¸Šï¼Œå¾®æœåŠ¡ä¸€ç‚¹éƒ½ä¸å¾®ï¼Œæœ‰äº›é€»è¾‘ä¹Ÿå¾ˆå¤æ‚ï¼Œè€Œä¸”ä¸šåŠ¡ä»£ç çœŸçš„æ²¡ä»€ä¹ˆå¥½çœ‹çš„ã€‚ç»å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘å¸Œæœ›1minäº†è§£å…¶é€»è¾‘ï¼Œè¶…è¿‡10minæˆ‘è¿˜çœ‹ä¸æ‡‚çš„ï¼Œå¿ƒé‡Œå·²ç»å¼€å§‹åœ¨çŠ¯å˜€å’•äº†ï¼Œè¿™å†™çš„å•¥ï¼Ÿ\næ˜¯æˆ‘â€œæ²¡è€å¿ƒâ€ï¼Ÿæˆ‘å€’æ˜¯ä¸è¿™ä¹ˆè®¤ä¸ºï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæˆ‘æ¯å¤©è¦äººè‚‰é‡å¤å‡ åéï¼Œæˆ‘å°±å¾—æƒ³åŠæ³•â€œå·å·æ‡’â€æé«˜ä¸‹æ•ˆç‡äº†ã€‚èº«ä¸ºå·¥ç¨‹å¸ˆï¼Œå–è‚‰æ˜¯è€»è¾±ã€‚\nå†å›æƒ³ä¸€ä¸‹å“ªäº›è¯­è¨€æ„é€ æ¯”è¾ƒé‡è¦ï¼Œrpcã€å¯¹è±¡ä¹‹é—´çš„é€šä¿¡ï¼ˆæ–¹æ³•è°ƒç”¨ï¼‰ã€åŒ…æ–¹æ³•è°ƒç”¨ã€goroutineä¹‹é—´é€šä¿¡ï¼ˆchan send/recvï¼‰ï¼Œè¿˜æœ‰æ§åˆ¶é€»è¾‘if-elseã€switch-caseã€for-loopã€‚\næˆ‘ä»¬å¯ä»¥å…ˆä»å®ç”¨åˆç®€å•ç‚¹çš„å¼€å§‹ï¼Œæ¯”å¦‚rpcã€å¯¹è±¡æ–¹æ³•è°ƒç”¨ã€åŒ…æ–¹æ³•è°ƒç”¨ï¼Œå…¶ä»–çš„åç»­å†å®Œå–„ã€‚OK!\næ‰¾åˆ°å…³å¿ƒçš„å…¥å£ç‚¹ # æŒ‰ç…§ä¸€äº›å¾®æœåŠ¡æ¡†æ¶çš„ç¼–ç é£æ ¼ï¼Œé€šå¸¸main.goé‡Œé¢ä¼šæ³¨å†Œserviceæ¥å£çº§å®ç°ï¼Œè¿™é‡Œå°±å¯ä»¥ä½œä¸ºä¸€ä¸ªå…¥å£ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾å‡ºASTä¸­main.goä¸­æ³¨å†Œçš„æ‰€æœ‰serviceåŠå…¶å®ç°ï¼Œå¹¶åˆ†æserviceæ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œç„¶åå†å°†serviceå®ç°ä¸­çš„å¯¹åº”æ–¹æ³•ä½œä¸ºå…¥å£ç‚¹ã€‚\næ‰¾åˆ°è¿™äº›å…¥å£ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å°†å¯ä»¥ä»ASTä¸­éå†æ‰€æœ‰çš„æ–¹æ³•å®šä¹‰ï¼Œç›´åˆ°åŒ¹é…åˆ°receiver typeã€method signatureåŒ¹é…çš„å®šä¹‰ã€‚\nfile: main.go\nfunc main() { s := gorpc.NewServer() pb.RegisterHelloService(s, \u0026amp;helloServiceImpl{}) if err := s.Serve(); err != nil { log.Fatal(err) } }  ä»å…¥å£ç‚¹å¤„å¼€å§‹å±‚å±‚å±•å¼€ # æ¯ä¸ªå‡½æ•°åœ¨ASTä¸­éƒ½æœ‰å¯¹åº”çš„ç»“æ„ï¼Œå‡½æ•°ä½“å†…åŒ…æ‹¬çš„æ¯ä¸€æ¡è¯­å¥ä¹Ÿæ˜¯è¿™æ ·ï¼Œé‚£è¿˜æœ‰ä»€ä¹ˆä¸èƒ½å¹²çš„ï¼Ÿ\næˆ‘ä»¬å¯ä»¥é€’å½’åœ°å°†ä¸€æ¡è¯­å¥å±‚å±‚å±•å¼€ï¼ŒæŠ½ä¸å‰¥èŒ§ï¼Œç›´åˆ°çœ‹åˆ°å…³å¿ƒçš„è„‰ç»œã€‚åˆšæ‰æˆ‘ä»¬è¯´å…ˆåªè€ƒè™‘rpcã€å¯¹è±¡æ–¹æ³•è°ƒç”¨ã€åŒ…å¯¼å‡ºå‡½æ•°è°ƒç”¨å°±å¯ä»¥äº†ï¼Œè¿™ç±»åŸºæœ¬å¯ä»¥å½¢å¼åŒ–æˆxxx.Func(args...)çš„å½¢å¼ï¼Œå°±è¦†ç›–äº†ä¸Šé¢è¿™å‡ ç§æƒ…å†µã€‚\nåªè¦ç¢°åˆ°è¿™æ ·çš„è¯­å¥ï¼Œæˆ‘ä»¬å°±è®°å½•ä¸€ä¸‹ï¼Œå¹¶å°†å…¶é€’å½’åœ°å±•å¼€ï¼Œå±•å¼€è¿‡ç¨‹ä¸­ä¾ç„¶è®°å½•æ‰€æœ‰xxx.Func(args...)å½¢å¼çš„å‡½æ•°è°ƒç”¨â€¦â€¦ç›´åˆ°æ²¡ä»€ä¹ˆå¯ç»§ç»­å±•å¼€ä¸ºæ­¢ã€‚\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§è‡´å®ç°æœ€åˆçš„è®¾æƒ³ï¼šçœ‹åˆ°å¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡è¿‡ç¨‹ã€‚\nå¢åŠ é€šä¿¡è¿‡ç¨‹çš„è¯´æ˜ä¿¡æ¯ # åœ¨goä»£ç è§„èŒƒé‡Œé¢ï¼Œå¯¹äºå¯¼å‡ºæ–¹æ³•ã€å¯¼å‡ºå‡½æ•°ã€å¯¼å‡ºç±»å‹é€šå¸¸éƒ½æ˜¯éœ€è¦æ·»åŠ godocæ³¨é‡Šçš„ï¼Œè¿™äº›æ³¨é‡Šæœ¬èº«å°±å…·æœ‰ä¸€å®šçš„è¯´æ˜æ€§ã€‚é‚£å½“æˆ‘ä»¬é€šè¿‡å¯¹è±¡é—´çš„è°ƒç”¨å…³ç³»è¿›è¡Œå¯è§†åŒ–æ—¶ï¼Œæ˜¯å¦å¯ä»¥å°†è¿™äº›æ³¨é‡Šä¿¡æ¯æ·»åŠ ä¸Šï¼Œä»¥æä¾›æ›´å¥½çš„è¯´æ˜å‘¢ï¼Ÿå½“ç„¶ã€‚\nä½•æ—¶ä½•åœ°ä»¥åŠå¦‚ä½•è§¦å‘ # ä½•æ—¶ä½•åœ°ä»¥åŠå¦‚ä½•è§¦å‘äº†ç‰¹å®šçš„å‡½æ•°è°ƒç”¨ï¼Ÿ\n ä½•æ—¶ä½•åœ°ï¼Ÿfilename:lineno:columnnoï¼Œæ¯ä¸€ä¸ªastå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªPos()æ–¹æ³•ï¼Œé…åˆtoken.Position(astobj.Pos())å°±å¯ä»¥è®¡ç®—å‡ºæºç ä½ç½®ï¼› å¦‚ä½•è§¦å‘ï¼Ÿå‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°ä¿¡æ¯ï¼Œå‡½æ•°è°ƒç”¨å‘ç”Ÿçš„ä½œç”¨åŸŸï¼ˆfunction scopeï¼‰ï¼›  Put It Together # å½“æˆ‘ä»¬å°†ä¸Šè¿°æåŠçš„æ“ä½œå…¨éƒ¨ç»„ç»‡åœ¨ä¸€èµ·ï¼Œå°±å¯ä»¥å®ç°å¤§è‡´å¦‚ä¸‹æ•ˆæœï¼Œç¯‡å¹…ä»¥åŠæ—¶é—´åŸå› ï¼Œè¿™é‡Œå°±ä¸å†ä¸€æ­¥æ­¥è¯¦ç»†æè¿°ä»£ç é€»è¾‘äº†ã€‚\n      å¦‚æœæ‚¨å¯¹è¿™é‡Œçš„å®ç°ç¡®å®æ„Ÿå…´è¶£ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹è¿™é‡Œçš„ä»£ç æ¥è¿›ä¸€æ­¥äº†è§£MR: gorpc support visualize subcmdã€‚\nps: æˆ‘ä¹Ÿåœ¨åšä¸€äº›gorpc101æ•™ç¨‹ä¹‹ç±»çš„ææ–™å‡†å¤‡ï¼ŒåŒ…æ‹¬ä¹¦ç±ã€æ¡†æ¶ã€å·¥å…·ã€æ’ä»¶ä¹‹ç±»çš„å°ç©æ„ï¼Œä¸€æ–¹é¢æ˜¯ä¸ºäº†æ²‰æ·€è‡ªå·±ï¼Œä¸€æ–¹é¢æ˜¯ä¸ºäº†éªŒè¯æƒ³æ³•ï¼Œå¦‚æœèƒ½æœ‰äº›è®¸å»ºè®®æˆ–è€…æ„¿æ„å‚ä¸è¿›æ¥ï¼Œé‚£æˆ‘å…ˆè¡¨ç¤ºæ¬¢è¿ã€‚\n debugger101 gorpc101  "}),a.add({id:222,href:"/contributors/henk-verlinde/",title:"hitzhangjie",description:"Creator of Hyas.\n@hitzhangjie",content:"Creator of Hyas.\n@hitzhangjie\n"}),a.add({id:223,href:"/contributors/",title:"Contributors",description:"The Doks contributors.",content:"The Doks contributors.\n"}),a.add({id:224,href:"/blog/",title:"Blog",description:"The Doks Blog.",content:"ğŸ¶ æ¬¢è¿æ¥åˆ° Kn\u0026rsquo;s Blog\u0026hellip; è¿™é‡Œè®°å½•ç€æˆ‘çš„è®¤è¯†å’Œæ€è€ƒ\n ğŸ‘€Â æ‰€æœ‰åˆ†ç±» |Â ğŸ‘€Â æ‰€æœ‰æ ‡ç­¾\n "}),a.add({id:225,href:"/tags/debugger/",title:"debugger",description:"",content:""}),a.add({id:226,href:"/books/debugger101/",title:"Debugger101: Goè°ƒè¯•å™¨å¼€å‘å†…å¹•",description:"æˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”ï¼Œè°ƒè¯•å™¨æ­£æ˜¯è¿™æ ·ä¸€æ¬¾å·¥å…·ï¼Œå®ƒè™½ç„¶ä¸çŸ¥é“æ‚¨ç¨‹åºä¸­ä½•å¤„å¼•å…¥äº†bugæˆ–è€…ç†è§£ä¸åˆ°ä½ï¼Œä½†æ˜¯å½“ä½ æƒ³åˆ°å®ƒã€æ¡èµ·å®ƒï¼Œå®ƒå°±å¯ä»¥æŒ‡å¼•ä½ ä¸€æ­¥æ­¥è¿½æ ¹æº¯æºã€‚ä¸ä»…è¦åšæˆäººä»¥æ¸”çš„å·¥å…·ï¼Œä¹Ÿè¦åšæˆäººä»¥æ¸”çš„äººï¼Œä¸ç¦è¦é—®è¯»è€…ï¼Œä½ ä»¬å¯æ›¾äº†è§£è¿‡è°ƒè¯•å™¨çš„å†…éƒ¨å®ç°ï¼Ÿå®ƒæ˜¯å¦‚ä½•æ§åˆ¶ä½ ç¨‹åºæ‰§è¡Œçš„ï¼Œå®ƒæ˜¯å¦‚ä½•çŸ¥é“æŒ‡å®šå†…å­˜åœ°å€å¤„çš„æŒ‡ä»¤æˆ–è€…æ•°æ®ç±»å‹çš„â€¦æœ¬ä¹¦æ—¨åœ¨å¸®åŠ©è¯»è€…æ‰“é€šå¯¹ç¼–è¯‘ã€è°ƒè¯•å·¥å…·é“¾ã€è°ƒè¯•ä¿¡æ¯æ ‡å‡†ä»¥åŠæ“ä½œç³»ç»Ÿä¹‹é—´çš„è®¤è¯†ï¼Œä½¿å…·å¤‡ä¸€å®šçš„è°ƒè¯•å™¨å®šåˆ¶åŒ–å¼€å‘çš„èƒ½åŠ›ã€‚",content:"æˆäººä»¥é±¼ä¸å¦‚æˆäººä»¥æ¸”ï¼Œè°ƒè¯•å™¨æ­£æ˜¯è¿™æ ·ä¸€æ¬¾å·¥å…·ï¼Œå®ƒè™½ç„¶ä¸çŸ¥é“æ‚¨ç¨‹åºä¸­ä½•å¤„å¼•å…¥äº†bugæˆ–è€…ç†è§£ä¸åˆ°ä½ï¼Œä½†æ˜¯å½“ä½ æƒ³åˆ°å®ƒã€æ¡èµ·å®ƒï¼Œå®ƒå°±å¯ä»¥æŒ‡å¼•ä½ ä¸€æ­¥æ­¥è¿½æ ¹æº¯æºã€‚\nä¸ä»…è¦åšæˆäººä»¥æ¸”çš„å·¥å…·ï¼Œä¹Ÿè¦åšæˆäººä»¥æ¸”çš„äººï¼Œä¸ç¦è¦é—®è¯»è€…ï¼Œä½ ä»¬å¯æ›¾äº†è§£è¿‡è°ƒè¯•å™¨çš„å†…éƒ¨å®ç°ï¼Ÿå®ƒæ˜¯å¦‚ä½•æ§åˆ¶ä½ ç¨‹åºæ‰§è¡Œçš„ï¼Œå®ƒæ˜¯å¦‚ä½•çŸ¥é“æŒ‡å®šå†…å­˜åœ°å€å¤„çš„æŒ‡ä»¤æˆ–è€…æ•°æ®ç±»å‹çš„â€¦æœ¬ä¹¦æ—¨åœ¨å¸®åŠ©è¯»è€…æ‰“é€šå¯¹ç¼–è¯‘ã€è°ƒè¯•å·¥å…·é“¾ã€è°ƒè¯•ä¿¡æ¯æ ‡å‡†ä»¥åŠæ“ä½œç³»ç»Ÿä¹‹é—´çš„è®¤è¯†ï¼Œä½¿å…·å¤‡ä¸€å®šçš„è°ƒè¯•å™¨å®šåˆ¶åŒ–å¼€å‘çš„èƒ½åŠ›ã€‚\n ç”±äºæœ¬ä¹¦å†…å®¹æ¶‰åŠå¤§é‡ç³»ç»ŸåŸç†ã€è°ƒè¯•ä¿¡æ¯æ ‡å‡†ã€è®¾è®¡å®ç°ã€goæºç åˆ†æå†…å®¹ï¼Œç¯‡å¹…å¾ˆå¤§ï¼Œå¾ˆéš¾ç”¨å‡ ç¯‡åšæ–‡è®²è¿°æ¸…æ¥šï¼Œå› æ­¤å•ç‹¬å†™ä¸€æœ¬ç”µå­ä¹¦ï¼Œã€ŠDebugger101ï¼šgoè°ƒè¯•å™¨å¼€å‘å†…å¹•ã€‹ã€‚\næ¬¢è¿é˜…è¯»ï¼Œå¦‚æ‚¨åœ¨é˜…è¯»è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯ã€ç–æ¼ã€å»ºè®®ï¼Œä¸è¦çŠ¹è±«ï¼Œè¯·ç»™æˆ‘æissueã€‚\n"}),a.add({id:227,href:"/tags/dwarf/",title:"dwarf",description:"",content:""}),a.add({id:228,href:"/books/gorpc101/",title:"GoRPC101: å¾®æœåŠ¡æ¡†æ¶å¼€å‘å†…å¹•",description:"å¦‚ä»Šå¾®æœåŠ¡æ¶æ„å¤§è¡Œå…¶é“ï¼Œå¾®æœåŠ¡æ¡†æ¶ä¹Ÿå±‚å‡ºä¸ç©·ï¼Œå¦‚grpcã€springcloudã€vert.xã€ballerinaï¼Œç­‰ç­‰ï¼Œè¿™ä¹Ÿåæ˜ å‡ºæŠ€æœ¯å›¢é˜Ÿå¯¹å¼€å‘æ•ˆç‡ã€è¿è¥è´¨é‡çš„ä¸æ–­æ¢ç´¢ä¸è¿½æ±‚ã€‚åˆæ ¼çš„å·¥ç¨‹å¸ˆè¦ç†Ÿç»ƒè¿ç”¨æ¡†æ¶ï¼Œæœ‰è¿½æ±‚çš„å·¥ç¨‹å¸ˆåˆ™åº”æŒæ¡æ›´å…¨é¢çš„æŠ€èƒ½ï¼Œèƒ½å¯¹æ¡†æ¶è¿›è¡Œå®šåˆ¶åŒ–å¼€å‘ã€‚",content:"å¦‚ä»Šå¾®æœåŠ¡æ¶æ„å¤§è¡Œå…¶é“ï¼Œå¾®æœåŠ¡æ¡†æ¶ä¹Ÿå±‚å‡ºä¸ç©·ï¼Œå¦‚grpcã€springcloudã€vert.xã€ballerinaï¼Œç­‰ç­‰ï¼Œè¿™ä¹Ÿåæ˜ å‡ºæŠ€æœ¯å›¢é˜Ÿå¯¹å¼€å‘æ•ˆç‡ã€è¿è¥è´¨é‡çš„ä¸æ–­æ¢ç´¢ä¸è¿½æ±‚ã€‚åˆæ ¼çš„å·¥ç¨‹å¸ˆè¦ç†Ÿç»ƒè¿ç”¨æ¡†æ¶ï¼Œæœ‰è¿½æ±‚çš„å·¥ç¨‹å¸ˆåˆ™åº”æŒæ¡æ›´å…¨é¢çš„æŠ€èƒ½ï¼Œèƒ½å¯¹æ¡†æ¶è¿›è¡Œå®šåˆ¶åŒ–å¼€å‘ã€‚\n ç”±äºæœ¬å†…å®¹æ¶‰åŠåˆ°å¤§é‡çš„è®¾è®¡å®ç°ã€ç³»ç»ŸåŸç†ã€æ€§èƒ½è°ƒä¼˜ã€ç ”å‘æµç¨‹ã€å·¥ç¨‹ç´ å…»ã€ç¤¾åŒºç»´æŠ¤ç­‰ç­‰è¯¸å¤šå†…å®¹ï¼Œå‡ ç¯‡åšæ–‡å®åœ¨éš¾ä»¥ä»‹ç»æ¸…æ¥šã€‚ä¸ºäº†ä¿è¯å†…å®¹çš„å®Œæ•´æ€§ï¼Œè®©è¯»è€…èƒ½å¤Ÿæ„Ÿå—åˆ°ç¬”è€…å¾®æœåŠ¡æ¡†æ¶å¼€å‘å·¥ä½œä¸­çš„çœŸå®ä¾‹ç¨‹ï¼Œè¿˜æ˜¯å†³å®šå•ç‹¬å†™ä¸€æœ¬ç”µå­ä¹¦ï¼Œã€ŠGoRPC101ï¼šå¾®æœåŠ¡æ¡†æ¶å¼€å‘å†…å¹•ã€‹ã€‚\næ¬¢è¿é˜…è¯»ï¼Œå¦‚æœæ‚¨åœ¨é˜…è¯»è¿‡ç¨‹ä¸­å‘ç°æœ‰é”™è¯¯ã€ç–æ¼ã€å»ºè®®ï¼Œä¸è¦å¾ˆçŠ¹è±«ï¼Œè¯·ç»™æˆ‘æissueã€‚\n"}),a.add({id:229,href:"/journey/",title:"Journey",description:"journey.",content:""}),a.add({id:230,href:"/books/libmill/",title:"libmill: goé£æ ¼åç¨‹åº“è®¾è®¡å®ç°",description:"æˆ‘ä»¬åªæƒ³è¦ä¸€ä¸ªåç¨‹åŒ–çš„å¼€å‘èƒ½åŠ›ä»¥åŠåŸºäºCSPçš„æ•°æ®å…±äº«ï¼Œéš¾é“æˆ‘ä»¬å°±éœ€è¦ä¸€é—¨æ–°çš„è¯­è¨€ï¼Œæ¯”å¦‚golangï¼Ÿæœ‰å¾ˆå¤šå¼€å‘äººå‘˜æ›¾ç»æå‡ºç±»ä¼¼çš„è´¨ç–‘ï¼Œç¬”è€…åˆšæ¥è§¦goæ—¶ä¹ŸæŠ±ç€ç±»ä¼¼çš„æƒ³æ³•ã€‚é‚£ä¹ˆä¸å¦¨æ€è€ƒä¸‹å¦‚æœç”¨c/c++çš„è¯ï¼Œå¦‚æœè¦å®ç°ä¸Šè¿°åŠŸèƒ½ï¼Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•å®ç°å‘¢ï¼ŸZeroMQä¹‹çˆ¶Martin Sustrikå°±ç”¨1wå¤šè¡Œä»£ç å®ç°äº†ä¸€ä¸ªéå¸¸ä¼˜é›…çš„goé£æ ¼åç¨‹åº“ï¼Œä¸å¦¨æ¥ä¸€èµ·å­¦ä¹ ä¸‹ã€‚",content:"æˆ‘ä»¬åªæƒ³è¦ä¸€ä¸ªåç¨‹åŒ–çš„å¼€å‘èƒ½åŠ›ä»¥åŠåŸºäºCSPçš„æ•°æ®å…±äº«ï¼Œéš¾é“æˆ‘ä»¬å°±éœ€è¦ä¸€é—¨æ–°çš„è¯­è¨€ï¼Œæ¯”å¦‚golangï¼Ÿæœ‰å¾ˆå¤šå¼€å‘äººå‘˜æ›¾ç»æå‡ºç±»ä¼¼çš„è´¨ç–‘ï¼Œç¬”è€…åˆšæ¥è§¦goæ—¶ä¹ŸæŠ±ç€ç±»ä¼¼çš„æƒ³æ³•ã€‚é‚£ä¹ˆä¸å¦¨æ€è€ƒä¸‹å¦‚æœç”¨c/c++çš„è¯ï¼Œå¦‚æœè¦å®ç°ä¸Šè¿°åŠŸèƒ½ï¼Œåº”è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ\n ZeroMQä¹‹çˆ¶Martin Sustrikå°±ç”¨1wå¤šè¡Œä»£ç å®ç°äº†ä¸€ä¸ªéå¸¸ä¼˜é›…çš„goé£æ ¼åç¨‹åº“ï¼Œä¸å¦¨æ¥ä¸€èµ·å­¦ä¹ ä¸‹ã€‚\næœ¬å†…å®¹æ¶‰åŠå¤§é‡çš„ç³»ç»ŸåŸºç¡€çŸ¥è¯†ã€è®¾è®¡å®ç°ç»†èŠ‚ï¼Œä¸ºäº†ä¿è¯çŸ¥è¯†ç‚¹çš„ç³»ç»Ÿæ€§ï¼Œå•ç‹¬å†™äº†ä¸€æœ¬ç”µå­ä¹¦ï¼Œã€Šlibmillï¼šgoé£æ ¼åç¨‹åº“è®¾è®¡å®ç°ã€‹ã€‚\næ¬¢è¿é˜…è¯»ï¼Œå¦‚æœæ‚¨åœ¨é˜…è¯»è¿‡ç¨‹ä¸­å‘ç°æœ‰é”™è¯¯ã€ç–æ¼ã€å»ºè®®ï¼Œä¸è¦çŠ¹è±«ï¼Œè¯·ç»™æˆ‘æissueã€‚\n"}),a.add({id:231,href:"/books/",title:"My Books",description:"My Books.",content:""}),a.add({id:232,href:"/",title:"æ¬¢è¿æ¥åˆ° Kn's Space",description:"å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´ï¼Œå­¦ä¹ ã€å®è·µã€æ€»ç»“ï¼Œå¡‘é€ æ›´å¥½çš„è‡ªå·±",content:'$\u0026gt; Keep! æ—¥å‡ºä¹‹æ—¶ï¼Œå†è¡Œä¸‡é‡Œ! ğŸ¶\n Your browser does not support the audio element.\n  var player = document.getElementById("music-player"); player.volume = 0.1;  -- '}),a.add({id:233,href:"/blog/2020-09-28-go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-go%E5%91%BD%E4%BB%A4/",title:"goæºç å‰–æ - goå‘½ä»¤",description:"1. æœ¬æ–‡ç®€ä»‹ # é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹goå‘½ä»¤è¡Œæœ‰å“ªäº›åŠŸèƒ½ï¼Œè¿è¡Œgo helpå¯ä»¥æŸ¥çœ‹goå‘½ä»¤çš„è¯¦ç»†å¸®åŠ©ä¿¡æ¯ï¼Œgoå‘½ä»¤æœ‰å¾ˆå¤šå­å‘½ä»¤ï¼Œæ¯ä¸ªå­å‘½ä»¤æœ‰ç‰¹å®šçš„åŠŸèƒ½ã€‚goå‘½ä»¤åŠŸèƒ½ä¹‹ä¸°å¯Œæ¶µç›–äº†æºæ–‡ä»¶ç¼–è¯‘ã€æ±‡ç¼–ã€è¿æ¥ã€åæ±‡ç¼–ã€é€ƒé€¸åˆ†æã€ä»£ç ç”Ÿæˆã€æ¨¡å—è§£æç­‰ç­‰éå¸¸ç³»ç»Ÿæ€§çš„åŠŸèƒ½ï¼Œäº†è§£goå‘½ä»¤çš„å®ç°å°†æœ‰åŠ©äºç³»ç»Ÿæ€§æŒæ¡æ•´ä¸ªgoç¼–è¯‘å·¥å…·é“¾ã€‚æœ¬æ–‡ä»‹ç»ä¸‹goå‘½ä»¤çš„è¯¦ç»†åŠŸèƒ½åŠå¤§è‡´å®ç°ï¼Œä¾›åç»­å‚è€ƒã€‚\n2. goå­å‘½ä»¤åˆ—è¡¨ # goæ”¯æŒçš„å­å‘½ä»¤åˆ—è¡¨å¦‚ä¸‹ï¼Œä¸‹é¢æˆ‘ä»¬é€ä¸€æ¥ç®€å•è¯´ä¸‹ã€‚\n bug, start a bug report build, compile packages and dependencies clean, remove object files and cached files doc, show documentation for package or symbol env, print Go environment information fix, update packages to use new APIs fmt, gofmt (reformat) package sources generate, generate Go files by processing source get, add dependencies to current module and install them install, compile and install packages and dependencies list, list packages or modules mod, module maintenance run, compile and run Go program test, test packages tool, run specified go tool version, print Go version vet, report likely mistakes in packages  3.",content:"1. æœ¬æ–‡ç®€ä»‹ # é¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹goå‘½ä»¤è¡Œæœ‰å“ªäº›åŠŸèƒ½ï¼Œè¿è¡Œgo helpå¯ä»¥æŸ¥çœ‹goå‘½ä»¤çš„è¯¦ç»†å¸®åŠ©ä¿¡æ¯ï¼Œgoå‘½ä»¤æœ‰å¾ˆå¤šå­å‘½ä»¤ï¼Œæ¯ä¸ªå­å‘½ä»¤æœ‰ç‰¹å®šçš„åŠŸèƒ½ã€‚goå‘½ä»¤åŠŸèƒ½ä¹‹ä¸°å¯Œæ¶µç›–äº†æºæ–‡ä»¶ç¼–è¯‘ã€æ±‡ç¼–ã€è¿æ¥ã€åæ±‡ç¼–ã€é€ƒé€¸åˆ†æã€ä»£ç ç”Ÿæˆã€æ¨¡å—è§£æç­‰ç­‰éå¸¸ç³»ç»Ÿæ€§çš„åŠŸèƒ½ï¼Œäº†è§£goå‘½ä»¤çš„å®ç°å°†æœ‰åŠ©äºç³»ç»Ÿæ€§æŒæ¡æ•´ä¸ªgoç¼–è¯‘å·¥å…·é“¾ã€‚æœ¬æ–‡ä»‹ç»ä¸‹goå‘½ä»¤çš„è¯¦ç»†åŠŸèƒ½åŠå¤§è‡´å®ç°ï¼Œä¾›åç»­å‚è€ƒã€‚\n2. goå­å‘½ä»¤åˆ—è¡¨ # goæ”¯æŒçš„å­å‘½ä»¤åˆ—è¡¨å¦‚ä¸‹ï¼Œä¸‹é¢æˆ‘ä»¬é€ä¸€æ¥ç®€å•è¯´ä¸‹ã€‚\n bug, start a bug report build, compile packages and dependencies clean, remove object files and cached files doc, show documentation for package or symbol env, print Go environment information fix, update packages to use new APIs fmt, gofmt (reformat) package sources generate, generate Go files by processing source get, add dependencies to current module and install them install, compile and install packages and dependencies list, list packages or modules mod, module maintenance run, compile and run Go program test, test packages tool, run specified go tool version, print Go version vet, report likely mistakes in packages  3. go subcmds # go bug # go bugï¼Œç”¨äºå¿«é€Ÿåˆ›å»ºbug reportã€‚\nä½œä¸ºå¼€æºé¡¹ç›®çš„ç»´æŠ¤äººå‘˜ï¼Œéå¸¸å¸Œæœ›å¼€å‘äººå‘˜â€œä¼šâ€æé—®é¢˜ï¼ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œå°±æ˜¯å› ä¸ºå¦‚æœä¸ä¼šæé—®é¢˜ã€é—®é—®é¢˜ï¼Œæ²Ÿé€šæˆæœ¬å°±ä¼šéå¸¸é«˜ï¼Œè¿™å¯¹äºå¼€æºé¡¹ç›®ç»´æŠ¤äººå‘˜æ¥è¯´ï¼Œæ—¶é—´ä¸Šæ˜¯ä¸ªæå¤§çš„æµªè´¹ã€‚\nåœ¨è…¾è®¯æˆ‘ä¹Ÿå‚ä¸ç»´æŠ¤äº†å¥½å‡ ä¸ªæ¯”è¾ƒå¤§å‹çš„å¼€æºé¡¹ç›®ï¼Œç»å¸¸å—åˆ°ä¸€äº›åŒå­¦çš„é—®é¢˜ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘çœŸçš„æ„Ÿè°¢æ±‚å­¦é˜¶æ®µé•¿æ—¶é—´æ³¡stackoverflowçš„ç»å†ï¼Œstackoverflowä¸Šæ•™ä¼šäº†æˆ‘æ€ä¹ˆæé—®é¢˜ï¼Œè¿™ä¸ªåœ¨æˆ‘åé¢å­¦ä¹ ã€æ²Ÿé€šã€æ£€ç´¢ã€å¼€æºååŒä¸­èµ·åˆ°äº†å¾ˆé‡è¦çš„ä½œç”¨ã€‚\nä¸ºäº†é™ä½æ²Ÿé€šæˆæœ¬ï¼Œgo bugå†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªissueæ¨¡æ¿ï¼ˆå…¶å®githubä¹Ÿæ”¯æŒå®šä¹‰æ¨¡æ¿ï¼‰ï¼ŒåŒ…æ‹¬äº†å‡ ä¸ªéƒ¨åˆ†ï¼šé—®é¢˜ç®€è¿°ã€goç‰ˆæœ¬ã€go envä¿¡æ¯ã€æ‰§è¡Œçš„æ“ä½œã€æœŸæœ›çš„ç»“æœã€å®é™…çš„ç»“æœã€‚è¿™é‡Œå‘¢ï¼Œä¸ºäº†ä¿æŠ¤go issuerçš„ä½“éªŒï¼Œgo bugä¼šè‡ªåŠ¨è·å–goç¯å¢ƒä¿¡æ¯ï¼Œå¡«å……åˆ°issueæ¨¡æ¿ä¸­ï¼Œè¿™é‡Œçš„å†…å®¹å°†ä½œä¸ºissueçš„bodyéƒ¨åˆ†ã€‚\næ¥ä¸‹æ¥ä¼šåˆ¤æ–­go issuerå½“å‰ç³»ç»Ÿä¿¡æ¯ï¼Œå¹¶å†³å®šå¦‚ä½•æ‰“å¼€webæµè§ˆå™¨ï¼Œæµè§ˆå™¨æ‰“å¼€ä¸€ä¸ªissueåˆ›å»ºé¡µé¢ï¼Œé€šè¿‡GETå‚æ•°å¡«å……issueçš„bodyï¼Œä¸€ä¸ªç®€å•çš„issueåŸºæœ¬ä¿¡æ¯å°±å¡«å……å®Œæˆäº†ã€‚go issueråªéœ€è¦å¡«å……ä¸‹æ ‡é¢˜ã€é—®é¢˜ç®€è¿°ã€æ‰§è¡Œæ“ä½œã€æœŸæœ›ç»“æœã€å®é™…ç»“æœå°±åˆ›å»ºå®Œæˆäº†ã€‚\ngo build # go buildå¯ä»¥ç»†åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ“ä½œï¼š\n compile, src/cmd/compile/main.go asm, \u0026hellip; link, src/cmd/link/main.go ld, \u0026hellip;  go buildè¿‡ç¨‹åˆ†æï¼Œå‡å®šå¾…ç¼–è¯‘çš„å·¥ç¨‹å¼€å¯äº†go moduleï¼š\n  åˆå§‹åŒ–æ“ä½œ\n modload.Init(), è¿›è¡Œgo moduleç›¸å…³çš„åˆå§‹åŒ–ï¼Œå¦‚æ£€æŸ¥ç¯å¢ƒå˜é‡GO111MODULEå†³å®šæ˜¯å¦å¯ç”¨go moduleã€å®šä½go.modæ‰€åœ¨çš„ç›®å½•ã€è®¾ç½®gitç­‰ï¼› instrumentInit()ï¼Œä»£ç ç»‡å…¥åˆå§‹åŒ–ï¼Œä»€ä¹ˆæ˜¯ä»£ç ç»‡å…¥å‘¢ï¼Œæ¯”å¦‚go build -raceå¯¹ä»£ç ä¸­çš„ç«æ€æ¡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œéœ€è¦åœ¨åŸç¨‹åºä¸­åŠ å…¥ä¸€äº›ç‰¹æ®Šä»£ç æ¥ç»Ÿè®¡å¯¹æŸäº›æ•°æ®ç»“æ„çš„å¹¶å‘è¯»å†™æ“ä½œï¼Œè¿™å°±ç§°ä¹‹ä¸ºä»£ç ç»‡å…¥ï¼Œç†Ÿæ‚‰Javaå­—èŠ‚ç ç»‡å…¥çš„è¯åº”è¯¥å¾ˆå®¹æ˜“çœ‹æ‡‚è¿™é‡Œçš„æ¦‚å¿µï¼Œæ¯”å¦‚Kilimã€Quasaç­‰å­—èŠ‚ç ç»‡å…¥ã€‚go build -msanåº”è¯¥æ˜¯å¯ç”¨ä¸å†…å­˜æ¸…ç†ç›¸å…³çš„æ“ä½œã€‚è¿™é‡Œä¹Ÿå°±æ˜¯æ£€æŸ¥ä¸€ä¸‹flagçš„æ­£ç¡®æ€§ï¼ˆå¦‚-raceã€-msanä¸èƒ½åŒæ—¶æŒ‡å®šï¼‰ï¼Œæ£€æŸ¥ä¸€ä¸‹å¹³å°æ˜¯å¦æ”¯æŒraceæ£€æŸ¥ã€msanæ£€æŸ¥ï¼› buildModeInit()ï¼Œæ„å»ºæ¨¡å¼åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬å†³å®šæ˜¯æ„å»ºä¸€ä¸ªå…±äº«åº“ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œè¿˜æ˜¯å…¶ä»–ç­‰ï¼Œä¹Ÿä¼šæ£€æŸ¥å¹³å°æ˜¯å¦æ”¯æŒã€æ˜¯å¦å¼€å¯go moduleç­‰ï¼›    builderåˆå§‹åŒ–: builderä¿å­˜ç€ä¸€æ¬¡æ„å»ºè¿‡ç¨‹ä¸­çš„å…¨å±€çŠ¶æ€ï¼Œä¸ä¿å­˜packageçš„å…¨å±€çŠ¶æ€ï¼Œä¸åŒpackageçš„ç¼–è¯‘æ˜¯å¹¶å‘è¿›è¡Œçš„ï¼Œbuilderæ˜¯å•ä¾‹å…±äº«çš„\n åˆå§‹åŒ–æ‰“å°å‡½æ•° åˆå§‹åŒ–action cache åˆå§‹åŒ–mkdir cache åˆå§‹åŒ–tool id cache åˆå§‹åŒ–build id cache åˆå§‹åŒ–ä¸´æ—¶æ„å»ºç›®å½• æ£€æŸ¥GOOSã€GOARCHæ˜¯å¦åˆæ³• æ£€æŸ¥æŒ‡å®šçš„tagåˆ—è¡¨    åŠ è½½è¦æ„å»ºçš„è·¯å¾„å¯¹åº”çš„packageä¿¡æ¯\n åŠ è½½è·¯å¾„å¯¹åº”çš„pacakge ç§»é™¤çº¯æµ‹è¯•ç”¨çš„package    åˆ›å»ºè¦æ‰§è¡Œçš„actionsï¼šä¸€ä¸ªactionè¡¨ç¤ºactionå›¾ä¸­çš„ä¸€ä¸ªå•ç‹¬çš„åŠ¨ä½œ\n åˆ›å»ºä¸€ä¸ªgo buildçš„actionï¼ˆæ ¹èŠ‚ç‚¹ï¼‰ï¼Œæˆ‘çŒœè¿™ä¸ªactionæ˜¯ä¸€ä¸ªè¡¨ç¤ºå…¨å±€æ„å»ºå®Œæˆçš„actionï¼› é’ˆå¯¹å„ä¸ªè¦æ„å»ºçš„packageåˆ›å»ºä¸€ä¸ªauto actionï¼Œéƒ½æ˜¯å‰ä¸€æ­¥go buildè¿™ä¸ªactionçš„å‰ç½®ä¾èµ–ï¼› è¿™é‡Œçš„actionsæ„æˆäº†ä¸€ä¸ªdagï¼Œä¹Ÿç§°ä¹‹ä¸ºaction graphï¼›    b.Do()å¼€å§‹æ‰§è¡Œæ„å»º\n ä»æ ¹èŠ‚ç‚¹æ‰§è¡Œæ‰«æï¼ŒæŒ‰ç…§æ·±åº¦ä¼˜å…ˆæœç´¢ã€ååºéå†çš„æ–¹å¼è¿›è¡Œéå†ï¼Œæ­£å¥½ç¬¦åˆå‰ç½®ï¼ˆå­èŠ‚ç‚¹ï¼‰æ‰§è¡Œå®Œæˆåï¼Œåç½®æ‰å¯ä»¥æ‰§è¡Œçš„é—®é¢˜ï¼› æ ¹æ®æŸ¥çœ‹é€‰é¡¹æ˜¯å¦æŒ‡å®šï¼Œå†³å®šæ˜¯å¦è¾“å‡ºaction graphï¼› action dagæ‰§è¡Œçš„æ—¶å€™ï¼Œç›¸å½“äºå…ˆæ‰§è¡Œæœ€åº•å±‚çš„å¶å­èŠ‚ç‚¹ï¼Œæ‰§è¡Œå®Œå†æ‰§è¡Œä¸Šä¸€å±‚çš„çˆ¶èŠ‚ç‚¹\u0026hellip;ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°åˆ°è¾¾æ ¹èŠ‚ç‚¹ï¼› æ ¹æ®action.Depsæ„å»ºåå‘çš„è§¦å‘å…³ç³»ï¼Œå¦‚a.Deps=bï¼Œé‚£ä¹ˆb.Triggers=aï¼Œæ–¹ä¾¿bæ‰§è¡Œå®Œåé©±åŠ¨aæ‰§è¡Œï¼› action.pendingè¡¨ç¤ºå½“å‰è¯¥actionå‰©ä¸‹çš„ç­‰å¾…æ‰§è¡Œå®Œæˆçš„å‰ç½®ä¾èµ–çš„æ•°é‡ï¼Œå¦‚æœpendingä¸º0ï¼Œè¡¨ç¤ºæ— ä¾èµ–æˆ–è€…ä¾èµ–éƒ½å·²æ‰§è¡Œå®Œæˆï¼Œå½“å‰actionå˜ä¸ºå°±ç»ªçŠ¶æ€ï¼Œè½¬ç§»åˆ°b.readyè¿™ä¸­ï¼Œb.readySemaä¿¡å·é‡ä¹Ÿokäº†ï¼› å¯åŠ¨å¤šä¸ªgoroutineæ‰§è¡Œå¹¶å‘çš„æ„å»ºä»»åŠ¡ï¼Œå½“b.readySemaå°±ç»ªåï¼Œä»b.readyæ ˆä¸­å–å‡ºè¦å¤„ç†çš„actionå»æ‰§è¡Œï¼Œè®°å½•æ„å»ºçš„æ—¶é—´ä¹‹ç±»çš„ï¼Œåº”è¯¥æ˜¯ä¸ºäº†æ–¹ä¾¿ç»Ÿè®¡ç¼–è¯‘è€—æ—¶ä¿¡æ¯ï¼› è¿™é‡Œè¦æ³¨æ„action.Funcï¼Œé»˜è®¤æ˜¯æŒºè¿‡(*Builder).buildæ¥æ„å»ºçš„ï¼Œå±‚å±‚å±•å¼€ï¼Œå…¶å®çœ‹å¾—å°±æ˜¯gc.goçš„gcæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æœ€ç»ˆè°ƒç”¨çš„å…¶å®æ˜¯go tool compileæ¥å®Œæˆç¼–è¯‘è¿‡ç¨‹ï¼› go tool compileçš„ä»£ç ä½äºsrc/cmd/compile/main.goä¸‹ï¼›    go tool compileé€»è¾‘å®ç°ï¼š\n æˆ‘æ“¦ï¼Œä¸€å¼€å§‹å„ç§a#239?fafx8\u0026mdash; æ„å»ºè¯­æ³•æ ‘ï¼Œä¸æ˜¯ç”¨çš„go/aståŒ…ï¼Œè€Œæ˜¯syntaxåŒ…ï¼Œæ®è¯´è¿™æ˜¯å› ä¸ºä¹‹å‰æ˜¯ç”¨cå†™çš„ï¼Œå³ä¾¿åé¢ç”¨goé‡å†™äº†ï¼Œä½†åŸºæœ¬ä¸Šæ˜¯ç¿»è¯‘äº†ä¸€éï¼Œå·¥ç¨‹ç»“æ„æ²¡å†æ”¹ï¼› åŸºäºè¯­æ³•æ ‘è¿›è¡Œè¯­ä¹‰åˆ†æï¼Œå¦‚æ£€æŸ¥ç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œtypecheck(node,...)ï¼Œè¿™é‡Œåˆåˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š  constã€typeã€ä»¥åŠfuncçš„ç±»å‹å’Œåç§°çš„æ£€æŸ¥ï¼› å˜é‡èµ‹å€¼æ£€æŸ¥ï¼› å‡½æ•°ä½“ç±»å‹æ£€æŸ¥ï¼Œæ£€æŸ¥è¿”å›å€¼ç±»å‹ï¼Ÿ ç±»å‹æ£€æŸ¥å®Œä¹‹åï¼Œæ£€æŸ¥mapç±»å‹çš„keys   æ£€æŸ¥å¦‚ä½•æ•è·closedçš„å˜é‡ï¼Œéœ€è¦åœ¨é€ƒé€¸åˆ†æä¹‹å‰è¿›è¡Œï¼› å†…è”æ£€æŸ¥ï¼› é€ƒé€¸åˆ†æï¼› å°†é—­åŒ…ä¸­å¯¹å¤–éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œæ ¹æ®ä½¿ç”¨æ–¹å¼è½¬æ¢ä¸ºæŒ‰å€¼æ•è·ã€æŒ‰å¼•ç”¨æ•è·çš„å¯¹åº”å½¢å¼ï¼› ç¼–è¯‘é¡¶å±‚å‡½æ•°ï¼Œè¯¦è§å‡½æ•°ï¼šfunccompile(node)ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æ ¹æ®å‡½æ•°å®šä¹‰ï¼ˆå‚æ•°åˆ—è¡¨ã€è¿”å›å€¼ï¼‰ä»¥åŠè¯­å¥ï¼Œç”Ÿæˆä¸€ç³»åˆ—çš„æ“ä½œï¼ˆæ“ä½œç ã€æ“ä½œæ•°ç­‰ï¼‰; \u0026hellip;. å†™å¯¹è±¡æ•°æ®åˆ°ç£ç›˜ï¼Œobject dataï¼Œç¿»è¯‘æ˜¯â€œå¯¹è±¡æ•°æ®â€ï¼Œä¸æ˜¯â€œç›®æ ‡æ–‡ä»¶æ•°æ®â€ã€‚è¯¦è§å‡½æ•°dumpdata()ï¼Œè²Œä¼¼æ˜¯åœ¨å‡½æ•°compileSSA()ä¸­å®ç°çš„ï¼Œè¿˜è¦ç¡®è®¤å…·ä½“é€»è¾‘ï¼›  å“‡ï¼Œå¥½å¤æ‚!\ngo clean # æˆ‘ä»¬åœ¨ç¼–è¯‘æ„å»ºçš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬éƒ½ä¼šç”Ÿæˆä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œæ¯”å¦‚.oæ–‡ä»¶ï¼Œå¦‚æœæ˜¯ä½¿ç”¨Makefileç®¡ç†å·¥ç¨‹æ„å»ºçš„æ—¶å€™ä¸€èˆ¬ä¼šå®šä¹‰ä¸ªPHONY Target cleanï¼Œé€šè¿‡make cleanæ¥æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ã€ç¨‹åºç­‰ï¼ŒMVNæ„å»ºä¹Ÿä¼šå®šä¹‰cleanè¿™æ ·çš„targetï¼Œgoä¹Ÿä¸ä¾‹å¤–ã€‚\ngo buildï¼Œç¼–è¯‘è¾“å‡ºå¯æ‰§è¡Œç¨‹åºï¼Œgo installè¿˜ä¼šå°†å¯æ‰§è¡Œç¨‹åºå®‰è£…åˆ°GOBINæˆ–è€…GOPATH/binï¼Œé‚£ç°åœ¨è¦æ¸…ç†çš„è¯ï¼Œgo cleanä¼šæ¸…ç†å½“å‰moduleä¸‹çš„ç¼–è¯‘äº§ç‰©ï¼Œgo clean -iè¿˜ä¼šæŠŠå®‰è£…åˆ°GOBINæˆ–è€…GOPATH/binä¸‹å®‰è£…çš„ç¨‹åºç»™æ¸…ç†æ‰ï¼Œå¦å¤–go modulesä¹‹é—´ä¹Ÿæœ‰ä¾èµ–å…³ç³»ï¼Œgo clean -rè¿˜å¯ä»¥é€’å½’åœ°æ¸…ç†ä¾èµ–äº§ç‰©ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ç°åœ¨æœ‰ä¸ªå·¥ç¨‹ç›®å½•å«helloï¼Œé‚£ä¹ˆåœ¨è¯¥å·¥ç¨‹ç›®å½•ä¸‹æ‰§è¡Œgo cleanï¼Œå°†æ¸…ç†ç›®å½•ä¸‹çš„ä¸‹è¿°æ–‡ä»¶ï¼šhello, hello.exe, hello.test, hello.test.exe, main, main.exe, main.test, main.test.exeã€‚é‚£å‡å¦‚helloç›®å½•ä¸‹go.modå®šä¹‰çš„moduleæ˜¯a.b.cå‘¢ï¼Ÿä¼šæ¸…ç†a.b.c, a.b.c.exe, a.b.c.test, a.b.c.test.exeå—ï¼Ÿä¸ä¼šï¼ä½†æ˜¯go clean -iä¼šä»GOBINæˆ–GOPATH/binä¸‹æ¸…ç†è¿™äº›æ–‡ä»¶ã€‚ä¸ºå•¥ï¼Ÿç›®å‰go cleanå°±æ˜¯è¿™ä¹ˆå®ç°çš„ã€‚\ngo cleanä¹‹å‰å®ç°çš„æœ‰bugï¼Œæˆ‘ç¨å¾®ä¿®æ”¹äº†ä¸‹ï¼Œå®ç°äº†æ¸…ç†${module}, ${module}.exeçš„åŠŸèƒ½ã€‚\ngo doc # go doc å¯ä»¥ç”¨æ¥æ˜¾ç¤ºæŒ‡å®špackageä¸‹çš„ç±»å‹ã€å‡½æ•°ã€æ–¹æ³•åŠå…¶æ³¨é‡Šä¿¡æ¯ï¼Œå…¶ç”¨æ³•æ¯”è¾ƒå¤šï¼Œå¦‚go docã€go doc pkg.symbol.fieldOrMethodã€go doc pkg.Functionç­‰ç­‰ã€‚\næ¯”å¦‚æˆ‘ä»¬è¿è¡Œgo doc os.Signalï¼Œä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š\npackage os // import \u0026quot;os\u0026quot; type Signal interface { String() string Signal() // to distinguish from other Stringers } A Signal represents an operating system signal. The usual underlying implementation is operating system-dependent: on Unix it is syscall.Signal. var Interrupt Signal = syscall.SIGINT ...  ä»è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•´ä¸ªæ¥å£çš„å®šä¹‰ï¼ŒåŠå…¶godocæ³¨é‡Šä¿¡æ¯ï¼Œé‚£ä¹ˆä¸ç¦è¦é—®ï¼Œgo doc æ˜¯å¦‚ä½•å‡†ç¡®æ‰¾åˆ°è¿™ä¸ªç¬¦å·os.Signalå®šä¹‰çš„å‘¢ï¼Ÿ\nå¦‚æœä¹‹å‰æœ‰äº†è§£è¿‡go/astçš„ç”¨æ³•ã€ç”¨é€”ä¹‹åï¼Œåº”è¯¥å°±ä¸éš¾ç†è§£äº†ã€‚æˆ‘è¿˜å†™è¿‡ä¸€ç¯‡è®²å¾®æœåŠ¡ä»£ç é€»è¾‘å¯è§†åŒ–çš„æ–‡ç« ï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº†go/astã€‚\ngo docçš„é€»è¾‘å…¶å®å¾ˆç®€å•ï¼Œå®ƒé¦–å…ˆä¼šå°†os.Signal splitä¸€ä¸‹ï¼Œå‘ç°æ˜¯osè¿™ä¸ªpackageï¼Œç„¶åæ˜¯Signalè¿™ä¸ªç¬¦å·ï¼Œç„¶åå®ƒå°±ä¼šæ ¹æ®build packageæä¾›çš„ä¿¡æ¯æ¥å®šä½åˆ°oså¯¹åº”çš„ç›®å½•ï¼Œç„¶åé€šè¿‡parser.ParseDir(...)æ¥å¯¹ç›®å½•ä¸‹goæ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æã€‚åˆ†æå®Œä¹‹åå°±å°†å¾—åˆ°ASTï¼Œç„¶åå†åŸºäºASTå»æŸ¥æ‰¾ç¬¦å·Symbolçš„å®šä¹‰ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ä¸ªç±»å‹å®šä¹‰ï¼Œæ‰¾åˆ°ASTä¸­å¯¹åº”çš„èŠ‚ç‚¹ä¹‹åï¼Œå†æå–å‡ºæ³¨é‡Šä¿¡æ¯ã€‚æœ€åå°†è¿™äº›ä¿¡æ¯æ ¼å¼åŒ–è¾“å‡ºåˆ°stdoutã€‚\ngo docå¤§è‡´å°±æ˜¯è¿™æ ·å®ç°çš„ã€‚\ngo env # go env å‘½ä»¤ç”¨æ¥æŸ¥çœ‹ã€è®¾ç½®ã€å–æ¶ˆè®¾ç½®goç›¸å…³çš„ä¸€äº›ç¯å¢ƒå˜é‡ã€‚\næˆ‘ä»¬çŸ¥é“go envä¼šæ˜¾ç¤ºå‡ºä¸€ä¸ªç¯å¢ƒå˜é‡åˆ—è¡¨ï¼Œè¿™é‡Œé¢è¿™äº›ç¯å¢ƒå˜é‡åç§°éƒ½æ˜¯go envCmdé‡Œé¢é¢„å®šä¹‰å¥½çš„ï¼Œæ¯”å¦‚è¦è®¾ç½®ä¸€ä¸ªä¸ç›¸å¹²çš„å˜é‡ågo env -w xxxæ˜¯ä¼šæŠ¥é”™çš„ã€‚\ngo env åˆ—å‡ºçš„ç¯å¢ƒå˜é‡ä¸€èˆ¬éƒ½æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå¦‚GOSUMDB=sum.golang.orgï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰æ—¶å€™å¸Œæœ›å¯¹é½è¿›è¡Œè°ƒæ•´ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡go env -w GOSUMDB=offæ¥è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœè¦å–æ¶ˆè®¾ç½®æ¢å¤åˆ°åŸæ¥çš„é»˜è®¤è®¾ç½®ï¼Œåˆ™å¯ä»¥æ‰§è¡Œgo env -u GOSUMDBã€‚\né‚£è¿™é‡Œä¸ç¦è¦é—®ï¼Œç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„ç¯å¢ƒå˜é‡å­˜å‚¨åœ¨å“ªé‡Œå‘¢ï¼Ÿå…¶å®æ˜¯å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡GOENVå¯¹åº”çš„æ–‡ä»¶ä¸­ï¼ŒmacOSä¸‹ä¸º/Users/zhangjie/Library/Application Support/goï¼Œlinuxä¸‹ä¸º~/.config/go/envï¼Œå…¶å®å°±æ˜¯os.UserConfigDir()+/go/envè·¯å¾„ä¸‹ã€‚å½“æˆ‘ä»¬è®¾ç½®ã€å–æ¶ˆè®¾ç½®çš„æ—¶å€™ï¼Œä¼šæ›´æ–°æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚\ngo envå¤§è‡´å°±æ˜¯è¿™ä¹ˆå·¥ä½œçš„ã€‚\ngo fix # ä¸€é—¨å¿«é€Ÿæ¼”è¿›ä¸­çš„ç¼–ç¨‹è¯­è¨€ä¹Ÿä¼šé¢ä¸´ä¸€äº›è°ƒæ•´çš„æ—¶å€™ï¼Œå¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯”å¦‚å°†golang.org/x/tools/net/contextå†…å®¹è½¬ç§»åˆ°æ ‡å‡†åº“contextä¸­ï¼Œå¯èƒ½å·²ç»å­˜åœ¨ä¸€äº›å­˜é‡ä»£ç äº†ï¼Œæˆ–è€…è¯´å¼€å‘è€…å·²ç»ä¹ æƒ¯äº†ä½¿ç”¨è€çš„importçš„åŒ…è·¯å¾„äº†ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿæƒ³è®©å¼€å‘è€…ä»˜å‡ºæœ€å°çš„è¿ç§»æˆæœ¬è€Œè½¬åˆ°ä½¿ç”¨æœ€æ–°çš„æ ‡å‡†åº“contextä¸Šæ¥ã€‚go fixå°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚\nfixå‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ä¼šæ£€æŸ¥å½“å‰æ”¯æŒé‚£äº›ä¿®å¤æ“ä½œï¼Œæ¯ä¸€ä¸ªä¿®å¤æ“ä½œéƒ½æŒ‡å®šäº†è¦æœç´¢çš„ä»£ç ï¼Œä»¥åŠè¦æ›¿æ¢æˆçš„ä»£ç ï¼Œæ¯”å¦‚ä¸Šé¢æåŠçš„contextåŒ…å¯¼å…¥è·¯å¾„çš„é—®é¢˜ã€‚fixå‘½ä»¤ä¼šé¦–å…ˆè§£ææºæ–‡ä»¶å¾—åˆ°æŠ½è±¡è¯­æ³•æ ‘ASTï¼Œç„¶ååŸºäºå¯¹ASTçš„æ“ä½œï¼Œæœç´¢å‡ºå¯ä»¥ä¿®å¤çš„é—®é¢˜ä»£ç ï¼Œç„¶åå°†å…¶æ›¿æ¢æˆå¯¹åº”çš„æ–°ä»£ç ï¼Œç„¶åå†å°†ASTè½¬æ¢æˆä»£ç è¾“å‡ºåˆ°æºæ–‡ä»¶ä¸­ã€‚\nè¿™å¤§æ¦‚å°±æ˜¯go fix (go tool fix) çš„ä¸€ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼Œ$GOROOT/pkg/tool/$GOOS_$GOARCH/ä¸‹ä¿å­˜äº†go toolå¯¹åº”çš„ä¸€äº›å·¥å…·ï¼Œå¦‚fixï¼Œvetç­‰ï¼Œè¿è¡Œgo vet, go fixå°±ä¼šæœ€ç»ˆè½¬æ¢æˆæ‰§è¡Œä¸Šè¿°è·¯å¾„ä¸‹çš„vetã€fixå‘½ä»¤ã€‚go fixçš„å…¥å£åœ¨$GOROOT/src/cmd/go/fix/fix.goï¼Œå®é™…è°ƒç”¨çš„æ˜¯go tool fixï¼Œå…¶å…¥å£åœ¨$GOROOT/src/cmd/fix/main.goã€‚\nps: go fixçš„å†…éƒ¨å®ç°ï¼Œæ˜¯åŸºäºgo/astå®ç°ï¼Œé€šè¿‡å¯¹æºç è¿›è¡Œè¯­æ³•åˆ†ææ„å»ºastï¼Œé€šè¿‡å¯¹astè¿›è¡ŒæŸ¥æ‰¾ã€ä¿®æ”¹ï¼Œå®Œæˆå¯¹ä»£ç çš„è°ƒæ•´ï¼Œæœ€åå†å°†astè½¬æ¢ä¸ºæºç è¾“å‡ºã€‚\ngo fmt # go fmtå®é™…ä¸Šæ˜¯è°ƒç”¨çš„å‘½ä»¤gofmtï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯åˆ©ç”¨äº†package go/astå®Œæˆå¯¹ç‰¹å®šæºæ–‡ä»¶æˆ–è€…ç›®å½•ä¸‹æ‰€æœ‰æºæ–‡ä»¶çš„è¯­æ³•åˆ†æï¼Œæ„å»ºå‡ºè¯­æ³•æ ‘ï¼Œç„¶ååŸºäºå¯¹è¯­æ³•æ ‘çš„ç†è§£å’Œæ“ä½œï¼Œæ¥æœ€ç»ˆå®Œæˆå¯¹ä»£ç çš„æ ¼å¼åŒ–ã€‚\ngo fmtåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæœ‰å‡ ä¸ªåœ°æ–¹æ¯”è¾ƒæ–¹ä¾¿ï¼Œé€‰é¡¹-då¯ä»¥å°†æ ¼å¼åŒ–åçš„ä»£ç æ‰“å°åˆ°æ ‡å‡†è¾“å‡ºï¼Œ-wåˆ™å¯ä»¥ç›´æ¥å°†æ–‡ä»¶å†™å…¥åˆ°æ–‡ä»¶ï¼Œ-såˆ™æ”¯æŒå¯¹ä»£ç è¿›è¡Œç®€åŒ–ã€‚\nè¿™é‡Œä¹Ÿæ²¡æœ‰ç‰¹åˆ«å¤šè¦å¼ºè°ƒçš„ï¼Œç»§ç»­çœ‹å…¶ä»–å­å‘½ä»¤çš„å®ç°é€»è¾‘ã€‚\ngo generate # goæä¾›äº†ä»£ç ç”Ÿæˆèƒ½åŠ›ï¼Œåœ¨goæºæ–‡ä»¶ä¸­é€šè¿‡//go:generate ....å®šä¹‰çš„æ³¨é‡Šï¼Œå…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå®ƒå‘Šè¯‰goå·¥å…·å¯ä»¥æå–å‡ºè¿™äº›æŒ‡ä»¤æ¥ç”Ÿæˆä»£ç ã€‚å½“ç„¶ç†è®ºä¸Šé€šè¿‡go:generateå¯ä»¥æ‰§è¡Œä»»ä½•æŒ‡ä»¤ï¼Œä½†æ˜¯ä»goå·¥å…·è®¾è®¡è€…çš„åˆè¡·æ¥çœ‹ï¼Œå®ƒä¸»è¦æ˜¯ä¸ºäº†ç”¨æ¥ä½œä¸ºä¸€ç§åŒ…å¼€å‘è€…çš„å·¥å…·ï¼Œç”¨æ¥ç”Ÿæˆæˆ–è€…æ›´æ–°ç‰¹å®šæºæ–‡ä»¶çš„ã€‚\næ¯”å¦‚ä¸€ä¸ªä»£ç ç”Ÿæˆå·¥å…·å¯ä»¥é€šè¿‡ä»£ç æ¨¡æ¿æ¥ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„æœåŠ¡å·¥ç¨‹ï¼Œä»£ç æ¨¡æ¿é‡Œé¢å°±å¯ä»¥åŒ…å«è¿™æ ·çš„//go:generate mockgen ...æŒ‡ä»¤æ¥ç”Ÿæˆmockæµ‹è¯•ç›¸å…³çš„æ¡©ä»£ç ã€‚\ngo generateå®ç°çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå®ƒå°±æ˜¯éå†æºæ–‡ä»¶ï¼Œç„¶åå»é€è¡Œè¯»å–æ¯ä¸ªæºæ–‡ä»¶ï¼Œæ£€æŸ¥è¯»å–è¡Œæ˜¯ä¸æ˜¯åŒ¹é…//go:generate ...ï¼Œæ˜¯çš„è¯åˆ™è§£æå‡ºå‘½ä»¤æ¥ï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ã€‚\ngo get # go getç”¨æ¥ä¸‹è½½å¯¹åº”æ¨¡å—å¹¶å®‰è£…ï¼ŒåŒæ—¶å°†è¯¥æ¨¡å—æ·»åŠ åˆ°å½“å‰æ¨¡å—çš„ä¾èµ–æ–‡ä»¶go.modä¸­ã€‚å½“ç„¶go getä¹Ÿæœ‰å¾ˆå¤šä¸€äº›å¸¸ç”¨é€‰é¡¹ï¼Œå¦‚-uç”¨æ¥æ›´æ–°æ¨¡å—ç­‰ã€‚è¿™é‡Œå¯ä»¥é€šè¿‡go help getæ¥äº†è§£è¯¦ç»†çš„ä¿¡æ¯ã€‚\ngo install # go installï¼Œå®ƒä¸»è¦æ˜¯ä¸‹è½½å¯¹åº”æ¨¡å—ï¼Œå¹¶å®Œæˆç¨‹åºçš„æ„å»ºã€å®‰è£…é€»è¾‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåœ¨go1.13å‰åå‘ç”Ÿäº†ä¸€ç‚¹å˜åŒ–ã€‚\nåœ¨go1.13ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæ˜¯è¦é€šè¿‡go installæ¥å®‰è£…çš„ï¼Œgo1.13åŠä¹‹åçš„ç‰ˆæœ¬go getä¼šè‡ªåŠ¨ä¸‹è½½ã€å¹¶æ„å»ºã€å®‰è£…ï¼Œgo installåªèƒ½å®‰è£…æœ¬åœ°å·²ç»ä¸‹è½½ä¸‹æ¥çš„æ¨¡å—ã€‚\ngo list # go liståˆ—å‡ºpackagesæˆ–ä¾èµ–ï¼Œå…·ä½“å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿè¿™ä¸ªå‘½ä»¤æ€ä¹ˆå®ç°çš„ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œå…ˆè·³è¿‡äº†ã€‚\ngo mod # go modä¸»è¦æ˜¯ç”¨æ¥å¯¹ä¾èµ–è¿›è¡Œç®¡ç†ï¼Œå¸¸ç”¨æ“ä½œåŒ…æ‹¬go mod init, go mod tidyï¼Œgo mod vendorç­‰ç­‰å§ã€‚\nè¿™ä¸ªæœ‰æ—¶é—´å†çœ‹ï¼Œå½“å‰ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œå…ˆè·³è¿‡äº†ã€‚\ngo run # go runä¸€èˆ¬ç”¨æ¥å¿«é€Ÿæ‰§è¡Œä¸€ä¸ªgoæ–‡ä»¶ï¼Œè¿™ä¸ªgoæ–‡ä»¶å¿…é¡»æ˜¯package mainä¸‹çš„ï¼Œå¹¶ä¸”åŒ…å«ä¸€ä¸ªæ–¹æ³•func main(){}ã€‚go runç°åœ¨ä¹Ÿæ”¯æŒæŒ‡å®šä¸€ä¸ªpackage mainçš„è·¯å¾„åï¼Œè¦æ±‚æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯è¿™ä¸ªç›®å½•ä¸‹çš„goæºæ–‡ä»¶å¿…é¡»æ˜¯package mainï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæºæ–‡ä»¶ä¸­åŒ…å«func main(){}çš„å®šä¹‰ã€‚\ngo runå…¶å®ä¹Ÿéœ€è¦è¿›è¡Œç¼–è¯‘ã€é“¾æ¥è¿‡ç¨‹ï¼Œåªä¸è¿‡è¿™ä¸ªè¿‡ç¨‹éƒ½åœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­å®Œæˆï¼Œç»“æœäº§ç‰©æ²¡æœ‰è¾“å‡ºåˆ°æºç ç›®å½•æˆ–è€…å‘½ä»¤æ‰§è¡Œæ—¶çš„å·¥ä½œç›®å½•ä¸‹ã€‚å¹¶ä¸”go runæ‰§è¡Œå®Œä¼šåï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ‰è¿™äº›ä¸´æ—¶ç›®å½•ã€‚æ‰§è¡Œå®Œæˆå‰æ˜¯æ€ä¹ˆæ¸…ç†çš„å‘¢ï¼Ÿå®ƒè¿™é‡Œæ¨¡æ‹Ÿäº†cé‡Œé¢çš„å‡½æ•°atexit()æ¥æ³¨å†Œé€€å‡ºæ—¶è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œgo runè¿›ç¨‹æœ€ç»ˆåœ¨è°ƒç”¨os.Exit()ä¹‹å‰ä¼šå…ˆå°†ä¹‹å‰æ³¨å†Œè¿‡çš„å¤„ç†å‡½æ•°æ‰§è¡Œä¸€éï¼Œè·Ÿcåº“å‡½æ•°atexitçš„é€»è¾‘ç±»ä¼¼ã€‚è¿™é‡Œæ³¨å†Œçš„å¤„ç†å‡½æ•°å°±åŒ…æ‹¬æ¸…ç†go runè§¦å‘ç¼–è¯‘ã€é“¾æ¥æ—¶ç”Ÿæˆçš„ä¸´æ—¶ç›®å½•ã€‚\ngo test # go testä¸»è¦æ˜¯ç”¨æ¥æ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨çš„ï¼Œå®ƒè¿˜æ¯”è¾ƒç‰›ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨æ¥æ”¯æŒ\u0026quot;test.go\u0026quot;æ–‡ä»¶çš„å•å…ƒæµ‹è¯•ï¼Œè¿˜æ”¯æŒåƒ\u0026quot;cmd/go/testdata/scripts/\u0026ldquo;ä¸‹çš„é€šè¿‡txtæ–‡ä»¶+è‡ªå®šä¹‰æŒ‡ä»¤æ¥å®ç°çš„æµ‹è¯•ã€‚è¿™é‡Œè¿˜æ˜¯æœ‰ç‚¹åˆ›æ–°ç‚¹çš„ã€‚\nè¿™é‡Œå…ˆè¯´ä¸‹\u0026quot;test.go\u0026quot;æ–‡ä»¶çš„å•å…ƒæµ‹è¯•æ˜¯å¦‚ä½•å®ç°çš„å§ã€‚å®é™…ä¸Šæ˜¯è¿™æ ·æ‰§è¡Œçš„ï¼Œå®ƒä¼šä¸ºå½“å‰packageä¸‹çš„\u0026quot;test.go\u0026quot;æ–‡ä»¶ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„goæ–‡ä»¶ï¼Œè¿™ä¸ªgoæ–‡ä»¶çš„å†…å®¹æ˜¯æ ¹æ®é¢„å…ˆå®šä¹‰å¥½çš„goæµ‹è¯•æ¨¡æ¿æ–‡ä»¶ç”Ÿæˆçš„ï¼Œå†…éƒ¨ä¼šé€šè¿‡-test.runé€‰é¡¹æ¥é€‰æ‹©æˆ‘ä»¬è‡ªå®šä¹‰çš„TestXXX(t)æ¥æ‰§è¡Œã€‚\nå½“ç„¶go testä¹Ÿæ”¯æŒè¦†ç›–ç‡æµ‹è¯•ç­‰ç­‰çš„æ“ä½œï¼Œè¿™ä¸ªè¦†ç›–ç‡æµ‹è¯•å®é™…ä¸Šä¹Ÿç®€å•ï¼Œå…¶å®æ˜¯æŠŠæºæ–‡ä»¶é‡å†™äº†ï¼Œæ¯ä¸€è¡Œè¯­å¥éƒ½å¯¹åº”äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ‰§è¡Œè¯­å¥ä¹‹åï¼Œç´§è·Ÿç€ä¸€æ¡å¢åŠ è®¡æ•°å™¨çš„æ“ä½œï¼Œæœ€åæµ‹è¯•ç¨‹åºè·‘å®Œï¼Œæ£€æŸ¥æ‰€æœ‰è¯­å¥çš„è®¡æ•°å™¨å°±å¯ä»¥ç»Ÿè®¡å‡ºè¦†ç›–ç‡ä¿¡æ¯ã€‚\n\u0026hellip;\nå…¶ä»–çš„ï¼Œå½“å‰ä¹Ÿä¸æ˜¯å¾ˆå…³å¿ƒäº†ã€‚\ngo tool # goè¿™ä¸ªå‘½ä»¤è¡Œå·¥å…·æ˜¯ä¸€ä¸ªé›†å¤§æˆè€…ï¼Œå®ƒå†…éƒ¨å…¶å®ä¹Ÿæ˜¯è°ƒç”¨äº†ä¸€äº›å…¶ä»–çš„å·¥å…·çš„ï¼Œå¦‚é€šè¿‡go fmtæˆ–go tool fmtæ¥è°ƒç”¨å‘½ä»¤gofmtï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„å·¥å…·ï¼Œè¿™äº›å·¥å…·å¯ä»¥åœ¨å¦‚ä¸‹è·¯å¾„ä¸­æ‰¾åˆ°ï¼š$GOROOT/pkg/tool/$GOOS_$GOARCHã€‚\nè¿™é‡Œçš„å·¥å…·æœ‰å¾ˆå¤šï¼Œæˆ‘åœ¨åé¢çš„æ–‡ç« ä¸­ä¼šæœ‰é€‰æ‹©çš„è¿›è¡Œä»‹ç»ã€‚\ngo version # go versionå°±æ˜¯æ‰“å°å½“å‰goç¨‹åºçš„ç‰ˆæœ¬ä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯æ˜¯åœ¨goç¼–è¯‘æ„å»ºæœŸé—´ç”±å·¥å…·go tool distç”Ÿæˆçš„ï¼Œè¯¦è§runtime/sys/zversion.goã€‚\nè¿˜æœ‰ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œæ˜¯è®¾ç½®å¥½ä¸€ä¸ªåŒ…çº§åˆ«çš„å˜é‡ï¼Œç„¶åé€šè¿‡go build -ldflags=\u0026quot;-X 'pkg.Varable=value'\u0026quot;ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§åŠæ³•ã€‚\ngo vet # go vetç”¨æ¥æŠ¥é“packagesä¸­å¯èƒ½çš„é”™è¯¯ï¼Œä¹‹å‰æœ‰äº†è§£è¿‡å¹¶å‘mapè¯»å†™çš„é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡go vetæ£€æŸ¥å‡ºæ¥ï¼Œå®ƒæ˜¯æ€ä¹ˆæ£€æŸ¥çš„å‘¢ï¼Ÿå®ƒè¿˜èƒ½æ£€æŸ¥å‡ºä»€ä¹ˆå…¶ä»–çš„é”™è¯¯å‘¢ï¼Ÿ\ngo veté»˜è®¤ä½¿ç”¨çš„vetå·¥å…·æ˜¯goè‡ªå¸¦çš„vetå·¥å…·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡go vet -vettool=$progæ›¿æ¢æˆè‡ªå®šä¹‰çš„vetå·¥å…·ã€‚OKï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹goè‡ªå¸¦çš„vetåˆ†æå·¥å…·éƒ½æ”¯æŒåˆ†æå“ªäº›ç±»å‹çš„é”™è¯¯ï¼Œä»¥åŠæ€ä¹ˆå®ç°çš„ã€‚\ngoè‡ªå¸¦çš„vetå·¥å…·ï¼Œå…¶å®ç°ä½äºï¼šsrc/cmd/vet/main.goï¼Œä»æºç ä¸­ä¸éš¾çœ‹å‡ºï¼Œvetæ”¯æŒå¯¹å¦‚ä¸‹ç±»å‹çš„é”™è¯¯è¿›è¡Œæ£€æŸ¥ï¼š\n asmdecl: reports mismatches between assembly files and Go declarations assign: detects useless assignments atomic: checks for common mistakes using the sync/atomic package bools: detects common mistakes involving boolean operators buildtag: check that +build tags are well-formed and correctly located cgocall: detect some violations of the cgo pointer passing rules composite: check for unkeyed composite literals copylock: check for locks erroneously passed by value errorsas: report passing non-pointer or non-error values to errors.As httpresponse: check for mistakes using HTTP response ifaceassert: detect impossible interface-to-interface type assertions loopclosure: check references to loop variables from within nested functions lostcancel: check cancel func returned by context.WithCancel is called nilfunc: check for useless comparisons between functions and nil printf: check consistency of Printf format strings and arguments shift: check for shifts that equal or exceed the width of the integer stdmethods: check signature of methods of well-known interfaces stringintconv: check for string(int) conversions structtag: check that struct field tags conform to reflect.StructTag.Get tests: check for common mistaken usages of tests and examples unmarshal: report passing non-pointer or non-interface values to unmarshal unreachable: check for unreachable code unsafeptr: check for invalid conversions of uintptr to unsafe.Pointer unusedresult: check for unused results of calls to some functions  å¦‚ä½•å®ç°çš„å‘¢ï¼Œå•ç‹¬æŸ¥çœ‹å„ä¸ªanalyzerçš„å®ç°å°±å¯ä»¥äº†ï¼Œä¸¾ä¾‹copylockæ˜¯åŸºäºgo/astè¯­æ³•åˆ†ææ¥æ£€æµ‹å‡ºæ¥çš„ã€‚\n4. æ€»ç»“ # "}),a.add({id:234,href:"/tags/toolchain/",title:"toolchain",description:"",content:""}),a.add({id:235,href:"/blog/2020-09-20-%E5%AE%B6%E4%BA%BA%E7%94%9F%E6%B4%BB%E6%AF%94%E5%B7%A5%E4%BD%9C%E9%87%8D%E8%A6%81/",title:"å®¶äºº\u0026ç”Ÿæ´»ï¼Œæ¯”å·¥ä½œé‡è¦",description:"ä¸ºä»€ä¹ˆå·¥ä½œä¸å¼€å¿ƒ # 2020ä¸ŠåŠå¹´ç»©æ•ˆè€ƒè¯„å‡ºæ¥äº†ï¼ŒOuterstandingï¼Œ5æ˜Ÿå¥½è¯„ï¼ŒæŠ€æœ¯é€šé“æ™‹å‡ç­”è¾©ç»“æœä¹Ÿå‡ºæ¥äº†ï¼ŒT10ï¼Œç®—æ˜¯åŒäº‹ä»¬å¯¹è‡ªå·±å·¥ä½œçš„è®¤å¯å§ï¼Œå¯¹æˆ‘è‡ªå·±æ¥è¯´ä¹Ÿæ˜¯ä¸ªå¥½äº‹ï¼Œå°½ç®¡æˆ‘å¹¶æ²¡æœ‰æ„Ÿè§‰å¤šä¹ˆå¼€å¿ƒã€‚è€å©†è¯´ï¼Œè™½ç„¶ä½ æ²¡è§‰å¾—å¤šä¹ˆå¼€å¿ƒï¼Œä½†æ˜¯å¦‚æœæ²¡è¿‡çš„è¯ä¸€å®šä¼šè§‰å¾—ä¸å¼€å¿ƒâ€¦â€¦å¬ç€å¾ˆæœ‰é“ç†ã€‚\nè¿™ä¸ª5æ˜Ÿçš„è€ƒæ ¸ï¼Œæˆ‘ä¹Ÿæ²¡ä»€ä¹ˆå¥½å¼€å¿ƒçš„ï¼Œå› ä¸ºä¸šåŠ¡å›¢é˜Ÿè¿™è¾¹ä¸€å¼€å§‹ç»™çš„æ˜¯4æ˜Ÿï¼Œåé¢å‘¢ï¼Œå› ä¸ºåœ¨ä¸­å°ä¸­çš„è´¡çŒ®æ¯”è¾ƒçªå‡ºï¼Œbgå±‚é¢æœ‰ç»©æ•ˆçš„åŠ æˆï¼Œæ‰€ä»¥ä»4æ˜Ÿæåˆ°äº†5æ˜Ÿã€‚leaderå‘Šè¯‰æˆ‘è¿™ä¸ªå¥½æ¶ˆæ¯åï¼Œæˆ‘å¹¶æ²¡æœ‰è§‰å¾—å¼€å¿ƒæˆ–è€…ä¸å¼€å¿ƒã€‚æˆ‘åšçš„å·¥ä½œå°±æ‘†åœ¨è¿™é‡Œï¼Œä¸ºä»€ä¹ˆä¸æ˜¯è‡ªå·±ä¸šåŠ¡å›¢é˜Ÿç»™æˆ‘è€ƒæ ¸5æ˜Ÿï¼Œåè€Œæ˜¯æŠ€æœ¯è¿è¥éƒ¨åé¦ˆçš„bgå±‚é¢çš„ä¸­å°è´¡çŒ®ï¼Œè®©æˆ‘çš„ç»©æ•ˆä»4æ˜Ÿæåˆ°äº†5æ˜Ÿï¼Ÿ\nå¹´åˆ3æœˆä»½æ™‹å‡T10æ²¡é€šè¿‡ï¼ŒåŸå› ä¸€å †æœ‰çš„æ²¡çš„è¯„è¯­ï¼Œå…¶å®è¿™æ¬¡è¯„çº§åœ¨å†…å®¹å±‚é¢ä¹Ÿå¹¶æ²¡æœ‰ç‰¹åˆ«å¤§çš„å˜åŒ–ï¼Œåªæ˜¯è¡¥å……äº†äº›ä¸šåŠ¡æ•°æ®ã€è´¡çŒ®è·å¥–æƒ…å†µï¼ŒPPTè®²çš„æ—¶å€™å¾®è°ƒäº†ä¸‹ç›®å½•ç»“æ„ï¼Œä¸è¿‡åŸºæœ¬ä¸Šæ²¡æŒ‰æµç¨‹è®²ä¸‹æ¥ï¼Œè¯„å§”å…¨ç¨‹æŒ‘æˆ˜ï¼Œæœ€åé€šè¿‡äº†ã€‚å’Œä¸Šæ¬¡ç­”è¾©ç›¸æ¯”ï¼Œç­”è¾©å†…å®¹æ¯”ä¸Šæ¬¡è¿›æ­¥äº†å“ªäº›å‘¢ï¼Œå†…å®¹ç»„ç»‡çš„æ›´å®¹æ˜“è¢«å¬ä¼—æ¥å—äº†ï¼Œåˆ—äº†äº›ä¸šåŠ¡å¯¹æ¯”æ•°æ®ã€ç³»ç»Ÿæœªæ¥è§„åˆ’ï¼Œåˆ—äº†äº›è·å¥–æ•°æ®ï¼Œä¸Šæ¬¡è¯„å§”æŒ‘æˆ˜æˆ‘è¦æ§åˆ¶å˜é‡ã€ç»™æ•°æ®ï¼Œå“¥æˆ‘æ˜¯åœ¨åšå·¥ç¨‹ï¼Œä¸æ˜¯åœ¨åšè®ºæ–‡å®éªŒæ•°æ®ï¼Œæ²¡æœ‰æ•°æ®å°±ä¸èƒ½åˆ¤æ–­å‡ºæˆ‘çš„æ–¹æ¡ˆæ˜¯å¦å¯è¡Œï¼Ÿçœ‹ä¸åˆ°æˆ‘çš„è´¡çŒ®ï¼Ÿè¯„å§”çš„ä¸“ä¸šèƒ½åŠ›ä½“ç°åœ¨å“ªå‘¢ï¼Ÿ\n\u0026hellip;\næ‰€ä»¥æˆ‘çº ç»“çš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè‡ªå·±çš„å·¥ä½œæ²¡æœ‰è¢«çœ‹è§ã€‚å¯èƒ½åœ¨å‘ä¸Šç®¡ç†ä¸Šæˆ‘æ²¡æœ‰èŠ±å¿ƒæ€å»åšï¼Œè¯„å®¡æ—¶ä¹Ÿæ²¡æœ‰èŠ±å¿ƒæ€å»å±•ç¤ºã€‚æˆ‘è¿˜æ˜¯å€¾å‘äºå¯¹äº‹æƒ…æœ¬èº«è´Ÿè´£ï¼Œå¯¹è¿™ç§è€ƒæ ¸ã€è¯„ä»·ä½“ç³»ï¼Œæˆ‘æ˜¯ä¸å¾ˆä¹äºå»èå…¥çš„ã€‚å°±å¦‚åŒä¸€äº›è¯„å§”æåˆ°ç°åœ¨è¯„å®¡å­˜åœ¨å¾ˆå¤šç¼ºé™·ä¸€æ ·ï¼Œæˆ‘ä¹Ÿä¸æƒ³å»èå…¥ï¼Œå¹¶ä¸æ˜¯ä¸èƒ½ã€‚\nSoï¼Œæˆ‘è¿˜æ˜¯ä¸å¼€å¿ƒï¼Œå› ä¸ºæˆ‘æ— æ³•å½±å“æ›´æ— æ³•æ§åˆ¶æ•´ä¸ªè¯„ä»·è€ƒæ ¸ä½“ç³»ï¼Œæˆ‘å¿…é¡»åšå‡ºä¸€äº›æ”¹å˜æ‰å¯ä»¥å»æ‰è¿™äº›ä¸å¼€å¿ƒçš„ä¸œè¥¿ã€‚å†æ¥å†å‰ï¼Œä½†æ˜¯ä¹Ÿç¡®å®éœ€è¦è€ƒè™‘â€œé€‰æ‹©â€çš„é‡è¦æ€§ï¼Œæˆ‘ä¸èƒ½ä¸€ç›´å› ä¸ºæ¬£èµä¸ªåˆ«é¢†å¯¼è€Œä¸€ç›´åœ¨æ²¡æœ‰å‰æ™¯çš„ä¸šåŠ¡çº¿è€—ç€ï¼Œæˆ‘è¿˜æƒ³åšäº›å…¶ä»–çš„ï¼Œä¹Ÿéœ€è¦è¿›ä¸€æ­¥æˆé•¿ï¼Œä¹Ÿéœ€è¦å…»å®¶ï¼Œå¿…é¡»æ›´å¥½åœ°å¹³è¡¡å·¥ä½œå’Œç”Ÿæ´»ã€‚\næ—…è¡Œæ˜¯æ¶ˆæ„çš„è‰¯è¯ # è¿™å‡ å¤©ï¼Œåˆšå¥½ä¸­å¿ƒæœ‰äº›å°ä¼™ä¼´è¦å¤–å‡ºå›¢å»ºï¼Œè¶è¿™ä¸ªæœºä¼šï¼Œæˆ‘ä¹Ÿæƒ³ä¼‘æ¯ä¸‹ï¼Œè¯·äº†å‡ å¤©å‡ï¼Œå»çœ‹æœ›ä¸‹å¤šå¹´æœªè§çš„è€å©†å®¶äººï¼Œä¹Ÿé¡ºä¾¿è°ƒæ•´ä¸‹è‡ªå·±çš„æƒ…ç»ªã€‚è¿™æ¬¡ä¸€è¡Œï¼Œè®©æˆ‘æ„Ÿè§‰ï¼Œå®¶äºº\u0026amp;ç”Ÿæ´»ï¼Œè¿œè¿œæ¯”å·¥ä½œé‡è¦ã€‚\nå·¥ä½œå†å¿™å†çƒ¦ï¼Œä¹Ÿä¸èƒ½å°†è¿™äº›è´Ÿé¢ä¿¡æ¯å¸¦å…¥åˆ°è‡ªå·±å®¶åº­ã€å®¶äººã€ç”Ÿæ´»ä¸­ï¼Œå·¥ä½œå°±æ˜¯å·¥ä½œï¼Œç”Ÿæ´»å°±æ˜¯ç”Ÿæ´»ï¼Œå·¥ä½œå°±æ˜¯ä¸ºäº†ç”Ÿæ´»ï¼Œè€Œä¸èƒ½å°†ç”Ÿæ´»çœ‹åšå·¥ä½œçš„é™„å±å“ã€‚ä¸å·¥ä½œæ€ä¹ˆç”Ÿæ´»ï¼Œä¸åŠ ç­æ€ä¹ˆä¹°æˆ¿ä¹°è½¦â€¦â€¦ç«äº‰å¥‹æ–—æ˜¯ä¸€ç§æˆé•¿æ–¹å¼ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æˆé•¿çš„ç»ˆç‚¹ï¼Œç›´çº¿è™½ç„¶è·¯å¾„æœ€çŸ­ï¼Œä½†æ˜¯å¹¶ä¸å®šé€Ÿåº¦æœ€å¿«ã€‚å¤§å¤šæ•°äººèµ°çš„è·¯ï¼Œè‚¯å®šæ²¡ä»€ä¹ˆæ–°æ„ï¼Œä½ æ²¡å¿…è¦è¸©ç€åˆ«äººè„šå°é‡èµ°ä¸€éï¼Œé‡æ–°æ¢æ¡è·¯èµ°é¿å¼€äººæµè¯´ä¸å®šèƒ½æœ‰çªç ´ã€‚\nè¿™å‡ å¤©ï¼Œæˆ‘çœ‹åˆ°å„ç§å„æ ·å·¥ä½œçš„äººï¼Œå¼€ç€å“ˆé›·é€å¤–å–çš„ï¼Œä¹°åœŸè±†æ¡çš„ï¼Œæ‰“æ‰«å…¬å…±å«ç”Ÿçš„ï¼Œå•†åœºå¯¼å”®å‘˜ï¼Œæ”¿åŠ¡å·¥ä½œäººå‘˜ï¼Œä¿å®‰ï¼Œè¡—å¤´å–å”±çš„ï¼Œæ™¯åŒºå–ç¥¨çš„ï¼Œå†œå®¶ç§åœ°çš„ï¼Œâ€¦â€¦ä»–ä»¬ä¼¼ä¹å¹¶æ²¡æœ‰å› ä¸ºèŒä¸šé—®é¢˜è€Œä¸å¼€å¿ƒï¼Œä¹Ÿåº”è¯¥ä¸ä¼šæœ‰å¾ˆå¤šäººå› ä¸ºè‡ªå·±ä¸æ˜¯å¼€å‘äººå‘˜è€Œä¸å¼€å¿ƒï¼Œå°±å¥½æ¯”æˆ‘å¹¶æ²¡æœ‰å› ä¸ºè‡ªå·±ä¸æ˜¯ä¸€ä¸ªè®¾è®¡å¸ˆè€Œåæ‚”ä¸€æ ·ã€‚æˆ‘ä»¬ç¾¡æ…•åˆ«äººå¹¶ä¸æ˜¯å› ä¸ºä»–çš„èŒä¸šï¼Œè€Œæ˜¯å› ä¸ºä»–çš„å¾…é‡ã€‚\nç¾¡æ…•ä»€ä¹ˆæ ·çš„å¾…é‡å‘¢ï¼Ÿç®€è¨€ä¹‹ï¼Œæˆ‘è®¤ä¸ºåªæœ‰ä¸¤ä¸ªç»´åº¦ï¼Œæ—¶é—´å’Œé‡‘é’±ã€‚æˆ‘ä»¬æ€»æ˜¯åœ¨åšé€‰æ‹©ã€æƒè¡¡ã€å–èˆã€‚å·¥ä½œæ—¶é—´è¶Šé•¿ï¼Œæ”¶å…¥ä¹Ÿæ›´å¤šäº›ï¼Œåä¹‹å°±å°‘äº›ã€‚æœ‰æ—¶å€™æˆ‘ä»¬è§‰å¾—è‡ªå·±æ—¶é—´å¯ä»¥å¤šæŠ•å…¥ä»¥æ¢å–é‡‘é’±ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ç­ï¼Œæœ‰æ—¶æˆ‘ä»¬ç´¯äº†å®å¯æƒ³æŒ£ç‚¹é’±å·²é¿å…åˆ«äººå‹æ¦¨è‡ªå·±çš„æ—¶é—´ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¼€å§‹æå‰ä¸‹ç­ï¼Œæˆ–è€…ä¼‘å‡ä»¥é¿å…è‡ªå·±å·¥ä½œæ—¶ç–²å€¦æ¶ˆè€—æ›´å¤šæ—¶é—´ã€‚\nçœ‹åˆ°æ²¡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç¬¬ä¸€æ—¶é—´å°†å¥åº·æ‘†åœ¨ç¬¬ä¸€ä½ï¼Œå®ƒå‡ ä¹æ€»æ˜¯æ—¶é—´å’Œé‡‘é’±ç›¸æŒä¸ä¸‹æˆ–è€…ä¸€æ–¹ä¼˜åŠ¿æ˜æ˜¾æ—¶æ‰ä¼šæƒ³åˆ°çš„ä¸€ä¸ªå‚è€ƒå› ç´ ã€‚ä¸è¿‡èƒ½æƒ³åˆ°æ€»æ¯”æƒ³ä¸åˆ°å¥½ã€‚æˆ‘å°±ç»å¸¸æ²¡æœ‰è€ƒè™‘å¥åº·ã€‚\nè¿™æ˜¯è‡ªå·±å¯¹è‡ªå·±æç«¯ä¸è´Ÿè´£ä»»çš„è¡Œä¸ºï¼Œä¹Ÿæ˜¯å¯¹è‡ªå·±çš„å®¶åº­ä¸è´Ÿè´£ä»»ã€‚æ„Ÿè°¢è¿™æ¬¡â€œæ—…è¡Œâ€æ•™ä¼šäº†æˆ‘è¿™ä¹ˆå¤šã€‚\næ¥ä¸‹æ¥åšä»€ä¹ˆå‘¢ # è¦åšçš„äº‹æƒ…ï¼Œåœ¨è‡ªå·±è„‘æµ·é‡Œå·²ç»è§„åˆ’çš„å·®ä¸å¤šäº†ï¼Œæœ€è¿‘æ€è€ƒç€æ€è€ƒç€æ›´åšå®šäº†è‡ªå·±çš„æƒ³æ³•ã€‚è¿˜æ˜¯è¦æŒ‰ç…§è‡ªå·±é¢„å…ˆè®¾å®šçš„ç›®æ ‡å»è¾¾æˆï¼Œæˆ‘ç›¸ä¿¡è‡ªå·±ã€‚\nps: åœ¨æˆ‘å†™å®Œæœ¬æ–‡ç¬¬äºŒå¤©ï¼Œå¾—çŸ¥ä¸€ä¸ªæƒŠäººçš„æ¶ˆæ¯ï¼Œä¸€ä¸ªå¤§å­¦åŒå­¦è¯Šæ–­å¾—äº†èƒ¶è´¨ç˜¤ï¼Œé©¬ä¸Šä¸¤ä¸ªå­©å­çš„çˆ¸çˆ¸äº†ï¼Œç»“æœé­æ­¤ä¸å¹¸ã€‚ç–¾ç—…å¹¶éç¦»æˆ‘ä»¬å¾ˆè¿œï¼ŒåŠªåŠ›å¥‹æ–—çš„åŒæ—¶ï¼Œä¹Ÿè¦æ³¨æ„ä¿æŠ¤å¥½èº«ä½“ã€‚",content:"ä¸ºä»€ä¹ˆå·¥ä½œä¸å¼€å¿ƒ # 2020ä¸ŠåŠå¹´ç»©æ•ˆè€ƒè¯„å‡ºæ¥äº†ï¼ŒOuterstandingï¼Œ5æ˜Ÿå¥½è¯„ï¼ŒæŠ€æœ¯é€šé“æ™‹å‡ç­”è¾©ç»“æœä¹Ÿå‡ºæ¥äº†ï¼ŒT10ï¼Œç®—æ˜¯åŒäº‹ä»¬å¯¹è‡ªå·±å·¥ä½œçš„è®¤å¯å§ï¼Œå¯¹æˆ‘è‡ªå·±æ¥è¯´ä¹Ÿæ˜¯ä¸ªå¥½äº‹ï¼Œå°½ç®¡æˆ‘å¹¶æ²¡æœ‰æ„Ÿè§‰å¤šä¹ˆå¼€å¿ƒã€‚è€å©†è¯´ï¼Œè™½ç„¶ä½ æ²¡è§‰å¾—å¤šä¹ˆå¼€å¿ƒï¼Œä½†æ˜¯å¦‚æœæ²¡è¿‡çš„è¯ä¸€å®šä¼šè§‰å¾—ä¸å¼€å¿ƒâ€¦â€¦å¬ç€å¾ˆæœ‰é“ç†ã€‚\nè¿™ä¸ª5æ˜Ÿçš„è€ƒæ ¸ï¼Œæˆ‘ä¹Ÿæ²¡ä»€ä¹ˆå¥½å¼€å¿ƒçš„ï¼Œå› ä¸ºä¸šåŠ¡å›¢é˜Ÿè¿™è¾¹ä¸€å¼€å§‹ç»™çš„æ˜¯4æ˜Ÿï¼Œåé¢å‘¢ï¼Œå› ä¸ºåœ¨ä¸­å°ä¸­çš„è´¡çŒ®æ¯”è¾ƒçªå‡ºï¼Œbgå±‚é¢æœ‰ç»©æ•ˆçš„åŠ æˆï¼Œæ‰€ä»¥ä»4æ˜Ÿæåˆ°äº†5æ˜Ÿã€‚leaderå‘Šè¯‰æˆ‘è¿™ä¸ªå¥½æ¶ˆæ¯åï¼Œæˆ‘å¹¶æ²¡æœ‰è§‰å¾—å¼€å¿ƒæˆ–è€…ä¸å¼€å¿ƒã€‚æˆ‘åšçš„å·¥ä½œå°±æ‘†åœ¨è¿™é‡Œï¼Œä¸ºä»€ä¹ˆä¸æ˜¯è‡ªå·±ä¸šåŠ¡å›¢é˜Ÿç»™æˆ‘è€ƒæ ¸5æ˜Ÿï¼Œåè€Œæ˜¯æŠ€æœ¯è¿è¥éƒ¨åé¦ˆçš„bgå±‚é¢çš„ä¸­å°è´¡çŒ®ï¼Œè®©æˆ‘çš„ç»©æ•ˆä»4æ˜Ÿæåˆ°äº†5æ˜Ÿï¼Ÿ\nå¹´åˆ3æœˆä»½æ™‹å‡T10æ²¡é€šè¿‡ï¼ŒåŸå› ä¸€å †æœ‰çš„æ²¡çš„è¯„è¯­ï¼Œå…¶å®è¿™æ¬¡è¯„çº§åœ¨å†…å®¹å±‚é¢ä¹Ÿå¹¶æ²¡æœ‰ç‰¹åˆ«å¤§çš„å˜åŒ–ï¼Œåªæ˜¯è¡¥å……äº†äº›ä¸šåŠ¡æ•°æ®ã€è´¡çŒ®è·å¥–æƒ…å†µï¼ŒPPTè®²çš„æ—¶å€™å¾®è°ƒäº†ä¸‹ç›®å½•ç»“æ„ï¼Œä¸è¿‡åŸºæœ¬ä¸Šæ²¡æŒ‰æµç¨‹è®²ä¸‹æ¥ï¼Œè¯„å§”å…¨ç¨‹æŒ‘æˆ˜ï¼Œæœ€åé€šè¿‡äº†ã€‚å’Œä¸Šæ¬¡ç­”è¾©ç›¸æ¯”ï¼Œç­”è¾©å†…å®¹æ¯”ä¸Šæ¬¡è¿›æ­¥äº†å“ªäº›å‘¢ï¼Œå†…å®¹ç»„ç»‡çš„æ›´å®¹æ˜“è¢«å¬ä¼—æ¥å—äº†ï¼Œåˆ—äº†äº›ä¸šåŠ¡å¯¹æ¯”æ•°æ®ã€ç³»ç»Ÿæœªæ¥è§„åˆ’ï¼Œåˆ—äº†äº›è·å¥–æ•°æ®ï¼Œä¸Šæ¬¡è¯„å§”æŒ‘æˆ˜æˆ‘è¦æ§åˆ¶å˜é‡ã€ç»™æ•°æ®ï¼Œå“¥æˆ‘æ˜¯åœ¨åšå·¥ç¨‹ï¼Œä¸æ˜¯åœ¨åšè®ºæ–‡å®éªŒæ•°æ®ï¼Œæ²¡æœ‰æ•°æ®å°±ä¸èƒ½åˆ¤æ–­å‡ºæˆ‘çš„æ–¹æ¡ˆæ˜¯å¦å¯è¡Œï¼Ÿçœ‹ä¸åˆ°æˆ‘çš„è´¡çŒ®ï¼Ÿè¯„å§”çš„ä¸“ä¸šèƒ½åŠ›ä½“ç°åœ¨å“ªå‘¢ï¼Ÿ\n\u0026hellip;\næ‰€ä»¥æˆ‘çº ç»“çš„é—®é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè‡ªå·±çš„å·¥ä½œæ²¡æœ‰è¢«çœ‹è§ã€‚å¯èƒ½åœ¨å‘ä¸Šç®¡ç†ä¸Šæˆ‘æ²¡æœ‰èŠ±å¿ƒæ€å»åšï¼Œè¯„å®¡æ—¶ä¹Ÿæ²¡æœ‰èŠ±å¿ƒæ€å»å±•ç¤ºã€‚æˆ‘è¿˜æ˜¯å€¾å‘äºå¯¹äº‹æƒ…æœ¬èº«è´Ÿè´£ï¼Œå¯¹è¿™ç§è€ƒæ ¸ã€è¯„ä»·ä½“ç³»ï¼Œæˆ‘æ˜¯ä¸å¾ˆä¹äºå»èå…¥çš„ã€‚å°±å¦‚åŒä¸€äº›è¯„å§”æåˆ°ç°åœ¨è¯„å®¡å­˜åœ¨å¾ˆå¤šç¼ºé™·ä¸€æ ·ï¼Œæˆ‘ä¹Ÿä¸æƒ³å»èå…¥ï¼Œå¹¶ä¸æ˜¯ä¸èƒ½ã€‚\nSoï¼Œæˆ‘è¿˜æ˜¯ä¸å¼€å¿ƒï¼Œå› ä¸ºæˆ‘æ— æ³•å½±å“æ›´æ— æ³•æ§åˆ¶æ•´ä¸ªè¯„ä»·è€ƒæ ¸ä½“ç³»ï¼Œæˆ‘å¿…é¡»åšå‡ºä¸€äº›æ”¹å˜æ‰å¯ä»¥å»æ‰è¿™äº›ä¸å¼€å¿ƒçš„ä¸œè¥¿ã€‚å†æ¥å†å‰ï¼Œä½†æ˜¯ä¹Ÿç¡®å®éœ€è¦è€ƒè™‘â€œé€‰æ‹©â€çš„é‡è¦æ€§ï¼Œæˆ‘ä¸èƒ½ä¸€ç›´å› ä¸ºæ¬£èµä¸ªåˆ«é¢†å¯¼è€Œä¸€ç›´åœ¨æ²¡æœ‰å‰æ™¯çš„ä¸šåŠ¡çº¿è€—ç€ï¼Œæˆ‘è¿˜æƒ³åšäº›å…¶ä»–çš„ï¼Œä¹Ÿéœ€è¦è¿›ä¸€æ­¥æˆé•¿ï¼Œä¹Ÿéœ€è¦å…»å®¶ï¼Œå¿…é¡»æ›´å¥½åœ°å¹³è¡¡å·¥ä½œå’Œç”Ÿæ´»ã€‚\næ—…è¡Œæ˜¯æ¶ˆæ„çš„è‰¯è¯ # è¿™å‡ å¤©ï¼Œåˆšå¥½ä¸­å¿ƒæœ‰äº›å°ä¼™ä¼´è¦å¤–å‡ºå›¢å»ºï¼Œè¶è¿™ä¸ªæœºä¼šï¼Œæˆ‘ä¹Ÿæƒ³ä¼‘æ¯ä¸‹ï¼Œè¯·äº†å‡ å¤©å‡ï¼Œå»çœ‹æœ›ä¸‹å¤šå¹´æœªè§çš„è€å©†å®¶äººï¼Œä¹Ÿé¡ºä¾¿è°ƒæ•´ä¸‹è‡ªå·±çš„æƒ…ç»ªã€‚è¿™æ¬¡ä¸€è¡Œï¼Œè®©æˆ‘æ„Ÿè§‰ï¼Œå®¶äºº\u0026amp;ç”Ÿæ´»ï¼Œè¿œè¿œæ¯”å·¥ä½œé‡è¦ã€‚\nå·¥ä½œå†å¿™å†çƒ¦ï¼Œä¹Ÿä¸èƒ½å°†è¿™äº›è´Ÿé¢ä¿¡æ¯å¸¦å…¥åˆ°è‡ªå·±å®¶åº­ã€å®¶äººã€ç”Ÿæ´»ä¸­ï¼Œå·¥ä½œå°±æ˜¯å·¥ä½œï¼Œç”Ÿæ´»å°±æ˜¯ç”Ÿæ´»ï¼Œå·¥ä½œå°±æ˜¯ä¸ºäº†ç”Ÿæ´»ï¼Œè€Œä¸èƒ½å°†ç”Ÿæ´»çœ‹åšå·¥ä½œçš„é™„å±å“ã€‚ä¸å·¥ä½œæ€ä¹ˆç”Ÿæ´»ï¼Œä¸åŠ ç­æ€ä¹ˆä¹°æˆ¿ä¹°è½¦â€¦â€¦ç«äº‰å¥‹æ–—æ˜¯ä¸€ç§æˆé•¿æ–¹å¼ï¼Œä½†æ˜¯ä¹Ÿä¸æ˜¯æˆé•¿çš„ç»ˆç‚¹ï¼Œç›´çº¿è™½ç„¶è·¯å¾„æœ€çŸ­ï¼Œä½†æ˜¯å¹¶ä¸å®šé€Ÿåº¦æœ€å¿«ã€‚å¤§å¤šæ•°äººèµ°çš„è·¯ï¼Œè‚¯å®šæ²¡ä»€ä¹ˆæ–°æ„ï¼Œä½ æ²¡å¿…è¦è¸©ç€åˆ«äººè„šå°é‡èµ°ä¸€éï¼Œé‡æ–°æ¢æ¡è·¯èµ°é¿å¼€äººæµè¯´ä¸å®šèƒ½æœ‰çªç ´ã€‚\nè¿™å‡ å¤©ï¼Œæˆ‘çœ‹åˆ°å„ç§å„æ ·å·¥ä½œçš„äººï¼Œå¼€ç€å“ˆé›·é€å¤–å–çš„ï¼Œä¹°åœŸè±†æ¡çš„ï¼Œæ‰“æ‰«å…¬å…±å«ç”Ÿçš„ï¼Œå•†åœºå¯¼å”®å‘˜ï¼Œæ”¿åŠ¡å·¥ä½œäººå‘˜ï¼Œä¿å®‰ï¼Œè¡—å¤´å–å”±çš„ï¼Œæ™¯åŒºå–ç¥¨çš„ï¼Œå†œå®¶ç§åœ°çš„ï¼Œâ€¦â€¦ä»–ä»¬ä¼¼ä¹å¹¶æ²¡æœ‰å› ä¸ºèŒä¸šé—®é¢˜è€Œä¸å¼€å¿ƒï¼Œä¹Ÿåº”è¯¥ä¸ä¼šæœ‰å¾ˆå¤šäººå› ä¸ºè‡ªå·±ä¸æ˜¯å¼€å‘äººå‘˜è€Œä¸å¼€å¿ƒï¼Œå°±å¥½æ¯”æˆ‘å¹¶æ²¡æœ‰å› ä¸ºè‡ªå·±ä¸æ˜¯ä¸€ä¸ªè®¾è®¡å¸ˆè€Œåæ‚”ä¸€æ ·ã€‚æˆ‘ä»¬ç¾¡æ…•åˆ«äººå¹¶ä¸æ˜¯å› ä¸ºä»–çš„èŒä¸šï¼Œè€Œæ˜¯å› ä¸ºä»–çš„å¾…é‡ã€‚\nç¾¡æ…•ä»€ä¹ˆæ ·çš„å¾…é‡å‘¢ï¼Ÿç®€è¨€ä¹‹ï¼Œæˆ‘è®¤ä¸ºåªæœ‰ä¸¤ä¸ªç»´åº¦ï¼Œæ—¶é—´å’Œé‡‘é’±ã€‚æˆ‘ä»¬æ€»æ˜¯åœ¨åšé€‰æ‹©ã€æƒè¡¡ã€å–èˆã€‚å·¥ä½œæ—¶é—´è¶Šé•¿ï¼Œæ”¶å…¥ä¹Ÿæ›´å¤šäº›ï¼Œåä¹‹å°±å°‘äº›ã€‚æœ‰æ—¶å€™æˆ‘ä»¬è§‰å¾—è‡ªå·±æ—¶é—´å¯ä»¥å¤šæŠ•å…¥ä»¥æ¢å–é‡‘é’±ï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ ç­ï¼Œæœ‰æ—¶æˆ‘ä»¬ç´¯äº†å®å¯æƒ³æŒ£ç‚¹é’±å·²é¿å…åˆ«äººå‹æ¦¨è‡ªå·±çš„æ—¶é—´ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¼€å§‹æå‰ä¸‹ç­ï¼Œæˆ–è€…ä¼‘å‡ä»¥é¿å…è‡ªå·±å·¥ä½œæ—¶ç–²å€¦æ¶ˆè€—æ›´å¤šæ—¶é—´ã€‚\nçœ‹åˆ°æ²¡ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰ç¬¬ä¸€æ—¶é—´å°†å¥åº·æ‘†åœ¨ç¬¬ä¸€ä½ï¼Œå®ƒå‡ ä¹æ€»æ˜¯æ—¶é—´å’Œé‡‘é’±ç›¸æŒä¸ä¸‹æˆ–è€…ä¸€æ–¹ä¼˜åŠ¿æ˜æ˜¾æ—¶æ‰ä¼šæƒ³åˆ°çš„ä¸€ä¸ªå‚è€ƒå› ç´ ã€‚ä¸è¿‡èƒ½æƒ³åˆ°æ€»æ¯”æƒ³ä¸åˆ°å¥½ã€‚æˆ‘å°±ç»å¸¸æ²¡æœ‰è€ƒè™‘å¥åº·ã€‚\nè¿™æ˜¯è‡ªå·±å¯¹è‡ªå·±æç«¯ä¸è´Ÿè´£ä»»çš„è¡Œä¸ºï¼Œä¹Ÿæ˜¯å¯¹è‡ªå·±çš„å®¶åº­ä¸è´Ÿè´£ä»»ã€‚æ„Ÿè°¢è¿™æ¬¡â€œæ—…è¡Œâ€æ•™ä¼šäº†æˆ‘è¿™ä¹ˆå¤šã€‚\næ¥ä¸‹æ¥åšä»€ä¹ˆå‘¢ # è¦åšçš„äº‹æƒ…ï¼Œåœ¨è‡ªå·±è„‘æµ·é‡Œå·²ç»è§„åˆ’çš„å·®ä¸å¤šäº†ï¼Œæœ€è¿‘æ€è€ƒç€æ€è€ƒç€æ›´åšå®šäº†è‡ªå·±çš„æƒ³æ³•ã€‚è¿˜æ˜¯è¦æŒ‰ç…§è‡ªå·±é¢„å…ˆè®¾å®šçš„ç›®æ ‡å»è¾¾æˆï¼Œæˆ‘ç›¸ä¿¡è‡ªå·±ã€‚\nps: åœ¨æˆ‘å†™å®Œæœ¬æ–‡ç¬¬äºŒå¤©ï¼Œå¾—çŸ¥ä¸€ä¸ªæƒŠäººçš„æ¶ˆæ¯ï¼Œä¸€ä¸ªå¤§å­¦åŒå­¦è¯Šæ–­å¾—äº†èƒ¶è´¨ç˜¤ï¼Œé©¬ä¸Šä¸¤ä¸ªå­©å­çš„çˆ¸çˆ¸äº†ï¼Œç»“æœé­æ­¤ä¸å¹¸ã€‚ç–¾ç—…å¹¶éç¦»æˆ‘ä»¬å¾ˆè¿œï¼ŒåŠªåŠ›å¥‹æ–—çš„åŒæ—¶ï¼Œä¹Ÿè¦æ³¨æ„ä¿æŠ¤å¥½èº«ä½“ã€‚\n"}),a.add({id:236,href:"/tags/%E5%B7%A5%E4%BD%9C/",title:"å·¥ä½œ",description:"",content:""}),a.add({id:237,href:"/tags/%E5%B9%B3%E8%A1%A1/",title:"å¹³è¡¡",description:"",content:""}),a.add({id:238,href:"/tags/%E7%94%9F%E6%B4%BB/",title:"ç”Ÿæ´»",description:"",content:""}),a.add({id:239,href:"/tags/disassembler/",title:"disassembler",description:"",content:""}),a.add({id:240,href:"/tags/gapstone/",title:"gapstone",description:"",content:""}),a.add({id:241,href:"/blog/2020-09-06-%E5%89%96%E6%9E%90go%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6/",title:"å‰–ægoäºŒè¿›åˆ¶æ–‡ä»¶",description:"ä¸ºä»€ä¹ˆè¦åæ±‡ç¼–ï¼Ÿ # è¿™ç¯‡æ–‡ç« ä»‹ç»ä¸‹åæ±‡ç¼–çš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•ç”¨goè¯­è¨€å†™ä¸€ä¸ªç®€å•çš„åæ±‡ç¼–å™¨ã€‚æœ¬æ–‡çš„ç›®æ ‡å°±æ˜¯ä¸ºäº†å°½å¯èƒ½æè¿°ä¸‹åæ±‡ç¼–çš„çš„ç›¸å…³æ¦‚å¿µï¼Œä»¥åŠè®©è¯»è€…æœ‹å‹ä»¬äº†è§£goäºŒè¿›åˆ¶ç¨‹åºå†…éƒ¨å¤§è‡´æ˜¯ä»€ä¹ˆæ ·çš„ã€‚\næ±‡ç¼–ä»£ç ä¸ä¼šæ’’è°ï¼Œé˜…è¯»æ±‡ç¼–ä»£ç èƒ½å¤Ÿè®©æˆ‘ä»¬æ›´ç»†è‡´åœ°äº†è§£å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤åˆ°åº•åšäº†ä»€ä¹ˆã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåæ±‡ç¼–å¾ˆé‡è¦çš„åŸå› ä¹‹ä¸€ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºï¼Œå¹¶ä¸”æ€€ç–‘å®ƒæœ‰ä¸€äº›æ¶æ„çš„è¡Œä¸ºï¼Œé€šè¿‡åæ±‡ç¼–æ¥ç ”ç©¶å®ƒå°±æ˜¯ä¸€ç§å¾ˆå¥½çš„é€”å¾„ã€‚å†æˆ–è€…ï¼Œå¦‚æœä½ åˆ†æä»£ç éš¾ä»¥å‘ç°æ€§èƒ½ç“¶é¢ˆï¼Œé‚£ä¹ˆåæ±‡ç¼–ä¹Ÿæ˜¯ä¸€ç§å¯ä»¥ç®€åŒ–åˆ†æçš„é€”å¾„ã€‚\nå¦‚æœä½ æ‹…å¿ƒèƒ½ä¸èƒ½é˜…è¯»x86_64æ±‡ç¼–ä»£ç çš„é—®é¢˜ï¼Œå…¶å®ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†éƒ½ä¸èƒ½å¾ˆé¡ºç•…åœ°é˜…è¯»ã€‚ä½ ä¹Ÿæ²¡æœ‰å¿…è¦ä¸ºäº†ææ‡‚è¿™ç¯‡æ–‡ç« å»é˜…è¯»å…¶ä»–ä»»ä½•çš„æ±‡ç¼–ä»£ç ï¼Œä¸è¿‡å¦‚æœæœ‰æ±‡ç¼–åŸºç¡€çš„è¯ç¡®å®ä¼šæ„Ÿè§‰æ›´æœ‰æ„æ€ç‚¹ã€‚è¿™é‡Œæœ‰ä¸€ç¯‡ä»‹ç»æ±‡ç¼–åŸºç¡€çš„æ–‡ç«  A fundamental introduction to x86 assembly programmingã€‚\nä»€ä¹ˆæ˜¯åæ±‡ç¼–ï¼Ÿ # é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯åæ±‡ç¼–å‘¢ï¼Ÿ\nåæ±‡ç¼–ï¼Œå…¶å®æ˜¯å°†å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œé‡æ–°è½¬æ¢ä¸ºæ±‡ç¼–ä»£ç çš„è¿‡ç¨‹ã€‚ä¸ºäº†è§£é‡Šæ¸…æ¥šï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘ä¸‹ä»æºä»£ç ç¼–è¯‘æ„å»ºçš„è¿‡ç¨‹ï¼š\næ±‡ç¼–ä»£ç ï¼Œå…¶å®æ˜¯ä¸€ç§ä»‹äºæºä»£ç ã€æœºå™¨æŒ‡ä»¤ä¹‹é—´çš„ä¸­é—´ä»£ç è¡¨ç¤ºï¼Œè™½ç„¶å¤§å¤šæ•°æ±‡ç¼–æŒ‡ä»¤æ˜¯å’Œæœºå™¨æŒ‡ä»¤å¯¹åº”çš„ï¼Œä½†æ˜¯ä¹Ÿä¸ç»å¯¹ï¼Œæ¯”å¦‚goæ±‡ç¼–å°±æ˜¯ä¸€ç§è·Ÿæœºå™¨æŒ‡ä»¤æ²¡æœ‰æ˜æ˜¾å¯¹åº”å…³ç³»çš„æ±‡ç¼–å½¢å¼ã€‚è¯¦ç»†åœ°å¯ä»¥å‚è€ƒgo assemblerè®¾è®¡å¯¹åº”çš„go blogä¸€æ–‡ã€‚okï¼Œè¨€å½’æ­£ä¼ ã€‚ç¼–è¯‘å™¨é¦–å…ˆå°†æºä»£ç è½¬æ¢ä¸ºOS/æ¶æ„ç‰¹å®šçš„æ±‡ç¼–ä»£ç ï¼Œç„¶åå†é€šè¿‡æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨æŒ‡ä»¤ã€‚ä»å­—é¢ä¸Šå°±å¯ä»¥çœ‹å‡ºdisassembleæ˜¯assembleçš„ä¸€ä¸ªé€†å‘çš„è¿‡ç¨‹ï¼Œä¿—ç§°åæ±‡ç¼–ã€‚\nåº†å¹¸åœ°æ˜¯ï¼Œgoè¯­è¨€æœ‰ä¸€ä¸ªç›¸å¯¹æ ‡å‡†ã€å®Œæ•´çš„å·¥å…·é“¾ï¼Œæ±‡ç¼–ã€åæ±‡ç¼–éƒ½ä¼šæ¯”è¾ƒæ–¹ä¾¿ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†æºç è½¬æ¢æˆæ±‡ç¼–ä»£ç æ¥æŸ¥çœ‹ï¼Œä¾‹å¦‚é€šè¿‡è¿è¡Œå‘½ä»¤ go build -gcflags -S program.goã€‚å¦‚æœæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªç¼–è¯‘æ„å»ºå¥½çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œè¿™ä¸ªæ—¶å€™æƒ³æŸ¥çœ‹æ±‡ç¼–ä»£ç çš„è¯ï¼Œå°±å¾—é€šè¿‡åæ±‡ç¼–ï¼Œå¯ä»¥è¿è¡Œå‘½ä»¤ go tool objdump binaryFileã€‚\nå¦‚æœæƒ³äº†è§£å¦‚ä½•å®ç°æ±‡ç¼–ã€åæ±‡ç¼–çš„è¯ï¼Œè¿™ç¯‡æ–‡ç« å…¶å®å·²ç»å¯ä»¥ç»“æŸäº†ã€‚ä½†æ˜¯å¦‚æœæ¥è§£é‡Šä¸‹å¦‚ä½•ä»0åˆ°1æ„å»ºä¸€ä¸ªåæ±‡ç¼–å™¨çš„è¯ï¼Œè¿˜æ˜¯æœ‰æ„æ€çš„ã€‚\nä»0åˆ°1æ„å»ºåæ±‡ç¼–å™¨ï¼Ÿ # é¦–å…ˆï¼Œä¸ºäº†æ„å»ºä¸€ä¸ªåæ±‡ç¼–å™¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“äºŒè¿›åˆ¶ç¨‹åºå¯¹åº”çš„ç›®æ ‡æœºå™¨æ¶æ„åŒ…å«çš„æ‰€æœ‰çš„æœºå™¨æŒ‡ä»¤ã€‚ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬å¯èƒ½è¦å‚è€ƒç‰¹å®šæ¶æ„çš„æ‰‹å†Œæ¥æŸ¥é˜…åˆ°åº•æœ‰å¤šå°‘æœºå™¨æŒ‡ä»¤ã€‚å¦‚æœå¯¹è¿™ä¸ªä¸ç†Ÿæ‚‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚å…¶å®ï¼Œæœ‰å¾ˆå¤šç§å¾®å¤„ç†å™¨æ¶æ„ã€æ±‡ç¼–è¯­æ³•ã€æŒ‡ä»¤é›†ã€ç¼–ç æ¨¡å¼ï¼Œè€Œä¸”ä¸€ç›´åœ¨å˜ã€‚å…‰æŒæ¡è¿™äº›ä¸åŒæœºå™¨æ¶æ„åŒ…å«çš„æŒ‡ä»¤é›†å°±æ˜¯ä¸€ä¸ªå¾ˆå›°éš¾çš„äº‹æƒ…ï¼Œè‡³äºå¦‚ä½•å›°éš¾å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç«  how many x86_64 instructions are there anywayã€‚\nåº†å¹¸åœ°æ˜¯ï¼Œè¿™äº›ç¹é‡çš„å·¥ä½œåº”è¢«è§£å†³äº†ï¼Œåæ±‡ç¼–æ¡†æ¶Capstoneå°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚Capstoneå…¶å®å·²ç»æ˜¯ä¸€ä¸ªäº‹å®ä¸Šçš„æ ‡å‡†äº†ï¼Œåœ¨å„ç§åæ±‡ç¼–å·¥å…·ä¸­åº”ç”¨å¹¿æ³›ã€‚é‡æ–°å®ç°ä¸€ä¸ªåæ±‡ç¼–æ¡†æ¶ï¼Œå…¶å®æ²¡å¿…è¦ï¼Œè¿™ä¸ªè¿‡ç¨‹åªä¼šæ˜¯ä¸€ä¸ªå­¦ä¹ æ€§çš„ã€æ¯ç‡¥çš„ã€é‡å¤çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ä¸ä¼šä»‹ç»å¦‚ä½•å®ç°ä¸€ä¸ªCapstoneåæ±‡ç¼–æ¡†æ¶ï¼Œåªä¼šä»‹ç»å¦‚ä½•å€ŸåŠ©Capstoneæ¥å®ç°åæ±‡ç¼–çš„èƒ½åŠ›ã€‚åœ¨goè¯­è¨€ä¸­ä½¿ç”¨Capstoneä¹Ÿç®€å•ï¼Œæœ‰ä¸€ä¸ªé’ˆå¯¹goçš„å®ç°gapstoneã€‚\né€šè¿‡ä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªgapstoneåæ±‡ç¼–æ¡†æ¶å¼•æ“ï¼Œç”¨å®ƒæ¥æ‰§è¡Œåç»­çš„åæ±‡ç¼–ä»»åŠ¡ã€‚\nengine, err := gapstone.New( gapstone.CS_ARCH_X86, gapstone.CS_MODE_64, ) if err != nil { log.Fatal(err) }  ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸‹é¢çš„åŸå§‹æŒ‡ä»¤æ•°æ®ä¼ é€’ç»™Capstoneåæ±‡ç¼–æ¡†æ¶ï¼Œç„¶åè¯¥åæ±‡ç¼–æ¡†æ¶å°†ä¼šå°†è¿™äº›åŸå§‹æŒ‡ä»¤æ•°æ®è½¬æ¢ä¸ºå¯¹åº”çš„x86_64ä¸‹çš„æŒ‡ä»¤ã€‚\n0x64 0x48 0x8B 0xC 0x25 0xF8 0xFF 0xFF 0xFF | mov rcx, qword ptr fs:[0xfffffffffffffff8]  æŠŠä¸Šé¢çš„æ“ä½œæ”¾åœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹ï¼š",content:"ä¸ºä»€ä¹ˆè¦åæ±‡ç¼–ï¼Ÿ # è¿™ç¯‡æ–‡ç« ä»‹ç»ä¸‹åæ±‡ç¼–çš„åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠå¦‚ä½•ç”¨goè¯­è¨€å†™ä¸€ä¸ªç®€å•çš„åæ±‡ç¼–å™¨ã€‚æœ¬æ–‡çš„ç›®æ ‡å°±æ˜¯ä¸ºäº†å°½å¯èƒ½æè¿°ä¸‹åæ±‡ç¼–çš„çš„ç›¸å…³æ¦‚å¿µï¼Œä»¥åŠè®©è¯»è€…æœ‹å‹ä»¬äº†è§£goäºŒè¿›åˆ¶ç¨‹åºå†…éƒ¨å¤§è‡´æ˜¯ä»€ä¹ˆæ ·çš„ã€‚\næ±‡ç¼–ä»£ç ä¸ä¼šæ’’è°ï¼Œé˜…è¯»æ±‡ç¼–ä»£ç èƒ½å¤Ÿè®©æˆ‘ä»¬æ›´ç»†è‡´åœ°äº†è§£å¤„ç†å™¨æ‰§è¡Œçš„æŒ‡ä»¤åˆ°åº•åšäº†ä»€ä¹ˆã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåæ±‡ç¼–å¾ˆé‡è¦çš„åŸå› ä¹‹ä¸€ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºï¼Œå¹¶ä¸”æ€€ç–‘å®ƒæœ‰ä¸€äº›æ¶æ„çš„è¡Œä¸ºï¼Œé€šè¿‡åæ±‡ç¼–æ¥ç ”ç©¶å®ƒå°±æ˜¯ä¸€ç§å¾ˆå¥½çš„é€”å¾„ã€‚å†æˆ–è€…ï¼Œå¦‚æœä½ åˆ†æä»£ç éš¾ä»¥å‘ç°æ€§èƒ½ç“¶é¢ˆï¼Œé‚£ä¹ˆåæ±‡ç¼–ä¹Ÿæ˜¯ä¸€ç§å¯ä»¥ç®€åŒ–åˆ†æçš„é€”å¾„ã€‚\nå¦‚æœä½ æ‹…å¿ƒèƒ½ä¸èƒ½é˜…è¯»x86_64æ±‡ç¼–ä»£ç çš„é—®é¢˜ï¼Œå…¶å®ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å¤§éƒ¨åˆ†éƒ½ä¸èƒ½å¾ˆé¡ºç•…åœ°é˜…è¯»ã€‚ä½ ä¹Ÿæ²¡æœ‰å¿…è¦ä¸ºäº†ææ‡‚è¿™ç¯‡æ–‡ç« å»é˜…è¯»å…¶ä»–ä»»ä½•çš„æ±‡ç¼–ä»£ç ï¼Œä¸è¿‡å¦‚æœæœ‰æ±‡ç¼–åŸºç¡€çš„è¯ç¡®å®ä¼šæ„Ÿè§‰æ›´æœ‰æ„æ€ç‚¹ã€‚è¿™é‡Œæœ‰ä¸€ç¯‡ä»‹ç»æ±‡ç¼–åŸºç¡€çš„æ–‡ç«  A fundamental introduction to x86 assembly programmingã€‚\nä»€ä¹ˆæ˜¯åæ±‡ç¼–ï¼Ÿ # é‚£ä¹ˆï¼Œä»€ä¹ˆæ˜¯åæ±‡ç¼–å‘¢ï¼Ÿ\nåæ±‡ç¼–ï¼Œå…¶å®æ˜¯å°†å·²ç»ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œé‡æ–°è½¬æ¢ä¸ºæ±‡ç¼–ä»£ç çš„è¿‡ç¨‹ã€‚ä¸ºäº†è§£é‡Šæ¸…æ¥šï¼Œæˆ‘ä»¬å…ˆè€ƒè™‘ä¸‹ä»æºä»£ç ç¼–è¯‘æ„å»ºçš„è¿‡ç¨‹ï¼š\næ±‡ç¼–ä»£ç ï¼Œå…¶å®æ˜¯ä¸€ç§ä»‹äºæºä»£ç ã€æœºå™¨æŒ‡ä»¤ä¹‹é—´çš„ä¸­é—´ä»£ç è¡¨ç¤ºï¼Œè™½ç„¶å¤§å¤šæ•°æ±‡ç¼–æŒ‡ä»¤æ˜¯å’Œæœºå™¨æŒ‡ä»¤å¯¹åº”çš„ï¼Œä½†æ˜¯ä¹Ÿä¸ç»å¯¹ï¼Œæ¯”å¦‚goæ±‡ç¼–å°±æ˜¯ä¸€ç§è·Ÿæœºå™¨æŒ‡ä»¤æ²¡æœ‰æ˜æ˜¾å¯¹åº”å…³ç³»çš„æ±‡ç¼–å½¢å¼ã€‚è¯¦ç»†åœ°å¯ä»¥å‚è€ƒgo assemblerè®¾è®¡å¯¹åº”çš„go blogä¸€æ–‡ã€‚okï¼Œè¨€å½’æ­£ä¼ ã€‚ç¼–è¯‘å™¨é¦–å…ˆå°†æºä»£ç è½¬æ¢ä¸ºOS/æ¶æ„ç‰¹å®šçš„æ±‡ç¼–ä»£ç ï¼Œç„¶åå†é€šè¿‡æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨æŒ‡ä»¤ã€‚ä»å­—é¢ä¸Šå°±å¯ä»¥çœ‹å‡ºdisassembleæ˜¯assembleçš„ä¸€ä¸ªé€†å‘çš„è¿‡ç¨‹ï¼Œä¿—ç§°åæ±‡ç¼–ã€‚\nåº†å¹¸åœ°æ˜¯ï¼Œgoè¯­è¨€æœ‰ä¸€ä¸ªç›¸å¯¹æ ‡å‡†ã€å®Œæ•´çš„å·¥å…·é“¾ï¼Œæ±‡ç¼–ã€åæ±‡ç¼–éƒ½ä¼šæ¯”è¾ƒæ–¹ä¾¿ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥å°†æºç è½¬æ¢æˆæ±‡ç¼–ä»£ç æ¥æŸ¥çœ‹ï¼Œä¾‹å¦‚é€šè¿‡è¿è¡Œå‘½ä»¤ go build -gcflags -S program.goã€‚å¦‚æœæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªç¼–è¯‘æ„å»ºå¥½çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œè¿™ä¸ªæ—¶å€™æƒ³æŸ¥çœ‹æ±‡ç¼–ä»£ç çš„è¯ï¼Œå°±å¾—é€šè¿‡åæ±‡ç¼–ï¼Œå¯ä»¥è¿è¡Œå‘½ä»¤ go tool objdump binaryFileã€‚\nå¦‚æœæƒ³äº†è§£å¦‚ä½•å®ç°æ±‡ç¼–ã€åæ±‡ç¼–çš„è¯ï¼Œè¿™ç¯‡æ–‡ç« å…¶å®å·²ç»å¯ä»¥ç»“æŸäº†ã€‚ä½†æ˜¯å¦‚æœæ¥è§£é‡Šä¸‹å¦‚ä½•ä»0åˆ°1æ„å»ºä¸€ä¸ªåæ±‡ç¼–å™¨çš„è¯ï¼Œè¿˜æ˜¯æœ‰æ„æ€çš„ã€‚\nä»0åˆ°1æ„å»ºåæ±‡ç¼–å™¨ï¼Ÿ # é¦–å…ˆï¼Œä¸ºäº†æ„å»ºä¸€ä¸ªåæ±‡ç¼–å™¨ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“äºŒè¿›åˆ¶ç¨‹åºå¯¹åº”çš„ç›®æ ‡æœºå™¨æ¶æ„åŒ…å«çš„æ‰€æœ‰çš„æœºå™¨æŒ‡ä»¤ã€‚ä¸ºäº†å®ç°è¿™ä¸ªï¼Œæˆ‘ä»¬å¯èƒ½è¦å‚è€ƒç‰¹å®šæ¶æ„çš„æ‰‹å†Œæ¥æŸ¥é˜…åˆ°åº•æœ‰å¤šå°‘æœºå™¨æŒ‡ä»¤ã€‚å¦‚æœå¯¹è¿™ä¸ªä¸ç†Ÿæ‚‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚å…¶å®ï¼Œæœ‰å¾ˆå¤šç§å¾®å¤„ç†å™¨æ¶æ„ã€æ±‡ç¼–è¯­æ³•ã€æŒ‡ä»¤é›†ã€ç¼–ç æ¨¡å¼ï¼Œè€Œä¸”ä¸€ç›´åœ¨å˜ã€‚å…‰æŒæ¡è¿™äº›ä¸åŒæœºå™¨æ¶æ„åŒ…å«çš„æŒ‡ä»¤é›†å°±æ˜¯ä¸€ä¸ªå¾ˆå›°éš¾çš„äº‹æƒ…ï¼Œè‡³äºå¦‚ä½•å›°éš¾å¯ä»¥å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç«  how many x86_64 instructions are there anywayã€‚\nåº†å¹¸åœ°æ˜¯ï¼Œè¿™äº›ç¹é‡çš„å·¥ä½œåº”è¢«è§£å†³äº†ï¼Œåæ±‡ç¼–æ¡†æ¶Capstoneå°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚Capstoneå…¶å®å·²ç»æ˜¯ä¸€ä¸ªäº‹å®ä¸Šçš„æ ‡å‡†äº†ï¼Œåœ¨å„ç§åæ±‡ç¼–å·¥å…·ä¸­åº”ç”¨å¹¿æ³›ã€‚é‡æ–°å®ç°ä¸€ä¸ªåæ±‡ç¼–æ¡†æ¶ï¼Œå…¶å®æ²¡å¿…è¦ï¼Œè¿™ä¸ªè¿‡ç¨‹åªä¼šæ˜¯ä¸€ä¸ªå­¦ä¹ æ€§çš„ã€æ¯ç‡¥çš„ã€é‡å¤çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ä¸ä¼šä»‹ç»å¦‚ä½•å®ç°ä¸€ä¸ªCapstoneåæ±‡ç¼–æ¡†æ¶ï¼Œåªä¼šä»‹ç»å¦‚ä½•å€ŸåŠ©Capstoneæ¥å®ç°åæ±‡ç¼–çš„èƒ½åŠ›ã€‚åœ¨goè¯­è¨€ä¸­ä½¿ç”¨Capstoneä¹Ÿç®€å•ï¼Œæœ‰ä¸€ä¸ªé’ˆå¯¹goçš„å®ç°gapstoneã€‚\né€šè¿‡ä¸‹é¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥åˆå§‹åŒ–ä¸€ä¸ªgapstoneåæ±‡ç¼–æ¡†æ¶å¼•æ“ï¼Œç”¨å®ƒæ¥æ‰§è¡Œåç»­çš„åæ±‡ç¼–ä»»åŠ¡ã€‚\nengine, err := gapstone.New( gapstone.CS_ARCH_X86, gapstone.CS_MODE_64, ) if err != nil { log.Fatal(err) }  ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸‹é¢çš„åŸå§‹æŒ‡ä»¤æ•°æ®ä¼ é€’ç»™Capstoneåæ±‡ç¼–æ¡†æ¶ï¼Œç„¶åè¯¥åæ±‡ç¼–æ¡†æ¶å°†ä¼šå°†è¿™äº›åŸå§‹æŒ‡ä»¤æ•°æ®è½¬æ¢ä¸ºå¯¹åº”çš„x86_64ä¸‹çš„æŒ‡ä»¤ã€‚\n0x64 0x48 0x8B 0xC 0x25 0xF8 0xFF 0xFF 0xFF | mov rcx, qword ptr fs:[0xfffffffffffffff8]  æŠŠä¸Šé¢çš„æ“ä½œæ”¾åœ¨ä¸€èµ·ï¼Œå¦‚ä¸‹ï¼š\nfile: main.go\ninput := []byte{0x64, 0x48, 0x8B, 0xC, 0x25, 0xF8, 0xFF, 0xFF, 0xFF} instructions, err := engine.Disasm(input, 0, 0) if err != nil { log.Fatal(err) } for _, instruction := range instructions { fmt.Printf(\u0026quot;0x%x:\\t%s\\t\\t%s\\n\u0026quot;, instruction.Address, instruction.Mnemonic, instruction.OpStr) }  æµ‹è¯•ä¸‹ï¼š\n$ go run main.go 0x0:	mov	rcx, qword ptr fs:[0xfffffffffffffff8]  æœ‰äº†è¿™ä¸ªåæ±‡ç¼–æ¡†æ¶Capstoneä¹‹åï¼Œè¦å®ç°ä¸€ä¸ªåæ±‡ç¼–å™¨ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå‰©ä¸‹çš„å·¥ä½œè¦åšï¼Œå°±æ˜¯ä»äºŒè¿›åˆ¶ç¨‹åºä¸­æå–æŒ‡ä»¤å¯¹åº”çš„åŸå§‹æ•°æ®ï¼Œç„¶åå°†å…¶ä¼ ç»™Capstoneç¿»è¯‘å¼•æ“å°±å¯ä»¥äº†ã€‚\nå½“ä½ åœ¨ä¸€ä¸ªç¬”è®°æœ¬ä¸Šç¼–è¯‘ä¸€ä¸ªgoç¨‹åºã€é»˜è®¤è¾“å‡ºæ˜¯64ä½ELFæ ¼å¼ï¼ˆExecutable Linkable Formatï¼‰ã€‚ELFå†…éƒ¨å…¶å®æ˜¯è¢«ç»„ç»‡æˆäº†å¤šä¸ªä¸åŒçš„èŠ‚ï¼ˆsectionï¼‰ï¼Œæ¯ä¸€ä¸ªsectionéƒ½æœ‰ä¸åŒçš„ç›®çš„ï¼Œå¦‚å­˜å‚¨ç‰ˆæœ¬ä¿¡æ¯ã€ç¨‹åºå…ƒæ•°æ®ä¿¡æ¯ã€å¯æ‰§è¡Œä»£ç ç­‰ç­‰ã€‚ELFæ˜¯è¢«å¹¿æ³›é‡‡ç”¨çš„ä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºæ ‡å‡†ï¼Œgoè¯­è¨€æ ‡å‡†åº“é‡Œé¢æä¾›äº†ä¸€ä¸ª debug/elf packageç”¨æ¥è¿›è¡ŒELFæ–‡ä»¶æ•°æ®çš„è¯»å†™ã€‚ELFå…¶å®æœ‰ç‚¹å¤æ‚ï¼Œä½†æ˜¯è¦å®ç°åæ±‡ç¼–çš„è¯å…¶å®æˆ‘ä»¬åªå…³å¿ƒä¸¤ä¸ªsectionå°±å¯ä»¥äº†ã€‚ä¸€ä¸ªæ˜¯ç¬¦å·è¡¨sectionï¼ˆ.symtabï¼‰ï¼Œä¸€ä¸ªæ˜¯æŒ‡ä»¤section ï¼ˆ.textï¼‰ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æœ¯è¯­symbolçš„å®šä¹‰ï¼Œå…¶å®å®ƒæŒ‡çš„æ˜¯ä»£ç ä¸­ä»»ä½•æœ‰åçš„ä¸œè¥¿ï¼Œå¦‚å˜é‡ã€å‡½æ•°ã€ç±»å‹ã€å¸¸é‡ç­‰éƒ½æ˜¯symbolsã€‚goç¼–è¯‘å™¨ä¼šç¼–è¯‘æ¯ä¸€ä¸ªç¬¦å·ï¼Œå¹¶å­˜å‚¨å¯¹ç¬¦å·è¡¨ä¸­ç¬¦å·çš„å¼•ç”¨ä¿¡æ¯ã€‚goæ ‡å‡†åº“ debug/elf ä¸­æä¾›äº†å¯¹ELFæ–‡ä»¶çš„è¯»å†™èƒ½åŠ›ï¼Œæ¯ä¸€ä¸ªç¬¦å·éƒ½é€šè¿‡ç»“æ„ä½“ Symbol æ¥è¡¨ç¤ºï¼Œå®ƒåŒ…æ‹¬äº†ç¬¦å·çš„åå­—ã€åœ°å€ã€åŸå§‹æ•°æ®çš„å¤šå°‘ç­‰ç­‰å§ã€‚\n// A Symbol represents an entry in an ELF symbol table section. type Symbol struct { Name string Info byte Other byte Section SectionIndex Value uint64 Size uint64 }  ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¿«é€Ÿæå–ELFæ–‡ä»¶ä¸­çš„æ‰€æœ‰ç¬¦å·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™ä¹ˆå®ç°ï¼š\n// Open the ELF file elfFile, err := elf.Open(path) if err != nil { log.Fatalf(\u0026quot;error while opening ELF file %s: %+s\u0026quot;, path, err.Error()) } // Extract the symbol table symbolTable, err := elfFile.Symbols() if err != nil { log.Fatalf(\u0026quot;could not extract symbol table: %s\u0026quot;, err.Error()) } // Traverse through each symbol in the symbol table for _, symbol := range symbolTable { /* symbol.Info lets us tell if this symbol is a function that we want to disassemble symbol.Value gives us the offset from the start of the .text section symbol.Size lets us calculate the full address range of this symbol in the .text section */ }  ä»Symbolå„ä¸ªå­—æ®µçš„åå­—å‘½åä¸Šçœ‹å¹¶ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œç¬¦å·å¯¹åº”çš„å†…å­˜åç§»é‡å…¶å®æ˜¯å­˜å‚¨åœ¨Valueå­—æ®µä¸­çš„ã€‚é€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œå¯ä»¥é€šè¿‡è®¡ç®—ä¸.text sectionçš„åç§»é‡çš„å·®å€¼ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºç¬¦å·å¯¹åº”çš„æŒ‡ä»¤æ•°æ®åœ¨.text sectionä¸­çš„èµ·å§‹ç´¢å¼•ã€‚é€šè¿‡è¿›ä¸€æ­¥çš„Sizeæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºåŒ…å«çš„æŒ‡ä»¤æ•°æ®å¯¹åº”çš„å­—èŠ‚æ•°é‡ã€‚è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯Infoå­—æ®µï¼Œè¿™ä¸ªå­—æ®µèµ·å§‹æ˜¯ç±»å‹çš„æ„æ€ï¼Œåœ¨goé‡Œé¢Info=byte(2)è¡¨ç¤ºçš„æ˜¯å‡½æ•°ï¼ŒInfo=byte(18)è¡¨ç¤ºçš„æ˜¯æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œå¦‚æœæƒ³å®ç°å¯¹å‡½æ•°ã€æ–¹æ³•çš„åæ±‡ç¼–çš„è¯ï¼Œæˆ‘ä»¬åªå¤„ç†è¿™ä¸¤ç§ç±»å‹çš„å°±å¯ä»¥äº†ã€‚\næœ‰äº†è¿™äº›ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¿«é€Ÿçš„å†å®Œå–„ä¸€ä¸‹äº†ï¼š\n// extract the .text section textSection := elfFile.Section(\u0026quot;.text\u0026quot;) if textSection == nil { log.Fatal(\u0026quot;No text section\u0026quot;) } // extract the raw bytes from the .text section textSectionData, err := textSection.Data() if err != nil { log.Fatal(err) } // traverse through the symbol table for _, symbol := range symbolTable { // skip over any symbols that aren't functinons/methods if symbol.Info != byte(2) \u0026amp;\u0026amp; symbol.Info != byte(18) { continue } // skip over empty symbols if symbol.Size == 0 { continue } // calculate starting and ending index of the symbol within the text section symbolStartingIndex := symbol.Value - textSection.Addr symbolEndingIndex := symbolStartingIndex + symbol.Size // collect the bytes of the symbol symbolBytes := textSectionData[symbolStartingIndex:symbolEndingIndex] // disasemble the symbol instructions, err := engine.Disasm(symbolBytes, symbol.Value, 0) if err != nil { log.Fatalf(\u0026quot;could not disasemble symbol: %s\u0026quot;, err) } // print out each instruction that's part of this symbol fmt.Printf(\u0026quot;\\n\\nSYMBOL %s\\n\u0026quot;, symbol.Name) for _, ins := range instructions { fmt.Printf(\u0026quot;0x%x:\\t%s\\t\\t%s\\n\u0026quot;, ins.Address, ins.Mnemonic, ins.OpStr) } }  å®Œæ•´çš„å®ä¾‹ä»£ç ï¼Œè¯¦è§ full disassemblerã€‚å®ç°ä¸€ä¸ªç®€å•çš„åæ±‡ç¼–å™¨ï¼Œå®é™…ä¸Šåªç”¨äº†70~80è¡Œä»£ç è€Œå·²ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è¿è¡Œå®ä¾‹ã€‚\n æ³¨æ„: åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ä¸‹capstoneçš„ç‰ˆæœ¬ã€gapstaoneçš„ç‰ˆæœ¬ï¼Œä¸ç„¶æµ‹è¯•çš„æ—¶å€™å¯èƒ½ä¼šå‡ºé”™ã€‚è¿™é‡Œå…ˆæš‚æ—¶ä¸è¯¦ç»†å†™äº†ï¼Œé‡åˆ°é—®é¢˜å¯ä»¥å»repoä¸‹æŸ¥issueã€‚\nå‚è€ƒå†…å®¹ # 1.dissecting go binaries, https://www.grant.pizza/dissecting-go-binaries\n"}),a.add({id:242,href:"/tags/forkexec/",title:"forkexec",description:"",content:""}),a.add({id:243,href:"/blog/2020-08-28-go%E7%A8%8B%E5%BA%8F%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%83%AD%E9%87%8D%E5%90%AF/",title:"goç¨‹åºå¦‚ä½•å®ç°çƒ­é‡å¯",description:"æœ€è¿‘åœ¨ä¼˜åŒ–å…¬å¸æ¡†æ¶trpcæ—¶å‘ç°äº†ä¸€ä¸ªçƒ­é‡å¯ç›¸å…³çš„é—®é¢˜ï¼Œä¼˜åŒ–ä¹‹ä½™ä¹Ÿæ€»ç»“æ²‰æ·€ä¸‹ï¼Œå¯¹goå¦‚ä½•å®ç°çƒ­é‡å¯è¿™æ–¹é¢çš„å†…å®¹åšä¸€ä¸ªç®€å•çš„æ¢³ç†ã€‚\n1.ä»€ä¹ˆæ˜¯çƒ­é‡å¯ï¼Ÿ # çƒ­é‡å¯ï¼ˆHot Restartï¼‰ï¼Œæ˜¯ä¸€é¡¹ä¿è¯æœåŠ¡å¯ç”¨æ€§çš„æ‰‹æ®µã€‚å®ƒå…è®¸æœåŠ¡é‡å¯æœŸé—´ï¼Œä¸ä¸­æ–­å·²ç»å»ºç«‹çš„è¿æ¥ï¼Œè€æœåŠ¡è¿›ç¨‹ä¸å†æ¥å—æ–°è¿æ¥è¯·æ±‚ï¼Œæ–°è¿æ¥è¯·æ±‚å°†åœ¨æ–°æœåŠ¡è¿›ç¨‹ä¸­å—ç†ã€‚å¯¹äºåŸæœåŠ¡è¿›ç¨‹ä¸­å·²ç»å»ºç«‹çš„è¿æ¥ï¼Œä¹Ÿå¯ä»¥å°†å…¶è®¾ä¸ºè¯»å…³é—­ï¼Œç­‰å¾…å¹³æ»‘å¤„ç†å®Œè¿æ¥ä¸Šçš„è¯·æ±‚åŠè¿æ¥ç©ºé—²åå†è¡Œé€€å‡ºã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä¿è¯å·²å»ºç«‹çš„è¿æ¥ä¸ä¸­æ–­ï¼Œè¿æ¥ä¸Šçš„äº‹åŠ¡ï¼ˆè¯·æ±‚ã€å¤„ç†ã€å“åº”ï¼‰å¯ä»¥æ­£å¸¸å®Œæˆï¼Œæ–°çš„æœåŠ¡è¿›ç¨‹ä¹Ÿå¯ä»¥æ­£å¸¸æ¥å—è¿æ¥ã€å¤„ç†è¿æ¥ä¸Šçš„è¯·æ±‚ã€‚å½“ç„¶ï¼Œçƒ­é‡å¯æœŸé—´è¿›ç¨‹å¹³æ»‘é€€å‡ºæ¶‰åŠåˆ°çš„ä¸æ­¢æ˜¯è¿æ¥ä¸Šçš„äº‹åŠ¡ï¼Œä¹Ÿæœ‰æ¶ˆæ¯æœåŠ¡ã€è‡ªå®šä¹‰äº‹åŠ¡éœ€è¦å…³æ³¨ã€‚\nè¿™æ˜¯æˆ‘ç†è§£çš„çƒ­é‡å¯çš„ä¸€ä¸ªå¤§è‡´æè¿°ã€‚çƒ­é‡å¯ç°åœ¨è¿˜æœ‰æ²¡æœ‰å­˜åœ¨çš„å¿…è¦ï¼Ÿæˆ‘çš„ç†è§£æ˜¯çœ‹åœºæ™¯ã€‚\nä»¥åå°å¼€å‘ä¸ºä¾‹ï¼Œå‡å¦‚è¿ç»´å¹³å°æœ‰èƒ½åŠ›åœ¨æœåŠ¡å‡çº§ã€é‡å¯æ—¶è‡ªåŠ¨è¸¢æ‰æµé‡ï¼ŒæœåŠ¡å°±ç»ªååˆè‡ªåŠ¨åŠ å›æµé‡ï¼Œå‡å¦‚èƒ½å¤Ÿåˆç†é¢„ä¼°æœåŠ¡QPSã€è¯·æ±‚å¤„ç†æ—¶é•¿ï¼Œé‚£ä¹ˆåªè¦é…ç½®ä¸€ä¸ªåˆç†çš„åœæ­¢å‰ç­‰å¾…æ—¶é—´ï¼Œæ˜¯å¯ä»¥è¾¾åˆ°ç±»ä¼¼çƒ­é‡å¯çš„æ•ˆæœçš„ã€‚è¿™æ ·çš„è¯ï¼Œåœ¨åå°æœåŠ¡é‡Œé¢æ”¯æŒçƒ­é‡å¯å°±æ˜¾å¾—æ²¡ä»€ä¹ˆå¿…è¦ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¼€å‘ä¸€ä¸ªå¾®æœåŠ¡æ¡†æ¶ï¼Œä¸èƒ½å¯¹å°†æ¥çš„éƒ¨ç½²å¹³å°ã€ç¯å¢ƒåšè¿™ç§å‡è®¾ï¼Œä¹Ÿæœ‰å¯èƒ½ä½¿ç”¨æ–¹åªæ˜¯éƒ¨ç½²åœ¨ä¸€ä¸¤å°ç‰©ç†æœºä¸Šï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–çš„è´Ÿè½½å‡è¡¡è®¾æ–½ï¼Œä½†ä¸å¸Œæœ›å› ä¸ºé‡å¯å—å¹²æ‰°ï¼Œçƒ­é‡å¯å°±å¾ˆæœ‰å¿…è¦ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›æ›´å¤æ‚ã€è¦æ±‚æ›´è‹›åˆ»çš„åœºæ™¯ï¼Œä¹Ÿéœ€è¦çƒ­é‡å¯çš„èƒ½åŠ›ã€‚\nçƒ­é‡å¯æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€é¡¹ä¿è¯æœåŠ¡è´¨é‡çš„æ‰‹æ®µï¼Œè¿˜æ˜¯å€¼å¾—äº†è§£ä¸‹çš„ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡ä»‹ç»çš„åˆè¡·ã€‚\n2.å¦‚ä½•å®ç°çƒ­é‡å¯ï¼Ÿ # å¦‚ä½•å®ç°çƒ­é‡å¯ï¼Œè¿™é‡Œå…¶å®ä¸èƒ½ä¸€æ¦‚è€Œè®ºï¼Œè¦ç»“åˆå®é™…çš„åœºæ™¯æ¥çœ‹ï¼ˆæ¯”å¦‚æœåŠ¡ç¼–ç¨‹æ¨¡å‹ã€å¯¹å¯ç”¨æ€§è¦æ±‚çš„é«˜ä½ç­‰ï¼‰ã€‚å¤§è‡´çš„å®ç°æ€è·¯ï¼Œå¯ä»¥å…ˆæŠ›ä¸€ä¸‹ã€‚\nä¸€èˆ¬è¦å®ç°çƒ­é‡å¯ï¼Œå¤§è‡´è¦åŒ…æ‹¬å¦‚ä¸‹æ­¥éª¤ï¼š\n é¦–å…ˆï¼Œè¦è®©è€è¿›ç¨‹ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºçˆ¶è¿›ç¨‹äº†ï¼Œå…ˆè¦forkå‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥ä»£æ›¿å®ƒå·¥ä½œï¼› ç„¶åï¼Œå­è¿›ç¨‹å°±ç»ªä¹‹åï¼Œé€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œæ­£å¸¸æ¥å—æ–°è¿æ¥è¯·æ±‚ã€å¤„ç†è¿æ¥ä¸Šæ”¶åˆ°çš„è¯·æ±‚ï¼› å†ç„¶åï¼Œçˆ¶è¿›ç¨‹å¤„ç†å®Œå·²å»ºç«‹è¿æ¥ä¸Šçš„è¯·æ±‚åã€è¿æ¥ç©ºé—²åï¼Œå¹³æ»‘é€€å‡ºã€‚  å¬ä¸Šå»æ˜¯æŒºç®€å•çš„\u0026hellip;\n2.1.è®¤è¯†fork # å¤§å®¶éƒ½çŸ¥é“fork() ç³»ç»Ÿè°ƒç”¨ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨forkä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹å‰¯æœ¬ï¼Œä»£ç ä¸­è¿˜å¯ä»¥é€šè¿‡forkè¿”å›å€¼æ˜¯å¦ä¸º0æ¥åŒºåˆ†æ˜¯å­è¿›ç¨‹è¿˜æ˜¯çˆ¶è¿›ç¨‹ã€‚\nint main(char **argv, int argc) { pid_t pid = fork(); if (pid == 0) { printf(\u0026quot;i am child process\u0026quot;); } else { printf(\u0026quot;i am parent process, i have a child process named %d\u0026quot;, pid); } }  å¯èƒ½æœ‰äº›å¼€å‘äººå‘˜ä¸çŸ¥é“forkçš„å®ç°åŸç†ï¼Œæˆ–è€…ä¸çŸ¥é“forkè¿”å›å€¼ä¸ºä»€ä¹ˆåœ¨çˆ¶å­è¿›ç¨‹ä¸­ä¸åŒï¼Œæˆ–è€…ä¸çŸ¥é“å¦‚ä½•åšåˆ°çˆ¶å­è¿›ç¨‹ä¸­è¿”å›å€¼ä¸åŒâ€¦â€¦äº†è§£è¿™äº›æ˜¯è¦æœ‰ç‚¹çŸ¥è¯†ç§¯ç´¯çš„ã€‚\n2.2.è¿”å›å€¼ # ç®€å•æ¦‚æ‹¬ä¸‹ï¼ŒABIå®šä¹‰äº†è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶çš„ä¸€äº›è§„èŒƒï¼Œå¦‚ä½•ä¼ é€’å‚æ•°ï¼Œå¦‚ä½•è¿”å›å€¼ç­‰ç­‰ï¼Œä»¥x86ä¸ºä¾‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯raxå¯„å­˜å™¨èƒ½å¤Ÿå®¹çš„ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡raxå¯„å­˜å™¨è¿”å›çš„ã€‚\nå¦‚æœraxå¯„å­˜å™¨ä½å®½æ— æ³•å®¹çº³ä¸‹çš„è¿”å›å€¼å‘¢ï¼Ÿä¹Ÿç®€å•ï¼Œç¼–è¯‘å™¨ä¼šå®‰æ’äº›æŒ‡ä»¤æ¥å®Œæˆè¿™äº›ç¥ç§˜çš„æ“ä½œï¼Œå…·ä½“æ˜¯ä»€ä¹ˆæŒ‡ä»¤ï¼Œå°±è·Ÿè¯­è¨€ç¼–è¯‘å™¨å®ç°ç›¸å…³äº†ã€‚\n cè¯­è¨€ï¼Œå¯èƒ½ä¼šå°†è¿”å›å€¼çš„åœ°å€ï¼Œä¼ é€’åˆ°rdiæˆ–å…¶ä»–å¯„å­˜å™¨ï¼Œè¢«è°ƒå‡½æ•°å†…éƒ¨å‘¢ï¼Œé€šè¿‡å¤šæ¡æŒ‡ä»¤å°†è¿”å›å€¼å†™å…¥rdiä»£æŒ‡çš„å†…å­˜åŒºï¼› cè¯­è¨€ï¼Œä¹Ÿå¯èƒ½åœ¨è¢«è°ƒå‡½æ•°å†…éƒ¨ï¼Œç”¨å¤šä¸ªå¯„å­˜å™¨rax,rdx\u0026hellip;ä¸€èµ·æš‚å­˜è¿”å›ç»“æœï¼Œå‡½æ•°è¿”å›æ—¶å†å°†å¤šä¸ªå¯„å­˜å™¨çš„å€¼èµ‹å€¼åˆ°å˜é‡ä¸­ï¼› ä¹Ÿå¯èƒ½ä¼šåƒgolangè¿™æ ·ï¼Œé€šè¿‡æ ˆå†…å­˜æ¥è¿”å›ï¼›  2.3.forkè¿”å›å€¼ # forkç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œæœ‰ç‚¹ç‰¹æ®Šï¼Œåœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸­ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å€¼æ˜¯ä¸åŒçš„ï¼Œå¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ",content:"æœ€è¿‘åœ¨ä¼˜åŒ–å…¬å¸æ¡†æ¶trpcæ—¶å‘ç°äº†ä¸€ä¸ªçƒ­é‡å¯ç›¸å…³çš„é—®é¢˜ï¼Œä¼˜åŒ–ä¹‹ä½™ä¹Ÿæ€»ç»“æ²‰æ·€ä¸‹ï¼Œå¯¹goå¦‚ä½•å®ç°çƒ­é‡å¯è¿™æ–¹é¢çš„å†…å®¹åšä¸€ä¸ªç®€å•çš„æ¢³ç†ã€‚\n1.ä»€ä¹ˆæ˜¯çƒ­é‡å¯ï¼Ÿ # çƒ­é‡å¯ï¼ˆHot Restartï¼‰ï¼Œæ˜¯ä¸€é¡¹ä¿è¯æœåŠ¡å¯ç”¨æ€§çš„æ‰‹æ®µã€‚å®ƒå…è®¸æœåŠ¡é‡å¯æœŸé—´ï¼Œä¸ä¸­æ–­å·²ç»å»ºç«‹çš„è¿æ¥ï¼Œè€æœåŠ¡è¿›ç¨‹ä¸å†æ¥å—æ–°è¿æ¥è¯·æ±‚ï¼Œæ–°è¿æ¥è¯·æ±‚å°†åœ¨æ–°æœåŠ¡è¿›ç¨‹ä¸­å—ç†ã€‚å¯¹äºåŸæœåŠ¡è¿›ç¨‹ä¸­å·²ç»å»ºç«‹çš„è¿æ¥ï¼Œä¹Ÿå¯ä»¥å°†å…¶è®¾ä¸ºè¯»å…³é—­ï¼Œç­‰å¾…å¹³æ»‘å¤„ç†å®Œè¿æ¥ä¸Šçš„è¯·æ±‚åŠè¿æ¥ç©ºé—²åå†è¡Œé€€å‡ºã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä¿è¯å·²å»ºç«‹çš„è¿æ¥ä¸ä¸­æ–­ï¼Œè¿æ¥ä¸Šçš„äº‹åŠ¡ï¼ˆè¯·æ±‚ã€å¤„ç†ã€å“åº”ï¼‰å¯ä»¥æ­£å¸¸å®Œæˆï¼Œæ–°çš„æœåŠ¡è¿›ç¨‹ä¹Ÿå¯ä»¥æ­£å¸¸æ¥å—è¿æ¥ã€å¤„ç†è¿æ¥ä¸Šçš„è¯·æ±‚ã€‚å½“ç„¶ï¼Œçƒ­é‡å¯æœŸé—´è¿›ç¨‹å¹³æ»‘é€€å‡ºæ¶‰åŠåˆ°çš„ä¸æ­¢æ˜¯è¿æ¥ä¸Šçš„äº‹åŠ¡ï¼Œä¹Ÿæœ‰æ¶ˆæ¯æœåŠ¡ã€è‡ªå®šä¹‰äº‹åŠ¡éœ€è¦å…³æ³¨ã€‚\nè¿™æ˜¯æˆ‘ç†è§£çš„çƒ­é‡å¯çš„ä¸€ä¸ªå¤§è‡´æè¿°ã€‚çƒ­é‡å¯ç°åœ¨è¿˜æœ‰æ²¡æœ‰å­˜åœ¨çš„å¿…è¦ï¼Ÿæˆ‘çš„ç†è§£æ˜¯çœ‹åœºæ™¯ã€‚\nä»¥åå°å¼€å‘ä¸ºä¾‹ï¼Œå‡å¦‚è¿ç»´å¹³å°æœ‰èƒ½åŠ›åœ¨æœåŠ¡å‡çº§ã€é‡å¯æ—¶è‡ªåŠ¨è¸¢æ‰æµé‡ï¼ŒæœåŠ¡å°±ç»ªååˆè‡ªåŠ¨åŠ å›æµé‡ï¼Œå‡å¦‚èƒ½å¤Ÿåˆç†é¢„ä¼°æœåŠ¡QPSã€è¯·æ±‚å¤„ç†æ—¶é•¿ï¼Œé‚£ä¹ˆåªè¦é…ç½®ä¸€ä¸ªåˆç†çš„åœæ­¢å‰ç­‰å¾…æ—¶é—´ï¼Œæ˜¯å¯ä»¥è¾¾åˆ°ç±»ä¼¼çƒ­é‡å¯çš„æ•ˆæœçš„ã€‚è¿™æ ·çš„è¯ï¼Œåœ¨åå°æœåŠ¡é‡Œé¢æ”¯æŒçƒ­é‡å¯å°±æ˜¾å¾—æ²¡ä»€ä¹ˆå¿…è¦ã€‚ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å¼€å‘ä¸€ä¸ªå¾®æœåŠ¡æ¡†æ¶ï¼Œä¸èƒ½å¯¹å°†æ¥çš„éƒ¨ç½²å¹³å°ã€ç¯å¢ƒåšè¿™ç§å‡è®¾ï¼Œä¹Ÿæœ‰å¯èƒ½ä½¿ç”¨æ–¹åªæ˜¯éƒ¨ç½²åœ¨ä¸€ä¸¤å°ç‰©ç†æœºä¸Šï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–çš„è´Ÿè½½å‡è¡¡è®¾æ–½ï¼Œä½†ä¸å¸Œæœ›å› ä¸ºé‡å¯å—å¹²æ‰°ï¼Œçƒ­é‡å¯å°±å¾ˆæœ‰å¿…è¦ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›æ›´å¤æ‚ã€è¦æ±‚æ›´è‹›åˆ»çš„åœºæ™¯ï¼Œä¹Ÿéœ€è¦çƒ­é‡å¯çš„èƒ½åŠ›ã€‚\nçƒ­é‡å¯æ˜¯æ¯”è¾ƒé‡è¦çš„ä¸€é¡¹ä¿è¯æœåŠ¡è´¨é‡çš„æ‰‹æ®µï¼Œè¿˜æ˜¯å€¼å¾—äº†è§£ä¸‹çš„ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡ä»‹ç»çš„åˆè¡·ã€‚\n2.å¦‚ä½•å®ç°çƒ­é‡å¯ï¼Ÿ # å¦‚ä½•å®ç°çƒ­é‡å¯ï¼Œè¿™é‡Œå…¶å®ä¸èƒ½ä¸€æ¦‚è€Œè®ºï¼Œè¦ç»“åˆå®é™…çš„åœºæ™¯æ¥çœ‹ï¼ˆæ¯”å¦‚æœåŠ¡ç¼–ç¨‹æ¨¡å‹ã€å¯¹å¯ç”¨æ€§è¦æ±‚çš„é«˜ä½ç­‰ï¼‰ã€‚å¤§è‡´çš„å®ç°æ€è·¯ï¼Œå¯ä»¥å…ˆæŠ›ä¸€ä¸‹ã€‚\nä¸€èˆ¬è¦å®ç°çƒ­é‡å¯ï¼Œå¤§è‡´è¦åŒ…æ‹¬å¦‚ä¸‹æ­¥éª¤ï¼š\n é¦–å…ˆï¼Œè¦è®©è€è¿›ç¨‹ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºçˆ¶è¿›ç¨‹äº†ï¼Œå…ˆè¦forkå‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥ä»£æ›¿å®ƒå·¥ä½œï¼› ç„¶åï¼Œå­è¿›ç¨‹å°±ç»ªä¹‹åï¼Œé€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œæ­£å¸¸æ¥å—æ–°è¿æ¥è¯·æ±‚ã€å¤„ç†è¿æ¥ä¸Šæ”¶åˆ°çš„è¯·æ±‚ï¼› å†ç„¶åï¼Œçˆ¶è¿›ç¨‹å¤„ç†å®Œå·²å»ºç«‹è¿æ¥ä¸Šçš„è¯·æ±‚åã€è¿æ¥ç©ºé—²åï¼Œå¹³æ»‘é€€å‡ºã€‚  å¬ä¸Šå»æ˜¯æŒºç®€å•çš„\u0026hellip;\n2.1.è®¤è¯†fork # å¤§å®¶éƒ½çŸ¥é“fork() ç³»ç»Ÿè°ƒç”¨ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨forkä¼šåˆ›å»ºä¸€ä¸ªè¿›ç¨‹å‰¯æœ¬ï¼Œä»£ç ä¸­è¿˜å¯ä»¥é€šè¿‡forkè¿”å›å€¼æ˜¯å¦ä¸º0æ¥åŒºåˆ†æ˜¯å­è¿›ç¨‹è¿˜æ˜¯çˆ¶è¿›ç¨‹ã€‚\nint main(char **argv, int argc) { pid_t pid = fork(); if (pid == 0) { printf(\u0026quot;i am child process\u0026quot;); } else { printf(\u0026quot;i am parent process, i have a child process named %d\u0026quot;, pid); } }  å¯èƒ½æœ‰äº›å¼€å‘äººå‘˜ä¸çŸ¥é“forkçš„å®ç°åŸç†ï¼Œæˆ–è€…ä¸çŸ¥é“forkè¿”å›å€¼ä¸ºä»€ä¹ˆåœ¨çˆ¶å­è¿›ç¨‹ä¸­ä¸åŒï¼Œæˆ–è€…ä¸çŸ¥é“å¦‚ä½•åšåˆ°çˆ¶å­è¿›ç¨‹ä¸­è¿”å›å€¼ä¸åŒâ€¦â€¦äº†è§£è¿™äº›æ˜¯è¦æœ‰ç‚¹çŸ¥è¯†ç§¯ç´¯çš„ã€‚\n2.2.è¿”å›å€¼ # ç®€å•æ¦‚æ‹¬ä¸‹ï¼ŒABIå®šä¹‰äº†è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶çš„ä¸€äº›è§„èŒƒï¼Œå¦‚ä½•ä¼ é€’å‚æ•°ï¼Œå¦‚ä½•è¿”å›å€¼ç­‰ç­‰ï¼Œä»¥x86ä¸ºä¾‹ï¼Œå¦‚æœè¿”å›å€¼æ˜¯raxå¯„å­˜å™¨èƒ½å¤Ÿå®¹çš„ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡raxå¯„å­˜å™¨è¿”å›çš„ã€‚\nå¦‚æœraxå¯„å­˜å™¨ä½å®½æ— æ³•å®¹çº³ä¸‹çš„è¿”å›å€¼å‘¢ï¼Ÿä¹Ÿç®€å•ï¼Œç¼–è¯‘å™¨ä¼šå®‰æ’äº›æŒ‡ä»¤æ¥å®Œæˆè¿™äº›ç¥ç§˜çš„æ“ä½œï¼Œå…·ä½“æ˜¯ä»€ä¹ˆæŒ‡ä»¤ï¼Œå°±è·Ÿè¯­è¨€ç¼–è¯‘å™¨å®ç°ç›¸å…³äº†ã€‚\n cè¯­è¨€ï¼Œå¯èƒ½ä¼šå°†è¿”å›å€¼çš„åœ°å€ï¼Œä¼ é€’åˆ°rdiæˆ–å…¶ä»–å¯„å­˜å™¨ï¼Œè¢«è°ƒå‡½æ•°å†…éƒ¨å‘¢ï¼Œé€šè¿‡å¤šæ¡æŒ‡ä»¤å°†è¿”å›å€¼å†™å…¥rdiä»£æŒ‡çš„å†…å­˜åŒºï¼› cè¯­è¨€ï¼Œä¹Ÿå¯èƒ½åœ¨è¢«è°ƒå‡½æ•°å†…éƒ¨ï¼Œç”¨å¤šä¸ªå¯„å­˜å™¨rax,rdx\u0026hellip;ä¸€èµ·æš‚å­˜è¿”å›ç»“æœï¼Œå‡½æ•°è¿”å›æ—¶å†å°†å¤šä¸ªå¯„å­˜å™¨çš„å€¼èµ‹å€¼åˆ°å˜é‡ä¸­ï¼› ä¹Ÿå¯èƒ½ä¼šåƒgolangè¿™æ ·ï¼Œé€šè¿‡æ ˆå†…å­˜æ¥è¿”å›ï¼›  2.3.forkè¿”å›å€¼ # forkç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œæœ‰ç‚¹ç‰¹æ®Šï¼Œåœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸­ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›çš„å€¼æ˜¯ä¸åŒçš„ï¼Œå¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ\nè”æƒ³ä¸‹çˆ¶è¿›ç¨‹è°ƒç”¨forkçš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸éœ€è¦å¹²äº›ä»€ä¹ˆå‘¢ï¼Ÿåˆ†é…è¿›ç¨‹æ§åˆ¶å—ã€åˆ†é…pidã€åˆ†é…å†…å­˜ç©ºé—´â€¦â€¦è‚¯å®šæœ‰å¾ˆå¤šä¸œè¥¿å•¦ï¼Œè¿™é‡Œæ³¨æ„ä¸‹è¿›ç¨‹çš„ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿™äº›æ˜¯éå¸¸é‡è¦çš„ï¼Œåœ¨è¿›ç¨‹è¢«è°ƒåº¦ç®—æ³•é€‰ä¸­è¿›è¡Œè°ƒåº¦æ—¶ï¼Œæ˜¯éœ€è¦è¿˜åŸç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ã€‚\nLinux forkçš„æ—¶å€™ï¼Œä¼šå¯¹å­è¿›ç¨‹çš„ç¡¬ä»¶ä¸Šä¸‹æ–‡è¿›è¡Œä¸€å®šçš„ä¿®æ”¹ï¼Œæˆ‘å°±æ˜¯è®©ä½ forkä¹‹åæ‹¿åˆ°çš„pidæ˜¯0ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿå‰é¢2.2èŠ‚æè¿‡äº†ï¼Œå¯¹äºé‚£äº›å°æ•´æ•°ï¼Œraxå¯„å­˜å™¨å­˜ä¸‹ç»°ç»°æœ‰ä½™ï¼Œforkè¿”å›æ—¶å°±æ˜¯å°†æ“ä½œç³»ç»Ÿåˆ†é…çš„pidæ”¾åˆ°raxå¯„å­˜å™¨çš„ã€‚\né‚£ï¼Œå¯¹äºå­è¿›ç¨‹è€Œè¨€ï¼Œæˆ‘åªè¦åœ¨forkçš„æ—¶å€™å°†å®ƒçš„ç¡¬ä»¶ä¸Šä¸‹æ–‡raxå¯„å­˜å™¨æ¸…0ï¼Œç„¶åç­‰å…¶ä»–è®¾ç½®å…¨okåï¼Œå†å°†å…¶çŠ¶æ€ä»ä¸å¯ä¸­æ–­ç­‰å¾…çŠ¶æ€ä¿®æ”¹ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œç­‰å…¶è¢«è°ƒåº¦å™¨è°ƒåº¦æ—¶ï¼Œä¼šå…ˆè¿˜åŸå…¶ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬PCã€raxç­‰ç­‰ï¼Œè¿™æ ·forkè¿”å›åï¼Œraxä¸­å€¼ä¸º0ï¼Œæœ€ç»ˆèµ‹å€¼ç»™pidçš„å€¼å°±æ˜¯0ã€‚\nå› æ­¤ï¼Œä¹Ÿå°±å¯ä»¥é€šè¿‡è¿™ç§åˆ¤æ–­ â€œpidæ˜¯å¦ç­‰äº0â€ çš„æ–¹å¼æ¥åŒºåˆ†å½“å‰è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹äº†ã€‚\n2.4.å±€é™æ€§ # å¾ˆå¤šäººæ¸…æ¥šforkå¯ä»¥åˆ›å»ºä¸€ä¸ªè¿›ç¨‹çš„å‰¯æœ¬å¹¶ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¯ä»¥æ ¹æ®forkè¿”å›å€¼æ¥æ‰§è¡Œä¸åŒçš„åˆ†æ”¯é€»è¾‘ã€‚å¦‚æœè¿›ç¨‹æ˜¯å¤šçº¿ç¨‹çš„ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨forkä¼šå¤åˆ¶æ•´ä¸ªè¿›ç¨‹å—ï¼Ÿ\nforkåªèƒ½åˆ›å»ºè°ƒç”¨è¯¥å‡½æ•°çš„çº¿ç¨‹çš„å‰¯æœ¬ï¼Œè¿›ç¨‹ä¸­å…¶ä»–è¿è¡Œçš„çº¿ç¨‹ï¼Œforkä¸äºˆå¤„ç†ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¯¹äºå¤šçº¿ç¨‹ç¨‹åºè€Œè¨€ï¼Œå¯„å¸Œæœ›äºé€šè¿‡forkæ¥åˆ›å»ºä¸€ä¸ªå®Œæ•´è¿›ç¨‹å‰¯æœ¬æ˜¯ä¸å¯è¡Œçš„ã€‚\nå‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œforkæ˜¯å®ç°çƒ­é‡å¯çš„é‡è¦ä¸€ç¯ï¼Œforkè¿™é‡Œçš„è¿™ä¸ªå±€é™æ€§ï¼Œå°±åˆ¶çº¦ç€ä¸åŒæœåŠ¡ç¼–ç¨‹æ¨¡å‹ä¸‹çš„çƒ­é‡å¯å®ç°æ–¹å¼ã€‚æ‰€ä»¥æˆ‘ä»¬è¯´å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œä¸åŒç¼–ç¨‹æ¨¡å‹ä¸‹å®é™…ä¸Šå¯ä»¥é‡‡ç”¨ä¸åŒçš„å®ç°æ–¹å¼ã€‚\n3.å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹ # å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹ï¼Œå¯èƒ½å¾ˆå¤šäººä¸€å¬è§‰å¾—å®ƒå·²ç»è¢«æ·˜æ±°äº†ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ä¸èƒ½ç”¨ï¼ŒçœŸçš„ä¹ˆï¼Ÿå¼ºå¦‚redisï¼Œä¸å°±æ˜¯å•çº¿ç¨‹ã€‚å¼ºè°ƒä¸‹å¹¶éå•çº¿ç¨‹æ¨¡å‹æ²¡ç”¨ï¼Œokï¼Œæ”¶å›æ¥ï¼Œç°åœ¨å…³æ³¨ä¸‹å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹å¦‚ä½•å®ç°çƒ­é‡å¯ã€‚\nå•è¿›ç¨‹å•çº¿ç¨‹ï¼Œå®ç°çƒ­é‡å¯ä¼šæ¯”è¾ƒç®€å•äº›:\n forkä¸€ä¸‹å°±å¯ä»¥åˆ›å»ºå‡ºå­è¿›ç¨‹ï¼Œ å­è¿›ç¨‹å¯ä»¥ç»§æ‰¿çˆ¶è¿›ç¨‹ä¸­çš„èµ„æºï¼Œå¦‚å·²ç»æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒ…æ‹¬çˆ¶è¿›ç¨‹çš„listenfdã€connfdï¼Œ çˆ¶è¿›ç¨‹ï¼Œå¯ä»¥é€‰æ‹©å…³é—­listenfdï¼Œåç»­æ¥å—è¿æ¥çš„ä»»åŠ¡å°±äº¤ç»™å­è¿›ç¨‹æ¥å®Œæˆäº†ï¼Œ çˆ¶è¿›ç¨‹ï¼Œç”šè‡³ä¹Ÿå¯ä»¥å…³é—­connfdï¼Œè®©å­è¿›ç¨‹å¤„ç†è¿æ¥ä¸Šçš„è¯·æ±‚ã€å›åŒ…ç­‰ï¼Œä¹Ÿå¯ä»¥è‡ªèº«å¤„ç†å®Œå·²å»ºç«‹çš„è¿æ¥ä¸Šçš„è¯·æ±‚ï¼› çˆ¶è¿›ç¨‹ï¼Œåœ¨åˆé€‚çš„æ—¶é—´ç‚¹é€‰æ‹©é€€å‡ºï¼Œå­è¿›ç¨‹å¼€å§‹å˜æˆé¡¶æ¢æŸ±ã€‚  æ ¸å¿ƒæ€æƒ³å°±æ˜¯è¿™äº›ï¼Œä½†æ˜¯å…·ä½“åˆ°å®ç°ï¼Œå°±æœ‰å¤šç§æ–¹æ³•ï¼š\n å¯ä»¥é€‰æ‹©forkçš„æ–¹å¼è®©å­è¿›ç¨‹æ‹¿åˆ°åŸæ¥çš„listenfdã€connfdï¼Œ ä¹Ÿå¯ä»¥é€‰æ‹©unixdomain socketçš„æ–¹å¼çˆ¶è¿›ç¨‹å°†listenfdã€connfdå‘é€ç»™å­è¿›ç¨‹ã€‚  æœ‰åŒå­¦å¯èƒ½ä¼šæƒ³ï¼Œæˆ‘ä¸ä¼ é€’è¿™äº›fdè¡Œå—ï¼Ÿ\n æ¯”å¦‚æˆ‘å¼€å¯äº†reuseportï¼Œçˆ¶è¿›ç¨‹ç›´æ¥å¤„ç†å®Œå·²å»ºç«‹è¿æ¥connfdä¸Šçš„è¯·æ±‚ä¹‹åå…³é—­ï¼Œå­è¿›ç¨‹é‡Œreuseport.Listenç›´æ¥åˆ›å»ºæ–°çš„listenfdã€‚  ä¹Ÿå¯ä»¥ï¼ä½†æ˜¯æœ‰äº›é—®é¢˜å¿…é¡»è¦æå‰è€ƒè™‘åˆ°ï¼š\n reuseportè™½ç„¶å…è®¸å¤šä¸ªè¿›ç¨‹åœ¨åŒä¸€ä¸ªç«¯å£ä¸Šå¤šæ¬¡listenï¼Œä¼¼ä¹æ»¡è¶³äº†è¦æ±‚ï¼Œä½†æ˜¯è¦çŸ¥é“åªè¦euidç›¸åŒï¼Œéƒ½å¯ä»¥åœ¨è¿™ä¸ªç«¯å£ä¸Šlistenï¼æ˜¯ä¸å®‰å…¨çš„ï¼ reuseportå®ç°å’Œå¹³å°æœ‰å…³ç³»ï¼Œåœ¨Linuxå¹³å°ä¸Šåœ¨åŒä¸€ä¸ªaddress+portä¸Šlistenå¤šæ¬¡ï¼Œå¤šä¸ªlistenfdåº•å±‚å¯ä»¥å…±äº«åŒä¸€ä¸ªè¿æ¥é˜Ÿåˆ—ï¼Œå†…æ ¸å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œä½†æ˜¯åœ¨darwinå¹³å°ä¸Šå´ä¸ä¼šï¼  å½“ç„¶è¿™é‡Œæåˆ°çš„è¿™äº›é—®é¢˜ï¼Œåœ¨å¤šçº¿ç¨‹æ¨¡å‹ä¸‹è‚¯å®šä¹Ÿå­˜åœ¨ã€‚\n4.å•è¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å‹ # å‰é¢æåˆ°çš„é—®é¢˜ï¼Œåœ¨å¤šçº¿ç¨‹æ¨¡å‹ä¸­ä¹Ÿä¼šå‡ºç°ï¼š\n forkåªèƒ½å¤åˆ¶calling threadï¼Œnot whole processï¼ reuseportå¤šæ¬¡åœ¨ç›¸åŒåœ°å€+ç«¯å£listenå¾—åˆ°çš„å¤šä¸ªfdï¼Œä¸åŒå¹³å°æœ‰ä¸åŒçš„è¡¨ç°ï¼Œå¯èƒ½æ— æ³•åšåˆ°æ¥å—è¿æ¥æ—¶çš„load banlanceï¼ éreuseportæƒ…å†µä¸‹ï¼Œå¤šæ¬¡listenä¼šå¤±è´¥ï¼ ä¸ä¼ é€’fdï¼Œç›´æ¥é€šè¿‡reuseportæ¥é‡æ–°listenå¾—åˆ°listenfdï¼Œä¸å®‰å…¨ï¼Œä¸åŒæœåŠ¡è¿›ç¨‹å®ä¾‹å¯èƒ½ä¼šåœ¨åŒä¸€ä¸ªç«¯å£ä¸Šç›‘å¬ï¼Œggï¼ çˆ¶è¿›ç¨‹å¹³æ»‘é€€å‡ºçš„é€»è¾‘ï¼Œå…³é—­listenfdï¼Œç­‰å¾…connfdä¸Šè¯·æ±‚å¤„ç†ç»“æŸï¼Œå…³é—­connfdï¼Œä¸€åˆ‡å¦¥å½“åï¼Œçˆ¶è¿›ç¨‹é€€å‡ºï¼Œå­è¿›ç¨‹æŒ‘å¤§æ¢ï¼  5. å…¶ä»–çº¿ç¨‹æ¨¡å‹ # å…¶ä»–çº¿ç¨‹éƒ½åŸºæœ¬ä¸Šé¿ä¸å¼€ä¸Šè¿°3ã€4çš„å®ç°æˆ–è€…ç»„åˆï¼Œå¯¹åº”é—®é¢˜ç›¸ä»¿ï¼Œä¸å†èµ˜è¿°ã€‚\n6. goå®ç°çƒ­é‡å¯ï¼šè§¦å‘æ—¶æœº # éœ€è¦é€‰æ‹©ä¸€ä¸ªæ—¶æœºæ¥è§¦å‘çƒ­é‡å¯ï¼Œä»€ä¹ˆæ—¶å€™è§¦å‘å‘¢ï¼Ÿæ“ä½œç³»ç»Ÿæä¾›äº†ä¿¡å·æœºåˆ¶ï¼Œå…è®¸è¿›ç¨‹åšå‡ºä¸€äº›è‡ªå®šä¹‰çš„ä¿¡å·å¤„ç†ã€‚\næ€æ­»ä¸€ä¸ªè¿›ç¨‹ï¼Œä¸€èˆ¬ä¼šé€šè¿‡kill -9å‘é€SIGKILLä¿¡å·ç»™è¿›ç¨‹ï¼Œè¿™ä¸ªä¿¡å·ä¸å…è®¸æ•è·ï¼ŒSIGABORTä¹Ÿä¸å…è®¸æ•è·ï¼Œè¿™æ ·å¯ä»¥å…è®¸è¿›ç¨‹æ‰€æœ‰è€…æˆ–è€…é«˜æƒé™ç”¨æˆ·æ§åˆ¶è¿›ç¨‹ç”Ÿæ­»ï¼Œè¾¾åˆ°æ›´å¥½çš„ç®¡ç†æ•ˆæœã€‚\nkillä¹Ÿå¯ä»¥ç”¨æ¥å‘é€å…¶ä»–ä¿¡å·ç»™è¿›ç¨‹ï¼Œå¦‚å‘é€SIGUSR1ã€SIGUSR2ã€SIGINTç­‰ç­‰ï¼Œè¿›ç¨‹ä¸­å¯ä»¥æ¥æ”¶è¿™äº›ä¿¡å·ï¼Œå¹¶é’ˆå¯¹æ€§çš„åšå‡ºå¤„ç†ã€‚è¿™é‡Œå¯ä»¥é€‰æ‹©SIGUSR1æˆ–è€…SIGUSR2æ¥é€šçŸ¥è¿›ç¨‹çƒ­é‡å¯ã€‚\ngo func() { ch := make(chan os.Signal, 1) signal.Notify(ch, os.SIGUSR2) \u0026lt;- ch //æ¥ä¸‹æ¥å°±å¯ä»¥åšçƒ­é‡å¯ç›¸å…³çš„é€»è¾‘äº† ... }()  7. å¦‚ä½•åˆ¤æ–­çƒ­é‡å¯ # é‚£ä¸€ä¸ªgoç¨‹åºé‡æ–°å¯åŠ¨ä¹‹åï¼Œæ‰€æœ‰è¿è¡Œæ—¶çŠ¶æ€ä¿¡æ¯éƒ½æ˜¯æ–°çš„ï¼Œé‚£å¦‚ä½•åŒºåˆ†è‡ªå·±æ˜¯å¦æ˜¯å­è¿›ç¨‹å‘¢ï¼Œæˆ–è€…è¯´æˆ‘æ˜¯å¦è¦æ‰§è¡Œçƒ­é‡å¯é€»è¾‘å‘¢ï¼Ÿçˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡è®¾ç½®å­è¿›ç¨‹åˆå§‹åŒ–æ—¶çš„ç¯å¢ƒå˜é‡ï¼Œæ¯”å¦‚åŠ ä¸ªHOT_RESTART=1ã€‚\nè¿™å°±è¦æ±‚ä»£ç ä¸­åœ¨åˆé€‚çš„åœ°æ–¹è¦å…ˆæ£€æµ‹ç¯å¢ƒå˜é‡HOT_RESTARTæ˜¯å¦ä¸º1ï¼Œå¦‚æœæˆç«‹ï¼Œé‚£å°±æ‰§è¡Œçƒ­é‡å¯é€»è¾‘ï¼Œå¦åˆ™å°±æ‰§è¡Œå…¨æ–°çš„å¯åŠ¨é€»è¾‘ã€‚\n8. ForkExec # å‡å¦‚å½“å‰è¿›ç¨‹æ”¶åˆ°SIGUSR2ä¿¡å·ä¹‹åï¼Œå¸Œæœ›æ‰§è¡Œçƒ­é‡å¯é€»è¾‘ï¼Œé‚£ä¹ˆå¥½ï¼Œéœ€è¦å…ˆæ‰§è¡Œsyscall.ForkExec(\u0026hellip;)æ¥åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ³¨æ„goä¸åŒäºcc++ï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¾èµ–å¤šçº¿ç¨‹æ¥è°ƒåº¦åç¨‹çš„ï¼Œå¤©ç„¶å°±æ˜¯å¤šçº¿ç¨‹ç¨‹åºï¼Œåªä¸è¿‡æ˜¯ä»–æ²¡æœ‰ä½¿ç”¨NPTLçº¿ç¨‹åº“æ¥åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡cloneç³»ç»Ÿè°ƒç”¨æ¥åˆ›å»ºã€‚\nå‰é¢æè¿‡äº†ï¼Œå¦‚æœå•çº¯forkçš„è¯ï¼Œåªèƒ½å¤åˆ¶è°ƒç”¨forkå‡½æ•°çš„çº¿ç¨‹ï¼Œå¯¹äºè¿›ç¨‹ä¸­çš„å…¶ä»–çº¿ç¨‹æ— èƒ½ä¸ºåŠ›ï¼Œæ‰€ä»¥å¯¹äºgoè¿™ç§å¤©ç„¶çš„å¤šçº¿ç¨‹ç¨‹åºï¼Œå¿…é¡»ä»å¤´æ¥ä¸€éï¼Œå†execä¸€ä¸‹ã€‚æ‰€ä»¥goæ ‡å‡†åº“æä¾›çš„å‡½æ•°æ˜¯syscall.ForkExecè€Œä¸æ˜¯syscall.Forkã€‚\n9. goå®ç°çƒ­é‡å¯: ä¼ é€’listenfd # goé‡Œé¢ä¼ é€’fdçš„æ–¹å¼ï¼Œæœ‰è¿™ä¹ˆå‡ ç§ï¼Œçˆ¶è¿›ç¨‹forkå­è¿›ç¨‹çš„æ—¶å€™ä¼ é€’fdï¼Œæˆ–è€…åé¢é€šè¿‡unix domain socketä¼ é€’ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬ä¼ é€’çš„å®é™…ä¸Šæ˜¯file descriptionï¼Œè€Œéfile descriptorã€‚\né™„ä¸Šä¸€å¼ ç±»unixç³»ç»Ÿä¸‹file descriptorã€file descriptionã€inodeä¸‰è€…ä¹‹é—´çš„å…³ç³»å›¾ï¼š\nfdåˆ†é…éƒ½æ˜¯ä»å°åˆ°å¤§åˆ†é…çš„ï¼Œçˆ¶è¿›ç¨‹ä¸­çš„fdä¸º10ï¼Œä¼ é€’åˆ°å­è¿›ç¨‹ä¸­ä¹‹åæœ‰å¯èƒ½å°±ä¸æ˜¯10ã€‚é‚£ä¹ˆä¼ é€’åˆ°å­è¿›ç¨‹çš„fdæ˜¯å¦æ˜¯å¯ä»¥é¢„æµ‹çš„å‘¢ï¼Ÿå¯ä»¥é¢„æµ‹ï¼Œä½†æ˜¯ä¸å»ºè®®ã€‚æ‰€ä»¥æˆ‘æä¾›äº†ä¸¤ç§å®ç°æ–¹å¼ã€‚\n9.1 ForkExec+ProcAttr{Files: []uintptr{}} # è¦ä¼ é€’ä¸€ä¸ªlistenfdå¾ˆç®€å•ï¼Œå‡å¦‚æ˜¯ç±»å‹net.Listenerï¼Œé‚£å°±é€šè¿‡tcpln := ln.(*net.TCPListener); file, _ := tcpln.File(); fd := file.FD() æ¥æ‹¿åˆ°listeneråº•å±‚file descriptionå¯¹åº”çš„fdã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„fdå¹¶éåº•å±‚çš„file descriptionå¯¹åº”çš„åˆå§‹fdï¼Œè€Œæ˜¯è¢«dup2å¤åˆ¶å‡ºæ¥çš„ä¸€ä¸ªfdï¼ˆè°ƒç”¨tcpln.File()çš„æ—¶å€™å°±å·²ç»åˆ†é…äº†ï¼‰ï¼Œè¿™æ ·åº•å±‚file descriptionå¼•ç”¨è®¡æ•°å°±ä¼š+1ã€‚å¦‚æœåé¢æƒ³é€šè¿‡ln.Close()å…³é—­ç›‘å¬å¥—æ¥å­—çš„è¯ï¼Œsorryï¼Œå…³ä¸æ‰ã€‚è¿™é‡Œéœ€è¦æ˜¾ç¤ºçš„æ‰§è¡Œ file.Close() å°†æ–°åˆ›å»ºçš„fdå…³æ‰ï¼Œä½¿å¯¹åº”çš„file descriptionå¼•ç”¨è®¡æ•°-1ï¼Œä¿è¯Closeçš„æ—¶å€™å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ‰å¯ä»¥æ­£å¸¸å…³é—­ã€‚\nè¯•æƒ³ä¸‹ï¼Œæˆ‘ä»¬æƒ³å®ç°çƒ­é‡å¯ï¼Œæ˜¯ä¸€å®šè¦ç­‰è¿æ¥ä¸Šæ¥æ”¶çš„è¯·æ±‚å¤„ç†å®Œæ‰å¯ä»¥é€€å‡ºè¿›ç¨‹çš„ï¼Œä½†æ˜¯è¿™æœŸé—´çˆ¶è¿›ç¨‹ä¸èƒ½å†æ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚ï¼Œå¦‚æœè¿™é‡Œä¸èƒ½æ­£å¸¸å…³é—­listenerï¼Œé‚£æˆ‘ä»¬è¿™ä¸ªç›®æ ‡å°±æ— æ³•å®ç°ã€‚æ‰€ä»¥è¿™é‡Œå¯¹dupå‡ºæ¥çš„fdçš„å¤„ç†è¦æ…é‡äº›ï¼Œä¸è¦é—å¿˜ã€‚\nOKï¼Œæ¥ä¸‹æ¥è¯´ä¸‹syscall.ProcAttr{Files: []uintptr{}}ï¼Œè¿™é‡Œå°±æ˜¯è¦ä¼ é€’çš„çˆ¶è¿›ç¨‹ä¸­çš„fdï¼Œæ¯”å¦‚è¦ä¼ é€’stdinã€stdoutã€stderrç»™å­è¿›ç¨‹ï¼Œå°±éœ€è¦å°†è¿™å‡ ä¸ªå¯¹åº”çš„fdå¡è¿›å»os.Stdin.FD(), os.Stdout.FD(), os.Stderr.FD()ï¼Œå¦‚æœè¦æƒ³ä¼ é€’åˆšæ‰çš„listenfdï¼Œå°±éœ€è¦å°†ä¸Šé¢çš„file.FD()è¿”å›çš„fdå¡è¿›å»ã€‚\nå­è¿›ç¨‹ä¸­æ¥æ”¶åˆ°è¿™äº›fdä¹‹åï¼Œåœ¨ç±»unixç³»ç»Ÿä¸‹ä¸€èˆ¬ä¼šæŒ‰ç…§ä»0ã€1ã€2ã€3è¿™æ ·é€’å¢çš„é¡ºåºæ¥åˆ†é…fdï¼Œé‚£ä¹ˆä¼ é€’è¿‡å»çš„fdæ˜¯å¯ä»¥é¢„æµ‹çš„ï¼Œå‡å¦‚é™¤äº†stdin, stdout, stderrå†ä¼ ä¸¤ä¸ªlistenfdï¼Œé‚£ä¹ˆå¯ä»¥é¢„æµ‹è¿™ä¸¤ä¸ªçš„fdåº”è¯¥æ˜¯3ï¼Œ4ã€‚åœ¨ç±»unixç³»ç»Ÿä¸‹ä¸€èˆ¬éƒ½æ˜¯è¿™ä¹ˆå¤„ç†çš„ï¼Œå­è¿›ç¨‹ä¸­å°±å¯ä»¥æ ¹æ®ä¼ é€’fdçš„æ•°é‡ï¼ˆæ¯”å¦‚é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ç»™å­è¿›ç¨‹FD_NUM=2ï¼‰ï¼Œæ¥ä»3å¼€å§‹è®¡ç®—ï¼Œå“¦ï¼Œè¿™ä¸¤ä¸ªfdåº”è¯¥æ˜¯3ï¼Œ4ã€‚\nçˆ¶å­è¿›ç¨‹å¯ä»¥é€šè¿‡ä¸€ä¸ªçº¦å®šçš„é¡ºåºï¼Œæ¥ç»„ç»‡ä¼ é€’çš„listenfdçš„é¡ºåºï¼Œä»¥æ–¹ä¾¿å­è¿›ç¨‹ä¸­æŒ‰ç›¸åŒçš„çº¦å®šè¿›è¡Œå¤„ç†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡fdé‡å»ºlistenerä¹‹åæ¥åˆ¤æ–­å¯¹åº”çš„ç›‘å¬network+addressï¼Œä»¥åŒºåˆ†è¯¥listenerå¯¹åº”çš„æ˜¯å“ªä¸€ä¸ªé€»è¾‘serviceã€‚éƒ½æ˜¯å¯ä»¥çš„ï¼\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œfile.FD()è¿”å›çš„fdæ˜¯éé˜»å¡çš„ï¼Œä¼šå½±å“åˆ°åº•å±‚çš„file descriptionï¼Œåœ¨é‡å»ºlistenerå…ˆå°†å…¶è®¾ä¸ºnonblock, syscall.SetNonBlock(fd)ï¼Œç„¶åfile, _ := os.NewFile(fd); tcplistener := net.FileListener(file)ï¼Œæˆ–è€…æ˜¯ udpconn := net.PacketConn(file)ï¼Œç„¶åå¯ä»¥è·å–tcplistenerã€udpconnçš„ç›‘å¬åœ°å€ï¼Œæ¥å…³è”å…¶å¯¹åº”çš„é€»è¾‘serviceã€‚\n å‰é¢æåˆ°file.FD()ä¼šå°†åº•å±‚çš„file descriptionè®¾ç½®ä¸ºé˜»å¡æ¨¡å¼ï¼Œè¿™é‡Œå†è¡¥å……ä¸‹ï¼Œnet.FileListener(f), net.PacketConn(f)å†…éƒ¨ä¼šè°ƒç”¨newFileFd()-\u0026gt;dupSocket()ï¼Œè¿™å‡ ä¸ªå‡½æ•°å†…éƒ¨ä¼šå°†fdå¯¹åº”çš„file descriptioné‡æ–°è®¾ç½®ä¸ºéé˜»å¡ã€‚çˆ¶å­è¿›ç¨‹ä¸­å…±äº«äº†listenerå¯¹åº”çš„file descriptionï¼Œæ‰€ä»¥ä¸éœ€è¦æ˜¾ç¤ºè®¾ç½®ä¸ºéé˜»å¡ã€‚\n æœ‰äº›å¾®æœåŠ¡æ¡†æ¶æ˜¯æ”¯æŒå¯¹æœåŠ¡è¿›è¡Œé€»è¾‘serviceåˆ†ç»„çš„ï¼Œgoogle pbè§„èŒƒä¸­ä¹Ÿæ”¯æŒå¤šserviceå®šä¹‰ï¼Œè¿™ä¸ªåœ¨è…¾è®¯çš„goneatã€trpcæ¡†æ¶ä¸­ä¹Ÿæ˜¯æœ‰æ”¯æŒçš„ã€‚\nå½“ç„¶äº†ï¼Œè¿™é‡Œæˆ‘ä¸ä¼šå†™ä¸€ä¸ªå®Œæ•´çš„åŒ…å«ä¸Šè¿°æ‰€æœ‰æè¿°çš„demoç»™å¤§å®¶ï¼Œè¿™æœ‰ç‚¹å ç¯‡å¹…ï¼Œè¿™é‡Œåªè´´ä¸€ä¸ªç²¾ç®€ç‰ˆçš„å®ä¾‹ï¼Œå…¶ä»–çš„è¯»è€…æ„Ÿå…´è¶£å¯ä»¥è‡ªå·±ç¼–ç æµ‹è¯•ã€‚é¡»çŸ¥çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œè¿˜æ˜¯è¦å¤šå®è·µã€‚\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;io/ioutil\u0026quot; \u0026quot;log\u0026quot; \u0026quot;net\u0026quot; \u0026quot;os\u0026quot; \u0026quot;strconv\u0026quot; \u0026quot;sync\u0026quot; \u0026quot;syscall\u0026quot; \u0026quot;time\u0026quot; ) const envRestart = \u0026quot;RESTART\u0026quot; const envListenFD = \u0026quot;LISTENFD\u0026quot; func main() { v := os.Getenv(envRestart) if v != \u0026quot;1\u0026quot; { ln, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;localhost:8888\u0026quot;) if err != nil { panic(err) } wg := sync.WaitGroup{} wg.Add(1) go func() { defer wg.Done() for { ln.Accept() } }() tcpln := ln.(*net.TCPListener) f, err := tcpln.File() if err != nil { panic(err) } os.Setenv(envRestart, \u0026quot;1\u0026quot;) os.Setenv(envListenFD, fmt.Sprintf(\u0026quot;%d\u0026quot;, f.Fd())) _, err = syscall.ForkExec(os.Args[0], os.Args, \u0026amp;syscall.ProcAttr{ Env: os.Environ(), Files: []uintptr{os.Stdin.Fd(), os.Stdout.Fd(), os.Stderr.Fd(), f.Fd()}, Sys: nil, }) if err != nil { panic(err) } log.Print(\u0026quot;parent pid:\u0026quot;, os.Getpid(), \u0026quot;, pass fd:\u0026quot;, f.Fd()) f.Close() wg.Wait() } else { v := os.Getenv(envListenFD) fd, err := strconv.ParseInt(v, 10, 64) if err != nil { panic(err) } log.Print(\u0026quot;child pid:\u0026quot;, os.Getpid(), \u0026quot;, recv fd:\u0026quot;, fd) // case1: ç†è§£ä¸Šé¢æåŠçš„file descriptorã€file descriptionçš„å…³ç³» // è¿™é‡Œå­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹ä¸­ä¼ é€’è¿‡æ¥çš„ä¸€äº›fdï¼Œä½†æ˜¯fdæ•°å€¼ä¸çˆ¶è¿›ç¨‹ä¸­å¯èƒ½æ˜¯ä¸åŒçš„ // // å–æ¶ˆæ³¨é‡Šæ¥æµ‹è¯•... //ff := os.NewFile(uintptr(fd), \u0026quot;\u0026quot;) //if ff != nil { //	_, err := ff.Stat() //	if err != nil { //	log.Println(err) //	} //} // case2: å‡å®šçˆ¶è¿›ç¨‹ä¸­å…±äº«äº†fd 0\\1\\2\\listenfdç»™å­è¿›ç¨‹ï¼Œé‚£å†å­è¿›ç¨‹ä¸­å¯ä»¥é¢„æµ‹åˆ°listenfd=3 ff := os.NewFile(uintptr(3), \u0026quot;\u0026quot;) fmt.Println(\u0026quot;fd:\u0026quot;, ff.Fd()) if ff != nil { _, err := ff.Stat() if err != nil { panic(err) } // è¿™é‡Œpause, è¿è¡Œå‘½ä»¤lsof -P -p $pidï¼Œæ£€æŸ¥ä¸‹æœ‰æ²¡æœ‰listenfdä¼ è¿‡æ¥ï¼Œé™¤äº†0ï¼Œ1ï¼Œ2ï¼Œåº”è¯¥æœ‰çœ‹åˆ°3 // ctrl+d to continue ioutil.ReadAll(os.Stdin) fmt.Println(\u0026quot;....\u0026quot;) _, err = net.FileListener(ff) if err != nil { panic(err) } // è¿™é‡Œpause, è¿è¡Œå‘½ä»¤lsof -P -p $pid, ä¼šå‘ç°æœ‰ä¸¤ä¸ªlistenfd, // å› ä¸ºå‰é¢è°ƒç”¨äº†ff.FD() dup2äº†ä¸€ä¸ªï¼Œå¦‚æœè¿™é‡Œä¸æ˜¾ç¤ºå…³é—­ï¼Œlistenerå°†æ— æ³•å…³é—­ ff.Close() time.Sleep(time.Minute) } time.Sleep(time.Minute) } }  è¿™é‡Œç”¨ç®€å•çš„ä»£ç å¤§è‡´è§£é‡Šäº†å¦‚ä½•ç”¨ProcAttræ¥ä¼ é€’listenfdã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå‡å¦‚åç»­çˆ¶è¿›ç¨‹ä¸­ä¼ é€’çš„fdä¿®æ”¹äº†å‘¢ï¼Œæ¯”å¦‚ä¸ä¼ stdin, stdout, stderrçš„fdäº†ï¼Œæ€ä¹ˆåŠï¼ŸæœåŠ¡ç«¯æ˜¯ä¸æ˜¯è¦å¼€å§‹é¢„æµ‹åº”è¯¥ä»0å¼€å§‹ç¼–å·äº†ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡é€šçŸ¥å­è¿›ç¨‹ï¼Œæ¯”å¦‚ä¼ é€’çš„fdä»å“ªä¸ªç¼–å·å¼€å§‹æ˜¯listenfdï¼Œä¸€å…±æœ‰å‡ ä¸ªlistenfdï¼Œè¿™æ ·ä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚\nè¿™ç§å®ç°æ–¹å¼å¯ä»¥è·¨å¹³å°ã€‚\næ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥çœ‹ä¸‹facebookæä¾›çš„è¿™ä¸ªå®ç°graceã€‚\n9.2 unix domain socket + cmsg # å¦ä¸€ç§ï¼Œæ€è·¯å°±æ˜¯é€šè¿‡unix domain socket + cmsgæ¥ä¼ é€’ï¼Œçˆ¶è¿›ç¨‹å¯åŠ¨çš„æ—¶å€™ä¾ç„¶æ˜¯é€šè¿‡ForkExecæ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œä½†æ˜¯å¹¶ä¸é€šè¿‡ProcAttræ¥ä¼ é€’listenfdã€‚\nçˆ¶è¿›ç¨‹åœ¨åˆ›å»ºå­è¿›ç¨‹ä¹‹å‰ï¼Œåˆ›å»ºä¸€ä¸ªunix domain socketå¹¶ç›‘å¬ï¼Œç­‰å­è¿›ç¨‹å¯åŠ¨ä¹‹åï¼Œå»ºç«‹åˆ°è¿™ä¸ªunix domain socketçš„è¿æ¥ï¼Œçˆ¶è¿›ç¨‹æ­¤æ—¶å¼€å§‹å°†listenfdé€šè¿‡cmsgå‘é€ç»™å­è¿›ç¨‹ï¼Œè·å–fdçš„æ–¹å¼ä¸9.1ç›¸åŒï¼Œè¯¥æ³¨æ„çš„fdå…³é—­é—®é¢˜ä¹Ÿæ˜¯ä¸€æ ·çš„å¤„ç†ã€‚\nå­è¿›ç¨‹è¿æ¥ä¸Šunix domain socketï¼Œå¼€å§‹æ¥æ”¶cmsgï¼Œå†…æ ¸å¸®å­è¿›ç¨‹æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œå‘ç°é‡Œé¢æœ‰ä¸€ä¸ªçˆ¶è¿›ç¨‹çš„fdï¼Œå†…æ ¸æ‰¾åˆ°å¯¹åº”çš„file descriptionï¼Œå¹¶ä¸ºå­è¿›ç¨‹åˆ†é…ä¸€ä¸ªfdï¼Œå°†ä¸¤è€…å»ºç«‹èµ·æ˜ å°„å…³ç³»ã€‚ç„¶åå›åˆ°å­è¿›ç¨‹ä¸­çš„æ—¶å€™ï¼Œå­è¿›ç¨‹æ‹¿åˆ°çš„å°±æ˜¯å¯¹åº”è¯¥file descriptionçš„fdäº†ã€‚é€šè¿‡os.NewFile(fd)å°±å¯ä»¥æ‹¿åˆ°fileï¼Œç„¶åå†é€šè¿‡net.FileListeneræˆ–è€…net.PacketConnå°±å¯ä»¥æ‹¿åˆ°tcplisteneræˆ–è€…udpconnã€‚\nå‰©ä¸‹çš„è·å–ç›‘å¬åœ°å€ï¼Œå…³è”é€»è¾‘serviceçš„åŠ¨ä½œï¼Œå°±ä¸9.1å°ç»“æè¿°çš„ä¸€è‡´äº†ã€‚\nè¿™é‡Œæˆ‘ä¹Ÿæä¾›ä¸€ä¸ªå¯è¿è¡Œçš„ç²¾ç®€ç‰ˆçš„demoï¼Œä¾›å¤§å®¶äº†è§£ã€æµ‹è¯•ç”¨ã€‚\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;io/ioutil\u0026quot; \u0026quot;log\u0026quot; \u0026quot;net\u0026quot; \u0026quot;os\u0026quot; \u0026quot;strconv\u0026quot; \u0026quot;sync\u0026quot; \u0026quot;syscall\u0026quot; \u0026quot;time\u0026quot; passfd \u0026quot;github.com/ftrvxmtrx/fd\u0026quot; ) const envRestart = \u0026quot;RESTART\u0026quot; const envListenFD = \u0026quot;LISTENFD\u0026quot; const unixsockname = \u0026quot;/tmp/xxxxxxxxxxxxxxxxx.sock\u0026quot; func main() { v := os.Getenv(envRestart) if v != \u0026quot;1\u0026quot; { ln, err := net.Listen(\u0026quot;tcp\u0026quot;, \u0026quot;localhost:8888\u0026quot;) if err != nil { panic(err) } wg := sync.WaitGroup{} wg.Add(1) go func() { defer wg.Done() for { ln.Accept() } }() tcpln := ln.(*net.TCPListener) f, err := tcpln.File() if err != nil { panic(err) } os.Setenv(envRestart, \u0026quot;1\u0026quot;) os.Setenv(envListenFD, fmt.Sprintf(\u0026quot;%d\u0026quot;, f.Fd())) _, err = syscall.ForkExec(os.Args[0], os.Args, \u0026amp;syscall.ProcAttr{ Env: os.Environ(), Files: []uintptr{os.Stdin.Fd(), os.Stdout.Fd(), os.Stderr.Fd(), /*f.Fd()*/}, // comment this when test unixsock Sys: nil, }) if err != nil { panic(err) } log.Print(\u0026quot;parent pid:\u0026quot;, os.Getpid(), \u0026quot;, pass fd:\u0026quot;, f.Fd()) os.Remove(unixsockname) unix, err := net.Listen(\u0026quot;unix\u0026quot;, unixsockname) if err != nil { panic(err) } unixconn, err := unix.Accept() if err != nil { panic(err) } err = passfd.Put(unixconn.(*net.UnixConn), f) if err != nil { panic(err) } f.Close() wg.Wait() } else { v := os.Getenv(envListenFD) fd, err := strconv.ParseInt(v, 10, 64) if err != nil { panic(err) } log.Print(\u0026quot;child pid:\u0026quot;, os.Getpid(), \u0026quot;, recv fd:\u0026quot;, fd) // case1: æœ‰äº›åŒå­¦è§‰å¾—å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ä¼ fdï¼Œé€šè¿‡ç¯å¢ƒå˜é‡è‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œfdæ ¹æœ¬ä¸å¯¹åº”å­è¿›ç¨‹ä¸­çš„fd //ff := os.NewFile(uintptr(fd), \u0026quot;\u0026quot;) //if ff != nil { //	_, err := ff.Stat() //	if err != nil { //	log.Println(err) //	} //} // case2: æœ‰äº›åŒå­¦è§‰å¾—å¦‚æœåªæœ‰ä¸€ä¸ªlistenfdçš„æƒ…å†µä¸‹ï¼Œé‚£å¦‚æœforkå­è¿›ç¨‹æ—¶ä¿è¯åªä¼ 0\\1\\2\\listenfdï¼Œé‚£å­è¿›ç¨‹ä¸­listenfdä¸€å®šæ˜¯3 //ff := os.NewFile(uintptr(3), \u0026quot;\u0026quot;) //if ff != nil { //	_, err := ff.Stat() //	if err != nil { //	panic(err) //	} // //	// pause, ctrl+d to continue //	ioutil.ReadAll(os.Stdin) //	fmt.Println(\u0026quot;....\u0026quot;) //	_, err = net.FileListener(ff) //ä¼šdupä¸€ä¸ªfdå‡ºæ¥ï¼Œæœ‰å¤šä¸ªlistener //	if err != nil { //	panic(err) //	} //	// lsof -P -p $pid, ä¼šå‘ç°æœ‰ä¸¤ä¸ªlistenfd //	time.Sleep(time.Minute) //} // è¿™é‡Œæˆ‘ä»¬æš‚åœä¸‹ï¼Œæ–¹ä¾¿è¿è¡Œç³»ç»Ÿå‘½ä»¤æ¥æŸ¥çœ‹è¿›ç¨‹å½“å‰çš„ä¸€äº›çŠ¶æ€ // run: lsof -P -p $pidï¼Œæ£€æŸ¥ä¸‹listenfdæƒ…å†µ ioutil.ReadAll(os.Stdin) fmt.Println(\u0026quot;.....\u0026quot;) unixconn, err := net.Dial(\u0026quot;unix\u0026quot;, unixsockname) if err != nil { panic(err) } files, err := passfd.Get(unixconn.(*net.UnixConn), 1, nil) if err != nil { panic(err) } // è¿™é‡Œå†è¿è¡Œå‘½ä»¤ï¼šlsof -P -p $pidå†æ£€æŸ¥ä¸‹listenfdæƒ…å†µ f := files[0] f.Stat() time.Sleep(time.Minute) } }  è¿™ç§å®ç°æ–¹å¼ï¼Œä»…é™ç±»unixç³»ç»Ÿã€‚\nå¦‚æœæœ‰æœåŠ¡æ··å¸ƒçš„æƒ…å†µå­˜åœ¨ï¼Œéœ€è¦è€ƒè™‘ä¸‹ä½¿ç”¨çš„unix domain socketçš„æ–‡ä»¶åï¼Œé¿å…å› ä¸ºé‡åæ‰€å¼•èµ·çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡â€è¿›ç¨‹å.pidâ€œæ¥ä½œä¸ºunix domain socketçš„åå­—ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡å°†å…¶ä¼ é€’ç»™å­è¿›ç¨‹ã€‚\n10. goå®ç°çƒ­é‡å¯: å­è¿›ç¨‹å¦‚ä½•é€šè¿‡listenfdé‡å»ºlistener # å‰é¢å·²ç»æè¿‡äº†ï¼Œå½“æ‹¿åˆ°fdä¹‹åè¿˜ä¸çŸ¥é“å®ƒå¯¹åº”çš„æ˜¯tcpçš„listenerï¼Œè¿˜æ˜¯udpconnï¼Œé‚£æ€ä¹ˆåŠï¼Ÿéƒ½è¯•ä¸‹å‘—ã€‚\nfile, err := os.NewFile(fd) // check error tcpln, err := net.FileListener(file) // check error udpconn, err := net.PacketConn(file) // check error  11. goå®ç°çƒ­é‡å¯ï¼šçˆ¶è¿›ç¨‹å¹³æ»‘é€€å‡º # çˆ¶è¿›ç¨‹å¦‚ä½•å¹³æ»‘é€€å‡ºå‘¢ï¼Œè¿™ä¸ªè¦çœ‹çˆ¶è¿›ç¨‹ä¸­éƒ½æœ‰å“ªäº›é€»è¾‘è¦å¹³æ»‘åœæ­¢äº†ã€‚\n11.1. å¤„ç†å·²å»ºç«‹è¿æ¥ä¸Šè¯·æ±‚ # å¯ä»¥ä»è¿™ä¸¤ä¸ªæ–¹é¢å…¥æ‰‹ï¼š\n shutdown readï¼Œä¸å†æ¥å—æ–°çš„è¯·æ±‚ï¼Œå¯¹ç«¯ç»§ç»­å†™æ•°æ®çš„æ—¶å€™ä¼šæ„ŸçŸ¥åˆ°å¤±è´¥ï¼› ç»§ç»­å¤„ç†è¿æ¥ä¸Šå·²ç»æ­£å¸¸æ¥æ”¶çš„è¯·æ±‚ï¼Œå¤„ç†å®Œæˆåï¼Œå›åŒ…ï¼Œcloseè¿æ¥ï¼›  ä¹Ÿå¯ä»¥è€ƒè™‘ï¼Œä¸è¿›è¡Œè¯»ç«¯å…³é—­ï¼Œè€Œæ˜¯ç­‰è¿æ¥ç©ºé—²ä¸€æ®µæ—¶é—´åå†closeï¼Œæ˜¯å¦å°½å¿«å…³é—­æ›´ç¬¦åˆè¦æ±‚å°±è¦ç»“åˆåœºæ™¯ã€è¦æ±‚æ¥çœ‹ã€‚\nå¦‚æœå¯¹å¯ç”¨æ€§è¦æ±‚æ¯”è¾ƒè‹›åˆ»ï¼Œå¯èƒ½ä¹Ÿä¼šéœ€è¦è€ƒè™‘å°†connfdã€connfdä¸Šå·²ç»è¯»å–å†™å…¥çš„bufferæ•°æ®ä¹Ÿä¸€å¹¶ä¼ é€’ç»™å­è¿›ç¨‹å¤„ç†ã€‚\n11.2. æ¶ˆæ¯æœåŠ¡ #  ç¡®è®¤ä¸‹è‡ªå·±æœåŠ¡çš„æ¶ˆæ¯æ¶ˆè´¹ã€ç¡®è®¤æœºåˆ¶æ˜¯å¦åˆç† ä¸å†æ”¶æ–°æ¶ˆæ¯ å¤„ç†å®Œå·²æ”¶åˆ°çš„æ¶ˆæ¯åï¼Œå†é€€å‡º  11.3. è‡ªå®šä¹‰AtExitæ¸…ç†ä»»åŠ¡ # æœ‰äº›ä»»åŠ¡ä¼šæœ‰äº›è‡ªå®šä¹‰ä»»åŠ¡ï¼Œå¸Œæœ›è¿›ç¨‹åœ¨é€€å‡ºä¹‹å‰ï¼Œèƒ½å¤Ÿæ‰§è¡Œåˆ°ï¼Œè¿™ç§å¯ä»¥æä¾›ä¸€ä¸ªç±»ä¼¼AtExitçš„æ³¨å†Œå‡½æ•°ï¼Œè®©è¿›ç¨‹é€€å‡ºä¹‹å‰èƒ½å¤Ÿæ‰§è¡Œä¸šåŠ¡è‡ªå®šä¹‰çš„æ¸…ç†é€»è¾‘ã€‚\nä¸ç®¡æ˜¯å¹³æ»‘é‡å¯ï¼Œè¿˜æ˜¯å…¶ä»–æ­£å¸¸é€€å‡ºï¼Œå¯¹è¯¥æ”¯æŒéƒ½æ˜¯æœ‰ä¸€å®šéœ€æ±‚çš„ã€‚\n12. å…¶ä»– # æœ‰äº›åœºæ™¯ä¸‹ä¹Ÿå¸Œæœ›ä¼ é€’connfdï¼ŒåŒ…æ‹¬connfdä¸Šå¯¹åº”çš„è¯»å†™çš„æ•°æ®ã€‚\næ¯”å¦‚è¿æ¥å¤ç”¨çš„åœºæ™¯ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¼šé€šè¿‡åŒä¸€ä¸ªè¿æ¥å‘é€å¤šä¸ªè¯·æ±‚ï¼Œå‡å¦‚åœ¨ä¸­é—´æŸä¸ªæ—¶åˆ»æœåŠ¡ç«¯æ‰§è¡Œçƒ­é‡å¯æ“ä½œï¼ŒæœåŠ¡ç«¯å¦‚æœç›´æ¥è¿æ¥è¯»å…³é—­ä¼šå¯¼è‡´åç»­å®¢æˆ·ç«¯çš„æ•°æ®å‘é€å¤±è´¥ï¼Œå®¢æˆ·ç«¯å…³é—­è¿æ¥åˆ™å¯èƒ½å¯¼è‡´ä¹‹å‰å·²ç»æ¥æ”¶çš„è¯·æ±‚ä¹Ÿæ— æ³•æ­£å¸¸å“åº”ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘æœåŠ¡ç«¯ç»§ç»­å¤„ç†è¿æ¥ä¸Šè¯·æ±‚ï¼Œç­‰è¿æ¥ç©ºé—²å†å…³é—­ã€‚ä¼šä¸ä¼šä¸€ç›´ä¸ç©ºé—²å‘¢ï¼Ÿæœ‰å¯èƒ½ã€‚\nå…¶å®æœåŠ¡ç«¯ä¸èƒ½é¢„æµ‹å®¢æˆ·ç«¯æ˜¯å¦ä¼šé‡‡ç”¨è¿æ¥å¤ç”¨æ¨¡å¼ï¼Œé€‰æ‹©ä¸€ä¸ªæ›´å¯é çš„å¤„ç†æ–¹å¼ä¼šæ›´å¥½äº›ï¼Œå¦‚æœåœºæ™¯è¦æ±‚æ¯”è¾ƒè‹›åˆ»ï¼Œå¹¶ä¸å¸Œæœ›é€šè¿‡ä¸Šå±‚é‡è¯•æ¥è§£å†³çš„è¯ã€‚è¿™ç§å¯ä»¥è€ƒè™‘å°†connfdä»¥åŠconnfdä¸Šè¯»å†™çš„bufferæ•°æ®ä¸€å¹¶ä¼ é€’ç»™å­è¿›ç¨‹ï¼Œäº¤ç”±å­è¿›ç¨‹æ¥å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å…³æ³¨çš„ç‚¹æ›´å¤šï¼Œå¤„ç†èµ·æ¥æ›´å¤æ‚ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒä¸‹mosnçš„å®ç°ã€‚\n13. æ€»ç»“ # çƒ­é‡å¯ä½œä¸ºä¸€ç§ä¿è¯æœåŠ¡å¹³æ»‘é‡å¯ã€å‡çº§çš„å®ç°æ–¹å¼ï¼Œåœ¨ä»Šå¤©çœ‹æ¥ä¾ç„¶éå¸¸æœ‰ä»·å€¼ã€‚æœ¬æ–‡æè¿°äº†å®ç°çƒ­é‡å¯çš„ä¸€äº›å¤§è‡´æ€è·¯ï¼Œå¹¶ä¸”é€šè¿‡demoå¾ªåºæ¸è¿›åœ°æè¿°äº†åœ¨goæœåŠ¡ä¸­å¦‚ä½•äºˆä»¥å®ç°ã€‚è™½ç„¶æ²¡æœ‰æä¾›ä¸€ä¸ªå®Œæ•´çš„çƒ­é‡å¯å®ä¾‹ç»™å¤§å®¶ï¼Œä½†æ˜¯ç›¸ä¿¡å¤§å®¶è¯»å®Œä¹‹ååº”è¯¥å·²ç»å¯ä»¥äº²æ‰‹å®ç°äº†ã€‚\nç”±äºä½œè€…æœ¬äººæ°´å¹³æœ‰é™ï¼Œéš¾å…ä¼šæœ‰æè¿°ç–æ¼ä¹‹å¤„ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£ã€‚\nå‚è€ƒæ–‡ç«  #  Unixé«˜çº§ç¼–ç¨‹ï¼šè¿›ç¨‹é—´é€šä¿¡ï¼ŒW.Richard Stevens mosnå¯åŠ¨æµç¨‹ï¼Œhttps://mosn.io/blog/code/mosn-startup/  "}),a.add({id:244,href:"/tags/unixsock/",title:"unixsock",description:"",content:""}),a.add({id:245,href:"/tags/%E7%83%AD%E9%87%8D%E5%90%AF/",title:"çƒ­é‡å¯",description:"",content:""}),a.add({id:246,href:"/tags/debug/",title:"debug",description:"",content:""}),a.add({id:247,href:"/blog/2020-08-25-delve%E8%B0%83%E8%AF%95%E5%99%A8%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/",title:"delveè°ƒè¯•å™¨è®¾è®¡å®ç°",description:"ç ”ç©¶è°ƒè¯•å™¨è®¾è®¡å®ç°æœ‰æ®µæ—¶é—´äº†ï¼Œå‰å‡ å¤©åœ¨è°ƒè¯•ä¸€ä¸ªç¨‹åºæ—¶ï¼Œå‘ç°goè°ƒè¯•å™¨go-delve/delveç«Ÿç„¶ä¸æ”¯æŒç±»ä¼¼gdbçš„x/FMTæ ¼å¼ï¼Œäºæ˜¯åœ¨ä¹‹å‰å·¥ä½œä¸Šåˆä¼˜åŒ–äº†ä¸€ä¸‹ã€‚CRæœŸé—´ï¼Œä¹Ÿå­¦ä¹ åˆ°ä¸€äº›ä¹‹å‰ç†è§£ä¸æ·±çš„åœ°æ–¹ï¼Œä¹Ÿé¡ºä¾¿äº†è§£äº†ä¸‹delveçš„æ•´ä½“æ¶æ„è®¾è®¡ã€å¤§è‡´å®ç°ï¼Œä»Šå¤©å°±æ¥è¯´é“è¯´é“ã€‚\ndelveç®€ä»‹ # go-delve/delveæ˜¯Derekparkerå‘èµ·çš„ä¸€ä¸ªè°ƒè¯•å™¨é¡¹ç›®ï¼Œé¢å‘goè¯­è¨€çš„ã€‚ä¸ºä»€ä¹ˆé’ˆå¯¹goè¯­è¨€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è°ƒè¯•å™¨å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ä½¿ç”¨GDBå‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°goçš„ä¸€äº›ç‰¹æ€§ã€‚\nä½œä¸ºç¬¦å·çº§è°ƒè¯•å™¨ï¼Œè¦èƒ½æ­£å¸¸å®ç°æºç çº§è°ƒè¯•ï¼Œæœ‰è¿™ä¹ˆå‡ ä¸ªäº‹æƒ…å¿…é¡»è¦åšçš„ï¼š\n é¦–å…ˆï¼Œå°±å¿…é¡»è¦æœ‰è°ƒè¯•ä¿¡æ¯çš„æ”¯æŒï¼Œæ¯”å¦‚ç¼–è¯‘å™¨ã€è¿æ¥å™¨åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ’å…¥DWARFç›¸å…³çš„sectionsï¼Œä»¥ä¾›åç»­è°ƒè¯•å™¨æå–ã€è§£æä»¥é‡å»ºæŒ‡ä»¤ã€åœ°å€ä¸æºç çš„æ˜ å°„å…³ç³»ï¼Œè¿˜æœ‰åœ¨æ´»åŠ¨è®°å½•ä¸­è·³è½¬ç­‰ç­‰ã€‚ æ­¤å¤–ï¼Œæœ‰äº†è°ƒè¯•ä¿¡æ¯ï¼Œè¿˜éœ€è¦ç†è§£è¯­è¨€å†…éƒ¨å®ç°ï¼Œæ¯”å¦‚goçš„ç±»å‹ç³»ç»Ÿã€åç¨‹ã€è¿è¡Œæ—¶ï¼Œè¿™æ ·ä½ æ‰èƒ½è¯»å†™æºç çº§çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼› è¿˜æ²¡å®Œï¼Œä½ è¿˜éœ€è¦ä¸€äº›å¹³å°çº§å®ç°ç›¸å…³çš„ç©æ„ï¼Œä¸åŒçš„è¯­è¨€åœ¨ä¸åŒçš„å¹³å°ä¸Šæœ‰ä¸åŒçš„å®ç°ï¼Œè°ƒè¯•å™¨è¦ç†è§£è¿™äº›å·®å¼‚å¹¶åšé’ˆå¯¹æ€§å¤„ç†ï¼›  è¿™äº›å·¥ä½œï¼Œåœ¨GDBé‡Œæ‰©å±•æ’ä»¶æ¥å®ç°ï¼Œä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°å®ç°çš„ï¼Œæ¯”å¦‚GDBæ”¯æŒçš„DWARFæ ‡å‡†ç‰ˆæœ¬é—®é¢˜ï¼Œå’Œgoç¼–è¯‘å™¨æ²¡æœ‰å¯¹é½ä¹‹ç±»çš„ï¼Œæ¯”å¦‚GDBé‡Œé¢Targetå±‚ï¼ˆå¯¹traceeï¼‰æ§åˆ¶å±‚è€ƒè™‘çš„å¤§å¤šæ˜¯è¿›ç¨‹ã€çº¿ç¨‹çº§åˆ«çš„ï¼Œæ²¡æœ‰å¯¹goroutineç±»ä¼¼çš„æ§åˆ¶èƒ½åŠ›ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚\nAnywayï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ¬¾æ›´ç†è§£goçš„è°ƒè¯•å™¨ï¼Œdelveå°±è¿™ä¹ˆè¯ç”Ÿäº†ã€‚ç°åœ¨å¤§å·²ç»æ˜¯goå®˜æ–¹æ¨èçš„è°ƒè¯•å™¨äº†ï¼Œä¹Ÿæ˜¯GoLandã€VSCodeã€vim-goä¸­ä½¿ç”¨çš„è°ƒè¯•å™¨ã€‚èƒ½æœ‰å¹¸äº†è§£ä¸€æ¬¾è°ƒè¯•å™¨çš„å®ç°ã€å‚ä¸è´¡çŒ®è¿˜æ˜¯å¾ˆçˆ½çš„ä¸€ä»¶äº‹æƒ…ã€‚\ndelveæ•´ä½“æ¶æ„ # delveå¤§è‡´å®ç° # ",content:"ç ”ç©¶è°ƒè¯•å™¨è®¾è®¡å®ç°æœ‰æ®µæ—¶é—´äº†ï¼Œå‰å‡ å¤©åœ¨è°ƒè¯•ä¸€ä¸ªç¨‹åºæ—¶ï¼Œå‘ç°goè°ƒè¯•å™¨go-delve/delveç«Ÿç„¶ä¸æ”¯æŒç±»ä¼¼gdbçš„x/FMTæ ¼å¼ï¼Œäºæ˜¯åœ¨ä¹‹å‰å·¥ä½œä¸Šåˆä¼˜åŒ–äº†ä¸€ä¸‹ã€‚CRæœŸé—´ï¼Œä¹Ÿå­¦ä¹ åˆ°ä¸€äº›ä¹‹å‰ç†è§£ä¸æ·±çš„åœ°æ–¹ï¼Œä¹Ÿé¡ºä¾¿äº†è§£äº†ä¸‹delveçš„æ•´ä½“æ¶æ„è®¾è®¡ã€å¤§è‡´å®ç°ï¼Œä»Šå¤©å°±æ¥è¯´é“è¯´é“ã€‚\ndelveç®€ä»‹ # go-delve/delveæ˜¯Derekparkerå‘èµ·çš„ä¸€ä¸ªè°ƒè¯•å™¨é¡¹ç›®ï¼Œé¢å‘goè¯­è¨€çš„ã€‚ä¸ºä»€ä¹ˆé’ˆå¯¹goè¯­è¨€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„è°ƒè¯•å™¨å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ä½¿ç”¨GDBå‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°goçš„ä¸€äº›ç‰¹æ€§ã€‚\nä½œä¸ºç¬¦å·çº§è°ƒè¯•å™¨ï¼Œè¦èƒ½æ­£å¸¸å®ç°æºç çº§è°ƒè¯•ï¼Œæœ‰è¿™ä¹ˆå‡ ä¸ªäº‹æƒ…å¿…é¡»è¦åšçš„ï¼š\n é¦–å…ˆï¼Œå°±å¿…é¡»è¦æœ‰è°ƒè¯•ä¿¡æ¯çš„æ”¯æŒï¼Œæ¯”å¦‚ç¼–è¯‘å™¨ã€è¿æ¥å™¨åœ¨æ„å»ºè¿‡ç¨‹ä¸­æ’å…¥DWARFç›¸å…³çš„sectionsï¼Œä»¥ä¾›åç»­è°ƒè¯•å™¨æå–ã€è§£æä»¥é‡å»ºæŒ‡ä»¤ã€åœ°å€ä¸æºç çš„æ˜ å°„å…³ç³»ï¼Œè¿˜æœ‰åœ¨æ´»åŠ¨è®°å½•ä¸­è·³è½¬ç­‰ç­‰ã€‚ æ­¤å¤–ï¼Œæœ‰äº†è°ƒè¯•ä¿¡æ¯ï¼Œè¿˜éœ€è¦ç†è§£è¯­è¨€å†…éƒ¨å®ç°ï¼Œæ¯”å¦‚goçš„ç±»å‹ç³»ç»Ÿã€åç¨‹ã€è¿è¡Œæ—¶ï¼Œè¿™æ ·ä½ æ‰èƒ½è¯»å†™æºç çº§çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯ï¼› è¿˜æ²¡å®Œï¼Œä½ è¿˜éœ€è¦ä¸€äº›å¹³å°çº§å®ç°ç›¸å…³çš„ç©æ„ï¼Œä¸åŒçš„è¯­è¨€åœ¨ä¸åŒçš„å¹³å°ä¸Šæœ‰ä¸åŒçš„å®ç°ï¼Œè°ƒè¯•å™¨è¦ç†è§£è¿™äº›å·®å¼‚å¹¶åšé’ˆå¯¹æ€§å¤„ç†ï¼›  è¿™äº›å·¥ä½œï¼Œåœ¨GDBé‡Œæ‰©å±•æ’ä»¶æ¥å®ç°ï¼Œä¸ä¸€å®šèƒ½å¾ˆå¥½åœ°å®ç°çš„ï¼Œæ¯”å¦‚GDBæ”¯æŒçš„DWARFæ ‡å‡†ç‰ˆæœ¬é—®é¢˜ï¼Œå’Œgoç¼–è¯‘å™¨æ²¡æœ‰å¯¹é½ä¹‹ç±»çš„ï¼Œæ¯”å¦‚GDBé‡Œé¢Targetå±‚ï¼ˆå¯¹traceeï¼‰æ§åˆ¶å±‚è€ƒè™‘çš„å¤§å¤šæ˜¯è¿›ç¨‹ã€çº¿ç¨‹çº§åˆ«çš„ï¼Œæ²¡æœ‰å¯¹goroutineç±»ä¼¼çš„æ§åˆ¶èƒ½åŠ›ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚\nAnywayï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ¬¾æ›´ç†è§£goçš„è°ƒè¯•å™¨ï¼Œdelveå°±è¿™ä¹ˆè¯ç”Ÿäº†ã€‚ç°åœ¨å¤§å·²ç»æ˜¯goå®˜æ–¹æ¨èçš„è°ƒè¯•å™¨äº†ï¼Œä¹Ÿæ˜¯GoLandã€VSCodeã€vim-goä¸­ä½¿ç”¨çš„è°ƒè¯•å™¨ã€‚èƒ½æœ‰å¹¸äº†è§£ä¸€æ¬¾è°ƒè¯•å™¨çš„å®ç°ã€å‚ä¸è´¡çŒ®è¿˜æ˜¯å¾ˆçˆ½çš„ä¸€ä»¶äº‹æƒ…ã€‚\ndelveæ•´ä½“æ¶æ„ # delveå¤§è‡´å®ç° # "}),a.add({id:248,href:"/tags/jsonrpc/",title:"jsonrpc",description:"",content:""}),a.add({id:249,href:"/tags/starlark/",title:"starlark",description:"",content:""}),a.add({id:250,href:"/tags/mock/",title:"mock",description:"",content:""}),a.add({id:251,href:"/blog/2020-08-23-monkey_patching_in_go/",title:"Monkey Patching in Go",description:"å‰å‡ å¤©å†™äº†ç¯‡x64æ±‡ç¼–å¼€å‘ä»‹ç»çš„æ–‡ç« ï¼Œå½“æ—¶æœ‰æåˆ°æ¥ä¸‹æ¥ä¼šä»‹ç»ä¸‹goä¸­å¦‚ä½•å®ç°monkey patchingï¼Œå—¯ï¼Œä»Šå¤©å°±æ¥è¯´ä¸‹è¿™ä¸ªäº‹æƒ…ã€‚\nMonkey Patching ç®€ä»‹ # monkey patchingï¼Œä¸€è¯´åˆ°è¿™ä¸ªï¼Œå¾ˆå¤šç†Ÿæ‚‰goçš„åŒå­¦å¯èƒ½ä¼šè”æƒ³èµ·gomonkeyè¿™ä¸ªmockæµ‹è¯•æ¡†æ¶ã€‚è¯¥æœ¯è¯­çš„å®šä¹‰å–å†³äºä½¿ç”¨å®ƒçš„ç¤¾åŒºã€‚åœ¨Rubyï¼ŒPython å’Œè®¸å¤šå…¶ä»–åŠ¨æ€ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œâ€œmonkey patchingâ€ä¸€è¯ä»…æŒ‡åœ¨è¿è¡Œæ—¶å¯¹ç±»æˆ–æ¨¡å—çš„åŠ¨æ€ä¿®æ”¹ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ä¿®è¡¥ç°æœ‰çš„ç¬¬ä¸‰æ–¹ä»£ç ï¼Œä»¥æ­¤ä½œä¸ºè§£å†³æ–¹æ³•ã€‚é”™è¯¯æˆ–åŠŸèƒ½æ— æ³•æ­£å¸¸è¿è¡Œã€‚æ ¹æ®å…¶ä¸åŒçš„æ„å›¾ï¼Œåœ¨è¿è¡Œæ—¶ä¿®æ”¹ç±»çš„å…¶ä»–å½¢å¼ä¹Ÿå…·æœ‰ä¸åŒçš„åç§°ã€‚ä¾‹å¦‚ï¼Œåœ¨Zopeå’ŒPloneä¸­ï¼Œå®‰å…¨è¡¥ä¸é€šå¸¸æ˜¯ä½¿ç”¨åŠ¨æ€ç±»ä¿®æ”¹æ¥æä¾›çš„ï¼Œä½†å®ƒä»¬è¢«ç§°ä¸ºçƒ­ä¿®è¡¥ç¨‹åº(hot fixes)ã€‚\nmonkey pathcingï¼Œå®ƒå¸¸ç”¨è¯­å¦‚ä¸‹åœºæ™¯ï¼š\n åœ¨è¿è¡Œæ—¶æ›¿æ¢æ–¹æ³•/ç±»/å±æ€§/å‡½æ•°ï¼Œä¾‹å¦‚åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å–æ¶ˆåŠŸèƒ½ï¼› ä¿®æ”¹/æ‰©å±•ç¬¬ä¸‰æ–¹äº§å“çš„è¡Œä¸ºï¼Œè€Œæ— éœ€ç»´æŠ¤æºä»£ç çš„ç§æœ‰å‰¯æœ¬ï¼› åœ¨è¿è¡Œæ—¶å°†è¡¥ä¸ç¨‹åºçš„ç»“æœåº”ç”¨äºå†…å­˜ä¸­çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç£ç›˜ä¸Šçš„æºä»£ç ï¼› åˆ†å‘ä¸åŸå§‹æºä»£ç ä¸€èµ·å­˜åœ¨çš„å®‰å…¨æ€§æˆ–è¡Œä¸ºä¿®å¤ç¨‹åºï¼ˆä¾‹å¦‚ï¼Œå°†å…¶ä½œä¸ºRuby on Railså¹³å°çš„æ’ä»¶åˆ†å‘ï¼‰ï¼› æ¢ç´¢å„ç§è‡ªåŠ¨ä¿®å¤ç¨‹åºä»¥æä¾›è‡ªæˆ‘ä¿®å¤ã€‚  Monkey Patching in Go # æœ€è¿‘åœ¨å†™mockæµ‹è¯•çš„æ—¶å€™ï¼Œæœ‰äº›åœºæ™¯ä¸‹ç”¨åˆ°äº†gomonkeyï¼Œè¿™ä¸ªæµ‹è¯•æ¡†æ¶æŒºå¥½ç”¨çš„ï¼Œä¹‹å‰ä¹Ÿç®€å•äº†è§£è¿‡å¤§è‡´çš„å®ç°ï¼Œæœ€è¿‘ä¹Ÿåœ¨çœ‹äº›åº•å±‚å·¥å…·é“¾ç›¸å…³çš„ä¸œè¥¿ï¼Œå°±æƒ³æ•´ç†ä¸‹è¿™æ–¹é¢çš„ä¸€ç‚¹ä¸œè¥¿ã€‚ä¹Ÿå¸Œæœ›èƒ½å¸®åŠ©åˆ°æƒ³äº†è§£è¿™æ–¹é¢å†…å®¹çš„åŒå­¦ã€‚\né‚£ç°åœ¨å°±å°±å¼€å§‹å§ï¼Œé¦–å…ˆæˆ‘ä¼šç®€å•ä»‹ç»ä¸‹goå‡½æ•°çš„å®ç°ã€æŒ‡ä»¤patchingçš„æ¦‚å¿µï¼Œç„¶åçœ‹ä¸‹åæ±‡ç¼–ã€æŒ‡ä»¤çº§è°ƒè¯•å¦‚ä½•å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜ï¼Œç„¶åé€šè¿‡å‡ ä¸ªç®€å•çš„demoæ¥æ¼”ç¤ºä¸‹å¦‚ä½•å®ç°æŒ‡ä»¤patchï¼Œç„¶åæˆ‘ä»¬å†å›åˆ°goå®ç°monkey patchingã€‚\n æ€ä¹ˆè¯´å‘¢ï¼Œå¦‚æœä¸æ„Ÿå…´è¶£å°±çœŸçš„ä¸è¦çœ‹äº†ï¼Œå°±å¥½åƒåˆ«äººéª‘è½¦æ‘”ç ´å¤´ä¹Ÿè§‰å¾—å¾ˆçˆ½ï¼Œä½†æ˜¯ä½ è§‰å¾—éª‘è½¦æ²¡ä»€ä¹ˆå¥½ç©çš„ï¼Œä¸€ä¸ªé“ç†ã€‚\n Goå‡½æ•°è¡¨ç¤º # demo1 # ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å‡½æ•°a()ï¼Œç„¶åå†mainå‡½æ•°ä¸­è°ƒç”¨å®ƒï¼Œç„¶åè°ƒç”¨é€šè¿‡printæ‰“å°å‡ºå®ƒçš„è¿”å›å€¼ã€‚\nfile: main.go\npackage main func a() int { return 1 } func main() { print(a()) }  è¿™ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼Œmonkey patchingç¦»ä¸å¼€æ±‡ç¼–ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ä¸‹å…¶å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œäº†è§£è¿™ä¸ªç¨‹åºå¹²äº†äº›å•¥ã€‚\nè¿™é‡Œé¡ºä¾¿æ¨èå‡ ä¸ªå·¥å…·:\n dlvï¼Œé€‚ç”¨äºgoçš„è°ƒè¯•å™¨ radare2ï¼Œé™æ€åˆ†æå·¥å…·ï¼Œç±»ä¼¼çš„IDAã€Hopper  æˆ‘è¿™é‡Œå°±å…ˆè¯•ç”¨radare2ï¼ˆä¸‹æ–‡ç®€ç§°r2ï¼‰æ¥æ¼”ç¤ºå¦‚ä½•æ“ä½œäº†ã€‚\n$ go build -gcflags=\u0026quot;all=-N -l\u0026quot; -o main main.",content:"å‰å‡ å¤©å†™äº†ç¯‡x64æ±‡ç¼–å¼€å‘ä»‹ç»çš„æ–‡ç« ï¼Œå½“æ—¶æœ‰æåˆ°æ¥ä¸‹æ¥ä¼šä»‹ç»ä¸‹goä¸­å¦‚ä½•å®ç°monkey patchingï¼Œå—¯ï¼Œä»Šå¤©å°±æ¥è¯´ä¸‹è¿™ä¸ªäº‹æƒ…ã€‚\nMonkey Patching ç®€ä»‹ # monkey patchingï¼Œä¸€è¯´åˆ°è¿™ä¸ªï¼Œå¾ˆå¤šç†Ÿæ‚‰goçš„åŒå­¦å¯èƒ½ä¼šè”æƒ³èµ·gomonkeyè¿™ä¸ªmockæµ‹è¯•æ¡†æ¶ã€‚è¯¥æœ¯è¯­çš„å®šä¹‰å–å†³äºä½¿ç”¨å®ƒçš„ç¤¾åŒºã€‚åœ¨Rubyï¼ŒPython å’Œè®¸å¤šå…¶ä»–åŠ¨æ€ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œâ€œmonkey patchingâ€ä¸€è¯ä»…æŒ‡åœ¨è¿è¡Œæ—¶å¯¹ç±»æˆ–æ¨¡å—çš„åŠ¨æ€ä¿®æ”¹ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†ä¿®è¡¥ç°æœ‰çš„ç¬¬ä¸‰æ–¹ä»£ç ï¼Œä»¥æ­¤ä½œä¸ºè§£å†³æ–¹æ³•ã€‚é”™è¯¯æˆ–åŠŸèƒ½æ— æ³•æ­£å¸¸è¿è¡Œã€‚æ ¹æ®å…¶ä¸åŒçš„æ„å›¾ï¼Œåœ¨è¿è¡Œæ—¶ä¿®æ”¹ç±»çš„å…¶ä»–å½¢å¼ä¹Ÿå…·æœ‰ä¸åŒçš„åç§°ã€‚ä¾‹å¦‚ï¼Œåœ¨Zopeå’ŒPloneä¸­ï¼Œå®‰å…¨è¡¥ä¸é€šå¸¸æ˜¯ä½¿ç”¨åŠ¨æ€ç±»ä¿®æ”¹æ¥æä¾›çš„ï¼Œä½†å®ƒä»¬è¢«ç§°ä¸ºçƒ­ä¿®è¡¥ç¨‹åº(hot fixes)ã€‚\nmonkey pathcingï¼Œå®ƒå¸¸ç”¨è¯­å¦‚ä¸‹åœºæ™¯ï¼š\n åœ¨è¿è¡Œæ—¶æ›¿æ¢æ–¹æ³•/ç±»/å±æ€§/å‡½æ•°ï¼Œä¾‹å¦‚åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å–æ¶ˆåŠŸèƒ½ï¼› ä¿®æ”¹/æ‰©å±•ç¬¬ä¸‰æ–¹äº§å“çš„è¡Œä¸ºï¼Œè€Œæ— éœ€ç»´æŠ¤æºä»£ç çš„ç§æœ‰å‰¯æœ¬ï¼› åœ¨è¿è¡Œæ—¶å°†è¡¥ä¸ç¨‹åºçš„ç»“æœåº”ç”¨äºå†…å­˜ä¸­çš„çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç£ç›˜ä¸Šçš„æºä»£ç ï¼› åˆ†å‘ä¸åŸå§‹æºä»£ç ä¸€èµ·å­˜åœ¨çš„å®‰å…¨æ€§æˆ–è¡Œä¸ºä¿®å¤ç¨‹åºï¼ˆä¾‹å¦‚ï¼Œå°†å…¶ä½œä¸ºRuby on Railså¹³å°çš„æ’ä»¶åˆ†å‘ï¼‰ï¼› æ¢ç´¢å„ç§è‡ªåŠ¨ä¿®å¤ç¨‹åºä»¥æä¾›è‡ªæˆ‘ä¿®å¤ã€‚  Monkey Patching in Go # æœ€è¿‘åœ¨å†™mockæµ‹è¯•çš„æ—¶å€™ï¼Œæœ‰äº›åœºæ™¯ä¸‹ç”¨åˆ°äº†gomonkeyï¼Œè¿™ä¸ªæµ‹è¯•æ¡†æ¶æŒºå¥½ç”¨çš„ï¼Œä¹‹å‰ä¹Ÿç®€å•äº†è§£è¿‡å¤§è‡´çš„å®ç°ï¼Œæœ€è¿‘ä¹Ÿåœ¨çœ‹äº›åº•å±‚å·¥å…·é“¾ç›¸å…³çš„ä¸œè¥¿ï¼Œå°±æƒ³æ•´ç†ä¸‹è¿™æ–¹é¢çš„ä¸€ç‚¹ä¸œè¥¿ã€‚ä¹Ÿå¸Œæœ›èƒ½å¸®åŠ©åˆ°æƒ³äº†è§£è¿™æ–¹é¢å†…å®¹çš„åŒå­¦ã€‚\né‚£ç°åœ¨å°±å°±å¼€å§‹å§ï¼Œé¦–å…ˆæˆ‘ä¼šç®€å•ä»‹ç»ä¸‹goå‡½æ•°çš„å®ç°ã€æŒ‡ä»¤patchingçš„æ¦‚å¿µï¼Œç„¶åçœ‹ä¸‹åæ±‡ç¼–ã€æŒ‡ä»¤çº§è°ƒè¯•å¦‚ä½•å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜ï¼Œç„¶åé€šè¿‡å‡ ä¸ªç®€å•çš„demoæ¥æ¼”ç¤ºä¸‹å¦‚ä½•å®ç°æŒ‡ä»¤patchï¼Œç„¶åæˆ‘ä»¬å†å›åˆ°goå®ç°monkey patchingã€‚\n æ€ä¹ˆè¯´å‘¢ï¼Œå¦‚æœä¸æ„Ÿå…´è¶£å°±çœŸçš„ä¸è¦çœ‹äº†ï¼Œå°±å¥½åƒåˆ«äººéª‘è½¦æ‘”ç ´å¤´ä¹Ÿè§‰å¾—å¾ˆçˆ½ï¼Œä½†æ˜¯ä½ è§‰å¾—éª‘è½¦æ²¡ä»€ä¹ˆå¥½ç©çš„ï¼Œä¸€ä¸ªé“ç†ã€‚\n Goå‡½æ•°è¡¨ç¤º # demo1 # ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªç®€å•çš„å‡½æ•°a()ï¼Œç„¶åå†mainå‡½æ•°ä¸­è°ƒç”¨å®ƒï¼Œç„¶åè°ƒç”¨é€šè¿‡printæ‰“å°å‡ºå®ƒçš„è¿”å›å€¼ã€‚\nfile: main.go\npackage main func a() int { return 1 } func main() { print(a()) }  è¿™ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼Œmonkey patchingç¦»ä¸å¼€æ±‡ç¼–ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ä¸‹å…¶å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼Œäº†è§£è¿™ä¸ªç¨‹åºå¹²äº†äº›å•¥ã€‚\nè¿™é‡Œé¡ºä¾¿æ¨èå‡ ä¸ªå·¥å…·:\n dlvï¼Œé€‚ç”¨äºgoçš„è°ƒè¯•å™¨ radare2ï¼Œé™æ€åˆ†æå·¥å…·ï¼Œç±»ä¼¼çš„IDAã€Hopper  æˆ‘è¿™é‡Œå°±å…ˆè¯•ç”¨radare2ï¼ˆä¸‹æ–‡ç®€ç§°r2ï¼‰æ¥æ¼”ç¤ºå¦‚ä½•æ“ä½œäº†ã€‚\n$ go build -gcflags=\u0026quot;all=-N -l\u0026quot; -o main main.go $ r2 ./main -- give | and \u0026gt; a try piping and redirection [0x00454330]\u0026gt; s sym.main.main [0x00459270]\u0026gt; af [0x00459270]\u0026gt; pdf ; CODE XREF from sym.main.main @ 0x4592c2 â”Œ 84: sym.main.main (); â”‚ ; var int64_t var_10h @ rsp+0x8 â”‚ ; var int64_t var_8h @ rsp+0x10 â”‚ â”Œâ”€\u0026gt; 0x00459270 64488b0c25f8. mov rcx, qword fs:[0xfffffffffffffff8] ;; è¿™é‡Œæ˜¯goå‡½æ•°æ ˆæ£€æŸ¥ â”‚ â• 0x00459279 483b6110 cmp rsp, qword [rcx + 0x10] â”‚ â”Œâ”€â”€\u0026lt; 0x0045927d 763e jbe 0x4592bd â”‚ â”‚â• 0x0045927f 4883ec18 sub rsp, 0x18 ;; æ ˆæ²¡é—®é¢˜å¼€å§‹æ‰§è¡Œ â”‚ â”‚â• 0x00459283 48896c2410 mov qword [var_8h], rbp â”‚ â”‚â• 0x00459288 488d6c2410 lea rbp, qword [var_8h] â”‚ â”‚â• 0x0045928d e8beffffff call sym.main.a ;; è°ƒç”¨å‡½æ•°sym.main.a â”‚ â”‚â• 0x00459292 488b0424 mov rax, qword [rsp] â”‚ â”‚â• 0x00459296 4889442408 mov qword [var_10h], rax â”‚ â”‚â• 0x0045929b e83003fdff call sym.runtime.printlock â”‚ â”‚â• 0x004592a0 488b442408 mov rax, qword [var_10h] â”‚ â”‚â• 0x004592a5 48890424 mov qword [rsp], rax â”‚ â”‚â• 0x004592a9 e8a20afdff call sym.runtime.printint â”‚ â”‚â• 0x004592ae e89d03fdff call sym.runtime.printunlock â”‚ â”‚â• 0x004592b3 488b6c2410 mov rbp, qword [var_8h] â”‚ â”‚â• 0x004592b8 4883c418 add rsp, 0x18 â”‚ â”‚â• 0x004592bc c3 ret â”‚ â””â”€â”€\u0026gt; 0x004592bd e83e7affff call sym.runtime.morestack_noctxt â”” â””â”€\u0026lt; 0x004592c2 ebac jmp sym.main.main [0x00459270]\u0026gt; s sym.main.a ;; æŸ¥çœ‹sym.main.aåœ°å€ä¸º0x00459250 [0x00459250]\u0026gt;  å‡½æ•°mainä¸­è°ƒç”¨å‡½æ•°açš„è¿‡ç¨‹å°±è¿™ä¹ˆç®€å•call sym.main.aï¼Œä¹Ÿå°±æ˜¯call 0x00459250ï¼Œå†çœ‹ä¸‹aè¿™ä¸ªå‡½æ•°ï¼Œå®ƒå¾ˆç®€å•å°†è¿”å›å€¼1å­˜å‚¨åˆ°[arg_8h]ä¸­ï¼Œå°±æ˜¯å‰ä¸€ä¸ªæ ˆå¸§ä¸­çš„ä¸€ä¸ª8å­—èŠ‚ç©ºé—´ï¼Œä¹‹åçš„æˆ‘ä»¬å°±å…ˆä¸å…³å¿ƒäº†ã€‚\n[0x00459250]\u0026gt; af [0x00459250]\u0026gt; pdf ; CALL XREF from sym.main.main @ 0x45928d â”Œ 19: sym.main.a (int64_t arg_8h); â”‚ ; arg int64_t arg_8h @ rsp+0x8 â”‚ 0x00459250 48c744240800. mov qword [arg_8h], 0 â”‚ 0x00459259 48c744240801. mov qword [arg_8h], 1 â”” 0x00459262 c3 ret  demo2 # çœ‹å®Œä¸Šé¢è¿™ä¸ªï¼Œæˆ‘ä»¬çœ‹ç‚¹è·Ÿmonkey patchingç›¸å…³çš„ä¸€ä¸ªdemoã€‚\nè¿™ä¸ªdemoä¹Ÿå¾ˆç®€å•ï¼Œå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°aï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªå˜é‡bï¼Œå°†aèµ‹å€¼ç»™bã€‚æœ‰è¿‡cc++åŸºç¡€çš„åŒå­¦ï¼Œä¼šè‡ªç„¶è”æƒ³åˆ°å‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä¹Ÿæ˜¯å†™cc++è¿‡æ¥çš„ï¼Œæ‰€ä»¥å¾ˆè‡ªç„¶ä¼šæƒ³åˆ°ï¼Œfæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå®ƒæŒ‡å‘aè¿™ä¸ªå‡½æ•°ã€‚ä¸‹é¢çš„æ‰“å°è¯­å¥å‘¢ï¼Œå®ƒåº”è¯¥æ‰“å°å‡ºå‡½æ•°açš„åœ°å€ã€‚\nfile: main2.go\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;unsafe\u0026quot; ) func a() int { return 1 } func main() { f := a fmt.Printf(\u0026quot;%p\\n\u0026quot;, a) fmt.Printf(\u0026quot;0x%x\\n\u0026quot;, *(*uintptr)(unsafe.Pointer(\u0026amp;f))) }  æµ‹è¯•ä¸‹çœ‹ä¸‹ç»“æœï¼š\n$ go build -gcflags=\u0026quot;all=-N -l\u0026quot; -o main2 main2.go $ ./main2 0x4abf20 0x4ecc28  å‘ç°è¿™ä¸¤ä¸ªåœ°å€å¹¶ä¸ç›¸åŒï¼Œè¯´æ˜ä»€ä¹ˆï¼Œè¯´æ˜æˆ‘ä»¬å¯¹goå‡½æ•°å€¼çš„ç†è§£æœ‰åå·®ï¼Œè‡³å°‘å¯ä»¥ç¡®å®šçš„æ˜¯å®ƒä¸æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚è¦æƒ³ç†è§£goçš„å‡½æ•°å€¼è¡¨ç¤ºï¼Œå¯ä»¥å‚è€ƒfuncvalè¡¨ç¤ºã€‚\né‚£è¿™ä¹ˆçœ‹åº”è¯¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„æŒ‡é’ˆï¼ŒéªŒè¯ä¸€ä¸‹ï¼š\n[0x0045c410]\u0026gt; px/1ag 0x4ecc28 0x004ecc28 0x004abf20 0x00000000 .J.....  px/1agå°±æ˜¯å°±æ˜¯ç±»ä¼¼gdbè°ƒè¯•å™¨é‡Œé¢çš„x/FMTæˆ–è€…dlvé‡Œé¢çš„x -FMT hex -len 8 addressã€‚æˆ‘ä»¬æ‰“å°åœ°å€0x4ecc28åœ°å€å¤„çš„ä¸€ä¸ª8å­—èŠ‚åœ°å€å‡ºæ¥ï¼Œå‘ç°åˆšå¥½å°±æ˜¯å‡½æ•°açš„åœ°å€0x004abf20ã€‚æ‰€ä»¥ï¼Œä¸Šè¿°f := a å…³äºfç»“æ„çš„çŒœæƒ³å°±å¾—åˆ°äº†éªŒè¯ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªfuncvalï¼Œå¹¶écc++æ„ä¹‰ä¸Šçš„å‡½æ•°æŒ‡é’ˆã€‚\ndemo3 # ç†è§£äº†funcvalä¹‹åï¼Œå†æ¥ä¸€ä¸ªdemoï¼Œå†æ¥ä¸€ä¸ªä¿®æ”¹ç‰ˆçš„demoï¼Œè¿™ä¸‹åº”è¯¥å¯ä»¥æ‰“å°å‡ºç›¸åŒçš„åœ°å€äº†ã€‚\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;unsafe\u0026quot; ) func a() int { return 1 } func main() { f := a fmt.Printf(\u0026quot;%p\\n\u0026quot;, a) fmt.Printf(\u0026quot;0x%x\\n\u0026quot;, **(**uintptr)(unsafe.Pointer(\u0026amp;f))) }  è¿è¡Œä¸€ä¸‹ï¼š\n$ go build -gcflags=\u0026quot;all=-N -l\u0026quot; -o main3 main3.go $ ./main3 0x4abf20 0x4abf20  OKï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ç†è§£äº†funcvalï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬è°ƒç”¨ f() çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å®‰æ’äº†ä»€ä¹ˆæŒ‡ä»¤æ¥å®ç°å¯¹aè¿™ä¸ªå‡½æ•°çš„è°ƒç”¨å‘¢ï¼Ÿ\nfile: main4.go\npackage main() func a() int { return 1 } func main() { f := a f() }  è¿è¡Œä»¥ä¸‹æ“ä½œï¼š\n$ go build -gcflags=\u0026quot;all=-N -l\u0026quot; -o main4 main4.go $ $ r2 ./main4 -- Enable ascii-art jump lines in disassembly by setting 'e asm.lines=true'. asm.lines.out and asm.linestyle may interest you as well [0x00454330]\u0026gt; s sym.main.main [0x00459270]\u0026gt; af [0x00459270]\u0026gt; pdf ; CODE XREF from sym.main.main @ 0x4592b1 â”Œ 67: sym.main.main (); â”‚ ; var int64_t var_10h @ rsp+0x8 â”‚ ; var int64_t var_8h @ rsp+0x10 â”‚ â”Œâ”€\u0026gt; 0x00459270 64488b0c25f8. mov rcx, qword fs:[0xfffffffffffffff8] â”‚ â• 0x00459279 483b6110 cmp rsp, qword [rcx + 0x10] â”‚ â”Œâ”€â”€\u0026lt; 0x0045927d 762d jbe 0x4592ac â”‚ â”‚â• 0x0045927f 4883ec18 sub rsp, 0x18 â”‚ â”‚â• 0x00459283 48896c2410 mov qword [var_8h], rbp â”‚ â”‚â• 0x00459288 488d6c2410 lea rbp, qword [var_8h] â”‚ â”‚â• 0x0045928d 488d15fc7002. lea rdx, qword [0x00480390] â”‚ â”‚â• 0x00459294 4889542408 mov qword [var_10h], rdx â”‚ â”‚â• 0x00459299 488b05f07002. mov rax, qword [0x00480390] ; [0x480390:8]=0x459250 sym.main.a â”‚ â”‚â• 0x004592a0 ffd0 call rax â”‚ â”‚â• 0x004592a2 488b6c2410 mov rbp, qword [var_8h] â”‚ â”‚â• 0x004592a7 4883c418 add rsp, 0x18 â”‚ â”‚â• 0x004592ab c3 ret â”‚ â””â”€â”€\u0026gt; 0x004592ac e84f7affff call sym.runtime.morestack_noctxt â”” â””â”€\u0026lt; 0x004592b1 ebbd jmp sym.main.main  è¿™é‡Œå…¶å®å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œ0x00480390 å°±æ˜¯å˜é‡fè¿™ä¸ªfuncvalçš„åœ°å€ï¼Œä¸‹é¢åˆå– [0x00480390] è¿™ä¸ªå†…å­˜å•å…ƒä¸­çš„å†…å®¹é€raxï¼Œæ­¤æ—¶raxä¸­çš„å†…å®¹ä¹Ÿå°±æ˜¯å‡½æ•°açš„åœ°å€äº†ï¼Œæœ€å call rax å®Œæˆå‡½æ•°è°ƒç”¨ã€‚\nè¿™é‡Œå…¶å®å®ç°äº†ä¸€ä¸ªæ“ä½œï¼Œæœ¬æ¥fä¹Ÿå¯ä»¥æŒ‡å‘å¦ä¸€ä¸ªå‡½æ•°bï¼Œä½†æ˜¯æˆ‘å´é€šè¿‡èµ‹å€¼æ“ä½œ f := a å°†å…¶æ‰§è¡Œäº†å¦ä¸€ä¸ªå‡½æ•°aå»æ‰§è¡Œã€‚è¿™æ ·ç±»ä¼¼çš„æ“ä½œï¼Œæç‚¼ä¸‹æ˜¯å¦å¯ä»¥æ‹¿æ¥ç”¨äºå®ç°monkey patchingå‘¢ï¼Ÿå¯ä»¥ã€‚\nç°åœ¨è¦åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼ŒåŠ¨æ€è°ƒæ•´ä¸€ä¸ªå‡½æ•°è¦æ‰§è¡Œçš„ç›®çš„ä»£ç ï¼Œå…¶å®ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ“ä½œã€‚\næŒ‡ä»¤Patching # æŒ‡ä»¤patchingæ˜¯ä¸€ä¸ªæ¯”monkey patchingè¦†ç›–é¢æ›´å¹¿çš„èŒƒç•´ï¼Œæ„æ€å°±æ˜¯è¿è¡Œæ—¶ä¿®æ”¹ç¨‹åºæ‰§è¡Œçš„æŒ‡ä»¤ã€‚å…¶å®ï¼ŒæŒ‡ä»¤patchingæŠ€æœ¯å¤§å®¶éƒ½å·²ç»ç”¨è¿‡æ— æ•°æ¬¡äº†ï¼Œåªä¸è¿‡ä¸æ˜¯ä½ äº²è‡ªæ“ä½œçš„ã€‚\næ¯”å¦‚ï¼Œå½“ä½ è°ƒè¯•ä¸€ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œå°±éœ€è¦æŒ‡ä»¤patchè®©ä½ çš„è¢«è°ƒè¯•ä»»åŠ¡ï¼ˆä¿—ç§°traceeï¼‰åœä¸‹æ¥ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å°†traceeä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„é¦–å­—èŠ‚ç¯¡æ”¹ä¸º0xccï¼Œå¤„ç†å™¨é‡åˆ°è¿™ä¸ªæŒ‡ä»¤å°±ä¼šè®©ä½ çš„ç¨‹åºåœä¸‹æ¥ã€‚é€šå¸¸int3ç”¨æ¥ç”Ÿæˆä¸€å­—èŠ‚æŒ‡ä»¤0xccï¼Œå¤„ç†å™¨å–å€¼ã€è¯‘ç ã€æ‰§è¡Œå®Œä¹‹åå°±ä¼šåœä¸‹æ¥è§¦å‘ä¸­æ–­ï¼Œç„¶åå†…æ ¸æä¾›çš„ä¸­æ–­æœåŠ¡ç¨‹åºå¼€å§‹æ‰§è¡Œã€‚æ­£å¸¸BIOSæä¾›çš„éƒ½æ˜¯16ä½ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œä»¥Linuxä¸ºä¾‹ï¼Œå†…æ ¸åˆå§‹åŒ–çš„æ—¶å€™ä¼šé‡å»ºä¿æŠ¤æ¨¡å¼ä¸‹çš„32/64ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œæ„æ€ä¹Ÿå°±æ˜¯è¯´ï¼Œç¢°åˆ°è¿™ä¸ªæŒ‡ä»¤ä¹‹åï¼Œå†…æ ¸å°±ç›¸å½“äºæ”¶åˆ°äº†é€šçŸ¥æ¥å¤„ç†traceeçš„æš‚åœå·¥ä½œã€‚ç­‰traceeåœä¸‹æ¥ä¹‹åå°±ä¼šé€šçŸ¥tracerï¼ˆä¹Ÿå°±æ˜¯è°ƒè¯•å™¨ï¼‰ï¼Œtracerå°±å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ç­‰æ‰‹æ®µæ¥æ£€æŸ¥traceeçš„è¿è¡Œæ—¶ä¿¡æ¯ï¼ŒåŒ…æ‹¬registersã€ramç­‰ç­‰ã€‚\nè¿™é‡Œçš„monkey patchingå‘¢ï¼Œå…¶å®ä¹Ÿæ˜¯æœ‰ç‚¹ç±»ä¼¼ï¼Œç®€å•ä¸€å¥å°±æ˜¯ç¯¡æ”¹æŒ‡ä»¤è€Œå·²ã€‚é—®é¢˜æ˜¯è¿™é‡Œè¯¥æ€ä¹ˆç¯¡æ”¹ï¼Ÿ\nå…¶å®è¿™é‡Œçš„æ”¹æ³•ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå‡å¦‚æˆ‘ä»¬æœ‰è¿™æ ·çš„ä¸€ä¸ªå‡½æ•° func a() int {return 1}ï¼Œæˆ‘ä»¬å¸Œæœ›mainå‡½æ•°ä¸­è°ƒç”¨a()çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„æ˜¯func b() int {return 2}ï¼Œé‚£æ€ä¹ˆæå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå‡½æ•°replace(a, b)å°†å¯¹açš„è°ƒç”¨æ›¿æ¢æˆå¯¹bçš„è°ƒç”¨ã€‚\npackage main func a() int { return 1 } func b() int { return 2 } func main() { replace(a, b) print(a()) }  å¤§è‡´å®ç° # å› ä¸ºæ˜¯åœ¨è¿è¡Œæ—¶ä¿®æ”¹ï¼Œåœ¨è¿è¡Œæ—¶èƒ½å¹²ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ä¸èƒ½ä¿®æ”¹açš„åœ°å€ï¼Œåªèƒ½å†açš„åœ°å€å¤„ç©äº›èŠ±æ‹›ï¼šæŒ‡ä»¤patchï¼Œç¯¡æ”¹è¿™é‡Œçš„æŒ‡ä»¤ã€‚æ€ä¹ˆç¯¡æ”¹å‘¢ï¼Ÿ\n å‰é¢è®²è¿‡ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥æ‹¿åˆ°ä¸€ä¸ªfuncvalå˜é‡ä¸­ä¿å­˜çš„ç›®çš„å‡½æ•°åœ°å€çš„ï¼› æ“ä½œç³»ç»Ÿï¼Œæä¾›äº†ä¸€äº›å¯ä»¥ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨æ¥è®©æˆ‘ä»¬ä¿®æ”¹è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„æ•°æ®ï¼›  ä¸¤ä¸ªæ¡ä»¶éƒ½å…·å¤‡äº†ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ptrace+peekdata/pokedataæ¥è¯»å†™æŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥è·å–å‡½æ•°å¯¹åº”çš„é¡µé¢ï¼ˆæ³¨æ„å¯¹é½ï¼‰ï¼Œç„¶åç”³è¯·å¯¹è¿™ä¸ªé¡µé¢çš„è¯»å†™æ‰§è¡Œæƒé™ã€‚ä¸¤ç§åŠæ³•åº”è¯¥éƒ½å¯è¡Œã€‚æ›´å®‰å…¨ã€ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œptrace+peekdata/pokedataè¦å¥½äº›ï¼Œè¿™é‡Œçº¯ç²¹æ˜¯ä¸ºäº†æ¼”ç¤ºï¼Œå°±ç”¨åé¢è¿™ä¸ªåŠæ³•äº†ã€‚å¤§è‡´å®ç°å¦‚ä¸‹ã€‚\nfile5: main5.go\npackage main import ( \u0026quot;syscall\u0026quot; \u0026quot;unsafe\u0026quot; ) func a() int { return 1 } func b() int { return 2 } func rawMemoryAccess(b uintptr) []byte { return (*(*[0xFF]byte)(unsafe.Pointer(b)))[:] } func assembleJump(f func() int) []byte { funcVal := *(*uintptr)(unsafe.Pointer(\u0026amp;f)) return []byte{ // TODO åŠ¨æ€ç”Ÿæˆè·³è½¬åˆ°å‡½æ•°funcval fç›®çš„åœ°å€çš„æŒ‡ä»¤ // MOV rdx, funcVal // JMP [rdx] } } func replace(orig, replacement func() int) { bytes := assembleJump(replacement) functionLocation := **(**uintptr)(unsafe.Pointer(\u0026amp;orig)) window := rawMemoryAccess(functionLocation) copy(window, bytes) } func main() { replace(a, b) // å°†å¯¹açš„è°ƒç”¨æ›¿æ¢æˆå¯¹bçš„è°ƒç”¨ print(a()) // è¿™é‡Œè¾“å‡ºçš„ä¸æ˜¯1ï¼Œæ˜¯2ï¼Œæ³¨æ„ç¦ç”¨å†…è”-gcflags=\u0026quot;all=-N -l\u0026quot; }  å¤§è‡´å®ç°æ€è·¯å°±æ˜¯ä¸Šé¢è¿™æ ·ï¼Œreplaceå†…éƒ¨ï¼š\n ä¼šé¦–å…ˆç”Ÿæˆè·³è½¬åˆ°å‡½æ•°bçš„æ±‡ç¼–æŒ‡ä»¤ï¼Œ ç„¶åå†æ‰¾åˆ°å‡½æ•°açš„å†…å­˜åœ°å€ï¼Œ å†å°†ç”Ÿæˆçš„è·³è½¬æŒ‡ä»¤æ‹·è´åˆ°å‡½æ•°açš„åœ°å€å¤„ï¼Œè¦†ç›–aåŸæ¥çš„æŒ‡ä»¤ï¼›  è¿™æ ·å½“ç¨‹åºè·‘èµ·æ¥ä¹‹åï¼Œè·‘åˆ°açš„åœ°å€å¤„ï¼Œç«‹å³å°±JMPåˆ°å‡½æ•°bçš„åœ°å€å¤„æ‰§è¡Œå‡½æ•°bçš„æŒ‡ä»¤ã€‚æˆ‘ä»¬è¿™é‡Œä¸è€ƒè™‘å°†aæ•°æ®æ¢å¤çš„é—®é¢˜ï¼Œå…¶å®è¦åšä¹Ÿå¾ˆç®€å•ï¼Œä½ è®°å½•ä¸€ä¸‹å“ªä¸ªåœ°å€ï¼Œè¦†å†™äº†å¤šå°‘å“ªäº›æ•°æ®å°±è¡Œäº†ã€‚è°ƒè¯•å™¨è°ƒè¯•å®‰æ’0xccæŒ‡ä»¤çš„æ—¶å€™éƒ½æ˜¯éœ€è¦åšå¥½ä¿å­˜ã€æ¢å¤ç±»æ“ä½œçš„ï¼Œä¸ç„¶ç”Ÿæˆçš„ç«¯ç‚¹ï¼ˆ0xccï¼‰å°±æŠŠæŒ‡ä»¤å¼„ä¹±å¥—äº†ã€‚æˆ‘ä»¬è¿™é‡Œå°±ä¸åšè¿™äº›äº†ã€‚\nOKï¼Œé‚£è¿™é‡Œçš„å‡½æ•° assembleJump(f func() int) å¦‚ä½•åŠ¨æ€ç”Ÿæˆå®ƒçš„è·³è½¬æŒ‡ä»¤å‘¢ï¼Ÿè¿™é‡Œå¯ä»¥å…ˆå€ŸåŠ©æŒ‡ä»¤çº§è°ƒè¯•å…ˆè‡ªå·±æµ‹è¯•ä¸‹ã€‚\næŒ‡ä»¤çº§è°ƒè¯• # è°ƒè¯•å™¨ï¼Œå¤§å®¶éƒ½ç†Ÿæ‚‰å§ï¼Ÿå…¶å®è°ƒè¯•å™¨ä¹Ÿæ˜¯å¯ä»¥åˆ†æˆå¥½å‡ ç±»æ¯”è¾ƒé€šä¿—çš„åˆ†ç±»æ˜¯æºç çº§è°ƒè¯•å™¨ã€æŒ‡ä»¤çº§è°ƒè¯•å™¨ã€‚\næŒ‡ä»¤çº§è°ƒè¯•å™¨ï¼Œå¤§å®¶å¬è¯´è¿‡çš„åº”è¯¥æœ‰IDAã€OlleDbgã€Hopperã€Cutterã€Radare2ï¼ŒæŒ‡ä»¤çº§è°ƒè¯•å™¨ä¸€èˆ¬å·¥ä½œåœ¨æ±‡ç¼–æŒ‡ä»¤å±‚çº§ï¼Œå¯¹ä¸Šå±‚é«˜çº§è¯­è¨€çš„ä¸œè¥¿ä¸æ€ä¹ˆç†è§£ï¼Œå®ƒç†è§£çš„å°±æ˜¯ä¸€äº›æœ€åŸå§‹çš„ä¿¡æ¯ï¼ŒæŒ‡ä»¤ã€æ•°æ®ã€å¯„å­˜å™¨ã€å†…å­˜ï¼Œæ²¡æœ‰æ–‡ä»¶ã€æºç ã€è¡Œå·ã€å˜é‡å\u0026hellip;å„è‡ªæœ‰å„è‡ªçš„ç”¨é€”ï¼Œä¸€äº›ç¬¦å·çº§è°ƒè¯•å™¨å¦‚dlvã€gdbã€lldbç­‰ç­‰çš„ä¹Ÿä¼šæ”¯æŒä¸€äº›åŸºç¡€çš„æŒ‡ä»¤çº§è°ƒè¯•çš„èƒ½åŠ›ï¼Œæ¯”å¦‚åæ±‡ç¼–ã€stepã€step reverseç­‰ç­‰çš„ã€‚\næˆ‘ä»¬è¿™é‡Œå¸Œæœ›åœ¨æŒ‡ä»¤çº§å®Œæˆè°ƒè¯•ï¼Œæ¯”å¦‚ä¿®æ”¹äº›æŒ‡ä»¤çœ‹çœ‹æ•ˆæœä¹‹ç±»çš„ï¼Œä¸€èˆ¬çš„å·¥å…·è¿˜æ˜¯ä¸æ–¹ä¾¿çš„ã€‚Radare2æ”¯æŒæŒ‡ä»¤çº§è°ƒè¯•ã€æŒ‡ä»¤ä¿®æ”¹ã€æ ¹æ®è°ƒç”¨çº¦å®šåŠ¨æ€ç”Ÿæˆè°ƒç”¨å›¾ç­‰ä¹‹ç±»çš„ï¼Œè¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚\nä»Šå¤©å°±ç”¨Radare2æ¥æ¼”ç¤ºä¸‹è¿™ä¸ªå¦‚ä½•æ“ä½œï¼Œè¦è°ƒè¯•çš„æ˜¯ä¸‹é¢è¿™æ®µä»£ç ã€‚æˆ‘ä»¬åœ¨å‡½æ•°è·³è½¬åˆ°aåœ°å€æ‰§è¡Œä¹‹åï¼Œå°†aåœ°å€å¤„çš„æŒ‡ä»¤ç¯¡æ”¹ä¸‹ï¼Œæ¯”å¦‚å†™ä¸ªJMPåˆ°bå‡½æ•°åœ°å€çš„æŒ‡ä»¤ï¼Œçœ‹èƒ½ä¸èƒ½æ­£å¸¸è·³è½¬åˆ°bå¤„æ‰§è¡Œï¼Œè°ƒè¯•æˆåŠŸåº”è¯¥è¾“å‡º2 2ã€‚\nfile: mainx.go\npackage main func a() int { return 1 } func b() int { return 2 } func main() { println(a(), b()) }  è¿è¡Œä»¥ä¸‹æ“ä½œï¼š\n$ go build -gcflags=\u0026quot;all=-N -l\u0026quot; -o mainx mainx.go $ $ r2 -w ./mainx $ r2 -w ./mainx -- To debug a program, you can call r2 with 'dbg://\u0026lt;path-to-program\u0026gt;' or '-d \u0026lt;path..\u0026gt;' [0x00454330]\u0026gt; s sym.main. sym.main.a sym.main.b sym.main.main [0x00454330]\u0026gt; s sym.main.a ; å‘ç°å‡½æ•°açš„ä½è´¨æ˜¯0x00454330 [0x00459250]\u0026gt; af [0x00459250]\u0026gt; s sym.main.b ; å‘ç°å‡½æ•°bçš„åœ°å€æ˜¯0x00459250 [0x00459270]\u0026gt; af  å¥½ï¼Œæˆ‘ä»¬æ¥ç€æ“ä½œçœ‹ä¸‹åœ¨sym.main.aåœ°å€å¤„å†™å…¥ä¸ªè·³è½¬åˆ°bçš„æŒ‡ä»¤ã€‚\n[0x00459270]\u0026gt; s sym.main.a [0x00459250]\u0026gt; pdf â”Œ 19: sym.main.a (int64_t arg_8h); â”‚ ; arg int64_t arg_8h @ rsp+0x8 â”‚ 0x00459250 48c744240800. mov qword [arg_8h], 0 â”‚ 0x00459259 48c744240801. mov qword [arg_8h], 1 â”” 0x00459262 c3 ret [0x00459250]\u0026gt;  æˆ‘ä»¬çœ‹åˆ°å‡½æ•°aå¤„çš„é€»è¾‘æ˜¯è¿”å›å€¼1ï¼Œæˆ‘ä»¬ä»èµ·èµ·å§‹åœ°å€0x00459250å¤„å¼€å§‹ï¼Œç”¨JMP bAddressçš„æŒ‡ä»¤è¦†ç›–ã€‚\næˆ‘ä»¬å¸Œæœ›å†™åˆ°æ­¤å¤„çš„æŒ‡ä»¤æœ‰ï¼š\nmov rdx, 0x00459270 ; é¦–å…ˆå°†å‡½æ•°båœ°å€æ”¾åˆ°rdxå¯„å­˜å™¨ jmp rdx ; ç„¶åç›´æ¥è·³è½¬è¿‡å»æ‰§è¡Œ  è¿™é‡Œæœ‰è¿™ä¹ˆä¸¤ä¸ªåŠæ³•ï¼š\n r2 -wå†™æ¨¡å¼ä¸‹ï¼Œç›´æ¥ç”¨wa+æ±‡ç¼–æŒ‡ä»¤æ›¿æ¢å‡½æ•°açš„æŒ‡ä»¤ï¼› r2é™„å¸¦å·¥å…·ç”Ÿæˆæ±‡ç¼–å¯¹åº”çš„16è¿›åˆ¶æ•°æ®ï¼Œç”¨wx+16è¿›åˆ¶æ•°æ¥è¦†å†™æŒ‡ä»¤ï¼› å…¶å®ä½ ä¹Ÿå¯ä»¥ç”¨ä¸€äº›åœ¨çº¿çš„æ±‡ç¼–å·¥å…·ç”Ÿæˆï¼Œå†ç”¨å…¶ä»–16è¿›åˆ¶å·¥å…·æ‰“å¼€å¯æ‰§è¡Œç¨‹åºï¼Œç„¶åä¿®æ”¹æ›¿æ¢ã€‚  r2: wa+æ±‡ç¼–æŒ‡ä»¤ # é€šè¿‡waæ¥ç›´æ¥å†™å…¥æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™ä¸ªæ¯”è¾ƒçœäº‹ï¼Œä¸ç”¨å•ç‹¬è¿è¡Œrasm2å»å¾—åˆ°æ±‡ç¼–åçš„æŒ‡ä»¤16ç¦æ­¢æ•°æ®å†å»è¦†å†™ã€‚\n[root@centos test]# r2 -w ./mainx -- The '?' command can be used to evaluate math expressions. Like this: '? (0x34+22)*4' [0x00454330]\u0026gt; s sym.main.b [0x00459270]\u0026gt; af [0x00459270]\u0026gt; s sym.main.a [0x00459250]\u0026gt; af [0x00459250]\u0026gt; pdf â”Œ 19: sym.main.a (int64_t arg_8h); â”‚ ; arg int64_t arg_8h @ rsp+0x8 â”‚ 0x00459250 48c744240800. mov qword [arg_8h], 0 â”‚ 0x00459259 48c744240801. mov qword [arg_8h], 1 â”” 0x00459262 c3 ret [0x00459250]\u0026gt; wa mov rdx, 0x00459270 ;; å†™movæŒ‡ä»¤ï¼Œæç¤ºæˆåŠŸï¼Œå†™å…¥äº†7ä¸ªå­—èŠ‚ Written 7 byte(s) (mov rdx, 0x00459270) = wx 48c7c270924500 [0x00459250]\u0026gt; wa jmp rdx @0x00459257 ;; å†™jmpæŒ‡ä»¤ï¼Œæç¤ºæˆåŠŸï¼Œå†™å…¥äº†2ä¸ªå­—èŠ‚ Written 2 byte(s) (jmp rdx) = wx ffe2 [0x00459250]\u0026gt; px/20xb 0x00459250 ;; æ ¡éªŒä¸€ä¸‹å†™å…¥çš„9ä¸ªå­—èŠ‚ [0x00459250]\u0026gt; wci ;; ä¿å­˜é€€å‡º [0x00459250]\u0026gt; q  æ³¨æ„ä¸€ä¸‹ï¼Œå°±æ˜¯æˆ‘ä»¬å†™å…¥æŒ‡ä»¤ä¹‹åï¼Œç›´æ¥è¿è¡Œå‘½ä»¤pdfï¼ˆprint disassembly functionï¼‰çœ‹åˆ°çš„æŒ‡ä»¤æœ‰äº›æ˜¯æ²¡æ­£å¸¸æ˜¾ç¤ºçš„ï¼Œä¸è¿‡æˆ‘ä»¬px/æ ¡éªŒæ•°æ®æ˜¯æˆåŠŸå†™å…¥çš„å°±okã€‚\nè¿è¡Œä¸‹patchä¹‹åçš„ç¨‹åºï¼š\n$ ./mainx 2 2  å®Œå…¨ç¬¦åˆé¢„æœŸã€‚\nr2: wx+hex # é‚£æˆ‘ä»¬å¾—çœ‹ä¸‹è¿™äº›æ±‡ç¼–æŒ‡ä»¤å¯¹åº”çš„æœºå™¨æŒ‡ä»¤æ˜¯å•¥æ ·çš„ï¼Œradare2ä¹Ÿæä¾›äº†å·¥å…·æ¥å¤„ç†ã€‚\næ±‡ç¼–ã€æœºå™¨æŒ‡ä»¤éƒ½æ˜¯å¹³å°ç›¸å…³çš„ï¼Œæ±‡ç¼–å‰å…ˆçœ‹ä¸‹å¹³å°ç›¸å…³ä¿¡æ¯ï¼Œå¥½ï¼Œæˆ‘çš„æ˜¯Intel x86_64, 64ä½ã€‚\n$ uname -a Linux centos 4.19.76-linuxkit #1 SMP Tue May 26 11:42:35 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux $ $ rasm2 -a x86 -b 64 'mov rdx, 0x00459270' 48c7c270924500 $ rasm2 -a x86 -b 64 'jump rdx' ffe2  ç”Ÿæˆæœºå™¨æŒ‡ä»¤åï¼Œåœ¨r2ä¼šè¯çª—å£ä¸­æ‰§è¡Œï¼š\n[0x00459250] wx 48c7c270924500ffe2 [0x00459250]\u0026gt; px/9xb - offset - 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF 0x00459250 48c7 c270 9245 00ff e2 H..p.E... ;; å†™å…¥æˆåŠŸäº† [0x00459250]\u0026gt; wci ;; ä¿å­˜é€€å‡º [0x00459250]\u0026gt; q  è¿è¡Œä¸‹patchä¹‹åçš„ç¨‹åºï¼š\n$ ./mainx 2 2  ä¸Šé¢åªæ˜¯ä¸ºäº†æµ‹è¯•ä¸‹ï¼Œè¡Œè¿˜æ˜¯ä¸è¡Œï¼Œè‚¯å®šæ˜¯è¡Œå•Šï¼Œæˆ‘åªæ˜¯æƒ³ç‚«è€€ä¸‹radare2æœ‰å¤šå¼ºå¤§å¥½ç©è€Œå·²ã€‚\nMonkey Patching # ä¸Šé¢å…œäº†ä¸ªåœˆå­ï¼Œç»™å¤§å®¶æ¼”ç¤ºäº†ä¸‹radare2æ€ä¹ˆä½¿ç”¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¿è¡Œæ—¶patchä¸‹æŒ‡ä»¤æµ‹è¯•ä¸‹ã€‚è¿˜æ˜¯mainx.goè¿™ä¸ªç¨‹åºã€‚\npackage main func a() int { return 1 } func b() int { return 2 } func main() { println(a(), b()) }  å‰é¢radare2éƒ½æ˜¯è¿è¡Œåœ¨ä¿®æ”¹æ¨¡å¼ä¸‹ï¼Œè¿™æ¬¡è¿è¡Œå†è°ƒè¯•æ¨¡å¼ä¸‹radare2 -dã€‚\næ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š\n$ r2 -d ./mainx Process with PID 1243 started... ;; æ˜¾ç¤ºå·²ç»attachåˆ°tracee = attach 1243 1243 bin.baddr 0x00400000 Using 0x400000 asm.bits 64 -- Use 'e' and 't' in Visual mode to edit configuration and track flags. [0x00454330]\u0026gt; s sym.main.b ;; ç»§ç»­çœ‹ä¸‹bå‡½æ•°åœ°å€ [0x00459270]\u0026gt; af [0x00459270]\u0026gt; s sym.main.a ;; ç»§ç»­çœ‹ä¸‹aå‡½æ•°åœ°å€ [0x00459250]\u0026gt; af [0x00459250]\u0026gt; pdf ;; çœ‹ä¸‹aå‡½æ•°åŒ…å«çš„æŒ‡ä»¤ â”Œ 9: sym.main.a (); â”‚ bp: 0 (vars 0, args 0) â”‚ sp: 0 (vars 0, args 0) â”‚ rg: 0 (vars 0, args 0) â”‚ 0x00459250 48c7c2709245. mov rdx, sym.main.b ; 0x459270 ; \u0026quot;H\\xc7D$\\b\u0026quot; â”” 0x00459257 ffe2 jmp rdx [0x00459250]\u0026gt; wx 48c7c270924500ffe2 ;; è·Ÿå‰é¢è®²çš„ä¸€æ ·ï¼ŒæŒ‡ä»¤patchï¼Œè°ƒåˆ°bå» [0x00459250]\u0026gt; [0x00459250]\u0026gt; s sym.main.main ;; å®šä½åˆ°mainå‡½æ•° [0x00459290]\u0026gt; af ;; åˆ†æmainå‡½æ•° [0x00459290]\u0026gt; pdf ;; çœ‹ä¸‹mainå‡½æ•°æŒ‡ä»¤é›†è°ƒç”¨å…³ç³» ; CODE XREF from sym.main.main @ 0x459308 â”Œ 122: sym.main.main (); â”‚ ; var int64_t var_18h @ rsp+0x8 â”‚ ; var int64_t var_10h @ rsp+0x10 â”‚ ; var int64_t var_8h @ rsp+0x18 â”‚ â”Œâ”€\u0026gt; 0x00459290 64488b0c25f8. mov rcx, qword fs:[0xfffffffffffffff8] â”‚ â• 0x00459299 483b6110 cmp rsp, qword [rcx + 0x10] â”‚ â”Œâ”€â”€\u0026lt; 0x0045929d 7664 jbe 0x459303 â”‚ â”‚â• 0x0045929f 4883ec20 sub rsp, 0x20 â”‚ â”‚â• 0x004592a3 48896c2418 mov qword [var_8h], rbp â”‚ â”‚â• 0x004592a8 488d6c2418 lea rbp, qword [var_8h] â”‚ â”‚â• 0x004592ad e89effffff call sym.main.a â”‚ â”‚â• 0x004592b2 488b0424 mov rax, qword [rsp] â”‚ â”‚â• 0x004592b6 4889442410 mov qword [var_10h], rax â”‚ â”‚â• 0x004592bb e8b0ffffff call sym.main.b â”‚ â”‚â• 0x004592c0 488b0424 mov rax, qword [rsp] â”‚ â”‚â• 0x004592c4 4889442408 mov qword [var_18h], rax â”‚ â”‚â• 0x004592c9 e80203fdff call sym.runtime.printlock â”‚ â”‚â• 0x004592ce 488b442410 mov rax, qword [var_10h] â”‚ â”‚â• 0x004592d3 48890424 mov qword [rsp], rax â”‚ â”‚â• 0x004592d7 e8740afdff call sym.runtime.printint â”‚ â”‚â• 0x004592dc e82f05fdff call sym.runtime.printsp â”‚ â”‚â• 0x004592e1 488b442408 mov rax, qword [var_18h] â”‚ â”‚â• 0x004592e6 48890424 mov qword [rsp], rax â”‚ â”‚â• 0x004592ea e8610afdff call sym.runtime.printint â”‚ â”‚â• 0x004592ef e86c05fdff call sym.runtime.printnl â”‚ â”‚â• 0x004592f4 e85703fdff call sym.runtime.printunlock â”‚ â”‚â• 0x004592f9 488b6c2418 mov rbp, qword [var_8h] â”‚ â”‚â• 0x004592fe 4883c420 add rsp, 0x20 â”‚ â”‚â• 0x00459302 c3 ret â”‚ â””â”€â”€\u0026gt; 0x00459303 e8f879ffff call sym.runtime.morestack_noctxt â”” â””â”€\u0026lt; 0x00459308 eb86 jmp sym.main.main [0x00459290]\u0026gt; dc ;; æˆ‘ä»¬è¿™é‡Œæ²¡æœ‰ä»€ä¹ˆåŠ æ–­ç‚¹çš„å¿…è¦äº†ï¼Œç›´æ¥continue (1243) Created thread 1244 (1243) Created thread 1245 PTRACE_CONT: No such process (1243) Created thread 1246 PTRACE_CONT: No such process [+] SIGNAL 19 errno=0 addr=0x00000000 code=0 ret=0 [+] signal 19 aka SIGSTOP received 0 [0x004549f3]\u0026gt; dc ;; å†æ¥ä¸€æ¬¡ï¼Œcontinueåˆ°traceeç»“æŸ 2 2 ;; è¾“å‡ºäº†ç»“æœ `2 2`  OKï¼Œç»è¿‡ä¸Šé¢ç›¸å…³çš„æ¼”ç¤ºä¹‹åï¼Œåº”è¯¥å·²ç»äº†è§£äº†æˆ‘ä»¬patchçš„å¤§è‡´æ–¹æ³•åŠå®é™…æ•ˆæœäº†ï¼Œä¹Ÿä»‹ç»äº†radare2çš„å¸¸ç”¨æ“ä½œã€‚\nPut It Together # ç°åœ¨æˆ‘ä»¬æ”¶ä¸€ä¸‹ï¼Œå°†å‰é¢æŒæ¡çš„æŠ€èƒ½ç‚¹ç»¼åˆèµ·æ¥ï¼Œæ¥å®ç°æˆ‘ä»¬å‰é¢é—ç•™çš„ä»»åŠ¡ï¼š\nfunc assembleJump(f func() int) []byte { funcVal := *(*uintptr)(unsafe.Pointer(\u0026amp;f)) return []byte{ // TODO åŠ¨æ€ç”Ÿæˆè·³è½¬åˆ°å‡½æ•°funcval fç›®çš„åœ°å€çš„æŒ‡ä»¤ // MOV rdx, funcVal // JMP [rdx] } }  é‚£è¿™é‡Œå°±å¾ˆç®€å•äº†ï¼Œå°±æ˜¯å¡«å……è¿™é‡Œçš„[]byte{}ï¼Œæ„é€ å‡ºæˆ‘ä»¬å‰é¢radare2 wxå‘½ä»¤å†™å…¥çš„æ•°æ®è€Œå·²ã€‚ å¤šæ¬¡æµ‹è¯•ä¸‹rasm2å¯¹jmpæŒ‡ä»¤çš„ç¼–ç ä½ å¯ä»¥å‘ç°ï¼š\n movæ“ä½œç ç¼–ç ä¸º48c7 rdxç¼–ç ä¸ºä¸ºc2 æ¥ä¸‹æ¥æ˜¯è¦ç§»åŠ¨çš„æ•°æ®funcvalåœ°å€ï¼Œè¿™ä¸ªé€šè¿‡ç§»ä½è¿ç®—ç¬¦æä¸‹å°±è¡Œäº†ï¼Œå¤šå°‘ä¸ªå­—èŠ‚å‘¢ï¼Ÿçœ‹movæ“ä½œç çŸ¥é“æ“ä½œæ•°ä½å®½32bitsï¼Œæ‰€ä»¥4ä¸ªå­—èŠ‚  é‚£ä¹ˆ MOV rdx, funcVal å¯¹åº”çš„å°±æ˜¯:\n[]byte{ 0x48, 0xC7, 0xC2, byte(funcVal \u0026gt;\u0026gt; 0), byte(funcVal \u0026gt;\u0026gt; 8), byte(funcVal \u0026gt;\u0026gt; 16), byte(funcVal \u0026gt;\u0026gt; 24), // MOV rdx, funcVal  å†çœ‹ä¸‹ JMP [rdx]ï¼Œæ³¨æ„è¿™é‡Œå’Œæˆ‘ä»¬å‰é¢ä¸¾çš„ä¾‹å­ä¸åŒï¼Œå‰é¢æ˜¯å¯¹JMP rdxç¼–ç çš„ï¼Œè¿™ä¸¤ç§æ–¹å¼æ¶‰åŠåˆ°å¤„ç†å™¨å¯»å€æ–¹å¼çš„å·®å¼‚ã€‚\n JMP [rdx]ï¼Œæ˜¯è¯´rdxä¸­å­˜å‚¨çš„æ˜¯åœ°å€ï¼Œå–å‡ºè¿™ä¸ªåœ°å€å¯¹åº”å†…å­˜å•å…ƒä¸­çš„æ•°æ®ä½œä¸ºæœ‰æ•ˆåœ°å€ï¼› JMP rdxï¼Œæ˜¯è¯´rdxä¸­å­˜å‚¨çš„å°±æ˜¯æœ‰æ•ˆåœ°å€ï¼Œå‰é¢çš„ä¾‹å­ä¸­æˆ‘ä»¬æ˜¯ç›´æ¥å°†func bçš„åœ°å€æ‹¿æ¥ç”¨çš„ï¼›  è¿™é‡Œçš„assembleJumpå‡½æ•°æ¥å—çš„å‚æ•°æ˜¯funcValï¼Œæ‹¿åˆ°çš„æ˜¯funcValçš„åœ°å€ï¼Œéœ€è¦å†è§£ä¸€æ¬¡å¼•ç”¨ï¼Œæ‰èƒ½æ‹¿åˆ°func bçš„æœ‰æ•ˆåœ°å€ã€‚\nè¯´è¿™ä¹ˆå¤šï¼Œåº”è¯¥æ²¡æœ‰æ­§ä¹‰äº†ï¼Œä½¿ç”¨rasm2ç»§ç»­å¯¹JMP [rdx]ç¼–ç å¾—åˆ°ff22:\n$ rasm2 -a x86 -b 64 'jmp [rdx]' $ ff22  é‚£æˆ‘ä»¬è¿™ä¸ªå‡½æ•°å°±å¯ä»¥å†™å®Œäº†ï¼š\nfunc assembleJump(f func() int) []byte { funcVal := *(*uintptr)(unsafe.Pointer(\u0026amp;f)) return []byte{ // TODO åŠ¨æ€ç”Ÿæˆè·³è½¬åˆ°å‡½æ•°funcval fç›®çš„åœ°å€çš„æŒ‡ä»¤ 0x48, 0xC7, 0xC2, byte(funcVal \u0026gt;\u0026gt; 0), byte(funcVal \u0026gt;\u0026gt; 8), byte(funcVal \u0026gt;\u0026gt; 16), byte(funcVal \u0026gt;\u0026gt; 24), // MOV rdx, funcVal 0xff, 0x22, // JMP [rdx] } }  é‚£æœ€åçš„ç¤ºä¾‹å°±æ˜¯è¿™æ ·çš„ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œä¸‹é¢çš„ç¨‹åºæ¥æµ‹è¯•ä¸‹ï¼ŒæœŸæœ›çš„ç»“æœæ˜¯è¾“å‡º2ï¼Œè€Œä¸æ˜¯1ã€‚\nå¦‚æœä½ æµ‹è¯•çš„æ—¶å€™è¾“å‡ºäº†1ï¼Œè¯´æ˜ä½ å¯èƒ½å¿½è§†äº†ä¸€ä¸ªé—®é¢˜ï¼šè¿™é‡Œçš„monkey patchingæ˜¯åŸºäºå‡½æ•°åœ°å€å¤„çš„æŒ‡ä»¤patchæ¥å®ç°çš„ã€‚å¦‚æœç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œä¸å·§æœŸæœ›è¢«patchçš„å‡½æ•°è¢«go inlineå¤„ç†æ‰äº†ï¼Œé‚£è¿™é‡Œçš„patché“å®šå°±å¤±æ•ˆäº†ã€‚\næ‰€ä»¥æµ‹è¯•çš„æ—¶å€™è®°å¾—ç¦ç”¨å†…è”ï¼Œæ¯”å¦‚go run -gcflags=\u0026quot;all=-N -l\u0026quot; jump.goã€‚\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;syscall\u0026quot; \u0026quot;unsafe\u0026quot; ) func a() int { return 1 } func b() int { return 2 } func getPage(p uintptr) []byte { return (*(*[0xFFFFFF]byte)(unsafe.Pointer(p \u0026amp; ^uintptr(syscall.Getpagesize()-1))))[:syscall.Getpagesize()] } func rawMemoryAccess(b uintptr) []byte { return (*(*[0xFF]byte)(unsafe.Pointer(b)))[:] } func assembleJump(f func() int) []byte { funcVal := *(*uintptr)(unsafe.Pointer(\u0026amp;f)) fmt.Printf(\u0026quot;target address: %#x\\n\u0026quot;, funcVal) return []byte{ 0x48, 0xC7, 0xC2, byte(funcVal \u0026gt;\u0026gt; 0), byte(funcVal \u0026gt;\u0026gt; 8), byte(funcVal \u0026gt;\u0026gt; 16), byte(funcVal \u0026gt;\u0026gt; 24), // MOV rdx, funcVal 0xFF, 0x22, // JMP rdx } } func replace(orig, replacement func() int) { bytes := assembleJump(replacement) functionLocation := **(**uintptr)(unsafe.Pointer(\u0026amp;orig)) fmt.Printf(\u0026quot;orig address: %#x\\n\u0026quot;, functionLocation) window := rawMemoryAccess(functionLocation) page := getPage(functionLocation) syscall.Mprotect(page, syscall.PROT_READ|syscall.PROT_WRITE|syscall.PROT_EXEC) copy(window, bytes) fmt.Printf(\u0026quot;bytes: %v\\n\u0026quot;, bytes) fmt.Printf(\u0026quot;wind: %v\\n\u0026quot;, window[0:len(bytes)]) } func main() { fmt.Printf(\u0026quot;a address: %p\\n\u0026quot;, a) fmt.Printf(\u0026quot;b address: %p\\n\u0026quot;, b) replace(a, b) print(a()) }  è¿è¡Œæµ‹è¯•ä¸‹ï¼š\n$ go run -gcflags=\u0026quot;all=-N -l\u0026quot; jump.gomonkey 2  gomonkeyå†™mockæµ‹è¯•ï¼Œå¯¹å‡½æ•°çš„å¤„ç†å¤§è‡´å°±æ˜¯è¿™ä¸ªè¿™ä¹ˆå®ç°çš„ï¼Œè¿™é‡Œå°±ä¸ç»§ç»­è¯´gomonkeyçš„å…·ä½“å®ç°ç»†èŠ‚äº†ã€‚\næ€»ç»“ # æœ¬æ–‡æ‰€æå†…å®¹å¹¶éåŸåˆ›ï¼Œåœ¨äº†è§£gomonkeyçš„è¿‡ç¨‹ä¸­çœ‹åˆ°äº†ã€Šmonkey-patching-in-goã€‹è¿™ç¯‡æ–‡ç« ï¼Œç»“åˆè‡ªå·±çš„ä¸€äº›ç†è§£é‡æ–°è§£é‡Šä¸‹èƒŒåçš„åŸç†ã€‚\nå…¶å®æœ¬æ²¡æœ‰å¿…è¦è§£é‡Šè¿™ä¹ˆå¤šï¼Œæˆ‘å¯ä»¥ä¸€å¥è¯æ€»ç»“å®Œï¼Œâ€go funcval + æŒ‡ä»¤patchâ€œã€‚ä½†æ˜¯å‘¢ï¼Œâ€çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…â€ï¼Œæ²¡æœ‰ç»è¿‡å®è·µæ£€éªŒçš„â€œæ‡‚â€ä¹Ÿåªæ˜¯è‡ªå·±éª—è‡ªå·±ç½¢äº†ã€‚\nå¤§ç¯‡å¹…ä»‹ç»äº†radare2è°ƒè¯•å™¨çš„ä¸€äº›ä½¿ç”¨ï¼Œåº”è¯¥æœ‰è¯»è€…ä¼šå¯¹è°ƒè¯•å™¨å·¥ä½œåŸç†ã€åº•å±‚å®ç°æ¯”è¾ƒæ„Ÿå…´è¶£ï¼Œè¿™ä¹Ÿæ˜¯å¤§ç¯‡å¹…ä»‹ç»çš„ä¸€ç‚¹å°å°çš„ç§å¿ƒã€‚\nä»2018å¹´å¼€å§‹é™†ç»­æ•´ç†è°ƒè¯•åŸç†çš„ä¸€äº›çŸ¥è¯†ï¼Œå°†è¿™äº›æ•´ç†çš„å†…å®¹æ”¾åœ¨äº†githubä¸Šgolang-debugger-bookã€‚åŸç†çš„éƒ¨åˆ†å¤§è‡´å·²ç»ä»‹ç»å®Œäº†ï¼Œç°åœ¨è¿˜éœ€è¦ç»“åˆä¸€ä¸ªå®ç°æ¥è¾…åŠ©ä½¿å†…å®¹æ›´åŠ è¯¦å®ä¸€ç‚¹ï¼Œè¿™é‡Œä¹Ÿä¼šæ¶‰åŠåˆ°å¯¹goå®ç°ç»†èŠ‚çš„ä¸€äº›çŸ¥è¯†ç‚¹è¡¥å……ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ä¸€èµ·æ¥ã€‚\næ—¶é—´ç²¾åŠ›å®åœ¨æœ‰é™ï¼Œæ‹–å¾—ä¹…äº†ï¼Œå¾ˆæ²¡æœ‰æˆå°±æ„Ÿã€‚\nå‚è€ƒæ–‡ç«  # 1.monkey-patching-in-go, https://bou.ke/blog/monkey-patching-in-go/\n2.a-journey-into-radare2, https://www.megabeets.net/a-journey-into-radare-2-part-1/\n3.monkey patching, https://en.wikipedia.org/wiki/Monkey_patch\n4.radare2 book, https://radare.gitbooks.io/radare2book/content/tools/rasm2/assemble.html\n"}),a.add({id:252,href:"/tags/monkey-patching/",title:"monkey-patching",description:"",content:""}),a.add({id:253,href:"/tags/assembly/",title:"assembly",description:"",content:""}),a.add({id:254,href:"/tags/intel/",title:"intel",description:"",content:""}),a.add({id:255,href:"/tags/x64/",title:"x64",description:"",content:""}),a.add({id:256,href:"/blog/2020-08-20-x64%E6%B1%87%E7%BC%96%E5%BC%80%E5%8F%91%E4%BB%8B%E7%BB%8D/",title:"x64æ±‡ç¼–å¼€å‘ä»‹ç»",description:"æœ€è¿‘åœ¨å·¥ä½œå’Œå­¦ä¹ ä¸­å‘ç°ï¼Œå…¶å®æ±‡ç¼–æ˜¯éå¸¸é‡è¦çš„ï¼Œå³ä¾¿ç°åœ¨é«˜çº§è¯­è¨€å·²ç»éå¸¸æ–¹ä¾¿äº†ï¼Œä½†æ˜¯äº†è§£æ±‡ç¼–å¯¹äºæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼Œä»¥åŠä¸€äº›é«˜æ·±çš„çŸ¥è¯†ç‚¹æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è¯´Linuxæ“ä½œç³»ç»Ÿæœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°å«Forkæˆ‘ä»¬éƒ½çŸ¥é“Forkçš„è¿”å›å€¼åœ¨å­è¿›ç¨‹ä¸­æ˜¯0ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­æ˜¯é0ï¼Œé‚£è¿™ä¸ªæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿå¯¹äºä¸äº†è§£æ±‡ç¼–çš„äººä¹Ÿå¾ˆéš¾æœ‰èƒ½åŠ›å»é˜…è¯»Linuxæ“ä½œç³»ç»Ÿæºç ï¼Œåªèƒ½é“å¬é€”è¯´äº†è§£åˆ°ä¸ªå¤§æ¦‚åŸå› ã€‚å†æ¯”å¦‚æ¥ä¸‹æ¥è¦è®²çš„gomonkeyæµ‹è¯•æ¡†æ¶å®ç°çš„ä¸€äº›æŒ‡ä»¤patchingæ“ä½œï¼Œè¿™äº›éƒ½æ˜¯ä¸æ±‡ç¼–æ“ä½œåˆ†ä¸å¼€çš„ã€‚ç”šè‡³ä½ æƒ³äº†è§£ä¸‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½ éƒ½éœ€è¦æ·±å…¥äº†è§£ä¸‹æŒ‡ä»¤æ‰§è¡Œå‘¨æœŸç­‰ç­‰çš„é—®é¢˜ã€‚\nä¸æ‡‚æ±‡ç¼–ï¼Œä¸å¦¨ç¢ä½ å¼€å‘ä¸Šå±‚åº”ç”¨ï¼Œä½†æ˜¯å¯¹ä½ çš„æ·±åº¦å°±æ˜¯ä¸€é“åï¼Œä½ å¾ˆéš¾è·¨å›½è¿™ä¸ªé¸¿æ²Ÿå»çª¥æ¢æ›´åº•å±‚çš„ä¸€äº›åŸç†ã€‚\næœ‰æ„Ÿè€Œå‘ï¼Œä»Šå¤©å°±å›é¡¾ä¸‹intelå®˜æ–¹å¼€å‘å‘å¸ƒçš„x64æ±‡ç¼–çŸ¥è¯†ï¼Œåšä¸€ä¸ªç®€å•çš„å›é¡¾ï¼Œä¹Ÿä¸ºåé¢ç ”ç©¶gomonkeyæŒ‡ä»¤patchingç­‰ç­‰åšä¸€äº›å‡†å¤‡å’Œé“ºå«ã€‚\nä»‹ç» # å¤§å®¶ä½¿ç”¨x86æ±‡ç¼–æ¥å†™ä¸€äº›å¯¹æ€§èƒ½æ¯”è¾ƒæ•æ„Ÿçš„ç¨‹åºå—¯ï¼Œè¿™ä¸ªæƒ…å†µå·²ç»æŒç»­å¾ˆå¤šå¹´äº†å—¯ï¼Œä½†æ˜¯ç°åœ¨32ä½æœºå™¨åº”é€æ¸è¢«64ä½æœºå™¨å–ä»£äº†ï¼Œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦å°±æ˜¯ä»‹ç»x64æ±‡ç¼–çš„ï¼Œå¦‚æœä¸äº†è§£x86æ±‡ç¼–ä¹Ÿæ²¡ä»€ä¹ˆå¤§ç¢ï¼Œå½“ç„¶äº†è§£çš„è¯ç†è§£èµ·æ¥ä¼šæ›´ç®€å•ä¸€ç‚¹ã€‚\nx64æ˜¯ä¸€ä¸ªé€šç”¨çš„åå­—ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å¯¹Intelä»¥åŠAMD 32ä½æŒ‡ä»¤é›†æ¶æ„çš„ä¸€ä¸ª64ä½æ‰©å±•ã€‚AMDé¦–å…ˆå¼•å…¥äº†x64æŒ‡ä»¤é›†ï¼Œæœ€åˆå«x86-64ï¼Œåé¢åˆæ”¹æˆäº†AMD64ã€‚Intelå‘¢ï¼Œå°†å…¶æ”¯æŒ64ä½æŒ‡ä»¤é›†çš„æ¶æ„ç§°ä¹‹ä¸ºIA-32eï¼Œåé¢åˆæ”¹æˆäº†EMT64ã€‚è¿™ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´æœ‰ä¸€ç‚¹ç»†å¾®çš„ä¸å…¼å®¹çš„åœ°æ–¹ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æŒ‡ä»¤åœ¨ä¸¤ä¸ªç‰ˆæœ¬ä¸Šéƒ½å¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œç›¸å…³çš„ç»†èŠ‚å¯ä»¥å‚è€ƒIntelå¼€å‘æ‰‹å†ŒIntel 64 And IA-32 Architectures Software Developer\u0026rsquo;s Manualsï¼Œä»¥åŠAMD64æ¶æ„çš„æŠ€æœ¯æ–‡æ¡£ã€‚æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„äº¤é›†éƒ¨åˆ†ç§°ä¹‹ä¸ºx64ã€‚ä¸è¦å°†x64ä¸64ä½Intel Itaniumæ¶æ„ï¼ˆç§°ä¹‹ä¸ºIA-64ï¼‰æ··ä¸ºä¸€è°ˆã€‚\nè¿™ç¯‡æ–‡ç« æ²¡æœ‰æ¶‰åŠç¡¬ä»¶ç›¸å…³çš„ç»†èŠ‚ï¼Œå¦‚cachesã€åˆ†æ”¯é¢„æµ‹ï¼Œä»¥åŠå…¶ä»–é«˜çº§è¯é¢˜ã€‚æ–‡ç« æœ€åä¼šç»™å‡ºä¸€äº›è¿™äº›é¢†åŸŸçš„å‚è€ƒæ‰‹å†Œä¾›äº†è§£æ›´å¤šã€‚\næ±‡ç¼–è¯­è¨€ï¼Œå¾€å¾€ä¼šç”¨æ¥ç¼–å†™å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒè‹›åˆ»çš„ç¨‹åºæˆ–å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯å¯¹å¤§éƒ¨åˆ†æ™®é€šç¨‹åºå‘˜æ¥è¯´ï¼Œä¸å…¶è®©å…¶å†™æ±‡ç¼–ï¼Œè¿˜ä¸å¦‚å†™cc++ç„¶åé…ä¸Šä¸€ä¸ªå¥½çš„ç¼–è¯‘å™¨æ¥çš„å®åœ¨ï¼Œåè€…ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ€§èƒ½å¯èƒ½æ¯”å…¶å†™å‡ºçš„æ±‡ç¼–ä»£ç è´¨é‡æ›´é«˜ã€‚æ±‡ç¼–è¯­è¨€å¯¹äºè°ƒè¯•ä»£ç ä¹Ÿæ˜¯æœ‰ç”¨çš„ï¼Œæœ‰æ—¶ä¸€ä¸ªç¼–è¯‘å™¨å¯èƒ½ç”Ÿæˆäº†ä¸€äº›ä¸æ­£ç¡®çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œé€šè¿‡è°ƒè¯•å™¨åœ¨ç¨‹åºä¸­å•æ­¥è°ƒè¯•å¯ä»¥å¸®åŠ©å®šä½åˆ°é—®é¢˜çš„åŸå› ã€‚ä»£ç ä¼˜åŒ–å™¨ï¼Œæœ‰æ—¶ä¹Ÿä¼šçŠ¯é”™ã€‚æ±‡ç¼–çš„å¦å¤–ä¸€ä¸ªç”¨é€”ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥ç ”ç©¶æ²¡æœ‰æºç çš„ç¨‹åºã€‚åæ±‡ç¼–è®©ä½ èƒ½å¤Ÿæ”¹å˜ã€ä¿®å¤ç°æœ‰çš„å¯æ‰§è¡Œç¨‹åºï¼ˆæ¨èä¸‹å‡ ä¸ªå·¥å…·hopper or cutterï¼‰ã€‚å¦‚æœä½ æƒ³äº†è§£æˆ–è€…è°ƒæŸ¥ä¸ºä»€ä¹ˆæŸç§ç¼–ç¨‹è¯­è¨€æ¯”è¾ƒæ…¢ï¼Œå…¶ä»–çš„æ¯”è¾ƒå¿«ä¹‹ç±»çš„é—®é¢˜ï¼Œæ±‡ç¼–ä¹Ÿæ˜¯ä½ çš„å¥½å¸®æ‰‹ã€‚æœ€åå§ï¼ŒæŒæ¡æ±‡ç¼–çŸ¥è¯†ï¼Œå¯¹äºè¯Šæ–­ä¸€äº›æ¶æ„è½¯ä»¶ï¼Œä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„æŠ€èƒ½ã€‚\næ¶æ„ # å½“è¦å»å­¦ä¹ ç‰¹å®šå¹³å°çš„æ±‡ç¼–æ—¶ï¼Œé¦–å…ˆåº”è¯¥å­¦ä¹ çš„æ˜¯ï¼Œè¯¥å¹³å°çš„å¯„å­˜å™¨é›†åˆã€‚\né€šç”¨æ¶æ„ # 64ä½å¯„å­˜å™¨å…è®¸å®¹çº³æ›´å¤§çš„å°ºå¯¸çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰çš„æ›´å¤šçš„ç±»å‹ï¼Œå°†1ä¸ªå­—èŠ‚byteå®šä¹‰æˆ8bitsï¼Œå°†1ä¸ªå­—wordå®šä¹‰æˆ16bitsï¼Œå°†ä¸€ä¸ªåŒå­—double wordå®šä¹‰æˆ32bitsï¼Œå°†ä¸€ä¸ªå››å­—quadwordå®šä¹‰æˆ64ä½ï¼Œå°†ä¸€ä¸ªå…«å­—double quadwordå®šä¹‰æˆ128bitsã€‚å…³äºå­—èŠ‚åºçš„é—®é¢˜ï¼ŒIntelæ˜¯å°ç«¯å­—èŠ‚åºï¼Œæ„å‘³ç€ä½æœ‰æ•ˆä½å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€ä¸­ã€‚\nä¸Šå›¾æ˜¾ç¤ºäº†16ä¸ª64bitsçš„é€šç”¨ç›®çš„å¯„å­˜å™¨ï¼Œå‰8ä¸ªè¢«å‘½åæˆraxã€rbxã€rcxã€rdxã€rbpã€rsiã€rdiã€rspï¼Œè¿™ä¸ªå‘½åå’Œå†å²åŸå› æœ‰å…³ç³»ï¼Œåé¢8ä¸ªè¢«å‘½åæˆäº†r8~r15ã€‚å¦‚æœå‰8ä¸ªè‡ªå·±å­˜å™¨åï¼Œå°†å­—ç¬¦ræ¢æˆeï¼Œå°±å˜æˆäº†å¯¹åº”çš„åœ°ä½çš„32ä½å¯„å­˜å™¨ï¼Œæ¯”å¦‚raxçš„ä½32ä½æ˜¯eaxã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœæƒ³è®¿é—®ä½16ä½ï¼Œå°±ç›´æ¥æŠŠå‰ç¼€å»æ‰ï¼Œå¦‚AXå°±æ˜¯è®¿é—®çš„raxçš„ä½16ä½ï¼Œå¦‚æœä½8ä½å‘¢ï¼Œé‚£å°±æ˜¯ALäº†ï¼ŒAHå°±æ˜¯æ¬¡ä½8ä½ï¼ˆ8~15ä½ï¼‰ã€‚æ–°åŠ çš„8ä¸ªå¯„å­˜å™¨r8~r15å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼æ¥è®¿é—®ä½ä½æ•°æ®ï¼Œå¦‚r8ï¼ˆqwordï¼‰ï¼Œr8dï¼ˆlower dwordï¼‰ï¼Œr8wï¼ˆlowest wordï¼‰ã€r8bï¼ˆlowest byte MASMé£æ ¼ï¼Œintelé£æ ¼æ˜¯r8lï¼‰ã€‚æ³¨æ„æ²¡æœ‰r8hè¿™ç§è¡¨ç¤ºæ³•ã€‚\nä½¿ç”¨REXæ“ä½œç å‰ç¼€å»è®¿é—®æ–°æ·»åŠ çš„è¿™8ä¸ªé€šç”¨å¯„å­˜å™¨çš„å­—èŠ‚æ—¶ï¼Œæœ‰ä¸€äº›é™åˆ¶ï¼Œä¸èƒ½åƒè®¿é—®ä¹‹å‰çš„8ä¸ªé€šç”¨å¯„å­˜å™¨ä¸€æ ·é€šè¿‡AHã€BHã€CHã€DHæ¥è®¿é—®ï¼Œå¹¶ä¸”ä¸€æ¬¡åªèƒ½è®¿é—®ä¸€ä¸ªï¼ˆå¦‚R11Bï¼‰ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ALã€BLã€CLã€DLï¼Œä¸ºå•¥æ¥ï¼Œå› ä¸ºå®ƒå°±æ˜¯å¼ºåˆ¶è¦æ±‚å°†AHã€BHã€CHã€DHè½¬æ¢æˆBPLã€SPLã€DILã€SILæ¥ä½¿ç”¨ã€‚\n64ä½æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨RIPï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„ä½è´¨ï¼Œå¹¶ä¸”æ”¯æŒ64ä½å¹³å¦å†…å­˜æ¨¡å‹ï¼Œå½“å‰æ“ä½œç³»ç»Ÿä¸­çš„å†…å­˜åœ°å€å¸ƒå±€å°†åœ¨åé¢æåŠã€‚\næ ˆæŒ‡é’ˆå¯„å­˜å™¨RSPï¼ŒæŒ‡å‘å½“å‰åˆšpushè¿›æ ˆçš„å…ƒç´ ç©ºé—´åœ°å€ï¼Œä¹Ÿå°±æ˜¯æ ˆé¡¶äº†ï¼Œæ ˆä»é«˜åœ°å€å‘ä½åœ°å€æ–¹å‘å¢é•¿ã€‚æ ˆç”¨æ¥å­˜å‚¨è°ƒç”¨ä¾‹ç¨‹ï¼ˆå‡½æ•°ï¼‰çš„è¿”å›å€¼ã€ä¼ é€’å‚æ•°ï¼Œæˆ–è€…ç”¨ä»¥æ”¯æŒABIä¸­çš„è°ƒç”¨æƒ¯ä¾‹ï¼ˆå¦‚ä¿å­˜è°ƒç”¨æ–¹ç°åœºï¼‰ã€‚\nRFLAGSå¯„å­˜å™¨ï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›æ ‡è¯†ä¿¡æ¯ï¼Œå®ƒç”¨æ¥æ ‡è¯†ä¸€äº›æ“ä½œçš„ç»“æœï¼ˆå¦‚æ˜¯å¦æº¢å‡ºã€è¿ç®—ç»“æœçš„æ­£è´Ÿç­‰ï¼‰æˆ–è€…æ§åˆ¶å¤„ç†å™¨çš„æ‰§è¡Œã€‚è¿™åœ¨x86 32ä½å¯„å­˜å™¨EFLAGSä¸­å°±å·²ç»å½¢æˆäº†è¿™äº›ï¼Œç°åœ¨åœ¨ä»¥å‰åŸºç¡€ä¸Šåˆæ·»åŠ äº†é«˜32ä½ï¼Œç”¨æ¥é¢„ç•™æ”¯æŒæ‰©å±•ï¼Œå½“å‰æ˜¯æ²¡æœ‰ä½¿ç”¨çš„ã€‚ä¸‹è¡¨åˆ—å‡ºäº†æœ€å¸¸ä½¿ç”¨çš„ä¸€äº›flagsã€‚å¤§å¤šæ•°å…¶ä»–flagsæ˜¯ç”¨äºæ“ä½œç³»ç»Ÿçº§åˆ«çš„ä»»åŠ¡ã€‚\n   Symbol Bit Name Set if\u0026hellip;     CF 0 Carry Operation generated a carry or borrow   PF 2 Parity Last byte has even number of 1\u0026rsquo;s, else 0   AF 4 Adjust Denotes Binary Coded Decimal in-byte carry   ZF 6 Zero Result was 0   SF 7 Sign Most significant bit of result is 1   OF 11 Overflow Overflow on signed operation         DF 10 Direction Direction string instructions operate (increment or decrement)   ID 21 Identification Changeability denotes presence of CPUID instruction    æµ®ç‚¹è¿ç®—å•å…ƒï¼ˆFPUï¼ŒFloating Point Unitï¼‰åŒ…å«äº†8ä¸ªå¯„å­˜å™¨FPR0-FPR7ï¼Œè¿˜æœ‰çŠ¶æ€å¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ï¼Œä»¥åŠå…¶ä»–çš„å‡ ä¸ªå¯„å­˜å™¨ã€‚FPR0-7è¿™å‡ ä¸ªå¯„å­˜å™¨ï¼Œæ¯ä¸ªéƒ½å¯ä»¥å­˜å‚¨ä¸‹è¡¨ä¸­åˆ—å‡ºçš„æ•°æ®ç±»å‹çš„å€¼ã€‚æµ®ç‚¹æ“ä½œéµä»IEEE 754æ ‡å‡†ã€‚æ³¨æ„ï¼Œå¤§å¤šæ•°c/c++ç¼–è¯‘å™¨æ”¯æŒ32ä½å’Œ64ä½çš„floatã€doubleæ•°æ®ç±»å‹ï¼Œä½†æ˜¯æ²¡æœ‰æ”¯æŒ80ä½çš„æµ®ç‚¹æ•°æ®ç±»å‹ï¼Œä½†æ˜¯æ±‡ç¼–æ˜¯æ”¯æŒçš„ã€‚è¿™8ä¸ªå¯„å­˜å™¨å’Œå¦å¤–8ä¸ªMMXï¼Ÿå¯„å­˜å™¨å®é™…ä¸Šæ˜¯å…±äº«çš„åŒä¸€ç»„ç‰©ç†å¯„å­˜å™¨ã€‚",content:"æœ€è¿‘åœ¨å·¥ä½œå’Œå­¦ä¹ ä¸­å‘ç°ï¼Œå…¶å®æ±‡ç¼–æ˜¯éå¸¸é‡è¦çš„ï¼Œå³ä¾¿ç°åœ¨é«˜çº§è¯­è¨€å·²ç»éå¸¸æ–¹ä¾¿äº†ï¼Œä½†æ˜¯äº†è§£æ±‡ç¼–å¯¹äºæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼Œä»¥åŠä¸€äº›é«˜æ·±çš„çŸ¥è¯†ç‚¹æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼Œæ¯”å¦‚è¯´Linuxæ“ä½œç³»ç»Ÿæœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°å«Forkæˆ‘ä»¬éƒ½çŸ¥é“Forkçš„è¿”å›å€¼åœ¨å­è¿›ç¨‹ä¸­æ˜¯0ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­æ˜¯é0ï¼Œé‚£è¿™ä¸ªæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿå¯¹äºä¸äº†è§£æ±‡ç¼–çš„äººä¹Ÿå¾ˆéš¾æœ‰èƒ½åŠ›å»é˜…è¯»Linuxæ“ä½œç³»ç»Ÿæºç ï¼Œåªèƒ½é“å¬é€”è¯´äº†è§£åˆ°ä¸ªå¤§æ¦‚åŸå› ã€‚å†æ¯”å¦‚æ¥ä¸‹æ¥è¦è®²çš„gomonkeyæµ‹è¯•æ¡†æ¶å®ç°çš„ä¸€äº›æŒ‡ä»¤patchingæ“ä½œï¼Œè¿™äº›éƒ½æ˜¯ä¸æ±‡ç¼–æ“ä½œåˆ†ä¸å¼€çš„ã€‚ç”šè‡³ä½ æƒ³äº†è§£ä¸‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä½ éƒ½éœ€è¦æ·±å…¥äº†è§£ä¸‹æŒ‡ä»¤æ‰§è¡Œå‘¨æœŸç­‰ç­‰çš„é—®é¢˜ã€‚\nä¸æ‡‚æ±‡ç¼–ï¼Œä¸å¦¨ç¢ä½ å¼€å‘ä¸Šå±‚åº”ç”¨ï¼Œä½†æ˜¯å¯¹ä½ çš„æ·±åº¦å°±æ˜¯ä¸€é“åï¼Œä½ å¾ˆéš¾è·¨å›½è¿™ä¸ªé¸¿æ²Ÿå»çª¥æ¢æ›´åº•å±‚çš„ä¸€äº›åŸç†ã€‚\næœ‰æ„Ÿè€Œå‘ï¼Œä»Šå¤©å°±å›é¡¾ä¸‹intelå®˜æ–¹å¼€å‘å‘å¸ƒçš„x64æ±‡ç¼–çŸ¥è¯†ï¼Œåšä¸€ä¸ªç®€å•çš„å›é¡¾ï¼Œä¹Ÿä¸ºåé¢ç ”ç©¶gomonkeyæŒ‡ä»¤patchingç­‰ç­‰åšä¸€äº›å‡†å¤‡å’Œé“ºå«ã€‚\nä»‹ç» # å¤§å®¶ä½¿ç”¨x86æ±‡ç¼–æ¥å†™ä¸€äº›å¯¹æ€§èƒ½æ¯”è¾ƒæ•æ„Ÿçš„ç¨‹åºå—¯ï¼Œè¿™ä¸ªæƒ…å†µå·²ç»æŒç»­å¾ˆå¤šå¹´äº†å—¯ï¼Œä½†æ˜¯ç°åœ¨32ä½æœºå™¨åº”é€æ¸è¢«64ä½æœºå™¨å–ä»£äº†ï¼Œå¯¹åº”çš„æ±‡ç¼–ä»£ç ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦å°±æ˜¯ä»‹ç»x64æ±‡ç¼–çš„ï¼Œå¦‚æœä¸äº†è§£x86æ±‡ç¼–ä¹Ÿæ²¡ä»€ä¹ˆå¤§ç¢ï¼Œå½“ç„¶äº†è§£çš„è¯ç†è§£èµ·æ¥ä¼šæ›´ç®€å•ä¸€ç‚¹ã€‚\nx64æ˜¯ä¸€ä¸ªé€šç”¨çš„åå­—ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯å¯¹Intelä»¥åŠAMD 32ä½æŒ‡ä»¤é›†æ¶æ„çš„ä¸€ä¸ª64ä½æ‰©å±•ã€‚AMDé¦–å…ˆå¼•å…¥äº†x64æŒ‡ä»¤é›†ï¼Œæœ€åˆå«x86-64ï¼Œåé¢åˆæ”¹æˆäº†AMD64ã€‚Intelå‘¢ï¼Œå°†å…¶æ”¯æŒ64ä½æŒ‡ä»¤é›†çš„æ¶æ„ç§°ä¹‹ä¸ºIA-32eï¼Œåé¢åˆæ”¹æˆäº†EMT64ã€‚è¿™ä¸¤ä¸ªç‰ˆæœ¬ä¹‹é—´æœ‰ä¸€ç‚¹ç»†å¾®çš„ä¸å…¼å®¹çš„åœ°æ–¹ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æŒ‡ä»¤åœ¨ä¸¤ä¸ªç‰ˆæœ¬ä¸Šéƒ½å¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œç›¸å…³çš„ç»†èŠ‚å¯ä»¥å‚è€ƒIntelå¼€å‘æ‰‹å†ŒIntel 64 And IA-32 Architectures Software Developer\u0026rsquo;s Manualsï¼Œä»¥åŠAMD64æ¶æ„çš„æŠ€æœ¯æ–‡æ¡£ã€‚æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„äº¤é›†éƒ¨åˆ†ç§°ä¹‹ä¸ºx64ã€‚ä¸è¦å°†x64ä¸64ä½Intel Itaniumæ¶æ„ï¼ˆç§°ä¹‹ä¸ºIA-64ï¼‰æ··ä¸ºä¸€è°ˆã€‚\nè¿™ç¯‡æ–‡ç« æ²¡æœ‰æ¶‰åŠç¡¬ä»¶ç›¸å…³çš„ç»†èŠ‚ï¼Œå¦‚cachesã€åˆ†æ”¯é¢„æµ‹ï¼Œä»¥åŠå…¶ä»–é«˜çº§è¯é¢˜ã€‚æ–‡ç« æœ€åä¼šç»™å‡ºä¸€äº›è¿™äº›é¢†åŸŸçš„å‚è€ƒæ‰‹å†Œä¾›äº†è§£æ›´å¤šã€‚\næ±‡ç¼–è¯­è¨€ï¼Œå¾€å¾€ä¼šç”¨æ¥ç¼–å†™å¯¹æ€§èƒ½è¦æ±‚æ¯”è¾ƒè‹›åˆ»çš„ç¨‹åºæˆ–å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ä½†æ˜¯å¯¹å¤§éƒ¨åˆ†æ™®é€šç¨‹åºå‘˜æ¥è¯´ï¼Œä¸å…¶è®©å…¶å†™æ±‡ç¼–ï¼Œè¿˜ä¸å¦‚å†™cc++ç„¶åé…ä¸Šä¸€ä¸ªå¥½çš„ç¼–è¯‘å™¨æ¥çš„å®åœ¨ï¼Œåè€…ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ€§èƒ½å¯èƒ½æ¯”å…¶å†™å‡ºçš„æ±‡ç¼–ä»£ç è´¨é‡æ›´é«˜ã€‚æ±‡ç¼–è¯­è¨€å¯¹äºè°ƒè¯•ä»£ç ä¹Ÿæ˜¯æœ‰ç”¨çš„ï¼Œæœ‰æ—¶ä¸€ä¸ªç¼–è¯‘å™¨å¯èƒ½ç”Ÿæˆäº†ä¸€äº›ä¸æ­£ç¡®çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œé€šè¿‡è°ƒè¯•å™¨åœ¨ç¨‹åºä¸­å•æ­¥è°ƒè¯•å¯ä»¥å¸®åŠ©å®šä½åˆ°é—®é¢˜çš„åŸå› ã€‚ä»£ç ä¼˜åŒ–å™¨ï¼Œæœ‰æ—¶ä¹Ÿä¼šçŠ¯é”™ã€‚æ±‡ç¼–çš„å¦å¤–ä¸€ä¸ªç”¨é€”ï¼Œä½ å¯ä»¥ç”¨å®ƒæ¥ç ”ç©¶æ²¡æœ‰æºç çš„ç¨‹åºã€‚åæ±‡ç¼–è®©ä½ èƒ½å¤Ÿæ”¹å˜ã€ä¿®å¤ç°æœ‰çš„å¯æ‰§è¡Œç¨‹åºï¼ˆæ¨èä¸‹å‡ ä¸ªå·¥å…·hopper or cutterï¼‰ã€‚å¦‚æœä½ æƒ³äº†è§£æˆ–è€…è°ƒæŸ¥ä¸ºä»€ä¹ˆæŸç§ç¼–ç¨‹è¯­è¨€æ¯”è¾ƒæ…¢ï¼Œå…¶ä»–çš„æ¯”è¾ƒå¿«ä¹‹ç±»çš„é—®é¢˜ï¼Œæ±‡ç¼–ä¹Ÿæ˜¯ä½ çš„å¥½å¸®æ‰‹ã€‚æœ€åå§ï¼ŒæŒæ¡æ±‡ç¼–çŸ¥è¯†ï¼Œå¯¹äºè¯Šæ–­ä¸€äº›æ¶æ„è½¯ä»¶ï¼Œä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„æŠ€èƒ½ã€‚\næ¶æ„ # å½“è¦å»å­¦ä¹ ç‰¹å®šå¹³å°çš„æ±‡ç¼–æ—¶ï¼Œé¦–å…ˆåº”è¯¥å­¦ä¹ çš„æ˜¯ï¼Œè¯¥å¹³å°çš„å¯„å­˜å™¨é›†åˆã€‚\né€šç”¨æ¶æ„ # 64ä½å¯„å­˜å™¨å…è®¸å®¹çº³æ›´å¤§çš„å°ºå¯¸çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰çš„æ›´å¤šçš„ç±»å‹ï¼Œå°†1ä¸ªå­—èŠ‚byteå®šä¹‰æˆ8bitsï¼Œå°†1ä¸ªå­—wordå®šä¹‰æˆ16bitsï¼Œå°†ä¸€ä¸ªåŒå­—double wordå®šä¹‰æˆ32bitsï¼Œå°†ä¸€ä¸ªå››å­—quadwordå®šä¹‰æˆ64ä½ï¼Œå°†ä¸€ä¸ªå…«å­—double quadwordå®šä¹‰æˆ128bitsã€‚å…³äºå­—èŠ‚åºçš„é—®é¢˜ï¼ŒIntelæ˜¯å°ç«¯å­—èŠ‚åºï¼Œæ„å‘³ç€ä½æœ‰æ•ˆä½å­˜å‚¨åœ¨å†…å­˜çš„ä½åœ°å€ä¸­ã€‚\nä¸Šå›¾æ˜¾ç¤ºäº†16ä¸ª64bitsçš„é€šç”¨ç›®çš„å¯„å­˜å™¨ï¼Œå‰8ä¸ªè¢«å‘½åæˆraxã€rbxã€rcxã€rdxã€rbpã€rsiã€rdiã€rspï¼Œè¿™ä¸ªå‘½åå’Œå†å²åŸå› æœ‰å…³ç³»ï¼Œåé¢8ä¸ªè¢«å‘½åæˆäº†r8~r15ã€‚å¦‚æœå‰8ä¸ªè‡ªå·±å­˜å™¨åï¼Œå°†å­—ç¬¦ræ¢æˆeï¼Œå°±å˜æˆäº†å¯¹åº”çš„åœ°ä½çš„32ä½å¯„å­˜å™¨ï¼Œæ¯”å¦‚raxçš„ä½32ä½æ˜¯eaxã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœæƒ³è®¿é—®ä½16ä½ï¼Œå°±ç›´æ¥æŠŠå‰ç¼€å»æ‰ï¼Œå¦‚AXå°±æ˜¯è®¿é—®çš„raxçš„ä½16ä½ï¼Œå¦‚æœä½8ä½å‘¢ï¼Œé‚£å°±æ˜¯ALäº†ï¼ŒAHå°±æ˜¯æ¬¡ä½8ä½ï¼ˆ8~15ä½ï¼‰ã€‚æ–°åŠ çš„8ä¸ªå¯„å­˜å™¨r8~r15å¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼æ¥è®¿é—®ä½ä½æ•°æ®ï¼Œå¦‚r8ï¼ˆqwordï¼‰ï¼Œr8dï¼ˆlower dwordï¼‰ï¼Œr8wï¼ˆlowest wordï¼‰ã€r8bï¼ˆlowest byte MASMé£æ ¼ï¼Œintelé£æ ¼æ˜¯r8lï¼‰ã€‚æ³¨æ„æ²¡æœ‰r8hè¿™ç§è¡¨ç¤ºæ³•ã€‚\nä½¿ç”¨REXæ“ä½œç å‰ç¼€å»è®¿é—®æ–°æ·»åŠ çš„è¿™8ä¸ªé€šç”¨å¯„å­˜å™¨çš„å­—èŠ‚æ—¶ï¼Œæœ‰ä¸€äº›é™åˆ¶ï¼Œä¸èƒ½åƒè®¿é—®ä¹‹å‰çš„8ä¸ªé€šç”¨å¯„å­˜å™¨ä¸€æ ·é€šè¿‡AHã€BHã€CHã€DHæ¥è®¿é—®ï¼Œå¹¶ä¸”ä¸€æ¬¡åªèƒ½è®¿é—®ä¸€ä¸ªï¼ˆå¦‚R11Bï¼‰ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ALã€BLã€CLã€DLï¼Œä¸ºå•¥æ¥ï¼Œå› ä¸ºå®ƒå°±æ˜¯å¼ºåˆ¶è¦æ±‚å°†AHã€BHã€CHã€DHè½¬æ¢æˆBPLã€SPLã€DILã€SILæ¥ä½¿ç”¨ã€‚\n64ä½æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨RIPï¼ŒæŒ‡å‘ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„ä½è´¨ï¼Œå¹¶ä¸”æ”¯æŒ64ä½å¹³å¦å†…å­˜æ¨¡å‹ï¼Œå½“å‰æ“ä½œç³»ç»Ÿä¸­çš„å†…å­˜åœ°å€å¸ƒå±€å°†åœ¨åé¢æåŠã€‚\næ ˆæŒ‡é’ˆå¯„å­˜å™¨RSPï¼ŒæŒ‡å‘å½“å‰åˆšpushè¿›æ ˆçš„å…ƒç´ ç©ºé—´åœ°å€ï¼Œä¹Ÿå°±æ˜¯æ ˆé¡¶äº†ï¼Œæ ˆä»é«˜åœ°å€å‘ä½åœ°å€æ–¹å‘å¢é•¿ã€‚æ ˆç”¨æ¥å­˜å‚¨è°ƒç”¨ä¾‹ç¨‹ï¼ˆå‡½æ•°ï¼‰çš„è¿”å›å€¼ã€ä¼ é€’å‚æ•°ï¼Œæˆ–è€…ç”¨ä»¥æ”¯æŒABIä¸­çš„è°ƒç”¨æƒ¯ä¾‹ï¼ˆå¦‚ä¿å­˜è°ƒç”¨æ–¹ç°åœºï¼‰ã€‚\nRFLAGSå¯„å­˜å™¨ï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›æ ‡è¯†ä¿¡æ¯ï¼Œå®ƒç”¨æ¥æ ‡è¯†ä¸€äº›æ“ä½œçš„ç»“æœï¼ˆå¦‚æ˜¯å¦æº¢å‡ºã€è¿ç®—ç»“æœçš„æ­£è´Ÿç­‰ï¼‰æˆ–è€…æ§åˆ¶å¤„ç†å™¨çš„æ‰§è¡Œã€‚è¿™åœ¨x86 32ä½å¯„å­˜å™¨EFLAGSä¸­å°±å·²ç»å½¢æˆäº†è¿™äº›ï¼Œç°åœ¨åœ¨ä»¥å‰åŸºç¡€ä¸Šåˆæ·»åŠ äº†é«˜32ä½ï¼Œç”¨æ¥é¢„ç•™æ”¯æŒæ‰©å±•ï¼Œå½“å‰æ˜¯æ²¡æœ‰ä½¿ç”¨çš„ã€‚ä¸‹è¡¨åˆ—å‡ºäº†æœ€å¸¸ä½¿ç”¨çš„ä¸€äº›flagsã€‚å¤§å¤šæ•°å…¶ä»–flagsæ˜¯ç”¨äºæ“ä½œç³»ç»Ÿçº§åˆ«çš„ä»»åŠ¡ã€‚\n   Symbol Bit Name Set if\u0026hellip;     CF 0 Carry Operation generated a carry or borrow   PF 2 Parity Last byte has even number of 1\u0026rsquo;s, else 0   AF 4 Adjust Denotes Binary Coded Decimal in-byte carry   ZF 6 Zero Result was 0   SF 7 Sign Most significant bit of result is 1   OF 11 Overflow Overflow on signed operation         DF 10 Direction Direction string instructions operate (increment or decrement)   ID 21 Identification Changeability denotes presence of CPUID instruction    æµ®ç‚¹è¿ç®—å•å…ƒï¼ˆFPUï¼ŒFloating Point Unitï¼‰åŒ…å«äº†8ä¸ªå¯„å­˜å™¨FPR0-FPR7ï¼Œè¿˜æœ‰çŠ¶æ€å¯„å­˜å™¨ã€æ§åˆ¶å¯„å­˜å™¨ï¼Œä»¥åŠå…¶ä»–çš„å‡ ä¸ªå¯„å­˜å™¨ã€‚FPR0-7è¿™å‡ ä¸ªå¯„å­˜å™¨ï¼Œæ¯ä¸ªéƒ½å¯ä»¥å­˜å‚¨ä¸‹è¡¨ä¸­åˆ—å‡ºçš„æ•°æ®ç±»å‹çš„å€¼ã€‚æµ®ç‚¹æ“ä½œéµä»IEEE 754æ ‡å‡†ã€‚æ³¨æ„ï¼Œå¤§å¤šæ•°c/c++ç¼–è¯‘å™¨æ”¯æŒ32ä½å’Œ64ä½çš„floatã€doubleæ•°æ®ç±»å‹ï¼Œä½†æ˜¯æ²¡æœ‰æ”¯æŒ80ä½çš„æµ®ç‚¹æ•°æ®ç±»å‹ï¼Œä½†æ˜¯æ±‡ç¼–æ˜¯æ”¯æŒçš„ã€‚è¿™8ä¸ªå¯„å­˜å™¨å’Œå¦å¤–8ä¸ªMMXï¼Ÿå¯„å­˜å™¨å®é™…ä¸Šæ˜¯å…±äº«çš„åŒä¸€ç»„ç‰©ç†å¯„å­˜å™¨ã€‚\n   Data Type Length Precision (bits) Decimal digits Precision Decimal Range     Single Precision 32 24 7 1.1810^-38 to 3.4010^38   Double Precision 64 53 15 2.23 10^-308 to 1.7910^308   Extended Precision 80 64 19 3.3710^-4932 to 1.1810^4932    æœ‰å‡ ä¸ª8ä½æŒ‡ä»¤æ”¯æŒäºŒè¿›åˆ¶ç¼–ç çš„åè¿›åˆ¶ï¼ˆBCDï¼‰ï¼Œæµ®ç‚¹å¯„å­˜å™¨æ”¯æŒçš„å¥‡ç‰¹æ ¼å¼è¿˜æä¾›äº†ä¸€ç§80ä½ï¼Œ17ä½çš„BCDç±»å‹ã€‚\n ä¸ç¡®å®šæ˜¯å¦ç¿»è¯‘æœ‰è¯¯ï¼ŒåŸæ–‡ï¼šBinary Coded Decimal (BCD) is supported by a few 8-bit instructions, and an oddball format supported on the floating point registers gives an 80 bit, 17 digit BCD type.\n è¿™16ä¸ª128bitsçš„XMMå¯„å­˜å™¨ï¼ˆæ¯”x86å¤šäº†8ä¸ªï¼‰åé¢ä¼šæœ‰æ›´è¯¦ç»†ä»‹ç»ã€‚\nè¿˜æœ‰å°±æ˜¯ï¼Œæ®µå¯„å­˜å™¨ï¼ˆåœ¨x64ä¸‹å¤§å¤šæ•°æ²¡æœ‰ç”¨ï¼‰ã€æ§åˆ¶å¯„å­˜å™¨ã€å†…å­˜ç®¡ç†å¯„å­˜å™¨ã€è°ƒè¯•å¯„å­˜å™¨ã€è™šæ‹ŸåŒ–å¯„å­˜å™¨ã€æ€§èƒ½å¯„å­˜å™¨ï¼ˆè·Ÿè¸ªè®°å½•å„ç§ç±»å‹çš„å†…éƒ¨å‚æ•°ï¼Œå¦‚cacheå‘½ä¸­ã€missï¼Œåˆ†æ”¯é¢„æµ‹å‘½ä¸­ã€missï¼Œå¾®ç æ‰§è¡Œï¼Œå®šæ—¶ç­‰ç­‰ï¼‰ã€‚æœ€çªå‡ºçš„æ€§èƒ½ç›¸å…³çš„æ“ä½œç å°±æ˜¯RDTSCï¼Œå®ƒæ˜¯ç”¨æ¥æŠ€æœ¯å¤„ç†å™¨æ—¶é’Ÿå‘¨æœŸçš„ï¼Œç»å¸¸é€šè¿‡å®ƒæ¥æµ‹é‡ä¸€å°æ®µä»£ç çš„æ‰§è¡Œè€—æ—¶ã€‚é€šå¸¸cåº“é‡Œé¢æä¾›çš„å‡½æ•°gettimeofdayæ˜¯æ¯”è¾ƒè€—æ—¶é—´çš„ï¼Œæ‰€ä»¥åœ¨é«˜é¢‘ä½¿ç”¨çš„æ—¶å€™ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œä¸€èˆ¬åœ¨ç½‘ç»œæ¡†æ¶é‡Œé¢åšå®šæ—¶å™¨ã€æ—¶é—´æµ‹é‡ç›¸å…³çš„ä»»åŠ¡ï¼Œæ˜¯ä¼šé€šè¿‡RDTSCæ¥æ¨é€ç³»ç»Ÿæ—¶é—´è¿›è€Œæ¨ç®—è€—æ—¶çš„ï¼ˆåœ¨æˆ‘çš„æ–‡ç« libmillå®šæ—¶å™¨ä¸­ä¹Ÿæœ‰æåŠï¼Œhitzhangjie.gitbook.io/libmillï¼‰ã€‚\næ›´å¤šå…¶ä»–ç»†èŠ‚ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒå…¨5å· \u0026ldquo;Intel 64 And IA-32 Architectures Software Developer\u0026rsquo;s Manuals\u0026rdquo;ï¼Œå¯ä»¥ä»è¿™é‡Œå…è´¹ä¸‹è½½ï¼Œhttp://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.htmlã€‚\nSIMDæ¶æ„ # å•æŒ‡ä»¤å¤šæ•°æ®ï¼ˆSIMDï¼‰æŒ‡ä»¤å¯¹å¤šæ¡æ•°æ®å¹¶è¡Œæ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œè¿™æ˜¯æ±‡ç¼–ä¾‹ç¨‹çš„å¸¸ç”¨ç”¨æ³•ã€‚ MMXå’ŒSSEå‘½ä»¤ï¼ˆåˆ†åˆ«ä½¿ç”¨MMXå’ŒXMMå¯„å­˜å™¨ï¼‰æ”¯æŒSIMDæ“ä½œï¼Œè¯¥æ“ä½œå¯å¹¶è¡Œå¤„ç†å¤šè¾¾å…«æ®µæ•°æ®ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨MMXåœ¨ä¸€æ¡æŒ‡ä»¤ä¸­å°†å…«ä¸ªå­—èŠ‚ä¸å¦å¤–å…«ä¸ªå­—èŠ‚ç›¸åŠ ã€‚\nå…«ä¸ª64ä½MMXå¯„å­˜å™¨MMX0-MMX7æ˜¯FPR0-7çš„åˆ«åï¼Œè¿™æ„å‘³ç€ä»»ä½•å°†FPRå’ŒMMXæ··åˆèµ·æ¥æ“ä½œçš„ä»£ç éƒ½å¿…é¡»å°å¿ƒï¼Œä¸è¦è¦†ç›–æ‰€éœ€çš„å€¼ã€‚ MMXæŒ‡ä»¤å¯¹æ•´æ•°ç±»å‹è¿›è¡Œæ“ä½œï¼Œå…è®¸å¯¹MMXå¯„å­˜å™¨ä¸­çš„å€¼å¹¶è¡Œæ‰§è¡Œå­—èŠ‚ï¼Œå­—å’ŒåŒå­—æ“ä½œã€‚å¤§å¤šæ•°MMXæŒ‡ä»¤ä»¥â€œPâ€å¼€å¤´è¡¨ç¤ºâ€œpackedâ€ã€‚ç®—æœ¯ï¼Œç§»ä½/æ—‹è½¬ï¼Œæ¯”è¾ƒï¼Œä¾‹å¦‚ï¼šPCMPGTBè¡¨ç¤ºâ€œæ¯”è¾ƒpackedçš„çš„æœ‰ç¬¦å·1å­—èŠ‚æ•´æ•°æ˜¯å¦å¤§äºâ€ã€‚\n16ä¸ª128ä½XMMå¯„å­˜å™¨å…è®¸æ¯æ¡æŒ‡ä»¤å¯¹å››ä¸ªå•ç²¾åº¦æˆ–ä¸¤ä¸ªåŒç²¾åº¦å€¼è¿›è¡Œå¹¶è¡Œè¿ç®—ã€‚ä¸€äº›æŒ‡ä»¤è¿˜é€‚ç”¨äºå‹ç¼©å­—èŠ‚ï¼Œå­—ï¼ŒåŒå­—å’Œå››å­—æ•´æ•°ã€‚è¿™äº›ç§°ä¸ºæµå¼SIMDæ‰©å±•ï¼ˆSSEï¼‰çš„æŒ‡ä»¤å…·æœ‰å¤šç§å½¢å¼ï¼šSSEï¼ŒSSE2ï¼ŒSSE3ï¼ŒSSSE3ï¼ŒSSE4ï¼Œä»¥åŠåœ¨æœ¬æ–‡å°åˆ¶ä¹‹æ—¶å¯èƒ½è¿˜ä¼šæ›´å¤šã€‚è‹±ç‰¹å°”å·²ç»å®£å¸ƒäº†è¿™äº›æ‰©å±•ï¼Œç§°ä¸ºè‹±ç‰¹å°”Â®é«˜çº§çŸ¢é‡æ‰©å±•ï¼ˆIntelÂ®AVXï¼‰ï¼Œå…·æœ‰æ–°çš„256ä½å®½æ•°æ®è·¯å¾„ã€‚ SSEæŒ‡ä»¤åŒ…å«å¯¹æµ®ç‚¹å’Œæ•´æ•°ç±»å‹çš„ç§»åŠ¨ï¼Œç®—æœ¯ï¼Œæ¯”è¾ƒï¼Œé‡æ’å’Œæ‹†åŒ…ä»¥åŠæŒ‰ä½è¿ç®—ã€‚æŒ‡ä»¤åç§°åŒ…æ‹¬è¯¸å¦‚PMULHUWå’ŒRSQRTPSä¹‹ç±»çš„ã€‚æœ€åï¼ŒSSEå¼•å…¥äº†ä¸€äº›æœ‰å…³å†…å­˜é¢„å–ï¼ˆå‡ºäºæ€§èƒ½ï¼‰å’Œå†…å­˜å±éšœï¼ˆå‡ºäºå¤šçº¿ç¨‹å®‰å…¨ï¼‰çš„æŒ‡ä»¤ã€‚\nä¸‹è¡¨åˆ—å‡ºäº†ä¸€äº›å‘½ä»¤é›†ï¼Œæ“ä½œçš„å¯„å­˜å™¨ç±»å‹ï¼Œå¹¶è¡Œæ“ä½œçš„é¡¹ç›®æ•°ä»¥åŠé¡¹ç›®ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨SSE3å’Œ128ä½XMMå¯„å­˜å™¨ï¼Œæ‚¨å¯ä»¥å¹¶è¡Œå¤„ç†2ä¸ªï¼ˆå¿…é¡»ä¸º64ä½ï¼‰æµ®ç‚¹å€¼ï¼Œæˆ–è€…å¹¶è¡Œå¤„ç†16ä¸ªï¼ˆå¿…é¡»ä¸ºå­—èŠ‚å¤§å°ï¼‰æ•´æ•°å€¼ã€‚\nä¸ºäº†æ‰¾åˆ°ç»™å®šèŠ¯ç‰‡æ”¯æŒçš„æŠ€æœ¯ï¼Œæœ‰ä¸€æ¡CPUIDæŒ‡ä»¤è¿”å›ç‰¹å®šäºå¤„ç†å™¨çš„ä¿¡æ¯ã€‚\n   Technology Register size/type Item type Items in Parallel     MMX 64 MMX Integer 8, 4, 2, 1   SSE 64 MMX Integer 8,4,2,1   SSE 128 XMM Float 4   SSE2/SSE3/SSSE3\u0026hellip; 64 MMX Integer 2,1   SSE2/SSE3/SSSE3\u0026hellip; 128 XMM Float 2   SSE2/SSE3/SSSE3\u0026hellip; 128 XMM Integer 16,8,4,2,1    å·¥å…· # assemblers # äº’è”ç½‘æœç´¢æ˜¾ç¤ºäº†å…·æœ‰x64åŠŸèƒ½çš„æ±‡ç¼–ç¨‹åºï¼Œä¾‹å¦‚Netwideæ±‡ç¼–ç¨‹åºNASMï¼Œåœ¨NASMåŸºç¡€ä¸Šé‡å†™çš„YASMï¼Œå¿«é€Ÿçš„Flat Assembler FASMå’Œä¼ ç»Ÿçš„Microsoft MASMã€‚ç”šè‡³è¿˜æœ‰ä¸€ä¸ªå…è´¹çš„ç”¨äºx86å’Œx64ç¨‹åºé›†çš„IDEï¼Œç§°ä¸ºWinASMã€‚æ¯ä¸ªæ±‡ç¼–ç¨‹åºå¯¹å…¶ä»–æ±‡ç¼–ç¨‹åºçš„å®å’Œè¯­æ³•éƒ½æœ‰ä¸åŒçš„æ”¯æŒï¼Œå¹¶ä¸æ˜¯å®Œå…¨å…¼å®¹çš„ã€‚\nå¯¹äºä»¥ä¸‹ç¤ºä¾‹ï¼Œæˆ‘ä½¿ç”¨å¹³å°SDKä¸­å…è´¹æä¾›çš„MASMçš„64ä½ç‰ˆæœ¬ML64.EXEã€‚å¯¹äºä»¥ä¸‹ç¤ºä¾‹ï¼Œè¯·æ³¨æ„ï¼ŒMASMè¯­æ³•çš„æ ¼å¼ä¸ºï¼šâ€œæŒ‡ä»¤ ç›®æ ‡æ“ä½œæ•°æˆ–åœ°å€ï¼Œæºæ“ä½œæ•°æˆ–åœ°å€â€ï¼Œæœ‰äº›æ±‡ç¼–å™¨ä¸­çš„è¯­æ³•ä¸­çš„æºæ“ä½œã€ç›®çš„æ“ä½œçš„é¡ºåºæ˜¯åç€çš„ã€‚è¯·å‚è€ƒå¯¹åº”æ±‡ç¼–å™¨çš„è¯­æ³•è¯´æ˜ã€‚\nc/c++ compilers # C/C++ç¼–è¯‘å™¨é€šå¸¸å…è®¸ä½¿ç”¨å†…è”æ±‡ç¼–å°†æ±‡ç¼–åµŒå…¥ä»£ç ä¸­ï¼Œä½†æ˜¯Microsoft Visual Studio C/C++ä¸ºx64ä»£ç åˆ é™¤äº†è¯¥æ±‡ç¼–ï¼Œè¿™å¯èƒ½ç®€åŒ–äº†ä»£ç ä¼˜åŒ–å™¨çš„å·¥ä½œã€‚å‰©ä¸‹ä¸¤ä¸ªé€‰æ‹©ï¼šä½¿ç”¨å•ç‹¬çš„æ±‡ç¼–æ–‡ä»¶å’Œå¤–éƒ¨æ±‡ç¼–å™¨ï¼Œæˆ–ä½¿ç”¨å¤´æ–‡ä»¶â€œ intrn.hâ€ä¸­çš„å†…åœ¨å‡½æ•°ï¼ˆè¯·å‚è§Birtoloå’ŒMSDNï¼‰ã€‚å…¶ä»–ç¼–è¯‘å™¨å…·æœ‰ç±»ä¼¼çš„é€‰é¡¹ã€‚\nä½¿ç”¨å¯å‘å¼çš„ç†ç”±ï¼š\n x64ä¸­ä¸æ”¯æŒå†…è”æ±‡ç¼–äº†ï¼› æ–¹ä¾¿ä½¿ç”¨ï¼Œä½ å¯ä»¥ä½¿ç”¨å˜é‡åï¼Œæ¥ä»£æ›¿å¯¹å¯„å­˜å™¨çš„æ‰‹åŠ¨åˆ†é…ï¼› å¯å‘å¼ç›¸æ¯”å†™æ±‡ç¼–è€Œè¨€æ›´å®¹æ˜“å®ç°è·¨å¹³å°ï¼Œç¼–è¯‘å™¨ä¼šé’ˆå¯¹ä¸åŒçš„å¹³å°åšå¯¹åº”çš„å¯å‘å¼ä¼˜åŒ–å¤„ç†ï¼› é…åˆå¯å‘å¼æ“ä½œï¼Œä¼˜åŒ–å™¨å·¥ä½œçš„æ›´å¥½ï¼›  ä¾‹å¦‚ï¼ŒMicrosoft Visual Studio 2008å°±æœ‰å¯å‘å¼æ“ä½œï¼Œunsigned short _rotr16(unsigned short_rot16 b, unsigned char c)ï¼Œè¿™ä¸ªæ“ä½œå°†ä¸€ä¸ª16ä½æ“ä½œæ•°bä¸­å‘å³rotate cä½ï¼Œå¹¶è¿”å›ç»“æœã€‚ä½¿ç”¨cæ¥å®ç°çš„è¯ï¼Œå¯ä»¥è¿™ä¹ˆå†™unsigned short a1 = (b\u0026gt;\u0026gt;c)|(b\u0026lt;\u0026lt;(16-c))ï¼Œè¿™ä¸ªæ±‡ç¼–å®Œæˆåå¤§çº¦æ˜¯15æ¡æŒ‡ä»¤ï¼ˆdebugæ¨¡å¼ä¸‹ï¼Œå¦‚æœæ˜¯releaseæ¨¡å¼ä¸‹çš„è¯ä¹Ÿå·®ä¸å¤ªå¤šï¼‰ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨å¯å‘å¼æ“ä½œunsigned short a1 = _rotr16(b,c)çš„è¯å‘¢ï¼Œæ±‡ç¼–å®Œæˆååªæœ‰4æ¡æŒ‡ä»¤ï¼Œä½ è¯´å“ªä¸ªæ›´ç‰›é€¼å‘¢ï¼Ÿï¼\næŒ‡ä»¤åŸºç¡€ # å¯»å€æ¨¡å¼ # åœ¨å­¦ä¹ ä¹‹å‰ï¼Œå¾—å…ˆäº†è§£ä¸‹å¯»å€æ¨¡å¼ï¼Œå¯»å€æ¨¡å¼æŒ‡æ˜äº†æŒ‡ä»¤è®¿é—®å¯„å­˜å™¨æˆ–è€…å†…å­˜çš„æ–¹å¼ ï¼Œä»¥ä¸‹æ˜¯å¸¸è§çš„å‡ ç§å¯»å€æ¨¡å¼ï¼š\n  ç«‹å³æ•°å¯»å€ï¼ˆimmediateï¼‰ï¼šæ“ä½œæ•°å°±åœ¨æŒ‡ä»¤ä¸­ï¼Œå¦‚ADD EAX, 14 ;å°†æ“ä½œæ•°14ä¸32ä½å¯„å­˜å™¨EAXä¸­å€¼ç›¸åŠ å¹¶å­˜å‚¨åˆ°EAXä¸­\n  å¯„å­˜å™¨å¯»å€ï¼ˆregister to registerï¼‰ï¼šæ“ä½œæ•°å°±åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¦‚ADD R8L, AL ;å°†ALä¸­çš„å€¼ä¸R8Lä¸­çš„å€¼ç›¸åŠ \n  é—´æ¥å¯»å€ï¼ˆindirectï¼‰ï¼šå°±æ˜¯æŒ‡ä»¤ä¸­ç»™å‡ºçš„ä¸æ˜¯æ“ä½œæ•°æœ¬èº«ï¼Œä¹Ÿä¸æ˜¯æ“ä½œæ•°æœ¬èº«æ‰€åœ¨çš„åœ°å€ï¼Œè€Œæ˜¯å­˜å‚¨æ“ä½œæ•°åœ°å€çš„åœ°å€ï¼Œç”šè‡³æœ‰å¯èƒ½å‡ºç°å¤šé‡é—´å€çš„æƒ…å†µã€‚è¿™æ ·çš„å¯»å€ä¸­å…è®¸ä½¿ç”¨8ï¼Œ16ï¼Œ32ä½åç§»é‡ï¼Œæˆ–è€…ä»»ä½•é€šç”¨ç›®çš„å¯„å­˜å™¨æ¥ä½œä¸ºåŸºåœ°å€æˆ–è€…ç´¢å¼•ï¼Œä¹Ÿå…è®¸ä½¿ç”¨1ï¼Œ2ï¼Œ4ï¼Œ8æ¥å¯¹ç´¢å¼•è¿›è¡Œä¹˜ç§¯è¿ç®—ã€‚ä¹Ÿå¯ä»¥ä¸ºå…¶åŠ ä¸Šæ®µå‰ç¼€ï¼Œå¦‚FS:, GS:ç­‰ï¼Œä½†æ˜¯æ¯”è¾ƒå°‘ä½¿ç”¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼ŒMOV R8W, 1234[8*RAX+RCX] ;å°†åœ°å€8*RAX+RCX+1234å¤„çš„ä¸€ä¸ªwordç§»åŠ¨åˆ°R8Wï¼Œè¿™ç§æ–¹å¼å¸¸ç”¨æ¥è®¿é—®ç»“æ„ä½“æ•°ç»„ä¸­çš„æˆå‘˜ï¼Œ1234å¾€å¾€æ˜¯æ•°ç»„èµ·å§‹åœ°å€ï¼Œ8è¡¨ç¤ºæ•°ç»„å…ƒç´ å¤§å°ï¼ŒRAXè¡¨ç¤ºæ•°ç»„ç´¢å¼•ï¼ŒRCXè¡¨ç¤ºç»“æ„ä½“å­—æ®µç›¸å¯¹ç»“æ„ä½“èµ·å§‹åœ°å€çš„åç§»é‡ã€‚\nè¿™ç§å¯»å€æ–¹å¼ï¼Œèµ·å§‹æœ‰å¾ˆå¤šç§å†™æ³•äº†ï¼Œä¸‹é¢è¿™äº›éƒ½æ˜¯ç­‰ä»·çš„ã€‚\nMOV ECX, dword ptr table[RBX][RDI] MOV ECX, dword ptr table[RDI][RBX] MOV ECX, dword ptr table[RBX+RDI] MOV ECX, dword ptr [table+RBX+RDI]  è¿™é‡Œçš„dword ptrå‘Šè¯‰æ±‡ç¼–å™¨å¦‚ä½•ç¼–ç MOVæŒ‡ä»¤ã€‚\n  RIPç›¸å¯¹å¯»å€ï¼šè¿™æ˜¯x64ä¸­æ–°åŠ çš„å¯»å€æ¨¡å¼ï¼Œå®ƒå…è®¸è®¿é—®ç›¸å¯¹å½“å‰æŒ‡ä»¤åœ°å€æŸåç§»é‡å‡ºçš„æ•°æ®ï¼Œä½¿å¾—å®ç°ä½ç½®æ— å…³çš„ä»£ç æ›´åŠ å®¹æ˜“äº†ã€‚å¦‚MOV AL,[RIP] ;RIPæŒ‡å‘ä¸‹ä¸€æ¡å¾…æ‰§è¡ŒæŒ‡ä»¤çš„ä½è´¨ï¼Œaka NOP NOPã€‚å¯æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰æ±‡ç¼–å™¨éƒ½æ”¯æŒè¿™ç§æ“ä½œï¼ŒMASMå°±ä¸æ”¯æŒï¼Œä½†æ˜¯FASMã€YASMæ”¯æŒã€‚MASMéšå¼åœ°åµŒå…¥äº†RIPç›¸å¯¹å¯»å€ï¼Œå¦‚MOV EAX, TABLE ;ä½¿ç”¨RIPç›¸å¯¹å¯»å€æ¥è·å–è¡¨åœ°å€ã€‚\n  å…¶ä»–æ¯”è¾ƒç‰¹æ®Šçš„å¯»å€ï¼šæœ‰äº›æ“ä½œç ä½¿ç”¨å¯„å­˜å™¨çš„æ–¹å¼æ¯”è¾ƒä¸ä¸€æ ·ï¼Œä¾‹å¦‚ï¼Œæœ‰ç¬¦å·æ•´æ•°é™¤æ“ä½œIDIVï¼Œ128ä½æ“ä½œæ•°RDX:RAXé™¤ä»¥ä¸€ä¸ª64ä½çš„æ“ä½œæ•°ï¼Œä¼šå°†å•†å­˜å‚¨åˆ°RAXä¸­ï¼Œå°†ä½™æ•°å­˜å‚¨åˆ°RDXä¸­ã€‚\n  æŒ‡ä»¤é›† # ä¸‹è¡¨åˆ—å‡ºäº†ä¸€äº›æ¯”è¾ƒå¸¸è§çš„æŒ‡ä»¤ï¼Œå…¶ä¸­*è¡¨ç¤ºæ”¹æŒ‡ä»¤æœ‰å¤šä¸ªæ“ä½œç ï¼Œ*è¡¨ç¤ºåç¼€çš„æ„æ€ï¼š\n   Opcode Meaning Opcode Meaning     MOV Move to/from/between memory and registers AND/OR/XOR/NOT Bitwise operations   CMOV* Various conditional moves SHR/SAR Shift right logical/arithmetic   XCHG Exchange SHL/SAL Shift left logical/arithmetic   BSWAP Byte swap ROR/ROL Rotate right/left   PUSH/POP Stack usage RCR/RCL Rotate right/left through carry bit   ADD/ADC Add/with carry BT/BTS/BTR Bit test/and set/and reset   SUB/SBC Subtract/with carry JMP Unconditional jump   MUL/IMUL Multiply/unsigned JE/JNE/JC/JNC/J* Jump if equal/not equal/carry/not carry/ many others   DIV/IDIV Divide/unsigned LOOP/LOOPE/LOOPNE Loop with ECX   INC/DEC Increment/Decrement CALL/RETCall subroutine/return   NEG Negate NOP No operation   CMP Compare CPUID CPU information    ä¸€ä¸ªå¸¸è§çš„æŒ‡ä»¤å°±æ˜¯LOOPæŒ‡ä»¤ï¼Œå®ƒå°†RCXï¼ŒECXæˆ–è€…CXçš„å€¼å‡å»1ï¼Œç„¶åå¦‚æœç»“æœä¸æ˜¯0çš„è¯ï¼Œå°±æ‰§è¡Œè·³è½¬ï¼Œä¸‹é¢æ˜¯ä¸ªç¤ºä¾‹ï¼š\nXOR	EAX, EAX	; zero out eax MOV ECX, 10 ; loop 10 times Label:	; this is a label in assembly INX EAX ; increment eax LOOP Label	; decrement ECX, loop if not 0  ä¸å¤ªå¸¸è§çš„æ“ä½œç å¯å®ç°å­—ç¬¦ä¸²æ“ä½œï¼Œé‡å¤æŒ‡ä»¤å‰ç¼€ï¼Œç«¯å£I / OæŒ‡ä»¤ï¼Œæ ‡å¿—è®¾ç½®/æ¸…é™¤/æµ‹è¯•ï¼Œæµ®ç‚¹æ“ä½œï¼ˆé€šå¸¸ä»¥Få¼€å¤´ï¼Œå¹¶æ”¯æŒmove fromä¸€ä¸ªæ•´æ•°ã€move toä¸€ä¸ªæ•´æ•°ï¼Œç®—æœ¯ï¼Œæ¯”è¾ƒï¼Œå…ˆéªŒï¼Œä»£æ•°ç§»å…¥/ç§»å‡ºï¼‰ä»¥åŠæ§åˆ¶åŠŸèƒ½ï¼‰ï¼Œç”¨äºå¤šçº¿ç¨‹å’Œæ€§èƒ½é—®é¢˜çš„ç¼“å­˜å’Œå†…å­˜æ“ä½œç ç­‰ã€‚è‹±ç‰¹å°”Â®64å’ŒIA-32ä½“ç³»ç»“æ„è½¯ä»¶å¼€å‘äººå‘˜æ‰‹å†Œç¬¬2å·åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œè¯¦ç»†ä»‹ç»äº†æ¯ä¸ªæ“ä½œç ã€‚\næ“ä½œç³»ç»Ÿ # ä»ç†è®ºä¸Šè®²ï¼Œ64ä½ç³»ç»Ÿå…è®¸å¯»å€2^64å­—èŠ‚çš„æ•°æ®ï¼Œä½†æ˜¯å½“å‰æ²¡æœ‰èŠ¯ç‰‡å…è®¸è®¿é—®æ‰€æœ‰16 EBå­—èŠ‚ï¼ˆ18,446,744,073,709,551,616å­—èŠ‚ï¼‰ã€‚ä¾‹å¦‚ï¼ŒAMDä½“ç³»ç»“æ„ä»…ä½¿ç”¨åœ°å€çš„ä½48ä½ï¼Œå¹¶ä¸”48è‡³63ä½å¿…é¡»æ˜¯47ä½çš„å‰¯æœ¬ï¼Œå¦åˆ™å¤„ç†å™¨ä¼šå¼•å‘å¼‚å¸¸ã€‚å› æ­¤ï¼Œåœ°å€ä¸º0åˆ°00007FFFFFFFFFFFï¼Œä»FFFF800000000000åˆ°FFFFFFFFFFFFFFFFï¼Œæ€»å…±æœ‰256 TBï¼ˆ281,474,976,710,656å­—èŠ‚ï¼‰çš„å¯ç”¨è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚å¦ä¸€ä¸ªç¼ºç‚¹æ˜¯ï¼Œè¦å¯»å€æ‰€æœ‰64ä½å†…å­˜ï¼Œéœ€è¦æ›´å¤šçš„é¡µè¡¨ä¾›OSå­˜å‚¨ï¼Œéœ€è¦ä½¿ç”¨å®è´µçš„å†…å­˜ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè€Œä¸æ˜¯ç‰©ç†åœ°å€ã€‚\nç»“æœï¼Œè®¸å¤šæ“ä½œç³»ç»Ÿä½¿ç”¨æ­¤ç©ºé—´çš„ä¸ŠåŠéƒ¨åˆ†ï¼Œä»é¡¶éƒ¨å¼€å§‹ï¼Œç„¶åå‘ä¸‹æ‰©å±•ï¼›è€Œç”¨æˆ·ç¨‹åºåˆ™ä½¿ç”¨ä¸‹åŠéƒ¨åˆ†ï¼Œä»åº•éƒ¨å¼€å§‹ï¼Œç„¶åå‘ä¸Šæ‰©å±•ã€‚å½“å‰çš„Windows *ç‰ˆæœ¬ä½¿ç”¨44ä½å¯»å€ï¼ˆ16 TB = 17,592,186,044,416å­—èŠ‚ï¼‰ã€‚ç»“æœåœ°å€å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ç”±äºåœ°å€æ˜¯ç”±OSåˆ†é…çš„ï¼Œå› æ­¤ç»“æœåœ°å€å¯¹ç”¨æˆ·ç¨‹åºè€Œè¨€ä¸å¤ªé‡è¦ï¼Œä½†æ˜¯ç”¨æˆ·åœ°å€å’Œå†…æ ¸åœ°å€ä¹‹é—´çš„åŒºåˆ«å¯¹äºè°ƒè¯•å¾ˆæœ‰ç”¨ã€‚\næœ€åä¸€ä¸ªä¸OSç›¸å…³çš„é—®é¢˜ä¸å¤šçº¿ç¨‹ç¼–ç¨‹æœ‰å…³ï¼Œä½†æ˜¯æ­¤ä¸»é¢˜å¤ªå¤§ï¼Œæ— æ³•åœ¨æ­¤å¤„è®¨è®ºã€‚å”¯ä¸€è¦æåˆ°çš„æ˜¯ï¼Œæœ‰å†…å­˜å±éšœæ“ä½œç å¯å¸®åŠ©ä¿æŠ¤å…±äº«èµ„æºä¸å—ç ´åã€‚\nè°ƒç”¨çº¦å®š # æ¯ç§æ¶æ„éƒ½æœ‰è‡ªå·±çš„ä¾‹ç¨‹ï¼ˆå‡½æ•°ï¼‰è°ƒç”¨çš„ä¸€äº›çº¦æŸï¼Œæ“ä½œç³»ç»Ÿä¸å¯¹åº”æ¶æ„çš„CPUæ‰“äº¤é“éƒ½å¿…é¡»è¦è€ƒè™‘å¦‚ä½•ä¼ é€’å¯¹åº”çš„å‚æ•°ã€å¦‚ä½•è·å–è¿”å›å€¼çš„é—®é¢˜ï¼Œè¿™é‡Œçš„å…·ä½“åˆ°æŸä¸ªå¹³å°çš„çº¦æŸï¼Œå°±ç§°ä¸ºè°ƒç”¨çº¦å®šã€‚\nå¸¸è§çš„x64è°ƒç”¨çº¦å®šæ˜¯ç”¨äºCæ ·å¼å‡½æ•°è°ƒç”¨çš„Microsoft 64è°ƒç”¨çº¦å®šï¼ˆè¯·å‚é˜…MSDNï¼ŒChenå’ŒPietrekï¼‰ã€‚åœ¨Linuxä¸‹ï¼Œä¹Ÿå°†å…¶ç§°ä¸ºåº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ï¼ˆABIï¼‰ã€‚\nè¯·æ³¨æ„ï¼Œæ­¤å¤„æ¶‰åŠçš„è°ƒç”¨çº¦å®šä¸x64 Linuxç³»ç»Ÿä¸Šä½¿ç”¨çš„çº¦å®šä¸åŒï¼šå¯¹äºMicrosoft x64è°ƒç”¨çº¦å®šï¼Œé™„åŠ çš„å¯„å­˜å™¨ç©ºé—´ä½¿fastcallæˆä¸ºå”¯ä¸€çš„è°ƒç”¨çº¦å®šï¼ˆåœ¨x86ä¸‹æœ‰å¾ˆå¤šï¼šstdcallï¼Œthiscallï¼Œfastcallï¼Œcdeclç­‰ï¼‰ã€‚ä¸C / C ++æ ·å¼å‡½æ•°æ¥å£çš„è§„åˆ™ï¼š\n RCX, RDX, R8, R9 are used for integer and pointer arguments in that order left to right. XMM0, 1, 2, and 3 are used for floating point arguments. Additional arguments are pushed on the stack left to right. Parameters less than 64 bits long are not zero extended; the high bits contain garbage. It is the caller\u0026rsquo;s responsibility to allocate 32 bytes of \u0026ldquo;shadow space\u0026rdquo; (for storing RCX, RDX, R8, and R9 if needed) before calling the function. It is the caller\u0026rsquo;s responsibility to clean the stack after the call. Integer return values (similar to x86) are returned in RAX if 64 bits or less. Floating point return values are returned in XMM0. Larger return values (structs) have space allocated on the stack by the caller, and RCX then contains a pointer to the return space when the callee is called. Register usage for integer parameters is then pushed one to the right. RAX returns this address to the caller. The stack is 16-byte aligned. The \u0026ldquo;call\u0026rdquo; instruction pushes an 8-byte return value, so the all non-leaf functions must adjust the stack by a value of the form 16n+8 when allocating stack space. Registers RAX, RCX, RDX, R8, R9, R10, and R11 are considered volatile and must be considered destroyed on function calls. RBX, RBP, RDI, RSI, R12, R14, R14, and R15 must be saved in any function using them. Note there is no calling convention for the floating point (and thus MMX) registers. Further details (varargs, exception handling, stack unwinding) are at Microsoft\u0026rsquo;s site.  æˆ‘ä»¬å†çœ‹ä¸‹Linux manæ‰‹å†Œï¼Œè¿™é‡Œæ•´ç†äº†ä¸¤å¼ è°ƒç”¨çº¦å®šç›¸å…³çš„è¡¨: https://man7.org/linux/man-pages/man2/syscall.2.htmlï¼Œè¯»åå¯ä»¥åŠ æ·±æˆ‘ä»¬å¯¹è°ƒç”¨çº¦å®š or ABIçš„è®¤è¯†ã€‚\n ## ç¤ºä¾‹ ### MessageBox å‰é¢è®²è¿™ä¹ˆå¤šï¼Œç°åœ¨ç”¨ä¸Šé¢è®²è¿‡çš„å†…å®¹æ¥å†™ä¸€ä¸ªdemoå±•ç¤ºä¸‹x64æ±‡ç¼–çš„ä½¿ç”¨ï¼Œç¬¬ä¸€ä¸ªdemoæ˜¯ä¸€ä¸ªx64ç‹¬ç«‹å¯è¿è¡Œçš„ç¨‹åºï¼Œè¿è¡Œä¹‹åä¼šå¼¹å‡ºä¸€ä¸ªWindows MessageBoxã€‚ ```asm ; Sample x64 Assembly Program ; Chris Lomont 2009 www.lomont.org extrn ExitProcess: PROC ; external functions in system libraries extrn MessageBoxA: PROC .data caption db '64-bit hello!', 0 message db 'Hello World!', 0 .code Start PROC sub rsp,28h ; shadow space, aligns stack mov rcx, 0 ; hWnd = HWND_DESKTOP lea rdx, message ; LPCSTR lpText lea r8, caption ; LPCSTR lpCaption mov r9d, 0 ; uType = MB_OK call MessageBoxA ; call MessageBox API function mov ecx, eax ; uExitCode = MessageBox(...) call ExitProcess Start ENDP End  å°†ä¸Šè¿°æ±‡ç¼–ç¨‹åºä¿å­˜ä¸ºhello.asmï¼Œç„¶åä½¿ç”¨ML64è¿›è¡Œç¼–è¯‘ï¼Œåœ¨Microsoft Windows x64 SDKä¸­æœ‰è¿™ä¸ªç¨‹åºçš„ï¼Œè¿™ä¹ˆç¼–è¯‘ï¼š\nml64 hello.asm /link /subsystem:windows /defaultlib:kernel32.lib /defaultlib:user32.lib /entry:Start  æ‰§è¡Œå®Œæˆåä¼šæ„å»ºå‡ºä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼ˆå·²ç»é“¾æ¥å¥½åº“å‡½æ•°ã€å¯åŠ¨ä»£ç äº†ï¼‰ï¼Œè¿è¡Œè¿™ä¸ªç¨‹åºhello.exeï¼Œå°±ä¼šçœ‹åˆ°å¼¹å‡ºä¸€ä¸ªæ¶ˆæ¯çª—å£ã€‚\n# ç¬¬äºŒä¸ªç¤ºä¾‹ï¼Œæ˜¯åœ¨Visual Studio 2008è¿™ä¸ªIDEä¸­ï¼Œåœ¨C/C++æ–‡ä»¶ä¸­å¼•ç”¨ä¸€ä¸ªx64æ±‡ç¼–æ–‡ä»¶ä¸­çš„ä»£ç ï¼Œè¿˜è®°å¾—Visual Studioåç»­åˆ é™¤äº†å¯¹æ”¯æŒå†…è”æ±‡ç¼–çš„æ”¯æŒå§ã€‚å¥½ã€‚\n Create a new empty C++ console project. Create a function you\u0026rsquo;d like to port to assembly, and call it from main. To change the default 32-bit build, select Build/Configuration Manager. Under Active Platform, select New\u0026hellip; Under Platform, select x64. If it does not appear figure out how to add the 64-bit SDK tools and repeat. Compile and step into the code. Look under Debug/Windows/Disassembly to see the resulting code and interface needed for your assembly function. Create an assembly file, and add it to the project. It defaults to a 32 bit assembler which is fine. Open the assembly file properties, select all configurations, and edit the custom build step. Put command line ml64.exe /DWIN_X64 /Zi /c /Cp /Fl /Fo $(IntDir)\\$(InputName).obj $(InputName).asm j:w    okï¼Œä¸‹é¢å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªc++æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼Œmainé‡Œé¢ä¼šè°ƒç”¨ä¸¤ä¸ªå‡½æ•°CombineCã€CombineAå…ˆåæ‰“å°å‡ºè®¡ç®—çš„ç»“æœï¼Œå®é™…ä¸Šæˆ‘ä»¬å‡†å¤‡è®©CombineAå’ŒCombineCå®ç°å®Œå…¨ä¸€è‡´çš„é€»è¾‘ï¼ŒåŒºåˆ«å°±æ˜¯CombineAæ˜¯åœ¨å¤–éƒ¨çš„æ±‡ç¼–æ–‡ä»¶ä¸­å®ç°çš„ã€‚\n// C++ code to demonstrate x64 assembly file linking #include \u0026lt;iostream\u0026gt; using namespace std; double CombineC(int a, int b, int c, int d, int e, double f) { return (a+b+c+d+e)/(f+1.5); } // NOTE: è¿™é‡Œå¿…é¡»åŠ ä¸Šextern \u0026quot;C\u0026quot;æ¥é˜»æ­¢C++ name manglingï¼Œå¦åˆ™è¿æ¥çš„æ—¶å€™ä¼šå‡ºç°ç¬¦å·è§£æé”™è¯¯ extern \u0026quot;C\u0026quot; double CombineA(int a, int b, int c, int d, int e, double f); int main(void) { cout \u0026lt;\u0026lt; \u0026quot;CombineC: \u0026quot; \u0026lt;\u0026lt; CombineC(1,2,3,4, 5, 6.1) \u0026lt;\u0026lt; endl; cout \u0026lt;\u0026lt; \u0026quot;CombineA: \u0026quot; \u0026lt;\u0026lt; CombineA(1,2,3,4, 5, 6.1) \u0026lt;\u0026lt; endl; return 0; }  å¥½çš„ï¼Œä¸‹é¢ç»§ç»­å†™æ±‡ç¼–æ–‡ä»¶ï¼š\nfile: CombineA.asm\n.code PUBLIC CombineA CombineA PROC ADD ECX, DWORD PTR [RSP+28H] ; add overflow parameter to first parameter ADD ECX, R9D ; add other three register parameters ADD ECX, R8D ; ADD ECX, EDX ; MOVD XMM0, ECX ; move doubleword ECX into XMM0 CVTDQ2PD XMM0, XMM0 ; convert doubleword to floating point MOVSD XMM1, realVal ; load 1.5 ADDSD XMM1, MMWORD PTR [RSP+30H] ; add parameter DIVSD XMM0, XMM1 ; do division, answer in xmm0 RET ; return CombineA ENDP End  ç¼–è¯‘å¹¶è¿è¡Œä¸Šè¿°ç¨‹åºï¼Œä¼šå‘ç°è¾“å‡ºäº†ä¸¤æ¬¡1.97368ï¼Œç¬¬ä¸€æ¬¡æ˜¯CombineCçš„è¿ç®—ç»“æœï¼Œç¬¬äºŒæ¬¡å°±æ˜¯æ±‡ç¼–å®ç°çš„CombineAçš„è¿ç®—ç»“æœ\næ€»ç»“ # è¿™æ˜¯å¯¹x64æ±‡ç¼–ç¼–ç¨‹çš„å¿…è¦çš„ç®€è¦ä»‹ç»ã€‚ä¸‹ä¸€æ­¥æ˜¯æµè§ˆã€Šè‹±ç‰¹å°”Â®64å’ŒIA-32æ¶æ„è½¯ä»¶å¼€å‘äººå‘˜æ‰‹å†Œã€‹ã€‚ç¬¬1å·åŒ…å«ä½“ç³»ç»“æ„çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚æœæ‚¨çŸ¥é“æ±‡ç¼–çš„è¯ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€å§‹ã€‚å…¶ä»–åœ°æ–¹æ˜¯æ±‡ç¼–ä¹¦ç±æˆ–åœ¨çº¿æ±‡ç¼–æ•™ç¨‹ã€‚ä¸ºäº†äº†è§£ä»£ç çš„æ‰§è¡Œæ–¹å¼ï¼ŒæŒ‡å¯¼æ‚¨åœ¨è°ƒè¯•å™¨ä¸­é€æ­¥æ‰§è¡Œä»£ç ï¼ŒæŸ¥çœ‹åæ±‡ç¼–ï¼Œç›´åˆ°æ‚¨å¯ä»¥é˜…è¯»æ±‡ç¼–ä»£ç ä»¥åŠæ‚¨å–œæ¬¢çš„è¯­è¨€ä¸ºæ­¢ï¼Œè¿™å¯¹æ‚¨å¾ˆæœ‰å¸®åŠ©ã€‚å¯¹äºC / C ++ç¼–è¯‘å™¨ï¼Œè°ƒè¯•ç‰ˆæœ¬æ¯”å‘è¡Œç‰ˆæœ¬æ›´å®¹æ˜“é˜…è¯»ï¼Œå› æ­¤è¯·ç¡®ä¿ä»æ­¤å¤„å¼€å§‹ã€‚æœ€åï¼Œé˜…è¯»masm32.comä¸Šçš„è®ºå›ä»¥è·å–å¤§é‡ææ–™ã€‚\nå‚è€ƒå†…å®¹ #  åŸæ–‡åœ°å€: https://software.intel.com/content/www/us/en/develop/articles/introduction-to-x64-assembly.html NASM: http://www.nasm.us/ YASM: http://www.tortall.net/projects/yasm/ Flat Assembler (FASM): http://www.flatassembler.net/ \u0026ldquo;IntelÂ® 64 and IA-32 Architectures Software Developer\u0026rsquo;s Manuals,\u0026rdquo; available online at http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html \u0026ldquo;Compiler Intrinsics\u0026rdquo;, available online at http://msdn.microsoft.com/en-us/library/26td21ds.aspx Matt Pietrek, \u0026ldquo;Everything You Need To Know To Start Programming 64-Bit Windows Systems\u0026rdquo;, available online at http://msdn.microsoft.com/en-us/magazine/cc300794.aspx, 2009. IntelÂ® 64 and IA-32 Architectures Software Developer Manuals  "}),a.add({id:257,href:"/tags/goconvey/",title:"goconvey",description:"",content:""}),a.add({id:258,href:"/tags/gomonkey/",title:"gomonkey",description:"",content:""}),a.add({id:259,href:"/tags/gostub/",title:"gostub",description:"",content:""}),a.add({id:260,href:"/tags/gotest/",title:"gotest",description:"",content:""}),a.add({id:261,href:"/tags/test/",title:"test",description:"",content:""}),a.add({id:262,href:"/blog/2020-08-19-go%E5%BC%80%E5%8F%91%E5%A6%82%E4%BD%95%E5%81%9A%E6%B5%8B%E8%AF%95%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/",title:"é€‰æ‹©åˆé€‚çš„æµ‹è¯•æ¡†æ¶",description:"å¼€å‘é™¤äº†ç¼–å†™ä»£ç ï¼Œä¹Ÿåº”è¯¥å…³æ³¨å¦‚ä½•ä¿è¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä»¥åŠç»´æŠ¤æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚æœ€è¿‘å›¢é˜Ÿå¯¹å•æµ‹è¦æ±‚ä¸æ–­æé«˜ï¼Œä¹Ÿå°†ä¹‹å‰æ”¶é›†ã€ç§¯ç´¯çš„ä¸€ç‚¹æµ‹è¯•ç›¸å…³çš„å†…å®¹è®°å½•åˆ†äº«ä¸‹ã€‚è¿™ç¯‡ä¸»è¦æ€»ç»“ä¸‹å¸¸è§çš„æµ‹è¯•æ¡†æ¶çš„ä¼˜ç¼ºç‚¹ã€‚",content:"å¼€å‘é™¤äº†ç¼–å†™ä»£ç ï¼Œä¹Ÿåº”è¯¥å…³æ³¨å¦‚ä½•ä¿è¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä»¥åŠç»´æŠ¤æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚æœ€è¿‘å›¢é˜Ÿå¯¹å•æµ‹è¦æ±‚ä¸æ–­æé«˜ï¼Œä¹Ÿå°†ä¹‹å‰æ”¶é›†ã€ç§¯ç´¯çš„ä¸€ç‚¹æµ‹è¯•ç›¸å…³çš„å†…å®¹è®°å½•åˆ†äº«ä¸‹ã€‚è¿™ç¯‡ä¸»è¦æ€»ç»“ä¸‹å¸¸è§çš„æµ‹è¯•æ¡†æ¶çš„ä¼˜ç¼ºç‚¹ã€‚\nå¦‚ä½•åšå¥½æµ‹è¯•ï¼Œæ˜¯ä¸€é—¨ç³»ç»Ÿæ€§çš„æ–¹æ³•å­¦ï¼Œè€Œä¸åªæ˜¯ä¸€äº›é›¶é›¶æ•£æ•£çš„ç»éªŒã€‚æ ¹æ®æµ‹è¯•ç›®çš„çš„ä¸åŒï¼Œå¯¹æµ‹è¯•æ–¹æ³•å¯ä»¥ä½œå¦‚ä¸‹åˆ†ç±»ï¼š\n ç¨³å®šæ€§æµ‹è¯• å‹åŠ›æµ‹è¯• å›å½’æµ‹è¯• å†’çƒŸæµ‹è¯• æ€§èƒ½æµ‹è¯• åŠŸèƒ½æµ‹è¯• å®‰å…¨æµ‹è¯• å¯ç”¨æ€§æµ‹è¯• \u0026hellip;  è¿™ä¹ˆå¤šçš„æµ‹è¯•æ–¹æ³•ï¼Œæœ€åˆæˆ‘è¿˜æ˜¯åœ¨å¡«å†™ä¸€é¡¹IntelliJ IDEAå‘èµ·çš„é—®å·è°ƒæŸ¥æ—¶äº†è§£åˆ°çš„ï¼Œåé¢åœ¨ç ”å‘è¿‡ç¨‹ä¸­ä¹Ÿæ¸æ¸åŠ æ·±äº†å¯¹è¿™äº›æµ‹è¯•æ–¹æ³•çš„è®¤è¯†ã€‚è¿™é‡Œé¢çš„æ¯ä¸€é¡¹æµ‹è¯•ï¼Œæˆ‘è®¤ä¸ºå¼€å‘éƒ½æ˜¯åº”è¯¥å»äº†è§£çš„ã€‚\nå¾ˆå¤šæµ‹è¯•æ–¹æ³•æ˜¯é€šç”¨çš„ï¼Œå’Œå…·ä½“è¯­è¨€æ— å…³ï¼Œè¿™ç¯‡æ–‡ç« åªé‡ç‚¹å…³æ³¨goå¼€å‘å¦‚ä½•åšå•å…ƒæµ‹è¯•ã€‚è¿™æ˜¯æ¯ä½å¼€å‘é¦–å…ˆåº”è¯¥æŒæ¡èµ·æ¥çš„ï¼Œå®ƒæ˜¯å…¶ä»–æµ‹è¯•å¾—ä»¥é¡ºåˆ©å±•å¼€çš„åŸºç¡€ã€‚\nå¼€å‘åœ¨ç¼–ç é˜¶æ®µï¼Œåº”è¯¥åœ¨æœ¬åœ°å®Œæˆå•æµ‹ç›¸å…³çš„å·¥ä½œï¼Œä¿è¯æµ‹è¯•ç”¨ä¾‹é€šè¿‡ï¼Œåœ¨è‡ªåŠ¨åŒ–æ„å»ºé˜¶æ®µåº”è¯¥æœ‰èƒ½åŠ›æ‰§è¡Œä¸€äº›è·‘å•æµ‹ã€BVTæµ‹è¯•çš„ä»»åŠ¡ï¼Œé€šè¿‡åæ‰å…è®¸æäº¤ç»™æµ‹è¯•å›¢é˜Ÿã€‚å½“ç„¶ç°åœ¨EPCå®è¡Œèµ·æ¥ä¹‹åï¼Œå¤§éƒ¨åˆ†å›¢é˜Ÿéƒ½æ˜¯è¿™ä¹ˆæ‰§è¡Œçš„äº†ã€‚\nç ”å‘æ•ˆèƒ½è¦æ±‚æå‡ä»£ç åº“çš„æµ‹è¯•è¦†ç›–ç‡ï¼Œè¦æé«˜æµ‹è¯•çš„ä»·å€¼ï¼Œæˆ‘ä»¬å¾—å…ˆå­¦äº›ä¸‹æŒæ¡æ¯”è¾ƒå¥½çš„æµ‹è¯•çš„æ–¹æ³•ã€‚\nå‚è€ƒäº†ä¸‹goæµ‹è¯•çš„ä¸€äº›å®è·µï¼Œä¸šåŠ¡ä¸­è‚¯å®šä¼šé‡åˆ°å¦‚ä¸‹è¿™äº›æƒ…å†µï¼Œæˆ–å¤šæˆ–å°‘ï¼š\n æ–°è€æœåŠ¡éƒ½æœ‰æ¯”è¾ƒå¤šçš„å¤–éƒ¨ä¾èµ–ï¼Œæ¯”å¦‚ç½‘ç»œè°ƒç”¨ã€è¯»dbç­‰ å­˜é‡æœåŠ¡ç»´æŠ¤ã€å¼€å‘ï¼Œæœ‰äº›ä¸é€‚åˆå¤§èŒƒå›´é‡æ„çš„ æµ‹è¯•ä¸è¦ä¾µå…¥ä¸šåŠ¡ä»£ç ï¼Œä¸èƒ½ä¸ºäº†æµ‹è¯•å†™å¤ªå¤šä¸ç›¸å¹²çš„ä¸œè¥¿  goå•æµ‹ä¸­ä½¿ç”¨çš„æ¯”è¾ƒå¤šçš„ï¼Œå¤§è‡´æœ‰å¦‚ä¸‹è¿™äº›é€‰æ‹©ï¼Œ gomock+gostub+gomonkey+goconveyï¼Œç°åœ¨goç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯è¿™å‡ ä¸ªï¼Œæˆ‘æ¯”è¾ƒæ¨ègomockã€gomonkeyï¼Œçœ‹æƒ…å†µï¼Œçµæ´»ç»„åˆä½¿ç”¨å§ï¼Œå…ˆæ€»ç»“ä¸‹è¿™å‡ ä¸ªçš„ä½¿ç”¨æ–¹å¼ã€ä¼˜ç¼ºç‚¹ã€‚\n gomockæ˜¯åŸºäºinterfaceçš„ï¼Œmockgenç”Ÿæˆinterfaceå¯¹åº”çš„mockæ¡©ä»£ç ï¼Œç„¶åå†å»å†™mockä»£ç ã€‚ å¦‚æœå‰æœŸæ²¡è¿™äº›interfaceè®¾è®¡çš„è¯ï¼Œä¹Ÿä¸æ–¹ä¾¿æµ‹è¯•ã€‚æœ‰çš„è¯ï¼Œçœ‹èµ·æ¥ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ã€‚ gostubæ”¯æŒå¯¹å˜é‡ã€æ–¹æ³•ã€è¿‡ç¨‹è¿›è¡Œmockï¼Œä½†æ˜¯ç”¨ä¸Šå®ƒï¼Œå­˜é‡ä»£ç çš„è¯å°±è¦åšäº›è°ƒæ•´ï¼Œå¯¹ä»£ç æœ‰ä¾µå…¥ï¼Œ å› ä¸ºå®ƒæ˜¯åŸºäºå˜é‡å»ä½œmockï¼Œæ¯”å¦‚func Hello(\u0026hellip;)è¦æ”¹æˆvar Hello=func(\u0026hellip;)æ‰èƒ½ç”¨ gomonkeyä¹Ÿæ”¯æŒå¯¹å˜é‡ã€æ–¹æ³•ã€è¿‡ç¨‹è¿›è¡Œmockï¼Œæˆ‘ç°åœ¨æ„Ÿè§‰è¿™ä¸ªæ¯”è¾ƒå¥½ç”¨ï¼Œç®€å•ï¼Œå¯¹ä»£ç æ— ä¾µå…¥ï¼Œ å’Œgostubå®ç°åŸç†ä¸å¤ªä¸€æ ·ï¼Œæ¯”å¦‚å‡½æ•°ï¼Œå®ƒé€šè¿‡æ±‡ç¼–è°ƒæ•´è·³è½¬åœ°å€ï¼Œè¿™ä¹ˆç€å¯¹å†…è”å‡½æ•°å°±æ”¯æŒä¸åˆ°äº†ï¼Œå°±å¾—-gcflags=\u0026ldquo;all=-l\u0026quot;ç¦ç”¨å†…è” goconveyä¸»è¦æ˜¯ç”¨æ¥æ›´å¥½åœ°ç®¡ç†æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥æ ¹æ®æƒ…å†µç”¨æˆ–è€…ä¸ç”¨  è¿™é‡Œæœ‰å‡ ç¯‡æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å…ˆçœ‹ä¸‹ï¼š\n ç»„åˆçµæ´»ä½¿ç”¨ï¼Œgomock+gostub+gomonkey+goconveyï¼šhttps://www.jianshu.com/p/2f675d5e334e gomonkeyå®ç°åŸç†ï¼šhttps://bouk.co/blog/monkey-patching-in-go/  åœ¨æ·±åº¦ä½¿ç”¨ä¸Šè¿°å‡ ä¸ªæµ‹è¯•æ¡†æ¶ä¹‹åï¼Œä¸ªäººæ„Ÿè§‰gomonkey+goconveryç»„åˆæ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œgoconveyä¹Ÿå¯ä»¥è€ƒè™‘ç”¨go testingæ¡†æ¶t.Runä»£æ›¿æ¥ç»´æŠ¤å­æµ‹è¯•ã€‚\nå¾ˆå¤šåŒå­¦å¯¹å¼€å‘é˜¶æ®µå†™å•æµ‹ï¼Œå¤šå°‘è¿˜æ˜¯æœ‰äº›æŠµè§¦çš„ï¼Œå¸¸è§çš„ç†ç”±å¤§å¤šæ˜¯æ²¡æ—¶é—´å†™å•æµ‹ã€‚æˆ‘çš„ç†è§£æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸ªå› æœå€’ç½®çš„é—®é¢˜ï¼Œå†™å•æµ‹çš„ç›®çš„å¹¶ä¸æ˜¯ä¸ºäº†å†™è€Œå†™ï¼Œå†™å•ä¾§çš„ç›®çš„æ˜¯ä¸ºäº†éªŒè¯ä½ çš„é€»è¾‘æˆ–è€…æµ‹è¯•å…ˆè¡Œé©±åŠ¨é€»è¾‘å¼€å‘ï¼Œç”šè‡³è¿˜ä¼šä¸ºåç»­çš„ä¿®æ”¹ä¿é©¾æŠ¤èˆªã€‚\nåœ¨å¼€å‘é˜¶æ®µå†™å•æµ‹ï¼Œå®¢è§‚ä¸Šä¼šèŠ±äº›æ—¶é—´ï¼Œä½†æ˜¯ä¹Ÿä¼šèŠ‚çœé¢‘ç¹æäº¤æ„å»ºã€éƒ¨ç½²ã€æµ‹è¯•çš„æ—¶é—´ï¼Œå¼€å‘é˜¶æ®µåœ¨ä¸Šè¿°æ“ä½œä¸­é¢‘ç¹åˆ‡æ¢çš„æ¬¡æ•°ä¼šå¤§å¹…å‡å°‘ã€‚\næˆ‘çš„ä½“éªŒæ˜¯è¿™æ ·çš„ï¼Œä»…ä¾›å‚è€ƒã€‚\n"}),a.add({id:263,href:"/blog/2020-08-19-go%E5%BC%80%E5%8F%91%E5%A6%82%E4%BD%95%E5%81%9A%E6%B5%8B%E8%AF%95%E8%A1%A8%E9%A9%B1%E5%8A%A8%E6%B5%8B%E8%AF%95/",title:"goå¼€å‘å¦‚ä½•åšæµ‹è¯•ï¼šè¡¨é©±åŠ¨æµ‹è¯•",description:"å¼€å‘é™¤äº†ç¼–å†™ä»£ç ï¼Œä¹Ÿåº”è¯¥å…³æ³¨å¦‚ä½•ä¿è¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä»¥åŠç»´æŠ¤æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚æœ€è¿‘å›¢é˜Ÿå¯¹å•æµ‹è¦æ±‚ä¸æ–­æé«˜ï¼Œä¹Ÿå°†ä¹‹å‰æ”¶é›†ã€ç§¯ç´¯çš„ä¸€ç‚¹æµ‹è¯•ç›¸å…³çš„å†…å®¹è®°å½•åˆ†äº«ä¸‹ã€‚æœ¬æ–‡è½¬è‡ªDave Cheneyçš„è¡¨é©±åŠ¨æµ‹è¯•ä¸€æ–‡ï¼Œè¿™ç¯‡æ–‡ç« å†™å¾—æŒºå¥½çš„ã€‚",content:"å¼€å‘é™¤äº†ç¼–å†™ä»£ç ï¼Œä¹Ÿåº”è¯¥å…³æ³¨å¦‚ä½•ä¿è¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä»¥åŠç»´æŠ¤æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ã€‚æœ€è¿‘å›¢é˜Ÿå¯¹å•æµ‹è¦æ±‚ä¸æ–­æé«˜ï¼Œä¹Ÿå°†ä¹‹å‰æ”¶é›†ã€ç§¯ç´¯çš„ä¸€ç‚¹æµ‹è¯•ç›¸å…³çš„å†…å®¹è®°å½•åˆ†äº«ä¸‹ã€‚æœ¬æ–‡è½¬è‡ªDave Cheneyçš„è¡¨é©±åŠ¨æµ‹è¯•ä¸€æ–‡ï¼Œè¿™ç¯‡æ–‡ç« å†™å¾—æŒºå¥½çš„ã€‚\nPrefer table driven tests # Iâ€™m a big fan of testing, specifically unit testing and TDD (done correctly, of course). A practice that has grown around Go projects is the idea of a table driven test. This post explores the how and why of writing a table driven test.\nLetâ€™s say we have a function that splits strings:\n// Split slices s into all substrings separated by sep and // returns a slice of the substrings between those separators. func Split(s, sep string) []string { var result []string i := strings.Index(s, sep) for i \u0026gt; -1 { result = append(result, s[:i]) s = s[i+len(sep):] i = strings.Index(s, sep) } return append(result, s) }  In Go, unit tests are just regular Go functions (with a few rules) so we write a unit test for this function starting with a file in the same directory, with the same package name, strings.\npackage split import ( \u0026quot;reflect\u0026quot; \u0026quot;testing\u0026quot; ) func TestSplit(t *testing.T) { got := Split(\u0026quot;a/b/c\u0026quot;, \u0026quot;/\u0026quot;) want := []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;} if !reflect.DeepEqual(want, got) { t.Fatalf(\u0026quot;expected: %v, got: %v\u0026quot;, want, got) } }  Tests are just regular Go functions with a few rules:\n The name of the test function must start with Test. The test function must take one argument of type *testing.T. A *testing.T is a type injected by the testing package itself, to provide ways to print, skip, and fail the test.  In our test we call Split with some inputs, then compare it to the result we expected.\nCode coverage # The next question is, what is the coverage of this package? Luckily the go tool has a built in branch coverage. We can invoke it like this:\n% go test -coverprofile=c.out PASS coverage: 100.0% of statements ok split 0.010s  Which tells us we have 100% branch coverage, which isnâ€™t really surprising, thereâ€™s only one branch in this code.\nIf we want to dig in to the coverage report the go tool has several options to print the coverage report. We can use go tool cover -func to break down the coverage per function:\n% go tool cover -func=c.out split/split.go:8: Split 100.0% total: (statements) 100.0%  Which isnâ€™t that exciting as we only have one function in this package, but Iâ€™m sure youâ€™ll find more exciting packages to test.\nSpray some .bashrc on that # This pair of commands is so useful for me I have a shell alias which runs the test coverage and the report in one command:\ncover () { local t=$(mktemp -t cover) go test $COVERFLAGS -coverprofile=$t $@ \\ \u0026amp;\u0026amp; go tool cover -func=$t \\ \u0026amp;\u0026amp; unlink $t }  Going beyond 100% coverage # So, we wrote one test case, got 100% coverage, but this isnâ€™t really the end of the story. We have good branch coverage but we probably need to test some of the boundary conditions. For example, what happens if we try to split it on comma?\nfunc TestSplitWrongSep(t *testing.T) { got := Split(\u0026quot;a/b/c\u0026quot;, \u0026quot;,\u0026quot;) want := []string{\u0026quot;a/b/c\u0026quot;} if !reflect.DeepEqual(want, got) { t.Fatalf(\u0026quot;expected: %v, got: %v\u0026quot;, want, got) } }  Or, what happens if there are no separators in the source string?\nfunc TestSplitNoSep(t *testing.T) { got := Split(\u0026quot;abc\u0026quot;, \u0026quot;/\u0026quot;) want := []string{\u0026quot;abc\u0026quot;} if !reflect.DeepEqual(want, got) { t.Fatalf(\u0026quot;expected: %v, got: %v\u0026quot;, want, got) } }  Weâ€™re starting build a set of test cases that exercise boundary conditions. This is good.\nIntroducing table driven tests # However the there is a lot of duplication in our tests. For each test case only the input, the expected output, and name of the test case change. Everything else is boilerplate. What weâ€™d like to to set up all the inputs and expected outputs and feel them to a single test harness. This is a great time to introduce table driven testing.\nfunc TestSplit(t *testing.T) { type test struct { input string sep string want []string } tests := []test{ {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, } for _, tc := range tests { got := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;expected: %v, got: %v\u0026quot;, tc.want, got) } } }  We declare a structure to hold our test inputs and expected outputs. This is our table. The tests structure is usually a local declaration because we want to reuse this name for other tests in this package.\nIn fact, we donâ€™t even need to give the type a name, we can use an anonymous struct literal to reduce the boilerplate like this:\nfunc TestSplit(t *testing.T) { tests := []struct { input string sep string want []string }{ {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, } for _, tc := range tests { got := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;expected: %v, got: %v\u0026quot;, tc.want, got) } } }  Now, adding a new test is a straight forward matter; simply add another line the tests structure. For example, what will happen if our input string has a trailing separator?\n{input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, {input: \u0026quot;a/b/c/\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, // trailing sep  But, when we run go test, we get\n% go test --- FAIL: TestSplit (0.00s) split_test.go:24: expected: [a b c], got: [a b c ]  Putting aside the test failure, there are a few problems to talk about.\nThe first is by rewriting each test from a function to a row in a table weâ€™ve lost the name of the failing test. We added a comment in the test file to call out this case, but we donâ€™t have access to that comment in the go test output.\nThere are a few ways to resolve this. Youâ€™ll see a mix of styles in use in Go code bases because the table testing idiom is evolving as people continue to experiment with the form.\nEnumerating test cases # As tests are stored in a slice we can print out the index of the test case in the failure message:\nfunc TestSplit(t *testing.T) { tests := []struct { input string sep . string want []string }{ {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, {input: \u0026quot;a/b/c/\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, } for i, tc := range tests { got := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;test %d: expected: %v, got: %v\u0026quot;, i+1, tc.want, got) } } }  Now when we run go test we get this\n% go test --- FAIL: TestSplit (0.00s) split_test.go:24: test 4: expected: [a b c], got: [a b c ]  Which is a little better. Now we know that the fourth test is failing, although we have to do a little bit of fudging because slice indexingâ€”and range iterationâ€”is zero based. This requires consistency across your test cases; if some use zero base reporting and others use one based, itâ€™s going to be confusing. And, if the list of test cases is long, it could be difficult to count braces to figure out exactly which fixture constitutes test case number four.\nGive your test cases names # Another common pattern is to include a name field in the test fixture.\nfunc TestSplit(t *testing.T) { tests := []struct { name string input string sep string want []string }{ {name: \u0026quot;simple\u0026quot;, input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, {name: \u0026quot;wrong sep\u0026quot;, input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, {name: \u0026quot;no sep\u0026quot;, input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, {name: \u0026quot;trailing sep\u0026quot;, input: \u0026quot;a/b/c/\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, } for _, tc := range tests { got := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;%s: expected: %v, got: %v\u0026quot;, tc.name, tc.want, got) } } }  Now when the test fails we have a descriptive name for what the test was doing. We no longer have to try to figure it out from the outputâ€”also, now have a string we can search on.\n% go test --- FAIL: TestSplit (0.00s) split_test.go:25: trailing sep: expected: [a b c], got: [a b c ]  We can dry this up even more using a map literal syntax:\nfunc TestSplit(t *testing.T) { tests := map[string]struct { input string sep string want []string }{ \u0026quot;simple\u0026quot;: {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, \u0026quot;wrong sep\u0026quot;: {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, \u0026quot;no sep\u0026quot;: {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, \u0026quot;trailing sep\u0026quot;: {input: \u0026quot;a/b/c/\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, } for name, tc := range tests { got := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;%s: expected: %v, got: %v\u0026quot;, name, tc.want, got) } } }  Using a map literal syntax we define our test cases not as a slice of structs, but as map of test names to test fixtures. Thereâ€™s also a side benefit of using a map that is going to potentially improve the utility of our tests.\nMap iteration order is undefined 1 This means each time we run go test, our tests are going to be potentially run in a different order.\nThis is super useful for spotting conditions where test pass when run in statement order, but not otherwise. If you find that happens you probably have some global state that is being mutated by one test with subsequent tests depending on that modification.\nIntroducing sub tests # Before we fix the failing test there are a few other issues to address in our table driven test harness.\nThe first is weâ€™re calling t.Fatalf when one of the test cases fails. This means after the first failing test case we stop testing the other cases. Because test cases are run in an undefined order, if there is a test failure, it would be nice to know if it was the only failure or just the first.\nThe testing package would do this for us if we go to the effort to write out each test case as its own function, but thatâ€™s quite verbose. The good news is since Go 1.7 a new feature was added that lets us do this easily for table driven tests. Theyâ€™re called sub tests.\nfunc TestSplit(t *testing.T) { tests := map[string]struct { input string sep string want []string }{ \u0026quot;simple\u0026quot;: {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, \u0026quot;wrong sep\u0026quot;: {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, \u0026quot;no sep\u0026quot;: {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, \u0026quot;trailing sep\u0026quot;: {input: \u0026quot;a/b/c/\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, } for name, tc := range tests { t.Run(name, func(t *testing.T) { got := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;expected: %v, got: %v\u0026quot;, tc.want, got) } }) } }  As each sub test now has a name we get that name automatically printed out in any test runs.\n% go test --- FAIL: TestSplit (0.00s) --- FAIL: TestSplit/trailing_sep (0.00s) split_test.go:25: expected: [a b c], got: [a b c ]  Each subtest is its own anonymous function, therefore we can use t.Fatalf, t.Skipf, and all the other testing.Thelpers, while retaining the compactness of a table driven test.\nIndividual sub test cases can be executed directly # Because sub tests have a name, you can run a selection of sub tests by name using the go test -run flag.\n% go test -run=.*/trailing -v === RUN TestSplit === RUN TestSplit/trailing_sep --- FAIL: TestSplit (0.00s) --- FAIL: TestSplit/trailing_sep (0.00s) split_test.go:25: expected: [a b c], got: [a b c ]  Comparing what we got with what we wanted # Now weâ€™re ready to fix the test case. Letâ€™s look at the error.\n--- FAIL: TestSplit (0.00s) --- FAIL: TestSplit/trailing_sep (0.00s) split_test.go:25: expected: [a b c], got: [a b c ]  Can you spot the problem? Clearly the slices are different, thatâ€™s what reflect.DeepEqual is upset about. But spotting the actual difference isnâ€™t easy, you have to spot that extra space after c. This might look simple in this simple example, but it is any thing but when youâ€™re comparing two complicated deeply nested gRPC structures.\nWe can improve the output if we switch to the %#v syntax to view the value as a Go(ish) declaration:\ngot := Split(tc.input, tc.sep) if !reflect.DeepEqual(tc.want, got) { t.Fatalf(\u0026quot;expected: %#v, got: %#v\u0026quot;, tc.want, got) }  Now when we run our test itâ€™s clear that the problem is there is an extra blank element in the slice.\n% go test --- FAIL: TestSplit (0.00s) --- FAIL: TestSplit/trailing_sep (0.00s) split_test.go:25: expected: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}, got: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;, \u0026quot;\u0026quot;}  But before we go to fix our test failure I want to talk a little bit more about choosing the right way to present test failures. Our Split function is simple, it takes a primitive string and returns a slice of strings, but what if it worked with structs, or worse, pointers to structs?\nHere is an example where %#v does not work as well:\nfunc main() { type T struct { I int } x := []*T{{1}, {2}, {3}} y := []*T{{1}, {2}, {4}} fmt.Printf(\u0026quot;%v %v\\n\u0026quot;, x, y) fmt.Printf(\u0026quot;%#v %#v\\n\u0026quot;, x, y) }  The first fmt.Printfprints the unhelpful, but expected slice of addresses; [0xc000096000 0xc000096008 0xc000096010] [0xc000096018 0xc000096020 0xc000096028]. However our %#v version doesnâ€™t fare any better, printing a slice of addresses cast to *main.T;[]*main.T{(*main.T)(0xc000096000), (*main.T)(0xc000096008), (*main.T)(0xc000096010)} []*main.T{(*main.T)(0xc000096018), (*main.T)(0xc000096020), (*main.T)(0xc000096028)}\nBecause of the limitations in using any fmt.Printf verb, I want to introduce the go-cmp library from Google.\nThe goal of the cmp library is it is specifically to compare two values. This is similar to reflect.DeepEqual, but it has more capabilities. Using the cmp pacakge you can, of course, write:\nfunc main() { type T struct { I int } x := []*T{{1}, {2}, {3}} y := []*T{{1}, {2}, {4}} fmt.Println(cmp.Equal(x, y)) // false }  But far more useful for us with our test function is the cmp.Diff function which will produce a textual description of what is different between the two values, recursively.\nfunc main() { type T struct { I int } x := []*T{{1}, {2}, {3}} y := []*T{{1}, {2}, {4}} diff := cmp.Diff(x, y) fmt.Printf(diff) }  Which instead produces:\n% go run {[]*main.T}[2].I: -: 3 +: 4  Telling us that at element 2 of the slice of Ts the Ifield was expected to be 3, but was actually 4.\nPutting this all together we have our table driven go-cmp test\nfunc TestSplit(t *testing.T) { tests := map[string]struct { input string sep string want []string }{ \u0026quot;simple\u0026quot;: {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, \u0026quot;wrong sep\u0026quot;: {input: \u0026quot;a/b/c\u0026quot;, sep: \u0026quot;,\u0026quot;, want: []string{\u0026quot;a/b/c\u0026quot;}}, \u0026quot;no sep\u0026quot;: {input: \u0026quot;abc\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;abc\u0026quot;}}, \u0026quot;trailing sep\u0026quot;: {input: \u0026quot;a/b/c/\u0026quot;, sep: \u0026quot;/\u0026quot;, want: []string{\u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;c\u0026quot;}}, } for name, tc := range tests { t.Run(name, func(t *testing.T) { got := Split(tc.input, tc.sep) diff := cmp.Diff(tc.want, got) if diff != \u0026quot;\u0026quot; { t.Fatalf(diff) } }) } }  Running this we get\n% go test --- FAIL: TestSplit (0.00s) --- FAIL: TestSplit/trailing_sep (0.00s) split_test.go:27: {[]string}[?-\u0026gt;3]: -: \u0026lt;non-existent\u0026gt; +: \u0026quot;\u0026quot; FAIL exit status 1 FAIL split 0.006s  Using cmp.Diff our test harness isnâ€™t just telling us that what we got and what we wanted were different. Our test is telling us that the strings are different lengths, the third index in the fixture shouldnâ€™t exist, but the actual output we got an empty string, â€œâ€. From here fixing the test failure is straight forward.\n Please donâ€™t email me to argue that map iteration order is random. Itâ€™s not.  Related Posts: #  Writing table driven tests in Go Internets of Interest #7: Ian Cooper on Test Driven Development Automatically run your packageâ€™s tests with inotifywait How to write benchmarks in Go  This entry was posted in Go, Programming and tagged testing, unit test on May 7, 2019.\n"}),a.add({id:264,href:"/tags/life/",title:"life",description:"",content:""}),a.add({id:265,href:"/blog/2020-08-13-%E9%AA%91%E8%87%AA%E8%A1%8C%E8%BD%A6%E4%B8%80%E7%82%B9%E9%83%BD%E4%B8%8D%E8%88%92%E6%9C%8D%E4%BD%86%E6%98%AF%E5%BE%88%E7%88%BD/",title:"éª‘è‡ªè¡Œè½¦ä¸€ç‚¹éƒ½ä¸èˆ’æœï¼Œä½†æ˜¯å¾ˆçˆ½",description:'/* Three image containers (use 25% for four, and 50% for two, etc) */ .column { float: left; width: 50%; padding: 5px; } /* Clear floats after image containers */ .row::after { content: ""; clear: both; display: table; } .fixsize { width: 340px; height: 280px; } .fullsize { width: 680px; }  19å¹´5æœˆåº•ï¼Œæ—¶é•¿æ„Ÿè§‰èº«ä½“ç–²å€¦ï¼Œæƒ³é”»ç‚¼ä¸‹èº«ä½“ï¼Œæˆ‘æƒ³ä¹°è¾†è‡ªè¡Œè½¦éª‘ç€ä¸Šç­ã€‚å·¦çœ‹å³çœ‹ï¼Œè¿˜æ˜¯æƒ³ä¹°ä¸€è¾†å…¬è·¯èµ›è‡ªè¡Œè½¦ï¼Œå¤ªäº«å—é‚£ç§â€œç ´é£â€çš„æ„Ÿè§‰äº†ã€‚å·¦çœ‹å³çœ‹ï¼Œçœ‹ä¸Šäº†Giant OCR 5700ï¼Œä¹°çš„æ—¶å€™è¿™ä¸¤è‡ªè¡Œè½¦å·²ç»å‡ è¿‘åœäº§äº†ï¼Œä½†æ˜¯å› ä¸ºå®ƒé»‘ç™½è‰²çš„æ¶‚è£…ï¼Œå®åœ¨æ˜¯å¤ªæ‹›äººå–œæ¬¢äº†ï¼Œç®€å•åˆä¸å¤±ç¾æ„Ÿã€‚å‡ ä¹æ²¡ä»€ä¹ˆçŠ¹è±«çš„ï¼Œå°±ä¹°äº†ä¸€è¾†ï¼Œç„¶åå‡ å¤©ä¹‹åæ”¶åˆ°è½¦ï¼Œè‡ªå·±ç»„è£…å®Œæ¯•ï¼Œæ»¡å¿ƒæ¬¢å–œã€‚\nå°†å…¶ç«‹åœ¨è½åœ°çª—è¾¹ï¼Œå¿ä¸ä½è¿™ä¹ˆçœ‹é‚£ä¹ˆçœ‹ï¼ŒçœŸçš„æ˜¯å¤ªæ¼‚äº®äº†ï¼Œè¿™é‡Œè¿˜ä¿ç•™äº†ä¸€å¼ åˆšå¼€å§‹ç»„è£…å¥½åçš„ç…§ç‰‡ã€‚\nå…¶å®ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä¹°çš„ç¬¬ä¸€è¾†å…¬è·¯èµ›è‡ªè¡Œè½¦ï¼Œæœ¬ç§‘è¯»ä¹¦æ—¶ï¼Œå°±ä¹°äº†ä¸€è¾†ï¼Œé‚£æ—¶å€™ä¸‹è¯¾æ²¡äº‹ã€å‘¨æœ«çš„æ—¶å€™ï¼Œå°±å–œæ¬¢éª‘è½¦å»è·‘ä¸ªç¯æµ·è·¯ã€é€›é€›è¿™åº§å°åŸã€æ¢æ¢å‘¨è¾¹çš„æ ¡å›­ï¼Œå¾ˆæ˜¯æƒ¬æ„ã€‚ç›´åˆ°ç°åœ¨ï¼Œæˆ‘è¿˜ä¾ç¨€è®°å¾—æ²¿ç€ç¯æµ·è·¯éª‘è¡Œæ—¶çš„åœºæ™¯ï¼Œé‚£æ‰‘é¢è€Œæ¥å¸¦ç€ç‚¹è…¥å‘³çš„æµ·é£ï¼Œé‚£é™è°§åˆå¹²å‡€çš„å¤§é©¬è·¯ï¼Œé‚£ä¸€æœ›æ— è¾¹çš„å¤§æµ·ï¼Œå¬ç€æµ·æµªæ‹æ‰“ç€æµ·æ»©ã€å²©çŸ³ï¼Œå¹ç€æµ·é£ï¼Œå°±è¿™ä¹ˆèµ°å•Šèµ°ï¼ŒçœŸæƒ³ä¸€ç›´è¿™ä¹ˆèµ°ä¸‹å»â€¦â€¦\n   è¯»ç ”ç©¶ç”Ÿæ—¶ï¼Œåˆä¹°äº†ä¸€è¾†ï¼Œæ—¶ä¸æ—¶å°±å›´ç€å­¦æ ¡ã€ä¹çœ¼æ¡¥ã€å¤§ç†ŠçŒ«ç¹è‚²åŸºåœ°ç­‰å‘¨è¾¹åœ°æ–¹æ¥ä¸€åœˆã€‚æˆéƒ½å¸‚åŒºçƒ­é—¹éå‡¡ï¼Œäº¤é€šä¹Ÿå µï¼Œéª‘ç€è½¦ä»å›¾ä¹¦é¦†é™„è¿‘çš„ä¸œé—¨çªœå‡ºï¼Œåˆ°ä¹çœ¼æ¡¥å¬å¬æ€¥æµçš„æ°´å£°ï¼Œæ„Ÿå—ä¸‹é‚£è‚¡æ½®æ¹¿çš„æ–°é²œï¼Œå¿ƒæƒ…å°±ä¼šå¾ˆèˆ’ç•…ã€‚è¿™è¾†è½¦éª‘äº†æ²¡å¤šä¹…ï¼Œè¢«å°å·å·èµ°äº†ï¼Œé‚£å‡ å¹´çœŸçš„æ˜¯ä¸åœåœ°æ¢è‡ªè¡Œè½¦ï¼Œä¹°äº†ä¸¢ä¸¢äº†ä¹°ã€‚éšç€å…±äº«å•è½¦çš„å…´èµ·ï¼Œæˆ‘æƒ³å­¦æ ¡å‘¨è¾¹çš„å°å·ä»¬åº”è¯¥æ²¡ä»€ä¹ˆå¯å·çš„äº†å§ã€‚\n   ä¸ºä»€ä¹ˆå‡ ç•ªä¹°å…¬è·¯èµ›è‡ªè¡Œè½¦å‘¢ï¼Ÿçœ‹å®ƒçš„é€ å‹ï¼Œæ¯ä¸ªç”·åŒå­¦åº”è¯¥éƒ½ä¼šå–œæ¬¢å®ƒçº¿æ¡ä¸­é€å‡ºçš„é‚£è‚¡åŠ¨æ„Ÿå§ï¼å¦å¤–ï¼Œå’Œæˆ‘çš„æ€§æ ¼ä¹Ÿæœ‰å…³ç³»ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢ç‹¬è¡Œã€‚éª‘ä¸Šå®ƒï¼Œæƒ³å»å“ªå°±å»å“ªï¼Œä¸ç”¨æ‹…å¿ƒå µè½¦ï¼Œä¸ç”¨æ‹…å¿ƒé”™è¿‡å…¬äº¤ã€åœ°é“ï¼Œéª‘è¡Œåœ¨å¤§è¡—å°å··ã€å…¬å›­ç»¿é“ç­‰ç­‰ï¼Œå°±å°½æƒ…äº«å—å’Œè‡ªç„¶èä¸ºä¸€ä½“çš„é‚£ç§å¿«æ„Ÿå§ã€‚éª‘è½¦ä¸€æ—¶çˆ½ï¼Œä¸€ç›´éª‘è½¦ä¸€ç›´çˆ½ï¼Œå“ˆå“ˆï¼\néª‘è½¦è™½ç„¶æœ‰æ—¶å€™ä¸å¤ªèˆ’æœï¼Œä½†æ˜¯çˆ½è¿˜æ˜¯æŒºçˆ½çš„ã€‚ç°åœ¨æˆ‘æ¯å¤©ä»å®å®‰ä½“è‚²é¦†é™„è¿‘å‡ºå‘ï¼Œåˆ°è…¾è®¯ä¸‡åˆ©è¾¾å¤§å¦ä¸Šç­ï¼Œæ²¿é€”9å…¬é‡Œå·¦å³ï¼Œäº¤é€šçŠ¶å†µå¥½çš„è¯å¤§æ¦‚25åˆ†é’Ÿå·¦å³èƒ½åˆ°ã€‚å¦‚æœæ˜¯äº¤é€šä¸å¥½çš„æƒ…å†µå‘¢ï¼Œå¤šç­‰ä¸Šå‡ ä¸ªçº¢ç»¿ç¯ï¼Œé‚£å¯èƒ½è¦40åˆ†é’Ÿå·¦å³ã€‚æˆ‘ä»¬ä¸­å¿ƒä¸‹ç­æœ‰ç‚¹æ™šï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯11ç‚¹å·¦å³æ‰ä¸‹ç­ï¼Œæœ‰çš„æ—¶å€™èµ°åˆ°åŠå¤œä¹‹åçš„ä¹Ÿä¸å°‘ã€‚é‚£ä¹ˆæ™šäº†ï¼Œç›¸æ¯”æ‰“è½¦ï¼Œæˆ‘è¿˜æ˜¯æ„¿æ„éª‘è½¦å›å®¶ã€‚é‚£ç§è¢«æ±—æ°´æµ¸é€ã€é•¿æ—¶é—´å¸¦æ¥çš„èº«ä½“ç´ è´¨çš„æå‡ã€æƒ³å†²å°±èƒ½å†²çš„ä½“èƒ½ï¼Œè®©æ•´ä¸ªäººéƒ½ä¼šå¾ˆå…´å¥‹ï¼Œå¿ƒæƒ…ä¹Ÿå¥½ã€‚æ‰€ä»¥ï¼Œå°½ç®¡é‚£ä¹ˆæ™šäº†ï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©éª‘è½¦å›å®¶ã€‚å½“ç„¶ï¼Œè¿™é‡Œæ˜¯æ·±åœ³ï¼Œæ·±åœ³çš„å¤œæ™šç¯ç«é€šæ˜â€¦â€¦\né™„ä¸Šä¸¤ä¸ªä¸Šç­ã€ä¸‹ç­è·¯ä¸Šçš„è§†é¢‘ï¼Œå“¦ï¼Œå¯¹äº†ï¼Œé…ä¸Šä¸€å‰¯å¥½çš„è“ç‰™è€³æœºï¼Œä¼šæ›´è®©ä½ è·å¾—éª‘è¡Œçš„ä¹è¶£ã€‚æˆ‘ç”¨çš„æ˜¯éŸ¶éŸ³ Aftershokz AS 650ï¼Œè¿™æ˜¯ä¸€æ¬¾éª¨ä¼ å¯¼è€³æœºï¼Œå¯ä»¥è®©ä½ åœ¨è·¯ä¸Šæ„ŸçŸ¥åˆ°å‘¨è¾¹ç¯å¢ƒçš„é‡è¦å£°éŸ³ï¼Œæ¯”å¦‚éª‘è½¦å–‡å­å£°ç­‰ç­‰ï¼Œå®Œå…¨å…¥è€³çš„è®¾è®¡åœ¨è¿™ç§åœºæ™¯ä¸‹æœ‰ç‚¹ä¸å®‰å…¨ã€‚æœ€å¼€å§‹æœ‰ä¸ªåŒå­¦è§‰å¾—ï¼Œ1200å—é’±ä¹°è¿™ä¸ªâ€éŸ³è´¨â€çš„è€³æœºæœ‰ç‚¹ä¸å€¼ï¼Œå—¯ï¼Œæˆ‘è¿½æ±‚çš„ä¸æ˜¯éŸ³è´¨ï¼Œæˆ‘æƒ³è¦çš„æ˜¯æ„Ÿè§‰ï¼ˆè¿½æ±‚éŸ³è´¨æˆ‘æœ‰BOSEï¼‰â€¦â€¦PSï¼ŒAftershokz AS 650ä¹‹å‰ä¸¢äº†ä¸€ä¸ªï¼Œç°åœ¨å·²ç»æ˜¯ç¬¬äºŒä¸ªäº†ã€‚',content:'/* Three image containers (use 25% for four, and 50% for two, etc) */ .column { float: left; width: 50%; padding: 5px; } /* Clear floats after image containers */ .row::after { content: ""; clear: both; display: table; } .fixsize { width: 340px; height: 280px; } .fullsize { width: 680px; }  19å¹´5æœˆåº•ï¼Œæ—¶é•¿æ„Ÿè§‰èº«ä½“ç–²å€¦ï¼Œæƒ³é”»ç‚¼ä¸‹èº«ä½“ï¼Œæˆ‘æƒ³ä¹°è¾†è‡ªè¡Œè½¦éª‘ç€ä¸Šç­ã€‚å·¦çœ‹å³çœ‹ï¼Œè¿˜æ˜¯æƒ³ä¹°ä¸€è¾†å…¬è·¯èµ›è‡ªè¡Œè½¦ï¼Œå¤ªäº«å—é‚£ç§â€œç ´é£â€çš„æ„Ÿè§‰äº†ã€‚å·¦çœ‹å³çœ‹ï¼Œçœ‹ä¸Šäº†Giant OCR 5700ï¼Œä¹°çš„æ—¶å€™è¿™ä¸¤è‡ªè¡Œè½¦å·²ç»å‡ è¿‘åœäº§äº†ï¼Œä½†æ˜¯å› ä¸ºå®ƒé»‘ç™½è‰²çš„æ¶‚è£…ï¼Œå®åœ¨æ˜¯å¤ªæ‹›äººå–œæ¬¢äº†ï¼Œç®€å•åˆä¸å¤±ç¾æ„Ÿã€‚å‡ ä¹æ²¡ä»€ä¹ˆçŠ¹è±«çš„ï¼Œå°±ä¹°äº†ä¸€è¾†ï¼Œç„¶åå‡ å¤©ä¹‹åæ”¶åˆ°è½¦ï¼Œè‡ªå·±ç»„è£…å®Œæ¯•ï¼Œæ»¡å¿ƒæ¬¢å–œã€‚\nå°†å…¶ç«‹åœ¨è½åœ°çª—è¾¹ï¼Œå¿ä¸ä½è¿™ä¹ˆçœ‹é‚£ä¹ˆçœ‹ï¼ŒçœŸçš„æ˜¯å¤ªæ¼‚äº®äº†ï¼Œè¿™é‡Œè¿˜ä¿ç•™äº†ä¸€å¼ åˆšå¼€å§‹ç»„è£…å¥½åçš„ç…§ç‰‡ã€‚\nå…¶å®ï¼Œè¿™å¹¶ä¸æ˜¯æˆ‘ä¹°çš„ç¬¬ä¸€è¾†å…¬è·¯èµ›è‡ªè¡Œè½¦ï¼Œæœ¬ç§‘è¯»ä¹¦æ—¶ï¼Œå°±ä¹°äº†ä¸€è¾†ï¼Œé‚£æ—¶å€™ä¸‹è¯¾æ²¡äº‹ã€å‘¨æœ«çš„æ—¶å€™ï¼Œå°±å–œæ¬¢éª‘è½¦å»è·‘ä¸ªç¯æµ·è·¯ã€é€›é€›è¿™åº§å°åŸã€æ¢æ¢å‘¨è¾¹çš„æ ¡å›­ï¼Œå¾ˆæ˜¯æƒ¬æ„ã€‚ç›´åˆ°ç°åœ¨ï¼Œæˆ‘è¿˜ä¾ç¨€è®°å¾—æ²¿ç€ç¯æµ·è·¯éª‘è¡Œæ—¶çš„åœºæ™¯ï¼Œé‚£æ‰‘é¢è€Œæ¥å¸¦ç€ç‚¹è…¥å‘³çš„æµ·é£ï¼Œé‚£é™è°§åˆå¹²å‡€çš„å¤§é©¬è·¯ï¼Œé‚£ä¸€æœ›æ— è¾¹çš„å¤§æµ·ï¼Œå¬ç€æµ·æµªæ‹æ‰“ç€æµ·æ»©ã€å²©çŸ³ï¼Œå¹ç€æµ·é£ï¼Œå°±è¿™ä¹ˆèµ°å•Šèµ°ï¼ŒçœŸæƒ³ä¸€ç›´è¿™ä¹ˆèµ°ä¸‹å»â€¦â€¦\n   è¯»ç ”ç©¶ç”Ÿæ—¶ï¼Œåˆä¹°äº†ä¸€è¾†ï¼Œæ—¶ä¸æ—¶å°±å›´ç€å­¦æ ¡ã€ä¹çœ¼æ¡¥ã€å¤§ç†ŠçŒ«ç¹è‚²åŸºåœ°ç­‰å‘¨è¾¹åœ°æ–¹æ¥ä¸€åœˆã€‚æˆéƒ½å¸‚åŒºçƒ­é—¹éå‡¡ï¼Œäº¤é€šä¹Ÿå µï¼Œéª‘ç€è½¦ä»å›¾ä¹¦é¦†é™„è¿‘çš„ä¸œé—¨çªœå‡ºï¼Œåˆ°ä¹çœ¼æ¡¥å¬å¬æ€¥æµçš„æ°´å£°ï¼Œæ„Ÿå—ä¸‹é‚£è‚¡æ½®æ¹¿çš„æ–°é²œï¼Œå¿ƒæƒ…å°±ä¼šå¾ˆèˆ’ç•…ã€‚è¿™è¾†è½¦éª‘äº†æ²¡å¤šä¹…ï¼Œè¢«å°å·å·èµ°äº†ï¼Œé‚£å‡ å¹´çœŸçš„æ˜¯ä¸åœåœ°æ¢è‡ªè¡Œè½¦ï¼Œä¹°äº†ä¸¢ä¸¢äº†ä¹°ã€‚éšç€å…±äº«å•è½¦çš„å…´èµ·ï¼Œæˆ‘æƒ³å­¦æ ¡å‘¨è¾¹çš„å°å·ä»¬åº”è¯¥æ²¡ä»€ä¹ˆå¯å·çš„äº†å§ã€‚\n   ä¸ºä»€ä¹ˆå‡ ç•ªä¹°å…¬è·¯èµ›è‡ªè¡Œè½¦å‘¢ï¼Ÿçœ‹å®ƒçš„é€ å‹ï¼Œæ¯ä¸ªç”·åŒå­¦åº”è¯¥éƒ½ä¼šå–œæ¬¢å®ƒçº¿æ¡ä¸­é€å‡ºçš„é‚£è‚¡åŠ¨æ„Ÿå§ï¼å¦å¤–ï¼Œå’Œæˆ‘çš„æ€§æ ¼ä¹Ÿæœ‰å…³ç³»ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢ç‹¬è¡Œã€‚éª‘ä¸Šå®ƒï¼Œæƒ³å»å“ªå°±å»å“ªï¼Œä¸ç”¨æ‹…å¿ƒå µè½¦ï¼Œä¸ç”¨æ‹…å¿ƒé”™è¿‡å…¬äº¤ã€åœ°é“ï¼Œéª‘è¡Œåœ¨å¤§è¡—å°å··ã€å…¬å›­ç»¿é“ç­‰ç­‰ï¼Œå°±å°½æƒ…äº«å—å’Œè‡ªç„¶èä¸ºä¸€ä½“çš„é‚£ç§å¿«æ„Ÿå§ã€‚éª‘è½¦ä¸€æ—¶çˆ½ï¼Œä¸€ç›´éª‘è½¦ä¸€ç›´çˆ½ï¼Œå“ˆå“ˆï¼\néª‘è½¦è™½ç„¶æœ‰æ—¶å€™ä¸å¤ªèˆ’æœï¼Œä½†æ˜¯çˆ½è¿˜æ˜¯æŒºçˆ½çš„ã€‚ç°åœ¨æˆ‘æ¯å¤©ä»å®å®‰ä½“è‚²é¦†é™„è¿‘å‡ºå‘ï¼Œåˆ°è…¾è®¯ä¸‡åˆ©è¾¾å¤§å¦ä¸Šç­ï¼Œæ²¿é€”9å…¬é‡Œå·¦å³ï¼Œäº¤é€šçŠ¶å†µå¥½çš„è¯å¤§æ¦‚25åˆ†é’Ÿå·¦å³èƒ½åˆ°ã€‚å¦‚æœæ˜¯äº¤é€šä¸å¥½çš„æƒ…å†µå‘¢ï¼Œå¤šç­‰ä¸Šå‡ ä¸ªçº¢ç»¿ç¯ï¼Œé‚£å¯èƒ½è¦40åˆ†é’Ÿå·¦å³ã€‚æˆ‘ä»¬ä¸­å¿ƒä¸‹ç­æœ‰ç‚¹æ™šï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯11ç‚¹å·¦å³æ‰ä¸‹ç­ï¼Œæœ‰çš„æ—¶å€™èµ°åˆ°åŠå¤œä¹‹åçš„ä¹Ÿä¸å°‘ã€‚é‚£ä¹ˆæ™šäº†ï¼Œç›¸æ¯”æ‰“è½¦ï¼Œæˆ‘è¿˜æ˜¯æ„¿æ„éª‘è½¦å›å®¶ã€‚é‚£ç§è¢«æ±—æ°´æµ¸é€ã€é•¿æ—¶é—´å¸¦æ¥çš„èº«ä½“ç´ è´¨çš„æå‡ã€æƒ³å†²å°±èƒ½å†²çš„ä½“èƒ½ï¼Œè®©æ•´ä¸ªäººéƒ½ä¼šå¾ˆå…´å¥‹ï¼Œå¿ƒæƒ…ä¹Ÿå¥½ã€‚æ‰€ä»¥ï¼Œå°½ç®¡é‚£ä¹ˆæ™šäº†ï¼Œæˆ‘è¿˜æ˜¯é€‰æ‹©éª‘è½¦å›å®¶ã€‚å½“ç„¶ï¼Œè¿™é‡Œæ˜¯æ·±åœ³ï¼Œæ·±åœ³çš„å¤œæ™šç¯ç«é€šæ˜â€¦â€¦\né™„ä¸Šä¸¤ä¸ªä¸Šç­ã€ä¸‹ç­è·¯ä¸Šçš„è§†é¢‘ï¼Œå“¦ï¼Œå¯¹äº†ï¼Œé…ä¸Šä¸€å‰¯å¥½çš„è“ç‰™è€³æœºï¼Œä¼šæ›´è®©ä½ è·å¾—éª‘è¡Œçš„ä¹è¶£ã€‚æˆ‘ç”¨çš„æ˜¯éŸ¶éŸ³ Aftershokz AS 650ï¼Œè¿™æ˜¯ä¸€æ¬¾éª¨ä¼ å¯¼è€³æœºï¼Œå¯ä»¥è®©ä½ åœ¨è·¯ä¸Šæ„ŸçŸ¥åˆ°å‘¨è¾¹ç¯å¢ƒçš„é‡è¦å£°éŸ³ï¼Œæ¯”å¦‚éª‘è½¦å–‡å­å£°ç­‰ç­‰ï¼Œå®Œå…¨å…¥è€³çš„è®¾è®¡åœ¨è¿™ç§åœºæ™¯ä¸‹æœ‰ç‚¹ä¸å®‰å…¨ã€‚æœ€å¼€å§‹æœ‰ä¸ªåŒå­¦è§‰å¾—ï¼Œ1200å—é’±ä¹°è¿™ä¸ªâ€éŸ³è´¨â€çš„è€³æœºæœ‰ç‚¹ä¸å€¼ï¼Œå—¯ï¼Œæˆ‘è¿½æ±‚çš„ä¸æ˜¯éŸ³è´¨ï¼Œæˆ‘æƒ³è¦çš„æ˜¯æ„Ÿè§‰ï¼ˆè¿½æ±‚éŸ³è´¨æˆ‘æœ‰BOSEï¼‰â€¦â€¦PSï¼ŒAftershokz AS 650ä¹‹å‰ä¸¢äº†ä¸€ä¸ªï¼Œç°åœ¨å·²ç»æ˜¯ç¬¬äºŒä¸ªäº†ã€‚\né™„ä¸Šä¸Šä¸‹ç­è·¯ä¸Šçš„ä¸¤ä¸ªè§†é¢‘ï¼Œæ„Ÿå—ä¸€ä¸‹éª‘è¡Œå¸¦æ¥çš„å¿«æ„Ÿï¼š\n     '}),a.add({id:266,href:"/tags/alfred/",title:"alfred",description:"",content:""}),a.add({id:267,href:"/tags/awgo/",title:"awgo",description:"",content:""}),a.add({id:268,href:"/tags/workflow/",title:"workflow",description:"",content:""}),a.add({id:269,href:"/blog/2020-07-31-%E4%BD%BF%E7%94%A8awgo%E5%BC%80%E5%8F%91alfred.workflow/",title:"ä½¿ç”¨awgoå¼€å‘alfred.workflow",description:"img { width: 680px; }  æœ¬æ–‡ç®€ä»‹ # è¯¥workflowä¸»è¦æ˜¯ä¸ºäº†å¯¹ \u0026ldquo;æ—¶é—´æˆ³\u0026rdquo; \u0026amp;\u0026amp; \u0026ldquo;æ ¼å¼åŒ–æ—¥æœŸ+æ—¶é—´å­—ç¬¦ä¸²\u0026rdquo; è¿›è¡Œå¿«é€Ÿè½¬æ¢ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚\nå¼€å‘äººå‘˜ï¼Œç»å¸¸ä¼šæ¶‰åŠåˆ°æ—¶é—´ç›¸å…³çš„è½¬æ¢æ“ä½œï¼Œæœ‰ä¸ªè¶æ‰‹çš„å·¥å…·è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚\næˆ‘å¹³æ—¶ä½¿ç”¨alfredæ¯”è¾ƒå¤šï¼Œè‡ªç„¶å°±æƒ³é€šè¿‡workflowçš„æ–¹å¼æ¥å®ç°ï¼Œå½“ç„¶ç”¨hammerspoonã€petç­‰å…¶ä»–å·¥å…·ä¹Ÿå¯ä»¥ã€‚\nalfred workflowå’Œalfredæœ¬èº«çš„äº¤äº’æ˜¯é€šè¿‡ç®¡é“æ–¹å¼è¿›è¡Œè¿æ¥çš„ï¼š\n alfredå°†ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯è½¬å‘ç»™åŒ¹é…çš„workflowï¼› workflowå¯¹æ¥æ”¶åˆ°çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†å¤„ç†çš„ç»“æœæŒ‰ç…§æŒ‡å®šæ ¼å¼è¾“å‡ºåˆ°stdoutï¼› alfredè¯»å–stdoutä¸­çš„æ•°æ®ä½œä¸ºå“åº”å±•ç¤ºåˆ°ç”¨æˆ·ç•Œé¢ï¼›  è¿™é‡Œä¸»è¦ä½¿ç”¨äº†awgoæ¥ç¼–å†™workflowï¼Œå®ç°é€»è¾‘å¯ä»¥å‚è€ƒä¸‹ä»£ç ï¼Œé€»è¾‘å¾ˆç®€å•ã€‚ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨ã€‚\nå¦‚ä½•å®‰è£…ï¼Ÿ # ä¸‹è½½é¡¹ç›®ä¸‹ workflow/Date Formats Go.alfredworkflowï¼ŒåŒå‡»å³å¯å®‰è£…ã€‚\nå¦‚ä½•ä½¿ç”¨ï¼Ÿ #   è¿è¡Œ datex å”¤èµ·workflow\n  å¸¸ç”¨è½¬æ¢æ“ä½œ: è·å–å½“å‰æ—¶é—´å¯¹åº”çš„Unixæ—¶é—´æˆ³ï¼Œä»¥åŠæ ¼å¼åŒ–å­—ç¬¦ä¸²\ndatex nowï¼Œå°†å½“å‰æ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³ä»¥åŠæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²(å¤šç§æ—¥æœŸæ ¼å¼)ã€‚\nå¯ä»¥ç”¨ä¸Šä¸‹é”®ç§»åŠ¨è¿›è¡Œé€‰æ‹©ï¼Œå½“æŒ‰ä¸‹å›è½¦é”®æ—¶ï¼Œä¼šå°†å¯¹åº”çš„ç»“æœæ‹·è´åˆ°å‰ªè´´æ¿ï¼Œæ–¹ä¾¿ç²˜è´´ä½¿ç”¨ã€‚   å¸¸ç”¨è½¬æ¢æ“ä½œ: å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºå¯¹åº”çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²\nä»¥æ—¶é—´æˆ³1596137272ä¸ºä¾‹ï¼Œdatex 1596137272ï¼Œæ­¤æ—¶ä¼šå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ã€‚\né€‰æ‹©ã€å¤åˆ¶æ•°æ®æ“ä½œç±»ä¼¼ã€‚   å¸¸ç”¨è½¬æ¢æ“ä½œ: å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼Œæˆ–å…¶ä»–æ ¼å¼\nä»¥å­—ç¬¦ä¸²2020-07-30ä¸ºä¾‹ï¼Œdatex 2020-07-30ï¼Œæ­¤æ—¶ä¼šå…ˆå°†å…¶ä¸å€™é€‰çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ã€‚\nå¹¶è½¬æ¢æˆä¸€ä¸ªæœ‰æ•ˆçš„æ—¶é—´æˆ³ã€‚ ç„¶åå†æ ¹æ®æ­¤æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºå…¶ä»–æ ¼å¼å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚é€‰æ‹©ã€å¤åˆ¶æ•°æ®æ“ä½œç±»ä¼¼ã€‚   è¿™å¤§è‡´å°±æ˜¯è¯¥workflowçš„ä½¿ç”¨æ–¹å¼ã€‚\nå…³äºæ—¥æœŸæ—¶é—´æ ¼å¼è½¬æ¢çš„workflowï¼Œgithubä¸Šå·²ç»æœ‰å‡ ä¸ªæ¯”è¾ƒå¥½çš„å®ç°äº†ï¼Œè½®å­ä¸å¥½ç”¨å°±å¾—è‡ªå·±é€ ã€‚\n å®ç°å¯¹timezoneæ”¯æŒä¸å¥½; é‡‡ç”¨çš„æ—¶é—´æ ¼å¼ä¸ç¬¦åˆå›½äººä¹ æƒ¯; æŒæ¡awgoå¼€å‘alfred workflowä»¥åå¯ä»¥å†™æ›´å¤šæ•ˆç‡å·¥å…·;  å¸Œæœ›è¿™ä¸ªå°å·¥å…·èƒ½å¸®åŠ©åˆ°æœ‰éœ€è¦çš„åŒå­¦ï¼Œä¹Ÿç»™å‡†å¤‡å¼€å‘alfred workflowæˆ–ä½¿ç”¨awgoå¼€å‘workflowçš„åŒå­¦æä¾›ä¸€ä¸ªç¤ºä¾‹ã€‚",content:" img { width: 680px; }  æœ¬æ–‡ç®€ä»‹ # è¯¥workflowä¸»è¦æ˜¯ä¸ºäº†å¯¹ \u0026ldquo;æ—¶é—´æˆ³\u0026rdquo; \u0026amp;\u0026amp; \u0026ldquo;æ ¼å¼åŒ–æ—¥æœŸ+æ—¶é—´å­—ç¬¦ä¸²\u0026rdquo; è¿›è¡Œå¿«é€Ÿè½¬æ¢ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚\nå¼€å‘äººå‘˜ï¼Œç»å¸¸ä¼šæ¶‰åŠåˆ°æ—¶é—´ç›¸å…³çš„è½¬æ¢æ“ä½œï¼Œæœ‰ä¸ªè¶æ‰‹çš„å·¥å…·è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚\næˆ‘å¹³æ—¶ä½¿ç”¨alfredæ¯”è¾ƒå¤šï¼Œè‡ªç„¶å°±æƒ³é€šè¿‡workflowçš„æ–¹å¼æ¥å®ç°ï¼Œå½“ç„¶ç”¨hammerspoonã€petç­‰å…¶ä»–å·¥å…·ä¹Ÿå¯ä»¥ã€‚\nalfred workflowå’Œalfredæœ¬èº«çš„äº¤äº’æ˜¯é€šè¿‡ç®¡é“æ–¹å¼è¿›è¡Œè¿æ¥çš„ï¼š\n alfredå°†ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯è½¬å‘ç»™åŒ¹é…çš„workflowï¼› workflowå¯¹æ¥æ”¶åˆ°çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†å¤„ç†çš„ç»“æœæŒ‰ç…§æŒ‡å®šæ ¼å¼è¾“å‡ºåˆ°stdoutï¼› alfredè¯»å–stdoutä¸­çš„æ•°æ®ä½œä¸ºå“åº”å±•ç¤ºåˆ°ç”¨æˆ·ç•Œé¢ï¼›  è¿™é‡Œä¸»è¦ä½¿ç”¨äº†awgoæ¥ç¼–å†™workflowï¼Œå®ç°é€»è¾‘å¯ä»¥å‚è€ƒä¸‹ä»£ç ï¼Œé€»è¾‘å¾ˆç®€å•ã€‚ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨ã€‚\nå¦‚ä½•å®‰è£…ï¼Ÿ # ä¸‹è½½é¡¹ç›®ä¸‹ workflow/Date Formats Go.alfredworkflowï¼ŒåŒå‡»å³å¯å®‰è£…ã€‚\nå¦‚ä½•ä½¿ç”¨ï¼Ÿ #   è¿è¡Œ datex å”¤èµ·workflow\n  å¸¸ç”¨è½¬æ¢æ“ä½œ: è·å–å½“å‰æ—¶é—´å¯¹åº”çš„Unixæ—¶é—´æˆ³ï¼Œä»¥åŠæ ¼å¼åŒ–å­—ç¬¦ä¸²\ndatex nowï¼Œå°†å½“å‰æ—¶é—´è½¬æ¢ä¸ºæ—¶é—´æˆ³ä»¥åŠæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²(å¤šç§æ—¥æœŸæ ¼å¼)ã€‚\nå¯ä»¥ç”¨ä¸Šä¸‹é”®ç§»åŠ¨è¿›è¡Œé€‰æ‹©ï¼Œå½“æŒ‰ä¸‹å›è½¦é”®æ—¶ï¼Œä¼šå°†å¯¹åº”çš„ç»“æœæ‹·è´åˆ°å‰ªè´´æ¿ï¼Œæ–¹ä¾¿ç²˜è´´ä½¿ç”¨ã€‚   å¸¸ç”¨è½¬æ¢æ“ä½œ: å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºå¯¹åº”çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²\nä»¥æ—¶é—´æˆ³1596137272ä¸ºä¾‹ï¼Œdatex 1596137272ï¼Œæ­¤æ—¶ä¼šå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ã€‚\né€‰æ‹©ã€å¤åˆ¶æ•°æ®æ“ä½œç±»ä¼¼ã€‚   å¸¸ç”¨è½¬æ¢æ“ä½œ: å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ—¶é—´æˆ³ï¼Œæˆ–å…¶ä»–æ ¼å¼\nä»¥å­—ç¬¦ä¸²2020-07-30ä¸ºä¾‹ï¼Œdatex 2020-07-30ï¼Œæ­¤æ—¶ä¼šå…ˆå°†å…¶ä¸å€™é€‰çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ã€‚\nå¹¶è½¬æ¢æˆä¸€ä¸ªæœ‰æ•ˆçš„æ—¶é—´æˆ³ã€‚ ç„¶åå†æ ¹æ®æ­¤æ—¶é—´æˆ³ï¼Œè½¬æ¢ä¸ºå…¶ä»–æ ¼å¼å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚é€‰æ‹©ã€å¤åˆ¶æ•°æ®æ“ä½œç±»ä¼¼ã€‚   è¿™å¤§è‡´å°±æ˜¯è¯¥workflowçš„ä½¿ç”¨æ–¹å¼ã€‚\nå…³äºæ—¥æœŸæ—¶é—´æ ¼å¼è½¬æ¢çš„workflowï¼Œgithubä¸Šå·²ç»æœ‰å‡ ä¸ªæ¯”è¾ƒå¥½çš„å®ç°äº†ï¼Œè½®å­ä¸å¥½ç”¨å°±å¾—è‡ªå·±é€ ã€‚\n å®ç°å¯¹timezoneæ”¯æŒä¸å¥½; é‡‡ç”¨çš„æ—¶é—´æ ¼å¼ä¸ç¬¦åˆå›½äººä¹ æƒ¯; æŒæ¡awgoå¼€å‘alfred workflowä»¥åå¯ä»¥å†™æ›´å¤šæ•ˆç‡å·¥å…·;  å¸Œæœ›è¿™ä¸ªå°å·¥å…·èƒ½å¸®åŠ©åˆ°æœ‰éœ€è¦çš„åŒå­¦ï¼Œä¹Ÿç»™å‡†å¤‡å¼€å‘alfred workflowæˆ–ä½¿ç”¨awgoå¼€å‘workflowçš„åŒå­¦æä¾›ä¸€ä¸ªç¤ºä¾‹ã€‚\nå¦‚ä½•å®ç°ï¼Ÿ # æµç¨‹å›¾æ¢³ç†ä¸‹é€»è¾‘ # å…ˆç”»ä¸ªæµç¨‹å›¾ï¼Œç®€å•ç†ä¸‹æ€è·¯ï¼Œæ€è·¯ç†æ¸…æ¥šäº†ï¼Œå†™ä»£ç å°±å¿«äº†ã€‚\nalfred.workflowç¼–æ’ # å¥½ï¼Œç†æ¸…æ¥šæ€è·¯ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å°è¯•å¯¹worklowè¿›è¡Œç¼–æ’ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nworkflowä¸­åŒ…å«2ä¸ªèŠ‚ç‚¹ï¼š\n  èŠ‚ç‚¹1ï¼Œæ˜¯ä¸€ä¸ªscript filterï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ä¸€ä¸ªå…³é”®å­—datexæ¥æ¿€æ´»å®ƒï¼Œå½“ç„¶è¿˜å¯ä»¥ç»§ç»­è¾“å…¥å‚æ•°ã€‚æ¿€æ´»è¯¥script filterä¹‹åï¼Œå®ƒå°†è°ƒç”¨æˆ‘ä»¬ç¼–å†™çš„æ—¶é—´è½¬æ¢ç¨‹åºalfred-datetime-workflowï¼Œç¨‹åºè¿”å›çš„ç»“æœå°†åœ¨alfredç•Œé¢ä¸Šè¿›è¡Œå±•ç¤ºï¼Œå±•ç¤ºçš„æ ·å¼æ˜¯åˆ—è¡¨ã€‚å¦‚æˆ‘ä»¬è¾“å…¥datex nowï¼Œå°†æ˜¾ç¤ºç°åœ¨çš„æ—¶é—´æˆ³ä»¥åŠå…¶ä»–æ ¼å¼çš„datetimeå­—ç¬¦ä¸²ã€‚\n  èŠ‚ç‚¹2ï¼Œæ˜¯Copy to Clipboardï¼Œå®ƒå¹²ä»€ä¹ˆå‘¢ï¼ŸèŠ‚ç‚¹1ä¸­æ˜¾ç¤ºäº†åˆ—è¡¨ä¹‹åï¼Œç”¨æˆ·é€‰æ‹©ä¸€ä¸ªåˆ—è¡¨é¡¹+å›è½¦ä¹‹åï¼Œé€‰ä¸­çš„åˆ—è¡¨é¡¹å¯¹åº”çš„å‚æ•°å€¼å°†è¢«ä¼ é€’ç»™è¯¥èŠ‚ç‚¹ä½œä¸ºå‚æ•°ï¼ŒCopy to Clipboardå°±æ˜¯å°†å‚æ•°æ‹·è´åˆ°å‰ªè´´æ¿ï¼›\n   å¦‚æœå¸Œæœ›åœ¨workflowå„èŠ‚ç‚¹ä¸­ä¼ é€’å‚æ•°ï¼Œåˆ™å¯ä»¥é€šè¿‡ workflow.Var(envname, value) æ¥è®¾ç½®å˜é‡ï¼Œé€šè¿‡ workflow.Config.Get${Type}(envname) æ¥è·å–å˜é‡ã€‚\n å¥½çš„ï¼Œä¸‹é¢æ¥çœ‹ä¸‹è¿™é‡Œçš„æ—¶é—´è½¬æ¢ç¨‹åºæ€ä¹ˆå†™ï¼Œæ€ä¹ˆä¸alfredè¡”æ¥èµ·æ¥ã€‚\nalfred.workflowæ—¶é—´è½¬æ¢ç¨‹åº # è¿™é‡Œçš„æ—¶é—´è½¬æ¢ç¨‹åºï¼Œå¯ä»¥æ˜¯ä»»æ„è¯­è¨€ç¼–å†™æ„å»ºçš„äºŒè¿›åˆ¶ç¨‹åºï¼Œä¹Ÿå¯ä»¥æ˜¯shellè„šæœ¬ï¼Œéƒ½å¯ä»¥ï¼Œåªè¦èƒ½è§£æalfredä¼ é€’çš„è¾“å…¥å‚æ•°ã€è¿”å›alfredæŒ‡å®šæ ¼å¼çš„ç»“æœå°±å¯ä»¥ã€‚awgoè¿™ä¸ªåº“ç®€åŒ–äº†å’Œalfredäº¤äº’çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªåº“ä¸»è¦æ˜¯ç®€åŒ–å’Œalfredæ•°æ®æ ¼å¼çš„è¡”æ¥ã€‚\nä¸»ä½“é€»è¾‘å¾ˆç®€å•ï¼Œå®ä¾‹åŒ–awgo.Workflowï¼Œç„¶åæ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥åå”¤é†’æ‰§è¡Œã€‚è¿™é‡Œçš„å›è°ƒå‡½æ•°ï¼Œå°±æ˜¯è¿™é‡Œçš„runæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•å†…éƒ¨å®Œæˆæ—¶é—´çš„è½¬æ¢é€»è¾‘å³å¯ã€‚\npackage main import ( aw \u0026quot;github.com/deanishe/awgo\u0026quot; ) func main() { workflow = aw.New() workflow.Run(run) }  å®ç°æ—¶é—´è½¬æ¢é€»è¾‘ # å‰é¢æˆ‘ä»¬ç»™å‡ºçš„æµç¨‹å›¾ï¼Œå¤§éƒ¨åˆ†æ˜¯runæ–¹æ³•çš„é€»è¾‘ï¼Œç…§ç€æµç¨‹å›¾æ¥å†™ä»£ç é€»è¾‘ï¼ŒåŸºæœ¬ä¸Šä¸€éå®Œæˆã€‚so easy!\npackage main import ( ... aw \u0026quot;github.com/deanishe/awgo\u0026quot; ) var ( workflow *aw.Workflow icon = \u0026amp;aw.Icon{ Value: aw.IconClock.Value, Type: aw.IconClock.Type, } layouts = []string{ \u0026quot;2006-01-02 15:04:05.999 MST\u0026quot;, \u0026quot;2006-01-02 15:04:05.999 -0700\u0026quot;, time.RFC3339, time.RFC3339Nano, time.UnixDate, time.RubyDate, time.RFC1123Z, } moreLayouts = []string{ \u0026quot;2006-01-02\u0026quot;, \u0026quot;2006-01-02 15:04\u0026quot;, \u0026quot;2006-01-02 15:04:05\u0026quot;, \u0026quot;2006-01-02 15:04:05.999\u0026quot;, } regexpTimestamp = regexp.MustCompile(`^[1-9]{1}\\d+$`) ) func run() { var err error args := workflow.Args() if len(args) == 0 { return } defer func() { if err == nil { workflow.SendFeedback() return } }() // å¤„ç† now input := strings.Join(args, \u0026quot; \u0026quot;) if input == \u0026quot;now\u0026quot; { processNow() return } // å¤„ç†æ—¶é—´æˆ³ if regexpTimestamp.MatchString(input) { v, e := strconv.ParseInt(args[0], 10, 32) if e == nil { processTimestamp(time.Unix(v, 0)) return } err = e return } // å¤„ç†æ—¶é—´å­—ç¬¦ä¸² err = processTimeStr(input) } func processNow() { now := time.Now() // prepend unix timestamp secs := fmt.Sprintf(\u0026quot;%d\u0026quot;, now.Unix()) workflow.NewItem(secs). Subtitle(\u0026quot;unix timestamp\u0026quot;). Icon(icon). Arg(secs). Valid(true) // process all time layouts processTimestamp(now) } // process all time layouts func processTimestamp(timestamp time.Time) { for _, layout := range layouts { v := timestamp.Format(layout) workflow.NewItem(v). Subtitle(layout). Icon(icon). Arg(v). Valid(true) } } func processTimeStr(timestr string) error { timestamp := time.Time{} layoutMatch := \u0026quot;\u0026quot; layoutMatch, timestamp, ok := matchedLayout(layouts, timestr) if !ok { layoutMatch, timestamp, ok = matchedLayout(moreLayouts, timestr) if !ok { return errors.New(\u0026quot;no matched time layout found\u0026quot;) } } // prepend unix timestamp secs := fmt.Sprintf(\u0026quot;%d\u0026quot;, timestamp.Unix()) workflow.NewItem(secs). Subtitle(\u0026quot;unix timestamp\u0026quot;). Icon(icon). Arg(secs). Valid(true) // other time layouts for _, layout := range layouts { if layout == layoutMatch { continue } v := timestamp.Format(layout) workflow.NewItem(v). Subtitle(layout). Icon(icon). Arg(v). Valid(true) } return nil } func matchedLayout(layouts []string, timestr string) (matched string, timestamp time.Time, ok bool) { for _, layout := range layouts { v, err := time.Parse(layout, timestr) if err == nil { return layout, v, true } } return }  å¯¼å‡ºalfred.workflow # å¼€å‘ã€æµ‹è¯•ã€éªŒè¯ï¼Œä¸€åˆ‡okä¹‹åï¼Œå°±å¯ä»¥åœ¨alfredå†…éƒ¨å°†workflowæ•´ä¸ªå¯¼å‡ºäº†ï¼Œå¯¼å‡ºåçš„æ–‡ä»¶ä»¥*.alfredworkflowä½œä¸ºæ‰©å±•åï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯å¯ä»¥æ‹¿æ¥åˆ†å‘çš„æ–‡ä»¶ï¼Œä½¿ç”¨è€…ç›´æ¥åŒå‡»å°±å¯ä»¥å®‰è£…ä½¿ç”¨ã€‚\nawgoè¯•ç”¨å°ç»“ # è¿™æ˜¯ä½¿ç”¨awgoç¼–å†™çš„ç¬¬ä¸€ä¸ªworkflowç¨‹åºï¼Œæ•´ä½“æ„Ÿè§‰æ¥è¯´ï¼Œå¼€å‘è€…å¯ä»¥ä¸“æ³¨äºåŠŸèƒ½çš„å®ç°ï¼Œä¸ç”¨è¿‡åº¦å…³æ³¨alfredæ•°æ®æ ¼å¼æ–¹é¢çš„é—®é¢˜ã€‚\nalfredæœ¬èº«å¾ˆå¼ºå¤§ï¼Œæ”¯æŒå„ç§å„æ ·çš„workflowç®—å­ï¼Œawgoåˆ°åº•èƒ½æ”¯æŒåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œè¿™ä¸ªè¿˜è¦åœ¨åç»­ä½¿ç”¨ä¸­é€æ¸æ¢ç´¢ã€‚\næ„Ÿå…´è¶£çš„è¯ï¼Œä¸å¦¨ä¸€è¯•ï¼Œè‡³å°‘æ¯”å†™apple scriptè„šæœ¬ã€bashè„šæœ¬ç­‰è¦æ–¹ä¾¿å¤šäº†ã€‚\n"}),a.add({id:270,href:"/tags/bindata/",title:"bindata",description:"",content:""}),a.add({id:271,href:"/blog/2020-07-25-%E5%A6%82%E4%BD%95%E5%9C%A8go%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%A8%8B%E5%BA%8F%E4%B8%AD%E6%89%93%E5%8C%85%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%96%87%E4%BB%B6/",title:"å¦‚ä½•åœ¨goäºŒè¿›åˆ¶ç¨‹åºä¸­æ‰“åŒ…é™æ€èµ„æºæ–‡ä»¶",description:"Why? # æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›åœ¨goäºŒè¿›åˆ¶ç¨‹åºä¸­æ‰“åŒ…ä¸€äº›é™æ€èµ„æºæ–‡ä»¶ï¼Œç›®çš„å¯èƒ½æœ‰å¤šç§ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯ä¸ºäº†ç®€åŒ–å®‰è£…ã€‚é€šå¸¸æˆ‘ä»¬å®‰è£…ä¸€ä¸ªgoç¼–å†™çš„å·¥å…·ï¼Œæ›´å€¾å‘äºä½¿ç”¨ go get $repo çš„æ–¹å¼æ¥å®Œæˆï¼Œè¿™ä¼¼ä¹å·²ç»æˆä¸ºäº†ä¸€ç§å…±è¯†ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰äº›é¡¹ç›®è¿˜ä¾èµ–ä¸€äº›é™æ€èµ„æºæ–‡ä»¶ï¼Œè¿™äº›é™æ€èµ„æºæ–‡ä»¶æ˜¯ä¸ä¼šè¢«è‡ªåŠ¨å®‰è£…çš„ï¼Œå°±éœ€è¦å€ŸåŠ©å…¶ä»–æ–¹å¼æ¥å®Œæˆé™æ€èµ„æºçš„å®‰è£…ï¼Œæ¯”å¦‚é€šè¿‡install.shè„šæœ¬ï¼Œåè€…Makefileæ„å»ºè„šæœ¬ç­‰ç­‰ã€‚\nä»Šå¤©ï¼Œæˆ‘æƒ³è®¨è®ºä¸‹ï¼Œå¦‚ä½•ç®€å•å¿«é€Ÿåœ°æ”¯æŒé™æ€èµ„æºæ‰“åŒ…åˆ°äºŒè¿›åˆ¶ç¨‹åºä¸­ï¼Œä»¥åŠåœ¨äºŒè¿›åˆ¶ç¨‹åºä¸­å¯¹è¿™äº›é™æ€èµ„æºåŠ ä»¥å¼•ç”¨ã€‚\nHow? # githubä¸Šå·²ç»æœ‰ä¸å°‘å¼€å‘è€…åœ¨æ¢ç´¢ï¼Œæ–¹æ³•å…¶å®éƒ½æ¯”è¾ƒé›·åŒï¼Œå¤§è‡´æ€è·¯å°±æ˜¯ï¼š\n è¯»å–é™æ€èµ„æºæ–‡ä»¶ï¼Œè½¬æ¢æˆbytesæ•°æ®ï¼› å†…éƒ¨æä¾›ä¸€äº›ç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ï¼Œæä¾›æ–‡ä»¶åï¼Œè¿”å›æ–‡ä»¶æ•°æ®ï¼› blabla\u0026hellip;  å¼€å‘è€…çš„éœ€æ±‚ï¼Œå¯èƒ½ä¸å®Œå…¨ä¸€è‡´ï¼Œæ¯”å¦‚ï¼š\n æˆ‘æƒ³åƒéå†æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸€æ ·éå†æ–‡ä»¶ç›®å½•ï¼Œä¸åªæ˜¯æä¾›ä¸€ä¸ªæ–‡ä»¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶ï¼› æˆ‘çš„ä»£ç å·²ç»å†™å®Œäº†ï¼Œæˆ‘åªæƒ³åšæœ€å°ä¿®æ”¹ï¼Œå°†é™æ€èµ„æºæ–‡ä»¶æ‰“åŒ…åˆ°äºŒè¿›åˆ¶ç¨‹åºä¸­ï¼Œè€Œåè¿˜åŸå›æ–‡ä»¶ç³»ç»Ÿï¼› æˆ‘çš„ä»£ç ä¸éœ€è¦æ”¯æŒç±»ä¼¼æ–‡ä»¶æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œä¸éœ€è¦é‚£ä¹ˆå¤šåä¸½å‘¼å“¨çš„åŠŸèƒ½ï¼›  å¼€å‘è€…æä¾›äº†å¾ˆå¤šç±»ä¼¼çš„å®ç°ï¼Œè¿™é‡Œæœ‰ç¯‡æ–‡ç« å¯ä¾›å‚è€ƒï¼šhttps://tech.townsourced.com/post/embedding-static-files-in-go/ã€‚èƒ½å·¥æ¨¡å½¢ï¼Œå·§åŒ çªƒæ„ã€‚å…¶å®åœ¨å¤§è‡´äº†è§£äº†å®ç°çš„æ–¹å¼ä¹‹åï¼Œå°±æ‡’å¾—å†å»å­¦å¦‚ä½•ä½¿ç”¨è¿™äº›äº”èŠ±å…«é—¨çš„ç¬¬ä¸‰æ–¹å·¥å…·äº†ã€‚è¯´çœŸçš„ï¼ŒçœŸçš„æ²¡å‡ ä¸ªå¥½ç”¨çš„ï¼Œè‡³å°‘ä»æˆ‘çš„è§’åº¦æ¥è¯´ã€‚å¯èƒ½å®ƒè®¾è®¡çš„æ¯”è¾ƒé€šç”¨ï¼Œä½†æ˜¯ä¸æˆ‘æ¥è¯´æ²¡æœ‰ç”¨å¤„ï¼Œæˆ‘è¿½æ±‚æç®€ã€‚\nè€Œä¸”ï¼Œgoå®˜æ–¹æ˜¯æœ‰æ„æ¥æ”¯æŒæ‰“åŒ…é™æ€èµ„æºçš„ï¼Œå…³äºè¿™ä¸€ç‚¹ï¼Œå·²ç»æœ‰issueåœ¨è·Ÿè¿›è®¨è®ºï¼šhttps://github.com/golang/go/issues/35950ã€‚\nå°½ç®¡ç°åœ¨çš„çŠ¶æ€è¿˜æ˜¯Proposal-HoldçŠ¶æ€ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ä¸ªfeatureçš„åˆ°æ¥ä¹Ÿä¸ä¼šç­‰å¾ˆä¹…äº†ï¼Œanywayï¼Œæˆ‘ä¸æƒ³åœ¨è¿™äº›å³å°†è¢«æ·˜æ±°çš„ä¸‰æ–¹å·¥å…·ä¸Šæµªè´¹å­¦ä¹ çš„æ—¶é—´ã€æ”¹å†™ä»£ç çš„æ—¶é—´ã€‚\næ‰€ä»¥å‘¢ï¼Œä¸ºä»€ä¹ˆä¸ç®€å•ä¸€ç‚¹ï¼Œè‡ªå·±å†™ä¸€ä¸ªå½“ä¸‹æ¯”è¾ƒé€‚ç”¨é¡¹ç›®æœ¬èº«çš„ï¼Ÿå†™è¿™ä¸ªä¸œè¥¿èŠ±ä¸äº†äºŒååˆ†é’Ÿæ—¶é—´ï¼\nLet\u0026rsquo;s Do it! # åŠŸèƒ½åˆ†æ # æˆ‘ç†è§£å®ç°æ‰“åŒ…é™æ€èµ„æºæ–‡ä»¶ï¼Œæœ‰è¿™ä¹ˆå‡ ä¸ªç‚¹éœ€è¦è€ƒè™‘ï¼š\n æä¾›ä¸€ä¸ªå°å·¥å…·ï¼Œé€šè¿‡å®ƒå¯ä»¥åå¤æ‰§è¡Œç±»ä¼¼çš„é™æ€èµ„æºæ‰“åŒ…çš„æ“ä½œï¼› å¯ä»¥æŒ‡å®šä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œå°†å…¶è½¬æ¢æˆä¸€ä¸ªgoæ–‡ä»¶æ”¾å…¥é¡¹ç›®ä¸­ï¼Œå…è®¸ç¼–è¯‘æ—¶è¿æ¥ï¼› goæ–‡ä»¶å¯ä»¥é€šè¿‡å¯¼å‡ºå˜é‡çš„å½¢å¼ï¼Œå¯¼å‡ºæ–‡ä»¶æ•°æ®ï¼Œå…è®¸åœ¨å…¶ä»–goä»£ç ä¸­å¼•ç”¨æ–‡ä»¶çš„å†…å®¹ï¼› é™æ€èµ„æºæ–‡ä»¶å¯èƒ½æœ‰å¾ˆå¤šï¼Œå¸Œæœ›èƒ½å¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œå‹ç¼©ï¼Œä»¥ä¾¿å‡å°go binaryæ–‡ä»¶å°ºå¯¸ï¼› é€šå¸¸æ˜¯æœ¬åœ°ç»„ç»‡å¥½é™æ€èµ„æºæ–‡ä»¶ï¼Œå†™ä»£ç ã€æµ‹è¯•okã€æœ€åå‘å¸ƒå‰å¸Œæœ›å°†å…¶æ‰“åŒ…åˆ°go binaryï¼Œæ‰“åŒ…ã€è§£åŒ…ã€ä½¿ç”¨é™æ€èµ„æºè¦æœ€å°åŒ–é¡¹ç›®ä»£ç ä¿®æ”¹ï¼›  åŠŸèƒ½å®ç° # æˆ‘ä»¬å…ˆå®ç°è¿™ä¸ªæ‰“åŒ…é™æ€èµ„æºçš„å·¥å…·ï¼Œéœ€è¦è¿™å‡ ä¸ªå‚æ•°ï¼šinputã€outputï¼Œåˆ†åˆ«ä»£è¡¨è¾“å…¥æ–‡ä»¶ï¼ˆor ç›®å½•ï¼‰ã€è¾“å‡ºæ–‡ä»¶åï¼ˆgoæ–‡ä»¶ï¼‰ï¼Œgopkgä»£è¡¨è¾“å‡ºgoæ–‡ä»¶çš„åŒ…åï¼ˆé»˜è®¤gobinï¼‰ã€‚\npackage main var ( input = flag.String(\u0026quot;input\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;read data from input, which could be a regular file or directory\u0026quot;) output = flag.String(\u0026quot;output\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;write transformed data to named *.",content:"Why? # æœ‰æ—¶æˆ‘ä»¬å¸Œæœ›åœ¨goäºŒè¿›åˆ¶ç¨‹åºä¸­æ‰“åŒ…ä¸€äº›é™æ€èµ„æºæ–‡ä»¶ï¼Œç›®çš„å¯èƒ½æœ‰å¤šç§ï¼Œæ¯”è¾ƒå¸¸è§çš„æ˜¯ä¸ºäº†ç®€åŒ–å®‰è£…ã€‚é€šå¸¸æˆ‘ä»¬å®‰è£…ä¸€ä¸ªgoç¼–å†™çš„å·¥å…·ï¼Œæ›´å€¾å‘äºä½¿ç”¨ go get $repo çš„æ–¹å¼æ¥å®Œæˆï¼Œè¿™ä¼¼ä¹å·²ç»æˆä¸ºäº†ä¸€ç§å…±è¯†ã€‚å½“ç„¶ï¼Œä¹Ÿæœ‰äº›é¡¹ç›®è¿˜ä¾èµ–ä¸€äº›é™æ€èµ„æºæ–‡ä»¶ï¼Œè¿™äº›é™æ€èµ„æºæ–‡ä»¶æ˜¯ä¸ä¼šè¢«è‡ªåŠ¨å®‰è£…çš„ï¼Œå°±éœ€è¦å€ŸåŠ©å…¶ä»–æ–¹å¼æ¥å®Œæˆé™æ€èµ„æºçš„å®‰è£…ï¼Œæ¯”å¦‚é€šè¿‡install.shè„šæœ¬ï¼Œåè€…Makefileæ„å»ºè„šæœ¬ç­‰ç­‰ã€‚\nä»Šå¤©ï¼Œæˆ‘æƒ³è®¨è®ºä¸‹ï¼Œå¦‚ä½•ç®€å•å¿«é€Ÿåœ°æ”¯æŒé™æ€èµ„æºæ‰“åŒ…åˆ°äºŒè¿›åˆ¶ç¨‹åºä¸­ï¼Œä»¥åŠåœ¨äºŒè¿›åˆ¶ç¨‹åºä¸­å¯¹è¿™äº›é™æ€èµ„æºåŠ ä»¥å¼•ç”¨ã€‚\nHow? # githubä¸Šå·²ç»æœ‰ä¸å°‘å¼€å‘è€…åœ¨æ¢ç´¢ï¼Œæ–¹æ³•å…¶å®éƒ½æ¯”è¾ƒé›·åŒï¼Œå¤§è‡´æ€è·¯å°±æ˜¯ï¼š\n è¯»å–é™æ€èµ„æºæ–‡ä»¶ï¼Œè½¬æ¢æˆbytesæ•°æ®ï¼› å†…éƒ¨æä¾›ä¸€äº›ç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„æ¥å£ï¼Œæä¾›æ–‡ä»¶åï¼Œè¿”å›æ–‡ä»¶æ•°æ®ï¼› blabla\u0026hellip;  å¼€å‘è€…çš„éœ€æ±‚ï¼Œå¯èƒ½ä¸å®Œå…¨ä¸€è‡´ï¼Œæ¯”å¦‚ï¼š\n æˆ‘æƒ³åƒéå†æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸€æ ·éå†æ–‡ä»¶ç›®å½•ï¼Œä¸åªæ˜¯æä¾›ä¸€ä¸ªæ–‡ä»¶åè¿”å›ä¸€ä¸ªæ–‡ä»¶ï¼› æˆ‘çš„ä»£ç å·²ç»å†™å®Œäº†ï¼Œæˆ‘åªæƒ³åšæœ€å°ä¿®æ”¹ï¼Œå°†é™æ€èµ„æºæ–‡ä»¶æ‰“åŒ…åˆ°äºŒè¿›åˆ¶ç¨‹åºä¸­ï¼Œè€Œåè¿˜åŸå›æ–‡ä»¶ç³»ç»Ÿï¼› æˆ‘çš„ä»£ç ä¸éœ€è¦æ”¯æŒç±»ä¼¼æ–‡ä»¶æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œä¸éœ€è¦é‚£ä¹ˆå¤šåä¸½å‘¼å“¨çš„åŠŸèƒ½ï¼›  å¼€å‘è€…æä¾›äº†å¾ˆå¤šç±»ä¼¼çš„å®ç°ï¼Œè¿™é‡Œæœ‰ç¯‡æ–‡ç« å¯ä¾›å‚è€ƒï¼šhttps://tech.townsourced.com/post/embedding-static-files-in-go/ã€‚èƒ½å·¥æ¨¡å½¢ï¼Œå·§åŒ çªƒæ„ã€‚å…¶å®åœ¨å¤§è‡´äº†è§£äº†å®ç°çš„æ–¹å¼ä¹‹åï¼Œå°±æ‡’å¾—å†å»å­¦å¦‚ä½•ä½¿ç”¨è¿™äº›äº”èŠ±å…«é—¨çš„ç¬¬ä¸‰æ–¹å·¥å…·äº†ã€‚è¯´çœŸçš„ï¼ŒçœŸçš„æ²¡å‡ ä¸ªå¥½ç”¨çš„ï¼Œè‡³å°‘ä»æˆ‘çš„è§’åº¦æ¥è¯´ã€‚å¯èƒ½å®ƒè®¾è®¡çš„æ¯”è¾ƒé€šç”¨ï¼Œä½†æ˜¯ä¸æˆ‘æ¥è¯´æ²¡æœ‰ç”¨å¤„ï¼Œæˆ‘è¿½æ±‚æç®€ã€‚\nè€Œä¸”ï¼Œgoå®˜æ–¹æ˜¯æœ‰æ„æ¥æ”¯æŒæ‰“åŒ…é™æ€èµ„æºçš„ï¼Œå…³äºè¿™ä¸€ç‚¹ï¼Œå·²ç»æœ‰issueåœ¨è·Ÿè¿›è®¨è®ºï¼šhttps://github.com/golang/go/issues/35950ã€‚\nå°½ç®¡ç°åœ¨çš„çŠ¶æ€è¿˜æ˜¯Proposal-HoldçŠ¶æ€ï¼Œä½†æ˜¯æˆ‘è§‰å¾—è¿™ä¸ªfeatureçš„åˆ°æ¥ä¹Ÿä¸ä¼šç­‰å¾ˆä¹…äº†ï¼Œanywayï¼Œæˆ‘ä¸æƒ³åœ¨è¿™äº›å³å°†è¢«æ·˜æ±°çš„ä¸‰æ–¹å·¥å…·ä¸Šæµªè´¹å­¦ä¹ çš„æ—¶é—´ã€æ”¹å†™ä»£ç çš„æ—¶é—´ã€‚\næ‰€ä»¥å‘¢ï¼Œä¸ºä»€ä¹ˆä¸ç®€å•ä¸€ç‚¹ï¼Œè‡ªå·±å†™ä¸€ä¸ªå½“ä¸‹æ¯”è¾ƒé€‚ç”¨é¡¹ç›®æœ¬èº«çš„ï¼Ÿå†™è¿™ä¸ªä¸œè¥¿èŠ±ä¸äº†äºŒååˆ†é’Ÿæ—¶é—´ï¼\nLet\u0026rsquo;s Do it! # åŠŸèƒ½åˆ†æ # æˆ‘ç†è§£å®ç°æ‰“åŒ…é™æ€èµ„æºæ–‡ä»¶ï¼Œæœ‰è¿™ä¹ˆå‡ ä¸ªç‚¹éœ€è¦è€ƒè™‘ï¼š\n æä¾›ä¸€ä¸ªå°å·¥å…·ï¼Œé€šè¿‡å®ƒå¯ä»¥åå¤æ‰§è¡Œç±»ä¼¼çš„é™æ€èµ„æºæ‰“åŒ…çš„æ“ä½œï¼› å¯ä»¥æŒ‡å®šä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œå°†å…¶è½¬æ¢æˆä¸€ä¸ªgoæ–‡ä»¶æ”¾å…¥é¡¹ç›®ä¸­ï¼Œå…è®¸ç¼–è¯‘æ—¶è¿æ¥ï¼› goæ–‡ä»¶å¯ä»¥é€šè¿‡å¯¼å‡ºå˜é‡çš„å½¢å¼ï¼Œå¯¼å‡ºæ–‡ä»¶æ•°æ®ï¼Œå…è®¸åœ¨å…¶ä»–goä»£ç ä¸­å¼•ç”¨æ–‡ä»¶çš„å†…å®¹ï¼› é™æ€èµ„æºæ–‡ä»¶å¯èƒ½æœ‰å¾ˆå¤šï¼Œå¸Œæœ›èƒ½å¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œå‹ç¼©ï¼Œä»¥ä¾¿å‡å°go binaryæ–‡ä»¶å°ºå¯¸ï¼› é€šå¸¸æ˜¯æœ¬åœ°ç»„ç»‡å¥½é™æ€èµ„æºæ–‡ä»¶ï¼Œå†™ä»£ç ã€æµ‹è¯•okã€æœ€åå‘å¸ƒå‰å¸Œæœ›å°†å…¶æ‰“åŒ…åˆ°go binaryï¼Œæ‰“åŒ…ã€è§£åŒ…ã€ä½¿ç”¨é™æ€èµ„æºè¦æœ€å°åŒ–é¡¹ç›®ä»£ç ä¿®æ”¹ï¼›  åŠŸèƒ½å®ç° # æˆ‘ä»¬å…ˆå®ç°è¿™ä¸ªæ‰“åŒ…é™æ€èµ„æºçš„å·¥å…·ï¼Œéœ€è¦è¿™å‡ ä¸ªå‚æ•°ï¼šinputã€outputï¼Œåˆ†åˆ«ä»£è¡¨è¾“å…¥æ–‡ä»¶ï¼ˆor ç›®å½•ï¼‰ã€è¾“å‡ºæ–‡ä»¶åï¼ˆgoæ–‡ä»¶ï¼‰ï¼Œgopkgä»£è¡¨è¾“å‡ºgoæ–‡ä»¶çš„åŒ…åï¼ˆé»˜è®¤gobinï¼‰ã€‚\npackage main var ( input = flag.String(\u0026quot;input\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;read data from input, which could be a regular file or directory\u0026quot;) output = flag.String(\u0026quot;output\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;write transformed data to named *.go, which could be linked with binary\u0026quot;) gopkg = flag.String(\u0026quot;gopkg\u0026quot;, \u0026quot;gobin\u0026quot;, \u0026quot;write transformed data to *.go, whose package is $package\u0026quot;) )  æˆ‘ä»¬çš„å·¥å…·å°†ä»inputå¯¹åº”çš„æ–‡ä»¶ä¸­è¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¹¶è½¬æ¢æˆä¸€ä¸ªoutputå¯¹åº”çš„goæ–‡ä»¶ä¸­çš„å¯¼å‡ºå˜é‡ã€‚å¦‚æœinputæ˜¯ä¸€ä¸ªç›®å½•å‘¢ï¼Œæˆ‘ä»¬åˆ™éœ€è¦å¯¹ç›®å½•ä¸‹æ–‡ä»¶è¿›è¡Œéå†å¤„ç†ã€‚ç”±äºé™æ€èµ„æºæ–‡ä»¶æ•°æ®å¯èƒ½è¾ƒå¤§ï¼Œè¿™é‡Œéœ€è¦è¿›è¡Œgzipå‹ç¼©ï¼ˆå¯¹äºæ–‡æœ¬å‹ç¼©ç‡å¯é«˜è¾¾80%å·¦å³ï¼‰æœ‰åŠ©äºå‡å°‘go binaryæ–‡ä»¶å°ºå¯¸ã€‚\né‚£è¯»å–åˆ°æ–‡ä»¶å†…å®¹ä¹‹åï¼Œå¦‚ä½•å°†å…¶è½¬æ¢æˆgoæ–‡ä»¶ä¸­çš„å¯¼å‡ºå˜é‡å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªgoæ¨¡æ¿ï¼Œå°†è¯»å–åˆ°çš„æ–‡ä»¶å†…å®¹gzipå‹ç¼©åè½¬æ¢æˆbytesæ•°ç»„ä¼ é€’ç»™æ¨¡æ¿å¼•æ“å°±å¯ä»¥äº†ã€‚æ¨¡æ¿ä¸­çš„{{.GoPackage}}å°†å¼•ç”¨å‘½ä»¤é€‰é¡¹$gopkgçš„å€¼ï¼Œ{{.Variable}}å³ä¸ºå¯¼å‡ºå˜é‡çš„å€¼ï¼Œè¿™é‡Œæˆ‘ä»¬ä¼šä½¿ç”¨é€‰é¡¹$inputå¯¹åº”çš„CamelCaseè½¬æ¢ä¹‹åçš„æ–‡ä»¶åï¼ˆæˆ–ç›®å½•åï¼‰ï¼Œ{{.Data}}å³ä¸ºgzipå‹ç¼©åçš„æ–‡ä»¶æ•°æ®ã€‚\nvar tpl = `package {{.GoPackage}} var {{.Variable}} = []uint8{ {{ range $idx, $val := .Data }}{{$val}},{{ end }} }`  æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ€ä¹ˆè¯»å–æ–‡ä»¶çš„å†…å®¹ï¼Œå†å¼ºè°ƒä¸‹ï¼Œè¦è¯»å–çš„å†…å®¹å¯èƒ½æ˜¯å•ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç›®å½•ã€‚\n// ReadFromInputSource ä»è¾“å…¥è¯»å–å†…å®¹ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç›®å½•ï¼ˆä¼šå…ˆgzipå‹ç¼©ç„¶åå†è¿”å›å†…å®¹ï¼‰ func ReadFromInputSource(inputSource string) (data []byte, err error) { _, err := os.Lstat(inputSource) if err != nil { return nil, err } buf := bytes.Buffer{} err = compress.Tar(inputSource, \u0026amp;buf) if err != nil { return nil, err } return buf.Bytes(), nil }  gzipå¯¹æ–‡ä»¶æ•°æ®è¿›è¡Œå‹ç¼©ï¼Œç¯‡å¹…åŸå› ï¼Œè¿™é‡Œåªè´´ä¸ªé“¾æ¥åœ°å€ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ï¼šhttps://github.com/hitzhangjie/codemaster/blob/master/compress/compress.goã€‚\nå¥½ï¼Œç°åœ¨æˆ‘ä»¬å°†è¿™ä¸ªæ‰“åŒ…å·¥å…·çš„å®Œæ•´é€»è¾‘å†å®Œæ•´æ¢³ç†ä¸€ä¸‹ã€‚\nfunc main() { // è¾“å…¥è¾“å‡ºå‚æ•°æ ¡éªŒ if len(*input) == 0 || len(*gopkg) == 0 { fmt.Println(\u0026quot;invalid argument: invalid input\u0026quot;) os.Exit(1) } // è¯»å–è¾“å…¥å†…å®¹ buf, err := ReadFromInputSource(*input) if err != nil { fmt.Errorf(\u0026quot;read data error: %v\\n\u0026quot;, err) os.Exit(1) } // å°†å†…å®¹è½¬æ¢æˆgoæ–‡ä»¶å†™å‡º inputBaseName := filepath.Base(*input) if len(*output) == 0 { *output = fmt.Sprintf(\u0026quot;%s_bindata.go\u0026quot;, inputBaseName) } outputDir, outputBaseName := filepath.Split(*output) tplInstance, err := template.New(outputBaseName).Parse(tpl) if err != nil { fmt.Printf(\u0026quot;parse template error: %v\\n\u0026quot;, err) os.Exit(1) } _ = os.MkdirAll(outputDir, 0777) fout, err := os.OpenFile(*output, os.O_CREATE|os.O_TRUNC|os.O_WRONLY, 0666) if err != nil { fmt.Printf(\u0026quot;open input error: %v\u0026quot;, err) os.Exit(1) } err = tplInstance.Execute(fout, \u0026amp;struct { GoPackage string Variable string Data []uint8 }{ GoPackage: *gopkg, Variable: strcase.ToCamel(outputBaseName), Data: buf, }) if err != nil { panic(fmt.Errorf(\u0026quot;template execute error: %v\u0026quot;, err)) } fmt.Printf(\u0026quot;ok, filedata stored to %s\\n\u0026quot;, *output) }  ä¸‹é¢æˆ‘ä»¬æ¼”ç¤ºä¸‹å¦‚ä½•ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥å¯¹é™æ€èµ„æºæ‰“åŒ…ã€‚\nå‡å®šå­˜åœ¨å¦‚ä¸‹é™æ€èµ„æºç›®å½•staticï¼Œå…¶ä¸‹åŒ…å«äº†å¤šä¸ªæ–‡ä»¶ï¼Œç°åœ¨æˆ‘æƒ³å°†å…¶å…¨éƒ¨æ‰“åŒ…åˆ°ä¸€ä¸ªgoæ–‡ä»¶ä¸­ã€‚\n$ tree . . |- static |- file1.txt |- file2.txt |- file3.txt  è¿è¡Œ go build -v bindata ç¼–è¯‘æˆ‘ä»¬ä¹‹å‰å†™çš„å·¥å…·ï¼Œç„¶åè¿è¡Œ bindata -input=path/to/static -output=goin/static.go -gopkg=gobinã€‚\n$ tree . . |- static |- file1.txt |- file2.txt |- file3.txt |- gobin |- static.go  æˆ‘ä»¬çœ‹åˆ°å½“å‰ç›®å½•ä¸‹å¤šç”Ÿæˆäº†ä¸€ä¸ªgobinç›®å½•ï¼Œå…¶ä¸‹å¤šäº†ä¸ªgoæ–‡ä»¶static.goï¼ŒæŸ¥çœ‹ä¸‹æ–‡ä»¶å†…å®¹ï¼š\n$ cat gobin/static.go package gobin var StaticGo = []uint8{ 31,139,8,0,0,0,0,0,0,255,236,213,193,10,194,48,12,128,225,158,125,138,62,129,36,77,219,60,79,15,171,171,136,7,91,65,124,122,105,39,131,29,244,182,58,89,190,75,24,140,209,145,253,44,166,203,128,199,242,40,106,61,0,0,222,218,54,217,187,54,193,76,215,13,178,66,98,240,236,25,136,21,32,121,100,165,97,197,51,205,238,185,132,155,2,120,142,225,122,58,167,225,211,125,185,132,24,191,60,231,253,42,243,252,19,101,76,89,167,172,235,119,160,241,240,235,227,136,206,234,222,205,150,250,183,78,250,239,104,209,191,145,254,247,166,238,157,182,212,191,155,254,255,134,164,255,30,22,253,147,244,47,132,16,123,241,10,0,0,255,255,106,242,211,179,0,16,0,0, }  å“ˆå“ˆï¼Œç°åœ¨çœ‹åˆ°staticç›®å½•åŠå…¶ä¸‹çš„æ–‡ä»¶å·²ç»è¢«å®Œæ•´æ‰“åŒ…åˆ°ä¸€ä¸ªgoæ–‡ä»¶ä¸­äº†ï¼Œä¸”é€šè¿‡å¯¼å‡ºå˜é‡è¿›è¡Œäº†å¯¼å‡ºï¼Œåç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆå°†å…¶è¿˜åŸåˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œä»¥å‰å·²ç»å†™å¥½çš„ä»£ç ä¸ç”¨åšä»»ä½•ä¿®æ”¹ï¼Œæ€ä¹ˆè¿˜åŸåˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå‘¢ï¼Œå¹¶ä½¿ç”¨å‘¢ï¼Ÿ\n// åœ¨ä½ éœ€è¦å¼•ç”¨è¿™äº›é™æ€èµ„æºçš„packageä¸­é‡Šæ”¾è¿™äº›é™æ€èµ„æºæ–‡ä»¶åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ func init() { compress.UnTar(path/to/static, bytes.NewBuffer(gobin.StaticGo)) val := config.Read(path/to/static/file1.go, \u0026quot;section\u0026quot;, \u0026quot;property\u0026quot;, defaultValue) ... }  ç°åœ¨ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰è¶…çº§ç®€å•å‘¢ï¼Ÿ:)\n"}),a.add({id:272,href:"/tags/cache/",title:"cache",description:"",content:""}),a.add({id:273,href:"/tags/cc++/",title:"cc++",description:"",content:""}),a.add({id:274,href:"/blog/2019-01-07-%E4%BD%A0%E4%B8%8D%E8%AE%A4%E8%AF%86%E7%9A%84cc-volatile/",title:"ä½ ä¸è®¤è¯†çš„cc++ volatile",description:"img { width: 680px; }  1. ä»¤äººå›°æƒ‘çš„volatile # volatileå­—é¢æ„æ€æ˜¯â€œä¸ç¨³å®šçš„ã€æ˜“å˜çš„â€ï¼Œä¸å°‘ç¼–ç¨‹è¯­è¨€ä¸­å­˜åœ¨volatileå…³é”®å­—ï¼Œä¹Ÿæœ‰å…±åŒä¹‹å¤„ï¼Œå¦‚â€œè¡¨ç¤ºç¨‹åºæ‰§è¡ŒæœŸé—´æ•°æ®å¯èƒ½ä¼šè¢«å¤–éƒ¨æ“ä½œä¿®æ”¹â€ï¼Œå¦‚è¢«å¤–è®¾ä¿®æ”¹æˆ–è€…è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ç­‰ã€‚è¿™åªæ˜¯å­—é¢ä¸Šç»™æˆ‘ä»¬çš„ä¸€èˆ¬æ€§è®¤è¯†ï¼Œç„¶è€Œå…·ä½“åˆ°ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸­volatileçš„è¯­ä¹‰å¯èƒ½ç›¸å·®ç”šè¿œã€‚\nå¾ˆå¤šäººä»¥ä¸ºè‡ªå·±ç²¾é€šCC++ï¼Œä½†æ˜¯è¢«é—®èµ·volatileçš„æ—¶å€™å´æ— æ³•æ¸…æ™°ã€æœæ–­åœ°è¡¨æ˜æ€åº¦ï¼Œé‚£åªèƒ½è¯´æ˜è¿˜æ˜¯å¤„åœ¨â€œä»å…¥é—¨åˆ°ç²¾é€šâ€çš„è·¯ä¸Šï¼Œå¦‚æœäº†è§£ä¸€é—¨è¯­è¨€å¸¸è§ç‰¹æ€§çš„ä½¿ç”¨ã€èƒ½å¤Ÿå†™å¥å£®é«˜æ•ˆçš„ç¨‹åºå°±ç®—ç²¾é€šçš„è¯ï¼Œé‚£å®åœ¨æ˜¯å¤ªè—è§†â€œå¤§å¸ˆâ€çš„å­˜åœ¨äº†ã€‚ä»ä¸€ä¸ªvolatileå…³é”®å­—æŠ˜å°„å‡ºäº†å¯¹CC++æ ‡å‡†ã€ç¼–è¯‘å™¨ã€æ“ä½œç³»ç»Ÿã€å¤„ç†å™¨ã€MMUå„ä¸ªæ–¹é¢çš„æŒæ¡ç¨‹åº¦ã€‚\nå‡ åå¹´çš„å‘å±•ï¼Œå¾ˆå¤šå¼€å‘è€…å› ä¸ºè‡ªå·±çš„åè§ã€è¯¯è§£ï¼Œæˆ–è€…å¯¹æŸäº›è¯­è¨€ç‰¹æ€§ï¼ˆå¦‚Javaä¸­çš„volatileè¯­ä¹‰ï¼‰çš„æ ¹æ·±è’‚å›ºçš„è®¤è¯†ï¼Œèµ‹äºˆäº†CC++ volatileæœ¬ä¸å±äºå®ƒçš„èƒ½åŠ›ï¼Œè‡ªå·±å´æµ‘ç„¶ä¸çŸ¥è‡ªå·±çŠ¯äº†å¤šå¤§çš„ä¸€ä¸ªé”™è¯¯ã€‚\næˆ‘æ›¾ç»ä»¥ä¸ºCC++ä¸­volatileå¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œå› ä¸ºJavaä¸­æ˜¯è¿™æ ·çš„ï¼Œç›´åˆ°åæ¥é˜…è¯»Linuxå†…æ ¸çœ‹åˆ°Linus Torvardsçš„ä¸€ç¯‡æ–‡æ¡£ï¼Œä»–å¼ºè°ƒäº†volatileå¯èƒ½å¸¦æ¥çš„åå¤„â€œä»»ä½•ä½¿ç”¨volatileçš„åœ°æ–¹ï¼Œéƒ½å¯èƒ½æ½œè—äº†ä¸€ä¸ªbugâ€ï¼Œæˆ‘ä¸ºä»–çš„â€œå±è¨€è€¸å¬â€æ„Ÿåˆ°åƒæƒŠï¼Œæ‰€ä»¥æˆ‘å½“æ—¶æœç´¢äº†ä¸å°‘èµ„æ–™æ¥æ±‚è¯CC++ volatileçš„èƒ½åŠ›ï¼Œäº‹åæˆ‘è®¤ä¸ºCC++ volatileä¸èƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚ä½†æ˜¯åæ¥éƒ¨é—¨å†…ä¸€æ¬¡åˆ†äº«ï¼Œåˆ†äº«ä¸­æåˆ°äº†volatileæ¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œæˆ‘å½“æ—¶å¿ƒå­˜ç–‘è™‘ï¼Œäº‹åéªŒè¯æ—¶çŠ¯äº†ä¸€ä¸ªé”™è¯¯å¯¼è‡´æˆ‘é”™è¯¯åœ°è®¤ä¸ºvolatileå¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚ç›´åˆ°æˆ‘æœ€è¿‘ç¿»é˜…ä»¥å‰çš„ç¬”è®°ï¼Œç¿»åˆ°äº†å‡ å¹´å‰å¯¹volatileçš„ç–‘è™‘â€¦â€¦æˆ‘å†³å®šæ·±å…¥ç ”ç©¶ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œä»¥ä¾¿èƒ½é¡ºåˆ©å…¥çœ ã€‚\n2. ä»è§„èŒƒè®¤è¯†volatile # ä»¥å¸¸è§çš„ç¼–ç¨‹è¯­è¨€Cã€C++ã€Javaä¸ºä¾‹ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…³é”®å­—volatileï¼Œä½†æ˜¯å¯¹volatileçš„å®šä¹‰å´å¹¶éå®Œå…¨ç›¸åŒã€‚\n  Javaä¸­å¯¹volatileçš„å®šä¹‰ï¼š\n 8.3.1.4. volatile Fields\nThe Java programming language allows threads to access shared variables (Â§17.1). As a rule, to ensure that shared variables are consistently and reliably updated, a thread should ensure that it has exclusive use of such variables by obtaining a lock that, conventionally, enforces mutual exclusion for those shared variables.",content:" img { width: 680px; }  1. ä»¤äººå›°æƒ‘çš„volatile # volatileå­—é¢æ„æ€æ˜¯â€œä¸ç¨³å®šçš„ã€æ˜“å˜çš„â€ï¼Œä¸å°‘ç¼–ç¨‹è¯­è¨€ä¸­å­˜åœ¨volatileå…³é”®å­—ï¼Œä¹Ÿæœ‰å…±åŒä¹‹å¤„ï¼Œå¦‚â€œè¡¨ç¤ºç¨‹åºæ‰§è¡ŒæœŸé—´æ•°æ®å¯èƒ½ä¼šè¢«å¤–éƒ¨æ“ä½œä¿®æ”¹â€ï¼Œå¦‚è¢«å¤–è®¾ä¿®æ”¹æˆ–è€…è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ç­‰ã€‚è¿™åªæ˜¯å­—é¢ä¸Šç»™æˆ‘ä»¬çš„ä¸€èˆ¬æ€§è®¤è¯†ï¼Œç„¶è€Œå…·ä½“åˆ°ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸­volatileçš„è¯­ä¹‰å¯èƒ½ç›¸å·®ç”šè¿œã€‚\nå¾ˆå¤šäººä»¥ä¸ºè‡ªå·±ç²¾é€šCC++ï¼Œä½†æ˜¯è¢«é—®èµ·volatileçš„æ—¶å€™å´æ— æ³•æ¸…æ™°ã€æœæ–­åœ°è¡¨æ˜æ€åº¦ï¼Œé‚£åªèƒ½è¯´æ˜è¿˜æ˜¯å¤„åœ¨â€œä»å…¥é—¨åˆ°ç²¾é€šâ€çš„è·¯ä¸Šï¼Œå¦‚æœäº†è§£ä¸€é—¨è¯­è¨€å¸¸è§ç‰¹æ€§çš„ä½¿ç”¨ã€èƒ½å¤Ÿå†™å¥å£®é«˜æ•ˆçš„ç¨‹åºå°±ç®—ç²¾é€šçš„è¯ï¼Œé‚£å®åœ¨æ˜¯å¤ªè—è§†â€œå¤§å¸ˆâ€çš„å­˜åœ¨äº†ã€‚ä»ä¸€ä¸ªvolatileå…³é”®å­—æŠ˜å°„å‡ºäº†å¯¹CC++æ ‡å‡†ã€ç¼–è¯‘å™¨ã€æ“ä½œç³»ç»Ÿã€å¤„ç†å™¨ã€MMUå„ä¸ªæ–¹é¢çš„æŒæ¡ç¨‹åº¦ã€‚\nå‡ åå¹´çš„å‘å±•ï¼Œå¾ˆå¤šå¼€å‘è€…å› ä¸ºè‡ªå·±çš„åè§ã€è¯¯è§£ï¼Œæˆ–è€…å¯¹æŸäº›è¯­è¨€ç‰¹æ€§ï¼ˆå¦‚Javaä¸­çš„volatileè¯­ä¹‰ï¼‰çš„æ ¹æ·±è’‚å›ºçš„è®¤è¯†ï¼Œèµ‹äºˆäº†CC++ volatileæœ¬ä¸å±äºå®ƒçš„èƒ½åŠ›ï¼Œè‡ªå·±å´æµ‘ç„¶ä¸çŸ¥è‡ªå·±çŠ¯äº†å¤šå¤§çš„ä¸€ä¸ªé”™è¯¯ã€‚\næˆ‘æ›¾ç»ä»¥ä¸ºCC++ä¸­volatileå¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œå› ä¸ºJavaä¸­æ˜¯è¿™æ ·çš„ï¼Œç›´åˆ°åæ¥é˜…è¯»Linuxå†…æ ¸çœ‹åˆ°Linus Torvardsçš„ä¸€ç¯‡æ–‡æ¡£ï¼Œä»–å¼ºè°ƒäº†volatileå¯èƒ½å¸¦æ¥çš„åå¤„â€œä»»ä½•ä½¿ç”¨volatileçš„åœ°æ–¹ï¼Œéƒ½å¯èƒ½æ½œè—äº†ä¸€ä¸ªbugâ€ï¼Œæˆ‘ä¸ºä»–çš„â€œå±è¨€è€¸å¬â€æ„Ÿåˆ°åƒæƒŠï¼Œæ‰€ä»¥æˆ‘å½“æ—¶æœç´¢äº†ä¸å°‘èµ„æ–™æ¥æ±‚è¯CC++ volatileçš„èƒ½åŠ›ï¼Œäº‹åæˆ‘è®¤ä¸ºCC++ volatileä¸èƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚ä½†æ˜¯åæ¥éƒ¨é—¨å†…ä¸€æ¬¡åˆ†äº«ï¼Œåˆ†äº«ä¸­æåˆ°äº†volatileæ¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œæˆ‘å½“æ—¶å¿ƒå­˜ç–‘è™‘ï¼Œäº‹åéªŒè¯æ—¶çŠ¯äº†ä¸€ä¸ªé”™è¯¯å¯¼è‡´æˆ‘é”™è¯¯åœ°è®¤ä¸ºvolatileå¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚ç›´åˆ°æˆ‘æœ€è¿‘ç¿»é˜…ä»¥å‰çš„ç¬”è®°ï¼Œç¿»åˆ°äº†å‡ å¹´å‰å¯¹volatileçš„ç–‘è™‘â€¦â€¦æˆ‘å†³å®šæ·±å…¥ç ”ç©¶ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œä»¥ä¾¿èƒ½é¡ºåˆ©å…¥çœ ã€‚\n2. ä»è§„èŒƒè®¤è¯†volatile # ä»¥å¸¸è§çš„ç¼–ç¨‹è¯­è¨€Cã€C++ã€Javaä¸ºä¾‹ï¼Œå®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…³é”®å­—volatileï¼Œä½†æ˜¯å¯¹volatileçš„å®šä¹‰å´å¹¶éå®Œå…¨ç›¸åŒã€‚\n  Javaä¸­å¯¹volatileçš„å®šä¹‰ï¼š\n 8.3.1.4. volatile Fields\nThe Java programming language allows threads to access shared variables (Â§17.1). As a rule, to ensure that shared variables are consistently and reliably updated, a thread should ensure that it has exclusive use of such variables by obtaining a lock that, conventionally, enforces mutual exclusion for those shared variables.\nThe Java programming language provides a second mechanism, volatile fields, that is more convenient than locking for some purposes.\nA field may be declared volatile, in which case the Java Memory Model ensures that all threads see a consistent value for the variable (Â§17.4).\n Javaæ¸…æ™°åœ°è¡¨è¾¾äº†è¿™æ ·ä¸€ä¸ªè§‚ç‚¹ï¼ŒJavaå†…å­˜æ¨¡å‹ä¸­ä¼šä¿è¯volatileå˜é‡çš„çº¿ç¨‹å¯è§æ€§ï¼Œæ¥è§¦è¿‡Javaå¹¶å‘ç¼–ç¨‹çš„å¼€å‘è€…åº”è¯¥éƒ½æ¸…æ¥šï¼Œè¿™æ˜¯ä¸€ä¸ªä¸äº‰çš„äº‹å®ã€‚\n  CC++ä¸­å¯¹volatileçš„å®šä¹‰ï¼š\n 6.7.3 Type qualifiers\nvolatile: No cacheing through this lvalue: each operation in the abstract semantics must be performed (that is, no cacheing assumptions may be made, since the location is not guaranteed to contain any previous value). In the absence of this qualifier, the contents of the designated location may be assumed to be unchanged except for possible aliasing.\n C99ä¸­ä¹Ÿæ¸…æ™°åœ°è¡¨åäº†volatileçš„è¯­ä¹‰ï¼Œä¸è¦åšcacheä¹‹ç±»çš„ä¼˜åŒ–ã€‚è¿™é‡Œçš„cacheæŒ‡çš„æ˜¯software cacheingï¼Œå³ç¼–è¯‘å™¨ç”ŸæˆæŒ‡ä»¤å°†å†…å­˜æ•°æ®ç¼“å­˜åˆ°cpuå¯„å­˜å™¨ï¼Œåç»­è®¿é—®å†…å­˜å˜é‡ä½¿ç”¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼›éœ€è¦ä¸ä¹‹ä½œå‡ºåŒºåˆ†çš„æ˜¯hardware cacheingï¼Œå³cpuè®¿é—®å†…å­˜æ—¶å°†å†…å­˜æ•°æ®ç¼“å­˜åˆ°cpu cacheï¼Œç¡¬ä»¶æ“ä½œå®Œå…¨å¯¹ä¸Šå±‚åº”ç”¨ç¨‹åºé€æ˜ã€‚å¤§å®¶è¯·å°†è¿™ä¸¤ä¸ªç‚¹é“­è®°åœ¨å¿ƒï¼Œè¦æƒ³ææ¸…æ¥šCC++ volatileå¿…é¡»è¦å…ˆç†è§£è¿™é‡Œcacheçš„åŒºåˆ«ã€‚\nC99æ¸…æ™°å—ï¼Ÿä¸Šè¿°è§£é‡Šçœ‹ä¸Šå»å¾ˆæ¸…æ™°ï¼Œä½†æ˜¯è¦æƒ³å½»åº•ç†è§£volatileçš„è¯­ä¹‰ï¼Œç»éä¸Šè¿°ä¸€å¥è¯å°±å¯ä»¥è®²å¾—æ¸…çš„ï¼ŒC99ä¸­å®šä¹‰äº†abstract machineä»¥åŠsequence pointsï¼Œä¸volatileç›¸å…³çš„æè¿°æœ‰å¤šå¤„ï¼Œç¯‡å¹…åŸå› è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼Œå…¶ä¸­ä¸volatileç›¸å…³çš„abstract machineè¡Œä¸ºæè¿°å…±åŒç¡®å®šäº†volatileçš„è¯­ä¹‰ã€‚\n  3. å¯¹volatileæŒä½•è§‚ç‚¹ # ä¸ºäº†å¼•èµ·å¤§å®¶å¯¹CC++ volatileçš„é‡è§†å¹¶åŠæ—¶è¡¨æ˜è§‚ç‚¹ï¼Œå…ˆè´´ä¸€ä¸ªé¡µé¢â€œIs-Volatile-Useful-with-Threadsâ€ï¼Œç½‘ç«™ä¸­ç®€æ˜æ‰¼è¦çš„å‘ŠçŸ¥å¤§å®¶ï¼Œâ€œFriends donâ€™t let friends use volatile for inter-thread communication in C and C++â€ã€‚But whyï¼Ÿ\nisocppä¸“é—¨æŒ‚äº†è¿™ä¹ˆä¸ªé¡µé¢æ¥å¼ºè°ƒvolatileåœ¨ä¸åŒç¼–ç¨‹è¯­è¨€ä¸­çš„å·®å¼‚ï¼Œå¯è§å®ƒæ˜¯ä¸€ä¸ªå¤šä¹ˆéš¾ç¼ çš„é—®é¢˜ã€‚å³ä¾¿æ˜¯æœ‰è¿™ä¹ˆä¸ªé¡µé¢ï¼Œè¦å½»åº•ææ¸…æ¥švolatileï¼Œä¹Ÿä¸æ˜¯è¯´è¯»å®Œä¸Šé¢åˆ—å‡ºçš„å‡ ä¸ªæŠ€æœ¯åšå®¢å°±èƒ½è§£å†³ï¼Œé‚£ä¹Ÿå¤ªè½»ææ·¡å†™äº†ï¼Œæ‰€ä»¥æˆ‘æœç´¢ã€æ•´ç†ã€è®¨è®ºï¼Œå¸Œæœ›èƒ½å°†å­¦åˆ°çš„å†…å®¹æ€»ç»“ä¸‹æ¥ä¾›å…¶ä»–å¼€å‘è€…å‚è€ƒï¼Œæˆ‘ä¹Ÿä¸æƒ³å†å› ä¸ºè¿™ä¸ªé—®é¢˜è€Œå›°æ‰°ã€‚\nç»“åˆCC++ volatile qualifierä»¥åŠabstract machineä¸­å¯¹volatileç›¸å…³sequence pointsçš„æè¿°ï¼Œå¯ä»¥ç¡®å®švolatileçš„è¯­ä¹‰ï¼š\n ä¸å¯ä¼˜åŒ–æ€§ï¼šä¸è¦åšä»»ä½•è½¯ä»¶cacheä¹‹ç±»çš„ä¼˜åŒ–ï¼Œå³å¤šæ¬¡è®¿é—®å†…å­˜å¯¹è±¡æ—¶ï¼Œç¼–è¯‘å™¨ä¸èƒ½ä¼˜åŒ–ä¸ºcacheå†…å­˜å¯¹è±¡åˆ°å¯„å­˜å™¨ã€åç»­è®¿é—®å†…å­˜å¯¹è±¡è½¬ä¸ºè®¿é—®å¯„å­˜å™¨ [6.7.3 Type qualifiers - volatile]ï¼› é¡ºåºæ€§ï¼šå¯¹volatileå˜é‡çš„å¤šæ¬¡è¯»å†™æ“ä½œï¼Œç¼–è¯‘å™¨ä¸èƒ½ä»¥é¢„æµ‹æ•°æ®ä¸å˜ä¸ºå€Ÿå£ä¼˜åŒ–æ‰è¯»å†™æ“ä½œï¼Œå¹¶ä¸”è¦ä¿è¯å‰é¢çš„è¯»å†™æ“ä½œå…ˆäºåé¢çš„è¯»å†™æ“ä½œå®Œæˆ [5.1.2.3 Program execution]ï¼› æ˜“å˜æ€§ï¼šä»ä¸å¯ä¼˜åŒ–æ€§ã€é¡ºåºæ€§è¯­ä¹‰è¦æ±‚ï¼Œä¸éš¾ä½“ä¼šå‡ºå…¶éšå«ç€æ•°æ®â€œæ˜“å˜æ€§â€ï¼Œè¿™ä¹Ÿæ˜¯volatileå­—é¢ä¸Šçš„æ„æ€ï¼Œä¹Ÿæ˜¯ä¸å°‘å¼€å‘è€…å­¦ä¹ volatileæ—¶æœ€ç†ŸçŸ¥çš„è¯­ä¹‰ï¼›  CC++è§„èŒƒæ²¡æœ‰æ˜¾ç¤ºè¦æ±‚volatileæ”¯æŒçº¿ç¨‹å¯è§æ€§ï¼Œgccä¹Ÿæ²¡æœ‰åœ¨æ ‡å‡†å…è®¸çš„ç©ºé—´å†…åšä»€ä¹ˆâ€œå‘æŒ¥â€å»å®‰æ’ä»€ä¹ˆä¿è¯çº¿ç¨‹å¯è§æ€§çš„å¤„ç†å™¨æŒ‡ä»¤ï¼ˆJavaä¸­volatileä¼šä½¿ç”¨lockæŒ‡ä»¤ä½¿å…¶ä»–å¤„ç†å™¨cacheå¤±æ•ˆå¼ºåˆ¶è¯»å†…å­˜ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼‰ã€‚è€Œå…³äºCPU cacheä¸€è‡´æ€§åè®®ï¼Œx86åŸå…ˆé‡‡ç”¨MESIåè®®ï¼Œåæ”¹ç”¨æ•ˆç‡æ›´é«˜çš„MESIFï¼Œéƒ½æ˜¯å¼ºä¸€è‡´æ€§åè®®ï¼Œåœ¨x86è¿™ç­‰æ”¯æŒå¼ºä¸€è‡´çš„CPUä¸Šï¼ŒCC++ä¸­ç»“åˆvolatileæ˜¯å¯ä»¥â€œè·å¾—â€çº¿ç¨‹å¯è§æ€§çš„ï¼Œåœ¨éå¼ºä¸€è‡´CPUä¸Šåˆ™ä¸ç„¶ã€‚\nä½†æ˜¯CC++ volatileç¡®å®æ˜¯æœ‰ä»·å€¼çš„ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½è¦ä½¿ç”¨å®ƒï¼Œè€Œä¸”ä¸å°‘åœºæ™¯ä¸‹ä¼¼ä¹æ²¡æœ‰æ¯”å®ƒæ›´ç®€å•çš„æ›¿ä»£æ–¹æ³•ï¼Œä¸‹é¢é¦–å…ˆåˆ—ä¸¾CC++ volatileçš„é€šç”¨é€‚ç”¨åœºæ™¯ï¼Œæ–¹ä¾¿å¤§å®¶è®¤è¯†volatileï¼Œç„¶åæˆ‘ä»¬å†ç ”ç©¶ä¸ºä»€ä¹ˆCC++ volatileä¸èƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚CC++æ ‡å‡†ä¸­ç¡®å®æ²¡æœ‰è¯´volatileè¦æ”¯æŒçº¿ç¨‹å¯è§æ€§ï¼Œå¤§å®¶å¯ä»¥é€‰æ‹©å°±æ­¤æ‰“ä½ï¼Œä½†æ˜¯æˆ‘æ€€ç–‘çš„æ˜¯gccåœ¨æ ‡å‡†å…è®¸çš„ç©ºé—´å†…æ˜¯æ€ä¹ˆåšçš„ï¼Ÿæ“ä½œç³»ç»Ÿã€MMUã€å¤„ç†å™¨æ˜¯æ€ä¹ˆåšçš„ï¼Ÿâ€œæ ‡å‡†ä¸­æ²¡æœ‰æ˜¾ç¤ºåˆ—å‡ºâ€ï¼Œè¿™æ ·çš„ç†ç”±è¿˜ä¸è¶³ä»¥è®©æˆ‘åœä¸‹æ¢ç´¢çš„è„šæ­¥ã€‚\n4. CC++ need volatile # CC++ volatileè¯­ä¹‰â€œä¸å¯ä¼˜åŒ–å‹â€ã€â€œé¡ºåºæ€§â€ã€â€œæ˜“å˜æ€§â€ï¼Œå¦‚ä½•ç›´è§‚æ„Ÿå—å®ƒçš„ä»·å€¼å‘¢ï¼Ÿçœ‹C99ä¸­ç»™å‡ºçš„é€‚ç”¨åœºæ™¯å§ã€‚\n  setjmpã€longjmpç”¨äºå®ç°å‡½æ•°å†…ã€å‡½æ•°é—´è·³è½¬ï¼ˆgotoåªèƒ½åœ¨å‡½æ•°å†…è·³è½¬ï¼‰ï¼ŒC Specè§„å®šlongjmpä¹‹åå¸Œæœ›è·³åˆ°çš„æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡çš„å€¼æ˜¯æœ€æ–°å€¼ï¼Œè€Œä¸æ˜¯setjmpæ—¶çš„å€¼ï¼Œè€ƒè™‘ç¼–è¯‘å™¨å¯èƒ½ä½œå‡ºä¸€äº›ä¼˜åŒ–ï¼Œå°†autoå˜é‡cacheåˆ°å¯„å­˜å™¨ä¸­ï¼Œå‡å¦‚setjmpä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡çš„æ—¶å€™æ°å·§ä¿å­˜äº†å­˜æœ‰è¯¥å±€éƒ¨å˜é‡å€¼çš„å¯„å­˜å™¨ä¿¡æ¯ï¼Œç­‰longjmpå›æ¥çš„æ—¶å€™å°±ç”¨äº†æ—§å€¼ã€‚è¿™è¿èƒŒäº†C Specçš„è§„å®šï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨volatileæ¥é¿å…ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæ»¡è¶³C Specï¼\n  signal handlerç”¨äºå¤„ç†è¿›ç¨‹æ•è·åˆ°çš„ä¿¡å·ï¼Œä¸setjmpã€longjmpç±»ä¼¼ï¼Œè¿›ç¨‹æ•è·ã€å¤„ç†ä¿¡å·æ—¶éœ€è¦ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡å†å»å¤„ç†ä¿¡å·ï¼Œä¿¡å·å¤„ç†å®Œæˆå†æ¢å¤ä¸Šä¸‹æ–‡ç»§ç»­æ‰§è¡Œã€‚ä¿¡å·å¤„ç†å‡½æ•°ä¸­ä¹Ÿå¯èƒ½ä¼šä¿®æ”¹æŸäº›å…±äº«å˜é‡ï¼Œå‡å¦‚å…±äº«å˜é‡åœ¨æ”¶åˆ°ä¿¡å·æ—¶åŠ è½½åˆ°äº†å¯„å­˜å™¨ï¼Œå¹¶ä¸”ä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡æ—¶ä¹Ÿä¿å­˜èµ·æ¥äº†ï¼Œé‚£ä¹ˆä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå®Œæ¯•è¿”å›ï¼ˆå¯èƒ½ä¼šä¿®æ”¹è¯¥å˜é‡ï¼‰æ¢å¤ä¸Šä¸‹æ–‡åï¼Œè®¿é—®åˆ°çš„è¿˜æ˜¯æ—§å€¼ã€‚å› æ­¤å°†ä¿¡å·å¤„ç†å‡½æ•°ä¸­è¦ä¿®æ”¹çš„å…±äº«å˜é‡å£°æ˜ä¸ºvolatileæ˜¯å¿…è¦çš„ã€‚\n  è®¾å¤‡é©±åŠ¨ã€Memory-Mapped IOã€DMAã€‚ æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç¤ºä¾‹ï¼Œå‡å¦‚ä¸ä½¿ç”¨volatileï¼Œç¼–è¯‘å™¨ä¼šåšä»€ä¹ˆã€‚ç¼–è¯‘å™¨ç”Ÿæˆä»£ç å¯èƒ½ä¼šå°†å†…å­˜å˜é‡sumã€iæ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¾ªç¯æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨å¯èƒ½è®¤ä¸ºè¿™ä¸ªå¾ªç¯å¯ä»¥ç›´æ¥ä¼˜åŒ–æ‰ï¼Œsumç›´æ¥å¾—åˆ°äº†æœ€ç»ˆçš„a[0]+a[1]+â€¦a[N]çš„å€¼ï¼Œå¾ªç¯ä½“æ‰§è¡Œæ¬¡æ•°å¤§å¤§å‡å°‘ã€‚\nsum = 0; for (i=0; i\u0026lt;N; ++i) sum += a[i];  è¿™ç§ä¼˜åŒ–å¯¹äºé¢å‘ç¡¬ä»¶çš„ç¨‹åºå¼€å‘ï¼ˆå¦‚è®¾å¤‡é©±åŠ¨å¼€å‘ã€å†…å­˜æ˜ å°„IOï¼‰æ¥è¯´æœ‰ç‚¹è¿‡å¤´äº†ï¼Œè€Œä¸”ä¼šå¯¼è‡´é”™è¯¯çš„è¡Œä¸ºã€‚ä¸‹é¢çš„ä»£ç ä½¿ç”¨äº†volatile qualiferï¼Œå…¶ä»–ä¸ä¸Šè¿°ä»£ç åŸºæœ¬ç›¸åŒã€‚å¦‚æœä¸å­˜åœ¨volatileä¿®é¥°ï¼Œç¼–è¯‘å™¨ä¼šè®¤ä¸ºæœ€ç»ˆ*ttyportçš„å€¼å°±æ˜¯a[N-1]ï¼Œå‰N-1æ¬¡èµ‹å€¼éƒ½æ˜¯æ²¡å¿…è¦çš„ï¼Œæ‰€ä»¥ç›´æ¥ä¼˜åŒ–æˆ*ttyport = a[N-1]ã€‚ä½†æ˜¯ttyportæ˜¯å¤–è®¾çš„è®¾å¤‡ç«¯å£é€šè¿‡å†…å­˜æ˜ å°„IOå¾—åˆ°çš„è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œç¼–è¯‘å™¨å‘ç°å­˜åœ¨volatileä¿®é¥°ï¼Œä¾¿ä¸ä¼šå¯¹å¾ªç¯ä½“ä¸­*ttyport = a[i]è¿›è¡Œä¼˜åŒ–ï¼Œå¾ªç¯ä½“ä¼šæ‰§è¡ŒNæ¬¡èµ‹å€¼ï¼Œä¸”ä¿è¯æ¯æ¬¡èµ‹å€¼æ“ä½œéƒ½ä¸å‰ä¸€æ¬¡ã€åä¸€æ¬¡èµ‹å€¼å­˜åœ¨ä¸¥æ ¼çš„é¡ºåºæ€§ä¿è¯ã€‚\nvolatile short *ttyport; for (i=0; i\u0026lt;N; ++i) *ttyport = a[i];  å¯èƒ½å¤§å®¶ä¼šæœ‰ç–‘é—®ï¼Œvolatileåªæ˜¯é¿å…ç¼–è¯‘å™¨å°†å†…å­˜å˜é‡å­˜å‚¨åˆ°å¯„å­˜å™¨ï¼Œå¯¹cpu cacheå´æŸæ‰‹æ— ç­–ï¼Œè°èƒ½ä¿è¯æ¯æ¬¡å¯¹*ttyportçš„å†™æ“ä½œéƒ½ç¡®å®šå†™å›å†…å­˜äº†å‘¢ï¼Ÿè¿™é‡Œå°±æ¶‰åŠåˆ°cpu cache policyé—®é¢˜äº†ã€‚\nå¯¹äºå¤–è®¾IOè€Œè¨€ï¼Œæœ‰ä¸¤ç§å¸¸ç”¨æ–¹å¼ï¼š\n Memory-Mapped IOï¼Œç®€ç§°MMIOï¼Œå°†è®¾å¤‡ç«¯å£ï¼ˆå¯„å­˜å™¨ï¼‰æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ã€‚ä»¥x86ä¸ºä¾‹ï¼Œå¯¹æ˜ å°„å†…å­˜åŒºåŸŸçš„è¯»å†™æ“ä½œé€šè¿‡æ™®é€šçš„loadã€storeè®¿å­˜æŒ‡ä»¤æ¥å®Œæˆï¼Œå¤„ç†å™¨é€šè¿‡å†…å­˜ç±»å‹èŒƒå›´å¯„å­˜å™¨ï¼ˆMTRRï¼ŒMemory Type Range Regsitersï¼‰å’Œé¡µé¢å±æ€§è¡¨ï¼ˆPATï¼ŒPage Attribute Tableï¼‰å¯¹ä¸åŒçš„å†…å­˜èŒƒå›´è®¾ç½®ä¸åŒçš„CPU cache policyï¼Œå†…æ ¸è®¾ç½®MMIOç±»å‹èŒƒå›´çš„cpu cacheç­–ç•¥ä¸ºuncacheableï¼Œå…¶ä»–RAMç±»å‹èŒƒå›´çš„cpu cacheç­–ç•¥ä¸ºwrite-backï¼å³ç›´æ¥ç»•è¿‡cpu cacheè¯»å†™å†…å­˜ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰ç‰©ç†å†…å­˜å‚ä¸ï¼Œè€Œæ˜¯å°†è¯»å†™æ“ä½œè½¬å‘åˆ°å¤–è®¾ï¼Œä¸Šè¿°ä»£ç ä¸­*ttyport = a[i]è¿™ä¸ªèµ‹å€¼æ“ä½œç»•è¿‡CPU cacheç›´è¾¾å¤–è®¾ã€‚ Port IOï¼Œæ­¤æ—¶å¤–è®¾ç«¯å£ï¼ˆå¯„å­˜å™¨ï¼‰é‡‡ç”¨ç‹¬ç«‹ç¼–å€ï¼Œè€ŒéMemory-Mapped IOè¿™ç§ç»Ÿä¸€ç¼–å€æ–¹å¼ï¼Œéœ€è¦é€šè¿‡ä¸“é—¨çš„cpuæŒ‡ä»¤æ¥å¯¹è®¾å¤‡ç«¯å£è¿›è¡Œè¯»å†™ï¼Œå¦‚x86ä¸Šé‡‡ç”¨çš„æ˜¯æŒ‡ä»¤inã€outæ¥å®Œæˆè®¾å¤‡ç«¯å£çš„è¯»å†™ã€‚  è€Œå¦‚æœæ˜¯**DMAï¼ˆDirect Memory Accessï¼‰**æ“ä½œæ¨¡å¼çš„è¯ï¼Œå®ƒç»•è¿‡cpuç›´æ¥å¯¹å†…å­˜è¿›è¡Œæ“ä½œï¼ŒæœŸé—´ä¸ä¸­æ–­cpuæ‰§è¡Œï¼ŒDMAæ“ä½œå†…å­˜æ–¹å¼ä¸Šä¸cpuç±»ä¼¼ï¼Œéƒ½ä¼šè€ƒè™‘cpu cacheä¸€è‡´æ€§é—®é¢˜ã€‚å‡å¦‚DMAå¯¹å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œï¼Œæ€»çº¿ä¸Šä¹Ÿä¼šå¯¹äº‹ä»¶è¿›è¡Œå¹¿æ’­ï¼Œcpu cacheä¹Ÿä¼šè§‚æµ‹åˆ°å¹¶é‡‡å–ç›¸åº”çš„åŠ¨ä½œã€‚å¦‚DMAå¯¹å†…å­˜è¿›è¡Œå†™æ“ä½œï¼Œcpu cacheä¹Ÿä¼šå°†ç›¸åŒå†…å­˜åœ°å€çš„cache lineè®¾ç½®ä¸ºinvalidateï¼Œåç»­è¯»å–æ—¶å°±å¯ä»¥é‡æ–°ä»å†…å­˜åŠ è½½æœ€æ–°æ•°æ®ï¼›å‡å¦‚DMAè¿›è¡Œå†…å­˜è¯»æ“ä½œï¼Œæ•°æ®å¯èƒ½ä»å…¶ä»–cpu cacheä¸­ç›´æ¥è·å–è€Œéä»å†…å­˜ä¸­ã€‚è¿™ç§æƒ…å†µä¸‹DMAæ“ä½œçš„å†…å­˜åŒºåŸŸï¼Œå¯¹åº”çš„å†…å­˜å˜é‡ä¹Ÿåº”è¯¥ä½¿ç”¨volatileä¿®é¥°ï¼Œé¿å…ç¼–è¯‘å™¨ä¼˜åŒ–ä»å¯„å­˜å™¨ä¸­è¯»åˆ°æ—§å€¼ã€‚\nä»¥ä¸Šç¤ºä¾‹æ‘˜è‡ªC99è§„èŒƒï¼Œé€šè¿‡ä¸Šè¿°ç¤ºä¾‹ã€è§£é‡Šï¼Œå¯ä»¥ä½“ä¼šåˆ°volatileçš„è¯­ä¹‰ç‰¹ç‚¹ï¼šâ€œä¸å¯ä¼˜åŒ–å‹ã€æ˜“å˜æ€§ã€é¡ºåºæ€§â€ã€‚\nä¸‹é¢è¿™ä¸ªç¤ºä¾‹æ‘˜è‡ªç½‘ç»œï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“è¡¨ç°volatileçš„è¯­ä¹‰ç‰¹ç‚¹ï¼š\n// åº”ä¸º volatile unsigned int *p = .... unsigned int *p = GetMagicAddress(); unsigned int a, b; a = *p; b = *p; *p = a; *p = b;  GetMagicAddress()è¿”å›ä¸€ä¸ªå¤–è®¾çš„å†…å­˜æ˜ å°„IOåœ°å€ï¼Œç”±äºunsigned int *pæŒ‡é’ˆæ²¡æœ‰volatileä¿®é¥°ï¼Œç¼–è¯‘å™¨è®¤ä¸º*pä¸­çš„å†…å®¹ä¸æ˜¯â€œæ˜“å˜çš„â€å› æ­¤å¯èƒ½ä¼šä½œå‡ºå¦‚ä¸‹ä¼˜åŒ–ã€‚é¦–å…ˆä»pè¯»å–ä¸€ä¸ªå­—èŠ‚åˆ°å¯„å­˜å™¨ï¼Œç„¶åå°†å…¶èµ‹å€¼ç»™aï¼Œç„¶åè®¤ä¸º*på†…å®¹ä¸å˜ï¼Œå°±ç›´æ¥å°†å¯„å­˜å™¨ä¸­å†…å®¹å†èµ‹å€¼ç»™bã€‚å†™*pçš„æ—¶å€™è®¤ä¸ºa == bï¼Œå†™ä¸¤æ¬¡æ²¡å¿…è¦å°±åªå†™äº†ä¸€æ¬¡ã€‚\nè€Œå¦‚æœé€šè¿‡volatileå¯¹*pè¿›è¡Œä¿®é¥°ï¼Œåˆ™å°±æ˜¯å¦ä¸€ä¸ªç»“æœäº†ï¼Œç¼–è¯‘å™¨ä¼šè®¤ä¸º*pä¸­å†…å®¹æ˜¯æ˜“å˜çš„ï¼Œæ¯æ¬¡è¯»å–æ“ä½œéƒ½ä¸ä¼šæ²¿ç”¨ä¸Šæ¬¡åŠ è½½åˆ°å¯„å­˜å™¨ä¸­çš„æ—§å€¼ï¼Œè€Œå†…å­˜æ˜ å°„IOå†…å­˜åŒºåŸŸå¯¹åº”çš„cpu cacheæ¨¡å¼åˆæ˜¯è¢«uncacheableçš„ï¼Œæ‰€ä»¥ä¼šä¿è¯ä»å†…å­˜è¯»å–åˆ°æœ€æ–°å†™å…¥çš„æ•°æ®ï¼ŒæˆåŠŸè¿ç»­è¯»å–ä¸¤ä¸ªå­—èŠ‚aã€bï¼Œä¹Ÿä¿è¯æŒ‰é¡ºåºå†™å…¥ä¸¤ä¸ªå­—èŠ‚aã€bã€‚\n  ç›¸ä¿¡è¯»åˆ°è¿™é‡Œå¤§å®¶å¯¹CC++ volatileçš„é€‚ç”¨åœºæ™¯æœ‰æ‰€äº†è§£äº†ï¼Œå®ƒç¡®å®æ˜¯æœ‰ç”¨çš„ã€‚é‚£æ¥ä¸‹æ¥æˆ‘ä»¬é’ˆå¯¹å¼€å‘è€…è¯¯è§£å¾ˆä¸¥é‡çš„ä¸€ä¸ªé—®é¢˜â€œvolatileèƒ½å¦æ”¯æŒçº¿ç¨‹å¯è§æ€§â€å†æ¢ç´¢ä¸€ç•ªï¼Œä¸èƒ½ï¼ä¸èƒ½ï¼ä¸èƒ½ï¼\n5. CC++ thread visibility # 5.1. çº¿ç¨‹å¯è§æ€§é—®é¢˜ # å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ç»å¸¸ä¼šé€šè¿‡ä¿®æ”¹å…±äº«å˜é‡çš„æ–¹å¼æ¥é€šçŸ¥å¦ä¸€ä¸ªçº¿ç¨‹å‘ç”Ÿäº†æŸç§çŠ¶æ€çš„å˜åŒ–ï¼Œå¸Œæœ›çº¿ç¨‹èƒ½åŠæ—¶æ„ŸçŸ¥åˆ°è¿™ç§å˜åŒ–ï¼Œå› æ­¤æˆ‘ä»¬å…³å¿ƒâ€œçº¿ç¨‹å¯è§æ€§é—®é¢˜â€ã€‚\nåœ¨å¯¹ç§°å¤šå¤„ç†å™¨æ¶æ„ä¸­ï¼ˆSMPï¼‰ï¼Œå¤šå¤„ç†å™¨ã€æ ¸å¿ƒé€šè¿‡æ€»çº¿å…±äº«ç›¸åŒçš„å†…å­˜ï¼Œä½†æ˜¯å„ä¸ªå¤„ç†å™¨æ ¸å¿ƒæœ‰è‡ªå·±çš„cacheï¼Œçº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬ä¼šå°†å†…å­˜æ•°æ®åŠ è½½åˆ°cacheä¸­ï¼Œä¹Ÿå¯èƒ½ä¼šåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œä»¥ä¾¿å®ç°è®¿é—®æ•ˆç‡çš„æå‡ï¼Œä½†è¿™ä¹Ÿå¸¦æ¥äº†é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘ä»¬æåˆ°çš„çº¿ç¨‹å¯è§æ€§é—®é¢˜ã€‚æŸä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡åšäº†ä¿®æ”¹ï¼Œçº¿ç¨‹å¯èƒ½åªæ˜¯ä¿®æ”¹äº†å¯„å­˜å™¨ä¸­çš„å€¼æˆ–è€…cpu cacheä¸­çš„å€¼ï¼Œä¿®æ”¹å¹¶ä¸ä¼šç«‹å³åŒæ­¥å›å†…å­˜ã€‚å³ä¾¿åŒæ­¥å›å†…å­˜ï¼Œè¿è¡Œåœ¨å…¶ä»–å¤„ç†å™¨æ ¸å¿ƒä¸Šçš„çº¿ç¨‹ï¼Œè®¿é—®è¯¥å…±äº«æ•°æ®æ—¶ä¹Ÿä¸ä¼šç«‹å³å»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®ï¼Œæ— æ³•æ„ŸçŸ¥åˆ°å…±äº«æ•°æ®çš„å˜åŒ–ã€‚\n5.2. diff volatile in javaã€cc++ # æœ‰äº›ç¼–ç¨‹è¯­è¨€ä¸­å®šä¹‰äº†å…³é”®å­—volatileï¼Œå¦‚Javaã€Cã€C++ç­‰ï¼Œå¯¹æ¯”ä¸‹Java volatileå’ŒCC++ volatileï¼Œå·®å¼‚ç®€ç›´æ˜¯å¤ªå¤§äº†ï¼Œæˆ‘ä»¬åªè®¨è®ºçº¿ç¨‹å¯è§æ€§ç›¸å…³çš„éƒ¨åˆ†ã€‚\nJavaä¸­è¯­è¨€è§„èŒƒæ˜ç¡®æŒ‡å‡ºvolatileä¿è¯å†…å­˜å¯è§æ€§ï¼ŒJMMå­˜åœ¨â€œæœ¬åœ°å†…å­˜â€çš„æ¦‚å¿µï¼Œçº¿ç¨‹å¯¹â€œä¸»å­˜â€å˜é‡çš„è®¿é—®éƒ½æ˜¯å…ˆåŠ è½½åˆ°æœ¬åœ°å†…å­˜ï¼Œåç»­å†™æ“ä½œå†åŒæ­¥å›ä¸»å­˜ã€‚volatileå¯ä»¥ä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹ç«‹å³å¯è§ï¼Œé¦–å…ˆæ˜¯ä¿è¯volatileå˜é‡å†™æ“ä½œå¿…é¡»è¦æ›´æ–°åˆ°ä¸»å­˜ï¼Œç„¶åè¿˜è¦ä¿è¯å…¶ä»–çº¿ç¨‹volatileå˜é‡è¯»å–å¿…é¡»ä»ä¸»å­˜ä¸­è¯»å–ã€‚å¤„ç†å™¨ä¸­æä¾›äº†MFENCEæŒ‡ä»¤æ¥åˆ›å»ºä¸€ä¸ªå±éšœï¼Œå¯ä»¥ä¿è¯MFENCEä¹‹å‰çš„æ“ä½œå¯¹åç»­æ“ä½œå¯è§ï¼Œç”¨MFENCEå¯ä»¥å®ç°volatileï¼Œä½†æ˜¯è€ƒè™‘åˆ°AMDå¤„ç†å™¨ä¸­è€—æ—¶é—®é¢˜ä»¥åŠIntelå¤„ç†å™¨ä¸­æµæ°´çº¿é—®é¢˜ï¼ŒJVMä»MFENCEä¿®æ”¹æˆäº†LOCK: ADD 0ã€‚\nä½†æ˜¯åœ¨Cã€C++è§„èŒƒé‡Œé¢æ²¡æœ‰è¦æ±‚volatileå…·å¤‡çº¿ç¨‹å¯è§æ€§è¯­ä¹‰ï¼Œåªè¦æ±‚å…¶ä¿è¯â€œä¸å¯ä¼˜åŒ–æ€§ã€é¡ºåºæ€§ã€æ˜“å˜æ€§â€ã€‚\n5.3. how gcc handle volatile # è¿™é‡Œåšä¸ªç®€å•çš„æµ‹è¯•ï¼š\n#include \u0026lt;stdio.h\u0026gt; int main() { // volatile int a = 0; int a = 0; while(1) { a++; printf(\u0026quot;%d\\n\u0026quot;, a); } return 0; }  ä¸å¼€ä¼˜åŒ–çš„è¯ï¼Œæœ‰æ²¡æœ‰volatile gccç”Ÿæˆçš„æ±‡ç¼–æŒ‡ä»¤åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼Œvolatileå˜é‡è¯»å†™éƒ½æ˜¯é’ˆå¯¹å†…å­˜è¿›è¡Œï¼Œè€Œéå¯„å­˜å™¨ã€‚å¼€gcc -O2ä¼˜åŒ–æ—¶ï¼Œä¸åŠ volatileæƒ…å†µä¸‹è¯»å†™æ“ä½œé€šè¿‡å¯„å­˜å™¨ï¼ŒåŠ äº†volatileåˆ™é€šè¿‡å†…å­˜ã€‚\n1ï¼‰ä¸åŠ volatile ï¼šgcc -g -O2 -o main main.c\nè¿™é‡Œé‡ç‚¹çœ‹ä¸‹å¯¹å˜é‡açš„æ“ä½œï¼Œxor %ebx,%ebxå°†å¯„å­˜å™¨%ebxè®¾ä¸º0ï¼Œä¹Ÿå°±æ˜¯å°†å˜é‡a=0å­˜å‚¨åˆ°äº†%ebxï¼Œnoplä¸åšä»»ä½•æ“ä½œï¼Œç„¶åå¾ªç¯ä½“é‡Œé¢æ¯æ¬¡è¯»å–açš„å€¼éƒ½æ˜¯ç›´æ¥åœ¨%ebx+1ï¼ŒåŠ å®Œä¹‹åä¹Ÿæ²¡æœ‰å†™å›å†…å­˜ã€‚å‡å¦‚æœ‰ä¸ªå…±äº«å˜é‡æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œå¹¶ä¸”æ²¡æœ‰åŠ volatileï¼Œå¤šä¸ªçº¿ç¨‹è®¿é—®è¿™ä¸ªå˜é‡çš„æ—¶å€™å°±æ˜¯ç”¨çš„ç‰©ç†çº¿ç¨‹è·‘çš„å¤„ç†å™¨æ ¸å¿ƒå¯„å­˜å™¨ä¸­çš„æ•°æ®ï¼Œæ˜¯æ— æ³•ä¿è¯å†…å­˜å¯è§æ€§çš„ã€‚\n2ï¼‰åŠ volatileï¼šgcc -g -O2 -o main main.c\nè¿™é‡Œå˜é‡açš„å€¼é¦–å…ˆè¢«è®¾ç½®åˆ°äº†0xc(%rsp)ä¸­ï¼Œnoplç©ºæ“ä½œï¼Œç„¶åa++æ—¶æ˜¯å°†å†…å­˜ä¸­çš„å€¼ç§»åŠ¨åˆ°äº†å¯„å­˜å™¨%eaxä¸­ï¼Œç„¶åæ‰§è¡Œ%eax+1å†å†™å›å†…å­˜0xc(%rsp)ä¸­ï¼Œwhileå¾ªç¯ä¸­æ¯æ¬¡å¾ªç¯æ‰§è¡Œéƒ½æ˜¯å…ˆä»å†…å­˜é‡Œé¢å–å€¼ï¼Œæ›´æ–°åå†å†™å›å†…å­˜ã€‚ä½†æ˜¯è¿™æ ·å°±å¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§äº†å—ï¼ŸNoï¼\n5.4. how cpu cache works # æ˜¯å¦æœ‰è¿™æ ·çš„ç–‘é—®ï¼ŸCC++ä¸­å¯¹volatileå˜é‡è¯»å†™ï¼Œå‘å‡ºçš„å†…å­˜è¯»å†™æŒ‡ä»¤ä¸ä¼šè¢«CPUè½¬æ¢æˆè¯»å†™CPU cacheå—ï¼Ÿè¿™ä¸ªå±äºç¡¬ä»¶å±‚é¢å†…å®¹ï¼Œå¯¹ä¸Šå±‚é€æ˜ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–æŒ‡ä»¤ä¹Ÿæ— æ³•åæ˜ å®é™…æ‰§è¡Œæƒ…å†µï¼å› æ­¤ï¼Œåªçœ‹ä¸Šè¿°åæ±‡ç¼–ç¤ºä¾‹æ˜¯ä¸èƒ½ç¡®å®šCC++ volatileæ”¯æŒçº¿ç¨‹å¯è§æ€§çš„ï¼Œå½“ç„¶ä¹Ÿä¸èƒ½æ’é™¤è¿™ç§å¯èƒ½æ€§ï¼Ÿ\nStack Overflowä¸ŠDietmar KÃ¼hlæåˆ°ï¼Œâ€˜volatileâ€™é˜»æ­¢äº†å¯¹å˜é‡çš„ä¼˜åŒ–ï¼Œä¾‹å¦‚å¯¹äºé¢‘ç¹è®¿é—®çš„å˜é‡ï¼Œä¼šé˜»æ­¢ç¼–è¯‘å™¨å¯¹å…¶è¿›è¡Œç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œé¿å…å°†å…¶æ”¾å…¥å¯„å­˜å™¨ä¸­ï¼ˆæ³¨æ„æ˜¯å¯„å­˜å™¨è€Œä¸æ˜¯cpuçš„cacheï¼‰ã€‚ç¼–è¯‘å™¨ä¼˜åŒ–å†…å­˜è®¿é—®æ—¶ï¼Œä¼šç”Ÿæˆå°†å†…å­˜æ•°æ®ç¼“å­˜åˆ°å¯„å­˜å™¨ã€åç»­è®¿é—®å†…å­˜æ“ä½œè½¬æ¢ä¸ºè®¿é—®å¯„å­˜å™¨ï¼Œè¿™ç§°ä¸ºâ€œsoftware cacheingâ€ï¼›è€ŒCPUå®é™…æ‰§è¡Œæ—¶ç¡¬ä»¶å±‚é¢å°†å†…å­˜æ•°æ®ç¼“å­˜åˆ°CPU cacheä¸­ï¼Œè¿™ç§°ä¸ºâ€œhardware cacheingâ€ï¼Œæ˜¯å¯¹ä¸Šå±‚å®Œå…¨é€æ˜çš„ã€‚ç°åœ¨å·²ç»ç¡®å®šCC++ volatileä¸ä¼šå†ä½œå‡ºâ€œå°†å†…å­˜æ•°æ®ç¼“å­˜åˆ°CPUå¯„å­˜å™¨â€è¿™æ ·çš„ä¼˜åŒ–ï¼Œé‚£ä¸Šè¿°CPU hardware cachingæŠ€æœ¯å°±æˆäº†æˆ‘ä»¬ä¸‹ä¸€ä¸ªæ€€ç–‘çš„å¯¹è±¡ã€‚\nä¿è¯CPU cacheä¸€è‡´æ€§çš„æ–¹æ³•ï¼Œä¸»è¦åŒ…æ‹¬write-throughï¼ˆå†™ç›´è¾¾ï¼‰æˆ–è€…write-backï¼ˆå†™å›ï¼‰ï¼Œwrite-backå¹¶ä¸æ˜¯å½“cacheä¸­æ•°æ®æ›´æ–°æ—¶ç«‹å³å†™å›ï¼Œè€Œæ˜¯åœ¨ç¨åçš„æŸä¸ªæ—¶æœºå†å†™å›ã€‚å†™ç›´è¾¾ä¼šä¸¥é‡é™ä½cpuååé‡ï¼Œæ‰€ä»¥ç°å¦‚ä»Šçš„ä¸»æµå¤„ç†å™¨ä¸­é€šå¸¸é‡‡ç”¨å†™å›æ³•ï¼Œè€Œå†™å›æ³•åˆåŒ…æ‹¬äº†write-invalidateå’Œwrite-updateä¸¤ç§æ–¹å¼ï¼Œå¯å…ˆè·³è¿‡ã€‚\n write-backï¼š\n write-invalidateï¼Œå½“æŸä¸ªcoreï¼ˆå¦‚core 1ï¼‰çš„cacheè¢«ä¿®æ”¹ä¸ºæœ€æ–°æ•°æ®åï¼Œæ€»çº¿è§‚æµ‹åˆ°æ›´æ–°ï¼Œå°†å†™äº‹ä»¶åŒæ­¥åˆ°å…¶ä»–coreï¼ˆå¦‚core nï¼‰ï¼Œå°†å…¶ä»–coreå¯¹åº”ç›¸åŒå†…å­˜åœ°å€çš„cache entryæ ‡è®°ä¸ºinvalidateï¼Œåç»­core nç»§ç»­è¯»å–ç›¸åŒå†…å­˜åœ°å€æ•°æ®æ—¶ï¼Œå‘ç°å·²ç»invalidateï¼Œä¼šå†æ¬¡è¯·æ±‚å†…å­˜ä¸­æœ€æ–°æ•°æ®ã€‚ write-updateï¼Œå½“æŸä¸ªcoreï¼ˆå¦‚core 1ï¼‰çš„cacheè¢«ä¿®æ”¹ä¸ºæœ€æ–°æ•°æ®åï¼Œå°†å†™äº‹ä»¶åŒæ­¥åˆ°å…¶ä»–coreï¼Œæ­¤æ—¶å…¶ä»–coreï¼ˆå¦‚core nï¼‰ç«‹å³è¯»å–æœ€æ–°æ•°æ®ï¼ˆå¦‚æ›´æ–°ä¸ºcore 1ä¸­æ•°æ®ï¼‰ã€‚   write-backï¼ˆå†™å›æ³•ï¼‰ä¸­éå¸¸æœ‰åçš„cacheä¸€è‡´æ€§ç®—æ³•MESIï¼Œå®ƒæ˜¯å…¸å‹çš„å¼ºä¸€è‡´ç®—æ³•ï¼Œintelå°±å‡­å€ŸMESIä¼˜é›…åœ°å®ç°äº†å¼ºä¸€è‡´CPUï¼Œç°åœ¨intelä¼˜åŒ–äº†ä¸‹MESIï¼Œå¾—åˆ°äº†MESIFï¼Œå®ƒæœ‰æ•ˆå‡å°‘äº†å¹¿æ’­ä¸­req/rspæ•°é‡ï¼Œå‡å°‘äº†å¸¦å®½å ç”¨ï¼Œæé«˜äº†å¤„ç†å™¨å¤„ç†çš„ååé‡ã€‚å…³äºMESIï¼Œè¿™é‡Œæœ‰ä¸ªå¯è§†åŒ–çš„MESIäº¤äº’æ¼”ç¤ºç¨‹åºå¯ä»¥å¸®åŠ©ç†è§£å…¶å·¥ä½œåŸç†ï¼ŒæŸ¥çœ‹MESIå¯è§†åŒ–äº¤äº’ç¨‹åºã€‚\næˆ‘ä»¬å°±å…ˆç»“åˆç®€å•çš„MESIè¿™ä¸ªå¼ºä¸€è‡´æ€§åè®®æ¥è¯•ç€ç†è§£ä¸‹â€œx86ä¸‹ä¸ºä»€ä¹ˆå°±å¯ä»¥ä¿è¯å¯è§æ€§â€ï¼Œç»“åˆå¤šçº¿ç¨‹åœºæ™¯åˆ†æï¼š\n ä¸€ä¸ªvolatileå…±äº«å˜é‡è¢«å¤šä¸ªçº¿ç¨‹è¯»å–ï¼Œå‡å®šè¿™å‡ ä¸ªçº¿ç¨‹è·‘åœ¨ä¸åŒçš„cpuæ ¸å¿ƒä¸Šï¼Œæ¯ä¸ªæ ¸å¿ƒæœ‰è‡ªå·±çš„cacheï¼Œçº¿ç¨‹1è·‘åœ¨core1ä¸Šï¼Œçº¿ç¨‹2è·‘åœ¨core2ä¸Šã€‚ ç°åœ¨çº¿ç¨‹1å‡†å¤‡ä¿®æ”¹å˜é‡å€¼ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå…ˆä¿®æ”¹cacheä¸­çš„å€¼ç„¶åç¨åæŸä¸ªæ—¶åˆ»å†™å›ä¸»å­˜æˆ–è€…è¢«å…¶ä»–coreè¯»å–ã€‚cacheåŒæ­¥ç­–ç•¥â€œwrite-backâ€ï¼ŒMESIå°±æ˜¯å…¶ä¸­çš„ä¸€ç§ã€‚å¤„ç†å™¨æ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½èƒ½è¢«æ€»çº¿è§‚æµ‹åˆ°ï¼Œsnoop based cache coherencyï¼Œå½“çº¿ç¨‹2å‡†å¤‡è¯»å–è¿™ä¸ªå˜é‡æ—¶ï¼š å‡å®šä¹‹å‰æ²¡è¯»å–è¿‡ï¼Œå‘ç°è‡ªå·±çš„cacheé‡Œé¢æ²¡æœ‰ï¼Œå°±é€šè¿‡æ€»çº¿å‘å†…å­˜è¯·æ±‚ï¼Œä¸ºäº†ä¿è¯cpu cacheé«˜ååé‡ï¼Œæ€»çº¿ä¸Šæ‰€æœ‰çš„äº‹åŠ¡éƒ½èƒ½è¢«å…¶ä»–coreè§‚æµ‹åˆ°ï¼Œcore1å‘ç°core2è¦è¯»å–å†…å­˜å€¼ï¼Œè¿™ä¸ªæ•°æ®åˆšå¥½åœ¨æˆ‘çš„cacheé‡Œé¢ï¼Œä½†æ˜¯å¤„äºdirtyçŠ¶æ€ã€‚core1å¯èƒ½ç°é‡‡å–ä¸¤ç§åŠ¨ä½œï¼Œä¸€ç§æ˜¯å°†dirtyæ•°æ®ç›´æ¥ä¸¢ç»™core2ï¼ˆè‡³å°‘æ˜¯æœ€æ–°çš„ï¼‰ï¼Œæˆ–è€…å‘ŠçŸ¥core2å»¶è¿Ÿreadï¼Œç­‰æˆ‘å…ˆå†™å›ä¸»å­˜ï¼Œç„¶åcore2å†å°è¯•readå†…å­˜ã€‚ å‡å®šä¹‹å‰è¯»å–è¿‡äº†ï¼Œcore1å¯¹å˜é‡çš„ä¿®æ”¹ä¹Ÿä¼šè¢«core2è§‚æµ‹åˆ°ï¼Œcore1åº”è¯¥å°†å…¶cache lineæ ‡è®°ä¸ºmodifiedï¼Œå°†core2 cache lineæ ‡è®°ä¸ºinvalidateä½¿å…¶å¤±æ•ˆï¼Œä¸‹æ¬¡core2è¯»å–æ—¶ä»core1è·å–æˆ–å†…å­˜è·å–ï¼ˆè§¦å‘core1å°†dirtyæ•°æ®å†™å›ä¸»å­˜ï¼‰ã€‚  è¿™ä¹ˆçœ‹æ¥åªè¦å¤„ç†å™¨çš„cacheä¸€è‡´æ€§ç®—æ³•æ”¯æŒï¼Œå¹¶ä¸”ç»“åˆvolatileé¿å…å¯„å­˜å™¨ç›¸å…³ä¼˜åŒ–ï¼Œå°±èƒ½è½»æ¾ä¿è¯çº¿ç¨‹å¯è§è¡Œã€‚çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿå¹¶ä¸æ˜¯ã€‚\nè®¤ä¸ºæœ‰äº†MESIF volatileå°±å¯ä»¥åœ¨x86å¹³å°ä¸Šå®ç°å¯è§æ€§ï¼Œè¿™ç§ç†è§£æ˜¯æœ‰é—®é¢˜çš„ï¼š\n volatileåªæ˜¯é¿å…äº†software cachingï¼Œä¸èƒ½é¿å…hardware cachingï¼› ç°åœ¨x86å¤„ç†å™¨ä¸­éƒ½å¼•å…¥äº†store bufferï¼Œvolatileå˜é‡æ›´æ–°æ“ä½œä¼šå…ˆæ”¾å…¥store bufferä¸­ï¼› store bufferä¸­çš„æ›´æ–°æ“ä½œä¼šå°½å¯èƒ½å¿«åœ°æ›´æ–°åˆ°cacheï¼Œæœ‰å¤šå¿«ä¸ç¡®å®šï¼Œåæ­£ä¸æ˜¯ç«‹å³ï¼ˆè¿‡æ®µæ—¶é—´æˆ–è€…æœ‰write barrieréƒ½å¯ä»¥æ¸…ç©ºï¼‰ï¼› store bufferä¸­çš„æ›´æ–°è½åˆ°L1 cacheåä¼šè§¦å‘MESIFæ“ä½œï¼Œå¦‚å°†å½“å‰cacheçš„cachelineä¿®æ”¹ä¸ºModifiedï¼Œå¹¶å¹¿æ’­ç»™å…¶ä»–æ ¸MESIF invalidateè¯·æ±‚ï¼Œå…¶ä»–æ ¸å°†å…¶æ”¾å…¥invalidate queueä¸­ï¼Œå›å¤ackä½†ä¸ç«‹å³å¤„ç†ï¼› ç­‰å…¶ä»–æ ¸ä¸‹æ¬¡è¯»å–æ—¶ï¼Œå¦‚æœè¿˜æ²¡å¤„ç†å®Œinvalidate queueä¸­çš„è¯·æ±‚ï¼Œå°±ä¼šä»æœ¬åœ°çš„cachelineä¸­è¯»å–åˆ°æ—§å€¼ï¼Œå› ä¸ºæ­¤æ—¶cachelineçš„çŠ¶æ€æ˜¯Sharedï¼Œè¿˜æ˜¯å¯ä»¥è¯»å–çš„ï¼› å¦‚æœå·²ç»å¤„ç†å®Œäº†invalidate queueä¸­çš„äº‹ä»¶ï¼ˆè¿‡ä¸€æ®µæ—¶é—´æˆ–è€…æœ‰read barrieréƒ½å¯ä»¥æ¸…ç©ºï¼‰ï¼Œä¼šå°†å¯¹åº”cachelineçŠ¶æ€ä¿®æ”¹ä¸ºInvalidatedï¼Œæ­¤æ—¶ä¼šé‡è¯•ä»æ€»çº¿è¯»å–è¯¥cachelineå¯¹åº”å†…å­˜å—çš„æœ€æ–°æ•°æ®ã€‚å…¶ä»–æ ¸ä¹Ÿä¼šobserve/snoopå…¶å®ƒæ ¸å‘é€åˆ°æ€»çº¿çš„å†…å­˜è¯»å–äº‹ä»¶ï¼Œå¦‚æœå®ƒçŸ¥é“è¯¥å†…å­˜å—å¯¹åº”çš„cachelineè‡ªå·±çš„æ‰æ˜¯æœ€æ–°çš„ï¼ˆModifiedï¼‰ï¼Œå°±ä¼šå°†å…¶æœ€æ–°æ•°æ®ä½œä¸ºå“åº”å¹¶å†™å›ä¸»å­˜ï¼Œæ­¤æ—¶ä¸¤è¾¹çš„cachelineå…¨éƒ¨æ”¹ä¸ºSharedçŠ¶æ€ã€‚  ä»åŸºäºå¯¹ç°ä»£CPUæ¶æ„ã€cacheä¸€è‡´æ€§åè®®çš„äº†è§£ï¼Œæˆ‘ä¸è®¤ä¸ºx86å¹³å°ä¸‹volatileå°±å¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚æˆ‘ç”šè‡³æ€€ç–‘å½“æ—¶è·Ÿæˆ‘æâ€œæˆ‘ä»¬ç”¨volatileä¹‹å‰æœ‰é—®é¢˜ç”¨äº†ä¹‹åOKäº†â€çš„åŒå­¦æ˜¯ä¸æ˜¯çœŸçš„éªŒè¯æ²¡é—®é¢˜äº†ï¼Œè¿˜æ˜¯è¯´ç”¨çš„å…¶å®æ˜¯atomicæˆ–è€…å…¶ä»–barriersã€‚æ€»ä¹‹æˆ‘åœ¨Intel Core i7ä¸Šæ²¡æœ‰æ„é€ å‡ºåˆé€‚çš„ç”¨ä¾‹æ¥è¯æ˜volatileå¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œå¯èƒ½ç¡¬ä»¶store bufferå’Œinvalidate queueå¤„ç†è¿˜æ˜¯å¾ˆå¿«çš„ï¼Œæˆ‘ä»¬æ„é€ ä¸¤ä¸‰ä¸ªçº¿ç¨‹å¹¶å‘è¯»å†™volatileä¸å®¹æ˜“å¤ç°è¿™ä¸ªé—®é¢˜ã€‚\nè€Œä¸”ï¼Œä¸åŒçš„å¤„ç†å™¨è®¾è®¡ä¸ä¸€æ ·ï¼Œæˆ‘ä»¬åªæ˜¯ä»¥MESIåè®®æ¥ç²—ç•¥äº†è§£äº†x86çš„å¤„ç†æ–¹å¼ï¼Œå¯¹äºå…¶ä»–å¼±ä¸€è‡´æ€§CPUï¼Œå³ä¾¿ä½¿ç”¨äº†volatileä¹Ÿä¸ä¸€å®šèƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚\nä½†è‹¥æ˜¯å¯¹volatileå˜é‡è¯»å†™æ—¶å®‰æ’äº†ç±»ä¼¼MFENCEã€LOCKæŒ‡ä»¤ä¹Ÿæ˜¯å¯ä»¥ä¿è¯å¯è§æ€§çš„ï¼Œå¦‚ä½•è¿›ä¸€æ­¥åˆ¤æ–­ç¼–è¯‘å™¨æœ‰æ²¡æœ‰ç”Ÿæˆç±»ä¼¼barriersæŒ‡ä»¤å‘¢ï¼Ÿè¿˜éœ€è¦åˆ¤æ–­ç¼–è¯‘å™¨ï¼ˆå¦‚gccï¼‰æ˜¯å¦æœ‰å¯¹volatileæ¥åšç‰¹æ®Šå¤„ç†ï¼Œå¦‚å®‰æ’MFENCEã€LOCKæŒ‡ä»¤ä¹‹ç±»çš„ã€‚ä¸Šé¢ç¼–å†™çš„åæ±‡ç¼–æµ‹è¯•ç¤ºä¾‹ä¸­ï¼Œgccç”Ÿæˆçš„æ±‡ç¼–æ²¡æœ‰çœ‹åˆ°lockç›¸å…³çš„æŒ‡ä»¤ï¼Œä½†æ˜¯å› ä¸ºæˆ‘æ˜¯åœ¨x86ä¸Šæµ‹è¯•çš„ï¼Œè€Œx86åˆšå¥½æ˜¯å¼ºä¸€è‡´CPUï¼Œæˆ‘ä¹Ÿä¸ç¡®å®šæ˜¯ä¸æ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œgccç›´æ¥å›¾çœäº‹ç•¥æ‰äº†lockæŒ‡ä»¤ï¼Ÿæ‰€ä»¥ç°åœ¨è¦éªŒè¯ä¸‹ï¼Œåœ¨å…¶ä»–éx86å¹³å°ä¸Šï¼Œgcc -O2ä¼˜åŒ–æ—¶åšäº†ä½•ç§å¤„ç†ã€‚å¦‚æœå®‰æ’äº†ç±»ä¼¼æŒ‡ä»¤ï¼Œé—®é¢˜å°±è§£å†³äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾—å‡ºç»“è®ºï¼Œcã€c++ä¸­volatileåœ¨gccå¤„ç†ä¸‹å¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œåä¹‹åˆ™ä¸èƒ½å¾—åˆ°è¿™æ ·çš„ç»“è®ºï¼\næˆ‘åœ¨ç½‘ç«™godbolt.orgäº¤å‰ç¼–è¯‘æµ‹è¯•äº†ä¸€ä¸‹ä¸Šé¢gccå¤„ç†çš„ä»£ç ï¼Œæ¢äº†å‡ ä¸ªä¸åŒçš„ç¡¬ä»¶å¹³å°ä¹Ÿæ²¡å‘ç°æœ‰ç”Ÿæˆç‰¹å®šçš„ç±»ä¼¼MFENCEæˆ–è€…LOCKç›¸å…³çš„è‡´ä½¿å¤„ç†å™¨cacheå¤±æ•ˆåé‡æ–°ä»å†…å­˜åŠ è½½çš„æŒ‡ä»¤ã€‚\n å¤‡æ³¨ï¼šåœ¨æŸäº›å¤„ç†å™¨æ¶æ„ä¸‹ï¼Œgccç¡®å®æœ‰æä¾›ä¸€äº›ç‰¹æ®Šçš„ç¼–è¯‘é€‰é¡¹å…è®¸ç»•è¿‡CPU cacheç›´æ¥å¯¹å†…å­˜è¿›è¡Œè¯»å†™ï¼Œå¯å‚è€ƒgcc manæ‰‹å†Œâ€œ-mcache-volatileâ€ã€â€œ-mcache-bypassâ€é€‰é¡¹çš„æè¿°ã€‚\n æƒ³äº†è§£ä¸‹CC++ä¸­volatileçš„çœŸå®è®¾è®¡â€œæ„å›¾â€ï¼Œç„¶åï¼Œåœ¨stack overflowä¸Šæˆ‘åˆæ‰¾åˆ°äº†è¿™æ ·ä¸€ä¸ªå›ç­”ï¼šhttps://stackoverflow.com/a/12878500ï¼Œé‡ç‚¹å†…å®¹å·²åŠ ç²—æ˜¾ç¤ºã€‚\n[Nicol Bolas](https://stackoverflow.com/users/734069/nicol-bolas)å›ç­”ä¸­æåˆ°ï¼š\n What volatile tells the compiler is that it can\u0026rsquo;t optimize memory reads from that variable. However, CPU cores have different caches, and most memory writes do not immediately go out to main memory. They get stored in that core\u0026rsquo;s local cache, and may be written\u0026hellip; eventually.**\nCPUs have ways to force cache lines out into memory and to synchronize memory access among different cores. These memory barriers allow two threads to communicate effectively. Merely reading from memory in one core that was written in another core isn\u0026rsquo;t enough; the core that wrote the memory needs to issue a barrier, and the core that\u0026rsquo;s reading it needs to have had that barrier complete before reading it to actually get the data.\nvolatile guarantees none of this. Volatile works with \u0026ldquo;hardware, mapped memory and stuff\u0026rdquo; because the hardware that writes that memory makes sure that the cache issue is taken care of. If CPU cores issued a memory barrier after every write, you can basically kiss any hope of performance goodbye. So C++11 has specific language saying when constructs are required to issue a barrier.\n Dietmar KÃ¼hlå›ç­”ä¸­æåˆ°:\n The volatile keyword has nothing to do with concurrency in C++ at all! It is used to have the compiler prevented from making use of the previous value, i.e., the compiler will generate code accessing a volatile value every time is accessed in the code. The main purpose are things like memory mapped I/O. However, use of volatile has no affect on what the CPU does when reading normal memory: If the CPU has no reason to believe that the value changed in memory, e.g., because there is no synchronization directive, it can just use the value from its cache. To communicate between threads you need some synchronization, e.g., an std::atomic, lock a std::mutex, etc.\n æœ€åçœ‹äº†æ ‡å‡†å§”å‘˜ä¼šå¯¹volatileçš„è®¨è®ºï¼šhttp://www.open-std.org/jtc1/sc22/wg21/docs/papers/2006/n2016.html ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯CC++ä¸­å½“ç„¶ä¹Ÿæƒ³æä¾›javaä¸­volatileä¸€æ ·çš„çº¿ç¨‹å¯è§æ€§ã€é˜»æ­¢æŒ‡ä»¤é‡æ’åºï¼Œä½†æ˜¯è€ƒè™‘åˆ°ç°æœ‰ä»£ç å·²ç»é‚£ä¹ˆå¤šäº†ï¼Œçªç„¶æ”¹å˜volatileçš„è¯­ä¹‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç°æœ‰ä»£ç çš„è¯¸å¤šé—®é¢˜ï¼Œæ‰€ä»¥å¿…é¡»è¦å†æƒè¡¡ä¸€ä¸‹ï¼Œåˆ°åº•å€¼ä¸å€¼å¾—ä¸ºvolatileå¢åŠ ä¸Šè¿°è¯­ä¹‰ï¼Œå½“å‰C++æ ‡å‡†å§”å‘˜ä¼šå»ºè®®ä¸æ”¹å˜volatileè¯­ä¹‰ï¼Œè€Œæ˜¯é€šè¿‡æ–°çš„std::atmoicç­‰æ¥æ”¯æŒä¸Šè¿°è¯­ä¹‰ã€‚\nç»“åˆè‡ªå·±çš„å®é™…æ“ä½œã€ä»–äººçš„å›ç­”ä»¥åŠCC++ç›¸å…³æ ‡å‡†çš„æè¿°ï¼Œæˆ‘è®¤ä¸ºCC++ volatileç¡®å®ä¸èƒ½ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚ä½†æ˜¯ç”±äºå†å²çš„åŸå› ã€å…¶ä»–è¯­è¨€çš„å½±å“ã€å¼€å‘è€…è‡ªå·±çš„è¯¯è§£ï¼Œè¿™äº›å…±åŒå¯¼è‡´å¼€å‘è€…èµ‹äºˆäº†CC++ volatileå¾ˆå¤šæœ¬ä¸å±äºå®ƒçš„èƒ½åŠ›ï¼Œç”šè‡³å¤§é”™ç‰¹é”™ï¼Œå°±è¿Linus Torvardsä¹Ÿåœ¨å†…æ ¸æ–‡æ¡£ä¸­æè¿°volatileæ—¶è¯´ï¼Œå»ºè®®å°½é‡ç”¨memory barrieræ›¿æ¢æ‰volatileï¼Œä»–è®¤ä¸ºå‡ ä¹æ‰€æœ‰å¯èƒ½å‡ºç°volatileçš„åœ°æ–¹éƒ½å¯èƒ½ä¼šæ½œè—ç€ä¸€ä¸ªbugï¼Œå¹¶æé†’å¼€å‘è€…ä¸€å®šå°å¿ƒè°¨æ…ã€‚\n6. å®è·µä¸­å¦‚ä½•æ“ä½œ #  å¼€å‘è€…åº”è¯¥å°½é‡ç¼–å†™å¯ç§»æ¤çš„ä»£ç ï¼Œåƒx86è¿™ç§å¼ºä¸€è‡´CPUï¼Œè™½ç„¶ç»“åˆvolatileä¹Ÿå¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ï¼Œä½†æ˜¯æ—¢ç„¶æä¾›äº†ç±»ä¼¼memory barrier()ã€std::atomicç­‰æ›´åŠ é è°±çš„ç”¨æ³•ï¼Œä¸ºä»€ä¹ˆè¦ç¼–å†™è¿™ç§å…¼é¡¾volatileã€x86ç‰¹æ€§çš„ä»£ç å‘¢ï¼Ÿ å¼€å‘è€…åº”è¯¥ç¼–å†™å¯ç»´æŠ¤çš„ä»£ç ï¼Œå¯¹äºè¿™ç§å®¹æ˜“å¼•èµ·å¼€å‘è€…è¯¯ä¼šçš„ä»£ç ã€ç‰¹æ€§ï¼Œåº”è¯¥å°½é‡å°‘ç”¨ï¼Œè¿™è™½ç„¶ä¸èƒ½è¯´æˆæ˜¯è¯­è¨€è®¾è®¡ä¸Šçš„ç¼ºé™·ï¼Œä½†æ˜¯ç¡®å®ä¹Ÿä¸èƒ½ç®—æ˜¯ä¸€ä¸ªä¼˜åŠ¿ã€‚  å‡¡äº‹éƒ½æ²¡æœ‰ç»å¯¹çš„ï¼Œç”¨ä¸ç”¨volatileã€æ€ä¹ˆç”¨volatileéœ€è¦å¼€å‘è€…è‡ªå·±æƒè¡¡ï¼Œæœ¬æ–‡çš„ç›®çš„ä¸»è¦æ˜¯æƒ³æ€»ç»“CC++ volatileçš„â€œèƒ½â€ä¸â€œä¸èƒ½â€ä»¥åŠèƒŒåçš„åŸå› ã€‚ç”±äºä¸ªäººè®¤è¯†çš„å±€é™æ€§ï¼Œéš¾å…ä¼šå‡ºç°é”™è¯¯ï¼Œä¹Ÿè¯·å¤§å®¶æŒ‡æ­£ã€‚\n æœ¬æ–‡æ’°å†™äº 2019-01-07, ç°åœ¨æ‹¿å‡ºæ¥åˆ†äº«ç»™æ„Ÿå…´è¶£çš„æŠ€æœ¯åŒè¡Œï¼Œä¸€èµ·å­¦ä¹ äº¤æµã€‚\n å…³äºå¯¹volatileçš„ç†è§£ï¼Œä¼šå¼•å‡ºå¯¹å†…å­˜æ¨¡å‹çš„ç†è§£ï¼Œå³ä¾¿çœ‹å®Œä¸€äº›é’ˆå¯¹å†…å­˜æ¨¡å‹çš„æè¿°ä¹‹åï¼Œè¿˜æ˜¯ä¼šæœ‰ä¸€äº›å¼€å‘è€…æå‡ºæ›´æ·±å…¥ç»†å¾®çš„é—®é¢˜ï¼Œæ¯”å¦‚lock, lock cmpxchgå¦‚ä½•å®ç°çš„ï¼Œmfenceã€lfenceã€sfenceå¦‚ä½•å®ç°çš„ã€‚é™·å…¥ç»†èŠ‚æ˜¯å¯æ€•çš„ï¼Œå®ƒä¼šè®©æˆ‘ä»¬æ„Ÿè§‰æ— æ³•é€‚å¯è€Œæ­¢ã€‚\nè¡¥å……ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘è§‰å¾—æŒºä¸é”™çš„ï¼ŒMemory Barrier: A Hardware View for Software Hackersã€‚\nå®ƒä»‹ç»äº†ç°åœ¨å¤„ç†å™¨çš„cacheç»“æ„è®¾è®¡ï¼ˆåŒ…æ‹¬æŒ‡ä»¤cacheã€æ•°æ®cacheã€cachelineã€store bufferã€å¤šçº§cacheï¼‰ã€cacheä¸€è‡´æ€§åè®®MESIï¼Œä»¥åŠæ‰€è°“çš„å†…å­˜å±éšœä¸cacheè®¾è®¡ä¸­cacheä¸€è‡´æ€§åè®®ã€store bufferã€invalidate queueä¹‹é—´çš„å…³ç³»ã€‚ç†è§£ä¸‹è¿™ç¯‡æ–‡ç« ï¼Œå¤§è‡´ææ˜ç™½ç¡¬ä»¶çš„å·¥ä½œè¿‡ç¨‹ï¼Œéå¸¸æœ‰åŠ©äºåŠ æ·±è¿™éƒ¨åˆ†çš„ç†è§£ã€‚\n æœ¬æ–‡æœ€åæ›´æ–°äº 2020-12-15, è¡¥å……äº†ä¸Šè¿°å†…å­˜å±éšœç›¸å…³çš„æè¿°åŠå‚è€ƒèµ„æ–™ã€‚\n è¿™é‡Œè¿˜å°‘äº†ä¸€å±‚ï¼Œåœ¨cpuæ‰§è¡Œæ›´æ–°æ“ä½œæ—¶ï¼Œä¸ºäº†é¿å…cpu stallæé«˜æŒ‡ä»¤ååï¼Œå†™æ›´æ–°å…¶å®æ˜¯è½store bufferä¸­çš„ï¼Œcacheä¸­å¹¶æ²¡æœ‰ç«‹å³ä½“ç°å‡ºæ›´æ–°ï¼Œcacheä¸€è‡´æ€§åè®®ä¹Ÿè¿˜æ²¡å·¥ä½œâ€¦â€¦æ‰€ä»¥è¿™ä¸ªæ—¶å€™è¿˜éœ€è¦å†…å­˜å±éšœæ¥è®²storebufferä¸­çš„æ›´æ–°åˆ·åˆ°cacheï¼Œè¯»çš„æ ¸ä¸Šè¿˜éœ€è¦é€šè¿‡å†…å­˜å±éšœå¤„ç†invalidate queueæ‰èƒ½è§‚å¯Ÿåˆ°æ–°å€¼ã€‚\né‚£x86+volatileæ²¡æœ‰åº”ç”¨å†…å­˜å±éšœï¼Œåˆæ˜¯æ€ä¹ˆèƒ½å®ç°å¯è§æ€§çš„å‘¢ï¼Ÿ\né¦–å…ˆä¸Šè¿°ç†è§£åŠè´¨ç–‘éƒ½æ˜¯æ­£ç¡®çš„æ€è€ƒè·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯x86ä½“ç³»ç»“æ„é‡Œé¢æ˜¯å¦æœ‰æˆ‘ä»¬æ‰€ä¸çŸ¥é“çš„ä¸œè¥¿ï¼Œè¿™ç¯‡è®ºæ–‡ä¹Ÿè®¸èƒ½è§£ç­”æˆ‘ä»¬çš„é—®é¢˜ï¼šx86 tso modelï¼š\n Moreover, different processors or hardware threads do not observably share store buffers. This is in sharp contrast to x86-CC, where each processor has a separate view order of its memory accesses and other processors' writes.\n æ„æ€å¤§æ¦‚å°±æ˜¯è¯´x86çš„è®¾è®¡ï¼Œæ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒä¸ä»…æœ‰è‡ªå·±çš„å†…å­˜è®¿é—®è§†å›¾ï¼Œè¿˜æœ‰ä¸€ä¸ªå…¶ä»–å¤„ç†å™¨çš„writeæ“ä½œçš„è§†å›¾ï¼Œè¿™æ ·å®ƒå°±èƒ½æ„ŸçŸ¥åˆ°è°æœ‰çœŸæ­£çš„æœ€æ–°çš„æ•°æ®ã€‚æ‰€ä»¥x86ä¸Šé¢åªè¦cç¨‹åºåŠ äº†volatileé¿å…å¯„å­˜å™¨ä¼˜åŒ–å°±å¯ä»¥ä¿è¯çº¿ç¨‹å¯è§æ€§ã€‚\nå‚è€ƒèµ„æ–™ #  Memory Barrier: A Hardware View for Software Hackers x86 TSO: A Programmer\u0026rsquo;s Model for x86 Multiprocessors x86-TSO: A Rigorous and Usable Programmerâ€™s Model for x86 Multiprocessors  "}),a.add({id:275,href:"/blog/2020-07-01-%E5%BC%80%E5%8F%91%E8%80%85%E5%BA%94%E6%8E%8C%E6%8F%A1%E7%9A%84%E7%B3%BB%E7%BB%9F%E6%80%A7%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95/",title:"å¼€å‘è€…åº”æŒæ¡çš„ç³»ç»Ÿæ€§æµ‹è¯•æ–¹æ³•",description:'/* Three image containers (use 25% for four, and 50% for two, etc) */ .column { float: left; width: 50%; padding: 5px; } /* Clear floats after image containers */ .row::after { content: ""; clear: both; display: table; } .fixsize { width: 400px; } .fullsize { width: 680px; }  å¦‚ä½•åšå¥½æµ‹è¯•ï¼Œæ˜¯ä¸€é—¨ç³»ç»Ÿæ€§çš„æ–¹æ³•å­¦ï¼Œè€Œä¸åªæ˜¯ä¸€äº›é›¶é›¶æ•£æ•£çš„ç»éªŒã€‚äº†è§£å¹¶æŒæ¡å„ç§æµ‹è¯•çš„ç›®çš„ã€æ–¹æ³•æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚\næœ€è¿‘å·¥ä½œä¸­ä¹Ÿåœ¨æ¨åŠ¨æµ‹è¯•ç›¸å…³çš„ä¸€äº›äº‹é¡¹ï¼Œæœ‰ä¸€ç‚¹æ„Ÿè§¦ï¼Œè¿™é‡Œå…ˆç®€å•æ€»ç»“ä¸‹å¸¸è§æµ‹è¯•æ–¹æ³•çš„ç›®çš„ï¼Œå¤§è‡´åŒ…æ‹¬å¦‚ä¸‹å‡ ç±»ã€‚\n1. ç ”å‘æµç¨‹ä¸­æ„å»ºç¯èŠ‚\n å†’çƒŸæµ‹è¯•\nè¯¥æœ¯è¯­ï¼Œå–è‡ªé›†æˆç”µè·¯å¼€å‘é¢†åŸŸï¼Œé›†æˆç”µè·¯åœ¨æµ‹è¯•ä¹‹å‰ï¼Œå…ˆè¦åŠ ç”µæ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰å†’çƒŸæ‰èƒ½è¿›è¡Œåç»­çš„æµ‹è¯•ã€‚å†’çƒŸæµ‹è¯•å¹¶ä¸æ˜¯æµ‹è¯•è¿‡ç¨‹çš„ä¸€ä¸ªé˜¶æ®µï¼Œå®ƒæ˜¯è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå®ƒåŒ…å«ä¸€äº›éå¸¸åŸºç¡€çš„æµ‹è¯•ï¼Œå¦‚ä¿è¯ç¼–è¯‘é€šè¿‡ã€éƒ¨åˆ†æ ¸å¿ƒç”¨ä¾‹é€šè¿‡ï¼Œå®ƒéšæ¯æ¬¡æ„å»ºè§¦å‘ï¼Œå¤„äºæŒç»­é›†æˆçš„ä¸€ä¸ªç¯èŠ‚ã€‚è‹±æ–‡è¡¨è¿°ä¸ºBVTæµ‹è¯•ï¼ŒBuild Verification Testingï¼Œä»ä¸­æ›´èƒ½æ„Ÿå—çš„åˆ°ã€‚å°†å…¶ç†è§£ä¸ºæµ‹è¯•çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ˜¯ä¸€ä¸ªå·¨å¤§çš„è¯¯åŒºã€‚  2. åŠŸèƒ½æ€§æŒ‡æ ‡ç›¸å…³æµ‹è¯•\n  åŠŸèƒ½æµ‹è¯•\nè½¯ä»¶éœ€æ±‚è¯´æ˜ä¸­å¯¹è½¯ä»¶éœ€è¦çš„åŠŸèƒ½è¿›è¡Œäº†æè¿°ï¼Œè½¯ä»¶éœ€æ±‚åˆ†æé˜¶æ®µä¼šå¯¹éœ€æ±‚è¯´æ˜è¿›è¡Œè¯¦ç»†åˆ†æï¼Œå¹¶æ•´ç†å‡ºç›¸å…³çš„è§„æ ¼è¯´æ˜ï¼ŒåŒ…æ‹¬æ¯ä¸ªç”¨ä¾‹çš„è¾“å…¥ã€è¾“å‡ºç­‰ç­‰ã€‚åŠŸèƒ½æµ‹è¯•ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¯¹è¿™é‡Œçš„è½¯ä»¶éœ€æ±‚è§„æ ¼è¯´æ˜è¿›è¡Œæµ‹è¯•ç”¨ä¾‹çš„è¦†ç›–ï¼Œè€ƒå¯Ÿçš„æ˜¯å¯¹å„ä¸ªç‚¹ã€å¼‚å¸¸è·¯å¾„çš„æŠŠæ§ç¨‹åº¦ã€‚åœ¨å®é™…ç ”å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘äººå‘˜ä¸€èˆ¬ä¼šå…ˆè‡ªæµ‹é€šè¿‡åï¼Œå†è½¬ç»™æµ‹è¯•å›¢é˜Ÿè¿›è¡Œè¿›ä¸€æ­¥çš„æµ‹è¯•ã€‚\n  å›å½’æµ‹è¯•\nä¹‹å‰å·²ç»æµ‹è¯•è¿‡çš„ç”¨ä¾‹ï¼Œå¯ä»¥æ²‰æ·€ä¸‹æ¥ï¼Œä¾›ä»¥åè¿›è¡Œå›å½’ï¼Œå·²å‘ç°è½¯ä»¶å˜æ›´ã€å‡çº§æœŸé—´æ˜¯å¦å¼•å…¥äº†bugã€‚',content:'/* Three image containers (use 25% for four, and 50% for two, etc) */ .column { float: left; width: 50%; padding: 5px; } /* Clear floats after image containers */ .row::after { content: ""; clear: both; display: table; } .fixsize { width: 400px; } .fullsize { width: 680px; }  å¦‚ä½•åšå¥½æµ‹è¯•ï¼Œæ˜¯ä¸€é—¨ç³»ç»Ÿæ€§çš„æ–¹æ³•å­¦ï¼Œè€Œä¸åªæ˜¯ä¸€äº›é›¶é›¶æ•£æ•£çš„ç»éªŒã€‚äº†è§£å¹¶æŒæ¡å„ç§æµ‹è¯•çš„ç›®çš„ã€æ–¹æ³•æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚\næœ€è¿‘å·¥ä½œä¸­ä¹Ÿåœ¨æ¨åŠ¨æµ‹è¯•ç›¸å…³çš„ä¸€äº›äº‹é¡¹ï¼Œæœ‰ä¸€ç‚¹æ„Ÿè§¦ï¼Œè¿™é‡Œå…ˆç®€å•æ€»ç»“ä¸‹å¸¸è§æµ‹è¯•æ–¹æ³•çš„ç›®çš„ï¼Œå¤§è‡´åŒ…æ‹¬å¦‚ä¸‹å‡ ç±»ã€‚\n1. ç ”å‘æµç¨‹ä¸­æ„å»ºç¯èŠ‚\n å†’çƒŸæµ‹è¯•\nè¯¥æœ¯è¯­ï¼Œå–è‡ªé›†æˆç”µè·¯å¼€å‘é¢†åŸŸï¼Œé›†æˆç”µè·¯åœ¨æµ‹è¯•ä¹‹å‰ï¼Œå…ˆè¦åŠ ç”µæ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰å†’çƒŸæ‰èƒ½è¿›è¡Œåç»­çš„æµ‹è¯•ã€‚å†’çƒŸæµ‹è¯•å¹¶ä¸æ˜¯æµ‹è¯•è¿‡ç¨‹çš„ä¸€ä¸ªé˜¶æ®µï¼Œå®ƒæ˜¯è½¯ä»¶æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸€ä¸ªç¯èŠ‚ï¼Œå®ƒåŒ…å«ä¸€äº›éå¸¸åŸºç¡€çš„æµ‹è¯•ï¼Œå¦‚ä¿è¯ç¼–è¯‘é€šè¿‡ã€éƒ¨åˆ†æ ¸å¿ƒç”¨ä¾‹é€šè¿‡ï¼Œå®ƒéšæ¯æ¬¡æ„å»ºè§¦å‘ï¼Œå¤„äºæŒç»­é›†æˆçš„ä¸€ä¸ªç¯èŠ‚ã€‚è‹±æ–‡è¡¨è¿°ä¸ºBVTæµ‹è¯•ï¼ŒBuild Verification Testingï¼Œä»ä¸­æ›´èƒ½æ„Ÿå—çš„åˆ°ã€‚å°†å…¶ç†è§£ä¸ºæµ‹è¯•çš„ä¸€ä¸ªé˜¶æ®µï¼Œæ˜¯ä¸€ä¸ªå·¨å¤§çš„è¯¯åŒºã€‚  2. åŠŸèƒ½æ€§æŒ‡æ ‡ç›¸å…³æµ‹è¯•\n  åŠŸèƒ½æµ‹è¯•\nè½¯ä»¶éœ€æ±‚è¯´æ˜ä¸­å¯¹è½¯ä»¶éœ€è¦çš„åŠŸèƒ½è¿›è¡Œäº†æè¿°ï¼Œè½¯ä»¶éœ€æ±‚åˆ†æé˜¶æ®µä¼šå¯¹éœ€æ±‚è¯´æ˜è¿›è¡Œè¯¦ç»†åˆ†æï¼Œå¹¶æ•´ç†å‡ºç›¸å…³çš„è§„æ ¼è¯´æ˜ï¼ŒåŒ…æ‹¬æ¯ä¸ªç”¨ä¾‹çš„è¾“å…¥ã€è¾“å‡ºç­‰ç­‰ã€‚åŠŸèƒ½æµ‹è¯•ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å¯¹è¿™é‡Œçš„è½¯ä»¶éœ€æ±‚è§„æ ¼è¯´æ˜è¿›è¡Œæµ‹è¯•ç”¨ä¾‹çš„è¦†ç›–ï¼Œè€ƒå¯Ÿçš„æ˜¯å¯¹å„ä¸ªç‚¹ã€å¼‚å¸¸è·¯å¾„çš„æŠŠæ§ç¨‹åº¦ã€‚åœ¨å®é™…ç ”å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘äººå‘˜ä¸€èˆ¬ä¼šå…ˆè‡ªæµ‹é€šè¿‡åï¼Œå†è½¬ç»™æµ‹è¯•å›¢é˜Ÿè¿›è¡Œè¿›ä¸€æ­¥çš„æµ‹è¯•ã€‚\n  å›å½’æµ‹è¯•\nä¹‹å‰å·²ç»æµ‹è¯•è¿‡çš„ç”¨ä¾‹ï¼Œå¯ä»¥æ²‰æ·€ä¸‹æ¥ï¼Œä¾›ä»¥åè¿›è¡Œå›å½’ï¼Œå·²å‘ç°è½¯ä»¶å˜æ›´ã€å‡çº§æœŸé—´æ˜¯å¦å¼•å…¥äº†bugã€‚\n  å…¶ä»–\n  3. éåŠŸèƒ½æ€§æŒ‡æ ‡ç›¸å…³æµ‹è¯•\n     æ€§èƒ½æµ‹è¯• (how much + how fast)\nå¯¹è½¯ä»¶çš„æ€§èƒ½æŒ‡æ ‡è¿›è¡Œæµ‹è¯•ï¼Œä»¥éªŒè¯æ˜¯å¦è¾¾åˆ°é¢„æœŸè®¾è®¡çš„æ€§èƒ½è¦æ±‚ã€‚åœ¨è½¯ä»¶è®¾è®¡ä¹‹åˆï¼Œéœ€æ±‚æ–¹ä¸€èˆ¬ä¼šæå‡ºæ˜ç¡®çš„æ€§èƒ½è¦æ±‚ï¼Œå¦‚å¸Œæœ›æ”¯æ’‘Nä¸ªç”¨æˆ·çš„å¹¶å‘è®¿é—®è¯·æ±‚ï¼Œå¸Œæœ›å“åº”æ—¶é—´èƒ½æ§åˆ¶åœ¨2sä»¥å†…ç­‰ç­‰ã€‚é™¤äº†ç”¨æˆ·æå‡ºçš„æ€§èƒ½æŒ‡æ ‡è¦æ±‚ï¼Œè½¯ä»¶è®¾è®¡äººå‘˜åœ¨ç³»ç»Ÿè®¾è®¡çš„æ—¶å€™ï¼Œä¹Ÿä¼šå¯¹ç³»ç»Ÿä¸­äº¤äº’çš„å„ä¸ªå­ç³»ç»Ÿã€ç»„ä»¶ä¹‹é—´çš„æ€§èƒ½æœ‰ä¸€å®šè¦æ±‚ï¼Œå¦‚å„ç»„ä»¶é€šä¿¡å“åº”æ—¶é—´åœ¨100msä»¥å†…ç­‰ã€‚\næ€§èƒ½æµ‹è¯•ï¼Œæ˜¯å¯¹ç³»ç»Ÿçš„ä¸€ä¸ªæ£€éªŒï¼Œæ£€éªŒæ˜¯å¦è¾¾åˆ°äº†é¢„æœŸçš„è®¾è®¡æ ‡å‡†ã€‚æ€§èƒ½æµ‹è¯•ï¼Œé€šå¸¸å¯ä»¥å‚è€ƒç³»ç»Ÿæœ€å¤§ååé‡æ—¶çš„è¯·æ±‚é‡çº§ã€å“åº”æ—¶é—´ï¼Œæ¥ç¡®å®šç³»ç»Ÿçš„æœ€ä½³è¿è¡Œç‚¹ï¼Œç§‘å­¦åˆç†åœ°éƒ¨ç½²è®¾å¤‡èµ„æºæ¥å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬ã€‚\næ€§èƒ½æµ‹è¯•ï¼Œé€šå¸¸ä¼šå’Œè´Ÿè½½æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ç­‰ç»“åˆèµ·æ¥ï¼Œä»¥è·å¾—ç³»ç»Ÿçš„æœ€ä½³è¿è¡Œç‚¹ã€ç³»ç»Ÿæœ€å¤§è´Ÿè½½ç‚¹ã€ç³»ç»Ÿå´©æºƒç‚¹ã€‚\n  è´Ÿè½½æµ‹è¯• (how much)\nåœ¨æ€§èƒ½æµ‹è¯•è¯·æ±‚é‡åŸºç¡€ä¸Šè¿›ä¸€æ­¥å¢å¤§è¯·æ±‚é‡ï¼Œç›´åˆ°ç³»ç»Ÿååé‡ä¸éšè¯·æ±‚é‡å¢åŠ è€Œå¢åŠ ï¼ˆè€Œæ˜¯ä¸‹é™ï¼‰ã€‚è¿™ä¸ªä¸´ç•Œç‚¹å°±æ˜¯æœ€å¤§è´Ÿè½½ç‚¹ï¼Œè¡¨ç¤ºç³»ç»Ÿå½“å‰å·²ç»æ»¡è´Ÿè·è¿è¡Œï¼Œç»§ç»­å¢å¤§è¯·æ±‚é‡çš„è¯ï¼Œè¯·æ±‚å¤„ç†å°±ä¼šå˜å¾—æ›´æ…¢ã€‚\n  å‹åŠ›æµ‹è¯• (how much)\nåœ¨å‹åŠ›æµ‹è¯•çš„åŸºç¡€ä¸Šï¼Œç»§ç»­å¢å¤§è¯·æ±‚é‡ï¼Œä»¥æ£€éªŒç³»ç»Ÿçš„è€å‹èƒ½åŠ›ï¼Œè¯·æ±‚é‡çš„ç»§ç»­å¢å¤§ï¼Œæ„å‘³ç€ä¼šæ¶ˆè€—æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œå¦‚å†…å­˜ã€CPUã€ç½‘å¡ç­‰ç­‰ï¼Œèµ„æºä¸è¶³è‚¯å®šä¼šå½±å“åˆ°è¯·æ±‚å¤„ç†ï¼ŒæœåŠ¡æœ¬èº«éœ€è¦å…·å¤‡ä¸€å®šçš„è¿‡è½½ä¿æŠ¤èƒ½åŠ›ï¼Œå¦‚é™åˆ¶å…¥è¿æ¥æ•°ã€å…¥è¯·æ±‚æ•°ç­‰ï¼ŒæœåŠ¡æœ¬èº«å¦‚æœä¸å¤Ÿå¥å£®çš„è¯ï¼Œææœ‰å¯èƒ½ä¼šå¯¼è‡´æ‹’ç»å“åº”ï¼Œå¦‚å†…å­˜ä¸è¶³é¢‘ç¹GCç”šè‡³å½±å“åˆ°äº†æ­£å¸¸è¯·æ±‚å¤„ç†æ— æ³•å“åº”ã€‚\nç³»ç»Ÿæ— æ³•åšå‡ºå“åº”çš„ç‚¹ï¼Œå³ä¸ºç³»ç»Ÿå´©æºƒç‚¹ï¼Œè¯·æ±‚é‡ç»§ç»­å¢åŠ ç³»ç»Ÿå°†æ— æ³•åšå‡ºå“åº”ã€‚\n  å¯ç”¨æ€§æµ‹è¯•\nç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œè¡¨ç¤ºç³»ç»Ÿåœ¨ä»»æ„æŒ‡å®šçš„æ—¶é—´ç‚¹ï¼Œç³»ç»Ÿæ˜¯å¦å¯ç”¨ï¼Œé€šå¸¸æœ‰Nä¸ª9æ¥è¡¨ç¤ºï¼Œå¦‚ç³»ç»Ÿè¾¾åˆ°5ä¸ª9çš„å¯ç”¨æ€§ï¼Œè¡¨ç¤ºç³»ç»Ÿå…¨å¹´åªæœ‰365x24x3600x(1-0.99999)=315s=5minçš„ä¸å¯ç”¨æ—¶é—´ã€‚\næœåŠ¡çº§åˆ«åè®®ï¼ˆservice-level agreementï¼Œç¼©å†™SLAï¼‰ä¹Ÿç§°æœåŠ¡ç­‰çº§åè®®ã€æœåŠ¡æ°´å¹³åè®®ï¼Œæ˜¯æœåŠ¡æä¾›å•†ä¸å®¢æˆ·ä¹‹é—´å®šä¹‰çš„æ­£å¼æ‰¿è¯ºã€‚æœåŠ¡æä¾›å•†ä¸å—æœåŠ¡ç”¨æˆ·ä¹‹é—´å…·ä½“è¾¾æˆäº†æ‰¿è¯ºçš„æœåŠ¡æŒ‡æ ‡â€”â€”è´¨é‡ã€å¯ç”¨æ€§ã€è´£ä»»ã€‚SLAæœ€å¸¸è§çš„ç»„æˆéƒ¨åˆ†æ˜¯ä»¥åˆåŒçº¦å®šå‘å®¢æˆ·æä¾›çš„æœåŠ¡ã€‚ä¾‹å¦‚ï¼Œäº’è”ç½‘æœåŠ¡ä¾›åº”å•†ï¼ˆISPï¼‰å’Œç”µä¿¡å…¬å¸é€šå¸¸åœ¨ä¸å®¢æˆ·çš„åˆåŒæ¡æ¬¾å†…åŒ…å«ç®€å•å®šä¹‰çš„æœåŠ¡çº§åˆ«åè®®ã€‚åœ¨æ­¤äº‹ä¾‹ä¸‹ï¼ŒSLAé€šå¸¸å®šä¹‰æœ‰å¹³å‡æ•…éšœé—´éš”ï¼ˆMTBFï¼‰ã€å¹³å‡ä¿®å¤æ—¶é—´æˆ–å¹³å‡ä¿®å¤æ—¶é—´ï¼ˆMTTRï¼‰ï¼›å“ªä¸€æ–¹è´Ÿè´£æŠ¥å‘Šé”™è¯¯ä¸æ”¯ä»˜è´¹ç”¨ï¼›ååé‡ï¼›æŠ–åŠ¨ï¼›æˆ–ç±»ä¼¼çš„å¯è¡¡é‡ç»†èŠ‚ã€‚ é€šå¸¸ï¼ŒæœåŠ¡æä¾›å•†éœ€è¦æœ‰SLAä¿è¯å®¢æˆ·æƒç›Šã€‚\n  ç¨³å®šæ€§æµ‹è¯•\nç¨³å®šæ€§æµ‹è¯•ï¼Œæ˜¯ç”¨æ¥éªŒè¯äº§å“åœ¨ä¸€å®šçš„è´Ÿè½½ä¸‹ï¼Œæ˜¯å¦èƒ½å¤Ÿé•¿æ—¶é—´çš„ç¨³å®šæ€§è¿è¡Œï¼Œå…¶ä¸»è¦ç›®çš„æ˜¯éªŒè¯èƒ½åŠ›ï¼Œå¹¶åœ¨éªŒè¯è¿‡ç¨‹ä¸­å‘ç°ç³»ç»Ÿä¸ç¨³å®šçš„å› ç´ å¹¶è¿›è¡Œåˆ†æè§£å†³ã€‚\n  å®‰å…¨æµ‹è¯•\nå¯¹ç³»ç»Ÿè¿›è¡Œå®‰å…¨æ€§ç›¸å…³çš„æµ‹è¯•ï¼Œå¦‚æ•æ„Ÿæƒé™ã€sqlæ³¨å…¥ã€csrfä¾›ç»™ã€apié‰´æƒã€æœ‰æ¼æ´çš„ä¸å®‰å…¨ç»„ä»¶ç­‰ç­‰ï¼Œé€šå¸¸è¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„å·¥ç¨‹ï¼Œéœ€è¦æœ‰ä¸“ä¸šå›¢é˜Ÿæ¥æ”¯æ’‘ï¼Œå¹¶æä¾›å®‰å…¨ç›¸å…³çš„æœåŠ¡ä¾›ä¸šåŠ¡å›¢é˜Ÿæ¥å…¥ä½¿ç”¨ã€‚\n  è½¯ä»¶ç ”å‘æµç¨‹ä¸­çš„å„ä¸ªé˜¶æ®µï¼Œä»”ç»†è§‚å¯Ÿä¹‹åä½ ä¼šå‘ç°ï¼Œæ¯ä¸€ç¯éƒ½ä¸è½¯ä»¶æœ€ç»ˆäº¤ä»˜è´¨é‡æ¯æ¯ç›¸å…³ã€‚äº†è§£å¹¶æŒæ¡å„ä¸ªé˜¶æ®µå¸¸è§çš„ä¸€äº›ç³»ç»Ÿæ€§æµ‹è¯•æ–¹æ³•ï¼Œæ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚\n'}),a.add({id:276,href:"/blog/2020-06-27-%E4%B8%AD%E5%9B%BD%E4%BA%BA%E8%A6%81%E5%AD%A6%E7%9D%80%E5%8B%87%E6%95%A2%E8%AE%B2%E7%9C%9F%E8%AF%9D/",title:"ä¸­å›½äººè¦å­¦ç€å‹‡æ•¢è®²çœŸè¯",description:"æœ€è¿‘è‹Ÿæ™¶è¢«å†’åé¡¶æ›¿ä¸Šå¤§å­¦çš„äº‹æƒ…ï¼Œæˆä¸ºç¤¾ä¼šå…³æ³¨ç„¦ç‚¹ï¼Œä½œä¸ºå±±ä¸œè€ä¹¡ï¼Œä¹Ÿå¿ä¸ä½å›æƒ³èµ·æ±‚å­¦æ—¶çš„ä¸€äº›ç»å†ï¼Œä¸€äº›ä»å†…å¿ƒé‡Œé¢ è¦†æˆ‘è®¤çŸ¥ã€æ”¹å˜æˆ‘çœ‹æ³•çš„ç»å†ã€‚æœ‰æ—¶ï¼Œæˆ‘ä¼šè§‰å¾—è‡ªå·±æ˜¯ä¸æ˜¯è¿‡äºç†æƒ³ä¸»ä¹‰ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æ„¤ä¸–å«‰ä¿—ï¼Œä¸æ¥åœ°æ°”ï¼Œå°±ç®—æ˜¯å§ã€‚ä¸€ä¸ªäººæ€æƒ³çš„è½¬å˜ï¼Œè‚¯å®šä¹Ÿæ˜¯æœ‰åŸå› çš„ã€‚\né‚£å¹´æˆ‘è¿˜ä¸Šåˆä¸­ï¼Œå½“æ—¶å­¦æ ¡æ­£åœ¨ææ•°å­¦ç«èµ›å§ï¼Œæˆ‘å¯¹è¿™ç©æ„çœŸçš„ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œä¹Ÿæ²¡æœ‰è®¤çœŸå»å‡†å¤‡ï¼Œå­¦æ ¡ç»„ç»‡è€ƒè¯•çš„æ—¶å€™ä¹Ÿæ²¡æœ‰ç«äº‰è¿‡å…¶ä»–åŒå­¦ï¼Œä¹Ÿä¸å‡ºæˆ‘æ„å¤–ã€‚ä½†æ˜¯ï¼Œæˆ‘æ•°å­¦åº”è¯¥è¿˜æŒºå¥½çš„å§ï¼Œä¹Ÿæ¯”è¾ƒèªæ˜å§ï¼Œä½†æ˜¯æˆ‘å¯¹è¿™ç§æ— è„‘åœ°åšé¢˜ç«èµ›çœŸçš„ä¸æ„Ÿå…´è¶£ã€‚å½“æ—¶ï¼Œæˆ‘çš„æ•°å­¦è€å¸ˆæ‰¾åˆ°æˆ‘å¸Œæœ›æˆ‘ç»§ç»­å‚åŠ åç»­ç›¸å…³çš„åŸ¹è®­ã€ç«èµ›ï¼Œæˆ‘è¯´æˆ‘æ²¡é€šè¿‡ç­›é€‰ã€‚è€å¸ˆåŠæˆ‘è¯´ä¹‹å‰ä¹Ÿæœ‰åŒå­¦å¼€å§‹æˆç»©ä¸å¥½åé¢å–å¾—å¥½æˆç»©çš„ï¼Œè¿˜ç­”åº”è¯´ç»™æˆ‘äº‰å–ä¸€ä¸ªåé¢ï¼Œæ€ä¹ˆäº‰å–å‘¢ï¼Ÿå°±æ˜¯è®©ä¸€ä¸ªé€šè¿‡ç­›é€‰çš„å¥³åŒå­¦è®©ç»™æˆ‘ï¼Œé¢ï¼Œè¢«æˆ‘å©‰è¨€æ‹’ç»äº†â€¦â€¦\nè¿™åªæ˜¯å‘ç”Ÿåœ¨æˆ‘èº«ä¸Šçš„ä¸€ä¸ªè€å¸ˆç§è‡ªåšä¸»ã€è®©åº¦å­¦ç”Ÿåˆ©ç›Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œä¸ºäº†â€œå‡ºæˆç»©â€ï¼Œè€å¸ˆä¼¼ä¹å¹¶ä¸æ˜¯å¾ˆåœ¨ä¹ä¸ªåˆ«å­¦ç”Ÿçš„åˆ©ç›Šã€‚ç°åœ¨å·²ç»13å¹´è¿‡å»äº†ï¼Œæˆ‘ä¸æƒ³è¯„ä»·å½“å¹´è€å¸ˆçš„åšæ³•æœ‰å¤šä¹ˆä¸å¥½ï¼Œæˆ‘åªæ˜¯æƒ³æŒ‡å‡ºè¿™æ ·çš„æƒ…å†µå‘ç”Ÿåœ¨å­¦ç”Ÿèº«ä¸Šï¼Œæ˜¯æœ‰å¤šä¹ˆåœ°è½»ææ·¡å†™ã€‚ä¸è¦è§‰å¾—è¿™æ˜¯ä¸ªå°äº‹ï¼Œâ€œåº¦â€ä¸¥é‡åˆ°ä¸€å®šç¨‹åº¦ï¼Œä¹Ÿå¯èƒ½ä¼šé…¿æˆåƒå—å®³äººè‹Ÿæ™¶ä¸€æ ·çš„æ¶æ€§äº‹ä»¶ï¼Œæœ¬å±äºä½ çš„æ•™è‚²ç»å†è¢«å·èµ°ï¼Œäººç”Ÿè¢«ä¹±æ¶‚ä¸€ç¬”ï¼Œä½ ä¼šä¸ä¼šæ„¤æ€’ï¼Ÿ\nä¸Šé«˜äºŒé‚£å¹´ï¼Œå¤§å®¶åº”è¯¥æœ‰ç›¸ä¼¼çš„ç»å†ï¼Œå°±æ˜¯ä¸Šåˆä¸Šå®Œç¬¬äºŒèŠ‚è¯¾æ˜¯è¦è·‘æ“çš„ã€‚ä¸Šåˆç¬¬ä¸‰èŠ‚è¯¾ï¼Œæˆ‘ä»¬ç­åˆšå¥½æ˜¯ä½“è‚²è¯¾ï¼Œæ‰€ä»¥è·‘å®Œæ“å°±ç›´æ¥å¸¦é˜Ÿåˆ°äº†æ“åœºã€‚æ“åœºé‡Œé¢æœ‰ä¸ªåŒå­¦ä»°é¢èººåœ¨åœ°ä¸Šï¼Œç©¿ç€ä¸€èº«è¿åŠ¨æœï¼Œè„¸è‰²è‹ç™½ï¼Œæ²¡æœ‰ä»»ä½•å–˜æ¯â€¦â€¦ä»–çš„æ—¶é—´åœæ­¢åœ¨äº†é‚£ä¸€å¤©ã€‚æ²¡æœ‰æ ¡åŒ»çš„æ€¥æ•‘ï¼Œå¤§å®¶éƒ½åœ¨ç­‰åŒ»é™¢çš„åŒ»ç”Ÿåˆ°æ¥ï¼ŒåŒ…æ‹¬å‘¨å›´å›´è§‚çš„å‡ åä½“è‚²è€å¸ˆã€‚è¿‡äº†15~20åˆ†é’Ÿå§ï¼ŒåŒ»ç”Ÿæ¥äº†ï¼Œåšäº†ä¸‹å¿ƒè‚ºæŒ‰å‹åï¼ŒåŒ»ç”Ÿè¯´ï¼Œæœ‰ç‚¹æ™šäº†å¯èƒ½ä¸è¡Œäº†ã€‚åŒ»ç”Ÿè®©æˆ‘ä»¬å‘¨å›´å‡ ååŒå­¦æŠŠè¿™ä½åŒå­¦æŠ¬ä¸Šæ•‘æŠ¤è½¦æƒ³å†æŠ¢æ•‘ä¸€ä¸‹â€¦â€¦\næˆ‘äº²æ‰‹å°†è¿™ååŒå­¦æŠ¬ä¸Šæ•‘æŠ¤è½¦ï¼Œä¹Ÿè¿˜è®°å¾—ä»–ç©¿ç€ä¸€èº«é»„è‰²çš„è¿åŠ¨æœï¼Œå·²ç»è®°ä¸æ¸…ä»–çš„è„¸ï¼Œæ¯”æˆ‘ä½ä¸€å±Šå§ã€‚æˆ‘ä¹Ÿä¸çŸ¥é“ä»–æ˜¯å› ä½•è€Œæ­»ï¼Œå­¦æ ¡è¦æ±‚å¸ˆç”Ÿç»Ÿä¸€å£å¾„â€œå…ˆå¤©æ€§å¿ƒè„ç—…â€ã€‚åé¢å¬è¯´æ˜¯å› ä¸ºåœ¨ç½‘å§é€šå®µï¼Œåé¢è·‘æ“æ—¶çŒæ­»ï¼Œè·Ÿè€å¸ˆè¯·å‡ä¸å‚åŠ è·‘æ“è€å¸ˆæ²¡åŒæ„ã€‚è¿™ä¸ªäº‹æƒ…å¾ˆéš¾è¯„ä»·ï¼Œä½œä¸ºä¸€åè€å¸ˆä¹Ÿå¾ˆéš¾é¢„è§è¿™æ ·çš„æƒ…å†µã€‚è‡³äºå­¦æ ¡ç»Ÿä¸€å£å¾„çš„åšæ³•ï¼Œæˆ‘ä¸€å¼€å§‹å¹¶æ²¡è¿‡å¤šæ€è€ƒï¼Œä½†æ˜¯å½“æˆ‘çœ‹åˆ°å»ä¸–å­¦ç”Ÿçš„çˆ¶æ¯è·ªåœ¨å­¦æ ¡é—¨å£ï¼Œå“­å–Šç€è¿˜æˆ‘å­©å­çš„æ—¶å€™ï¼Œæˆ‘å¼€å§‹æ…¢æ…¢äº§ç”Ÿäº†ä¸€äº›è´¨ç–‘ã€‚\nå¤§ä¸€é‚£å¹´ï¼Œç™¾åº¦é¦–é¡µæœ‰æ¡æ¶ˆæ¯ï¼Œæ˜¯å…³äºæˆ‘ä»¬é«˜ä¸­çš„ï¼Œâ€œé‚¹å¹³ä¸€ä¸­è°ˆè¯æ­»â€ã€‚äº‹æƒ…å¤§è‡´æ˜¯è¿™æ ·çš„ï¼Œä¸€åé«˜ä¸­ç”Ÿåœ¨è¯¾å¤–æ´»åŠ¨æ—¶è§‚çœ‹ç­ä¸»ä»»è€å¸ˆæ‰“ç¯®çƒï¼Œç­ä¸»ä»»ä¸€ä¸ªçƒæ²¡æŠ•è¿›ï¼Œè¿™ä¸ªçƒåœ¨å¾ˆå¤šæ‰“çƒçš„åŒå­¦æ¥çœ‹åº”è¯¥æ˜¯å¾ˆå®¹æ˜“è¿›çš„ä¸€ä¸ªçƒ,è¿™ååŒå­¦éšæ‰‹è¯´äº†å¥â€œè‡­æ‰‹â€ã€‚å…¶ç­ä¸»ä»»å¬åˆ°ååœ¨æ“åœºå½“ç€å¾ˆå¤šäººçš„é¢ç›´æ¥æ‰‡è€³å…‰æ•™è®­ï¼Œè¿˜ä¸è§£æ°”ï¼Œåˆåœ¨æ™šè‡ªä¹ æ—¶ï¼Œå°†è¯¥åŒå­¦å«åˆ°ååƒ»å¤„ç»§ç»­ä½“ç½šã€‚è¿™åç­ä¸»ä»»è¸¹äº†å­¦ç”Ÿä¸€è„šï¼ŒåŠ›æœ‰å¤šå¤§å°±ä¸è®¨è®ºäº†ï¼Œæ€»ä¹‹å­¦ç”Ÿå€’åœ°åå¤´éƒ¨ä¸¥é‡å—ä¼¤æ­»äº¡â€¦â€¦ä½†æ˜¯ï¼Œå­¦æ ¡è¿˜æ˜¯é‚£è€ä¸€å¥—åšæ³•ï¼Œå…ˆå¤©æ€§å¿ƒè„ç—…ã€‚å½“æˆ‘çœ‹åˆ°å¤šæ–¹çˆ†æ–™çš„æ¶ˆæ¯ä¹‹åï¼Œä¸€ä¸‹å­å°±è”æƒ³èµ·å½“å¹´é‚£ä½ä½æˆ‘ä¸€å±Šã€å†°å†·åœ°èººåœ¨åœ°ä¸Šã€æ²¡æœ‰æ–½åŠ ä»»ä½•æ€¥æ•‘æªæ–½ã€ä¹Ÿæ˜¯ä»¥â€œå…ˆå¤©æ€§å¿ƒè„ç—…â€è¢«äº†äº‹çš„åŒå­¦ï¼Œæˆ‘è§‰å¾—å­¦æ ¡æ˜¯ä¸æ˜¯åœ¨åšç¼ºå¾·äº‹äº†ï¼Ÿ\nè¿™æ¬¡ï¼Œæˆ‘é€‰æ‹©ç«™åœ¨å­¦ç”Ÿè¿™è¾¹ï¼Œç§¯æåœ°è·Ÿè¿›ç›¸å…³äº‹æ€çš„æŠ¥é“ï¼Œäº†è§£ç›¸å…³çš„ä¿¡æ¯å‘å±•ã€‚ä¸€å¼€å§‹æˆ‘å°±æ²¡æœ‰é€‰æ‹©ç»§ç»­ç›¸ä¿¡å­¦æ ¡ï¼Œæˆ–è€…è¯´ç»§ç»­ç›²ç›®åœ°ç›¸ä¿¡å­¦æ ¡ï¼Œè¿™äº›éƒ½æºäºæˆ‘æ­¤å‰çš„ç»å†åœ¨æˆ‘å†…å¿ƒæ·±å¤„åŸ‹ä¸‹çš„è´¨ç–‘ã€‚æˆ‘ä¸ç›¸ä¿¡ä¸€åèº«ä½“å¥åº·çš„å­¦ç”Ÿå…¼ç­é•¿ï¼Œä¼šçŠ¯ä»€ä¹ˆç½ªå¤§æ¶æçš„äº‹æƒ…ï¼Œä¹Ÿä¸ä¼šæ¥ä¸ªçªç„¶çŒæ­»ï¼Œæ›´ä¸ä¼šç›¸ä¿¡ä¸€ä¸ªèº«ä½“éƒ¨ä½ä¸¥é‡å—ä¼¤çš„åŒå­¦æ˜¯å› ä¸ºå…ˆå¤©æ€§å¿ƒè„ç—…ã€‚æˆ‘åªæœ‰ä¸€ç§æƒ³æ³•ï¼Œé‚£å°±æ˜¯è¿™åç­ä¸»ä»»è€å¸ˆã€å­¦æ ¡é¢†å¯¼ä»¬èƒŒåè¾¾æˆäº†æŸç§â€œé»˜å¥‘â€ï¼Œé€‰æ‹©ç»§ç»­åšä¸€æ¬¡ç¼ºå¾·äº‹ã€‚æœ€åéšç€å…³æ³¨åº¦çš„æé«˜ï¼Œé™†é™†ç»­ç»­åœ°æ¶ˆæ¯è¢«çˆ†æ–™å‡ºæ¥ï¼ŒåŒ»é™¢ã€è­¦å¯Ÿã€ç¤¾åŒºè®ºå›ã€æ–°é—»åª’ä½“ï¼Œæœ‰äº›è¢«é‡‘é’±åˆ©ç›Šæ”¶ä¹°ï¼Œæœ‰äº›é€‰æ‹©äº†è‰¯çŸ¥â€¦â€¦æœ€åï¼Œæ¶‰äº‹è€å¸ˆè‡ªé¦–äº†ï¼\né‚£äº›ä¸ºæ­»å»åŒå­¦äº‰å¤ºçœŸç›¸ã€å°Šä¸¥çš„åŒå­¦ä»¬ï¼Œæˆ‘è¿™è¾ˆå­éƒ½å¯¹ä»–ä»¬è¡¨ç¤ºæ•¬ä½©ï¼Œå¦‚æœæ²¡æœ‰ä»–ä»¬çš„è‰¯çŸ¥ã€ä¸å±ˆï¼Œè¿™åæ„å¤–å»ä¸–çš„åŒå­¦ä¹Ÿåªèƒ½æ˜¯ä½œä¸ºä¸€ç²’å°˜åŸƒæ·¹æ²¡åœ¨ä¸€æµªåˆä¸€æµªçš„è°è¨€ä¸­ã€‚\nç°åœ¨ï¼Œåº”è¯¥æœ‰å¾ˆå¤šäººèƒ½ç†è§£æˆ‘å†…å¿ƒæ·±å¤„çš„ä¸€äº›æ„¤ä¸–å«‰ä¿—ï¼Œæˆ–è€…å‚²æ…¢ï¼Œæˆ–è€…åè§äº†ï¼Œå¹¶éæˆ‘è§ä¸å¾—å’Œè°ç¤¾ä¼šå¥½ï¼Œå¹¶éæˆ‘ä¸çŸ¥ç†æƒ³ä¸ç°å®æœ‰å·®è·ï¼Œå¹¶éæˆ‘ä¸çŸ¥å‘å±•è¦å¾ªåºæ¸è¿›ã€‚åªæ˜¯ï¼Œæˆ‘ä¸å†æ„¿æ„è½»æ˜“è¯´å¦¥åï¼Œå°¤å…¶æ˜¯ä½ æ˜æ˜åšäº†æ‰60åˆ†ï¼Œå´å¤©å¤©å½ªç‚³åƒç§‹ã€å»¶è¿Ÿæˆ–æ‹’ç»æ”¹å˜çš„æ—¶å€™ï¼çˆ¶æ¯ç¦»å¼€ä¹‹åï¼Œä½ å°†ç›´é¢æ­»äº¡ï¼Œæˆ‘ä»¬äºŒä¸‰åæ¥å²çš„äººï¼Œå¾ˆå¤šäººå¯¹æ­»äº¡æ˜¯æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„Ÿå—çš„ï¼Œå¯èƒ½å¾ˆå¤šäººæ²¡æœ‰è§è¿‡åœ¨ç—…é­”é¢å‰ï¼Œä¸€ä¸ªå¥å£®çš„æˆå¹´äººæ˜¯å¦‚ä½•ä¸€æ­¥æ­¥èµ°å‘è¡°å¼±ç¦»å¼€ï¼Œå¤§è‡´ä¸Šä¹Ÿä¸çŸ¥é“ç”Ÿå‘½æœ‰å¤šè„†å¼±ï¼Œæˆ–è€…æœ‰å¤šåšéŸ§ã€‚\næˆ‘å…¶å®ä¸æƒ³ç»å†è¿™äº›ï¼Œä»–å¯¹æˆ‘æ¥è¯´æ˜¯æŒ«æŠ˜ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ·¬ç‚¼äº†æˆ‘ï¼Œæˆ‘ç”¨æˆ‘çš„ç”Ÿå‘½åšèµŒæ³¨ï¼Œæˆ‘æ°¸è¿œå‹åœ¨çœŸç›¸è¿™è¾¹ï¼ä¹Ÿå¸Œæœ›ï¼Œä¸­å›½çš„å¹´è½»äººä¸è¦æ€•äº‹ï¼Œè¦æ•¢äºè®²å‡ºè‡ªå·±çš„æƒ³æ³•ï¼Œç¤¾ä¼šå‘å±•ã€å›½å®¶æœªæ¥é çš„æ˜¯åˆ›æ–°ï¼Œå¦‚æœä½ ä»¬éƒ½ä¸æ•¢å‘å£°ï¼Œéš¾é“æˆ‘ä»¬è¦é 80ã€90å²çš„è€çˆ·çˆ·ä»¬å—ï¼Œè¿˜æ˜¯è¦å»åˆ¨ç¥–åŸæŠŠæ•¢è¯´çœŸè¯çš„äººåˆ¨å‡ºæ¥ï¼Ÿå½“ä¸€ä¸ªç¤¾ä¼šåªæœ‰ä¸€ç§å£°éŸ³çš„æ—¶å€™ï¼Œä¸è¢«ç†è§£çš„äººä¹Ÿå°±æˆäº†å¦ç±»ï¼Œåƒä»€ä¹ˆæ€è¾¨ã€åˆ›æ„ã€åˆ›é€ ï¼Œä¹Ÿå°±åŸºæœ¬ä¸æœªæ¥æ— ç¼˜äº†ã€‚ä»Šå¤©çš„ä½ ä»¬é€‰æ‹©é—­å˜´ï¼Œæ˜å¤©ä½ ä»¬çš„å­©å­å°±åªèƒ½æŠŠå˜´ç¼èµ·æ¥æ‰ä¼šå®‰å…¨äº†ï¼",content:"æœ€è¿‘è‹Ÿæ™¶è¢«å†’åé¡¶æ›¿ä¸Šå¤§å­¦çš„äº‹æƒ…ï¼Œæˆä¸ºç¤¾ä¼šå…³æ³¨ç„¦ç‚¹ï¼Œä½œä¸ºå±±ä¸œè€ä¹¡ï¼Œä¹Ÿå¿ä¸ä½å›æƒ³èµ·æ±‚å­¦æ—¶çš„ä¸€äº›ç»å†ï¼Œä¸€äº›ä»å†…å¿ƒé‡Œé¢ è¦†æˆ‘è®¤çŸ¥ã€æ”¹å˜æˆ‘çœ‹æ³•çš„ç»å†ã€‚æœ‰æ—¶ï¼Œæˆ‘ä¼šè§‰å¾—è‡ªå·±æ˜¯ä¸æ˜¯è¿‡äºç†æƒ³ä¸»ä¹‰ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹æ„¤ä¸–å«‰ä¿—ï¼Œä¸æ¥åœ°æ°”ï¼Œå°±ç®—æ˜¯å§ã€‚ä¸€ä¸ªäººæ€æƒ³çš„è½¬å˜ï¼Œè‚¯å®šä¹Ÿæ˜¯æœ‰åŸå› çš„ã€‚\né‚£å¹´æˆ‘è¿˜ä¸Šåˆä¸­ï¼Œå½“æ—¶å­¦æ ¡æ­£åœ¨ææ•°å­¦ç«èµ›å§ï¼Œæˆ‘å¯¹è¿™ç©æ„çœŸçš„ä¸æ˜¯å¾ˆæ„Ÿå…´è¶£ï¼Œä¹Ÿæ²¡æœ‰è®¤çœŸå»å‡†å¤‡ï¼Œå­¦æ ¡ç»„ç»‡è€ƒè¯•çš„æ—¶å€™ä¹Ÿæ²¡æœ‰ç«äº‰è¿‡å…¶ä»–åŒå­¦ï¼Œä¹Ÿä¸å‡ºæˆ‘æ„å¤–ã€‚ä½†æ˜¯ï¼Œæˆ‘æ•°å­¦åº”è¯¥è¿˜æŒºå¥½çš„å§ï¼Œä¹Ÿæ¯”è¾ƒèªæ˜å§ï¼Œä½†æ˜¯æˆ‘å¯¹è¿™ç§æ— è„‘åœ°åšé¢˜ç«èµ›çœŸçš„ä¸æ„Ÿå…´è¶£ã€‚å½“æ—¶ï¼Œæˆ‘çš„æ•°å­¦è€å¸ˆæ‰¾åˆ°æˆ‘å¸Œæœ›æˆ‘ç»§ç»­å‚åŠ åç»­ç›¸å…³çš„åŸ¹è®­ã€ç«èµ›ï¼Œæˆ‘è¯´æˆ‘æ²¡é€šè¿‡ç­›é€‰ã€‚è€å¸ˆåŠæˆ‘è¯´ä¹‹å‰ä¹Ÿæœ‰åŒå­¦å¼€å§‹æˆç»©ä¸å¥½åé¢å–å¾—å¥½æˆç»©çš„ï¼Œè¿˜ç­”åº”è¯´ç»™æˆ‘äº‰å–ä¸€ä¸ªåé¢ï¼Œæ€ä¹ˆäº‰å–å‘¢ï¼Ÿå°±æ˜¯è®©ä¸€ä¸ªé€šè¿‡ç­›é€‰çš„å¥³åŒå­¦è®©ç»™æˆ‘ï¼Œé¢ï¼Œè¢«æˆ‘å©‰è¨€æ‹’ç»äº†â€¦â€¦\nè¿™åªæ˜¯å‘ç”Ÿåœ¨æˆ‘èº«ä¸Šçš„ä¸€ä¸ªè€å¸ˆç§è‡ªåšä¸»ã€è®©åº¦å­¦ç”Ÿåˆ©ç›Šçš„ä¸€ä¸ªæ¡ˆä¾‹ï¼Œä¸ºäº†â€œå‡ºæˆç»©â€ï¼Œè€å¸ˆä¼¼ä¹å¹¶ä¸æ˜¯å¾ˆåœ¨ä¹ä¸ªåˆ«å­¦ç”Ÿçš„åˆ©ç›Šã€‚ç°åœ¨å·²ç»13å¹´è¿‡å»äº†ï¼Œæˆ‘ä¸æƒ³è¯„ä»·å½“å¹´è€å¸ˆçš„åšæ³•æœ‰å¤šä¹ˆä¸å¥½ï¼Œæˆ‘åªæ˜¯æƒ³æŒ‡å‡ºè¿™æ ·çš„æƒ…å†µå‘ç”Ÿåœ¨å­¦ç”Ÿèº«ä¸Šï¼Œæ˜¯æœ‰å¤šä¹ˆåœ°è½»ææ·¡å†™ã€‚ä¸è¦è§‰å¾—è¿™æ˜¯ä¸ªå°äº‹ï¼Œâ€œåº¦â€ä¸¥é‡åˆ°ä¸€å®šç¨‹åº¦ï¼Œä¹Ÿå¯èƒ½ä¼šé…¿æˆåƒå—å®³äººè‹Ÿæ™¶ä¸€æ ·çš„æ¶æ€§äº‹ä»¶ï¼Œæœ¬å±äºä½ çš„æ•™è‚²ç»å†è¢«å·èµ°ï¼Œäººç”Ÿè¢«ä¹±æ¶‚ä¸€ç¬”ï¼Œä½ ä¼šä¸ä¼šæ„¤æ€’ï¼Ÿ\nä¸Šé«˜äºŒé‚£å¹´ï¼Œå¤§å®¶åº”è¯¥æœ‰ç›¸ä¼¼çš„ç»å†ï¼Œå°±æ˜¯ä¸Šåˆä¸Šå®Œç¬¬äºŒèŠ‚è¯¾æ˜¯è¦è·‘æ“çš„ã€‚ä¸Šåˆç¬¬ä¸‰èŠ‚è¯¾ï¼Œæˆ‘ä»¬ç­åˆšå¥½æ˜¯ä½“è‚²è¯¾ï¼Œæ‰€ä»¥è·‘å®Œæ“å°±ç›´æ¥å¸¦é˜Ÿåˆ°äº†æ“åœºã€‚æ“åœºé‡Œé¢æœ‰ä¸ªåŒå­¦ä»°é¢èººåœ¨åœ°ä¸Šï¼Œç©¿ç€ä¸€èº«è¿åŠ¨æœï¼Œè„¸è‰²è‹ç™½ï¼Œæ²¡æœ‰ä»»ä½•å–˜æ¯â€¦â€¦ä»–çš„æ—¶é—´åœæ­¢åœ¨äº†é‚£ä¸€å¤©ã€‚æ²¡æœ‰æ ¡åŒ»çš„æ€¥æ•‘ï¼Œå¤§å®¶éƒ½åœ¨ç­‰åŒ»é™¢çš„åŒ»ç”Ÿåˆ°æ¥ï¼ŒåŒ…æ‹¬å‘¨å›´å›´è§‚çš„å‡ åä½“è‚²è€å¸ˆã€‚è¿‡äº†15~20åˆ†é’Ÿå§ï¼ŒåŒ»ç”Ÿæ¥äº†ï¼Œåšäº†ä¸‹å¿ƒè‚ºæŒ‰å‹åï¼ŒåŒ»ç”Ÿè¯´ï¼Œæœ‰ç‚¹æ™šäº†å¯èƒ½ä¸è¡Œäº†ã€‚åŒ»ç”Ÿè®©æˆ‘ä»¬å‘¨å›´å‡ ååŒå­¦æŠŠè¿™ä½åŒå­¦æŠ¬ä¸Šæ•‘æŠ¤è½¦æƒ³å†æŠ¢æ•‘ä¸€ä¸‹â€¦â€¦\næˆ‘äº²æ‰‹å°†è¿™ååŒå­¦æŠ¬ä¸Šæ•‘æŠ¤è½¦ï¼Œä¹Ÿè¿˜è®°å¾—ä»–ç©¿ç€ä¸€èº«é»„è‰²çš„è¿åŠ¨æœï¼Œå·²ç»è®°ä¸æ¸…ä»–çš„è„¸ï¼Œæ¯”æˆ‘ä½ä¸€å±Šå§ã€‚æˆ‘ä¹Ÿä¸çŸ¥é“ä»–æ˜¯å› ä½•è€Œæ­»ï¼Œå­¦æ ¡è¦æ±‚å¸ˆç”Ÿç»Ÿä¸€å£å¾„â€œå…ˆå¤©æ€§å¿ƒè„ç—…â€ã€‚åé¢å¬è¯´æ˜¯å› ä¸ºåœ¨ç½‘å§é€šå®µï¼Œåé¢è·‘æ“æ—¶çŒæ­»ï¼Œè·Ÿè€å¸ˆè¯·å‡ä¸å‚åŠ è·‘æ“è€å¸ˆæ²¡åŒæ„ã€‚è¿™ä¸ªäº‹æƒ…å¾ˆéš¾è¯„ä»·ï¼Œä½œä¸ºä¸€åè€å¸ˆä¹Ÿå¾ˆéš¾é¢„è§è¿™æ ·çš„æƒ…å†µã€‚è‡³äºå­¦æ ¡ç»Ÿä¸€å£å¾„çš„åšæ³•ï¼Œæˆ‘ä¸€å¼€å§‹å¹¶æ²¡è¿‡å¤šæ€è€ƒï¼Œä½†æ˜¯å½“æˆ‘çœ‹åˆ°å»ä¸–å­¦ç”Ÿçš„çˆ¶æ¯è·ªåœ¨å­¦æ ¡é—¨å£ï¼Œå“­å–Šç€è¿˜æˆ‘å­©å­çš„æ—¶å€™ï¼Œæˆ‘å¼€å§‹æ…¢æ…¢äº§ç”Ÿäº†ä¸€äº›è´¨ç–‘ã€‚\nå¤§ä¸€é‚£å¹´ï¼Œç™¾åº¦é¦–é¡µæœ‰æ¡æ¶ˆæ¯ï¼Œæ˜¯å…³äºæˆ‘ä»¬é«˜ä¸­çš„ï¼Œâ€œé‚¹å¹³ä¸€ä¸­è°ˆè¯æ­»â€ã€‚äº‹æƒ…å¤§è‡´æ˜¯è¿™æ ·çš„ï¼Œä¸€åé«˜ä¸­ç”Ÿåœ¨è¯¾å¤–æ´»åŠ¨æ—¶è§‚çœ‹ç­ä¸»ä»»è€å¸ˆæ‰“ç¯®çƒï¼Œç­ä¸»ä»»ä¸€ä¸ªçƒæ²¡æŠ•è¿›ï¼Œè¿™ä¸ªçƒåœ¨å¾ˆå¤šæ‰“çƒçš„åŒå­¦æ¥çœ‹åº”è¯¥æ˜¯å¾ˆå®¹æ˜“è¿›çš„ä¸€ä¸ªçƒ,è¿™ååŒå­¦éšæ‰‹è¯´äº†å¥â€œè‡­æ‰‹â€ã€‚å…¶ç­ä¸»ä»»å¬åˆ°ååœ¨æ“åœºå½“ç€å¾ˆå¤šäººçš„é¢ç›´æ¥æ‰‡è€³å…‰æ•™è®­ï¼Œè¿˜ä¸è§£æ°”ï¼Œåˆåœ¨æ™šè‡ªä¹ æ—¶ï¼Œå°†è¯¥åŒå­¦å«åˆ°ååƒ»å¤„ç»§ç»­ä½“ç½šã€‚è¿™åç­ä¸»ä»»è¸¹äº†å­¦ç”Ÿä¸€è„šï¼ŒåŠ›æœ‰å¤šå¤§å°±ä¸è®¨è®ºäº†ï¼Œæ€»ä¹‹å­¦ç”Ÿå€’åœ°åå¤´éƒ¨ä¸¥é‡å—ä¼¤æ­»äº¡â€¦â€¦ä½†æ˜¯ï¼Œå­¦æ ¡è¿˜æ˜¯é‚£è€ä¸€å¥—åšæ³•ï¼Œå…ˆå¤©æ€§å¿ƒè„ç—…ã€‚å½“æˆ‘çœ‹åˆ°å¤šæ–¹çˆ†æ–™çš„æ¶ˆæ¯ä¹‹åï¼Œä¸€ä¸‹å­å°±è”æƒ³èµ·å½“å¹´é‚£ä½ä½æˆ‘ä¸€å±Šã€å†°å†·åœ°èººåœ¨åœ°ä¸Šã€æ²¡æœ‰æ–½åŠ ä»»ä½•æ€¥æ•‘æªæ–½ã€ä¹Ÿæ˜¯ä»¥â€œå…ˆå¤©æ€§å¿ƒè„ç—…â€è¢«äº†äº‹çš„åŒå­¦ï¼Œæˆ‘è§‰å¾—å­¦æ ¡æ˜¯ä¸æ˜¯åœ¨åšç¼ºå¾·äº‹äº†ï¼Ÿ\nè¿™æ¬¡ï¼Œæˆ‘é€‰æ‹©ç«™åœ¨å­¦ç”Ÿè¿™è¾¹ï¼Œç§¯æåœ°è·Ÿè¿›ç›¸å…³äº‹æ€çš„æŠ¥é“ï¼Œäº†è§£ç›¸å…³çš„ä¿¡æ¯å‘å±•ã€‚ä¸€å¼€å§‹æˆ‘å°±æ²¡æœ‰é€‰æ‹©ç»§ç»­ç›¸ä¿¡å­¦æ ¡ï¼Œæˆ–è€…è¯´ç»§ç»­ç›²ç›®åœ°ç›¸ä¿¡å­¦æ ¡ï¼Œè¿™äº›éƒ½æºäºæˆ‘æ­¤å‰çš„ç»å†åœ¨æˆ‘å†…å¿ƒæ·±å¤„åŸ‹ä¸‹çš„è´¨ç–‘ã€‚æˆ‘ä¸ç›¸ä¿¡ä¸€åèº«ä½“å¥åº·çš„å­¦ç”Ÿå…¼ç­é•¿ï¼Œä¼šçŠ¯ä»€ä¹ˆç½ªå¤§æ¶æçš„äº‹æƒ…ï¼Œä¹Ÿä¸ä¼šæ¥ä¸ªçªç„¶çŒæ­»ï¼Œæ›´ä¸ä¼šç›¸ä¿¡ä¸€ä¸ªèº«ä½“éƒ¨ä½ä¸¥é‡å—ä¼¤çš„åŒå­¦æ˜¯å› ä¸ºå…ˆå¤©æ€§å¿ƒè„ç—…ã€‚æˆ‘åªæœ‰ä¸€ç§æƒ³æ³•ï¼Œé‚£å°±æ˜¯è¿™åç­ä¸»ä»»è€å¸ˆã€å­¦æ ¡é¢†å¯¼ä»¬èƒŒåè¾¾æˆäº†æŸç§â€œé»˜å¥‘â€ï¼Œé€‰æ‹©ç»§ç»­åšä¸€æ¬¡ç¼ºå¾·äº‹ã€‚æœ€åéšç€å…³æ³¨åº¦çš„æé«˜ï¼Œé™†é™†ç»­ç»­åœ°æ¶ˆæ¯è¢«çˆ†æ–™å‡ºæ¥ï¼ŒåŒ»é™¢ã€è­¦å¯Ÿã€ç¤¾åŒºè®ºå›ã€æ–°é—»åª’ä½“ï¼Œæœ‰äº›è¢«é‡‘é’±åˆ©ç›Šæ”¶ä¹°ï¼Œæœ‰äº›é€‰æ‹©äº†è‰¯çŸ¥â€¦â€¦æœ€åï¼Œæ¶‰äº‹è€å¸ˆè‡ªé¦–äº†ï¼\né‚£äº›ä¸ºæ­»å»åŒå­¦äº‰å¤ºçœŸç›¸ã€å°Šä¸¥çš„åŒå­¦ä»¬ï¼Œæˆ‘è¿™è¾ˆå­éƒ½å¯¹ä»–ä»¬è¡¨ç¤ºæ•¬ä½©ï¼Œå¦‚æœæ²¡æœ‰ä»–ä»¬çš„è‰¯çŸ¥ã€ä¸å±ˆï¼Œè¿™åæ„å¤–å»ä¸–çš„åŒå­¦ä¹Ÿåªèƒ½æ˜¯ä½œä¸ºä¸€ç²’å°˜åŸƒæ·¹æ²¡åœ¨ä¸€æµªåˆä¸€æµªçš„è°è¨€ä¸­ã€‚\nç°åœ¨ï¼Œåº”è¯¥æœ‰å¾ˆå¤šäººèƒ½ç†è§£æˆ‘å†…å¿ƒæ·±å¤„çš„ä¸€äº›æ„¤ä¸–å«‰ä¿—ï¼Œæˆ–è€…å‚²æ…¢ï¼Œæˆ–è€…åè§äº†ï¼Œå¹¶éæˆ‘è§ä¸å¾—å’Œè°ç¤¾ä¼šå¥½ï¼Œå¹¶éæˆ‘ä¸çŸ¥ç†æƒ³ä¸ç°å®æœ‰å·®è·ï¼Œå¹¶éæˆ‘ä¸çŸ¥å‘å±•è¦å¾ªåºæ¸è¿›ã€‚åªæ˜¯ï¼Œæˆ‘ä¸å†æ„¿æ„è½»æ˜“è¯´å¦¥åï¼Œå°¤å…¶æ˜¯ä½ æ˜æ˜åšäº†æ‰60åˆ†ï¼Œå´å¤©å¤©å½ªç‚³åƒç§‹ã€å»¶è¿Ÿæˆ–æ‹’ç»æ”¹å˜çš„æ—¶å€™ï¼çˆ¶æ¯ç¦»å¼€ä¹‹åï¼Œä½ å°†ç›´é¢æ­»äº¡ï¼Œæˆ‘ä»¬äºŒä¸‰åæ¥å²çš„äººï¼Œå¾ˆå¤šäººå¯¹æ­»äº¡æ˜¯æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„æ„Ÿå—çš„ï¼Œå¯èƒ½å¾ˆå¤šäººæ²¡æœ‰è§è¿‡åœ¨ç—…é­”é¢å‰ï¼Œä¸€ä¸ªå¥å£®çš„æˆå¹´äººæ˜¯å¦‚ä½•ä¸€æ­¥æ­¥èµ°å‘è¡°å¼±ç¦»å¼€ï¼Œå¤§è‡´ä¸Šä¹Ÿä¸çŸ¥é“ç”Ÿå‘½æœ‰å¤šè„†å¼±ï¼Œæˆ–è€…æœ‰å¤šåšéŸ§ã€‚\næˆ‘å…¶å®ä¸æƒ³ç»å†è¿™äº›ï¼Œä»–å¯¹æˆ‘æ¥è¯´æ˜¯æŒ«æŠ˜ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ·¬ç‚¼äº†æˆ‘ï¼Œæˆ‘ç”¨æˆ‘çš„ç”Ÿå‘½åšèµŒæ³¨ï¼Œæˆ‘æ°¸è¿œå‹åœ¨çœŸç›¸è¿™è¾¹ï¼ä¹Ÿå¸Œæœ›ï¼Œä¸­å›½çš„å¹´è½»äººä¸è¦æ€•äº‹ï¼Œè¦æ•¢äºè®²å‡ºè‡ªå·±çš„æƒ³æ³•ï¼Œç¤¾ä¼šå‘å±•ã€å›½å®¶æœªæ¥é çš„æ˜¯åˆ›æ–°ï¼Œå¦‚æœä½ ä»¬éƒ½ä¸æ•¢å‘å£°ï¼Œéš¾é“æˆ‘ä»¬è¦é 80ã€90å²çš„è€çˆ·çˆ·ä»¬å—ï¼Œè¿˜æ˜¯è¦å»åˆ¨ç¥–åŸæŠŠæ•¢è¯´çœŸè¯çš„äººåˆ¨å‡ºæ¥ï¼Ÿå½“ä¸€ä¸ªç¤¾ä¼šåªæœ‰ä¸€ç§å£°éŸ³çš„æ—¶å€™ï¼Œä¸è¢«ç†è§£çš„äººä¹Ÿå°±æˆäº†å¦ç±»ï¼Œåƒä»€ä¹ˆæ€è¾¨ã€åˆ›æ„ã€åˆ›é€ ï¼Œä¹Ÿå°±åŸºæœ¬ä¸æœªæ¥æ— ç¼˜äº†ã€‚ä»Šå¤©çš„ä½ ä»¬é€‰æ‹©é—­å˜´ï¼Œæ˜å¤©ä½ ä»¬çš„å­©å­å°±åªèƒ½æŠŠå˜´ç¼èµ·æ¥æ‰ä¼šå®‰å…¨äº†ï¼\n"}),a.add({id:277,href:"/tags/%E4%BA%BA%E6%80%A7/",title:"äººæ€§",description:"",content:""}),a.add({id:278,href:"/tags/%E6%96%87%E6%98%8E/",title:"æ–‡æ˜",description:"",content:""}),a.add({id:279,href:"/tags/%E6%AD%A3%E7%9B%B4/",title:"æ­£ç›´",description:"",content:""}),a.add({id:280,href:"/tags/cmd/",title:"cmd",description:"",content:""}),a.add({id:281,href:"/tags/cobra/",title:"cobra",description:"",content:""}),a.add({id:282,href:"/tags/flag/",title:"flag",description:"",content:""}),a.add({id:283,href:"/tags/flagset/",title:"flagset",description:"",content:""}),a.add({id:284,href:"/blog/2020-06-26-%E5%A6%82%E4%BD%95%E9%AB%98%E6%95%88%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7/",title:"å¦‚ä½•é«˜æ•ˆå¼€å‘ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·",description:"æˆ‘ç»å¸¸ä¼šå¼€å‘ä¸€äº›å‘½ä»¤è¡Œå·¥å…·æ¥ååŠ©å¤„ç†ä¸€äº›äº‹æƒ…ï¼Œå¦‚å¼€å‘ä¸€ä¸ªä»£ç ç”Ÿæˆå·¥å…·å¿«é€Ÿç”ŸæˆæœåŠ¡ä»£ç ï¼Œæˆ–è€…å¼€å‘ä¸€ä¸ªå·¥å…·æ¥æ–¹ä¾¿ç®¡ç†githubä¸Šçš„å·¥å…·ï¼Œæˆ–è€…å¼€å‘ä¸€ä¸ªå·¥å…·rmæ¥æ›¿æ¢æ‰ä¸å®‰å…¨çš„rmï¼Œç­‰ç­‰ã€‚\nå‘½ä»¤è¡Œå·¥å…·å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯¹åŠŸèƒ½è¿›è¡Œåˆ†ç»„ï¼Œå¼€å‘å¤šä¸ªå‘½ä»¤ä¸åˆ©äºä½¿ç”¨ï¼Œåœ¨å‘½ä»¤ä¸­æ”¯æŒå­å‘½ä»¤æ˜¯ä¸€ä¸ªæ›´å¸¸è§ã€æ›´å‹å¥½çš„åšæ³•ï¼Œå¦‚go buildï¼Œgo toolï¼Œgo pprofï¼Œç­‰ç­‰ã€‚æˆ‘ä»¬è¿˜å¸Œæœ›ä¸ºä¸åŒçš„å­å‘½ä»¤æ·»åŠ ä¸åŒçš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œå¦‚go build -gcflags=ï¼Œgo pprof --seconds=ï¼Œç­‰ç­‰ã€‚\nå¦‚ä½•æ”¯æŒå­å‘½ä»¤å­—å‘¢ï¼Ÿ # å‡å¦‚æˆ‘ä»¬å¼€å‘ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åº goxï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªå­å‘½ä»¤gox createæ¥åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æœåŠ¡å·¥ç¨‹ï¼ŒåŒ…æ‹¬è‡ªåŠ¨ç”Ÿæˆå·¥ç¨‹ä¸‹çš„ä»£ç ã€‚\né‚£å¦‚ä½•ä¸ºå‘½ä»¤è¡Œç¨‹åºgoxæ·»åŠ è¿™ä¸ªå­å‘½ä»¤å­—å‘¢ï¼Ÿ\ngoxæ˜¯shellæœç´¢è·¯å¾„å®šä½åˆ°çš„ç¨‹åºï¼Œcreateåªèƒ½æ˜¯shellä¼ é€’ç»™è¿›ç¨‹çš„ä¸€ä¸ªæ™®é€šå‚æ•°ï¼Œåœ¨goxç¨‹åºå¯åŠ¨ä¹‹ååªèƒ½ä»os.Argsæ¥è·å–è¯¥å‚æ•°ï¼Œä»¥åŠåç»­gox create -protofile= -protodirçš„å‚æ•°-protofileåŠ-protodirã€‚\nç„¶åå‘¢ï¼Œä¸ºäº†æ–¹ä¾¿ä»¥åæ‰©å±•å…¶ä»–å­å‘½ä»¤ï¼Œæˆ‘ä»¬æœ€å¥½å°†subcmdè¿›è¡Œä¸€ä¸‹æŠ½è±¡ï¼Œé€šè¿‡ä¸€ä¸ªCommand interface{}çº¦å®šå¥½ä¸€ä¸ªsubcmdå¿…é¡»è¦å®Œæˆé‚£äº›æ“ä½œã€‚æ¥å£å¹¶ä¸æ˜¯ä¸ºäº†æŠ½è±¡è€ŒæŠ½è±¡ï¼Œè€Œæ˜¯ç”¨æ¥æ¸…æ™°åœ°è¡¨æ˜è¦åšä»€ä¹ˆã€‚\n// Command what does a command do type Command interface{ // PreRun run before the command logic execution PreRun() error // Run run the command logic Run() error // PostRun run after the command logic execution PostRun() error } // BaseCommand basic implemention // // this BaseCommand could be embeded into a customized subcmd type BaseCommand struct{ } func (bc *BaseCommand) PreRun() error { return nil } func (bc *BaseCommand) Run() error { panic(\u0026quot;implement me\u0026quot;) } func (bc *BaseCommand) PostRun() error { return nil }  Commandæ¥å£å®šä¹‰äº†ä¸€ä¸ªcommandåº”è¯¥å¹²ä»€ä¹ˆï¼Œç„¶åä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªåŸºæœ¬çš„Commandå®ç°BaseCommandï¼Œå®ƒæä¾›äº†ä¸€äº›åŸºæœ¬çš„æ“ä½œå¯ä»¥ä¾›åç»­å¤ç”¨ï¼Œåé¢æˆ‘ä»¬è¦æ‰©å±•å…¶ä»–å­å‘½ä»¤å­—çš„æ—¶å€™ï¼Œé€šè¿‡å°†è¯¥BaseCommandåµŒå…¥ï¼Œå¯ä»¥å°‘å®ç°å‡ ä¸ªå‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯goé‡Œé¢æå€¡çš„é€šè¿‡ç»„åˆæ¥å®ç°ç»§æ‰¿ã€‚",content:"æˆ‘ç»å¸¸ä¼šå¼€å‘ä¸€äº›å‘½ä»¤è¡Œå·¥å…·æ¥ååŠ©å¤„ç†ä¸€äº›äº‹æƒ…ï¼Œå¦‚å¼€å‘ä¸€ä¸ªä»£ç ç”Ÿæˆå·¥å…·å¿«é€Ÿç”ŸæˆæœåŠ¡ä»£ç ï¼Œæˆ–è€…å¼€å‘ä¸€ä¸ªå·¥å…·æ¥æ–¹ä¾¿ç®¡ç†githubä¸Šçš„å·¥å…·ï¼Œæˆ–è€…å¼€å‘ä¸€ä¸ªå·¥å…·rmæ¥æ›¿æ¢æ‰ä¸å®‰å…¨çš„rmï¼Œç­‰ç­‰ã€‚\nå‘½ä»¤è¡Œå·¥å…·å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯¹åŠŸèƒ½è¿›è¡Œåˆ†ç»„ï¼Œå¼€å‘å¤šä¸ªå‘½ä»¤ä¸åˆ©äºä½¿ç”¨ï¼Œåœ¨å‘½ä»¤ä¸­æ”¯æŒå­å‘½ä»¤æ˜¯ä¸€ä¸ªæ›´å¸¸è§ã€æ›´å‹å¥½çš„åšæ³•ï¼Œå¦‚go buildï¼Œgo toolï¼Œgo pprofï¼Œç­‰ç­‰ã€‚æˆ‘ä»¬è¿˜å¸Œæœ›ä¸ºä¸åŒçš„å­å‘½ä»¤æ·»åŠ ä¸åŒçš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œå¦‚go build -gcflags=ï¼Œgo pprof --seconds=ï¼Œç­‰ç­‰ã€‚\nå¦‚ä½•æ”¯æŒå­å‘½ä»¤å­—å‘¢ï¼Ÿ # å‡å¦‚æˆ‘ä»¬å¼€å‘ä¸€ä¸ªå‘½ä»¤è¡Œç¨‹åº goxï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªå­å‘½ä»¤gox createæ¥åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„æœåŠ¡å·¥ç¨‹ï¼ŒåŒ…æ‹¬è‡ªåŠ¨ç”Ÿæˆå·¥ç¨‹ä¸‹çš„ä»£ç ã€‚\né‚£å¦‚ä½•ä¸ºå‘½ä»¤è¡Œç¨‹åºgoxæ·»åŠ è¿™ä¸ªå­å‘½ä»¤å­—å‘¢ï¼Ÿ\ngoxæ˜¯shellæœç´¢è·¯å¾„å®šä½åˆ°çš„ç¨‹åºï¼Œcreateåªèƒ½æ˜¯shellä¼ é€’ç»™è¿›ç¨‹çš„ä¸€ä¸ªæ™®é€šå‚æ•°ï¼Œåœ¨goxç¨‹åºå¯åŠ¨ä¹‹ååªèƒ½ä»os.Argsæ¥è·å–è¯¥å‚æ•°ï¼Œä»¥åŠåç»­gox create -protofile= -protodirçš„å‚æ•°-protofileåŠ-protodirã€‚\nç„¶åå‘¢ï¼Œä¸ºäº†æ–¹ä¾¿ä»¥åæ‰©å±•å…¶ä»–å­å‘½ä»¤ï¼Œæˆ‘ä»¬æœ€å¥½å°†subcmdè¿›è¡Œä¸€ä¸‹æŠ½è±¡ï¼Œé€šè¿‡ä¸€ä¸ªCommand interface{}çº¦å®šå¥½ä¸€ä¸ªsubcmdå¿…é¡»è¦å®Œæˆé‚£äº›æ“ä½œã€‚æ¥å£å¹¶ä¸æ˜¯ä¸ºäº†æŠ½è±¡è€ŒæŠ½è±¡ï¼Œè€Œæ˜¯ç”¨æ¥æ¸…æ™°åœ°è¡¨æ˜è¦åšä»€ä¹ˆã€‚\n// Command what does a command do type Command interface{ // PreRun run before the command logic execution PreRun() error // Run run the command logic Run() error // PostRun run after the command logic execution PostRun() error } // BaseCommand basic implemention // // this BaseCommand could be embeded into a customized subcmd type BaseCommand struct{ } func (bc *BaseCommand) PreRun() error { return nil } func (bc *BaseCommand) Run() error { panic(\u0026quot;implement me\u0026quot;) } func (bc *BaseCommand) PostRun() error { return nil }  Commandæ¥å£å®šä¹‰äº†ä¸€ä¸ªcommandåº”è¯¥å¹²ä»€ä¹ˆï¼Œç„¶åä¹Ÿå¯ä»¥æä¾›ä¸€ä¸ªåŸºæœ¬çš„Commandå®ç°BaseCommandï¼Œå®ƒæä¾›äº†ä¸€äº›åŸºæœ¬çš„æ“ä½œå¯ä»¥ä¾›åç»­å¤ç”¨ï¼Œåé¢æˆ‘ä»¬è¦æ‰©å±•å…¶ä»–å­å‘½ä»¤å­—çš„æ—¶å€™ï¼Œé€šè¿‡å°†è¯¥BaseCommandåµŒå…¥ï¼Œå¯ä»¥å°‘å®ç°å‡ ä¸ªå‡½æ•°ï¼Œè¿™ä¹Ÿæ˜¯goé‡Œé¢æå€¡çš„é€šè¿‡ç»„åˆæ¥å®ç°ç»§æ‰¿ã€‚\nç°åœ¨æˆ‘ä»¬å®ç°ä¸€ä¸ªCreateCmdï¼š\ntype CreateCmd struct { *BaseCommand } func NewCreateCmd() Command { return \u0026amp;CreateCmd{ \u0026amp;BaseCommand{}, } } func (c *CreateCmd) Run() error { println(\u0026quot;create cmd running\u0026quot;) // execute the logic of create cmd println(\u0026quot;create cmd finished\u0026quot;) }  é‚£æˆ‘ä»¬æ€ä¹ˆåœ¨æ‰§è¡Œgox createçš„æ—¶å€™è¿è¡ŒCreateCmd.Run()æ–¹æ³•å‘¢ï¼Ÿ\nvar cmds map[string]Command = { \u0026quot;create\u0026quot;: NewCreateCmd, } func main() { args := os.Args[1:] if len(args) == 0 { panic(\u0026quot;invalid subcmd\u0026quot;) } cmd, ok := cmds[args[0]] if !ok { panic(fmt.Errorf(\u0026quot;cmd: %s not registered\u0026quot;, args[0])) } if err := cmd.PreRun(); err != nil { panic(err) } if err := cmd.Run(); err != nil { panic(err) } if err := cmd.PostRun(); err != nil { panic(err) } }  æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿæœ¬æ¥å°±å¾ˆç®€å• :)\nå¦‚ä½•ä¸ºå­å‘½ä»¤å­—æ·»åŠ ä¸åŒçš„é€‰é¡¹å‘¢ï¼Ÿ # é‚£ç°åœ¨è¦ç»™å„ä¸ªå­å‘½ä»¤å­—æ·»åŠ ç‹¬ç«‹çš„å‘½ä»¤è¡Œé€‰é¡¹æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚gox createçš„å‘½ä»¤å‚æ•°å’Œgox updateçš„å‘½ä»¤è¡Œå‚æ•°æ˜¯ä¸åŒçš„ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿä½ å½“ç„¶å¯ä»¥æ ¹æ®os.Args[1:]æ¥è§£æï¼Œæƒ³æ€ä¹ˆè§£æéƒ½å¯ä»¥ï¼Œæˆ‘ä»¬è¿™é‡Œè®¨è®ºå¦‚ä½•å€ŸåŠ©goæ ‡å‡†åº“æä¾›çš„flagåŒ…æ¥è§£æã€‚\nå¤§å®¶å¯èƒ½éƒ½ä½¿ç”¨è¿‡flag.Parse()æ¥è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®æ˜¯å°†os.Args[1:]ä¸­çš„å‚æ•°è§£æå®Œåå¡«å……åˆ°ä¸€ä¸ªé»˜è®¤çš„flagsetã€‚å¦‚æœè¦ä¸ºä¸åŒçš„å­å‘½ä»¤æ·»åŠ ä¸åŒçš„å‘½ä»¤è¡Œé€‰é¡¹ï¼Œé‚£ä¹ˆä¸ºæ¯ä¸ªå­å‘½ä»¤åˆ›å»ºç‹¬ç«‹çš„flagsetå°±å¯ä»¥äº†ã€‚å„ä¸ªå­å‘½ä»¤ä½¿ç”¨è‡ªå·±çš„flagsetæ¥æ‰§è¡Œflagset.Parse()ä»£æ›¿flag.Parse()å°±å¯ä»¥äº†ã€‚\nå°±è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬å¯¹å‰é¢çš„ç¨‹åºè¿›è¡Œä¸€ç‚¹è°ƒæ•´ï¼š\nCommandæ¥å£å¢åŠ å‘½ä»¤å‚æ•°è§£ææ¥å£ï¼š\n// Command what does a command do type Command interface{ // ParseFlags parse flags into command's own flagset ParseFlags(os.Args) ... }  BaseCommand æ·»åŠ ä¸€ä¸ªå‚æ•°è§£æçš„æ–¹æ³•ï¼Œç»™è‡ªå®šä¹‰å­å‘½ä»¤å­—å¤ç”¨\n// BaseCommand basic implemention // // this BaseCommand could be embeded into a customized subcmd type BaseCommand struct{ flagSet *flag.FlagSet } func (bc *BaseCommand) ParseFlags(args os.Args) error { return bc.flagset.Parse(args) } ...  ä¸ºcreateå­å‘½ä»¤åˆ›å»ºç‹¬ç«‹çš„flagsetæ¥è§£æå‚æ•°\nfunc NewCreateCmd() error { fs := flag.NewFlagSet(\u0026quot;create\u0026quot;, flag.PanicOnError), fs.String(\u0026quot;protofile\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;protofile to process\u0026quot;) fs.String(\u0026quot;protodir\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;protofile to searchï¼‰\u0026quot; return \u0026amp;CreateCmd{ \u0026amp;BaseCommand{ flagSet: fs, } } }  ç¨‹åºå¯åŠ¨çš„æ—¶å€™ç»Ÿä¸€è§£æå‘½ä»¤è¡Œå‚æ•°ï¼š\nfunc main() { ... // parse the flags if err := cmd.ParseFlags(args[1:]; err != nil { panic(err) } ... }  è¿™æ ·å°±å®Œæˆäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œæœ¬æ¥å°±å¾ˆç®€å•ã€‚\nå¦‚ä½•æ˜¾ç¤ºå‘½ä»¤å¸®åŠ©ä¿¡æ¯ï¼Ÿ # å½“ç„¶äº†ï¼Œåªèƒ½è¿è¡Œå‘½ä»¤è¿˜ä¸è¡Œï¼Œæœ‰å¤šå°‘æ³¨å†Œçš„å­å‘½ä»¤å¯æ‰§è¡Œï¼Ÿæ¯ä¸ªå­å‘½ä»¤æœ‰ä»€ä¹ˆå‘½ä»¤è¡Œå‚æ•°å‘¢ï¼Ÿæˆ‘ä»¬è¿˜éœ€è¦èƒ½å¤Ÿæ˜¾ç¤ºå‘½ä»¤è¡Œçš„å¸®åŠ©ä¿¡æ¯ã€‚\nè¿™ä¸ªæ€ä¹ˆå®ç°å‘¢ï¼Ÿå„ä¸ªå­å‘½ä»¤éœ€è¦èƒ½å¤ŸæŒ‡æ˜å‘½ä»¤çš„ä½¿ç”¨å¸®åŠ©ï¼š\n ä¸€ä¸ªç®€å•çš„è¡¨è¿°ï¼Œä»¥ä¾›æˆ‘ä»¬æ˜¾ç¤ºgoxåŒ…å«çš„å„ä¸ªå­å‘½ä»¤å­—çš„ä½¿ç”¨ä¿¡æ¯ï¼› ä¸€ä¸ªè¯¦ç»†çš„æè¿°ï¼Œä»¥ä¾›æˆ‘ä»¬æ˜¾ç¤ºgox help createæ—¶çš„å„ä¸ªé€‰é¡¹çš„å¸®åŠ©ä¿¡æ¯ï¼›  æˆ‘ä»¬çš„ä»£ç ç®€å•åšä¸‹è°ƒæ•´å°±å¯ä»¥æ”¯æŒåˆ°ã€‚\næ·»åŠ Usageã€UsageLongæ–¹æ³•ï¼š\ntype Command interface{ ... // è¿”å›ç®€å•çš„å¸®åŠ©ä¿¡æ¯ Usage() string // è¿”å›è¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯ UsageLong() string }  ç„¶åä¸ºBaseCommandæ·»åŠ ä¸¤ä¸ªå­—æ®µï¼š\ntype BaseCommand struct{ ... Usage string UsageLong string } ... func (bc *BaseCommand) Usage() string { return bc.Usage } func (bc *BaseCommand) UsageLong() string { return bc.UsageLong }  ä¸ºcreateCmdæ·»åŠ å¸®åŠ©ä¿¡æ¯ï¼š\nfunc NewCreateCmd() Command { fs := flag.NewFlagSet(\u0026quot;create\u0026quot;, flag.PanicOnError), fs.String(\u0026quot;protofile\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;protofile to process\u0026quot;) fs.String(\u0026quot;protodir\u0026quot;, \u0026quot;\u0026quot;, \u0026quot;protofile to searchï¼‰\u0026quot; return \u0026amp;CreateCmd{ \u0026amp;BaseCommand{ flagSet: fs, Usage: 'create a project', UsageLong: 'create a project quickly.\\n\\n'+ fs.FlagUsages(), } } }  ç„¶åå‘¢ï¼Œä¸ºäº†èƒ½å¤Ÿä½¿ç”¨å¸®åŠ©ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªhelpå‘½ä»¤å­—ï¼š\ntype HelpCmd struct{ cmd string } func NewHelpCmd() Command { return \u0026amp;HelpCmd{ \u0026amp;BaseCommand{}, } } func (c *HelpCmd) ParseFlags(args os.Args) error { cmd = args[1:] } func (c *HelpCmd) Run() error { // help specific subcmd if len(c.cmd) != 0 { v, ok := cmds[c.cmd] if !ok { return fmt.Errorf(\u0026quot;cmd: %s not registered\u0026quot;, c.cmd) } println(v.UsageLong()) } // help all subcmds for _, v := range cmds { println(v.Usage()) } }  ç„¶åå‘¢ï¼Œæˆ‘ä»¬ä¸»ç¨‹åºå¯åŠ¨çš„æ—¶å€™æ‰§è¡Œgox æˆ– gox helpéƒ½æ‰§è¡Œhelpå‘½ä»¤ï¼š\nfunc main() { args := os.Args[1:] if len(args) == 0 { cmds[\u0026quot;help\u0026quot;].Run() } ... }  å—¯ï¼Œå°±è¿™äº›äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Ÿæœ¬æ¥å°±å¾ˆç®€å•ã€‚\nå°ç»“ # å½“ç„¶ï¼Œé™¤äº†è¿™äº›ï¼Œæˆ‘ä»¬å¯èƒ½è¿˜å¸Œæœ›ä¸ºå‘½ä»¤è¡Œå·¥å…·æ·»åŠ shell auto-completionè¾“å…¥è¡¥å…¨åŠŸèƒ½ï¼Œæç¤ºä¿¡æ¯çš„å›½é™…åŒ–ã€æœ¬åœ°åŒ–ï¼Œå‘½ä»¤å­—æ‰©å±•æ—¶çš„ä¾¿åˆ©ç¨‹åº¦ç­‰ï¼Œè¿˜æ˜¯æœ‰äº›é—®é¢˜éœ€è¦è¿›ä¸€æ­¥è€ƒè™‘çš„ã€‚\næˆ‘è¿™é‡Œåªæ˜¯ä»‹ç»ä¸‹å®ç°çš„ä¸€ä¸ªå¤§è‡´æ€è·¯ï¼Œå…·ä½“å®è·µçš„æ—¶å€™å€’å¹¶ä¸ä¸€å®šè¦è¿™ä¹ˆå»å®ç°ï¼Œå¯ä»¥è€ƒè™‘ä¸‹cobraï¼Œé€šè¿‡cobraæ¥å®ç°posixé£æ ¼çš„å‘½ä»¤è¡Œæ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚è¿™äº›å†…å®¹æ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªå·±äº†è§£ä¸‹ã€‚\nå’Œæœ¬æ–‡å†…å®¹æ¥è¿‘çš„ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„ä¸€ä¸ªå·¥å…·rm-safeï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‹å‹æœ‰å¸®åŠ©ï¼\n"}),a.add({id:285,href:"/tags/%E4%BA%BA%E7%94%9F/",title:"äººç”Ÿ",description:"",content:""}),a.add({id:286,href:"/tags/%E7%88%B6%E4%BA%B2/",title:"çˆ¶äº²",description:"",content:""}),a.add({id:287,href:"/blog/2020-06-21-%E7%88%B6%E4%BA%B2%E8%8A%82%E4%BA%8E%E6%88%91%E5%B7%B2%E6%98%AF%E7%A7%8D%E5%A5%A2%E4%BE%88/",title:"çˆ¶äº²èŠ‚ï¼Œäºæˆ‘å·²æ˜¯ç§å¥¢ä¾ˆ",description:"img {width:640px;}  æ˜¨å¤©æ˜¯å‘¨å…­ï¼Œä¼˜åŒ–äº†ä¸€ä¸‹ä»£ç ç”Ÿæˆå·¥å…·gorpcï¼Œè§£å†³äº†å‡ ä¸ªé—ç•™çš„é—®é¢˜ï¼Œæ€»ç®—æ˜¯åšäº†ç‚¹æœ‰æ„æ€çš„äº‹æƒ…ï¼Œå¿ƒé‡Œæœ‰ç‚¹çªƒå–œã€‚ä¸´ç¡å‰ï¼Œæå‡ºæ‰‹æœºï¼Œæƒ¯ä¾‹åœ°åˆ·äº†åˆ·æ¨é€çš„æ¶ˆæ¯ï¼ŒåŸæ¥æ˜å¤©æ˜¯çˆ¶äº²èŠ‚äº†ã€‚å¿ƒé‡Œå¿ä¸ä½è¢«æ‰äº†ä¸€ä¸‹ï¼Œçˆ¶äº²èŠ‚ï¼Œäºæˆ‘å·²æ˜¯ç§å¥¢ä¾ˆã€‚30å²çš„å¹´çºªï¼Œæˆ–å¥½æˆ–åï¼Œæˆ–å°æœ‰æˆç»©æˆ–æ»¡æ€€è¿·èŒ«ï¼Œä¸ç®¡æ€æ ·ï¼Œè‡³å°‘ä½ ä»¬è¿˜æœ‰çˆ¶äº²ï¼Œæˆ‘åªèƒ½åœ¨ä¸€ä¸ªäººçš„æ—¶å€™æ‰èƒ½å»äº«å—ä¸‹é‚£ä¹…è¿çš„å›å¿†ï¼Œé‚£äº›æœ‰çˆ¶äº²çš„æ—¶å…‰ã€‚\nåœ¨æˆ‘è¿˜å¾ˆå°çš„æ—¶å€™ï¼Œå®¶é‡Œå¾ˆæ˜¯æ‹®æ®ï¼Œçˆ¶æ¯å¾ˆè¾›è‹¦ï¼Œä¸ºäº†ç»´æŒä¸€å®¶äººç”Ÿæ´»ï¼Œçˆ¶æ¯ä»˜å‡ºäº†å¾ˆå¤šã€‚çˆ¶æ¯çš„è¾›è‹¦ï¼Œåœ¨æˆ‘å¾ˆå°çš„æ—¶å€™å°±åŸ‹è¿›äº†å¿ƒåº•â€¦â€¦å¦‚ä»Šï¼ŒäºŒä¸‰åå¹´è¿‡å»ï¼Œé‚£æ¯é€¢ä¸‹é›¨å°±è¦æ»´æ»´ç­”ç­”æ¼æ°´çš„çŸ®æ—§æˆ¿å­ä¸è§äº†ï¼Œé‚£ä¸ºäº†ç»´æŒç”Ÿè®¡çš„å°å–éƒ¨æŸœå°ã€ä¸€æ–¤ä¸€ä¸¤ç§¯æ”’æ”¶å…¥çš„ç§°ä¹Ÿä¸è§äº†ï¼Œé‚£äº›å…»è¿‡å…”å­çš„ç¬¼å­ã€å…»è¿‡çŒªé©¬çš„ç ´æ—§è‰æˆ¿ã€äººåŠ›æ‰“æ°´çš„å°å‹äº•ã€é»‘å’•éš†å’šçš„é¥­å±‹ï¼ˆå¨æˆ¿ï¼‰ï¼Œè¿˜æœ‰é‚£æ£µä¸€äººæŠ±ä¸è¿‡è…°èº«çš„å¤§æ§æ ‘ï¼Œå¤§æ§æ ‘ä¸‹çš„ç‹—å±‹ï¼ˆå°é»‘çš„å±‹ï¼‰ï¼Œéƒ½ä¸è§äº†ã€‚ç°åœ¨ä¾ç¨€è¿˜èƒ½å›æƒ³èµ·å®ƒä»¬çš„æ ·å­ï¼Œç”šè‡³è¿˜è®°å¾—ï¼Œé‚£ä¸ªæ‹¿ç€é­ç‚®å“å”¬å°é»‘çš„æˆ‘ï¼Œé‚£ä¸ªå‹ä¸åŠ¨å°å‹äº•ã€è·³èµ·æ¥å‹æ°´çš„æˆ‘ã€‚å®ƒä»¬éƒ½ä¸è§äº†ï¼Œå˜æˆäº†ç°åœ¨å®½æ•æ˜äº®ã€ä¾¿åˆ©æ–¹ä¾¿çš„å¤§æˆ¿å­ï¼Œé‚£æ˜¯çˆ¶æ¯ä¸€ç‚¹ä¸€æ»´æ‰“æ‹¼çš„ç»“æœï¼Œç°åœ¨å´å”¯ç‹¬å°‘äº†ä»–ã€‚",content:" img {width:640px;}  æ˜¨å¤©æ˜¯å‘¨å…­ï¼Œä¼˜åŒ–äº†ä¸€ä¸‹ä»£ç ç”Ÿæˆå·¥å…·gorpcï¼Œè§£å†³äº†å‡ ä¸ªé—ç•™çš„é—®é¢˜ï¼Œæ€»ç®—æ˜¯åšäº†ç‚¹æœ‰æ„æ€çš„äº‹æƒ…ï¼Œå¿ƒé‡Œæœ‰ç‚¹çªƒå–œã€‚ä¸´ç¡å‰ï¼Œæå‡ºæ‰‹æœºï¼Œæƒ¯ä¾‹åœ°åˆ·äº†åˆ·æ¨é€çš„æ¶ˆæ¯ï¼ŒåŸæ¥æ˜å¤©æ˜¯çˆ¶äº²èŠ‚äº†ã€‚å¿ƒé‡Œå¿ä¸ä½è¢«æ‰äº†ä¸€ä¸‹ï¼Œçˆ¶äº²èŠ‚ï¼Œäºæˆ‘å·²æ˜¯ç§å¥¢ä¾ˆã€‚30å²çš„å¹´çºªï¼Œæˆ–å¥½æˆ–åï¼Œæˆ–å°æœ‰æˆç»©æˆ–æ»¡æ€€è¿·èŒ«ï¼Œä¸ç®¡æ€æ ·ï¼Œè‡³å°‘ä½ ä»¬è¿˜æœ‰çˆ¶äº²ï¼Œæˆ‘åªèƒ½åœ¨ä¸€ä¸ªäººçš„æ—¶å€™æ‰èƒ½å»äº«å—ä¸‹é‚£ä¹…è¿çš„å›å¿†ï¼Œé‚£äº›æœ‰çˆ¶äº²çš„æ—¶å…‰ã€‚\nåœ¨æˆ‘è¿˜å¾ˆå°çš„æ—¶å€™ï¼Œå®¶é‡Œå¾ˆæ˜¯æ‹®æ®ï¼Œçˆ¶æ¯å¾ˆè¾›è‹¦ï¼Œä¸ºäº†ç»´æŒä¸€å®¶äººç”Ÿæ´»ï¼Œçˆ¶æ¯ä»˜å‡ºäº†å¾ˆå¤šã€‚çˆ¶æ¯çš„è¾›è‹¦ï¼Œåœ¨æˆ‘å¾ˆå°çš„æ—¶å€™å°±åŸ‹è¿›äº†å¿ƒåº•â€¦â€¦å¦‚ä»Šï¼ŒäºŒä¸‰åå¹´è¿‡å»ï¼Œé‚£æ¯é€¢ä¸‹é›¨å°±è¦æ»´æ»´ç­”ç­”æ¼æ°´çš„çŸ®æ—§æˆ¿å­ä¸è§äº†ï¼Œé‚£ä¸ºäº†ç»´æŒç”Ÿè®¡çš„å°å–éƒ¨æŸœå°ã€ä¸€æ–¤ä¸€ä¸¤ç§¯æ”’æ”¶å…¥çš„ç§°ä¹Ÿä¸è§äº†ï¼Œé‚£äº›å…»è¿‡å…”å­çš„ç¬¼å­ã€å…»è¿‡çŒªé©¬çš„ç ´æ—§è‰æˆ¿ã€äººåŠ›æ‰“æ°´çš„å°å‹äº•ã€é»‘å’•éš†å’šçš„é¥­å±‹ï¼ˆå¨æˆ¿ï¼‰ï¼Œè¿˜æœ‰é‚£æ£µä¸€äººæŠ±ä¸è¿‡è…°èº«çš„å¤§æ§æ ‘ï¼Œå¤§æ§æ ‘ä¸‹çš„ç‹—å±‹ï¼ˆå°é»‘çš„å±‹ï¼‰ï¼Œéƒ½ä¸è§äº†ã€‚ç°åœ¨ä¾ç¨€è¿˜èƒ½å›æƒ³èµ·å®ƒä»¬çš„æ ·å­ï¼Œç”šè‡³è¿˜è®°å¾—ï¼Œé‚£ä¸ªæ‹¿ç€é­ç‚®å“å”¬å°é»‘çš„æˆ‘ï¼Œé‚£ä¸ªå‹ä¸åŠ¨å°å‹äº•ã€è·³èµ·æ¥å‹æ°´çš„æˆ‘ã€‚å®ƒä»¬éƒ½ä¸è§äº†ï¼Œå˜æˆäº†ç°åœ¨å®½æ•æ˜äº®ã€ä¾¿åˆ©æ–¹ä¾¿çš„å¤§æˆ¿å­ï¼Œé‚£æ˜¯çˆ¶æ¯ä¸€ç‚¹ä¸€æ»´æ‰“æ‹¼çš„ç»“æœï¼Œç°åœ¨å´å”¯ç‹¬å°‘äº†ä»–ã€‚\n"}),a.add({id:288,href:"/blog/2020-06-09-a-golang-debugger-book/",title:"A Golang Debugger Book",description:"18å¹´å¼€å§‹å­¦ä¹ goæ—¶ï¼Œå‘ç°äº†ä¸€æ¬¾è°ƒè¯•å™¨delveï¼Œé™†é™†ç»­ç»­åœ°çœ‹äº†äº›æºç ã€è°ƒè¯•æ ‡å‡†çš„ä¸œè¥¿ï¼Œå‘ç°è°ƒè¯•å™¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åˆ‡å…¥è§†è§’æ¥è®¤è¯†è®¡ç®—æœºç³»ç»Ÿï¼Œå°±æƒ³æŠŠè¿™äº›ä¸œè¥¿ç†é¡ºã€åˆ†äº«ä¸€ä¸‹ã€‚åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå¯¹å¼€å‘å·¥å…·é“¾çš„è®¤è¯†éƒ½è¿˜æœ‰äº›è®¤è¯†ä¸Šçš„ä¸è¶³ï¼Œå…³é”®è¿˜æ˜¯ï¼Œè§‰å¾—è°ƒè¯•å™¨å°±å¥½æ¯”ä¸€ä¸ªæ”¾å¤§é•œï¼Œæ”¾å¤§ä¸€å€çœ‹æ¸…å†…å­˜å˜é‡ï¼Œæ”¾å¤§ä¸¤å€çœ‹æ¸…ç±»å‹ç³»ç»Ÿï¼Œæ”¾å¤§ä¸‰å€çœ‹æ¸…æœºå™¨ç‰©ç†ç»“æ„â€¦â€¦è¿™æ˜¯ç®€å•çš„ï¼Œæ¶‰åŠåˆ°è¿è¡Œæ—¶ã€æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ç­‰çš„ç‰¹æ€§ï¼Œæˆ‘æ˜¯è§‰å¾—å¾ˆæœ‰æ„æ€ï¼Œå°¤å…¶æ˜¯å¯¹éƒ¨åˆ†æƒ³äº†è§£è¿™äº›çŸ¥è¯†çš„äººæ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„å‚è€ƒæ„ä¹‰çš„ã€‚\nhttps://github.com/hitzhangjie/golang-debugger-bookã€‚\nåæ¥å·¥ä½œå˜åŠ¨æ²¡æœ‰æŒç»­æŠ•å…¥äº†ï¼Œ19å¹´ä¸‹åŠå¹´æ”¯æŒtrpcä¹Ÿæ²¡å¤ªå¤šæ—¶é—´æŠ•å…¥ï¼Œ19å¹´å¹´åº•çš„æ—¶å€™ä¹°äº†ipadèŠ±äº†è¿ç»­å‡ ä¸ªå‘¨æœ«å•ƒäº†300é¡µdwarfæ ‡å‡†ï¼ŒåšæŒå†™å®Œäº†dwarfç›¸å…³çš„éƒ¨åˆ†ã€‚åé¢å¼€å§‹æ”¯æŒepcåˆæ²¡æ—¶é—´äº†â€¦â€¦\nç°åœ¨å„é¡¹å·¥ä½œé™†é™†é™†ç»­ç»­æœ‰äº†çœ‰ç›®ï¼Œä¹Ÿæƒ³æŠŠä¹‹å‰æ”¾ä¸‹çš„ä¸œè¥¿å†æ¡èµ·æ¥ï¼Œæ„Ÿå…´è¶£å¯ä»¥ç®€å•ç¿»ä¸‹ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´ä¹Ÿæœ‰å…´è¶£çš„è¯ï¼Œæ¬¢è¿ä¸šä½™æ—¶é—´ä¸€èµ·ç»§ç»­ä¸‹å»ï¼Œå€’ä¸æ˜¯è§‰å¾—æ˜¯é¡¹å¤šä¹ˆå‡ºå½©çš„å†…å®¹ï¼Œå°±æ˜¯è§‰å¾—æœ‰äº›å€¼å¾—æ·±ç©¶çš„ä¸œè¥¿æƒ³å»æ¢ç´¢ä¸€ä¸‹ï¼Œè¿˜æœ‰å°±æ˜¯ä¸€é¡¹å·¥ä½œæç½®å¤ªä¹…ä¼šæœ‰å¾ˆæµ“çš„æŒ«è´¥æ„Ÿã€‚\nè…¾è®¯çš„å°ä¼™ä¼´ä»¬å¾ˆä¼˜ç§€ï¼Œå¦‚æœèƒ½æœ‰å°ä¼™ä¼´ä»¬åŠ©æ”»ï¼Œè¿™ä¸ªåº”è¯¥ä¼šåŠ é€Ÿå¾ˆå¤šã€‚\n  dwarf v4æ ‡å‡†è§£æ å·²å®Œæˆ\n  dwarfæ•°æ®æå– goæ ‡å‡†åº“å·²æä¾›\n  delveæºç è§£æ ä¸€å°éƒ¨åˆ†\n  goç±»å‹ç³»ç»Ÿã€è¿è¡Œæ—¶ã€è°ƒè¯•å™¨ç»“åˆ å¾…è¡¥å……\n  goæ–°ç‰ˆæœ¬å‡†å¤‡åˆ‡æ¢dwarf v5ã€æ›´å¥½çš„linkerï¼Œæœ‰äº›ç›¸å…³çš„çŸ¥è¯†ï¼Œæ¶‰åŠåˆ°compilerã€linkerã€debuggerçš„åä½œ\u0026hellip;\n  å…¶ä»–\n  å…¶å®ï¼Œè¿˜æœ‰å¾ˆå¤šå†…å®¹è¦è¡¥å……ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æœ€ç»ˆä¼šå˜æˆå•¥æ ·ï¼Œå¯èƒ½å°±æ˜¯ç°åœ¨è¿™æ ·â€¦â€¦æ›¾ç»è¯•å›¾é‚€è¯·å‡ ä¸ªå°ä¼™ä¼´æ¥æä¸‹ï¼Œå¯èƒ½æœ¬èº«æ²¡ä»€ä¹ˆå¸å¼•åŠ›å§ï¼Œæœ€ç»ˆè¿˜æ˜¯è¿™æ ·ã€‚\næ„Ÿå…´è¶£æ‰èƒ½åšæŒä¸‹å»ï¼Œæ¯æ¬¡æƒ³åˆ°å®ƒï¼Œéƒ½æœ‰ç§ç«‹å³æƒ³æŠ•å…¥çš„å†²åŠ¨ï¼Œä¸€ä¸ªäººçš„å‘¨æœ«æœ‰ç‚¹æœ‰é™ :)",content:"18å¹´å¼€å§‹å­¦ä¹ goæ—¶ï¼Œå‘ç°äº†ä¸€æ¬¾è°ƒè¯•å™¨delveï¼Œé™†é™†ç»­ç»­åœ°çœ‹äº†äº›æºç ã€è°ƒè¯•æ ‡å‡†çš„ä¸œè¥¿ï¼Œå‘ç°è°ƒè¯•å™¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åˆ‡å…¥è§†è§’æ¥è®¤è¯†è®¡ç®—æœºç³»ç»Ÿï¼Œå°±æƒ³æŠŠè¿™äº›ä¸œè¥¿ç†é¡ºã€åˆ†äº«ä¸€ä¸‹ã€‚åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œå¯¹å¼€å‘å·¥å…·é“¾çš„è®¤è¯†éƒ½è¿˜æœ‰äº›è®¤è¯†ä¸Šçš„ä¸è¶³ï¼Œå…³é”®è¿˜æ˜¯ï¼Œè§‰å¾—è°ƒè¯•å™¨å°±å¥½æ¯”ä¸€ä¸ªæ”¾å¤§é•œï¼Œæ”¾å¤§ä¸€å€çœ‹æ¸…å†…å­˜å˜é‡ï¼Œæ”¾å¤§ä¸¤å€çœ‹æ¸…ç±»å‹ç³»ç»Ÿï¼Œæ”¾å¤§ä¸‰å€çœ‹æ¸…æœºå™¨ç‰©ç†ç»“æ„â€¦â€¦è¿™æ˜¯ç®€å•çš„ï¼Œæ¶‰åŠåˆ°è¿è¡Œæ—¶ã€æ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ç­‰çš„ç‰¹æ€§ï¼Œæˆ‘æ˜¯è§‰å¾—å¾ˆæœ‰æ„æ€ï¼Œå°¤å…¶æ˜¯å¯¹éƒ¨åˆ†æƒ³äº†è§£è¿™äº›çŸ¥è¯†çš„äººæ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„å‚è€ƒæ„ä¹‰çš„ã€‚\nhttps://github.com/hitzhangjie/golang-debugger-bookã€‚\nåæ¥å·¥ä½œå˜åŠ¨æ²¡æœ‰æŒç»­æŠ•å…¥äº†ï¼Œ19å¹´ä¸‹åŠå¹´æ”¯æŒtrpcä¹Ÿæ²¡å¤ªå¤šæ—¶é—´æŠ•å…¥ï¼Œ19å¹´å¹´åº•çš„æ—¶å€™ä¹°äº†ipadèŠ±äº†è¿ç»­å‡ ä¸ªå‘¨æœ«å•ƒäº†300é¡µdwarfæ ‡å‡†ï¼ŒåšæŒå†™å®Œäº†dwarfç›¸å…³çš„éƒ¨åˆ†ã€‚åé¢å¼€å§‹æ”¯æŒepcåˆæ²¡æ—¶é—´äº†â€¦â€¦\nç°åœ¨å„é¡¹å·¥ä½œé™†é™†é™†ç»­ç»­æœ‰äº†çœ‰ç›®ï¼Œä¹Ÿæƒ³æŠŠä¹‹å‰æ”¾ä¸‹çš„ä¸œè¥¿å†æ¡èµ·æ¥ï¼Œæ„Ÿå…´è¶£å¯ä»¥ç®€å•ç¿»ä¸‹ï¼Œå¦‚æœæœ‰å°ä¼™ä¼´ä¹Ÿæœ‰å…´è¶£çš„è¯ï¼Œæ¬¢è¿ä¸šä½™æ—¶é—´ä¸€èµ·ç»§ç»­ä¸‹å»ï¼Œå€’ä¸æ˜¯è§‰å¾—æ˜¯é¡¹å¤šä¹ˆå‡ºå½©çš„å†…å®¹ï¼Œå°±æ˜¯è§‰å¾—æœ‰äº›å€¼å¾—æ·±ç©¶çš„ä¸œè¥¿æƒ³å»æ¢ç´¢ä¸€ä¸‹ï¼Œè¿˜æœ‰å°±æ˜¯ä¸€é¡¹å·¥ä½œæç½®å¤ªä¹…ä¼šæœ‰å¾ˆæµ“çš„æŒ«è´¥æ„Ÿã€‚\nè…¾è®¯çš„å°ä¼™ä¼´ä»¬å¾ˆä¼˜ç§€ï¼Œå¦‚æœèƒ½æœ‰å°ä¼™ä¼´ä»¬åŠ©æ”»ï¼Œè¿™ä¸ªåº”è¯¥ä¼šåŠ é€Ÿå¾ˆå¤šã€‚\n  dwarf v4æ ‡å‡†è§£æ å·²å®Œæˆ\n  dwarfæ•°æ®æå– goæ ‡å‡†åº“å·²æä¾›\n  delveæºç è§£æ ä¸€å°éƒ¨åˆ†\n  goç±»å‹ç³»ç»Ÿã€è¿è¡Œæ—¶ã€è°ƒè¯•å™¨ç»“åˆ å¾…è¡¥å……\n  goæ–°ç‰ˆæœ¬å‡†å¤‡åˆ‡æ¢dwarf v5ã€æ›´å¥½çš„linkerï¼Œæœ‰äº›ç›¸å…³çš„çŸ¥è¯†ï¼Œæ¶‰åŠåˆ°compilerã€linkerã€debuggerçš„åä½œ\u0026hellip;\n  å…¶ä»–\n  å…¶å®ï¼Œè¿˜æœ‰å¾ˆå¤šå†…å®¹è¦è¡¥å……ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æœ€ç»ˆä¼šå˜æˆå•¥æ ·ï¼Œå¯èƒ½å°±æ˜¯ç°åœ¨è¿™æ ·â€¦â€¦æ›¾ç»è¯•å›¾é‚€è¯·å‡ ä¸ªå°ä¼™ä¼´æ¥æä¸‹ï¼Œå¯èƒ½æœ¬èº«æ²¡ä»€ä¹ˆå¸å¼•åŠ›å§ï¼Œæœ€ç»ˆè¿˜æ˜¯è¿™æ ·ã€‚\næ„Ÿå…´è¶£æ‰èƒ½åšæŒä¸‹å»ï¼Œæ¯æ¬¡æƒ³åˆ°å®ƒï¼Œéƒ½æœ‰ç§ç«‹å³æƒ³æŠ•å…¥çš„å†²åŠ¨ï¼Œä¸€ä¸ªäººçš„å‘¨æœ«æœ‰ç‚¹æœ‰é™ :)\n"}),a.add({id:289,href:"/tags/golang/",title:"golang",description:"",content:""}),a.add({id:290,href:"/tags/tencent/",title:"tencent",description:"",content:""}),a.add({id:291,href:"/tags/work/",title:"work",description:"",content:""}),a.add({id:292,href:"/blog/2020-06-05-%E6%88%91%E5%9C%A8%E8%85%BE%E8%AE%AF%E8%BF%99%E5%87%A0%E5%B9%B4/",title:"æˆ‘åœ¨è…¾è®¯è¿™å‡ å¹´",description:"img {width:680px;} video {width:680px;}  å†™åœ¨å‰é¢ # å¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡æœ‰æ›´æ–°ä¸ªäººåšå®¢äº†ï¼Œå›å¤´ä¸€çœ‹ç«Ÿç„¶æœ‰ä¸€å¹´æ²¡æ›´æ–°ï¼Œè¿™ä¸€å¹´å·¥ä½œä¸Šç¡®å®æ¯”ä»¥å‰å¿™äº†å¾ˆå¤šã€‚æœ‰ç‚¹æ—¶é—´ä¹Ÿæ‹¿æ¥ä½“éªŒç”Ÿæ´»ã€é’»ç ”æ„Ÿå…´è¶£çš„æŠ€æœ¯äº†ã€‚æ„Ÿå…´è¶£ä¹Ÿå¯ä»¥çœ‹ä¸‹æˆ‘çš„githubï¼Œè¿™ä¸€å¹´å‡ ä¹ä¹Ÿåœ¨ä¸åœåœ°æ¢ç´¢ã€å°è¯•ï¼Œå› ä¸ºå…´è¶£å’Œé‚£ä»½å¥½å¥‡ï¼Œè¿˜æœ‰å°±æ˜¯ï¼Œæƒ³åšç‚¹æœ‰æ·±åº¦çš„ä¸œè¥¿å–æ‚¦è‡ªå·±ã€‚\nè‡ªä»2016å¹´7æœˆä»½å…¥èŒè…¾è®¯ä»¥æ¥ï¼Œä¹Ÿç®—æ˜¯å‹¤å‹¤æ³æ³åœ°å·¥ä½œï¼Œè‡³å°‘ä¸è®©è‡ªå·±æˆä¸ºå›¢é˜Ÿçš„ç“¶é¢ˆå§ï¼Œäº‹å®ä¸Šåšçš„åº”è¯¥è¿˜å¯ä»¥å§ã€‚å½“ç„¶å’Œè‡ªå·±çš„å…´è¶£ã€é¢†å¯¼çš„æŒ‡ç‚¹ã€å·¥ä½œé¡¹çš„å®‰æ’ï¼Œä¹Ÿæœ‰å¯†åˆ‡çš„å…³ç³»ï¼Œç»å¤§éƒ¨åˆ†å·¥ä½œæ—¶é—´ï¼Œæˆ‘è¿˜æ˜¯æ¯”è¾ƒå¼€å¿ƒçš„ã€‚\nä»Šå¤©æ”¶æ‹¾æˆ¿é—´ï¼Œæ— æ„ä¸­å‘ç°äº†è…¾è®¯å­¦é™¢çš„ä¸€ä¸ªç¬”è®°æœ¬ï¼Œç¿»å¼€ä¸€çœ‹ï¼ŒåŸæ¥æ˜¯16å¹´åˆšå…¥èŒæ—¶åŸ¹è®­ç”¨çš„ææ–™ï¼Œé‡Œé¢è¿˜æœ‰è‡ªå·±çš„ç¬”è®°ï¼Œå­—è¿¹è¿˜æ¸…æ™°ï¼Œç®—ä¸ä¸Šå¤ªå·¥æ•´ã€‚ç¿»å¼€æ–°çš„ä¸€é¡µï¼Œå¿ä¸ä½æƒ³å†™ç‚¹ä»€ä¹ˆï¼Œæœ‰æ„Ÿæ¿€ï¼Œæœ‰æ¬£èµï¼Œæœ‰éƒé—·ï¼Œä¹Ÿæœ‰è´¨ç–‘ï¼Œæœ€åç«Ÿä¹Ÿæ— æ³•è½ç¬”ã€‚\n2016å¹´7æœˆï¼Œæˆ‘å…¥èŒäº† # æœ€æ—©æƒ³æ¥è…¾è®¯è¿˜æ˜¯ä¸€æ¬¡å®ä¹ ç”Ÿæ‹›è˜ä¼šä¸Šï¼Œè‡ªå·±ä¹Ÿæ²¡æœ‰å‡†å¤‡ï¼Œå°±å¤§å¤§å’§å’§å»äº†ï¼Œç»“æœæŒ‚äº†ã€‚é¢è¯•å®˜æˆ‘æ„Ÿè§‰è¿˜ç®—æ¯”è¾ƒä¸“ä¸šå§ï¼Œå½“æ—¶å°±æƒ³ç€æ¯•ä¸šåå»è…¾è®¯é”»ç‚¼ä¸‹å§ã€‚æ ¡æ‹›å­£ï¼Œè‡ªå·±ä¹Ÿæ²¡æ€ä¹ˆè®¤çœŸå‡†å¤‡ï¼Œä½†æ˜¯è¿˜æ˜¯æ‹¿äº†å¥½å‡ ä¸ªofferï¼Œæ–°æµªï¼ˆSPï¼Ÿé¢è¯•å®˜å¾ˆå–œæ¬¢æˆ‘è¿˜æ„¿æ„æ›¿æˆ‘å’ŒHRæ²Ÿé€šè–ªèµ„ï¼Œæœ€ç»ˆå› ä¸ºæ–°æµªå‘offerå¤ªæ…¢æ²¡å»ï¼‰ã€å»å“ªå„¿ï¼ˆSPï¼Ÿå½“å¤©ç»™çš„offerï¼Œä¸å¤ªæƒ³å»åŒ—äº¬æœ€åæ²¡å»ï¼‰ã€é˜¿é‡Œå¤©çŒ«ï¼ˆæ²¡è®¤çœŸå‡†å¤‡ï¼Œç»™äº†ä¸ªB+ï¼Œè¢«å„ç§å¯’é…¸æœ€åæ²¡å»ï¼‰ã€åä¸ºï¼ˆæˆ‘å°±æ˜¯æƒ³å»æå†…æ ¸ï¼Œå‡­å­¦ä¹ èƒ½åŠ›åº”è¯¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯å»äº†ä¼°è®¡ä¹Ÿä¸æ˜¯è¿™ä¸ªæ–¹å‘ï¼Œæ²¡å»ï¼‰\u0026hellip;æœ€åæˆ‘æƒ³åˆ°è…¾è®¯ä¸Šæ¬¡å®ä¹ ç»™æˆ‘æŒ‚äº†ï¼Œåœ¨è…¾è®¯æ ¡æ‹›è¡¥å½•é˜¶æ®µçš„æ—¶å€™è¿‡äº†ï¼ˆSPï¼‰ã€‚\næˆ‘ä¹Ÿä¸çŸ¥é“å½“åˆé¢è¿™ä¹ˆå¤šæ˜¯ä¸ºäº†ä»€ä¹ˆï¼Œåªæ˜¯æƒ³è¯æ˜ä¸‹è‡ªå·±å¯ä»¥é€šè¿‡æŸäº›å…¬å¸çš„é¢è¯•ï¼Ÿå¯èƒ½å§ï¼Œäººç¼ºä¹è‡ªä¿¡çš„æ—¶å€™ï¼Œå°±å®¹æ˜“åšè¿™äº›å‚»äº‹ï¼Œæ€»æ˜¯å¸Œæœ›ä»åˆ«äººå£ä¸­çš„è¯„ä»·æ¥è®¤è¯†è‡ªå·±ã€‚\nå…¥èŒä¹‹å‰ï¼Œæˆ‘é—®æ—©è¿›æ¥çš„åŒå­¦ï¼Œæ­£å¼å…¥èŒé‚£å¤©ï¼Œæˆ‘éœ€è¦ç©¿æ­£è£…å—ï¼Ÿç»“æœå½“å¤©æ¥çš„æ—¶å€™å‘ç°æœ‰äº›äººç­‰ç”µæ¢¯çš„æ—¶å€™ï¼Œç©¿æ‹–é‹çš„å°å“¥ï¼Œä¸ºäº†å‡‰å¿«ï¼Œç›´æ¥æŠŠè„šè¸©åœ°ä¸Šã€‚æš—è‡ªåº†å¹¸ï¼Œç©¿æ­£è£…æ¥äº†åè€Œæ˜¯ä¸ªå¦ç±»ã€‚\n 2016.7.24 å…¥èŒ+ç ´å†° 2016.7.25 å¼€ç­å…¸ç¤¼ + \u0026ldquo;è…¾è®¯ç”¨æˆ·å¯¼å‘\u0026quot;åŸ¹è®­ 2016.7.26 èµ°è¿›è…¾è®¯ä¸è…¾è®¯æ–‡åŒ– \u0026hellip;  åå‡ å¤©çš„å°åŸ¹ï¼Œè®¤è¯†äº†å¾ˆå¤šåŒäº‹ï¼Œä¹Ÿå¤§æ¦‚äº†è§£äº†è…¾è®¯çš„ä¸€äº›æ–‡åŒ–ã€å·¥ä½œæ–¹å¼ï¼Œè¿™æœŸé—´åƒçš„ä¹Ÿä¸é”™ï¼Œæˆ‘è¿˜æƒ³ä¼šä¸ä¼šæˆ‘è¿™å¸¸å¹´120æ–¤çš„ä½“é‡ä¹Ÿå¯ä»¥å¢é‡ä¸‹äº†ã€‚\nå°åŸ¹ç»“æŸæ—¶ï¼Œä¹Ÿæœ‰éƒ¨åˆ†æ€»åŠé¢†å¯¼æ¥å‚åŠ äº†é—­å¹•å¼ï¼Œè¿˜è·³äº†ä¸€æ®µã€‚å½“æ—¶æˆ‘è§‰å¾—é¢†å¯¼å’Œä¸€çº¿å·¥ä½œäººå‘˜èƒ½è¿™ä¹ˆäº’åŠ¨ï¼Œåº”è¯¥å·¥ä½œæ°›å›´å¾ˆä¸é”™ï¼Œåº”è¯¥å¾ˆæœ‰æ´»åŠ›ï¼Œå½“æ—¶å¯¹è…¾è®¯æœ‰å¾ˆé«˜çš„æœŸæœ›å€¼ï¼Œè‡ªå·±ä¹Ÿæ„¿æ„åŠ å…¥å…¶ä¸­ï¼Œè´¡çŒ®ä¸€ç‚¹åŠ›é‡ã€‚\nYour browser doesn't support the video tag.  2016å¹´8æœˆï¼Œæ¥åˆ°ç»„ç»‡ # å°åŸ¹ç»“æŸåï¼Œæ¥åˆ°å½“æ—¶çš„å³é€šåº”ç”¨éƒ¨/äº’åŠ¨è§†é¢‘äº§å“éƒ¨ï¼Œæˆ‘å°±æˆäº†è¿™é‡Œçš„ä¸€ååå°å¼€å‘ï¼Œå¼€å§‹å†™è‡ªå·±çš„ä»£ç ã€‚å½“æ—¶æˆ‘çš„å¯¼å¸ˆç£Šå“¥ï¼Œå¯¹æˆ‘è¿˜æ˜¯æŒºç…§é¡¾çš„ï¼Œè¿˜æœ‰leaderï¼Œå‘¨å›´çš„å°ä¼™ä¼´ï¼Œä»–ä»¬çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘å¿«é€Ÿèå…¥äº†å›¢é˜Ÿã€‚ä¸è¿‡å˜›ï¼Œæˆ‘æ¥äº†å¿«ä¸€å‘¨çš„æ—¶å€™ï¼Œå°±å¿ä¸ä½æƒ³åæ§½ï¼Œå½“æ—¶åšä¸ªæ¶ˆæ¯æ¨é€çš„å·¥å…·ï¼Œè°ƒç”¨çš„APIç«Ÿç„¶è¿ä¸ªæ–‡æ¡£è¯´æ˜ä¹Ÿæ²¡æœ‰ã€‚æˆ‘æ˜¯æ¯”è¾ƒå–œæ¬¢å†™æ–‡æ¡£çš„ï¼Œä¸€ä¸ªæ˜¯æ¯”è¾ƒä¸“ä¸šï¼Œä¸€ä¸ªæ˜¯èƒ½å‡å°‘ä¸å¿…è¦çš„æ²Ÿé€šï¼Œä½•ä¹è€Œä¸ä¸ºã€‚å…³é”®å½“æ—¶çš„APIçš„è´Ÿè´£äººè¿˜è´¼éš¾æ²Ÿé€šï¼Œæˆ‘ä¹Ÿæ˜¯æœæ°”ï¼Œä»é‚£å¼€å§‹ï¼Œå°±é™†é™†ç»­ç»­åœ°è®¤è¯†äº†çœŸå®çš„è…¾è®¯ï¼Œè¤’è´¬å‚åŠï¼Œæ¯”è¾ƒçœŸå®ã€‚\n2016å¹´10æœˆï¼Œé‚€çˆ¶æ¯æ¥æ·±åœ³ç© # æˆ‘ä¸œè¥¿å·®ä¸å¤šå‡†å¤‡å¥½äº†ä¹‹åï¼Œè‡ªå·±ä¹Ÿå¼€å§‹æŒ£é’±äº†ï¼Œæƒ³ç€çˆ¶æ¯ä¸€ç›´å‹¤å‹¤æ³æ³å·¥ä½œï¼Œä¾›æˆ‘ä¸Šå­¦å·¥ä½œï¼Œç°åœ¨å¯ä»¥è¯·ä»–ä»¬æ¥æ·±åœ³ç©ç©ï¼Œä»¥å‰çˆ¶æ¯ä¹Ÿæ²¡æœ‰èˆå¾—å‡ºå»ç©è¿‡ã€‚æˆ‘å†…å¿ƒé‡Œæ˜¯ç‰¹åˆ«å¸Œæœ›ä»–ä»¬å‡ºæ¥èµ°èµ°çš„ï¼Œæˆ‘ä¹Ÿå°½å°½å­å¿ƒã€‚\né‚£æ—¶å€™å®¶é‡Œé¢ä¹ŸæŒºå¿™çš„ï¼Œçˆ¸çˆ¸æ²¡æœ‰è¿‡æ¥ï¼Œå¦ˆå¦ˆä¸€ä¸ªäººè¿‡æ¥äº†ï¼Œæˆ‘å½“æ—¶å¿ƒé‡Œç•¥æœ‰ç‚¹é—æ†¾ï¼Œè¿˜æƒ³ç€çˆ¸çˆ¸ä½ ä¹Ÿä¸æ¥ï¼Œé‚£å°±åªèƒ½çœ‹å¦ˆå¦ˆåœ¨è¿™ç©çš„ç…§ç‰‡äº†ï¼Œåªèƒ½æœ‰ç¾¡æ…•çš„ä»½äº†ã€‚å’Œå¦ˆå¦ˆé€›äº†æ·±åœ³çš„å‡ ä¸ªæ¯”è¾ƒå¥½ç©çš„åœ°æ–¹ï¼Œä¸–ç•Œä¹‹çª—ã€é”¦ç»£ä¸­åã€åŠ¨ç‰©å›­ã€æ·±åœ³æ¹¾å…¬å›­â€¦â€¦å¦ˆå¦ˆèµ°çš„é‚£å¤©ï¼Œå¦ˆå¦ˆå¾ˆå¼€å¿ƒï¼Œè§‰å¾—æˆ‘é•¿å¤§äº†ï¼Œå¯ä»¥è‡ªå·±é—¯è¡äº†ï¼Œåœ¨è¿™é‡Œå‘†äº†ä¸¤å‘¨ä¹Ÿæƒ³å›å®¶äº†ã€‚\né‚£æ¬¡çˆ¸çˆ¸æ²¡æœ‰æ¥ï¼Œæœ¬æ¥æˆ‘æƒ³ç€åé¢æœ‰çš„æ˜¯æœºä¼šï¼Œå¯æ²¡æƒ³åˆ°ç«Ÿç„¶æˆäº†æ°¸è¿œçš„é—æ†¾ã€‚17å¹´çˆ¸çˆ¸å°±èµ°äº†ï¼Œç—…ç—›æŠ˜ç£¨åœ°çˆ¶äº²ä¸è½»ï¼Œæˆ‘ç¬¬ä¸€æ¬¡è§‰å¾—ç”Ÿå‘½æ˜¯è„†å¼±çš„ï¼Œåˆæ˜¯åšå¼ºçš„ï¼Œç”Ÿå‘½æ˜¯çŸ­æš‚çš„ï¼Œåˆæ˜¯æ— é™çš„ï¼Œæ­£å¦‚æˆ‘çš„çˆ¶äº²èµ°äº†ï¼Œä½†æ˜¯ä»–æ°¸è¿œæ´»åœ¨æˆ‘å¿ƒé‡Œï¼Œç›´åˆ°æˆ‘ä¹Ÿç¦»å¼€ï¼Œç›´åˆ°è¿™äº›æ–‡å­—ä¸¢å¤±ï¼Œæ·¹æ²¡åœ¨äº’è”ç½‘ä¿¡æ¯çš„å¤§æµ·é‡Œã€‚\n2016å¹´10æœˆï¼Œç»„ç»‡æ¶æ„è°ƒæ•´ # é‚£å¤©æˆ‘å‘é«˜çƒ§ï¼Œè¯·äº†ä¸ªç—…å‡ï¼Œæ™šä¸Šå¯¼å¸ˆç»™æˆ‘ç”µè¯è¯´ï¼Œæˆ‘ä»¬ç»„ç»‡æ¶æ„è°ƒæ•´ï¼ŒæŠŠæˆ‘è°ƒåˆ°ä¸€ä¸ªæ–°çš„ç»„é‡Œé¢äº†ï¼Œæˆ‘æœ‰ç‚¹é”™æ„•ã€‚ä¸è¿‡ä¹Ÿè¿˜å¥½ï¼Œæ–°leaderã€ç»„å†…åŒäº‹ï¼Œéƒ½å¾ˆä¸é”™ï¼Œå·¥ä½œä¸Šå¯¹æˆ‘æŒ‡å¯¼éƒ½ä¸å°‘ï¼Œç‰¹åˆ«æ˜¯leaderï¼Œæ˜¯æˆ‘å­¦ä¹ è®¡ç®—æœºä»¥æ¥ï¼Œå°‘æœ‰çš„å‡ ä¸ªçœŸå¿ƒä½©æœçš„äººï¼Œä¸ç®¡æ˜¯é¢†å¯¼èƒ½åŠ›ï¼Œè¿˜æ˜¯æ²Ÿé€šã€æŠ€æœ¯ï¼Œéƒ½éå¸¸å€¼å¾—å­¦ä¹ ã€‚\n2017å¹´Xæœˆï¼Œæœ€ç—›è‹¦çš„ä¸€å¹´ # 2017å¹´ï¼Œæ˜¯æˆ‘ç»å†è¿‡çš„æœ€ç—›è‹¦çš„ä¸€å¹´ï¼Œæˆ‘æƒ³å¯èƒ½ä¹Ÿæ˜¯æˆ‘ä»¥åå‡ åå¹´ä¸­æœ€ç—›è‹¦çš„ä¸€å¹´ã€‚å¦‚æœäººçš„è®°å¿†å¯ä»¥åƒæ—¥å†é‚£æ ·ï¼Œç¿»æ¥ç¿»å»ï¼Œæˆ‘æ„¿æ„æ’•å»æˆ‘çš„2017å¹´ã€‚\n17å¹´æˆ‘çœ‹åˆ°çˆ¸çˆ¸è¢«ç—…é­”æŠ˜ç£¨ï¼Œçˆ¸çˆ¸èµ°åï¼Œå¤šå°‘æ¬¡åšæ¢¦ï¼Œä¸è®ºå‰é¢çš„æ•…äº‹å¤šå¥½ï¼Œæœ€åæ€»ä¼šå˜æˆçˆ¶äº²å“­ç€ä¸èˆç¦»å¼€çš„ç”»é¢ï¼Œä¸€æ¬¡åˆä¸€æ¬¡ä»æ¢¦é‡Œé†’æ¥ã€‚æˆ‘ä»¬å¹³æ—¥é‡Œæ—¢æ²¡æœ‰å•ç‹¬æ™’è¿‡æœ‹å‹åœˆï¼Œä¹Ÿæ²¡æœ‰ç•™ä¸‹å¤šå°‘ç…§ç‰‡ã€‚æˆ‘æ„Ÿè°¢Appleåˆ›é€ çš„live photosï¼Œè®©æˆ‘è¿˜èƒ½æœªæ¥å‡ åå¹´é—´ä¸€éåˆä¸€éåœ°çœ‹åˆ°çˆ¶äº²çš„éŸ³å®¹ç¬‘è²Œï¼Œæˆ‘çš„è®¾å¤‡é‡Œè¿˜æœ‰2æ®µçˆ¸çˆ¸çš„éŸ³é¢‘ï¼Œé‚£æ˜¯æˆ‘ä»…æœ‰çš„è´µé‡çš„ä¸œè¥¿ï¼Œæ‹…å¿ƒå®ƒä¸¢å¤±ï¼Œæ‰€æœ‰çš„è®¾å¤‡ã€ç§»åŠ¨ç¡¬ç›˜ã€äº‘å­˜å‚¨ã€å¾®ä¿¡ã€qqä¸­éƒ½åšäº†å¤‡ä»½ã€‚è¿™äº›ï¼Œå°±æ˜¯æˆ‘ä»…æœ‰çš„ä¸œè¥¿ï¼Œæ˜¯æˆ‘æœ€é‡è¦çš„ä¸œè¥¿â€¦â€¦å…¶ä»–çš„é’±ã€æˆ¿ã€è‚¡ç¥¨ï¼ŒI don\u0026rsquo;t care.\nçˆ¸çˆ¸çš„ç¦»å¼€ï¼Œå¯¹äºä»–æ¥è¯´ï¼Œæ˜¯ç§è§£è„±ï¼Œä½œä¸ºå„¿å­ï¼Œé¢å¯¹æˆ‘æ·±çˆ±ç€çš„çˆ¶äº²ï¼Œæˆ‘è¯´ä¸å‡ºä»»ä½•å®‰æ…°çš„è¯ï¼Œä»»ä½•å®‰æ…°çš„è¯éƒ½æ˜¾å¾—è‹ç™½æ— åŠ›ï¼Œä»»ä½•å®‰æ…°çš„è¯éƒ½æ˜¾å¾—æ˜¯å¯¹ç”Ÿå‘½çš„ä¸æ•¬ï¼Œæ›´ä½•å†µé‚£æ˜¯æˆ‘çš„çˆ¶äº²ï¼Œæˆ‘èƒ½åšçš„å°±æ˜¯é™ªåœ¨ä»–èº«æ—ï¼Œå‡è½»ä»–çš„ç–¼ç—›ã€æƒ³å¿µï¼Œä¹Ÿè®©ä»–æ”¾å¿ƒï¼Œè®©ä»–æ”¾å¿ƒæˆ‘ä¼šç…§é¡¾å¥½å¦ˆå¦ˆã€‚æœ€å¼€å§‹ï¼Œæˆ‘æƒ³ç€ï¼Œæˆ‘éœ€è¦æŒ£é’±ç»™çˆ¸çˆ¸æ²»ç—…ï¼Œé™ªçˆ¸çˆ¸åšäº†ç¬¬ä¸€æ¬¡æ‰‹æœ¯ä¼‘å…»äº†ä¸€å‘¨ï¼Œæ„Ÿè§‰å¥½åƒåœ¨å˜å¥½ã€‚æˆ‘å†…å¿ƒé‡Œå……æ»¡äº†å¸Œæœ›ï¼Œå›æ¥æ›´å–åŠ›çš„å·¥ä½œæŒ£é’±ã€‚è®©æˆ‘æ„Ÿè§‰åˆ°ç»æœ›çš„ä¸æ˜¯è‡ªå·±æ²¡å‡†å¤‡å¥½ï¼Œæ˜¯åœ¨æˆ‘å……æ»¡å¸Œæœ›çš„æ—¶å€™ï¼Œç°å®ä¸€æ¬¡æ¬¡çªç ´æˆ‘å¸Œæœ›çš„åº•çº¿ï¼Œä¸€æ¬¡åˆä¸€æ¬¡ï¼Œä»å……æ»¡å¸Œæœ›ï¼Œåˆ°æœ‰ä¸€ä¸ç‚¹å¸Œæœ›ï¼Œåˆ°æ²¡æœ‰å¸Œæœ›æƒ³å»è¯•ä¸€ä¸‹ï¼Œåˆ°æœ€åä¸æ„¿æ¥å—ä¸å¾—ä¸æ¥å—çš„äº‹å®çœŸç›¸â€¦â€¦\næˆ‘ä»å°åˆ°å¤§ï¼Œç¬¬ä¸€æ¬¡æ„Ÿè§‰é‚£ä¹ˆæŒ«è´¥ï¼Œæˆ‘æ²¡æœ‰èƒ½åŠ›æŒ½æ•‘çˆ¸çˆ¸ï¼Œè„‘æµ·é‡Œæ— æ•°æ¬¡é£˜è¿‡çˆ¶äº²ä¼šæ€æ ·ç¦»å¼€æˆ‘ä»¬ï¼Œæˆ‘ä»¥ä¸ºæˆ‘åšäº†æœ€åçš„æ‰“ç®—ï¼Œæˆ‘ä»¥ä¸ºæˆ‘å‡†å¤‡å¥½äº†ï¼Œäº‹å®ä¸Šæ²¡æœ‰ã€‚çˆ¸çˆ¸ï¼Œä¸€å®šå»äº†å¤©å ‚ï¼Œå¦‚æœçœŸçš„æœ‰å¤©å ‚ï¼Œæœ‰ä¸Šå¸ï¼Œä¸Šå¸ä¸€å®šä¼šè®©ä»–è¿™æ ·çš„å¥½äººå»å¤©å ‚ï¼å¤©å ‚ä¸å†æœ‰ç—›è‹¦ï¼\nä¸çŸ¥ä¸è§‰ä¸­ï¼Œæˆ‘çš„æ‰‹æœºå£çº¸å·²ç»3å¹´æ²¡æœ‰æ›´æ¢äº†ï¼3å¹´äº†ï¼ä»æ¥æ²¡æœ‰æ›´æ¢è¿‡ï¼æˆ‘å·²ç»ä¹ æƒ¯äº†æ¯æ¬¡æ‹¿å‡ºæ‰‹æœºï¼Œéƒ½å¯ä»¥çœ‹åˆ°çˆ¸çˆ¸ï¼Œæˆ‘å·²ç»ä¹ æƒ¯äº†é‚£ä¸ªæ‰‹æœºå·ç ï¼Œå¤šèŠ±äº†å‡ åƒå—é’±æŠŠçˆ¸çˆ¸çš„æ‰‹æœºå·ç è½¬åˆ°äº†è‡ªå·±åä¸‹ã€‚å®¶é‡Œçˆ¸çˆ¸ç”¨è¿‡çš„å·¥å…·ã€èººæ¤…ã€æ¨è½¦ã€æ‰³æ‰‹ç­‰ï¼Œä¹Ÿéƒ½æˆäº†æˆ‘è§†å¦‚ç”Ÿå‘½çš„é—äº§ã€‚æˆ‘ä¸æƒ³å®¶é‡Œæœ‰ä¸€ä¸ä¸€æ¯«çš„æ”¹å˜ï¼Œæœ€å¥½æ˜¯å°å­˜è¿™ä¸€åˆ‡ã€‚æœ‰äººè¯´æˆ‘è¿˜æ²¡èµ°å‡ºæ¥ï¼Œå…¶å®ä¸æ˜¯ï¼Œæˆ‘çš„å†…å¿ƒå¾ˆå¼ºå¤§ï¼Œæˆ‘åªæ˜¯é€‰æ‹©äº†ä¹ æƒ¯æœ‰çˆ¸çˆ¸çš„ç”Ÿæ´»ï¼Œè€Œä¸æ˜¯åƒå¤šæ•°äººä¸€æ ·æ‰”æ‰çƒ§æ‰æ¥æ·¡å¿˜ã€‚æˆ‘å¹¶æ²¡æœ‰å¾€è¿‡å»çš„ä¼¤å£ä¸Šæ’’ç›ï¼Œæˆ‘åªæ˜¯æƒ³è®©è¿™äº›ç–¤ç—•æ›´æ¸…æ™°ä¸€äº›ï¼Œæ¸…æ™°åˆ°æˆ‘çœ‹åˆ°æ‘¸åˆ°èº«è¾¹çš„ä¸œè¥¿æ—¶ï¼Œå°±å¯ä»¥ç½®èº«äº2017å¹´ä»¥å‰çš„æ—¶æ®µï¼Œé‚£é‡Œæœ‰æˆ‘ç†Ÿæ‚‰å¾—ä¸èƒ½å†ç†Ÿæ‚‰çš„çˆ¸çˆ¸ã€‚\nçˆ¸çˆ¸èµ°åï¼Œæˆ‘å˜æˆäº†å®¶é‡Œçš„é¡¶æ¢æŸ±ï¼Œæˆ‘ä¼šåŠªåŠ›ä¸¢æ‰å°æ€§å­ï¼Œæˆä¸ºä»–æœŸæœ›æˆ‘æˆä¸ºçš„æ ·å­ã€‚18å¹´æ˜¥èŠ‚å›åˆ°å®¶ï¼Œç¿»çœ‹çˆ¸çˆ¸ä»¥å‰çš„è®°è´¦æœ¬ï¼Œç¬¬ä¸€é¡µå†™ç€â€œå¹²å¹²å‡€å‡€åšäººï¼Œåˆ©åˆ©ç´¢ç´¢åšäº‹â€ï¼Œæœ´å®ä¸­é€æ¼å‡ºä»–çš„äººæ ¼ã€‚æˆ‘æ˜¯ä»–çš„å„¿å­ï¼Œé‚£ä¹Ÿæ˜¯æˆ‘çš„åº§å³é“­ï¼Œâ€œå ‚å ‚æ­£æ­£åšäººï¼Œè¸è¸å®å®åšäº‹â€ï¼Œè¿™æ˜¯06å¹´è¯»åˆä¸­æ—¶ï¼Œæˆ‘çš„ç‰©ç†è€å¸ˆå£æˆç»™æˆ‘çš„ï¼Œæˆ‘ä¸€ç›´å°åœ¨å¿ƒé‡Œã€‚æƒ³æƒ³ï¼Œä¹Ÿæ˜¯ç§ç¼˜åˆ†ï¼Œå¥½åƒ10æ¥å¹´åï¼Œæˆ‘å’Œçˆ¸çˆ¸ä¸€å¯¹æš—å·ï¼ŒåŸæ¥æ˜¯ä¸€æ ·çš„ï¼æœç„¶æ˜¯çˆ¶å­ä¿©ï¼\næ­¤åï¼Œä¹Ÿæ›´å…¨èº«å¿ƒåœ°æŠ•å…¥åˆ°äº†å·¥ä½œå½“ä¸­ï¼ŒåŠªåŠ›å·¥ä½œï¼ŒåŠªåŠ›æŒ£é’±ï¼Œç…§é¡¾å®¶äººï¼Œæˆ‘è§‰å¾—è‡ªå·±ç®—æ˜¯ç›¸å¯¹æ¯”è¾ƒåŠªåŠ›çš„äº†ï¼Œå¸Œæœ›çˆ¸çˆ¸åœ¨å¤©ä¹‹çµä¸ä¼šå¯¹æˆ‘å¤±æœ›ã€‚\n17å¹´ï¼Œæœ‰åŒäº‹å‚ä¸èµŒåšï¼Œæ‹†ä¸œå¢™è¡¥è¥¿å¢™ï¼Œå‘æˆ‘å€Ÿé’±ï¼Œç»“æœè¿˜æ²¡å¿è¿˜ä¸€åˆ†ï¼Œå°±è¢«å…¬å®‰å¸¦èµ°äº†ï¼Œè‡ªå·±æ‰å¾—çŸ¥çœŸç›¸ã€‚17å¹´å„ç§äº‹æƒ…ï¼Œå„ç§ä¸ç¡®å®šæ€§ä¸‹ï¼Œæˆ‘å†³å®šå…ˆä¹°å¥—æˆ¿åšä¸ªåè·¯ï¼Œç°åœ¨ä¹Ÿæ²¡å¢å€¼å¤šå°‘ï¼Œä¸è¿‡ä¹Ÿè¿˜å¯ä»¥ã€‚å€Ÿäº†å§¨å¦ˆã€å§å§ä»–ä»¬äº›é’±ï¼Œä¹Ÿéƒ½è¿˜æ¸…äº†ï¼Œæ²¡ä»€ä¹ˆå‹åŠ›äº†ã€‚ç°åœ¨ä¹Ÿé™†é™†ç»­ç»­åœ°æœ‰äº†ç§¯è“„ã€‚\n17å¹´ä¸‹åŠå¹´å°±æ˜¯åŠªåŠ›å·¥ä½œå§ï¼Œå°½åŠ›åšåˆ°å¯¹çš„èµ·é¢†å¯¼çš„æ ½åŸ¹ã€åŒäº‹è¿™æ®µæ—¶é—´çš„å¸®åŠ©ã€åŒ…å®¹ï¼Œæ„Ÿè°¢äº†ï¼\n2018å¹´Xæœˆ # è®¤çœŸå·¥ä½œï¼Œåšå¥½ä¸šåŠ¡+å­¦ä¹ æŠ€æœ¯ # ä¸ŠåŠå¹´ï¼Œä¹Ÿç®—æ˜¯è®¤è®¤çœŸçœŸçš„å·¥ä½œï¼Œè®¤çœŸåšå¥½äº§å“çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®¤çœŸç»´æŠ¤å¥½å¸¸ç”¨çš„ç®¡ç†åå°ï¼ŒåŒ…æ‹¬ç›¸å…³çš„åç«¯æ¡†æ¶jungle-adminçš„ç»´æŠ¤ã€å‰ç«¯ä½¿ç”¨ä½“éªŒçš„ä¼˜åŒ–ï¼Œæˆ‘è‡ªå·±è§‰å¾—è¿˜æ˜¯åšäº†äº›å·¥ä½œçš„ï¼Œæ–¹ä¾¿äº†å¤§å®¶çš„å¼€å‘æ•ˆç‡ï¼Œæå‡äº†ä½¿ç”¨ä½“éªŒã€‚\næˆ‘ä»¬leaderï¼ˆç°åœ¨å·²ç»æ˜¯æ€»ç›‘äº†ï¼‰ï¼Œå¯¹æŠ€æœ¯å¾ˆæœ‰é’»ç ”ï¼Œä¹Ÿå¾ˆæœ‰åˆ›æ–°èƒ½åŠ›ï¼Œç»å¸¸å¸¦é¢†æˆ‘ä»¬é«˜äº›æ¯”è¾ƒæœ‰å»ºè®¾æ€§çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æ¥å£æµ‹è¯•å·¥å…·ã€ä»£ç ç”Ÿæˆå·¥å…·ã€å¾®æœåŠ¡æ¡†æ¶è®¾è®¡å¼€å‘ç­‰ç­‰å§ï¼Œå¾ˆå¤šã€‚åœ¨è¿™æœŸé—´ï¼Œè‡ªå·±ä¹Ÿé”»ç‚¼äº†å¾ˆå¤šï¼Œæˆé•¿äº†å¾ˆå¤šã€‚å½“ç„¶ä¹Ÿå¾ˆå¼€å¿ƒï¼Œå­¦åˆ°ä¸œè¥¿å°±å¾ˆå¼€å¿ƒã€‚\nè¿™ä¸€æ¬¡ï¼Œæˆ‘æ”¶è·äº†æ¥è…¾è®¯åçš„ç¬¬ä¸€ä¸ªå››æ˜Ÿï¼Œå¾ˆå¼€å¿ƒã€‚\næ‹¥æŠ±å˜åŒ–ï¼ŒåŠ å…¥å†…å®¹å¹³å°ä¸­å¿ƒ # 18å¹´ä¸ŠåŠå¹´ï¼Œäº’åŠ¨è§†é¢‘ç›¸å…³çš„å»ºè®¾åŸºæœ¬æ¯”è¾ƒç¨³å®šäº†ï¼Œä¸šåŠ¡ä¸Šä¹Ÿæ²¡æœ‰é‚£ä¹ˆç´§å¼ äº†ï¼Œ7æœˆä»½ä¹‹åå§ï¼Œæˆ‘ä»¬åˆæ‹¥æŠ±å˜åŒ–ï¼ŒåŠ å…¥äº†å†…å®¹å¹³å°ä¸­å¿ƒæ¥æ”¯æŒä¿¡æ¯æµç›¸å…³çš„å†…å®¹ä¸­å°å»ºè®¾ï¼Œç›´åˆ°ç°åœ¨ã€‚",content:" img {width:680px;} video {width:680px;}  å†™åœ¨å‰é¢ # å¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡æœ‰æ›´æ–°ä¸ªäººåšå®¢äº†ï¼Œå›å¤´ä¸€çœ‹ç«Ÿç„¶æœ‰ä¸€å¹´æ²¡æ›´æ–°ï¼Œè¿™ä¸€å¹´å·¥ä½œä¸Šç¡®å®æ¯”ä»¥å‰å¿™äº†å¾ˆå¤šã€‚æœ‰ç‚¹æ—¶é—´ä¹Ÿæ‹¿æ¥ä½“éªŒç”Ÿæ´»ã€é’»ç ”æ„Ÿå…´è¶£çš„æŠ€æœ¯äº†ã€‚æ„Ÿå…´è¶£ä¹Ÿå¯ä»¥çœ‹ä¸‹æˆ‘çš„githubï¼Œè¿™ä¸€å¹´å‡ ä¹ä¹Ÿåœ¨ä¸åœåœ°æ¢ç´¢ã€å°è¯•ï¼Œå› ä¸ºå…´è¶£å’Œé‚£ä»½å¥½å¥‡ï¼Œè¿˜æœ‰å°±æ˜¯ï¼Œæƒ³åšç‚¹æœ‰æ·±åº¦çš„ä¸œè¥¿å–æ‚¦è‡ªå·±ã€‚\nè‡ªä»2016å¹´7æœˆä»½å…¥èŒè…¾è®¯ä»¥æ¥ï¼Œä¹Ÿç®—æ˜¯å‹¤å‹¤æ³æ³åœ°å·¥ä½œï¼Œè‡³å°‘ä¸è®©è‡ªå·±æˆä¸ºå›¢é˜Ÿçš„ç“¶é¢ˆå§ï¼Œäº‹å®ä¸Šåšçš„åº”è¯¥è¿˜å¯ä»¥å§ã€‚å½“ç„¶å’Œè‡ªå·±çš„å…´è¶£ã€é¢†å¯¼çš„æŒ‡ç‚¹ã€å·¥ä½œé¡¹çš„å®‰æ’ï¼Œä¹Ÿæœ‰å¯†åˆ‡çš„å…³ç³»ï¼Œç»å¤§éƒ¨åˆ†å·¥ä½œæ—¶é—´ï¼Œæˆ‘è¿˜æ˜¯æ¯”è¾ƒå¼€å¿ƒçš„ã€‚\nä»Šå¤©æ”¶æ‹¾æˆ¿é—´ï¼Œæ— æ„ä¸­å‘ç°äº†è…¾è®¯å­¦é™¢çš„ä¸€ä¸ªç¬”è®°æœ¬ï¼Œç¿»å¼€ä¸€çœ‹ï¼ŒåŸæ¥æ˜¯16å¹´åˆšå…¥èŒæ—¶åŸ¹è®­ç”¨çš„ææ–™ï¼Œé‡Œé¢è¿˜æœ‰è‡ªå·±çš„ç¬”è®°ï¼Œå­—è¿¹è¿˜æ¸…æ™°ï¼Œç®—ä¸ä¸Šå¤ªå·¥æ•´ã€‚ç¿»å¼€æ–°çš„ä¸€é¡µï¼Œå¿ä¸ä½æƒ³å†™ç‚¹ä»€ä¹ˆï¼Œæœ‰æ„Ÿæ¿€ï¼Œæœ‰æ¬£èµï¼Œæœ‰éƒé—·ï¼Œä¹Ÿæœ‰è´¨ç–‘ï¼Œæœ€åç«Ÿä¹Ÿæ— æ³•è½ç¬”ã€‚\n2016å¹´7æœˆï¼Œæˆ‘å…¥èŒäº† # æœ€æ—©æƒ³æ¥è…¾è®¯è¿˜æ˜¯ä¸€æ¬¡å®ä¹ ç”Ÿæ‹›è˜ä¼šä¸Šï¼Œè‡ªå·±ä¹Ÿæ²¡æœ‰å‡†å¤‡ï¼Œå°±å¤§å¤§å’§å’§å»äº†ï¼Œç»“æœæŒ‚äº†ã€‚é¢è¯•å®˜æˆ‘æ„Ÿè§‰è¿˜ç®—æ¯”è¾ƒä¸“ä¸šå§ï¼Œå½“æ—¶å°±æƒ³ç€æ¯•ä¸šåå»è…¾è®¯é”»ç‚¼ä¸‹å§ã€‚æ ¡æ‹›å­£ï¼Œè‡ªå·±ä¹Ÿæ²¡æ€ä¹ˆè®¤çœŸå‡†å¤‡ï¼Œä½†æ˜¯è¿˜æ˜¯æ‹¿äº†å¥½å‡ ä¸ªofferï¼Œæ–°æµªï¼ˆSPï¼Ÿé¢è¯•å®˜å¾ˆå–œæ¬¢æˆ‘è¿˜æ„¿æ„æ›¿æˆ‘å’ŒHRæ²Ÿé€šè–ªèµ„ï¼Œæœ€ç»ˆå› ä¸ºæ–°æµªå‘offerå¤ªæ…¢æ²¡å»ï¼‰ã€å»å“ªå„¿ï¼ˆSPï¼Ÿå½“å¤©ç»™çš„offerï¼Œä¸å¤ªæƒ³å»åŒ—äº¬æœ€åæ²¡å»ï¼‰ã€é˜¿é‡Œå¤©çŒ«ï¼ˆæ²¡è®¤çœŸå‡†å¤‡ï¼Œç»™äº†ä¸ªB+ï¼Œè¢«å„ç§å¯’é…¸æœ€åæ²¡å»ï¼‰ã€åä¸ºï¼ˆæˆ‘å°±æ˜¯æƒ³å»æå†…æ ¸ï¼Œå‡­å­¦ä¹ èƒ½åŠ›åº”è¯¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯å»äº†ä¼°è®¡ä¹Ÿä¸æ˜¯è¿™ä¸ªæ–¹å‘ï¼Œæ²¡å»ï¼‰\u0026hellip;æœ€åæˆ‘æƒ³åˆ°è…¾è®¯ä¸Šæ¬¡å®ä¹ ç»™æˆ‘æŒ‚äº†ï¼Œåœ¨è…¾è®¯æ ¡æ‹›è¡¥å½•é˜¶æ®µçš„æ—¶å€™è¿‡äº†ï¼ˆSPï¼‰ã€‚\næˆ‘ä¹Ÿä¸çŸ¥é“å½“åˆé¢è¿™ä¹ˆå¤šæ˜¯ä¸ºäº†ä»€ä¹ˆï¼Œåªæ˜¯æƒ³è¯æ˜ä¸‹è‡ªå·±å¯ä»¥é€šè¿‡æŸäº›å…¬å¸çš„é¢è¯•ï¼Ÿå¯èƒ½å§ï¼Œäººç¼ºä¹è‡ªä¿¡çš„æ—¶å€™ï¼Œå°±å®¹æ˜“åšè¿™äº›å‚»äº‹ï¼Œæ€»æ˜¯å¸Œæœ›ä»åˆ«äººå£ä¸­çš„è¯„ä»·æ¥è®¤è¯†è‡ªå·±ã€‚\nå…¥èŒä¹‹å‰ï¼Œæˆ‘é—®æ—©è¿›æ¥çš„åŒå­¦ï¼Œæ­£å¼å…¥èŒé‚£å¤©ï¼Œæˆ‘éœ€è¦ç©¿æ­£è£…å—ï¼Ÿç»“æœå½“å¤©æ¥çš„æ—¶å€™å‘ç°æœ‰äº›äººç­‰ç”µæ¢¯çš„æ—¶å€™ï¼Œç©¿æ‹–é‹çš„å°å“¥ï¼Œä¸ºäº†å‡‰å¿«ï¼Œç›´æ¥æŠŠè„šè¸©åœ°ä¸Šã€‚æš—è‡ªåº†å¹¸ï¼Œç©¿æ­£è£…æ¥äº†åè€Œæ˜¯ä¸ªå¦ç±»ã€‚\n 2016.7.24 å…¥èŒ+ç ´å†° 2016.7.25 å¼€ç­å…¸ç¤¼ + \u0026ldquo;è…¾è®¯ç”¨æˆ·å¯¼å‘\u0026quot;åŸ¹è®­ 2016.7.26 èµ°è¿›è…¾è®¯ä¸è…¾è®¯æ–‡åŒ– \u0026hellip;  åå‡ å¤©çš„å°åŸ¹ï¼Œè®¤è¯†äº†å¾ˆå¤šåŒäº‹ï¼Œä¹Ÿå¤§æ¦‚äº†è§£äº†è…¾è®¯çš„ä¸€äº›æ–‡åŒ–ã€å·¥ä½œæ–¹å¼ï¼Œè¿™æœŸé—´åƒçš„ä¹Ÿä¸é”™ï¼Œæˆ‘è¿˜æƒ³ä¼šä¸ä¼šæˆ‘è¿™å¸¸å¹´120æ–¤çš„ä½“é‡ä¹Ÿå¯ä»¥å¢é‡ä¸‹äº†ã€‚\nå°åŸ¹ç»“æŸæ—¶ï¼Œä¹Ÿæœ‰éƒ¨åˆ†æ€»åŠé¢†å¯¼æ¥å‚åŠ äº†é—­å¹•å¼ï¼Œè¿˜è·³äº†ä¸€æ®µã€‚å½“æ—¶æˆ‘è§‰å¾—é¢†å¯¼å’Œä¸€çº¿å·¥ä½œäººå‘˜èƒ½è¿™ä¹ˆäº’åŠ¨ï¼Œåº”è¯¥å·¥ä½œæ°›å›´å¾ˆä¸é”™ï¼Œåº”è¯¥å¾ˆæœ‰æ´»åŠ›ï¼Œå½“æ—¶å¯¹è…¾è®¯æœ‰å¾ˆé«˜çš„æœŸæœ›å€¼ï¼Œè‡ªå·±ä¹Ÿæ„¿æ„åŠ å…¥å…¶ä¸­ï¼Œè´¡çŒ®ä¸€ç‚¹åŠ›é‡ã€‚\nYour browser doesn't support the video tag.  2016å¹´8æœˆï¼Œæ¥åˆ°ç»„ç»‡ # å°åŸ¹ç»“æŸåï¼Œæ¥åˆ°å½“æ—¶çš„å³é€šåº”ç”¨éƒ¨/äº’åŠ¨è§†é¢‘äº§å“éƒ¨ï¼Œæˆ‘å°±æˆäº†è¿™é‡Œçš„ä¸€ååå°å¼€å‘ï¼Œå¼€å§‹å†™è‡ªå·±çš„ä»£ç ã€‚å½“æ—¶æˆ‘çš„å¯¼å¸ˆç£Šå“¥ï¼Œå¯¹æˆ‘è¿˜æ˜¯æŒºç…§é¡¾çš„ï¼Œè¿˜æœ‰leaderï¼Œå‘¨å›´çš„å°ä¼™ä¼´ï¼Œä»–ä»¬çš„å¸®åŠ©ä¸‹ï¼Œæˆ‘å¿«é€Ÿèå…¥äº†å›¢é˜Ÿã€‚ä¸è¿‡å˜›ï¼Œæˆ‘æ¥äº†å¿«ä¸€å‘¨çš„æ—¶å€™ï¼Œå°±å¿ä¸ä½æƒ³åæ§½ï¼Œå½“æ—¶åšä¸ªæ¶ˆæ¯æ¨é€çš„å·¥å…·ï¼Œè°ƒç”¨çš„APIç«Ÿç„¶è¿ä¸ªæ–‡æ¡£è¯´æ˜ä¹Ÿæ²¡æœ‰ã€‚æˆ‘æ˜¯æ¯”è¾ƒå–œæ¬¢å†™æ–‡æ¡£çš„ï¼Œä¸€ä¸ªæ˜¯æ¯”è¾ƒä¸“ä¸šï¼Œä¸€ä¸ªæ˜¯èƒ½å‡å°‘ä¸å¿…è¦çš„æ²Ÿé€šï¼Œä½•ä¹è€Œä¸ä¸ºã€‚å…³é”®å½“æ—¶çš„APIçš„è´Ÿè´£äººè¿˜è´¼éš¾æ²Ÿé€šï¼Œæˆ‘ä¹Ÿæ˜¯æœæ°”ï¼Œä»é‚£å¼€å§‹ï¼Œå°±é™†é™†ç»­ç»­åœ°è®¤è¯†äº†çœŸå®çš„è…¾è®¯ï¼Œè¤’è´¬å‚åŠï¼Œæ¯”è¾ƒçœŸå®ã€‚\n2016å¹´10æœˆï¼Œé‚€çˆ¶æ¯æ¥æ·±åœ³ç© # æˆ‘ä¸œè¥¿å·®ä¸å¤šå‡†å¤‡å¥½äº†ä¹‹åï¼Œè‡ªå·±ä¹Ÿå¼€å§‹æŒ£é’±äº†ï¼Œæƒ³ç€çˆ¶æ¯ä¸€ç›´å‹¤å‹¤æ³æ³å·¥ä½œï¼Œä¾›æˆ‘ä¸Šå­¦å·¥ä½œï¼Œç°åœ¨å¯ä»¥è¯·ä»–ä»¬æ¥æ·±åœ³ç©ç©ï¼Œä»¥å‰çˆ¶æ¯ä¹Ÿæ²¡æœ‰èˆå¾—å‡ºå»ç©è¿‡ã€‚æˆ‘å†…å¿ƒé‡Œæ˜¯ç‰¹åˆ«å¸Œæœ›ä»–ä»¬å‡ºæ¥èµ°èµ°çš„ï¼Œæˆ‘ä¹Ÿå°½å°½å­å¿ƒã€‚\né‚£æ—¶å€™å®¶é‡Œé¢ä¹ŸæŒºå¿™çš„ï¼Œçˆ¸çˆ¸æ²¡æœ‰è¿‡æ¥ï¼Œå¦ˆå¦ˆä¸€ä¸ªäººè¿‡æ¥äº†ï¼Œæˆ‘å½“æ—¶å¿ƒé‡Œç•¥æœ‰ç‚¹é—æ†¾ï¼Œè¿˜æƒ³ç€çˆ¸çˆ¸ä½ ä¹Ÿä¸æ¥ï¼Œé‚£å°±åªèƒ½çœ‹å¦ˆå¦ˆåœ¨è¿™ç©çš„ç…§ç‰‡äº†ï¼Œåªèƒ½æœ‰ç¾¡æ…•çš„ä»½äº†ã€‚å’Œå¦ˆå¦ˆé€›äº†æ·±åœ³çš„å‡ ä¸ªæ¯”è¾ƒå¥½ç©çš„åœ°æ–¹ï¼Œä¸–ç•Œä¹‹çª—ã€é”¦ç»£ä¸­åã€åŠ¨ç‰©å›­ã€æ·±åœ³æ¹¾å…¬å›­â€¦â€¦å¦ˆå¦ˆèµ°çš„é‚£å¤©ï¼Œå¦ˆå¦ˆå¾ˆå¼€å¿ƒï¼Œè§‰å¾—æˆ‘é•¿å¤§äº†ï¼Œå¯ä»¥è‡ªå·±é—¯è¡äº†ï¼Œåœ¨è¿™é‡Œå‘†äº†ä¸¤å‘¨ä¹Ÿæƒ³å›å®¶äº†ã€‚\né‚£æ¬¡çˆ¸çˆ¸æ²¡æœ‰æ¥ï¼Œæœ¬æ¥æˆ‘æƒ³ç€åé¢æœ‰çš„æ˜¯æœºä¼šï¼Œå¯æ²¡æƒ³åˆ°ç«Ÿç„¶æˆäº†æ°¸è¿œçš„é—æ†¾ã€‚17å¹´çˆ¸çˆ¸å°±èµ°äº†ï¼Œç—…ç—›æŠ˜ç£¨åœ°çˆ¶äº²ä¸è½»ï¼Œæˆ‘ç¬¬ä¸€æ¬¡è§‰å¾—ç”Ÿå‘½æ˜¯è„†å¼±çš„ï¼Œåˆæ˜¯åšå¼ºçš„ï¼Œç”Ÿå‘½æ˜¯çŸ­æš‚çš„ï¼Œåˆæ˜¯æ— é™çš„ï¼Œæ­£å¦‚æˆ‘çš„çˆ¶äº²èµ°äº†ï¼Œä½†æ˜¯ä»–æ°¸è¿œæ´»åœ¨æˆ‘å¿ƒé‡Œï¼Œç›´åˆ°æˆ‘ä¹Ÿç¦»å¼€ï¼Œç›´åˆ°è¿™äº›æ–‡å­—ä¸¢å¤±ï¼Œæ·¹æ²¡åœ¨äº’è”ç½‘ä¿¡æ¯çš„å¤§æµ·é‡Œã€‚\n2016å¹´10æœˆï¼Œç»„ç»‡æ¶æ„è°ƒæ•´ # é‚£å¤©æˆ‘å‘é«˜çƒ§ï¼Œè¯·äº†ä¸ªç—…å‡ï¼Œæ™šä¸Šå¯¼å¸ˆç»™æˆ‘ç”µè¯è¯´ï¼Œæˆ‘ä»¬ç»„ç»‡æ¶æ„è°ƒæ•´ï¼ŒæŠŠæˆ‘è°ƒåˆ°ä¸€ä¸ªæ–°çš„ç»„é‡Œé¢äº†ï¼Œæˆ‘æœ‰ç‚¹é”™æ„•ã€‚ä¸è¿‡ä¹Ÿè¿˜å¥½ï¼Œæ–°leaderã€ç»„å†…åŒäº‹ï¼Œéƒ½å¾ˆä¸é”™ï¼Œå·¥ä½œä¸Šå¯¹æˆ‘æŒ‡å¯¼éƒ½ä¸å°‘ï¼Œç‰¹åˆ«æ˜¯leaderï¼Œæ˜¯æˆ‘å­¦ä¹ è®¡ç®—æœºä»¥æ¥ï¼Œå°‘æœ‰çš„å‡ ä¸ªçœŸå¿ƒä½©æœçš„äººï¼Œä¸ç®¡æ˜¯é¢†å¯¼èƒ½åŠ›ï¼Œè¿˜æ˜¯æ²Ÿé€šã€æŠ€æœ¯ï¼Œéƒ½éå¸¸å€¼å¾—å­¦ä¹ ã€‚\n2017å¹´Xæœˆï¼Œæœ€ç—›è‹¦çš„ä¸€å¹´ # 2017å¹´ï¼Œæ˜¯æˆ‘ç»å†è¿‡çš„æœ€ç—›è‹¦çš„ä¸€å¹´ï¼Œæˆ‘æƒ³å¯èƒ½ä¹Ÿæ˜¯æˆ‘ä»¥åå‡ åå¹´ä¸­æœ€ç—›è‹¦çš„ä¸€å¹´ã€‚å¦‚æœäººçš„è®°å¿†å¯ä»¥åƒæ—¥å†é‚£æ ·ï¼Œç¿»æ¥ç¿»å»ï¼Œæˆ‘æ„¿æ„æ’•å»æˆ‘çš„2017å¹´ã€‚\n17å¹´æˆ‘çœ‹åˆ°çˆ¸çˆ¸è¢«ç—…é­”æŠ˜ç£¨ï¼Œçˆ¸çˆ¸èµ°åï¼Œå¤šå°‘æ¬¡åšæ¢¦ï¼Œä¸è®ºå‰é¢çš„æ•…äº‹å¤šå¥½ï¼Œæœ€åæ€»ä¼šå˜æˆçˆ¶äº²å“­ç€ä¸èˆç¦»å¼€çš„ç”»é¢ï¼Œä¸€æ¬¡åˆä¸€æ¬¡ä»æ¢¦é‡Œé†’æ¥ã€‚æˆ‘ä»¬å¹³æ—¥é‡Œæ—¢æ²¡æœ‰å•ç‹¬æ™’è¿‡æœ‹å‹åœˆï¼Œä¹Ÿæ²¡æœ‰ç•™ä¸‹å¤šå°‘ç…§ç‰‡ã€‚æˆ‘æ„Ÿè°¢Appleåˆ›é€ çš„live photosï¼Œè®©æˆ‘è¿˜èƒ½æœªæ¥å‡ åå¹´é—´ä¸€éåˆä¸€éåœ°çœ‹åˆ°çˆ¶äº²çš„éŸ³å®¹ç¬‘è²Œï¼Œæˆ‘çš„è®¾å¤‡é‡Œè¿˜æœ‰2æ®µçˆ¸çˆ¸çš„éŸ³é¢‘ï¼Œé‚£æ˜¯æˆ‘ä»…æœ‰çš„è´µé‡çš„ä¸œè¥¿ï¼Œæ‹…å¿ƒå®ƒä¸¢å¤±ï¼Œæ‰€æœ‰çš„è®¾å¤‡ã€ç§»åŠ¨ç¡¬ç›˜ã€äº‘å­˜å‚¨ã€å¾®ä¿¡ã€qqä¸­éƒ½åšäº†å¤‡ä»½ã€‚è¿™äº›ï¼Œå°±æ˜¯æˆ‘ä»…æœ‰çš„ä¸œè¥¿ï¼Œæ˜¯æˆ‘æœ€é‡è¦çš„ä¸œè¥¿â€¦â€¦å…¶ä»–çš„é’±ã€æˆ¿ã€è‚¡ç¥¨ï¼ŒI don\u0026rsquo;t care.\nçˆ¸çˆ¸çš„ç¦»å¼€ï¼Œå¯¹äºä»–æ¥è¯´ï¼Œæ˜¯ç§è§£è„±ï¼Œä½œä¸ºå„¿å­ï¼Œé¢å¯¹æˆ‘æ·±çˆ±ç€çš„çˆ¶äº²ï¼Œæˆ‘è¯´ä¸å‡ºä»»ä½•å®‰æ…°çš„è¯ï¼Œä»»ä½•å®‰æ…°çš„è¯éƒ½æ˜¾å¾—è‹ç™½æ— åŠ›ï¼Œä»»ä½•å®‰æ…°çš„è¯éƒ½æ˜¾å¾—æ˜¯å¯¹ç”Ÿå‘½çš„ä¸æ•¬ï¼Œæ›´ä½•å†µé‚£æ˜¯æˆ‘çš„çˆ¶äº²ï¼Œæˆ‘èƒ½åšçš„å°±æ˜¯é™ªåœ¨ä»–èº«æ—ï¼Œå‡è½»ä»–çš„ç–¼ç—›ã€æƒ³å¿µï¼Œä¹Ÿè®©ä»–æ”¾å¿ƒï¼Œè®©ä»–æ”¾å¿ƒæˆ‘ä¼šç…§é¡¾å¥½å¦ˆå¦ˆã€‚æœ€å¼€å§‹ï¼Œæˆ‘æƒ³ç€ï¼Œæˆ‘éœ€è¦æŒ£é’±ç»™çˆ¸çˆ¸æ²»ç—…ï¼Œé™ªçˆ¸çˆ¸åšäº†ç¬¬ä¸€æ¬¡æ‰‹æœ¯ä¼‘å…»äº†ä¸€å‘¨ï¼Œæ„Ÿè§‰å¥½åƒåœ¨å˜å¥½ã€‚æˆ‘å†…å¿ƒé‡Œå……æ»¡äº†å¸Œæœ›ï¼Œå›æ¥æ›´å–åŠ›çš„å·¥ä½œæŒ£é’±ã€‚è®©æˆ‘æ„Ÿè§‰åˆ°ç»æœ›çš„ä¸æ˜¯è‡ªå·±æ²¡å‡†å¤‡å¥½ï¼Œæ˜¯åœ¨æˆ‘å……æ»¡å¸Œæœ›çš„æ—¶å€™ï¼Œç°å®ä¸€æ¬¡æ¬¡çªç ´æˆ‘å¸Œæœ›çš„åº•çº¿ï¼Œä¸€æ¬¡åˆä¸€æ¬¡ï¼Œä»å……æ»¡å¸Œæœ›ï¼Œåˆ°æœ‰ä¸€ä¸ç‚¹å¸Œæœ›ï¼Œåˆ°æ²¡æœ‰å¸Œæœ›æƒ³å»è¯•ä¸€ä¸‹ï¼Œåˆ°æœ€åä¸æ„¿æ¥å—ä¸å¾—ä¸æ¥å—çš„äº‹å®çœŸç›¸â€¦â€¦\næˆ‘ä»å°åˆ°å¤§ï¼Œç¬¬ä¸€æ¬¡æ„Ÿè§‰é‚£ä¹ˆæŒ«è´¥ï¼Œæˆ‘æ²¡æœ‰èƒ½åŠ›æŒ½æ•‘çˆ¸çˆ¸ï¼Œè„‘æµ·é‡Œæ— æ•°æ¬¡é£˜è¿‡çˆ¶äº²ä¼šæ€æ ·ç¦»å¼€æˆ‘ä»¬ï¼Œæˆ‘ä»¥ä¸ºæˆ‘åšäº†æœ€åçš„æ‰“ç®—ï¼Œæˆ‘ä»¥ä¸ºæˆ‘å‡†å¤‡å¥½äº†ï¼Œäº‹å®ä¸Šæ²¡æœ‰ã€‚çˆ¸çˆ¸ï¼Œä¸€å®šå»äº†å¤©å ‚ï¼Œå¦‚æœçœŸçš„æœ‰å¤©å ‚ï¼Œæœ‰ä¸Šå¸ï¼Œä¸Šå¸ä¸€å®šä¼šè®©ä»–è¿™æ ·çš„å¥½äººå»å¤©å ‚ï¼å¤©å ‚ä¸å†æœ‰ç—›è‹¦ï¼\nä¸çŸ¥ä¸è§‰ä¸­ï¼Œæˆ‘çš„æ‰‹æœºå£çº¸å·²ç»3å¹´æ²¡æœ‰æ›´æ¢äº†ï¼3å¹´äº†ï¼ä»æ¥æ²¡æœ‰æ›´æ¢è¿‡ï¼æˆ‘å·²ç»ä¹ æƒ¯äº†æ¯æ¬¡æ‹¿å‡ºæ‰‹æœºï¼Œéƒ½å¯ä»¥çœ‹åˆ°çˆ¸çˆ¸ï¼Œæˆ‘å·²ç»ä¹ æƒ¯äº†é‚£ä¸ªæ‰‹æœºå·ç ï¼Œå¤šèŠ±äº†å‡ åƒå—é’±æŠŠçˆ¸çˆ¸çš„æ‰‹æœºå·ç è½¬åˆ°äº†è‡ªå·±åä¸‹ã€‚å®¶é‡Œçˆ¸çˆ¸ç”¨è¿‡çš„å·¥å…·ã€èººæ¤…ã€æ¨è½¦ã€æ‰³æ‰‹ç­‰ï¼Œä¹Ÿéƒ½æˆäº†æˆ‘è§†å¦‚ç”Ÿå‘½çš„é—äº§ã€‚æˆ‘ä¸æƒ³å®¶é‡Œæœ‰ä¸€ä¸ä¸€æ¯«çš„æ”¹å˜ï¼Œæœ€å¥½æ˜¯å°å­˜è¿™ä¸€åˆ‡ã€‚æœ‰äººè¯´æˆ‘è¿˜æ²¡èµ°å‡ºæ¥ï¼Œå…¶å®ä¸æ˜¯ï¼Œæˆ‘çš„å†…å¿ƒå¾ˆå¼ºå¤§ï¼Œæˆ‘åªæ˜¯é€‰æ‹©äº†ä¹ æƒ¯æœ‰çˆ¸çˆ¸çš„ç”Ÿæ´»ï¼Œè€Œä¸æ˜¯åƒå¤šæ•°äººä¸€æ ·æ‰”æ‰çƒ§æ‰æ¥æ·¡å¿˜ã€‚æˆ‘å¹¶æ²¡æœ‰å¾€è¿‡å»çš„ä¼¤å£ä¸Šæ’’ç›ï¼Œæˆ‘åªæ˜¯æƒ³è®©è¿™äº›ç–¤ç—•æ›´æ¸…æ™°ä¸€äº›ï¼Œæ¸…æ™°åˆ°æˆ‘çœ‹åˆ°æ‘¸åˆ°èº«è¾¹çš„ä¸œè¥¿æ—¶ï¼Œå°±å¯ä»¥ç½®èº«äº2017å¹´ä»¥å‰çš„æ—¶æ®µï¼Œé‚£é‡Œæœ‰æˆ‘ç†Ÿæ‚‰å¾—ä¸èƒ½å†ç†Ÿæ‚‰çš„çˆ¸çˆ¸ã€‚\nçˆ¸çˆ¸èµ°åï¼Œæˆ‘å˜æˆäº†å®¶é‡Œçš„é¡¶æ¢æŸ±ï¼Œæˆ‘ä¼šåŠªåŠ›ä¸¢æ‰å°æ€§å­ï¼Œæˆä¸ºä»–æœŸæœ›æˆ‘æˆä¸ºçš„æ ·å­ã€‚18å¹´æ˜¥èŠ‚å›åˆ°å®¶ï¼Œç¿»çœ‹çˆ¸çˆ¸ä»¥å‰çš„è®°è´¦æœ¬ï¼Œç¬¬ä¸€é¡µå†™ç€â€œå¹²å¹²å‡€å‡€åšäººï¼Œåˆ©åˆ©ç´¢ç´¢åšäº‹â€ï¼Œæœ´å®ä¸­é€æ¼å‡ºä»–çš„äººæ ¼ã€‚æˆ‘æ˜¯ä»–çš„å„¿å­ï¼Œé‚£ä¹Ÿæ˜¯æˆ‘çš„åº§å³é“­ï¼Œâ€œå ‚å ‚æ­£æ­£åšäººï¼Œè¸è¸å®å®åšäº‹â€ï¼Œè¿™æ˜¯06å¹´è¯»åˆä¸­æ—¶ï¼Œæˆ‘çš„ç‰©ç†è€å¸ˆå£æˆç»™æˆ‘çš„ï¼Œæˆ‘ä¸€ç›´å°åœ¨å¿ƒé‡Œã€‚æƒ³æƒ³ï¼Œä¹Ÿæ˜¯ç§ç¼˜åˆ†ï¼Œå¥½åƒ10æ¥å¹´åï¼Œæˆ‘å’Œçˆ¸çˆ¸ä¸€å¯¹æš—å·ï¼ŒåŸæ¥æ˜¯ä¸€æ ·çš„ï¼æœç„¶æ˜¯çˆ¶å­ä¿©ï¼\næ­¤åï¼Œä¹Ÿæ›´å…¨èº«å¿ƒåœ°æŠ•å…¥åˆ°äº†å·¥ä½œå½“ä¸­ï¼ŒåŠªåŠ›å·¥ä½œï¼ŒåŠªåŠ›æŒ£é’±ï¼Œç…§é¡¾å®¶äººï¼Œæˆ‘è§‰å¾—è‡ªå·±ç®—æ˜¯ç›¸å¯¹æ¯”è¾ƒåŠªåŠ›çš„äº†ï¼Œå¸Œæœ›çˆ¸çˆ¸åœ¨å¤©ä¹‹çµä¸ä¼šå¯¹æˆ‘å¤±æœ›ã€‚\n17å¹´ï¼Œæœ‰åŒäº‹å‚ä¸èµŒåšï¼Œæ‹†ä¸œå¢™è¡¥è¥¿å¢™ï¼Œå‘æˆ‘å€Ÿé’±ï¼Œç»“æœè¿˜æ²¡å¿è¿˜ä¸€åˆ†ï¼Œå°±è¢«å…¬å®‰å¸¦èµ°äº†ï¼Œè‡ªå·±æ‰å¾—çŸ¥çœŸç›¸ã€‚17å¹´å„ç§äº‹æƒ…ï¼Œå„ç§ä¸ç¡®å®šæ€§ä¸‹ï¼Œæˆ‘å†³å®šå…ˆä¹°å¥—æˆ¿åšä¸ªåè·¯ï¼Œç°åœ¨ä¹Ÿæ²¡å¢å€¼å¤šå°‘ï¼Œä¸è¿‡ä¹Ÿè¿˜å¯ä»¥ã€‚å€Ÿäº†å§¨å¦ˆã€å§å§ä»–ä»¬äº›é’±ï¼Œä¹Ÿéƒ½è¿˜æ¸…äº†ï¼Œæ²¡ä»€ä¹ˆå‹åŠ›äº†ã€‚ç°åœ¨ä¹Ÿé™†é™†ç»­ç»­åœ°æœ‰äº†ç§¯è“„ã€‚\n17å¹´ä¸‹åŠå¹´å°±æ˜¯åŠªåŠ›å·¥ä½œå§ï¼Œå°½åŠ›åšåˆ°å¯¹çš„èµ·é¢†å¯¼çš„æ ½åŸ¹ã€åŒäº‹è¿™æ®µæ—¶é—´çš„å¸®åŠ©ã€åŒ…å®¹ï¼Œæ„Ÿè°¢äº†ï¼\n2018å¹´Xæœˆ # è®¤çœŸå·¥ä½œï¼Œåšå¥½ä¸šåŠ¡+å­¦ä¹ æŠ€æœ¯ # ä¸ŠåŠå¹´ï¼Œä¹Ÿç®—æ˜¯è®¤è®¤çœŸçœŸçš„å·¥ä½œï¼Œè®¤çœŸåšå¥½äº§å“çš„ä¸šåŠ¡éœ€æ±‚ï¼Œè®¤çœŸç»´æŠ¤å¥½å¸¸ç”¨çš„ç®¡ç†åå°ï¼ŒåŒ…æ‹¬ç›¸å…³çš„åç«¯æ¡†æ¶jungle-adminçš„ç»´æŠ¤ã€å‰ç«¯ä½¿ç”¨ä½“éªŒçš„ä¼˜åŒ–ï¼Œæˆ‘è‡ªå·±è§‰å¾—è¿˜æ˜¯åšäº†äº›å·¥ä½œçš„ï¼Œæ–¹ä¾¿äº†å¤§å®¶çš„å¼€å‘æ•ˆç‡ï¼Œæå‡äº†ä½¿ç”¨ä½“éªŒã€‚\næˆ‘ä»¬leaderï¼ˆç°åœ¨å·²ç»æ˜¯æ€»ç›‘äº†ï¼‰ï¼Œå¯¹æŠ€æœ¯å¾ˆæœ‰é’»ç ”ï¼Œä¹Ÿå¾ˆæœ‰åˆ›æ–°èƒ½åŠ›ï¼Œç»å¸¸å¸¦é¢†æˆ‘ä»¬é«˜äº›æ¯”è¾ƒæœ‰å»ºè®¾æ€§çš„ä¸œè¥¿ï¼Œæ¯”å¦‚æ¥å£æµ‹è¯•å·¥å…·ã€ä»£ç ç”Ÿæˆå·¥å…·ã€å¾®æœåŠ¡æ¡†æ¶è®¾è®¡å¼€å‘ç­‰ç­‰å§ï¼Œå¾ˆå¤šã€‚åœ¨è¿™æœŸé—´ï¼Œè‡ªå·±ä¹Ÿé”»ç‚¼äº†å¾ˆå¤šï¼Œæˆé•¿äº†å¾ˆå¤šã€‚å½“ç„¶ä¹Ÿå¾ˆå¼€å¿ƒï¼Œå­¦åˆ°ä¸œè¥¿å°±å¾ˆå¼€å¿ƒã€‚\nè¿™ä¸€æ¬¡ï¼Œæˆ‘æ”¶è·äº†æ¥è…¾è®¯åçš„ç¬¬ä¸€ä¸ªå››æ˜Ÿï¼Œå¾ˆå¼€å¿ƒã€‚\næ‹¥æŠ±å˜åŒ–ï¼ŒåŠ å…¥å†…å®¹å¹³å°ä¸­å¿ƒ # 18å¹´ä¸ŠåŠå¹´ï¼Œäº’åŠ¨è§†é¢‘ç›¸å…³çš„å»ºè®¾åŸºæœ¬æ¯”è¾ƒç¨³å®šäº†ï¼Œä¸šåŠ¡ä¸Šä¹Ÿæ²¡æœ‰é‚£ä¹ˆç´§å¼ äº†ï¼Œ7æœˆä»½ä¹‹åå§ï¼Œæˆ‘ä»¬åˆæ‹¥æŠ±å˜åŒ–ï¼ŒåŠ å…¥äº†å†…å®¹å¹³å°ä¸­å¿ƒæ¥æ”¯æŒä¿¡æ¯æµç›¸å…³çš„å†…å®¹ä¸­å°å»ºè®¾ï¼Œç›´åˆ°ç°åœ¨ã€‚\næ¸…ç†äº†å¾ˆå¤šå†å²é—ç•™é—®é¢˜ï¼Œä¹Ÿåšäº†ä¸€äº›æ¶æ„è®¾è®¡ã€ä¼˜åŒ–æ–¹é¢çš„å·¥ä½œï¼Œä¹Ÿå¾—åˆ°äº†äº›é”»ç‚¼ã€‚\nä¸‹åŠå¹´ï¼Œç”±äºå†…éƒ¨å›¢é˜ŸæŠ€æœ¯æ ˆä¸ç»Ÿä¸€ï¼Œå­˜åœ¨å„ç§å„æ ·çš„é—®é¢˜ï¼Œä¸ºäº†æå‡å¤§å®¶çš„å¼€å‘æ•ˆç‡ã€å¼€å‘è´¨é‡ï¼Œæˆ‘ä»¬å¼€å§‹å‡†å¤‡æŠŠä¸ŠåŠå¹´è‡ªç ”çš„å¾®æœåŠ¡æ¡†æ¶goneatç»™æ‰“ç£¨åœ°æ›´å¥½ã€‚è¿™åŠå¹´ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œé¢æŠ•å…¥äº†å¾ˆå¤šï¼Œæˆ‘è‡ªå·±ä¹Ÿä¹åœ¨å…¶ä¸­ï¼Œç»å¸¸æ™šä¸Šä¸€ä¸¤ç‚¹é’Ÿäº†ï¼Œè¿˜åœ¨é‚£é‡Œå†™ä»£ç ã€‚ä½†æ˜¯çœ‹åˆ°è‡ªå·±å†™çš„ä»£ç èƒ½å¤Ÿæ”¯æ’‘å›¢é˜ŸæŠ€æœ¯åŒå­¦ç¨³å®šä¸Šçº¿ä¸€ä¸ªæœåŠ¡ï¼Œå¿ƒé‡Œå°±å¾ˆå¼€å¿ƒã€‚é‡åˆ°é—®é¢˜ï¼Œä¹Ÿä¹äºåŠæ—¶å»å¸®åŠ©å®šä½ï¼Œå»è§£å†³ã€‚\næˆªæ­¢åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œgoneatæ¡†æ¶å·²ç»æ”¯æ’‘äº†çº¿ä¸Š1k+å¤šä¸ªæœåŠ¡çš„ç¨³å®šè¿è¡Œäº†ï¼Œæ„Ÿè§‰å°±æœ‰ç‚¹æˆå°±æ„Ÿã€‚\n2019å¹´Xæœˆ # è®¡åˆ’æŒç»­æ‰“ç£¨goneatå¹¶æ¨å¹¿ # 19å¹´ä¸ŠåŠå¹´ï¼Œæˆ‘ç»™è‡ªå·±å®šäº†ç‚¹KPIï¼Œå°±æ˜¯å¥½å¥½æ‰“ç£¨goneatå¹¶åšä¸€ä¸ªæ¯”è¾ƒå¤§èŒƒå›´çš„æ¨å¹¿ã€‚æˆ‘ç¡®å®å¾ˆæƒ³æŠŠè¿™ä¸ªäº‹æƒ…åšæˆï¼Œè®©æŠ•å…¥å…¶ä¸­çš„åŒå­¦ä¹Ÿéƒ½æœ‰è·å¾—æ„Ÿã€æˆå°±æ„Ÿï¼Œå½“ç„¶æ›´å¸Œæœ›å®ƒèƒ½è§£å†³å…¬å¸å†…éƒ¨å¼€å‘æ¡†æ¶çš„ä¸€äº›é—®é¢˜ã€‚\nå…¬å¸å†…æœ‰å¾ˆå¤šæ¡†æ¶ï¼Œç›¸å¯¹æ¥è¯´ï¼Œæˆ‘è§‰å¾—goneatæ˜¯è®¾è®¡çš„æ¯”è¾ƒå¥½çš„ï¼Œè™½ç„¶ä¹Ÿæœ‰è¿™æ ·é‚£æ ·çš„é—®é¢˜å§ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´ï¼Œæœ‰äº›è®¾è®¡ç†å¿µè¿˜æ˜¯æ¯”è¾ƒå¥½çš„ã€‚\nç„¶åï¼Œä¸ŠåŠå¹´æˆ‘å’Œå°ä¼™ä¼´èŠ±äº†å¾ˆå¤šæ—¶é—´åšäº†æ¡†æ¶æ–‡æ¡£ã€ç½‘ç«™æ–¹é¢çš„å»ºè®¾ï¼Œæœ‰çš„å°ä¼™ä¼´å–œæ¬¢å»ºç½‘ç«™ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢å†™æ–‡æ¡£ã€åˆ†ææºç ï¼Œæœ‰çš„æ”¯æŒä¸‹demoï¼Œæˆ‘ä»¬æ„Ÿè§‰åšçš„ä¹Ÿç®—æ˜¯å¦‚ç«å¦‚è¼ã€‚å› ä¸ºæˆ‘ä»¬æŠ•å…¥çš„æ¯”è¾ƒå¥½ï¼Œåä½œçš„ä¸€äº›æ•°æ®ä»€ä¹ˆçš„éƒ½æŒºä¸é”™ï¼Œä»£ç ã€æ–‡æ¡£éƒ½ä¸é”™ï¼Œè¿˜æ‹¿äº†2019å¹´5æœˆåˆŠçš„å…¬å¸çº§ä»£ç æ–‡åå¥–ã€‚\næ„Ÿè§‰å¾ˆæœ‰æˆå°±æ„Ÿï¼Œä¸‹é¢å‡†å¤‡å†è¿›ä¸€æ­¥å»ºè®¾ã€æ¨å¹¿çš„æ—¶å€™ï¼Œå´è¢«ä¸€ä¸‹å­å–Šåœäº†ï¼Œå› ä¸ºbgå±‚é¢è¦ç‰µå¤´åšä¸€ä¸ªæ›´å¥½çš„å¾®æœåŠ¡æ¡†æ¶äº†ã€‚\næ”¯æŒå…¬å¸çº§å¾®æœåŠ¡æ¡†æ¶å»ºè®¾ # 19å¹´ä¸‹åŠå¹´ï¼Œå°±æŠ•å…¥äº†å…¬å¸çº§å¾®æœåŠ¡æ¡†æ¶trpcçš„è®¾è®¡ã€å¼€å‘ï¼Œåœ¨è®¾è®¡çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå‚è€ƒäº†å¾ˆå¤šå¼€æºæ¡†æ¶çš„è®¾è®¡ï¼Œç„¶åå‚ä¸æ ¸å¿ƒæ¶æ„è®¾è®¡çš„åŒå­¦ä¹Ÿå¤§å¤šæ˜¯å‚ä¸è¿‡æ¡†æ¶ç›¸å…³å»ºè®¾çš„ï¼Œå„ä¸ªè¯­è¨€å±‚é¢ç»Ÿä¸€è®¾è®¡ã€è§„åˆ’ã€åè°ƒã€å¼€å‘ã€æ¨å¹¿ï¼Œåšçš„è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚\nåœ¨è¿™æœŸé—´å‘¢ï¼Œä¹Ÿå°‘ä¸äº†è®¨è®ºï¼Œæœ‰çš„æ—¶å€™ä¼šæ¼”å˜ä¸ºè¾©è®ºã€‚ç°åœ¨è§‰å¾—ç¨‹åºå‘˜Show me the codeæ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼å¯¹äºæ¡†æ¶è®¾è®¡è€Œè¨€ï¼Œæœ‰æ—¶å€™è¯´show me the codeå¹¶ä¸æ˜¯ä¸ºäº†ç‚«è€€ä½ å¾ˆå‰å®³ï¼Œè€Œæ˜¯é˜è¿°ä½ çš„æ€æƒ³æ˜¯ä¸æ˜¯è¡Œçš„é€šã€‚å½“æ—¶é’ˆå¯¹åè®®ç¼–è§£ç æ”¯æŒæ–¹é¢ï¼Œæˆ‘å°±æœ‰æ¯”è¾ƒå¤§çš„æ„è§ï¼Œå’Œå¤§å¤šæ•°åŒå­¦æ„è§ä¸ä¸€è‡´ï¼Œæœ€åä¹Ÿæ˜¯å°‘æ•°æœä»å¤šæ•°æŒ‰ç…§å¤§å®¶çš„æ„æ€è¿›è¡Œæ”¯æŒçš„ã€‚æˆ‘ä¸ºæ­¤æ„¤æ‡‘äº†å¾ˆä¹…ï¼Œä¸ºä»€ä¹ˆå°±getä¸åˆ°æˆ‘çš„æ€è·¯å‘¢ã€‚\nç°åœ¨æˆ‘å…¶å®ä¹Ÿæƒ³é€šäº†ï¼Œå¦‚æœå½“æ—¶æˆ‘åŠæ—¶show me the codeï¼Œé‚£è¿™é‡Œçš„è®¾è®¡å¯èƒ½å°±ä¸æ˜¯è¿™ä¸ªæ ·å­ï¼å³ä¾¿æ˜¯ç°åœ¨ï¼Œæˆ‘å¯¹è¿™é‡Œçš„è®¾è®¡ä¹Ÿæ˜¯ä¸æ»¡æ„çš„ï¼Œå› ä¸ºå®ƒçš„é—®é¢˜å¾ˆæ˜æ˜¾ï¼Œåªæ˜¯å¾ˆå¤šä¸šåŠ¡å¼€å‘çš„åŒå­¦ï¼Œæˆ–è€…æ²¡æœ‰æŒ‘å‰”çœ¼å…‰çš„æ¡†æ¶å¼€å‘è€…ï¼Œæ„Ÿè§‰ä¸åˆ°å®ƒçš„å­˜åœ¨ç½¢äº†ã€‚\nå‘ç°é—®é¢˜ï¼Œä»æ··ä¹±ä¸­æŠ½è±¡å‡ºæ›´æ¸…æ™°çš„è®¾è®¡è„‰ç»œï¼Œæœ¬èº«å°±æ˜¯ç§ç‰¹æ®Šçš„èƒ½åŠ›ã€‚ä¸è¿‡æˆ‘å·²ç»ä¸é‚£ä¹ˆæ„¤æ‡‘äº†ï¼Œç›¸æ¯”ä¸€ä¸ªç‚¹çš„è®¾è®¡ä¼˜åŠ£è€Œè¨€ï¼Œèƒ½æœ‰ä¸€ä¸ªé è°±çš„å…¨å±€è½åœ°è®¡åˆ’ï¼Œä¼šæ›´é‡è¦ä¸€äº›ã€‚æ¯•ç«Ÿæˆ‘ä»¬æ˜¯æ¥è§£å†³é—®é¢˜çš„ï¼Œè€Œä¸æ˜¯è¦åˆ›é€ ä¸€ä¸ªä»€ä¹ˆå®Œç¾çš„ä¸œè¥¿ï¼è¿½æ±‚better codeï¼Œè€Œéperfect codeï¼better and betterï¼Œä¼šæ…¢æ…¢è¶‹è¿‘perfectï¼\nè¿™æœŸé—´æœ‰æˆé•¿ï¼Œæœ‰éƒé—·ï¼Œæœ‰è®¤å¯ï¼Œæœ‰è´¨ç–‘ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¤šä¹ˆè½»æ¾çš„æ´»ï¼ŒåšæŒä¸‹æ¥ï¼Œä»0åˆ°1ï¼Œä¹Ÿç®—æ˜¯æˆ‘ä»å¤´åˆ°å°¾è·Ÿå®Œçš„ä¸€ä¸ªæ¯”è¾ƒå¤§å‹çš„é¡¹ç›®äº†ã€‚æœŸé—´ä¹Ÿè¿›ä¸€æ­¥åŠ æ·±äº†è‡ªå·±å¯¹æ¶æ„è®¾è®¡ã€å¾®æœåŠ¡æ¶æ„è®¾è®¡ã€é¡¹ç›®ç®¡ç†ã€ä»£ç è´¨é‡ã€æ¨å¹¿è¿è¥ç­‰ç›¸å…³æ–¹é¢çš„ä¸€äº›ç†è§£ã€‚æˆ‘å°†åœ¨æˆ‘çš„ä¹¦ go-rpc-book ä¸­è®²è¿°æˆ‘çš„å¿ƒå¾—ä½“ä¼šï¼Œæ•¬è¯·å…³æ³¨ã€‚\n2020å¹´Xæœˆ # å¦‚ä»Š2020å¹´å·²ç»è¿‡åŠï¼Œæ¥åˆ°è¿™ä¸ªæ¡£å£ï¼Œåˆå¤šäº†ä¸€äº›æ€è€ƒã€‚ä»å…¬å¸ç»„ç»‡æ¶æ„è°ƒæ•´ä»¥æ¥ï¼Œå…¬å¸çš„å¾ˆå¤šå›¢é˜Ÿåœ¨æ•´åˆä¼˜åŠ¿èµ„æºï¼Œé€šè¿‡å¼€æºååŒå»å…±å»ºä¸€äº›ä¼˜ç§€é¡¹ç›®ï¼Œè€Œä¸å†æ˜¯æŠ±æ®‹å®ˆç¼ºä¼¼çš„é—­é—¨é€ è½¦ã€‚\næˆ‘ç›¸ä¿¡ï¼Œè…¾è®¯çš„æŠ€æœ¯åœ¨æœªæ¥å‡ å¹´è‚¯å®šä¼šè¶Šæ¥è¶Šå¥½çš„ï¼Œä½†æ˜¯å› ä¸ºæœ‰å¾ˆå¤šå­˜é‡ç³»ç»Ÿçš„é€‰å‹ã€å®è·µï¼Œè¿™ä¸ªè¿˜æ˜¯è¦æ—¶é—´æ¥æ¶ˆåŒ–çš„ï¼Œä¸šåŠ¡ä¸ŠåŠ¿å¿…ä¼šç»å†ä¸€æ®µæ—¶é—´çš„é˜µç—›ï¼Œè¿™äº›é˜µç—›ä¸€å®šä¼šè½åœ¨ç ”å‘åŒå­¦èº«ä¸Šã€‚æˆ–é•¿æˆ–çŸ­ï¼Œçœ‹æŠ€æœ¯å»ºè®¾æ¨è¿›çš„åŠ›åº¦å’Œé¢†å¯¼çš„é­„åŠ›ï¼Œä¸€çº¿å¼€å‘çš„è‡ªä¸»é€‰æ‹©èƒ½åŠ›ã€‚å¦‚æœå¤§å®¶éƒ½é€‰æ‹©é—­å˜´ï¼Œåªå”¯ä¸Šä¸å”¯æ˜¯ï¼Œé‚£è¿™æ ·çš„æŠ€æœ¯æ¨è¿›ï¼Œä¹Ÿæœ‰å¯èƒ½å‰‘èµ°åé”‹ï¼Œæœ‰å¼Šæ— åˆ©ã€‚è¿™åŠå¹´å§ï¼Œä¸€ç›´åœ¨æ‰¿æ‹…trpcæ¡†æ¶çš„åº”ç”¨æ¨å¹¿ã€ç ”å‘æ•ˆèƒ½æå‡æ–¹é¢çš„å·¥ä½œï¼Œæˆ‘éå¸¸è®¤åŒè¿™èƒŒåçš„ç†å¿µï¼Œåªæ˜¯è½åœ°çš„è®¡åˆ’ä¸Šæˆ‘è§‰å¾—æ˜¯å¯ä»¥æ”¹å–„çš„ã€‚\nè¯´çœŸçš„ï¼Œè¿™åŠå¹´æˆ‘è§‰å¾—æœ‰ç‚¹ç´¯ï¼Œå¿ƒç´¯ã€èº«ä½“ç´¯ã€æ²¡æœ‰æˆå°±æ„Ÿï¼ŒåŒ…æ‹¬ç­”è¾©æ™‹å‡åœ¨å†…å§ï¼Œå¿ƒé‡Œæœ‰ç‚¹ä¸ç”˜ï¼Œå¯¹è¯„å§”ä¸“ä¸šèƒ½åŠ›ã€è¯„å®¡åˆç†æ€§ä¹Ÿæœ‰è´¨ç–‘ã€‚\næ€»ç»“ä¸€å¥è¯ï¼Œæ²¡æœ‰è¾¾åˆ°è‡ªå·±æƒ³è¦çš„é‚£ç§æˆé•¿å§ã€‚\nè¿˜æœ‰ï¼ŒåŸæœ¬æƒ³æŒ‰è®¡åˆ’æ¨è¿›ä¸‹ä¸šåŠ¡æ–¹é¢çš„å»ºè®¾ï¼Œçªç„¶æ¥ä¸ªç ”å‘æ•ˆèƒ½æå‡ï¼Œä½†æ˜¯å·¥å…·å¹³å°å»ºè®¾ï¼ŒåŠå¹´å¤šäº†è¿˜æ˜¯ä¸€å›¢ç³Ÿï¼Œæˆ‘å¾ˆéš¾çŸ¥é“å›¢é˜Ÿç°çŠ¶åˆ°åº•å¥½åœ¨å“ªé‡Œï¼Œååœ¨å“ªé‡Œã€‚ç»§ç»­è¿™ä¹ˆå¹²ä¸‹å»ï¼Œæ…¢è…¾è…¾çš„ï¼Œä¸‹åŠå¹´å¤šåŠè¿˜æ˜¯è¿™æ ·çš„å·¥ä½œã€‚\næˆ‘æƒ³åšå‡ºä¸€äº›æ”¹å˜ï¼Œæ€ç»´ä¸Šï¼Œè¡ŒåŠ¨ä¸Šï¼Œè‡ªå·±ä¸ºè‡ªå·±åšä¸»ï¼Œä¸èƒ½è¢«åŠ¨åœ°ç­‰å¾…æœºä¼šæˆ–å¤–éƒ¨æ”¹å˜ã€‚\nå®¢è§‚ä¸Šæˆ¿å­æ˜¯å…¨æ¬¾ä¹°çš„ï¼Œæœ‰å­˜æ¬¾ï¼Œæ²¡æœ‰ç»æµä¸Šçš„å‹åŠ›ã€‚è‡ªå·±å¯¹ç°åœ¨å·¥ä½œçŠ¶æ€ä¸æ»¡ï¼Œä¹Ÿè®¸å·¥ä½œå°±æ˜¯è¿™æ ·å§ï¼Œä½†æ˜¯æˆ‘æƒ³åšæ›´å¤šæœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œè€Œä¸æ˜¯æ›¿åˆ«äººé¢‘ç¹æ“¦å±è‚¡ã€‚è™½ç„¶è‡ªå·±æ²¡å¼ºåˆ°é‚£ä¹ˆå¼ºï¼Œä½†æ˜¯å­¦ä¹ è°ä¸ä¼šï¼Œè€Œä¸”æˆ‘è§‰å¾—è‡ªå·±å­¦ä¹ èƒ½åŠ›å¾ˆå¼ºå‘¢ï¼Œåªæ˜¯æˆ‘ä¸æ„¿æ„å’Œè¿™ç§åšäº‹çš„äººä¸€èµ·é¬¼æ··äº†è€Œå·²äº†ã€‚\næœ€æœ€é‡è¦çš„ï¼Œæˆ‘æœ‰ä¸€äº›æƒ³æ³•ï¼Œæ„Ÿè§‰å¾ˆä¸é”™ï¼Œæƒ³å»å°è¯•ä¸€ä¸‹ã€‚ä¸‡ä¸€æˆåŠŸäº†å‘¢ï¼Œå°±å¯ä»¥æ‘†è„±è¿™ç§çŒªç‹—ä¸å¦‚çš„æ—¥å­äº†ã€‚åˆ°æ—¶å€™æˆ‘å°±å¯ä»¥å¼€å¼€å¿ƒå¿ƒåœ°å†™å†™è‡ªå·±æƒ³å†™çš„ä»£ç ã€‚ä¹Ÿæ²¡å¿…è¦å› ä¸ºè¯„å§”ä¸ä¸“ä¸šã€è¯„å®¡è§„åˆ™çš„é—®é¢˜æ¥ç­‰ä»–ä»¬è¯„å®¡æ™‹å‡ï¼Œä¸å€¼å¾—ã€‚æ›´æ²¡å¿…è¦å› ä¸ºä¸€äº›åˆä½œæ–¹çš„æ‡’æƒ°ã€ä¸ä½œä¸ºï¼Œæçš„è‡ªå·±å©šå‡æœŸé—´è¿˜è¦ä¸ºäº†ä»–ä»¬çš„KPIå»åšä¸€äº›è€æ¿é¢å­ä¸Šçš„äº‹æƒ…ã€‚è°çš„æ—¶é—´ä¸æ˜¯æ—¶é—´ï¼\nç°åœ¨ï¼Œæˆ‘ä¹ŸçŸ¥é“è‡ªå·±æœ‰å“ªäº›ä¼˜ç‚¹å’Œä¸è¶³ï¼Œé€šè¿‡ä¸€äº›å­¦ä¹ ã€å¯¹æ¯”ä¹Ÿèƒ½æ¸…æ™°åœ°è®¤è¯†åˆ°æœªæ¥è‡ªå·±çš„å¯èƒ½å‘å±•è·¯å¾„ï¼Œæˆ‘ä¹Ÿä¸ä¼šå› ä¸ºåˆ«äººä¸€æ—¶çš„è¯„ä»·ã€å·¥ä½œçš„ä¸å¦‚æ„ï¼Œå†åè¿‡æ¥è´¨ç–‘è‡ªå·±ã€‚çœ‹ä¸Šå»ä¸€åˆ‡éƒ½å·²ç»æ…¢æ…¢å˜å¾—æ›´å¥½ï¼Œä½†æˆ‘çœŸçš„ä¸æ»¡è¶³äºè¿™æ ·äº†ï¼Œæˆ‘æƒ³æŒ‘æˆ˜æ›´å¤šï¼Œä½“éªŒæ›´å¤šã€‚æ—¶é—´ä¸åº”è¯¥è¿™æ ·è¢«æµªè´¹æ‰ã€‚\nç°åœ¨çš„å·¥ä½œã€ç”Ÿæ´»ã€æ—¶é—´ï¼Œéƒ½ä¸æˆ‘ä¸ªäººçš„ç›®æ ‡äº§ç”Ÿäº†æ¿€çƒˆçš„å¯¹æŠ—å’Œå†²çªã€‚äººå’Œäººè¿˜æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯•ç«Ÿä¸æ˜¯æ¯ä¸ªäººéƒ½æƒ³æœºæ¢°åœ°å·¥ä½œï¼ŒåŸå°ä¸åŠ¨åœ°æŒ‰ç…§å‰è¾ˆä»¬è¸©å‡ºçš„è„šå°é‡æ–°èµ°ä¸€éäººç”Ÿâ€¦â€¦æœ‰äº›äººè¯´ï¼Œä½ åº”è¯¥çŸ¥è¶³ï¼Œç›¸æ¯”è€å®¶å¾ˆå¤šäººå·¥ä½œéƒ½å‘æ„ï¼Œä½ è¿™å·¥ä½œä¸é£å¹é›¨æ™’ååŠå…¬å®¤çš„ï¼Œæ€ä¹ˆè¿˜ä¸çŸ¥è¶³å‘¢ï¼Ÿä¸æ˜¯ä¸çŸ¥è¶³ï¼Œè¿½æ±‚çš„ä¸œè¥¿ä¸ä¸€æ ·è€Œå·²ï¼Œè‡ªå·±å–œæ¬¢çš„ä¸œè¥¿ï¼Œå°±ä¸è¦å»é—®åˆ«äººå¥½ä¸å¥½ï¼Œå› ä¸ºåœ¨åˆ«äººçœ‹æ¥å¯èƒ½æ ¹æœ¬å°±æ¯«æ— æ„ä¹‰ã€‚æœ‰æ¬¡å’Œæœ‹å‹å¼€ç©ç¬‘è¯´ï¼Œæˆ‘å¯èƒ½ä¼šæ”¾å¼ƒæŠ€æœ¯è¿™æ¡çº¿ï¼Œä»–æ„Ÿè§‰å¾ˆä¸ç†è§£ï¼Œè®¤ä¸ºæˆ‘åšæŠ€æœ¯å¾ˆä¸é”™ã€é’»ç ”çš„ä¹Ÿä¸é”™ï¼Œä¸æ˜¯å¤ªå¯æƒœäº†å—ï¼Ÿæœ‰ä»€ä¹ˆå¯æƒœçš„ï¼Œç›¸æ¯”æŸäº›äººè®¤ä¸ºçš„æˆåŠŸï¼Œæˆ‘å®å¯å»äº‰å–éª‘ä¸ªæ‘©æ‰˜ï¼Œè·‘éä¸­å›½ã€‚\næœ€å # æ—¢ç„¶å·²ç»è€ƒè™‘çš„è¿™ä¹ˆæ¸…æ¥šäº†ï¼Œæ— è®ºç»“æœå¦‚ä½•ï¼Œéƒ½åº”è¯¥è¡ŒåŠ¨èµ·æ¥ã€‚æœ€åï¼Œæˆ‘åšå®šåœ°è½ä¸‹äº†ç¬”ï¼Œåšä¸€ä¸ªå¯¹è‡ªå·±è´Ÿè´£çš„èˆµæ‰‹ï¼\n"}),a.add({id:293,href:"/tags/gatsby/",title:"gatsby",description:"",content:""}),a.add({id:294,href:"/tags/generator/",title:"generator",description:"",content:""}),a.add({id:295,href:"/tags/gitbook/",title:"gitbook",description:"",content:""}),a.add({id:296,href:"/tags/hugo/",title:"hugo",description:"",content:""}),a.add({id:297,href:"/tags/jekyll/",title:"jekyll",description:"",content:""}),a.add({id:298,href:"/tags/mkdocs/",title:"mkdocs",description:"",content:""}),a.add({id:299,href:"/tags/readthedocs/",title:"readthedocs",description:"",content:""}),a.add({id:300,href:"/tags/static-site/",title:"static site",description:"",content:""}),a.add({id:301,href:"/blog/2020-05-30-%E9%9D%99%E6%80%81%E7%AB%99%E7%82%B9%E7%94%9F%E6%88%90%E5%99%A8/",title:"é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼Œä¸ºä»€ä¹ˆé€‰æ‹©hugoï¼Ÿ",description:"æŠ€æœ¯äººæ²¡ä¸ªè‡ªå·±çš„æŠ€æœ¯åšå®¢æ€ä¹ˆè¡Œï¼ŒåŠæ—¶æ€»ç»“åˆ†äº«ä¸€ä¸‹è‡ªå·±å­¦ä¹ çš„ä¸œè¥¿ï¼Œä¸ä»…ä»…æ˜¯å¯¹è‡ªå·±ç°é˜¶æ®µçš„å·¥ä½œæ€»ç»“ï¼Œå¯¹åˆ«äººä¹Ÿå¯èƒ½æ˜¯ä¸€ç§æ— å½¢çš„å¸®åŠ©ï¼Œæ²¡å‡†æœ‰éœ€è¦çš„äººæ¥è§¦åˆ°äº†ä»€ä¹ˆé—®é¢˜åˆšå¥½èƒ½è·å¾—å¸®åŠ©ã€‚é‚£ä¹ˆæœ‰ä»€ä¹ˆå·¥å…·å¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜å¿«é€Ÿå»ºç«‹æŠ€æœ¯åšå®¢å‘¢ï¼Ÿç»“åˆæŠ€æœ¯äººçš„æŠ€æœ¯æ ˆã€å¸¸ç”¨å·¥å…·ï¼ŒæŠ€æœ¯äººç”¨çš„æ¯”è¾ƒå¤šçš„å°±æ˜¯markdownï¼Œå¦‚æœèƒ½æœ‰å·¥å…·è¿…é€Ÿå°†markdownä»¥webé¡µé¢çš„å½¢å¼è¿›è¡Œå‘å¸ƒå¹¶æä¾›ä¸€è‡´ä¾¿æ·çš„é˜…è¯»ä½“éªŒå°±å¥½äº†ã€‚æœ¬æ–‡å°±æ¥ä»‹ç»ç›¸å…³çš„å·¥å…·ã€‚",content:" img {width:680px;} video {width:680px;}  Hugo æ˜¯ä¸€ä¸ªé™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼Œæ˜¯è¯„æµ‹æœ€å¿«çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼Œé‡‡ç”¨golangç¼–å†™ï¼Œä¾èµ–bepã€spf13ã€friendsè¿™å‡ ä¸ªç¬¬ä¸‰æ–¹åº“æ¥å®ç°ã€‚Hugoæ˜¯ä¸€ä¸ªä¸é”™çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼Œç±»ä¼¼çš„è¿˜æœ‰readthedocã€gitbookã€jekyllã€gatsbyç­‰ç­‰ï¼Œè°ˆè°ˆæˆ‘å¯¹è¿™å‡ ä¸ªæµè¡Œçš„ç«™ç‚¹ç”Ÿæˆå™¨çš„çœ‹æ³•ã€‚\njekyll # jekyllï¼Œæ˜¯æˆ‘ä½¿ç”¨çš„ç¬¬ä¸€ä¸ªé™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼Œç”¨äºæˆ‘çš„ github pagesï¼Œ å®ƒæœ‰æ¯”è¾ƒä¸°å¯Œçš„ä¸»é¢˜ï¼Œè¿™ä¸ªæ˜¯æˆ‘å½“æ—¶é€‰æ‹©çš„ä¸€ä¸ªåŸå› ï¼Œæˆ‘å¯ä»¥ä¸“å¿ƒäºæ–‡æ¡£çš„ç¼–å†™ï¼Œæ–‡æ¡£ä¹Ÿæ˜¯markdownæ ¼å¼ã€‚ä½†æ˜¯ç”±äºå®ƒå¯¹markdownçš„æ”¯æŒæ¯”è¾ƒé¸¡è‚‹ï¼Œæ¯”å¦‚ç¼ºä¹å¯¹å›¾ç‰‡å¼•ç”¨ã€å›¾è¡¨ã€plantumlã€flowchartç­‰çš„è‰¯å¥½çš„æ”¯æŒï¼Œæœ€ç»ˆè®©æˆ‘è§‰å¾—é€šè¿‡jekyllæ¥ç»´æŠ¤ä¸€ä¸ªé™æ€ç«™ç‚¹æ¯”è¾ƒç—›è‹¦ã€‚\ngitbook # gitbookï¼Œæ˜¯æˆ‘å¹³æ—¶ç»å¸¸ä½¿ç”¨çš„ä¸€ä¸ªç¼–è¾‘å·¥å…·å§ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°ç±»ä¼¼ä¹¦ç±ç« èŠ‚çš„å¤§é‡å†…å®¹ç»„ç»‡çš„æ—¶å€™ï¼Œç°åœ¨ä¾æ—§æ˜¯æˆ‘å¸¸ç”¨çš„ç¼–è¾‘å·¥å…·ä¹‹ä¸€ã€‚gitbook-cliæ˜¯å…¶é…å¥—çš„ä¸€ä¸ªå·¥å…·ï¼Œç°åœ¨å·²ç»ä¸å†æ›´æ–°ã€ç»´æŠ¤ï¼Œç¦»çº¿ç¼–è¾‘å·²ç»ä¸å†è¢«æ”¯æŒï¼Œç°åœ¨è½¬ä¸ºçº¿ä¸ŠæœåŠ¡ã€‚æˆ‘è¿˜æ˜¯æ¯”è¾ƒå€¾å‘äºç¦»çº¿ç¼–è¾‘ï¼Œä¸å¾—ä¸å¯»æ±‚å…¶ä»–å¯æ›¿ä»£æ–¹æ¡ˆã€‚\nreadthedoc # è§åçŸ¥æ„ï¼Œreadthedocç¡®å®æ¯”è¾ƒç”¨æ¥å†™æŠ€æœ¯æ–‡æ¡£ï¼Œå…¶æœ¬èº«ä¹Ÿæ˜¯ä¸ºäº†ç»™pythonå†™apiæ–‡æ¡£çš„ï¼Œå…¶ç”¨æ¥æ„å»ºç±»ä¼¼çš„æŠ€æœ¯æ–‡æ¡£ã€æ‰‹å†Œè¿˜æ¯”è¾ƒåˆé€‚ï¼Œä½†æ˜¯ç”¨æ¥æ„å»ºä¸€ä¸ªæ›´é€šç”¨ç‚¹çš„é™æ€ç«™ç‚¹çš„è¯å°±æœ‰äº›ä¸åˆé€‚ï¼Œä¸ç®¡å¤šå¤§çš„å±å¹•ï¼Œå®ƒå±•ç¤ºçš„åŒºåŸŸæ€»æ˜¯é‚£ä¹ˆå°ï¼Œæœ‰ç‚¹æ­»å®ˆæ¯è¡ŒNä¸ªå­—ç¬¦çš„å‘³é“ã€‚\ngatsby # è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½ç”¨çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šå®ƒå’Œhugoçš„å¯¹æ¯”ï¼Œç”±äºæˆ‘å¯¹èƒŒåçš„å®ç°jsç­‰ä¸å¤ªç†Ÿæ‚‰ï¼Œè€Œæˆ‘æœ¬äººä¹Ÿç»å¸¸æœ‰äº›å®šåˆ¶åŒ–çš„ä¿®æ”¹éœ€æ±‚ï¼Œæˆ‘è¿˜æ˜¯æœ‰å¯èƒ½ä¼šå»æ”¹ä¸‹æºç ä¸ºè‡ªå·±æ‰€ç”¨çš„ï¼Œæ‰€ä»¥é€‰å‹é˜¶æ®µç›´æ¥æ”¾å¼ƒã€‚\nmkdocs # mkdocså’Œgitbookç±»ä¼¼ï¼Œä½¿ç”¨éƒ½æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å…¶é£æ ¼å®šåˆ¶åŒ–æ¯”è¾ƒéš¾æ“ä½œï¼Œå¦‚æœä½ å¯¹å®ƒçš„é»˜è®¤é£æ ¼ä¸å¤ªæ»¡æ„ï¼Œåˆæƒ³å®šåˆ¶ä¸»é¢˜ï¼Œè€Œä¸æƒ³æ²¾æŸ“ä»€ä¹ˆå‰ç«¯ç›¸å…³çš„å·¥ä½œï¼Œmkdocså¯èƒ½å¹¶ä¸ä¸€å®šåˆé€‚ã€‚\nhugo # hugoçš„æ”¯æŒã€ç»´æŠ¤ã€æ›´æ–°éƒ½è¿˜ä¸é”™ï¼Œç”Ÿæ€ä¹Ÿä¸é”™ï¼Œä¹Ÿæœ‰å¾ˆå¤šä½¿ç”¨hugoçš„å…¬å¸ã€å›¢é˜Ÿã€ä¸ªäººç”¨å®ƒæ¥ç»´æŠ¤è‡ªå·±äº§å“ã€ä¸ªäººçš„æ–‡æ¡£ã€åšå®¢ç­‰ç­‰ï¼Œä¹Ÿæœ‰æ¯”è¾ƒä¸°å¯Œçš„ä¸»é¢˜å¯ä¾›é€‰æ‹©ã€‚hugoçš„å¥½å¤„æ˜¯å®ƒçš„ä¸»é¢˜æ˜¯å®Œæ•´çš„ï¼ŒåŒ…æ‹¬å„ç§å„æ ·çš„æ’ä»¶ï¼Œå¯ä»¥ä½“éªŒã€ä¸‹è½½å®‰è£…ã€åº”ç”¨ä¸­æ„çš„ä¸»é¢˜ï¼Œåç»­åˆ‡æ¢ä¸»é¢˜ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ã€‚è€Œä¸”hugoä¹Ÿæä¾›äº†ä¸€äº›å‘½ä»¤è¡Œæ“ä½œæ¥å¿«é€Ÿå‘å¸ƒé™æ€ç«™ç‚¹ã€‚è¿˜æœ‰å°±æ˜¯å¯¹golangçš„åçˆ±ï¼Œæ„å‘³ç€æˆ‘å¯ä»¥åœ¨æœ‰éœ€è¦çš„æ—¶å€™äº†è§£å…¶å®ç°ï¼Œä¿®æ”¹å…¶æºç è¿›è¡Œå®šåˆ¶åŒ–ï¼Œæˆ–è€…åšè´¡çŒ®ã€‚\nç»¼åˆä¸Šè¿°è€ƒè™‘å’Œå¯¹æ¯”ï¼Œç°åœ¨å‘¢ï¼Œæˆ‘æ›´å€¾å‘äºä½¿ç”¨hugoæ¥ä½œä¸ºæ¥ä¸‹æ¥çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨ã€‚\n"}),a.add({id:302,href:"/tags/hammerspoon/",title:"hammerspoon",description:"",content:""}),a.add({id:303,href:"/tags/ical/",title:"iCal",description:"",content:""}),a.add({id:304,href:"/tags/mac/",title:"mac",description:"",content:""}),a.add({id:305,href:"/tags/shortcuts/",title:"shortcuts",description:"",content:""}),a.add({id:306,href:"/tags/spotlight/",title:"spotlight",description:"",content:""}),a.add({id:307,href:"/blog/2020-04-25-%E4%BD%A0%E7%9A%84mac%E6%9C%89%E5%93%AA%E4%BA%9B%E8%B6%81%E6%89%8B%E7%9A%84%E9%85%8D%E7%BD%AE/",title:"ä½ çš„macæœ‰å“ªäº›â€œè¶æ‰‹â€çš„é…ç½®å‘¢ï¼Ÿ",description:"æ¯ä¸ªäººçš„ä¹ æƒ¯ä¸ä¸€æ ·ï¼Œæ¯ä¸ªäººç”µè„‘åˆ°æ‰‹åè¦åšçš„å®šåˆ¶åŒ–é…ç½®ä¹Ÿä¸ä¸€æ ·ï¼Œæ¯”å¦‚å¸¸ç”¨çš„è½¯ä»¶ã€å¿«æ·é”®ã€æ•ˆç‡å·¥å…·ç­‰ç­‰çš„ï¼Œç¨‹åºå‘˜å¯èƒ½ä¼šå¼€å‘äº›å¸¸ç”¨çš„å·¥å…·æ¥å¢å¼ºæ“ä½œæ•ˆç‡ç­‰ç­‰ã€‚æˆ‘å°±æ„Ÿè§‰æˆ‘è€å©†macæ“ä½œæ•ˆç‡æŒºä½æ•ˆçš„ï¼Œå®é™…å·¥ä½œä¸­æ®æˆ‘è§‚å¯Ÿå¾ˆå¤šåŒäº‹çš„æ“ä½œæ•ˆç‡éƒ½å¾ˆä½æ•ˆï¼Œäºæ˜¯æœ‰æ­¤æ–‡ï¼Œåˆ†äº«ä¸‹è‡ªå·±åœ¨macä½¿ç”¨æ–¹é¢ä¸Šçš„ä¸€ç‚¹å¿ƒå¾—ã€‚æ•ˆç‡ä½ä¹Ÿæ— æ‰€è°“ï¼Œå®Œæˆå·¥ä½œå°±å¯ä»¥ï¼Œä½†æ˜¯æˆ‘ä¸è¡Œï¼Œæˆ‘ä¸èƒ½å¿å—æ— ä¼‘æ­¢çš„ä½“åŠ›åŠ³åŠ¨ï¼Œæ‰€ä»¥æˆ‘ä¼šæƒ³åŠæ³•æ¥ææ•ˆï¼Œå¦‚æœæˆ‘æ¯å¤©è¦é‡å¤ä¸€ä¸ªæ“ä½œå¾ˆå¤šæ¬¡ä»¥ä¸Šã€‚",content:" img {width:680px;} video {width:680px;}  è¿™é˜µå­ä¸Šç­åœ¨åŒäº‹ä¹‹é—´èµ°åŠ¨æ¯”è¾ƒå¤šï¼Œå‘ç°åŸºæœ¬ä¸Šå·²ç»äººæ‰‹ä¸€å°macï¼Œä½†æ˜¯å¯¹ç³»ç»Ÿçš„é…ç½®ã€ä½¿ç”¨å´å¤§ä¸åŒã€‚ä¹Ÿæœ‰æ–°åŒå­¦ä¼°è®¡æ˜¯windowsè½¬è¿‡æ¥çš„ï¼Œé€‚åº”èµ·æ¥ä¹Ÿæœ‰å›°éš¾ã€‚å¬ç‰©èµ„ç®¡ç†çš„åŒäº‹æèµ·è¿‡ï¼Œæœ‰åŒå­¦å› ä¸ºä¸ä¹ æƒ¯macé‡æ–°æ¢æœºå™¨çš„ä¹Ÿä¸å°‘ã€‚\nå‰å‡ å¤©ç”Ÿæ—¥ï¼Œä¹°äº†å°æ–°è®¾å¤‡é€è‡ªå·±ï¼ˆåŸæœ¬æ‰“ç®—ä¹°Aprilia 150ï¼Œå…ˆæ”¾æ”¾ï¼‰ï¼Œæ°å¥½ç”Ÿæ—¥å‰ä¸€å¤©åˆ°ğŸ˜ƒã€‚åˆšå¥½ä¹Ÿåœ¨åšä¸€äº›é…ç½®çš„äº‹ï¼Œå°±æŠŠè¿‡ç¨‹ä¸­è§‰å¾—æ¯”è¾ƒæœ‰åˆ†äº«ä»·å€¼çš„æ•´ç†åˆ†äº«ä¸‹ã€‚\nå›æƒ³èµ·16å¹´å‚åŠ å·¥ä½œåˆšé¢†å·¥èµ„é‚£ä¸ªæœˆï¼Œå…´å†²å†²åœ°ä¹°äº†mbpï¼Œç«¯ç«¯æ­£æ­£çš„16:10å±å¹•ï¼Œç»†è…»çš„åˆ†è¾¨ç‡ï¼Œèˆ’æœçš„é”®ç›˜ï¼Œäººæ€§åŒ–çš„é”®ç›˜ç¯ï¼Œçµæ•çš„è§¦æ§æ¿â€¦â€¦å“‡ï¼Œç¡¬ä»¶å®Œç¾ï¼Œè¿™å°±æ˜¯æˆ‘æƒ³è¦çš„å·¥å…·ã€‚è¯•ç”¨äº†ä¸€å¤©ä¹‹åï¼Œå‘ç°å¾ˆéš¾é€‚åº”ã€‚ç‹‚åæ§½ï¼Œç»å¸¸æ‹¿å®ƒå’ŒLinuxæ¡Œé¢åšå¯¹æ¯”ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´çš„è°ƒæ•™ï¼Œå‘ç°è¿˜æ˜¯å¯ä»¥çš„ğŸ˜ƒã€‚\nè‡ªå·±è€è®¾å¤‡ä¹Ÿæ²¡ä½¿ç”¨time machineæ¥åšå¿«ç…§ï¼Œæ²¡é‚£ä¹ˆå¤§ç¡¬ç›˜åˆ†åŒºäº†ï¼Œè€Œä¸”æœ‰å¾ˆå¤šåƒåœ¾ï¼Œè¿˜æ˜¯å¹²å¹²å‡€å‡€ä»å¤´æ¥ä¸€éå§ï¼Œä¹ŸæŠŠè¿‡ç¨‹ä¸­å€¼å¾—åˆ†äº«çš„è®°å½•ä¸‹ï¼ˆå°½é‡åšåˆ°åˆé€‚çš„å½’ç±»ï¼‰ã€‚\n1 Spotlight\nä»¥å‰ï¼Œæœç´¢å¼•æ“æ˜¯å¤§å®¶äº†è§£ä¿¡æ¯çš„ä¸»è¦å…¥å£ï¼Œæœç´¢ã€çƒ­é—¨è¯æ¡ç­‰ï¼Œspotlightæ˜¯ä¸€ä¸ªç±»ä¼¼çš„ä¸œè¥¿ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå…¥å£è®©ç”¨æˆ·å¯ä»¥å¿«é€Ÿè§¦è¾¾å¾…è®¿é—®çš„å†…å®¹ï¼Œå¯èƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œè¿›å…¥ä¸€ä¸ªæ–‡ä»¶è·¯å¾„ï¼Œæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œç¿»è¯‘ä¸€ä¸ªå•è¯ï¼Œè¿›è¡Œä¸€æ®µç§‘å­¦è®¡ç®—ï¼Œæ‰§è¡Œä¸€ä¸ªå·¥ä½œæµï¼Œå…¨æ–‡æœç´¢ï¼ŒOCRæœç´¢ä½ çš„ç½‘é¡µæ‰¹æ³¨â€¦â€¦ç½‘ç»œæœç´¢â€¦â€¦\nå¬èµ·æ¥å¾ˆç¾å¥½æ˜¯å§ï¼Œè¿™ä¸ªç©æ„ä¹Ÿä¸æ˜¯ä»€ä¹ˆæ–°é²œçš„ä¸œè¥¿ï¼Œåœ¨Windowsã€Linuxä¸Šéƒ½æœ‰ç±»ä¼¼çš„å·¥å…·ï¼Œæ¯”å¦‚KDEä¸ŠæŒ‰é”®F2 è¿›å…¥æœç´¢åŸºæœ¬ä¸Šæ˜¯åŒæ ·çš„æ•ˆæœï¼ŒUnityã€GNOMEä¸Šéƒ½æœ‰ç±»ä¼¼çš„ï¼Œç‰¹åˆ«æ˜¯XBuntuä¸Šå¯¹spotlightè¿›è¡Œäº†é«˜åº¦â€œæŠ„è¢­â€ğŸ˜ƒã€‚\nè°ƒæ•´åŸå› ï¼šé»˜è®¤command+spaceæ˜¯å¯åŠ¨spotlightï¼Œä¸è¾“å…¥æ³•åˆ‡æ¢å†²çª\nè°ƒæ•´æ¨èï¼šå¿«æ·é”®è°ƒæ•´æˆ command+/ï¼Œè¿™ä¸ªç»„åˆé”®ç®€å•ï¼Œåˆé¿å…å†²çª\n2 Launchpad\nLaunchpadæœ‰ç‚¹ç±»ä¼¼äºwindowsä¸‹çš„å¼€å§‹èœå•ï¼Œè¿™é‡Œå¯ä»¥æœç´¢å®‰è£…çš„åº”ç”¨ç¨‹åºï¼Œå’Œwindowsç›¸æ¯”ä¸€ä¸ªå¥½ç‚¹çš„åœ°æ–¹æ˜¯ï¼Œå¯ä»¥å¯¹åº”ç”¨è¿›è¡Œåˆ†ç»„ï¼Œç°åœ¨Androidã€iOSéƒ½æ”¯æŒï¼Œå¤§å®¶åº”è¯¥ä¸é™Œç”Ÿï¼Œå¥½å¤„å°±æ˜¯é¿å…äº†å†—é•¿çš„ç¨‹åºåˆ—è¡¨ï¼Œå®šä½ä¹Ÿæ›´å¿«ã€‚\nå› ä¸ºæœ‰äº†Spotlightã€Alfredï¼ˆä¸‹é¢ä¼šæåˆ°ï¼‰ï¼ŒLaunchpadå¹¶ä¸ç®—æ˜¯ä¸€ä¸ªé«˜é¢‘æ“ä½œï¼Œæ‰€ä»¥æˆ‘æŠŠOptionæŒ‰é”®ç”¨æ¥åˆ†é…ç»„åˆé”®ï¼ŒOption+Wã€‚\nå¦å¤–ï¼ŒLaunchpadå¶å°”ä¼šæŠ½é£ï¼Œå°†åº”ç”¨é¡ºåºã€ç»„åˆå…¨éƒ¨æçš„é”™ä¹±ï¼Œè¿™ä¸ªä¹Ÿä¸ç”¨æ€•ï¼Œå®‰è£…Launchpad Manageræ¥ç®¡ç†Launchpadå¸ƒå±€ï¼Œå¹¶å°†æœ€æ–°å¸ƒå±€å¯¼å‡ºåˆ°icloudè¿›è¡Œå¤‡ä»½ï¼Œå¦‚æœå“ªå¤©æŠ½é£äº†ï¼Œæ‹¿å‡ºæ¥æ¢å¤ä¸€ä¸‹å°±å¯ä»¥ã€‚CleanMyMacæ‰«æå¤§æ–‡ä»¶çš„æ—¶å€™å¶å°”ä¼šå¹²æ‰Launchpadå¯¹åº”çš„æ•°æ®æ–‡ä»¶ï¼Œä»CleanMyMacçš„æœç´¢è·¯å¾„é‡Œå±è”½æ‰å°±å¯ä»¥äº†ã€‚\n3. Desktops\nç°ä»£çš„æ¡Œé¢æ“ä½œç³»ç»Ÿéƒ½æ”¯æŒå¤šä»»åŠ¡ï¼Œä¸€è¾¹å¬ç€éŸ³ä¹ï¼Œä¸€è¾¹å†™ç€æ–‡æ¡£ç­‰ç­‰ï¼Œè¿™æ˜¯å¸¸æœ‰çš„äº‹æƒ…ï¼Œç„¶è€Œæ¯ä¸ªäººç†è§£çš„å¤šä»»åŠ¡å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚\nå¯èƒ½æœ‰çš„ç”¨æˆ·çœŸçš„æ²¡é‚£ä¹ˆå¤šä»»åŠ¡è¦å¤„ç†ï¼Œä¹Ÿå°±æ˜¯ä¸€è¾¹å…¬æ”¾ç€éŸ³ä¹ï¼Œä¸€éæ–—åœ°ä¸»ï¼Œè¯¸å¦‚æ­¤ç±»ï¼Œé‚£ä¸€ä¸ªæ¡Œé¢å¯èƒ½å°±å¤Ÿäº†ã€‚ä½†æ˜¯ï¼Œå¤šä»»åŠ¡ä¹Ÿå¯èƒ½æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼Œç”šè‡³æ›´å¤šã€‚å¦‚æœçœŸçš„åªèƒ½é€šè¿‡Alt+Tabæ¥åˆ‡æ¢ç®€ç›´æ˜¯å™©æ¢¦ã€‚\nå¤šä¸ªè™šæ‹Ÿæ¡Œé¢çš„å¥½å¤„å°±ä½“ç°å‡ºæ¥äº†ï¼ŒUbuntu Unityé‡Œé¢çš„workspaceï¼ŒKDEé‡Œé¢çš„Pagesï¼ŒmacOSé‡Œé¢çš„Desktopï¼ŒWindows 10é‡Œé¢çš„taskviewï¼Œanywayï¼Œæ€»ä¹‹éƒ½æ˜¯ä¸€ä¸ªæ„æ€ï¼Œæ— éå°±æ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è¿›è¡Œä»»åŠ¡ç®¡ç†ã€‚æŒ‰ç…§ä»»åŠ¡ç±»åˆ«é€‚å½“å°†ä»»åŠ¡ç»„ç»‡åˆ°ä¸åŒçš„Desktopï¼Œå¹¶æŒ‰ç…§å°±è¿‘åŸåˆ™å°†å¸¸ç”¨çš„ä»»åŠ¡æ”¾åœ¨åˆ‡æ¢æ—¶æ›´å¿«é€Ÿè®¿é—®åˆ°çš„Desktopï¼Œæ˜¯ä¸ªæ¯”è¾ƒå¥½çš„åšæ³•ã€‚\né€šè¿‡è§¦æ§æ¿å¯ä»¥æ–¹ä¾¿åœ°åœ¨ä¸Šè¿°è™šæ‹ŸDesktopé—´è¿›è¡Œåˆ‡æ¢ï¼Œä¹Ÿå¯ä»¥å°†çª—å£ç§»åŠ¨åˆ°å…¶ä»–çš„Desktopã€‚è¯´åˆ°è¿™é‡Œå°±ä¸å¾—ä¸æè§¦æ§æ¿ã€çª—å£æ‹–åŠ¨ã€å¿«æ·é”®çš„è®¾ç½®ï¼Œå—¯ï¼Œè¿™é‡Œå…ˆåªè®²å¿«æ·é”®è®¾ç½®å§ã€‚\nå¿«æ·é”®å¿«é€Ÿåˆ‡æ¢Desktopï¼Œé»˜è®¤æ”¹æˆäº†Ctrl+Command+ Left Arrowï¼Œå…¶å®ç”¨è§¦æ§æ¿ä¹Ÿå¯ä»¥ï¼Œè‡³äºä¸ºä»€ä¹ˆæƒ³ç”¨å¿«æ·é”®ï¼Ÿå¯èƒ½ç”µè„‘å¤§å°æ¯”ä¾‹ä¸ç¬¦åˆäººä½“å·¥ç¨‹å­¦ï¼Œç»å¸¸æ€§åœ°è§¦æ§æ¿å·¦å³æ»‘åŠ¨ä¹‹åï¼Œä¼šæ„Ÿè§‰æ‰‹è…•å¾ˆç´¯â€¦â€¦æ‰€ä»¥é”®ç›˜ã€è§¦æ§æ¿äº¤æ›¿ç€ç”¨ï¼Œä¼šèˆ’æœä¸€ç‚¹ã€‚\nå¦‚æœå·¦å³åˆ‡æ¢éƒ½å«Œç´¯ï¼Œå«Œéº»çƒ¦ï¼Œæ‹–æ‹½çª—å£åˆ°å…¶ä»–Desktopå°±æ›´éº»çƒ¦äº†ï¼Œæ¯”å¦‚æœ‰çš„æ—¶å€™ä½ åœ¨Desktop1æ‰“å¼€äº†ä¸€ä¸ªç¼–è¾‘å™¨ï¼Œä½†æ˜¯ä½ åé¢æ„è¯†åˆ°å®ƒåº”è¯¥ç§»åŠ¨åˆ°å…¶ä»–Desktop2ä¸­å»ï¼ˆKDEé‡Œé¢æœ‰ç§æ›´å¥½çš„ç®¡ç†æ–¹å¼å«Activityï¼‰ï¼Œé‚£ä½ å°±å¾—æ‰‹åŠ¨ç§»åŠ¨è¿‡å»ï¼Œé—®é¢˜æ˜¯å¦‚æœDesktop2ä¸­çª—å£æ¯”è¾ƒå¤šï¼Œä½ ç§»åŠ¨è¿‡å»å‘ç°ï¼Œå”‰ï¼Œç§»åŠ¨é”™äº†ï¼Œåº”è¯¥ç§»åŠ¨åˆ°Desktop3ä¸­å»ï¼Œç„¶åä½ åˆå¼€å§‹æ‹–åŠ¨â€¦â€¦\næ•ˆç‡æ˜¯ä»€ä¹ˆï¼Œæ•ˆç‡å°±æ˜¯çŸ­å°ç²¾æ‚ï¼Œè®©å“åº”è·Ÿä¸Šæ€ç»´çš„é€Ÿåº¦ï¼Œè¿™ç§çœ‹ä¼¼ä¸èµ·çœ¼çš„äº‹æƒ…ï¼Œæˆ‘æ˜¯ä¸æ„¿æ„è®©å®ƒæ‚„æ‚„æ¶ˆè€—æ‰è‡ªå·±çš„æ—¶é—´ã€‚å¦‚æœæ”¯æŒå¿«æ·é”®å¿«é€Ÿå°†ä¸€ä¸ªçª—å£ç§»åŠ¨åˆ°å¦ä¸€ä¸ªDesktopä¼šæ–¹ä¾¿ä¸€ç‚¹ï¼Œå› ä¸ºå¿«æ·é”®å¯ä»¥è¿ç»­è§¦å‘ï¼Œè€Œä¸ç”¨å†æ¬¡æ‹–æ‹½æ¥ä¸ªä½ç§»ã€‚KDEé‡Œé¢pagesç®¡ç†ï¼Œæ˜¯æœ‰è€ƒè™‘åˆ°è¿™äº›çš„ï¼ŒmacOSé‡Œé¢æ²¡æœ‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åšåˆ°ï¼Œåªä¸è¿‡å˜›å°±è¦è‡ªå·±åŠ¨æ‰‹äº†ã€‚\nHammerspoonï¼ˆä¸‹æ–‡ä¼šæåˆ°ï¼‰æ˜¯é’ˆå¯¹macOSæä¾›çš„ä¸€ä¸ªå¯æ‰©å±•çš„å·¥å…·ï¼Œé€šè¿‡luaè„šæœ¬å°è£…äº†å¤§å¤šæ•°çš„macOSç³»ç»Ÿç¼–ç¨‹æ¥å£ï¼Œå¦‚æœä½ æƒ³å®šåˆ¶åŒ–ä¸€äº›æ“ä½œï¼Œåªè¦çœ‹ç€hammerspoonçš„æ–‡æ¡£å†™luaè„šæœ¬å°±å¯ä»¥äº†ï¼Œè®ºä¸€ä¸ªå¼€å‘è€…çš„å¥½å¤„ã€‚\nå†™è¿™ä¹ˆä¸€æ®µluaè„šæœ¬ï¼Œæ”¾ç½®åˆ°~/.hammerspoonç›®å½•ä¸‹ï¼Œå°±æ”¯æŒå¿«æ·é”®Shift+Ctrl+Cmd+Arrow Keysæ¥å¿«é€Ÿç§»åŠ¨çª—å£äº†ï¼Œè‡³äºä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªå¿«æ·é”®ï¼Œä¹ æƒ¯ï¼ŒKDEä¸‹é¢å¤šå¹´å…»æˆçš„ä¹ æƒ¯ã€‚\n4 Trackpad\nè§¦æ§æ¿è¿˜éœ€è¦è®¾ç½®å—ï¼Œè¦è®¾ç½®ï¼Œé€‚åˆè‡ªå·±çš„æ‰æ˜¯æœ€å¥½çš„ã€‚\nTap to clickï¼Œç‚¹é€‰è¿™ä¸ªå‹¾ä¸Šï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡â€œæŒ‰â€ä¸€ä¸‹æ‰è§¦å‘å•å‡»æ“ä½œã€‚\nScroll direction: Naturalï¼Œè¿™ä¸ªæ»šåŠ¨æ–¹å‘ï¼Œç°åœ¨è™½ç„¶ä¸ç”¨é¼ æ ‡äº†ï¼Œä½†æ˜¯ä¹ æƒ¯å…»æˆäº†ã€‚æ¯”å¦‚æµè§ˆç½‘é¡µçš„æ—¶å€™ï¼Œæƒ³ä»é¡µé¢åº•éƒ¨å›åˆ°é¡¶éƒ¨ï¼Œæˆ–è€…å¸Œæœ›å‘ä¸Šæ»šåŠ¨ï¼Œæˆ‘æƒ³çš„æ˜¯ï¼ŒæŠŠé¡µé¢å¾€ä¸‹æ‹½ä¸€ä¸‹é¡µé¢é¡¶éƒ¨çš„ä½ç½®å°±å±•ç¤ºåœ¨çœ¼å‰äº†ã€‚è¿™é‡Œçš„naturalæ»šåŠ¨æ–¹å‘æˆ‘å°±å¾ˆéš¾é€‚åº”ï¼Œæœ‰ç›¸ä¼¼çš„å¯ä»¥å–æ¶ˆå‹¾é€‰ã€‚\næˆ‘ä¸æƒ³çŸ¥é“è‡ªå·±å¹²ä»€ä¹ˆçš„æ—¶å€™è¯¥ç”¨å‡ æ ¹æ‰‹æŒ‡ï¼Œæˆ‘åªæƒ³å®Œæˆæƒ³å¹²çš„äº‹æƒ…ã€‚æ‰€ä»¥æˆ‘å‡ ä¹éƒ½è®¾ç½®æˆäº†å››æŒ‡æ“ä½œï¼Œæœ‰çš„æœ€å¤šåªæœ‰ä¸‰æŒ‡çš„ï¼Œé‚£å°±ä¸‰æŒ‡å¥½äº†ï¼Œåæ­£å››æŒ‡ä¹Ÿå¯ä»¥è§¦å‘ï¼Œå»æ‰è¿™äº›è®°å¿†è´Ÿæ‹…ã€‚\nä½¿ç”¨è§¦æ‘¸æ¿æ‹–åŠ¨çª—å£ï¼Œé»˜è®¤è®¾ç½®æ˜¯å…ˆç‚¹æŒ‰çª—å£æ ‡é¢˜æ ï¼ŒæŒ‰ä½ä¸æ”¾ï¼Œå†ä¸€åªæ‰‹å°†å…¶æ‹–åŠ¨ï¼Œè¿™ä¸ªæ“ä½œå¾ˆä¸æ–¹ä¾¿ï¼Œè®¾ç½®ä¸‹å¯ä»¥ç›´æ¥ä¸‰æŒ‡çª—å£æ‹–åŠ¨ã€‚ç°å®åœºæ™¯ä¸­ï¼Œä¸€èˆ¬æˆ‘æ˜¯é€šè¿‡hammerspoonè‡ªå®šä¹‰è„šæœ¬æ¥å®Œæˆçš„ï¼šæœ€å¤§åŒ–ã€æœ€å°åŒ–ã€å±…ä¸­ã€å·¦åŠå±ã€å³åŠå±ç­‰ã€‚ä½†æ˜¯ï¼Œç§»åŠ¨çª—å£çš„éœ€æ±‚è¿˜æ˜¯æœ‰çš„ã€‚\n5 Keyboard\né”®ç›˜è®¾ç½®ï¼Œé»˜è®¤é”®ç›˜è®¾ç½®ï¼Œå¯¹ç»å¸¸éœ€è¦æ–‡å­—ç¼–è¾‘å·¥ä½œçš„æœ‹å‹æ¥è®²ä¸ç®—å‹å¥½ï¼Œä¸»è¦æœ‰å‡ ä¸ªæ–¹é¢æˆ‘è§‰å¾—è¦è°ƒæ•´ã€‚\nä¸­è‹±æ–‡åˆ‡æ¢æ–¹é¢\næœç‹—è¾“å…¥æ³•ç”¨äº†å¾ˆå¤šå¹´ï¼Œä¹Ÿæ˜¯å›½å†…å‚å•†æ¯”è¾ƒæ—©æ”¯æŒLinuxçš„å…¨æ‹¼è¾“å…¥æ³•ï¼Œå¯¹å…¶å°è±¡å¾ˆå¥½ï¼Œè€Œä¸”æ”¯æŒä¸ªäººè¯åº“åŒæ­¥ï¼Œè¿™ä¹ˆå¤šå¹´å½•å…¥çš„è¯åº“ä¹Ÿæ˜¯æ„¿æ„ç»§ç»­ä½¿ç”¨çš„ä¸»è¦åŸå› ï¼Œæ²¡æœ‰ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„æ‹¼éŸ³è¾“å…¥æ³•ã€‚\næœç‹—è¾“å…¥æ³•shiftæŒ‰é”®æ”¯æŒå¿«é€Ÿåœ¨ä¸­è‹±æ–‡ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè¿™ä¸ªæƒ³å¿…å¤§å®¶éƒ½çŸ¥é“ã€‚ä½œä¸ºä¸€åå¼€å‘è€…ï¼Œå¿«é€Ÿåœ¨ä¸­è‹±æ–‡ä¹‹é—´è¿›è¡Œåˆ‡æ¢æ˜¯å¸¸æœ‰çš„äº‹ï¼Œä½†æ˜¯åˆ‡æ¢è¾“å…¥æ³•ä¹Ÿè¦ç»†åˆ†åœºæ™¯ã€‚\næ¯”å¦‚ç°åœ¨è¦å‡†å¤‡å†™ä¸€å¤§æ®µä»£ç äº†ï¼Œé‚£å¯èƒ½è¿™æ®µæ—¶é—´å†…å…¨æ˜¯è‹±æ–‡æ¯”è¾ƒå¥½ï¼Œé‚£æŒ‰shiftåˆ‡æ¢æˆè‹±æ–‡å°±ä¸å¤ªåˆé€‚ï¼Œå› ä¸ºä¸€ä¸å°å¿ƒå†æŒ‰ä¸‹shiftå¯èƒ½ä¼šè®©æˆ‘è¯¯è¾“å…¥ä¸­æ–‡ï¼›\nå†æ¯”å¦‚ç°åœ¨å‡†å¤‡åˆ‡æˆä¸­æ–‡å†™å‡ è¡Œæ³¨é‡Šï¼Œå†™å®Œç«‹å³æ¥ç€å†™ä»£ç ï¼Œé‚£å¯èƒ½æŒ‰shiftåˆ‡æ¢å°±æ¯”è¾ƒåˆé€‚ï¼›\nå†æ¯”å¦‚ç¼–è¾‘æœŸé—´æ¶‰åŠåˆ°çª—å£åˆ‡æ¢ï¼Œæ¯”å¦‚å»å‚è€ƒä¸‹æ–‡æ¡£ã€èµ„æ–™â€¦â€¦ç„¶åå›æ¥æ¥ç€ç»§ç»­åˆšæ‰çš„å·¥ä½œï¼Œä½ ä¼šå‘ç°è¾“å…¥æ³•ä¸­è‹±æ–‡ä½ å·²ç»ä¸è®°å¾—äº†ï¼Œå¦‚ä½•ç¡®ä¿ç°åœ¨è¾“å…¥è‹±æ–‡æˆ–ä¸­æ–‡ï¼›\nè¿™éƒ½æ˜¯å½±å“æ–‡å­—ç¼–è¾‘æ•ˆç‡çš„é—®é¢˜ï¼Œæˆ‘æ˜¯è¿™ä¹ˆè§£å†³çš„ï¼Œä¹Ÿå¾ˆç®€å•ï¼š\nCommand+Spaceæ‰§è¡Œåˆ‡æ¢æ—¶ï¼Œæ€»æ˜¯ä¼šå°†æœç‹—åˆ‡æ¢åˆ°ä¸­æ–‡è¾“å…¥æ³•ï¼Œè€ŒCtrl+Spaceä¸ä¸€å®šï¼Œè¿˜æœ‰å¦ä¸€ä¸ªåŒºåˆ«ï¼Œå‰è€…è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢æ—¶ï¼Œå¦‚æœæŒ‰é”®é‡Šæ”¾æ—¶é—´ç¨é•¿ï¼Œä¼šæç¤ºå½“å‰æ­£åˆ‡æ¢åˆ°çš„è¾“å…¥æ³•åç§°ã€‚ä¸€ä¸¾ä¸‰å¾—ï¼\næ–‡å­—è¾“å…¥é€Ÿåº¦æ–¹é¢\nå½±å“æ–‡å­—è¾“å…¥çš„ï¼Œä¸ä»…æœ‰å®é™…çš„å‡»é”®é€Ÿåº¦ã€å‡†ç¡®ç‡ï¼Œè¿˜æœ‰è¿™ç©æ„ã€‚Key Repeatã€Delay Until Repeatè¿™ä¸¤ä¸ªé€‰é¡¹ä¸€ä¸ªæ˜¯ç”¨äºæ§åˆ¶æŒ‰é”®é‡å¤é‡å‘çš„é€Ÿç‡ï¼Œä¸€ä¸ªæ˜¯ç”¨äºæ§åˆ¶æŒ‰é”®åˆå§‹å»¶è¿Ÿï¼Œé»˜è®¤å€¼æ˜¯è€ƒè™‘åˆ°ç”¨æˆ·è¯¯è¾“å…¥çš„æƒ…æ™¯ï¼Œå‡å°äº†å‰è€…ï¼Œå¢å¤§äº†åè€…ã€‚\nä¸è¿‡ï¼Œå¯¹æœ‰ç‰¹æ®Šéœ€æ±‚çš„å¼€å‘è€…ã€æ–‡å­—å·¥ä½œè€…ï¼Œå¯èƒ½å°±æ²¡é‚£ä¹ˆå‹å¥½äº†ï¼Œç›´æ¥å°†Key Repeatè°ƒåˆ°æœ€å¤§ï¼ŒDelay Until Repeatè°ƒåˆ°æœ€ä½ã€‚\nä¿®æ”¹å®Œæˆåï¼Œå¦‚æœæ„Ÿè§‰è¿˜æ˜¯ä¸æ»¡æ„ï¼Œé‚£åªèƒ½é€šè¿‡defaultså‘½ä»¤æ¥ä¿®æ”¹é…ç½®äº†ï¼Œä¸å¯¹è¿™é‡Œçš„è®¾ç½®è¿›è¡Œä¼˜åŒ–ï¼Œä¼šè®©Vimå…šå¾ˆæŠ“ç‹‚ï¼Œç»å¯¹æš´èºçš„èµ·æ¥ï¼ˆæƒ³è±¡ä¸‹hjklæ€ä¹ˆç©ï¼‰ã€‚\ndefaults write NSGlobalDomain KeyRepeat -int 3 defaults write NSGlobalDomain InitialKeyRepeat -int 12 defaults write -g ApplePressAndHoldEnabled -bool false  å¿«æ·é”®æ–¹é¢\næ–°ç‰ˆçš„mbpéƒ½å¸¦äº†touchbarï¼Œtouchbaræœ‰æ—¶å€™æœ‰ç”¨ï¼Œæœ‰æ—¶å€™æ²¡ç”¨ï¼Œå¯¹å®é™…ç»å¸¸éœ€è¦ç”¨åˆ°F1~F12å¿«æ·é”®çš„åŒå­¦æ¥è¯´ï¼Œtouchbarè¿˜çœŸæœ‰ç‚¹æ²¡é‚£ä¹ˆå®ç”¨ã€‚æ‰€ä»¥touchbarä¸Šé¢é»˜è®¤æ˜¾ç¤ºF1, F2, etc. Keysã€‚\næˆªå±æ“ä½œï¼šç®—æ˜¯ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å¿«æ·é”®å§ï¼Œä¸€ä¸ªæ˜¯æˆªå±æŒ‡å®šåŒºåŸŸåˆ°å‰ªè´´æ¿ï¼Œä¸€ä¸ªæ˜¯æˆªå±æŒ‡å®šåŒºåŸŸä¿å­˜åˆ°æœ¬åœ°ã€‚\nFinderæœç´¢ï¼šFinderä¸­æœç´¢æ–‡ä»¶ä¹Ÿæ˜¯å¸¸è§æ“ä½œï¼Ÿä¸ä¼šå§ï¼Œå·²ç»æœ‰spotlightäº†ï¼Œä½†æ˜¯æ‰“å¼€Finderåº”è¯¥æ˜¯ä¸ªå¸¸è§æ“ä½œï¼Œä½†æ˜¯macOSæ²¡æœ‰æä¾›è¿™æ ·çš„å¿«æ·é”®ï¼Œå¯ä»¥é€šè¿‡è¿™é‡Œçš„Show Finder search windowæ¥ä»£æ›¿ä¸‹ï¼Œå¿«æ·é”®ä¿æŒäº†ä¸windowsä¸€è‡´ï¼ŒCtrl+Fã€‚\né‚£å¦‚æœçœŸçš„åªæƒ³å¿«é€Ÿæ‰“å¼€Finderæ–°çª—å£å‘¢ï¼Ÿæ¯”å¦‚Option+Eæ‰“å¼€Finderçª—å£ï¼Œå®šä½åˆ°homeç›®å½•ï¼Ÿä¸€æ ·å¯ä»¥é€šè¿‡hammerspoon luaè„šæœ¬æå®šã€‚\nå†æˆ–è€…ï¼Œé€šè¿‡Ctrl+Cmd+Tæ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡hs luaè„šæœ¬æå®šã€‚\nå—¯ï¼Œè¿˜æœ‰ä¸ªä¸å¾—ä¸æçš„é—®é¢˜ï¼Œé‚£å°±æ˜¯Command+Hè¿™ä¸ªå¿«æ·é”®ï¼ŒmacOSä¸‹é»˜è®¤æ˜¯Hide Windowï¼Œè¿™ä¸ªä¸è¡Œï¼Œæˆ‘åœ¨IDEé‡Œé¢å¸Œæœ›ç”¨è¿™ä¸ªå¿«æ·é”®æ¥å”¤å‡ºAPIè¯´æ˜ä¿¡æ¯ï¼Œä½ ç»™æˆ‘éšè—äº†ä¸è¡Œã€‚é‚£æ€ä¹ˆåŠï¼ŒæŠŠè¿™ä¸ªCommand+Hå¿«æ·é”®é‡æ–°æ˜ å°„ï¼Œä¸è®©å®ƒæ‰§è¡Œç³»ç»Ÿé»˜è®¤çš„æ“ä½œã€‚ä¸€æ ·çš„é€šè¿‡hs luaè„šæœ¬æ¥å®Œæˆã€‚\nå½“ç”¨æˆ·æŒ‰ä¸‹Command+Hè¿™ä¸ªåŠ¨ä½œçš„æ—¶å€™ï¼Œå®é™…ä¸Šåº”ç”¨ç¨‹åºçœ‹åˆ°çš„æ˜¯Command+Mï¼Œä¸€èˆ¬Command+Måº”ç”¨ç¨‹åºæ²¡è¿™ä¸ªå¿«æ·é”®çš„è¯ï¼Œä¹Ÿå°±æ²¡æœ‰ä»»ä½•åŠ¨ä½œï¼Œå°±å±è”½æ‰äº†â€œHide Windowâ€è¿™ä¸ªåŠ¨ä½œï¼Œå¦‚æœä½ çœŸçš„æƒ³é€šè¿‡Command+Hæ¥å”¤å‡ºAPIè¯´æ˜çš„è¯ï¼Œé‚£ä¹ˆåªè¦å°†è¿™ä¸ªåŠ¨ä½œç»‘å®šåˆ°Command+Mä¸Šå°±å¯ä»¥äº†ğŸ˜ƒã€‚\næ­¤å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºä¹Ÿéœ€è¦å®šåˆ¶å¿«æ·é”®ï¼ŒChromeæä¾›çš„é»˜è®¤å¿«æ·é”®çœŸçš„æ˜¯åäººç±»ï¼Œè®©æˆ‘è§‰å¾—è¦å¤šé•¿å‡ åªæ‰‹æ‰å¤Ÿç”¨ï¼Œ4ä¸ªæŒ‰é”®åˆ†å¸ƒåœ¨ä¸€åªæ‰‹çš„åŒºåŸŸï¼Œæ€ä¹ˆæŒ‰è¿‡æ¥ï¼Œæˆ–è€…æˆ‘çš„æ‰‹æŒ‡èƒ½å¤šæ‹å‡ ä¸ªå¼¯ï¼Ÿå“ˆå“ˆï¼Œæä¸äº†ï¼Œå¿…é¡»æ”¹ã€‚\nä½†æ˜¯æ™®é€šåº”ç”¨ç¨‹åºå¿«æ·é”®ï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šï¼Œæ€ä¹ˆåŒæ­¥å‘¢ï¼Ÿå‡ åä¸ªè‚¯å®šæ˜¯æœ‰çš„ï¼å¯¹ç…§ç€è€çš„æœºå™¨å…¨éƒ¨è®¾ç½®ä¸€éä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œé—®é¢˜æ˜¯ä¸æƒ³è¿™ä¹ˆæœºæ¢°åœ°æä¸€éå‘¢ã€‚macOSé‡Œé¢è¦ä¸€ä¸ªèœå•åä¸€ä¸ªèœå•åè¿™æ ·çš„å½•å…¥ï¼Œæ‰èƒ½å†ç»‘å®šå¿«æ·é”®ã€‚å¹¶ä¸æ˜¯è¯´åªæ˜¯é‡æ–°æ¢ä¸ªå¿«æ·é”®ç»„åˆå°±å®Œäº‹ï¼Œæ‰€ä»¥è¿™è¿˜æ˜¯ä½“åŠ›æ´»ã€‚\nè¿™é‡Œå…ˆåœ¨è€æœºå™¨ä¸Šï¼Œé€šè¿‡defaults findå‘½ä»¤æ‰¾åˆ°ç”¨æˆ·æ‰€æœ‰çš„å¿«æ·é”®è®¾ç½®ï¼Œæ¯”å¦‚ï¼š\ndefaults find NSUserKeyEquivalents Found 1 keys in domain 'abnerworks.Typora': { NSUserKeyEquivalents = { Articles = \u0026quot;\\\\Uf706\u0026quot;; Code = \u0026quot;@k\u0026quot;; \u0026quot;Code Fences\u0026quot; = \u0026quot;@^k\u0026quot;; \u0026quot;File Tree\u0026quot; = \u0026quot;\\\\Uf704\u0026quot;; \u0026quot;Focus Mode\u0026quot; = \u0026quot;@$f\u0026quot;; \u0026quot;Full Screen\u0026quot; = \u0026quot;\\\\Uf70e\u0026quot;; Outline = \u0026quot;\\\\Uf705\u0026quot;; \u0026quot;Rename...\u0026quot; = \u0026quot;$\\\\Uf709\u0026quot;; Search = \u0026quot;@^f\u0026quot;; \u0026quot;Source Code Mode\u0026quot; = \u0026quot;@r\u0026quot;; \u0026quot;Toggle Sidebar\u0026quot; = \u0026quot;\\\\Uf707\u0026quot;; \u0026quot;Typewriter Mode\u0026quot; = \u0026quot;@$t\u0026quot;; }; } Found 1 keys in domain 'com.apple.Preview': { NSUserKeyEquivalents = { Bookmarks = \u0026quot;@3\u0026quot;; \u0026quot;Hide Markup Toolbar\u0026quot; = \u0026quot;@^m\u0026quot;; \u0026quot;Hide Sidebar\u0026quot; = \u0026quot;@0\u0026quot;; \u0026quot;Highlights and Notes\u0026quot; = \u0026quot;@2\u0026quot;; \u0026quot;Show Markup Toolbar\u0026quot; = \u0026quot;@^m\u0026quot;; \u0026quot;Show Sidebar\u0026quot; = \u0026quot;@0\u0026quot;; \u0026quot;Table of Contents\u0026quot; = \u0026quot;@1\u0026quot;; }; } Found 1 keys in domain 'com.google.Chrome': { NSUserKeyEquivalents = { \u0026quot;Always Show Bookmarks Bar\u0026quot; = \u0026quot;^$b\u0026quot;; \u0026quot;Close Window\u0026quot; = \u0026quot;@w\u0026quot;; \u0026quot;Developer Tools\u0026quot; = \u0026quot;\\\\Uf70f\u0026quot;; Downloads = \u0026quot;^j\u0026quot;; \u0026quot;Force Reload This Page\u0026quot; = \u0026quot;\\\\Uf708\u0026quot;; \u0026quot;New Incognito Window\u0026quot; = \u0026quot;^i\u0026quot;; \u0026quot;Open Location...\u0026quot; = \u0026quot;\\\\Uf709\u0026quot;; Redo = \u0026quot;@y\u0026quot;; \u0026quot;Reload This Page\u0026quot; = \u0026quot;@r\u0026quot;; \u0026quot;Reopen Closed Tab\u0026quot; = \u0026quot;^$t\u0026quot;; \u0026quot;Show Full History\u0026quot; = \u0026quot;^h\u0026quot;; }; } ...  æŠŠè¿™ä¸ªå¯¼å‡ºæ¥ï¼Œå†™ä¸€ä¸ªbashè„šæœ¬ï¼Œç”¨defaults writeå‘½ä»¤æ¥æ›´æ–°ç³»ç»Ÿä¸­åº”ç”¨çš„é»˜è®¤è®¾ç½®ï¼š\n#!/bin/bash defaults write Apple Global Domain NSUserKeyEquivalents ' { \u0026quot;Enter Full Screen\u0026quot; = \u0026quot;\\\\Uf70e\u0026quot;; \u0026quot;Exit Full Screen\u0026quot; = \u0026quot;\\\\Uf70e\u0026quot;; Hyperlink = \u0026quot;@l\u0026quot;; Minimize = \u0026quot;~^\\\\U2193\u0026quot;; }' defaults write com.apple.Preview NSUserKeyEquivalents ' { Bookmarks = \u0026quot;@3\u0026quot;; \u0026quot;Hide Markup Toolbar\u0026quot; = \u0026quot;@^m\u0026quot;; \u0026quot;Hide Sidebar\u0026quot; = \u0026quot;@0\u0026quot;; \u0026quot;Highlights and Notes\u0026quot; = \u0026quot;@2\u0026quot;; \u0026quot;Show Markup Toolbar\u0026quot; = \u0026quot;@^m\u0026quot;; \u0026quot;Show Sidebar\u0026quot; = \u0026quot;@0\u0026quot;; \u0026quot;Table of Contents\u0026quot; = \u0026quot;@1\u0026quot;; }' defaults write com.google.Chrome NSUserKeyEquivalents ' { \u0026quot;Always Show Bookmarks Bar\u0026quot; = \u0026quot;^$b\u0026quot;; \u0026quot;Close Window\u0026quot; = \u0026quot;@w\u0026quot;; \u0026quot;Developer Tools\u0026quot; = \u0026quot;\\\\Uf70f\u0026quot;; Downloads = \u0026quot;^j\u0026quot;; \u0026quot;Force Reload This Page\u0026quot; = \u0026quot;\\\\Uf708\u0026quot;; \u0026quot;New Incognito Window\u0026quot; = \u0026quot;^i\u0026quot;; \u0026quot;Open Location...\u0026quot; = \u0026quot;\\\\Uf709\u0026quot;; Redo = \u0026quot;@y\u0026quot;; \u0026quot;Reload This Page\u0026quot; = \u0026quot;@r\u0026quot;; \u0026quot;Reopen Closed Tab\u0026quot; = \u0026quot;^$t\u0026quot;; \u0026quot;Show Full History\u0026quot; = \u0026quot;^h\u0026quot;; }' defaults write abnerworks.Typora NSUserKeyEquivalents ' { Articles = \u0026quot;\\\\Uf706\u0026quot;; Code = \u0026quot;@k\u0026quot;; \u0026quot;Code Fences\u0026quot; = \u0026quot;@^k\u0026quot;; \u0026quot;File Tree\u0026quot; = \u0026quot;\\\\Uf704\u0026quot;; \u0026quot;Focus Mode\u0026quot; = \u0026quot;@$f\u0026quot;; \u0026quot;Full Screen\u0026quot; = \u0026quot;\\\\Uf70e\u0026quot;; Outline = \u0026quot;\\\\Uf705\u0026quot;; \u0026quot;Rename...\u0026quot; = \u0026quot;$\\\\Uf709\u0026quot;; Search = \u0026quot;@^f\u0026quot;; \u0026quot;Source Code Mode\u0026quot; = \u0026quot;@r\u0026quot;; \u0026quot;Toggle Sidebar\u0026quot; = \u0026quot;\\\\Uf707\u0026quot;; \u0026quot;Typewriter Mode\u0026quot; = \u0026quot;@$t\u0026quot;; }' ... killall cfprefsd  åœ¨æ–°æœºå™¨ä¸Šï¼ŒæŠŠbashè„šæœ¬æ‰§è¡Œä¸‹å°±å¯ä»¥äº†ï¼Œso easy! ä¸‹æ¬¡å¦‚æœæœ‰éœ€è¦æ‹¿æ¥é‡è·‘ä¸‹å°±å¯ä»¥ï¼Œåº”ç”¨ç¨‹åºå¿«æ·é”®è®¾ç½®å¾ˆå¿«å°±èƒ½æå®šã€‚\nå¿«æ·é”®åˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ã€‚\n6 æ•ˆç‡å·¥å…·\nHammerspoon\nHammerspoonï¼Œå‰é¢ä¸æ­¢ä¸€æ¬¡æåˆ°äº†ï¼Œå®ƒçš„å¼ºå¤§è‡ªä¸å¿…å¤šè¨€ï¼Œçœ‹æ–‡æ¡£https://www.hammerspoon.org/docs/index.htmlï¼Œæ”¯æŒçš„æ“ä½œæ¶‰åŠåˆ°äº†ç³»ç»Ÿçš„æ–¹æ–¹é¢é¢ï¼Œåªè¦ä¼šçœ‹ç€æ–‡æ¡£æ‹¼ç§¯æœ¨å°±å¯ä»¥ã€‚æˆ‘ç”¨å®ƒæ¥å®ç°å¤æ‚çš„é”®æ˜ å°„å¤„ç†ã€çª—å£ç®¡ç†ã€æ¡Œé¢ç®¡ç†ç­‰å®šåˆ¶çš„æ“ä½œã€‚\nå¯¹æ™®é€šç”¨æˆ·æ²¡é‚£ä¹ˆå‹å¥½ï¼Œä½†æ˜¯ä¸€äº›éš¾æçš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ä¸ªäººçš„å®šåˆ¶åŒ–ï¼Œå¾€å¾€ä¹Ÿè¦è‡ªå·±æ¥æäº†ï¼Œç”¨å®ƒæ’¸å‡ è¡Œä»£ç å°±å¯ä»¥æå®šã€‚\nAlfred\nAlfredï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ•ˆç‡å·¥å…·ï¼Œå¯ä»¥è¯´å®ƒå’ŒSpotlightæœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ï¼Œæˆ‘ä»¬å‰é¢å…ˆæäº†Spotlightçš„åŸå› æ˜¯ï¼Œå¦‚æœä½ è®¤åŒSpotlightçš„ä»·å€¼ï¼Œé‚£ä¹ˆèŠ±æ—¶é—´å»æ¢ç´¢Alfredæ‰æœ‰æ„ä¹‰ã€‚\nAlfredåœ¨SpotlightåŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œæä¾›äº†é¢å¤–çš„å®šåˆ¶èƒ½åŠ›ï¼Œå®ƒèƒ½å¹²ä»€ä¹ˆå‘¢ï¼Ÿ\nå®šåˆ¶Web Search\nè¿™æ ·ä½ å°±å¯ä»¥é€šè¿‡å…³é”®å­—å¿«é€Ÿæ‰“å¼€ï¼ˆæµè§ˆå™¨æ”¶è—å¤¹æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä½†ç»ä¸æ˜¯æœ€å¥½çš„ä¸œè¥¿ï¼‰ï¼Œç„¶åè¾“å…¥çš„å…³é”®å­—ä¼šè¢«å½“åšæœç´¢å‚æ•°ä¼ å…¥ï¼Œä¾‹å¦‚è®©googleå¸®ä½ æœç´¢ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å½“åšæµè§ˆå™¨æ”¶è—å¤¹æ¥ç”¨ã€‚\nå®šåˆ¶Workflow\niOSä¸Šé¢çš„æ·å¾„ï¼Œå¤§å®¶ä½“éªŒè¿‡æ²¡ï¼Œå¤§è‡´ä¸Šæ˜¯ä¸€æ ·çš„ä¸œè¥¿ï¼ŒmacOSä¸Šæœ¬èº«æ˜¯æœ‰Automationçš„ï¼ŒAlfredçš„å¥½å¤„å°±æ˜¯æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ç®¡ç†ã€å¯è§†åŒ–é…ç½®ã€åŒæ­¥é…ç½®ï¼Œè€Œä¸”è¿˜è¦æ¯”è¾ƒå¥½çš„ç”¨æˆ·ç”Ÿæ€ï¼Œä½ å¯ä»¥æœç´¢åˆ°ä»–äººè´¡çŒ®çš„workflowï¼Œä¹Ÿå¯ä»¥è‡ªå·±å†™ã€‚\næ¯”å¦‚ä¸‹é¢gistæ˜¯ä¸€ä¸ªæ”¯æŒgistæœç´¢ã€åˆ›å»ºçš„workflowï¼Œå½“ä½ æƒ³ä½¿ç”¨ä»¥å‰ç§¯ç´¯çš„ä»£ç snippetï¼Œæˆ–è€…åˆ›å»ºæ–°çš„å¤‡ç”¨çš„æ—¶å€™ï¼Œéå¸¸æ–¹ä¾¿ã€‚\nå†æ¯”å¦‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¼ºå¯†ç ç”Ÿæˆå™¨ï¼Œæƒ³é äººè‚‰è®°ä½çš„å¯†ç éƒ½ç®—ä¸ä¸Šä»€ä¹ˆå¼ºå¯†ç ï¼Œå®‰å…¨çš„åšæ³•å°±æ˜¯éšæœºç”Ÿæˆä¸€ä¸ªï¼Œè¿è‡ªå·±ä¹Ÿä¸çŸ¥é“æ˜¯ä»€ä¹ˆï¼Œç„¶åäº¤ç»™keychainæ¥ç®¡ç†ã€‚\næ—¶é—´ä¹…äº†ï¼Œè¿™é‡Œçš„è®¾ç½®å°±ä¼šæ¯”è¾ƒå¤šï¼Œå¦‚æœæ¶‰åŠåˆ°å¤šå°è®¾å¤‡çš„è¯ï¼Œå¦‚ä½•åŒæ­¥ä¹Ÿéœ€è¦è€ƒè™‘ã€‚è¿™é‡Œä¸å»ºè®®ä½¿ç”¨icloudæ­¤ç±»è¿›è¡Œå­˜å‚¨ï¼Œå› ä¸ºä¸€æ—¦å‡ºç°å¤šå°è®¾å¤‡Alfredç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œæœ‰å¯èƒ½å› ä¸ºæ— æ³•æ­£å¸¸è§£æé…ç½®è€Œé‡å»ºé…ç½®ï¼Œåˆ°æ—¶å€™å¦‚æœicloudåŒæ­¥äº†å¤šå°è®¾å¤‡ä¸Šçš„æ•°æ®ï¼Œå°±ç©å®Œäº†ï¼ˆé‡åˆ°è¿‡ä¸€æ¬¡ï¼‰ã€‚\nå»ºè®®é€šè¿‡githubç­‰æ”¯æŒç‰ˆæœ¬ç®¡ç†çš„ç¬¬ä¸‰æ–¹å¹³å°è¿›è¡Œé…ç½®æ‰˜ç®¡ï¼Œæˆ‘ç°åœ¨æ˜¯é€šè¿‡github ä»“åº“è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚\n7 æµè§ˆå™¨\næµè§ˆå™¨ä½ é€‰å“ªæ¬¾ï¼ŸiOSè®¾å¤‡æˆ‘é€‰Safariï¼ŒmacOSæˆ‘é€‰Chromeï¼Œä¸ºå•¥ï¼Œæˆ‘å½“ç„¶æƒ³å…¨éƒ¨ç”¨Safariï¼Œç§»åŠ¨ç«¯Safariä½“éªŒæ¯”Chromeå¼ºå¤ªå¤šï¼Œç”µè„‘ä¸Šä¸è¡Œï¼Œæ²¡é‚£ä¹ˆå¤šextensionsã€appsæ¥æ‰©å±•æµè§ˆå™¨åŠŸèƒ½ï¼ŒChromeåœ¨æ¡Œé¢ä¸Šå¾ˆå¼ºå¤§ã€‚\næˆ‘çš„å¸¸ç”¨æ‰©å±•åˆ—è¡¨ï¼Œå±è”½å¹¿å‘Šã€ä»£ç†ã€æ²¹çŒ´æ‰©å±•è„šæœ¬ã€vimå…šä¸“å±vimiumã€‚ä¹‹å‰æœ‰ä¸ªåŒå­¦é—®æˆ‘ä½ çš„ç™¾åº¦é¡µé¢æ€ä¹ˆæ²¡å¹¿å‘Šå•Šï¼Œå› ä¸ºè¢«Adblockå±è”½äº†å•Šã€‚æ²¹çŒ´ä¸Šè„šæœ¬å¤šçš„äº†ä¸å¾—ï¼Œä¸‹è½½è§†é¢‘å•Šç­‰ç­‰ç­‰ã€‚\næˆ‘æ¯”è¾ƒå–œæ¬¢vimiumï¼Œå®ƒè®©æˆ‘å¯ä»¥ç”¨vimçš„æ“ä½œæ–¹å¼æ¥æ“ä½œChromeé¡µé¢ã€‚æ¯”å¦‚ï¼š\nx: å…³é—­å½“å‰æ ‡ç­¾é¡µ\nyt: åˆ›å»ºæ–°æ ‡ç­¾é¡µ\n/: å¼€å§‹é¡µé¢å†…æœç´¢\nhjklï¼šé¡µé¢å†…ä¸Šä¸‹å·¦å³æ»šåŠ¨\nggï¼šå›åˆ°é¡µé¢é¡¶éƒ¨\nf: å°†é¡µé¢ä¸­è¶…é“¾æ¥å…¨éƒ¨é«˜äº®æ˜¾ç¤ºï¼Œå¹¶æŒ‰å­—æ¯ç¼–å·ï¼Œç„¶åä½ å¯ä»¥é€šè¿‡ç¼–å·è§¦å‘é“¾æ¥ï¼Œç½‘é¡µæµè§ˆçš„æ—¶å€™å¯ä»¥å¿˜æ‰è§¦æ‘¸æ¿äº†\niï¼šç›´æ¥è¿›å…¥æœç´¢æ¡†ï¼Œtabåœ¨å¤šä¸ªæ–‡æœ¬æ¡†ä¹‹é—´åˆ‡æ¢\n\u0026hellip;\nå½“ç„¶Chrome Web Storeé‡Œé¢ä¹Ÿæœ‰ä¸€äº›ç¦»çº¿å¯ä»¥ä½¿ç”¨çš„Appsï¼Œæƒ³è±¡ä¸€ä¸‹ChromeBookèƒ½æèµ·æ¥å°±çŸ¥é“Web Storeé‡Œé¢åº”ç”¨æœ‰å¤šä¸°å¯Œã€‚\nå½“ç„¶ä½ ä¹Ÿå¯ä»¥è‡ªå·±å†™æ’ä»¶ã€åº”ç”¨ï¼Œä»¥å¼€å‘è€…æ¨¡å¼ç¦»çº¿åŠ è½½ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å‘å¸ƒåˆ°Web Storeã€‚æ¯”å¦‚æˆ‘è‡ªå·±å†™äº†ä¸ªæ’ä»¶åˆ†å±é˜…è¯»ä»£ç ã€‚\nä¸Šè¿°ä¸€äº›é…ç½®ä¼˜åŒ–æ–¹é¢çš„åˆ†äº«ï¼Œå¯¹macOSçš„æ™®é€šç”¨æˆ·ã€é«˜é¢‘ç”¨æˆ·ã€å¼€å‘è€…ç­‰ï¼Œåº”è¯¥éƒ½æ˜¯é€šç”¨çš„ï¼Œè¿™é‡Œåˆ†äº«ä¸€ä¸‹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶åˆ†äº«è‡ªå·±çš„ä¸€äº›ä½¿ç”¨å¿ƒå¾—ã€æŠ€å·§ã€‚\nå…³äºå¼€å‘ç›¸å…³çš„ä¸€äº›ç‰¹å®šé…ç½®ï¼Œåé¢æœ‰æ—¶é—´äº†æ•´ç†åå†åˆ†äº«ã€‚\n"}),a.add({id:308,href:"/blog/2020-02-23-go%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-gotest%E5%AE%9E%E7%8E%B0/",title:"goæºç å‰–æ-gotestå®ç°",description:"é—®é¢˜èƒŒæ™¯ # åœ¨go1.13å‡ºæ¥åä¸ä¹…ï¼Œæœ‰ä¸å°‘åŒå­¦é‡åˆ°äº†go testæŠ¥é”™çš„é—®é¢˜ â€œflag -test.timeout provided but not definedâ€ã€‚è¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å¼•èµ·çš„å‘¢ï¼Ÿ\n å…¬å¸å¾®æœåŠ¡ä»£ç ï¼Œé€šå¸¸æ˜¯å€ŸåŠ©ä»£ç ç”Ÿæˆå·¥å…·ç»Ÿä¸€ç”Ÿæˆçš„ï¼ŒåŒ…æ‹¬é’ˆå¯¹æ¥å£çš„æµ‹è¯•ç”¨ä¾‹ï¼› åœ¨ç”Ÿæˆå•å…ƒæµ‹è¯•æ–‡ä»¶æ—¶ï¼Œå¦‚helloworld_test.goä¸­ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº›æµ‹è¯•é€‰é¡¹å¦‚-timeoutã€-serviceã€-methodã€-targetã€-reqã€-rspç­‰ï¼› ä¸Šè¿°å®šä¹‰çš„é€‰é¡¹ï¼Œåœ¨helloworld_test.goä¸­çš„func init()ä¸­æ‰§è¡Œflag.Parse()æ“ä½œå®Œæˆé€‰é¡¹è§£æã€‚  è¿™æ˜¯è¢«æµ‹è¯•ä»£ç çš„ä¸€ç‚¹èƒŒæ™¯ä¿¡æ¯ï¼Œä¸Šè¿°æµ‹è¯•ä»£ç åœ¨go1.12ä¸­æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å½“å‡çº§åˆ°go1.13åï¼Œå°±å‡ºç°äº†ä¸Šè¿°â€œflag \u0026hellip; provided but not definedâ€çš„é”™è¯¯ã€‚\nå®ç°ç»†èŠ‚ # go testå®ç°ç»†èŠ‚ï¼Œéœ€è¦è·Ÿè¸ªä¸€ä¸‹å‘½ä»¤go testçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå…·ä½“å¯¹åº”è¿™ä¸ªæºæ–‡ä»¶ï¼šsrc/cmd/go/internal/test/test.goã€‚\nå‡å¦‚ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªpackageåä¸ºxxxxçš„goæ–‡ä»¶ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªpackageåä¸ºxxxx_testçš„_testæ–‡ä»¶ï¼Œå¦‚ï¼š\nfile: helloworld_test.go\npackage xxxx_test import \u0026quot;testing\u0026quot; import \u0026quot;xxxx\u0026quot; func TestHelloWorld(t *testing.T) { xxxx.Hello() } /* func init() { flag.Parse() } */ /* func TestMain(m *testing.M) { os.Exit(m.Run()) } */  file: helloworld.go\npackage xxxx func Hello() { }  è¿™é‡Œçš„å®ä¾‹ä»£ç ï¼Œåšäº†é€‚å½“çš„ç®€åŒ–ï¼Œæ–¹ä¾¿å¤§å®¶æŸ¥çœ‹ã€‚ä¸ºäº†æ›´å¥½åœ°è·Ÿè¸ªgo testè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥è°ƒè¯•æ¨¡å¼è¿è¡Œgo testï¼Œå¦‚GOTMPDIR=$(pwd)/xxx dlv exec $(which go) -- test -cï¼š",content:"é—®é¢˜èƒŒæ™¯ # åœ¨go1.13å‡ºæ¥åä¸ä¹…ï¼Œæœ‰ä¸å°‘åŒå­¦é‡åˆ°äº†go testæŠ¥é”™çš„é—®é¢˜ â€œflag -test.timeout provided but not definedâ€ã€‚è¿™ä¸ªé—®é¢˜æ˜¯å¦‚ä½•å¼•èµ·çš„å‘¢ï¼Ÿ\n å…¬å¸å¾®æœåŠ¡ä»£ç ï¼Œé€šå¸¸æ˜¯å€ŸåŠ©ä»£ç ç”Ÿæˆå·¥å…·ç»Ÿä¸€ç”Ÿæˆçš„ï¼ŒåŒ…æ‹¬é’ˆå¯¹æ¥å£çš„æµ‹è¯•ç”¨ä¾‹ï¼› åœ¨ç”Ÿæˆå•å…ƒæµ‹è¯•æ–‡ä»¶æ—¶ï¼Œå¦‚helloworld_test.goä¸­ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€äº›æµ‹è¯•é€‰é¡¹å¦‚-timeoutã€-serviceã€-methodã€-targetã€-reqã€-rspç­‰ï¼› ä¸Šè¿°å®šä¹‰çš„é€‰é¡¹ï¼Œåœ¨helloworld_test.goä¸­çš„func init()ä¸­æ‰§è¡Œflag.Parse()æ“ä½œå®Œæˆé€‰é¡¹è§£æã€‚  è¿™æ˜¯è¢«æµ‹è¯•ä»£ç çš„ä¸€ç‚¹èƒŒæ™¯ä¿¡æ¯ï¼Œä¸Šè¿°æµ‹è¯•ä»£ç åœ¨go1.12ä¸­æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å½“å‡çº§åˆ°go1.13åï¼Œå°±å‡ºç°äº†ä¸Šè¿°â€œflag \u0026hellip; provided but not definedâ€çš„é”™è¯¯ã€‚\nå®ç°ç»†èŠ‚ # go testå®ç°ç»†èŠ‚ï¼Œéœ€è¦è·Ÿè¸ªä¸€ä¸‹å‘½ä»¤go testçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå…·ä½“å¯¹åº”è¿™ä¸ªæºæ–‡ä»¶ï¼šsrc/cmd/go/internal/test/test.goã€‚\nå‡å¦‚ç°åœ¨ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªpackageåä¸ºxxxxçš„goæ–‡ä»¶ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªpackageåä¸ºxxxx_testçš„_testæ–‡ä»¶ï¼Œå¦‚ï¼š\nfile: helloworld_test.go\npackage xxxx_test import \u0026quot;testing\u0026quot; import \u0026quot;xxxx\u0026quot; func TestHelloWorld(t *testing.T) { xxxx.Hello() } /* func init() { flag.Parse() } */ /* func TestMain(m *testing.M) { os.Exit(m.Run()) } */  file: helloworld.go\npackage xxxx func Hello() { }  è¿™é‡Œçš„å®ä¾‹ä»£ç ï¼Œåšäº†é€‚å½“çš„ç®€åŒ–ï¼Œæ–¹ä¾¿å¤§å®¶æŸ¥çœ‹ã€‚ä¸ºäº†æ›´å¥½åœ°è·Ÿè¸ªgo testè¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥è°ƒè¯•æ¨¡å¼è¿è¡Œgo testï¼Œå¦‚GOTMPDIR=$(pwd)/xxx dlv exec $(which go) -- test -cï¼š\n é¦–å…ˆæŒ‡å®šäº†ä¸´æ—¶ç›®å½•GOTMPDIRä¸ºå½“å‰ç›®å½•ä¸‹çš„xxxï¼Œåœ¨æ‰§è¡Œç¼–è¯‘æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶å°†ç”Ÿæˆåˆ°è¯¥ç›®å½•ä¸‹ï¼› dlvæ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨--åé¢æ·»åŠ ä¼ é€’ç»™è¢«è°ƒè¯•ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°ï¼Œå¦‚è¿™é‡Œä¼ é€’ç»™goçš„å‚æ•°æ˜¯test -cï¼›  æ­¤å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œfswatch $(pwd)/xxxæ¥è·Ÿè¸ªæ–‡ä»¶ç³»ç»Ÿçš„å˜åŒ–ï¼Œä»è€Œå¸®åŠ©æˆ‘ä»¬åˆ†ægo teståˆ°åº•å¹²äº†ä»€ä¹ˆï¼Œè¿™æ ·æ¯”è¾ƒç›´è§‚ï¼Œç›´æ¥çœ‹æºç ï¼Œä»£ç é‡æœ‰ç‚¹å¤šï¼Œå®¹æ˜“æŠ“ä¸ä½å¤´ç»ªã€‚\næ¥ä¸‹æ¥åªéœ€è¦æ‰§è¡Œnextã€nextã€nextæ­¥è¿›çš„å½¢å¼æ‰§è¡Œgo testçš„ä»£ç é€»è¾‘å°±å¯ä»¥äº†ã€‚è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°fswatchè¾“å‡ºäº†å¦‚ä¸‹ä¿¡æ¯ï¼š\nzhangjie@knight test $ fswatch . /Users/zhangjie/test/test/xxx/go-build3964143485 /Users/zhangjie/test/test/xxx/go-build3964143485/b001 /Users/zhangjie/test/test/xxx/go-build3964143485/b001/_testmain.go  æ­¤æ—¶æŸ¥çœ‹ä¸‹_testmain.goçš„æ–‡ä»¶å†…å®¹ï¼š\nfile: _testmain.go\n// Code generated by 'go test'. DO NOT EDIT. package main import ( \u0026quot;os\u0026quot; \u0026quot;testing\u0026quot; \u0026quot;testing/internal/testdeps\u0026quot; _ \u0026quot;xxxx\u0026quot; _xtest \u0026quot;xxxx_test\u0026quot; ) var tests = []testing.InternalTest{ {\u0026quot;TestHelloWorld\u0026quot;, _xtest.TestHelloWorld}, } var benchmarks = []testing.InternalBenchmark{ } var examples = []testing.InternalExample{ } func init() { testdeps.ImportPath = \u0026quot;xxxx\u0026quot; } func main() { m := testing.MainStart(testdeps.TestDeps{}, tests, benchmarks, examples) os.Exit(m.Run()) }  ä¸Šè¿°æ–‡ä»¶ä¸­åŒ…å«äº†ä¸€ä¸ªmainå‡½æ•°ï¼Œæ˜¯go test -cç”Ÿæˆçš„æµ‹è¯•ç¨‹åºçš„å…¥å£å‡½æ•°ã€‚\n  ä¸Šè¿°æ–‡ä»¶ä¸­ï¼Œimportäº†æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ä¸¤ä¸ªpackageï¼Œå¦‚import _ \u0026quot;xxxx\u0026quot;ï¼Œä»¥åŠimport _xtest \u0026quot;xxxx_test\u0026quot;ï¼Œè¿™ä¸¤ä¸ªpackageçš„ä»£ç å°±æ˜¯æˆ‘ä»¬ä¸Šé¢ç»™å‡ºçš„ï¼Œä¸€ä¸ªHelloå‡½æ•°å®šä¹‰ï¼Œä¸€ä¸ªå¯¹Helloå‡½æ•°çš„å•å…ƒæµ‹è¯•ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„ã€‚åœ¨helloworld_test.goä¸­æˆ‘ä»¬æ³¨é‡Šæ‰äº†ä¸¤æ®µä»£ç ï¼Œä¸€ä¸ªæ˜¯func init()é€»è¾‘ï¼Œä¸€ä¸ªæ˜¯func TestMain()é€»è¾‘ã€‚æˆ‘ä»¬ç¨åå†è¯´è¿™ä¸ªã€‚\n  func init()ä¸­ä¹Ÿæ²¡æœ‰ä»€ä¹ˆéœ€è¦å…³æ³¨çš„ã€‚\n  func mainä¸­ï¼Œå…ˆæ‰§è¡Œäº†ä¸€ä¸ªtesting.MainStart(\u0026hellip;)åˆå§‹åŒ–é€»è¾‘ï¼Œè¿™é‡Œé¢èµ¶äº†ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ‰§è¡Œäº†ä¸€ä¸ªtesting.Init()å‡½æ•°ï¼Œæ¥åˆå§‹åŒ–go testingè¿™ä¸ªpackageä¸­è‡ªå®šä¹‰çš„ä¸€äº›flagsï¼Œå¦‚-test.timeoutä¹‹ç±»çš„ã€‚ä¸»æ„è¿™äº›flagsçš„æ³¨å†Œé€»è¾‘æ˜¯åœ¨æ‰€æœ‰packageçš„func init()æ‰§è¡Œä¹‹åæ‰å‘èµ·çš„ã€‚\n  func mainä¸­ï¼Œæ¥ç€æ‰§è¡Œäº†ä¸€ä¸ªos.Exit(m.Run())æ¥æ‰§è¡Œæµ‹è¯•ï¼Œå±•å¼€m.Run()èƒ½å¤Ÿçœ‹åˆ°æ ¹æ®-test.runé€‰æ‹©æ€§è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œæˆ–æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹çš„é€»è¾‘ã€‚æ³¨æ„ï¼Œå½“æˆ‘ä»¬åœ¨æµ‹è¯•æ–‡ä»¶ä¸­å®šä¹‰äº†TestMainæ–¹æ³•ä¹‹åï¼Œè¿™é‡Œç”Ÿæˆçš„ä»£ç å°±ä¸æ˜¯os.Exit(m.Run())äº†ï¼Œè€Œæ˜¯_xtest.TestMain(m),è¿™å°†å…è®¸å…ˆæ‰§è¡Œæˆ‘ä»¬è‡ªå·±çš„æµ‹è¯•ä»£ç è®¾ç½®é€»è¾‘ã€‚å¦‚åœ¨TestMainä¸­æ‰§è¡Œä¸€äº›å‡†å¤‡æµ‹è¯•æ•°æ®ã€å·¥ä½œç›®å½•ã€æ³¨å†Œå‘½ä»¤é€‰é¡¹ é€»è¾‘ã€‚\n  è¯¥é—®é¢˜äº§ç”ŸåŸå›  # å¥½ï¼Œäº‹æƒ…è‡³æ­¤ï¼Œæˆ‘ä»¬å…ˆæ¥è§£ç­”æœ¬æ–‡å¼€å¤´é‡åˆ°çš„é—®é¢˜ï¼Ÿ\n go1.13ä¸­å¯¹testing packageçš„åˆå§‹åŒ–é€»è¾‘åšäº†ä¸€ç‚¹è°ƒæ•´ï¼Œå®ƒå°†flagsçš„åˆå§‹åŒ–é€»è¾‘æ”¾åœ¨äº†mainç¨‹åºä¸­ï¼Œæ‰€æœ‰çš„å…¶ä»–packageçš„func init()æ‰§è¡Œä¹‹åï¼› goå®˜æ–¹å…¶å®ä¸å»ºè®®åœ¨func init()ä¸­å®šä¹‰ä¸€äº›flagsçš„ï¼Œé™¤éæ˜¯main packageã€‚ä½†æ˜¯æˆ‘ä»¬å¾ˆå¤šå¼€å‘å¹¶ä¸äº†è§£è¿™ä¸ªèƒŒæ™¯ï¼Œç»å¸¸åœ¨func init()ä¸­å®šä¹‰ä¸€äº›flagså¹¶Parseï¼Œç”šè‡³æ˜¯åœ¨_test.goæ–‡ä»¶ä¸­; go1.13åšäº†ä¸Šè¿°è°ƒæ•´ä¹‹åï¼Œåœ¨func init()ä¸­æ‰§è¡Œflag.Parse()æ—¶ï¼Œå¦‚æœgo testä¼ é€’äº†ä¸€äº›è¿˜æ²¡æœ‰æ¥å¾—åŠæ³¨å†Œçš„é€‰é¡¹ï¼Œå¦‚-test.timeoutæ˜¯åœ¨func main()æ‰§è¡Œåæ³¨å†Œï¼Œå°±ä¼šæŠ¥é”™\u0026quot;flag -test.timeout provided but not defined\u0026quot;ã€‚  åˆ°è¿™ï¼Œæˆ‘ä»¬è§£é‡Šäº†é—®é¢˜äº§ç”Ÿçš„åŸå› äº†ã€‚\nå¦‚ä½•è§„é¿è¯¥é—®é¢˜ # ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸‹å¦‚ä½•è§„é¿ä¸Šè¿°é—®é¢˜ï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œç¡®å®æœ‰éœ€è¦åœ¨_test.goä¸­å®šä¹‰ä¸€äº›flagsè¿›è¡Œç²¾ç»†åŒ–æ§åˆ¶çš„æƒ…å†µã€‚\næˆ‘ä»¬äº†è§£åˆ°ï¼Œå¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†TestMainå‡½æ•°ï¼Œgo testå°±ä¼šç”Ÿæˆè¿™æ ·çš„ä»£ç :\nfile: _testmain.go\nfunc main() { m := testing.MainStart(testdeps.TestDeps(), tests, benchmarks, examples) _xtest.TestMain(m) }  åœ¨testing.MainStartä¸­æ‰§è¡Œtestingæ¡†æ¶çš„é€‰é¡¹æ³¨å†Œé€»è¾‘ï¼Œå¦‚-test.runã€-test.timeoutç­‰ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨_xtestè¿™ä¸ªå¯¼å…¥åˆ«åå¯¹åº”packageä¸­å®šä¹‰å¥½flagsï¼Œå¯ä»¥åœ¨packageçº§åˆ«å®šä¹‰ï¼Œä¹Ÿå¯ä»¥åœ¨func init()ä¸­å®šä¹‰ï¼Œä¹Ÿå¯ä»¥åœ¨func TestMain()ä¸­å®šä¹‰ï¼Œåªè¦ä¿è¯ï¼Œæ‰§è¡Œflag.Parse()çš„æ—¶å€™æ˜¯åœ¨TestMainæˆ–è€…æ›´ä¹‹åçš„å•å…ƒæµ‹è¯•å‡½æ•°ä¸­å°±å¯ä»¥ã€‚\nè¿™ä¸ªæ—¶å€™ï¼Œæ‰€æœ‰çš„packageçš„é€‰é¡¹éƒ½æ­£å¸¸æ³¨å†Œäº†ï¼ŒåŒ…æ‹¬testing packageçš„ï¼Œåœ¨TestMainä¸­æ‰§è¡Œflag.Parse()å°±ä¸ä¼šå†å‡ºç°â€œflag \u0026hellip; provided but not defined\u0026quot;çš„å¥‡è‘©æƒ…å†µã€‚\nåŒºåˆ†testing flagsä»¥åŠè‡ªå®šä¹‰flags # å¦å¤–ï¼Œå…³äºè‡ªå®šä¹‰flagä¸testing packageå®šä¹‰çš„é‡åçš„é—®é¢˜ï¼Œå…¶å®go testæ˜¯æœ‰è€ƒè™‘åˆ°çš„ï¼Œç”¨å‚æ•°\u0026ndash;argsåˆ†å¼€å°±å¯ä»¥äº†ï¼Œå‰é¢çš„æ˜¯ç»™testingè§£æçš„ï¼Œåé¢æ˜¯ç»™è‡ªå®šä¹‰çš„è§£æçš„ï¼Œtestingè‡ªå·±çš„flagåå¸¦â€œtest.â€å‰ç¼€ï¼Œå…¶å®æ˜¯å¯ä»¥çœç•¥æ‰çš„ã€‚\nå†çœ‹go testä»£ç ç”Ÿæˆ # ä¸‹é¢æ˜¯é—®é¢˜çš„å›å½’ï¼ŒåŠå®šä½è¿‡ç¨‹ä¸­çš„æºç åˆ†æï¼\n_testmain.goçš„ç”Ÿæˆï¼Œæ˜¯é€šè¿‡goæ¨¡æ¿æ¥ç”Ÿæˆçš„ï¼Œæ¨¡æ¿è·¯å¾„è¯¦è§ï¼šsrc/cmd/go/internal/load/test.goï¼Œæœç´¢å˜é‡â€™testmainTmplâ€™ï¼š\n// Code generated by 'go test'. DO NOT EDIT. package main import ( \u0026quot;os\u0026quot; {{if .TestMain}} \u0026quot;reflect\u0026quot; {{end}} \u0026quot;testing\u0026quot; \u0026quot;testing/internal/testdeps\u0026quot; {{if .ImportTest}} {{if .NeedTest}}_test{{else}}_{{end}} {{.Package.ImportPath | printf \u0026quot;%q\u0026quot;}} {{end}} {{if .ImportXtest}} {{if .NeedXtest}}_xtest{{else}}_{{end}} {{.Package.ImportPath | printf \u0026quot;%s_test\u0026quot; | printf \u0026quot;%q\u0026quot;}} {{end}} ... ) var tests = []testing.InternalTest{ {{range .Tests}} {\u0026quot;{{.Name}}\u0026quot;, {{.Package}}.{{.Name}}}, {{end}} } var benchmarks = []testing.InternalBenchmark{ {{range .Benchmarks}} {\u0026quot;{{.Name}}\u0026quot;, {{.Package}}.{{.Name}}}, {{end}} } var examples = []testing.InternalExample{ {{range .Examples}} {\u0026quot;{{.Name}}\u0026quot;, {{.Package}}.{{.Name}}, {{.Output | printf \u0026quot;%q\u0026quot;}}, {{.Unordered}}}, {{end}} } func init() { testdeps.ImportPath = {{.ImportPath | printf \u0026quot;%q\u0026quot;}} } ... func main() { ... m := testing.MainStart(testdeps.TestDeps{}, tests, benchmarks, examples) {{with .TestMain}} {{.Package}}.{{.Name}}(m) os.Exit(int(reflect.ValueOf(m).Elem().FieldByName(\u0026quot;exitCode\u0026quot;).Int())) {{else}} os.Exit(m.Run()) {{end}} }  ç»“åˆå‰é¢ç»™å‡ºçš„æµ‹è¯•ç”¨ä¾‹helloworld.goã€helloworld_test.goï¼Œä»¥åŠgo testç”Ÿæˆçš„_testmain.goï¼Œåªè¦å¯¹goæ¨¡æ¿ç¨æœ‰è®¤è¯†ï¼Œå°±å¾ˆå®¹æ˜“å»ºç«‹èµ·æ¨¡æ¿å’Œä»£ç ç”Ÿæˆçš„è”ç³»ï¼Œæ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ã€‚\næ€»ç»“ # go1.13 testing packageåˆå§‹åŒ–flagsé¡ºåºå‘ç”Ÿæ”¹å˜ï¼Œå¼•èµ·äº†ä¸€äº›go testæ—¶\u0026quot;flag \u0026hellip; provided but not defined\u0026quot;çš„é”™è¯¯ï¼Œæš´éœ²äº†æˆ‘ä»¬ä¸€äº›å¼€å‘è€…å¯¹go testä¸ç†Ÿæ‚‰ã€å¯¹go flagså®˜æ–¹æ¨èç”¨æ³•ä¸ç†Ÿæ‚‰ã€‚æœ¬æ–‡è§£é‡Šäº†go testçš„å¤§è‡´å¤„ç†é€»è¾‘ã€é—®é¢˜äº§ç”ŸåŸå› ä»¥åŠè§„é¿è¯¥é—®é¢˜çš„å»ºè®®ã€‚\n"}),a.add({id:309,href:"/tags/framework/",title:"framework",description:"",content:""}),a.add({id:310,href:"/tags/goneat/",title:"goneat",description:"",content:""}),a.add({id:311,href:"/blog/2020-02-04-goneat-rpc%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E8%AF%A6%E8%A7%A3/",title:"GoNeat RPCæ¡†æ¶è®¾è®¡è¯¦è§£",description:"GoNeatæ¡†æ¶æ˜¯ä¸€æ¬¾åœ¨è…¾è®¯æœŸé—´å¼€å‘çš„RPCæ¡†æ¶ï¼Œæ”¯æ’‘äº†å›¢é˜Ÿå‡ åƒä¸ªå¾®æœåŠ¡ï¼Œåç»­PCGå»ºè®¾tRPCæ¡†æ¶åï¼ŒGoNeatæ¡†æ¶ä¹Ÿæœ€ç»ˆèµ°å‘äº†åœæ­¢åç»­å¼€å‘çš„å‘½è¿ã€‚è™½ç„¶æœªæ¥éš¾å…è¢«é—å¿˜ï¼Œä½†æ˜¯å®ƒè¿‡å»ä¹Ÿæ›¾ç»â€ç¹è£â€œè¿‡ï¼Œå‡ åäººçš„æ´»è·ƒå¼€å‘ç»„ç»‡ï¼Œå‡ ç™¾ä¸ªçš„issueæ²Ÿé€šè®¨è®ºã€å‡ åƒçš„commitã€å¾ˆå¤šæ¬¡æŠ€æœ¯åˆ†äº«ï¼Œæ²‰æ·€ä¸‹æ¥çš„ä¸œè¥¿ä¹Ÿå¯ä»¥å¯¹æ–°åŒå­¦æˆé•¿èµ·åˆ°äº›æŒ‡å¼•å¸®åŠ©ä½œç”¨ï¼Œå¯¹åç»­æ¡†æ¶è®¾è®¡å¼€å‘è€…ä¹Ÿå…·æœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹æ¡†æ¶è®¾è®¡å®ç°æ„Ÿå…´è¶£çš„åŒå­¦æœ‰å¸®åŠ©ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  GoNeatæ¡†æ¶ä¸€ç›´æŒç»­æ¼”è¿›ä¸­ï¼ŒæŠ½æ—¶é—´æ•´ç†äº†ä¸‹æ¡†æ¶ä»æœåŠ¡å¯åŠ¨åˆ°ç»“æŸé€€å‡ºè¿™ä¸€è¿ä¸²æµç¨‹ä¸­æ¶‰åŠåˆ°çš„è®¾è®¡ã€å®ç°ç»†èŠ‚ï¼Œå¸Œæœ›èƒ½å¯¹æƒ³äº†è§£GoNeatæ¡†æ¶è®¾è®¡ã€å®ç°æ„Ÿå…´è¶£çš„åŒå­¦æœ‰å¸®åŠ©ã€‚ æœ¬æ–‡åˆè¡·æ˜¯ä¸ºäº†ä»‹ç»GoNeatæ¡†æ¶çš„è®¾è®¡ï¼Œæœ¬äººè§‰å¾—æŒ‰ç…§ä¸€ä¸ªæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œä»‹ç»ï¼Œè¯»è€…ä¼šæ¯”è¾ƒå®¹æ˜“æ¥å—ã€ä»‹ç»èµ·æ¥ä¹Ÿæ²¡é‚£ä¹ˆæ¯ç‡¥ï¼Œç¼ºç‚¹æ˜¯ä¸€ä¸ªæ¨¡å—çš„å¤šä¸ªå®ç°ç»†èŠ‚å¯èƒ½ä¼šåœ¨ä¸åŒçš„åœ°æ–¹æåŠï¼Œè¯»è€…å¯èƒ½éœ€è¦ä¸€å®šçš„å‰åè”æƒ³ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œä¹Ÿå¯ä»¥ç›´æ¥è·³è¿‡éƒ¨åˆ†å†…å®¹é˜…è¯»æ„Ÿå…´è¶£çš„ç« èŠ‚ã€‚ ç”±äºè¯­è¨€åŠŸåº•ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œåœ¨ç”¨è¯ã€å¥å¼ã€æ–­å¥ã€ç¯‡ç« ç»„ç»‡ä¸Šéš¾å…å­˜åœ¨ä¸å°½å¦‚äººæ„çš„åœ°æ–¹ï¼Œè¯·å¤šå¤šåŒ…æ¶µã€‚\nGoNeat RPCæ¡†æ¶è®¾è®¡è¯¦è§£ # GoNeatï¼Œè¿½æ±‚â€œå°è€Œç¾â€çš„è®¾è®¡ï¼Œæ˜¯åŸºäºgolangå¼€å‘çš„é¢å‘åå°å¼€å‘çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæ—¨åœ¨æå‡åå°å¼€å‘æ•ˆç‡ï¼Œè®©å¤§å®¶æ‘†è„±å„ç§çç¢çš„ç»†èŠ‚ï¼Œè½¬è€Œæ›´åŠ ä¸“æ³¨äºæœåŠ¡è´¨é‡æœ¬èº«ã€‚Simple \u0026amp; Powerfulï¼Œæ˜¯æˆ‘ä»¬å§‹ç»ˆè¿½æ±‚çš„è®¾è®¡ç†å¿µã€‚\næœ¬æ–‡ä»æ•´ä½“ä¸Šä»‹ç»GoNeatçš„è®¾è®¡ï¼ŒGoNeatåŒ…æ‹¬å“ªäº›æ ¸å¿ƒéƒ¨ä»¶ï¼Œå®ƒä»¬åˆæ˜¯æ˜¯å¦‚ä½•åä½œçš„ï¼ŒæœåŠ¡è¿è¡ŒæœŸé—´æ¶‰åŠåˆ°å“ªäº›å¤„ç†æµç¨‹ï¼Œç­‰ç­‰ã€‚å¦‚æœè¯»è€…æƒ³æ›´æ·±å…¥åœ°äº†è§£ï¼Œå¯ä»¥åœ¨æœ¬æ–‡åŸºç¡€ä¸Šå†é˜…è¯»ç›¸å…³æºç ï¼Œæˆ–ä¸æˆ‘ä»¬å¼€å‘è€…äº¤æµã€‚\nGoNeat æ•´ä½“æ¶æ„ # ä¸‹å›¾å±•ç¤ºäº†GoNeatçš„æ•´ä½“æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬å…¶æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œä»¥åŠä¸åŒç»„æˆéƒ¨åˆ†ä¹‹é—´çš„äº¤äº’ï¼š GoNeatåŒ…æ‹¬å¦‚ä¸‹æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼š\n Serverï¼Œä»£è¡¨ä¸€ä¸ªæœåŠ¡å®ä¾‹ï¼Œä¸€ä¸ªServerå¯ä»¥æ’å…¥å¤šä¸ªServerModuleï¼› ServerModuleï¼Œä»£è¡¨ä¸€ä¸ªæœåŠ¡æ¨¡å—ï¼Œå®ç°åŒ…æ‹¬StreamServerã€PacketServerã€HttpServerã€HippoServerï¼› NHandlerï¼Œå³Codec Handlerï¼Œä»£è¡¨ä¸€ä¸ªåè®®Handlerï¼Œå®ç°åŒ…æ‹¬nrpcã€iliveã€ssoã€httpç­‰åè®®Handlerï¼›  ä¸åŒportä¸Šå¯ä»¥åˆ†åˆ«æä¾›ä¸åŒåè®®çš„æœåŠ¡ï¼Œå¦‚8000ç«¯å£æä¾›tcp/udpçš„nrpcæœåŠ¡ï¼Œè€Œ8080æä¾›httpæœåŠ¡ï¼› ä¸åŒportä¸Šåˆ°è¾¾çš„è¯·æ±‚ï¼Œç»åè®®Handlerè§£æå‡ºè¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚ä¸­çš„å‘½ä»¤å­—ï¼Œæ‰¾åˆ°æ³¨å†Œçš„CmdHandlerï¼›   Serverå°†è¯·æ±‚ä»¥å‡½æ•°å‚æ•°çš„å½¢å¼é€’äº¤ç»™æ³¨å†Œçš„CmdHandlerå¤„ç†ï¼Œå¤„ç†å®Œæ¯•è¿”å›ç»“æœç»™è°ƒç”¨æ–¹ï¼›  ä»‹ç»å®Œæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ä¹‹åï¼Œä¸‹é¢ç»“åˆä¸€ä¸ªæœåŠ¡ç¤ºä¾‹ï¼Œä»‹ç»ä¸‹æœåŠ¡å¯åŠ¨ã€è¯·æ±‚å¤„ç†ã€æœåŠ¡é€€å‡ºçš„è¯¦ç»†æµç¨‹åŠè®¾è®¡ç»†èŠ‚ã€‚\nGoNeat æœåŠ¡ç¤ºä¾‹ # æˆ‘ä»¬ä»ç„¶ä½¿ç”¨â€œtest_nrpc.protoâ€ä½œä¸ºç¤ºä¾‹æœåŠ¡pbï¼ˆæ‚¨å¯ä»¥åœ¨ go-neat/demo/quickstart ä¸­æ‰¾åˆ°è¯¥ç¤ºä¾‹ï¼‰ï¼š\nfile: test_nrpc.proto\nsyntax = \u0026quot;proto2\u0026quot;; package test_nrpc; // BuyApple message BuyAppleReq { optional uint32 num = 1; }; message BuyAppleRsp { optional uint32 errcode = 1; optional string errmsg = 2; }; // SellApple message SellAppleReq { optional uint32 num = 1; }; message SellAppleRsp { optional uint32 errcode = 1; optional string errmsg = 2; }; // service test_nrpc service test_nrpc { rpc BuyApple(BuyAppleReq) returns(BuyAppleRsp); // CMD_BuyApple rpc SellApple(SellAppleReq) returns(SellAppleRsp); // CMD_SellApple }  ä½¿ç”¨goneatå‘½ä»¤è¡Œå·¥å…·æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„go-neatæœåŠ¡ï¼š\ngoneat create -protocol=nrpc -protofile=test_nrpc.proto -httpon  ä¸â€œProgram Your Next Server in GoNeatâ€ç« èŠ‚ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œé¢å¤–åŠ äº†ä¸€ä¸ªå‚æ•°â€œ-httponâ€ï¼Œç›®çš„æ˜¯ä»‹ç»æ”¯æŒå¤šåè®®çš„ç›¸å…³å¤„ç†ã€‚è¿è¡Œä¸Šè¿°å‘½ä»¤åï¼Œåº”ç”Ÿæˆå¦‚ä¸‹ç›®å½•ç»“æ„çš„æœåŠ¡æ¨¡æ¿ã€‚\ntest_nrpc â”œâ”€â”€ Makefile â”œâ”€â”€ README.md â”œâ”€â”€ client â”‚ â””â”€â”€ test_nrpc_client.go â”œâ”€â”€ conf â”‚ â”œâ”€â”€ log.ini â”‚ â”œâ”€â”€ monitor.ini â”‚ â”œâ”€â”€ service.ini â”‚ â””â”€â”€ trace.ini â”œâ”€â”€ deploy.ini â”œâ”€â”€ log â””â”€â”€ src â”œâ”€â”€ exec â”‚ â”œâ”€â”€ exec_test_nrpc.go â”‚ â”œâ”€â”€ exec_test_nrpc_impl.go â”‚ â””â”€â”€ exec_test_nrpc_init.go â””â”€â”€ test_nrpc.go 5 directories, 12 files  GoNeat å†…éƒ¨è®¾è®¡ # ä¸€ç›´æ²¡æƒ³æ¸…æ¥šï¼Œè¯¥ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥æè¿°GoNeatçš„å†…éƒ¨è®¾è®¡ï¼Œæƒ³äº†ä¸¤ç§å™è¿°æ–¹å¼ï¼š\n  æŒ‰ç…§æ ¸å¿ƒç»„ä»¶å•ç‹¬æ‹å‡ºæ¥æŒ¨ä¸ªä»‹ç»ä¸‹ï¼Ÿ\nè¿™ç§æ–¹å¼æ¯”è¾ƒå®¹æ˜“ä»‹ç»ï¼Œä½†æ˜¯è¯»è€…ä¸å®¹æ˜“ç†è§£è¿™ç©æ„åœ¨å“ªäº›åœºæ™¯ä¸‹ç”¨ã€æ€ä¹ˆç”¨ã€‚å› ä¸ºæ ¸å¿ƒç»„ä»¶å¯èƒ½åŠŸèƒ½æ¯”è¾ƒå¤šï¼Œå¤§è€Œå…¨åœ°ä»‹ç»åè€Œæœ‰ç‚¹è™šï¼Œä¸€æ¬¡æ€§ä»‹ç»å®Œä¸å…‰è¯»è€…å¤´å¤§ï¼Œä»‹ç»çš„äººä¹Ÿå¤´å¤§ã€‚\n  æŒ‰ç…§æ‰§è¡Œæµç¨‹ä¸­æ¶‰åŠåˆ°çš„ç»„ä»¶é€ä¸ªä»‹ç»ï¼Ÿ\nè¿™ç§æ–¹å¼æ¯”è¾ƒå®¹æ˜“è®©è¯»è€…æ˜ç™½ä»€ä¹ˆåœºæ™¯ä¸‹ç”¨åˆ°äº†ä»€ä¹ˆç»„ä»¶ï¼Œå¯¹ç»„ä»¶çš„ä»‹ç»ä¹Ÿå¯ä»¥é€‚å¯è€Œæ­¢ï¼Œä½†æ˜¯åŒä¸€ä¸ªç»„ä»¶å¯èƒ½åœ¨å¤šä¸ªä¸åŒçš„æµç¨‹ä¸­è¢«æåˆ°ï¼Œéœ€è¦è¯»è€…é€‚å½“åœ°å¯¹æ€è·¯è¿›è¡Œä¸‹æ¢³ç†ã€‚ä¸è¿‡GoNeatæ¡†æ¶å†…ç»„ä»¶å®ç°ä¸€èˆ¬éƒ½æ¯”è¾ƒç®€å•ã€‚\n  ç»¼åˆè€ƒè™‘ä»¥åï¼Œå†³å®šç”¨ç¬¬äºŒç§æ–¹å¼è¿›è¡Œå™è¿°ï¼Œæ—¢æ–¹ä¾¿è¯»è€…ç†è§£ï¼Œä»‹ç»è¿‡ç¨‹æœ¬èº«ä¹Ÿä¸è‡³äºè¿‡äºæ¯ç‡¥ã€‚\nGoNeatæ¡†æ¶æ˜¯æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œç»„ç»‡çš„ï¼Œç›¸å…³å­å·¥ç¨‹æ‰˜ç®¡åœ¨git.code.oa.com/groups/go-neatï¼š\n coreï¼Œæ˜¯æ ¸å¿ƒæ¡†æ¶é€»è¾‘ï¼Œè´Ÿè´£æ¡†æ¶æ•´ä½“æµç¨‹å¤„ç†ï¼Œå³æŸäº›é€šç”¨èƒ½åŠ›çš„æŠ½è±¡ï¼Œå¦‚ç›‘æ§ã€åˆ†å¸ƒå¼è·Ÿè¸ªã€æ—¥å¿—èƒ½åŠ›ï¼› tencentï¼Œæä¾›äº†å…¬å¸å¸¸ç”¨ä¸­é—´ä»¶ï¼Œå¦‚ckvã€hippoã€monitorã€tnmã€dcã€haboã€l5ã€cmlbç­‰ç­‰ï¼› commonï¼Œæä¾›äº†æ¡†æ¶ä¸­ä¸€äº›å¸¸ç”¨çš„å·¥å…·ç±»å®ç°ï¼Œå¦‚å…±äº«å†…å­˜æ“ä½œç­‰ç­‰ï¼› toolï¼Œæä¾›äº†GoNeatå¼€å‘æ‰€éœ€è¦çš„ä¸€äº›å¤–å›´å·¥å…·ï¼Œå¦‚ä»£ç ç”Ÿæˆå·¥å…·ã€monitorç›‘æ§æ‰“ç‚¹å·¥å…·ç­‰ï¼›  ä¸ºå¤§å®¶æ–¹ä¾¿ä½¿ç”¨ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œä¹Ÿåˆ›å»ºäº†componentsæ–¹ä¾¿å¤§å®¶åœ¨goneatæœåŠ¡å¼€å‘ä¸­ä½¿ç”¨ï¼š\n componentsï¼Œæä¾›äº†ç¬¬ä¸‰æ–¹çš„ä¸€äº›æ”¯æŒï¼Œå¦‚etcdã€zookeeperç­‰ç­‰ï¼›  æ­¤å¤–ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£GoNeatæ¡†æ¶çš„è®¾è®¡ï¼Œä»¥åŠå¿«é€Ÿä¸Šæ‰‹å¼€å‘ï¼Œä¹Ÿæä¾›äº†wikiå’Œdemoï¼š\n wikiï¼Œä¹Ÿå°±æ˜¯æ‚¨æ­£åœ¨çœ‹çš„è¿™ä»½æ–‡æ¡£ï¼Œæ‰€æœ‰çš„æ–‡æ¡£éƒ½åœ¨è¿™é‡Œç»´æŠ¤ï¼Œå¦‚æœå¯¹æ–‡æ¡£æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œä¹Ÿå¯åœ¨æ­¤æissueï¼› demoï¼Œæä¾›äº†ä¸€äº›ç¤ºä¾‹ä»£ç ï¼ŒåŠ©åŠ›å¤§å®¶å¿«é€Ÿä¸Šæ‰‹goneatå¼€å‘ï¼›   ä¸ºæ–¹ä¾¿å¤§å®¶åœ¨å…¬å¸å†…ç½‘ä½“éªŒGoNeatï¼Œå‡å°‘è§£å†³å¤–éƒ¨ä¾èµ–æ‰€éœ€è¦çš„æ—¶é—´ï¼ˆå¦‚è®¿é—®githubå¯èƒ½è¦ç”³è¯·å¤–ç½‘è®¿é—®æƒé™ç­‰ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿç»´æŠ¤äº†go-neat/depsæ¥ç»´æŠ¤æ¡†æ¶çš„ä¾èµ–ï¼ˆåº“+ç‰ˆæœ¬ï¼‰ï¼Œinstall.shæ­å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨æ‹‰å–è¿™é‡Œçš„ä¾èµ–ã€‚\næˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨go moduleå¯¹ä¾èµ–è¿›è¡Œç®¡ç†ï¼Œgoneatç›¸å…³ä¾èµ–å·²ç»è¡¥å……åœ¨go.modï¼Œè¯·çŸ¥æ‚‰ã€‚\n GoNeat - åˆå§‹åŒ– # åˆå§‹åŒ–ï¼šé…ç½®è¯´æ˜ # GoNeatæ¡†æ¶è¯»å–çš„é…ç½®æ–‡ä»¶ï¼Œä¸»è¦åŒ…æ‹¬ï¼š\n test_nrpc/conf/service.iniï¼ŒåŒ…å«æœåŠ¡çš„æ ¸å¿ƒé…ç½®ï¼› test_nrpc/conf/monitor.iniï¼ŒåŒ…å«æœåŠ¡ä¸åŒæ¥å£çš„è€—æ—¶åˆ†å¸ƒçš„monitoridï¼› test_nrpc/conf/log.iniï¼ŒåŒ…å«æ—¥å¿—æ–‡ä»¶æ»šåŠ¨æ–¹å¼ã€æ—¥å¿—çº§åˆ«çš„ç›¸å…³å®šä¹‰ï¼› test_nrpc/conf/trace.iniï¼ŒåŒ…å«åˆ†å¸ƒå¼è·Ÿè¸ªç›¸å…³backendçš„å®šä¹‰ï¼›  å¦‚æœæ‚¨å·²ç»å¯¹GoNeaté…ç½®é¡¹å¾ˆç†Ÿæ‚‰ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡è¯¥å°èŠ‚ï¼Œå½“ç„¶æˆ‘ä»¬è¿˜æ˜¯å»ºè®®é€šè¯»ä¸€ä¸‹ä»¥å°½å¯èƒ½å…¨é¢åœ°äº†è§£ä¸åŒçš„é…ç½®é¡¹ï¼Œå½“åç»­æ‚¨æœ‰éœ€æ±‚è¦å¯¹æ¡†æ¶åšå‡ºçº¦æŸæˆ–è€…æ”¹å˜çš„æ—¶å€™ï¼Œæœ‰åŠ©äºåˆ¤æ–­ç°æœ‰æ¡†æ¶èƒ½åŠ›èƒ½å¦æ»¡è¶³æ‚¨çš„éœ€è¦ã€‚\nä¸‹é¢å¯¹å„ä¸ªæ—¥å¿—æ–‡ä»¶ä¸­çš„é…ç½®é¡¹è¿›è¡Œä»‹ç»ï¼š\n  test_nrpc/conf/service.iniï¼ŒåŒ…æ‹¬æ¡†æ¶æ ¸å¿ƒé…ç½®é¡¹ï¼Œä»¥åŠhaboã€ä¸šåŠ¡åè®®ã€rpcç›¸å…³é…ç½®é¡¹ï¼š\n[service] æ¡†æ¶æ ¸å¿ƒé…ç½®é¡¹ï¼š\n  æ—¥å¿—ç›¸å…³ï¼šæ—¥å¿—çº§åˆ«ï¼Œä¿ç•™æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼Œå•æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼›\n  æ€§èƒ½ç›¸å…³ï¼šå…è®¸çš„æœ€å¤§å…¥tcpè¿æ¥æ•°ï¼Œå…è®¸çš„æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ï¼Œ\n  å†…å­˜è°ƒä¼˜ï¼šworkerpoolå…è®¸åˆ›å»ºæœ€å¤§åç¨‹æ•°ï¼Œudpæ”¶åŒ…bufferå¤§å°ï¼›\n  æœåŠ¡è´¨é‡ï¼šæœåŠ¡æ¥å£çš„è¶…æ—¶æ—¶é—´ï¼Œå¤„ç†è¯·æ±‚æ—¶è¿›è¡Œå…¨å±€è¶…æ—¶æ§åˆ¶ï¼›\n  æœåŠ¡åç§°ï¼šåˆ†å¸ƒå¼è·Ÿè¸ªæ—¶ç”¨äºè¿½è¸ªspanèŠ‚ç‚¹ï¼›\n[service] name = test_nrpc #æœåŠ¡åç§° log.level = 1 #æ¡†æ¶æ—¥å¿—çº§åˆ«,0:DEBUG,1:INFO,2:WARN,3:ERROR log.size = 64MB #æ—¥å¿—æ–‡ä»¶å¤§å°,é»˜è®¤64MB,å¯ä»¥æŒ‡å®šå•ä½B/KB/MB/GB log.num = 10 #æ—¥å¿—æ–‡ä»¶æ•°é‡,é»˜è®¤10ä¸ª limit.reqs = 100000 #æœåŠ¡å…è®¸æœ€å¤§qps limit.conns = 100000 #å…è®¸æœ€å¤§å…¥è¿æ¥æ•° workerpool.size = 20000 #workeræ•°é‡ udp.buffer.size = 4096 #udpæ¥æ”¶ç¼“å†²å¤§å°(B),é»˜è®¤1KB,è¯·æ³¨æ„æ”¶å‘åŒ…å°ºå¯¸ BuyApple.cmd.timeout = 5000 #æœåŠ¡æ¥å£BuyAppleè¶…æ—¶æ—¶é—´(ms) SellApple.cmd.timeout = 5000 #æœåŠ¡æ¥å£SellAppleè¶…æ—¶æ—¶é—´(ms)    [habo] å“ˆå‹ƒç›‘æ§é…ç½®é¡¹ï¼š\n  æ˜¯å¦å¯ç”¨å“ˆå‹ƒç›‘æ§ï¼›\n  ç”³è¯·çš„dcidï¼Œdcä¸ŠæŠ¥æ•°æ®åŒæ­¥åˆ°haboï¼›\n  dcä¸ŠæŠ¥æµ‹è¯•ç¯å¢ƒï¼Œè¿˜æ˜¯çº¿ä¸Šç¯å¢ƒï¼›\n[habo] enabled = true #æ˜¯å¦å¼€å¯æ¨¡è°ƒä¸ŠæŠ¥ caller = content_strike_svr #ä¸»è°ƒæœåŠ¡åç§° dcid = dc04125 #ç½—ç›˜id env = 0 #0:ç°ç½‘(å…¥åº“tdw), 1:æµ‹è¯•(ä¸å…¥åº“tdw)    [nrpc-service] åè®®handleré…ç½®é¡¹ï¼š\n  nrpcåè®®handlerç›‘å¬çš„tcpç«¯å£ï¼›\n  nrpcåè®®handlerç›‘å¬çš„udpç«¯å£ï¼›\n[nrpc-service] tcp.port = 8000 #tcpç›‘å¬ç«¯å£ udp.port = 8000 #udpç›‘å¬ç«¯å£    [http-service] åè®®httpé…ç½®é¡¹ï¼š\n  httpåè®®ç›‘å¬çš„ç«¯å£ï¼›\n  httpè¯·æ±‚URLå‰ç¼€ï¼›\n[http-service] http.port = 8080 #ç›‘å¬httpç«¯å£ http.prefix = /cgi-bin/web #httpUrlå‰ç¼€    [rpc-test_nrpc] rpcé…ç½®é¡¹ï¼š\n  rpcè°ƒç”¨åœ°å€ï¼Œæ”¯æŒip://ip:portã€l5://mid:cidã€cmlb://appidï¼ˆâ€œæœåŠ¡å‘ç°â€æ­£åœ¨å¼€å‘éªŒè¯ä¸­ï¼‰\n  ä¼ è¾“æ¨¡å¼ï¼Œæ”¯æŒUDPã€UDPå…¨åŒå·¥ã€TCPçŸ­è¿æ¥ã€TCPé•¿è¿æ¥ã€TCPå…¨åŒå·¥ï¼ŒTCP/UDP SendOnly\n  rpcè¶…æ—¶æ—¶é—´ï¼ŒåŒ…æ‹¬é»˜è®¤çš„timeoutä»¥åŠç»†åŒ–åˆ°å„ä¸ªæ¥å£çš„è¶…æ—¶æ—¶é—´ï¼›\n  rpcç›‘æ§monitoridï¼ŒåŒ…æ‹¬æ€»è¯·æ±‚ã€æˆåŠŸã€å¤±è´¥ã€è€—æ—¶åˆ†å¸ƒmonitor idï¼›\n[rpc-test_nrpc] addr = ip://127.0.0.1:8000 #rpcè°ƒç”¨åœ°å€ proto = 3 #ç½‘ç»œä¼ è¾“æ¨¡å¼, #1:UDP, #2:TCP_SHORT, #3:TCP_KEEPALIVE, #4:TCP_FULL_DUPLEX, #5:UDP_FULL_DUPLEX, #6:UDP_WITHOUT_RECV timeout = 1000 #rpcå…¨å±€é»˜è®¤timeout BuyApple.timeout = 1000 #rpc-BuyAppleè¶…æ—¶æ—¶é—´(ms) SellApple.timeout = 1000 #rpc-SellAppleè¶…æ—¶æ—¶é—´(ms) monitor.BuyApple.timecost10 = 10001 #è€—æ—¶\u0026lt;10ms monitor.BuyApple.timecost20 = 10002	#è€—æ—¶\u0026lt;20ms monitor.BuyApple.timecost50 = 10003	#è€—æ—¶\u0026lt;50ms ... monitor.BuyApple.timecost2000 = 10005	#è€—æ—¶\u0026lt;2000ms monitor.BuyApple.timecostover2000 = 10006	#è€—æ—¶\u0026gt;=2000ms ...      test_nrpc/conf/monitor.iniï¼Œç”¨äºç›‘æ§æœåŠ¡æ¥å£æœ¬èº«çš„æ€»è¯·æ±‚é‡ã€å¤„ç†æˆåŠŸã€å¤„ç†å¤±è´¥é‡ï¼Œä»¥åŠå¤„ç†è€—æ—¶åˆ†å¸ƒæƒ…å†µï¼š\n[test_nrpc] æœåŠ¡æ¥å£æœ¬èº«ç›‘æ§æ‰“ç‚¹monitor idï¼š\n[test_nrpc] //æœåŠ¡æ¥å£-BuyApple monitor.BuyApple.timecost10=0 #æ¥å£BuyAppleå»¶æ—¶10ms monitor.BuyApple.timecost20=0 #æ¥å£BuyAppleå»¶æ—¶20ms monitor.BuyApple.timecost50=0 #æ¥å£BuyAppleå»¶æ—¶50ms ... monitor.BuyApple.timecost3000=0 #æ¥å£BuyAppleå»¶æ—¶3000ms monitor.BuyApple.timecostover3000=0 #æ¥å£BuyAppleå»¶æ—¶\u0026gt;3000ms //	æœåŠ¡æ¥å£-SellApple monitor.SellApple.timecost10=0 #æ¥å£SellAppleå»¶æ—¶10ms monitor.SellApple.timecost20=0 #æ¥å£SellAppleå»¶æ—¶20ms monitor.SellApple.timecost50=0 #æ¥å£SellAppleå»¶æ—¶50ms ... monitor.SellApple.timecost3000=0 #æ¥å£SellAppleå»¶æ—¶3000ms monitor.SellApple.timecostover3000=0 #æ¥å£SellAppleå»¶æ—¶\u0026gt;3000ms    test_nrpc/conf/log.iniï¼Œä»£æ›¿service.iniä¸­loggingç›¸å…³é…ç½®ï¼Œç”¨æ¥æ”¯æŒå·¥å‚æ¨¡å¼è·å–loggerï¼š\nè¿™é‡Œé»˜è®¤é…ç½®äº†ä¸‰ä¸ªloggerï¼š\n æ¡†æ¶å¤„ç†æ—¥å¿—logï¼Œgo_neat_frame.logï¼Œæœ€å¤šä¿ç•™5ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå•æ–‡ä»¶ä¸Šé™100MBï¼Œå†™æ»¡åˆ™æ»šåŠ¨ï¼› æ¡†æ¶è¯·æ±‚æµæ°´logï¼Œgo_neat_access.logï¼Œæœ€å¤šä¿ç•™5ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå•æ–‡ä»¶æ— ä¸Šé™ï¼ŒæŒ‰å¤©æ»šåŠ¨ï¼› é»˜è®¤logï¼Œdefault.logï¼Œæœ€å¤šä¿ç•™5ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå•æ–‡ä»¶ä¸Šé™100MBï¼Œå†™æ»¡åˆ™æ»šåŠ¨ï¼›  #æ¡†æ¶å†…éƒ¨æ—¥å¿— [log-go_neat_frame] level = 1 #æ—¥å¿—çº§åˆ«,0:DEBUG,1:INFO,2:WARN,3:ERROR logwrite = rolling logFileAndLine = 1 rolling.filename = go_neat_frame.log rolling.type = size rolling.filesize = 100m rolling.lognum = 5 #æ¡†æ¶æµæ°´æ—¥å¿— [log-go_neat_access] level = 1 #æ—¥å¿—çº§åˆ«,0:DEBUG,1:INFO,2:WARN,3:ERROR) logwrite = rolling logFileAndLine = 0 rolling.filename = go_neat_access.log rolling.type = daily rolling.lognum = 5 #æœåŠ¡é»˜è®¤æ—¥å¿— [log-default] level = 1 #æ—¥å¿—çº§åˆ«,0:DEBUG,1:INFO,2:WARN,3:ERROR) logwrite = rolling logFileAndLine = 0 rolling.filename = default.log rolling.type = size rolling.filesize = 100m rolling.lognum = 5    test_nrpc/conf/trace.iniï¼Œç”¨äºåˆ†å¸ƒå¼è·Ÿè¸ªç›¸å…³çš„é…ç½®ï¼š\nGoNeatæ¡†æ¶é€šè¿‡opentracing apiæ”¯æŒåˆ†å¸ƒå¼è·Ÿè¸ªï¼Œæ”¯æŒä¸‰ç§backendå®ç°ï¼Œzipkinã€jaegerã€å¤©æœºé˜ï¼š\n  [zipkin] é…ç½®\n[zipkin] enabled = true #æ˜¯å¦å¯ç”¨zipkin trace service.name = test_nrpc #å½“å‰æœåŠ¡åç§°(span endpoint) service.addr = *:8000 #å½“å‰æœåŠ¡åœ°å€(span endpoint) collector.addr = http://9.24.146.130:8080/api/v1/spans #zipkin collectoræ¥å£åœ°å€ traceId128bits = true #æ˜¯å¦å¯ç”¨128bits traceId    [jaeger] é…ç½®\n[jaeger] enabled = false #æ˜¯å¦å¯ç”¨jaeger trace(æš‚æœªéªŒè¯å…¼å®¹æ€§) service.name = test_nrpc #å½“å‰æœåŠ¡åç§°(span endpoint) service.addr = *:8000 #å½“å‰æœåŠ¡åœ°å€(span endpoint) collector.addr = http://9.24.146.130:8080/api/v1/spans #jaeger collectoræ¥å£åœ°å€ traceId128bits = true #æ˜¯å¦å¯ç”¨128bits traceId    [å¤©æœºé˜] é…ç½®\n[tianjige] enabled = false #æ˜¯å¦å¯ç”¨å¤©æœºé˜ trace service.name = test_nrpc #å½“å‰æœåŠ¡åç§°(span endpoint) service.addr = *:8000 #å½“å‰æœåŠ¡åœ°å€(span endpoint) collector.addr = 10.101.192.79:9092 #å¤©æœºé˜ collectoræ¥å£åœ°å€ traceId128bits = true #æ˜¯å¦å¯ç”¨128bits traceId appid = ${your_applied_appid} #å¤©æœºé˜ç”³è¯·çš„appid      åˆå§‹åŒ–ï¼šé…ç½®åŠ è½½ # åœ¨ä»‹ç»äº†GoNeatä¾èµ–çš„é…ç½®æ–‡ä»¶åŠå„ä¸ªé…ç½®é¡¹ä¹‹åï¼Œç»§ç»­ä»‹ç»ä¸‹GoNeatçš„é…ç½®è§£æã€åŠ è½½è¿‡ç¨‹ã€‚\nGoNeatæ”¯æŒä¸¤ç§æ ¼å¼çš„é…ç½®æ–‡ä»¶:\n ä¸€ç§æ˜¯â€œiniæ ¼å¼â€çš„é…ç½®æ–‡ä»¶ï¼Œ ä¸€ç§æ˜¯â€œjsonæ ¼å¼â€çš„é…ç½®æ–‡ä»¶ã€‚  é…ç½®åŠ è½½ï¼Œå‘ç”Ÿåœ¨Serverå®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œdefault_nserver.NewNServer()ï¼Œæ­¤æ—¶ä¼šåŠ è½½service.iniã€monitor.iniã€log.iniï¼Œå¹¶æ ¹æ®é…ç½®ä¿¡æ¯å®ŒæˆServerå®ä¾‹åŒ–ã€‚ åˆå§‹åŒ–ï¼šlogging # Serverå®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»ºä¸‰ä¸ªloggerå¯¹è±¡ï¼š\n go_neat_frameï¼Œæ¡†æ¶å¤„ç†é€»è¾‘æ—¥å¿—ï¼Œå¯¹åº”log.iniä¸­çš„[go_neat_frame]ï¼› go_neat_accessï¼Œæ¡†æ¶è¯·æ±‚æµæ°´æ—¥å¿—ï¼Œå¯¹åº”log.iniä¸­çš„[go_neat_access]ï¼› defaultï¼Œæ¡†æ¶é»˜è®¤æ—¥å¿—ï¼Œå¯¹åº”log.iniä¸­çš„[default]ï¼›  æ¯ä¸ªloggerå¯¹è±¡çš„åˆ›å»ºéƒ½æ˜¯æŒ‰ç…§å¦‚ä¸‹æµç¨‹å»æ‰§è¡Œçš„ï¼Œnlog.GetLogger(logger)ï¼Œä¼šé¦–å…ˆæ£€æŸ¥loggerCacheä¸­key=$loggerçš„loggerå¯¹è±¡æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œåä¹‹ï¼ŒåŠ è½½log.iniä¸­çš„é…ç½®[$logger]ï¼Œæ£€æŸ¥logwriteé…ç½®é¡¹ï¼ŒlogwriteæŒ‡å®šäº†æ—¥å¿—è¾“å‡ºçš„ç›®çš„åœ°ï¼Œå¦‚ï¼š\n consoleï¼Œè¾“å‡ºåˆ°æ§åˆ¶å°ï¼› simpleï¼Œæ™®é€šæ—¥å¿—æ–‡ä»¶ï¼Œä¸æ”¯æŒæ»šåŠ¨ï¼› rollingï¼Œæ”¯æŒæ»šåŠ¨çš„æ—¥å¿—æ–‡ä»¶ï¼ŒåŒ…æ‹¬æŒ‰ç…§æ—¥æœŸæ»šåŠ¨ã€æ–‡ä»¶å¤§å°æ»šåŠ¨ï¼›  logwriteå…è®¸é€—å·åˆ†éš”å¤šä¸ªè¾“å‡ºï¼Œå¦‚logwrite = console, rollingï¼Œé‚£ä¹ˆæ­¤æ—¶logger.Info(â€¦)è¾“å‡ºçš„ä¿¡æ¯å°†åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œæ»šåŠ¨æ—¥å¿—æ–‡ä»¶ï¼Œè¯¦ç»†å¯å‚è€ƒnlog.MultiWriterLogWriterå®ç°ã€‚\n nlog.MultiWriterLogWriterå¯ä»¥è¿›ä¸€æ­¥é‡æ„ï¼Œå¦‚æ”¯æŒå°†æ—¥å¿—ä¿¡æ¯ä¸ŠæŠ¥åˆ°elasticsearchã€å¤©æœºé˜ç­‰å…¶ä»–è¿œç¨‹æ—¥å¿—ç³»ç»Ÿï¼Œç°åœ¨çš„å®ç°ç¨ä½œä¿®æ”¹å°±å¯ä»¥æ”¯æŒç¬¬ä¸‰æ–¹æ—¥å¿—ç»„ä»¶å®ç°ï¼Œelasticsearchã€å¤©æœºé˜ç­‰è¿œç¨‹æ—¥å¿—ç»„ä»¶åªè¦å®ç°nlog.NLogæ¥å£å¹¶å®Œæˆè¯¥å®ç°çš„æ³¨å†Œå³å¯ã€‚  åˆå§‹åŒ–ï¼štracing # åˆ†å¸ƒå¼è°ƒç”¨é“¾å¯¹GoNeatæ¡†æ¶æ¥è¯´æ˜¯å¯æ’æ‹”çš„ï¼Œå›æƒ³ä¸€ä¸‹trace.iniï¼Œæˆ‘ä»¬æ”¯æŒä¸‰ç§è°ƒç”¨é“¾backendå®ç°ï¼ŒåŒ…æ‹¬zipkinã€jaegerä»¥åŠå…¬å¸å†…éƒ¨çš„å¤©æœºé˜ï¼Œå¦‚æœå¸Œæœ›åœ¨æœåŠ¡ä¸­ä½¿ç”¨tracingï¼š\n ä½¿ç”¨zipkinï¼Œé‚£ä¹ˆåœ¨ç¨‹åºä¸­import _ â€œgit.code.oa.com/go-neat/core/depmod/trace/zipkinå³å¯ï¼› ä½¿ç”¨jaegerï¼Œé‚£ä¹ˆåœ¨ç¨‹åºä¸­import _ â€œgit.code.oa.com/go-neat/core/depmod/trace/jaegerå³å¯ï¼› ä½¿ç”¨å¤©æœºé˜ï¼Œé‚£ä¹ˆåœ¨ç¨‹åºä¸­import _ â€œgit.code.oa.com/go-neat/core/depmod/trace/tianjigeå³å¯ï¼›  å½“ç„¶é™¤äº†importå¯¹åº”çš„è°ƒç”¨é“¾å®ç°ï¼Œä¹Ÿè¦å¯¹é…ç½®æ–‡ä»¶åšè°ƒæ•´ï¼š\n ä½¿ç”¨zipkinï¼Œtrace.inié‡Œé¢è®¾ç½®zipkin.enabled = trueï¼› ä½¿ç”¨jaegerï¼Œtrace.inié‡Œé¢è®¾ç½®jaeger.enabled = true; ä½¿ç”¨å¤©æœºé˜ï¼Œtrace.inié‡Œé¢è®¾ç½®tianjige.enabled = true;   å¦‚æœåç»­æƒ³è¦æ‰©å±•tracing backendï¼Œåªéœ€è¦æä¾›å¯¹åº”çš„traceråˆå§‹åŒ–æ–¹æ³•å°±å¯ä»¥äº†ï¼Œç±»ä¼¼äºzipkinã€jaegerã€å¤©æœºé˜åˆå§‹åŒ–æ–¹å¼ã€‚å¦‚æœè¦åœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¯¥tracingå®ç°ï¼Œé€šè¿‡importå¯¹åº”å®ç°+é…ç½®æ–‡ä»¶æ¿€æ´»å°±å¯ä»¥ã€‚importå¯¹åº”çš„tracing backendåˆå§‹åŒ–ï¼Œå¹¶æ·»åŠ å¯¹åº”çš„åˆå§‹åŒ–é…ç½®ï¼Œthatâ€™s it!\n åˆå§‹åŒ–ï¼šåè®®handler # ä¸åŒçš„ä¸šåŠ¡åè®®ï¼Œå…¶å­—æ®µå®šä¹‰ã€ç¼–è§£ç æ–¹å¼å¯èƒ½ä¸åŒï¼Œåè®®handlerå°±æ˜¯å¯¹ä¸šåŠ¡åè®®çš„ç¼–è§£ç è¿›è¡Œå¤„ç†ã€‚ç›®å‰ï¼ŒGoNeatæ¡†æ¶æ”¯æŒå…¬å¸å†…å¤§å¤šæ•°ä¸šåŠ¡åè®®ï¼Œå¦‚nrpcã€ssoã€simplessoã€iliveã€qconnã€tafç­‰ç­‰ã€‚\nåè®®å¤„ç†æ–¹é¢çš„äº®ç‚¹ï¼Ÿ # GoNeatæ¡†æ¶æ”¯æŒåœ¨å•ä¸ªè¿›ç¨‹ä¸­åŒæ—¶æ”¯æŒå¤šç§ä¸šåŠ¡åè®®ï¼Œå¦‚ï¼š\n åœ¨port 8000æä¾›nrpcæœåŠ¡ï¼› åœ¨port 8001æä¾›iliveåè®®ï¼› åœ¨port 8080æä¾›httpæœåŠ¡ï¼›  åŒä¸€ä»½ä¸šåŠ¡å¤„ç†ä»£ç ï¼Œå¯ä»¥é€šè¿‡ä¸åŒçš„ä¸šåŠ¡åè®®å¯¹å¤–æä¾›æœåŠ¡ï¼Œåœ¨æ¶‰åŠåˆ°å¤šç«¯ã€å¤šä¸šåŠ¡æ–¹äº¤äº’çš„æ—¶å€™ä¼šå¾ˆæ–¹ä¾¿ã€‚\næœåŠ¡ä¸­å¦‚ä½•æ”¯æŒnrpcåè®®ï¼Ÿ # ä»¥æä¾›nrpcæœåŠ¡ä¸ºä¾‹ï¼Œåªéœ€è¦åš3ä»¶äº‹æƒ…ï¼ŒåŒ…æ‹¬ï¼š\n é…ç½®æ–‡ä»¶service.iniä¸­å¢åŠ [nrpc-service]é…ç½®é¡¹ï¼ŒæŒ‡æ˜ä¸šåŠ¡åè®®nrpcç»‘å®šçš„ç«¯å£ï¼Œå¦‚tcp.port = 8000ï¼› ä»£ç ä¸­å¼•å…¥å¯¹åº”åè®®handlerï¼Œå¦‚import _ \u0026quot;git.code.oa.com/go-neat/core/proto/nrpc/nprc_svr/default_nrpc_handler\u0026quot;ï¼› ä»£ç æ³¨å†Œnrpcå‘½ä»¤å­—åŠå¤„ç†æ–¹æ³•ï¼Œå¦‚default_nserver.AddExec(â€œBuyAppleâ€, BuyApple)ï¼›  å¦‚æœè¦åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­æ”¯æŒhttpæœåŠ¡å‘¢ï¼Œä¸€æ ·çš„ä¸‰ä»¶äº‹ï¼ŒåŒ…æ‹¬ï¼š\n  é…ç½®æ–‡ä»¶service.iniä¸­å¢åŠ [http-service]é…ç½®é¡¹ï¼ŒæŒ‡æ˜è¦ç»‘å®šçš„ç«¯å£åŠurlå‰ç¼€ï¼Œå¦‚ï¼š\n[http-service] http.port = 8080 http.prefix = /cgi-bin/web    ä»£ç å¼•å…¥åè®®handlerï¼Œå¦‚import _ â€œgit.code.oa.com/go-neat/core/proto/http/dft_httpsvrâ€ï¼›\n  ä»£ç æ³¨å†Œhttp uriï¼Œå¦‚default_nserver.AddExec(â€œ/BuyAppleâ€, BuyApple)ï¼›\n  Thatâ€™s allï¼GoNeatè¦æ”¯æŒå¸¸ç”¨çš„ä¸šåŠ¡åè®®ï¼Œåªéœ€è¦åšä¸Šè¿°ä¿®æ”¹å³å¯ï¼Œæ˜¯ä¸æ˜¯çœ‹ä¸Šå»è¿˜æŒºç®€å•æ–¹ä¾¿ï¼\n è¿˜è®°å¾—å†™ä¸€ä¸ªsppæœåŠ¡åŒæ—¶æ”¯æŒå¤šç§åè®®ï¼Œéœ€è¦åœ¨spp_handle_inputé‡Œé¢åŒºåˆ†ç«¯å£æ¥æºï¼Œç„¶åå†è°ƒç”¨å¯¹åº”çš„è§£åŒ…å‡½æ•°ï¼Œåˆ¤æ–­è¯·æ±‚å‘½ä»¤å­—ï¼Œè½¬ç»™å¯¹åº”çš„å‡½æ•°å¤„ç†ï¼Œæ¯æ¬¡æœ‰è¿™ç§éœ€è¦éƒ½éœ€è¦å†™ä¸€å †è¿™æ ·çš„ä»£ç ï¼Œå¥½å•°å—¦ï¼\n æ¡†æ¶åšäº†ä»€ä¹ˆï¼Ÿ # è¯»è€…æ˜¯å¦æ³¨æ„åˆ°å‰æ–‡ä¸­AddExec(cmd,BuyApple)ï¼Œnrpcå‘½ä»¤å­—BuyAppleï¼Œhttpè¯·æ±‚$host:8080/cgi-bin/web/BuyAppleï¼Œè¿™ä¸¤ç§ä¸åŒçš„è¯·æ±‚æœ€ç»ˆæ˜¯è¢«è·¯ç”±åˆ°äº†ç›¸åŒçš„æ–¹æ³•BuyAppleè¿›è¡Œå¤„ç†ï¼Œæ„å‘³ç€å¼€å‘äººå‘˜æ— éœ€é’ˆå¯¹ä¸åŒçš„åè®®åšä»»ä½•å…¶ä»–å¤„ç†ï¼ŒGoNeatæ¡†æ¶å¸®ä½ æå®šè¿™ä¸€åˆ‡ï¼Œä¸šåŠ¡ä»£ç é›¶ä¾µå…¥ã€‚\nçœŸçš„ä¸šåŠ¡ä»£ç é›¶ä¾µå…¥å—ï¼Ÿhttpè¯·æ±‚å‚æ•°Getã€POSTæ–¹å¼å‘¢ï¼Ÿnrpcåè®®æ˜¯protbufæ ¼å¼å‘¢ï¼ŸåŒä¸€ä»½ä¸šåŠ¡ä»£ç å¦‚ä½•å…¼å®¹ï¼Ÿ\nGoNeatå¯¹ä¸åŒçš„ä¸šåŠ¡åè®®æŠ½è±¡ä¸ºå¦‚ä¸‹å‡ å±‚ï¼š\n åè®®å®šä¹‰ï¼Œå¦‚nrpcã€iliveã€simplessoã€httpåŒ…æ ¼å¼ï¼› åè®®handlerï¼Œå®Œæˆåè®®çš„ç¼–ç ã€è§£ç æ“ä½œï¼ˆæ¥å£ç”±NHandlerå®šä¹‰ï¼‰ï¼› ä¼šè¯sessionï¼Œç»´æŒå®¢æˆ·ç«¯è¯·æ±‚ã€ä¼šè¯ä¿¡æ¯ï¼ˆæ¥å£ç”±NSessionå®šä¹‰ï¼‰ï¼›  å½“å¸Œæœ›æ‰©å±•GoNeatçš„åè®®æ—¶ï¼Œéœ€è¦æä¾›åè®®çš„åŒ…ç»“æ„å®šä¹‰ã€åè®®çš„ç¼–è§£ç å®ç°ã€åè®®ä¼šè¯å®ç°ï¼Œnrpcåè®®å¯¹åº”çš„ä¼šè¯å®ç°ä¸ºNRPCSessionã€httpåè®®å¯¹åº”çš„ä¼šè¯å®ç°æ—¶HttpSessionã€‚\nå¥½ï¼Œç°åœ¨ä»‹ç»ä¸‹GoNeatä¸­åŒä¸€ä»½ä»£ç func BuyApple(ctx context.Context, session nsession.NSession) (interface{}, error)å¦‚ä½•æ”¯æŒå¤šç§ä¸šåŠ¡åè®®ã€‚\nfile: test_nrpc/src/exec/test_nrpc.goï¼š\nfunc BuyApple(ctx context.Context, session nsession.NSession) (interface{}, error) { req := \u0026amp;test_nrpc.BuyAppleReq{} err := session.ParseRequestBody(req) ... rsp := \u0026amp;test_nrpc.BuyAppleRsp{} err = BuyAppleImpl(ctx, session, req, rsp) ... return rsp, nil }  file: test_nrpc/src/exec/test_nrpc_impl.goï¼š\nfunc BuyAppleImpl(ctx context.Context, session nsession.NSession, req *test_nrpc.BuyAppleReq, rsp *test_nrpc.BuyAppleRsp) error { // business logic return nil }  ä»ä¸Šé¢çš„ä»£ç ä¸­ test_nrpc.go ä¸éš¾çœ‹å‡ºï¼Œç§˜å¯†åœ¨äºä¸åŒåè®®ä¼šè¯å¯¹NSession.ParseRequestBody(â€¦)çš„å®ç°ï¼š\n å¦‚æœæ˜¯pbåè®®ï¼Œsessioné‡Œé¢ä¼šç›´æ¥é€šè¿‡proto.Unmarshal(data []byte, v interface{})æ¥å®ç°è¯·æ±‚è§£æï¼› å¦‚æœæ˜¯httpåè®®ï¼Œsessioné‡Œé¢ä¼šå¤šåšäº›å·¥ä½œï¼š  å¦‚æœæ˜¯POSTæ–¹æ³•ï¼Œä¸”Content-Type=â€œapplication/jsonâ€ï¼Œåˆ™è¯»å–è¯·æ±‚ä½“ç„¶åjson.Unmarshal(...)æ¥å£ï¼›   å…¶ä»–æƒ…å†µä¸‹ï¼Œè¯»å–GET/POSTè¯·æ±‚å‚æ•°è½¬æˆmap[param]=valueï¼Œç¼–ç ä¸ºjsonå†ååºåˆ—åŒ–ä¸ºç›®æ ‡ç»“æ„ä½“ï¼›  Google Protocol Bufferæ˜¯ä¸€ç§å…·æœ‰è‡ªæè¿°æ€§çš„æ¶ˆæ¯æ ¼å¼ï¼Œå‡­å€Ÿè‰¯å¥½çš„ç¼–ç ã€è§£ç é€Ÿåº¦ä»¥åŠæ•°æ®å‹ç¼©æ•ˆæœï¼Œè¶Šæ¥è¶Šå¤šçš„å¼€å‘å›¢é˜Ÿé€‰æ‹©ä½¿ç”¨pbæ¥ä½œä¸ºæœåŠ¡é—´é€šä¿¡çš„æ¶ˆæ¯æ ¼å¼ï¼ŒGoNeatæ¡†æ¶ä¹Ÿæ¨èä½¿ç”¨pbä½œä¸ºé¦–é€‰çš„æ¶ˆæ¯æ ¼å¼ã€‚\nç”±äºå…¶è‡ªæè¿°æ€§ï¼Œpbæ–‡ä»¶è¢«ç”¨æ¥æè¿°ä¸€ä¸ªåå°æœåŠ¡æ˜¯å†åˆé€‚ä¸è¿‡äº†ï¼ŒåŸºäºæ­¤ä¹Ÿè¡ç”Ÿå‡ºä¸€äº›å‘¨è¾¹å·¥å…·ï¼Œå¦‚è‡ªåŠ¨åŒ–ä»£ç ç”Ÿæˆå·¥å…·goneatï¼ˆç”±gogené‡å‘½åè€Œæ¥ï¼‰ç”¨æ¥å¿«é€Ÿç”ŸæˆæœåŠ¡æ¨¡æ¿ã€clientæµ‹è¯•ç¨‹åºç­‰ç­‰ã€‚\nGoNeat - æœåŠ¡å¯åŠ¨ # å‰é¢é›¶é›¶æ•£æ•£åœ°ä»‹ç»äº†ä¸å°‘ä¸œè¥¿ï¼Œé…ç½®æ–‡ä»¶ã€é…ç½®åŠ è½½ã€loggingåˆå§‹åŒ–ã€tracingé›†æˆã€åè®®handleræ³¨å†Œï¼Œäº†è§£äº†è¿™äº›ä¹‹åï¼Œç°åœ¨æˆ‘ä»¬ä»æ•´ä½“ä¸Šæ¥è®¤è¯†ä¸‹GoNeatæœåŠ¡çš„å¯åŠ¨è¿‡ç¨‹ã€‚\nè¯´æ˜¯ä»æ•´ä½“ä¸Šæ¥è®¤è¯†å¯åŠ¨æµç¨‹ï¼Œå¹¶ä¸æ„å‘³ç€è¿™é‡Œæ²¡æœ‰æ–°çš„ç»†èŠ‚è¦å¼•å…¥ã€‚ä¸­é—´è¿˜æ˜¯ä¼šæ¶‰åŠåˆ°ä¸€äº›æ¯”è¾ƒç»†èŠ‚çš„é—®é¢˜ï¼Œå¦‚tcpã€udpç›‘å¬å¦‚ä½•å¤„ç†çš„ï¼Œä¸ºä»€ä¹ˆè¦æ”¯æŒç«¯å£é‡ç”¨ï¼Œä¸ºæ”¯æŒå¹³æ»‘é€€å‡ºéœ€è¦åšå“ªäº›å‡†å¤‡ç­‰ç­‰ã€‚è¿™é‡Œç« èŠ‚åˆ’åˆ†çš„å¯èƒ½ä¸å¤ªç§‘å­¦ï¼Œå¸Œæœ›æŒ‰ç…§ä¸€ä¸ªGoNeatæœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸæ¥å™è¿°ï¼Œèƒ½å°½å¯èƒ½å¤šåœ°è¦†ç›–åˆ°é‚£äº›å¿…è¦çš„è®¾è®¡å’Œç»†èŠ‚ã€‚\nå¯åŠ¨ï¼šå®ä¾‹åŒ–Server # ä¸€ä¸ªGoNeatæœåŠ¡å¯¹åº”ç€ä¸€ä¸ªServerå®ä¾‹ï¼Œä¸ºäº†æ–¹ä¾¿å¿«é€Ÿè£¸å†™ä¸€ä¸ªGoNeatæœåŠ¡ï¼Œgo-neat/coreå†…éƒ¨æä¾›äº†ä¸€ä¸ªpackage default_nserverï¼Œä»£ç ä¸­åªéœ€è¦æ·»åŠ å¦‚ä¸‹ä¸¤è¡Œä»£ç å°±å¯ä»¥å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªGoNeatæœåŠ¡ï¼š\npackage main import ( â€œgit.code.oa.com/go-neat/core/nserver/default_nserverâ€ ) func main() { default_nserver.Serve() }  å½“ç„¶ï¼Œè¯¥Serverå®ä¾‹ä¼šç›´æ¥é€€å‡ºï¼Œå› ä¸ºè¯¥å®ä¾‹æ²¡æœ‰æ³¨å†Œè¦å¤„ç†çš„ä¸šåŠ¡åè®®ï¼Œéœ€è¦æ³¨å†Œåè®®handleræœåŠ¡æ‰èƒ½å·¥ä½œã€‚å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªpbæ–‡ä»¶ï¼Œå¹¶é€šè¿‡å‘½ä»¤goneat -protofile=*.proto -protocol=nrpcåˆ›å»ºå·¥ç¨‹æ—¶ï¼Œgoneatè‡ªåŠ¨åœ¨ç”Ÿæˆä»£ç ä¸­åŒ…å«äº†nrpcåè®®å¯¹åº”çš„åè®®handlerï¼Œè¿™é‡Œçš„åè®®handleråšäº†ä»€ä¹ˆå‘¢ï¼Ÿæˆ–è€…è¯´importè¿™ä¸ªåè®®handleræ—¶ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ\nimport ( _ \u0026quot;git.code.oa.com/go-neat/core/proto/nrpc/nrpc_svr/default_nrpc_handler\u0026quot; )   Serverå®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶‰åŠåˆ°é…ç½®åŠ è½½ã€loggerå®ä¾‹åŒ–ç›¸å…³çš„æ“ä½œï¼Œè¿™é‡Œåœ¨GoNeat - åˆå§‹åŒ–ä¸€èŠ‚ä¸­å·²æœ‰æåŠï¼Œè¿™é‡Œç›¸å…³å†…å®¹ä¸å†èµ˜è¿°ã€‚\n å¯åŠ¨ï¼šåŠ å…¥åè®®handler # ä»¥nrpcåè®®handlerä¸ºä¾‹ï¼š\nfile: go-neat/core/proto/nrpc/nrpc_svr/default_nrpc_handler/nrpc_svr_init.go\npackage default_nrpc_handler import ( \u0026quot;git.code.oa.com/go-neat/core/nserver/default_nserver\u0026quot; \u0026quot;git.code.oa.com/go-neat/core/proto/nrpc/nrpc_svr\u0026quot; ) func init() { default_nserver.RegisterHandler(nrpc_svr.NewNRPCHandler()) }  å½“import default_nrpc_handleræ—¶ï¼Œfunc init()ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œå®ƒä¼šå‘ä¸Šè¿°Serverå®ä¾‹ä¸­æ³¨å†Œåè®®handlerï¼Œæ³¨å†Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿå¯å‚è€ƒå¦‚ä¸‹ç®€åŒ–ç‰ˆçš„ä»£ç ï¼Œå®ƒä¸»è¦åšè¿™äº›äº‹æƒ…ï¼š\n è¯»å–service.iniä¸­çš„é…ç½®[nrpc-service]sectionä¸‹çš„tcp.portï¼Œå¦‚æœå¤§äº0åˆ›å»ºä¸€ä¸ªStreamServerï¼› è¯»å–service.iniä¸­çš„é…ç½®[nrpc-service]sectionä¸‹çš„udp.portï¼Œå¦‚æœå¤§äº0åˆ›å»ºä¸€ä¸ªPacketServerï¼› å°†ä¸Šè¿°æ–°åˆ›å»ºçš„StreamServerå’ŒPacketServeræ·»åŠ åˆ°Serverå®ä¾‹çš„ServerModuleé›†åˆä¸­ï¼›  file: go-neat/core/nserver/neat_svr.go\nfunc (svr *NServer) RegisterHandler(handler NHandler) { ... moduleNode := handler.GetProto() + \u0026quot;-service\u0026quot; if svr.config.ReadInt32(moduleNode, \u0026quot;tcp.port\u0026quot;, 0) \u0026gt; 0 { nserverModule := \u0026amp;StreamServer{protoHandler: handler} svr.serverModule = append(svr.serverModule, nserverModule) } if svr.config.ReadInt32(moduleNode, \u0026quot;udp.port\u0026quot;, 0) \u0026gt; 0 { nserverModule := \u0026amp;PacketServer{protoHandler: handler} svr.serverModule = append(svr.serverModule, nserverModule) } ... }  file: test_nrpc/conf/service.ini\n[nrpc-service] tcp.port = 8000 #tcpç›‘å¬ç«¯å£ udp.port = 8000 #udpç›‘å¬ç«¯å£  å¯åŠ¨ï¼šServerå¯åŠ¨ # default_nserver.Serve()å‘èµ·äº†Serverå®ä¾‹çš„å¯åŠ¨ï¼ŒServerå®ä¾‹ä¼šéå†å…¶ä¸Šæ³¨å†Œçš„æ‰€æœ‰ServerModuleï¼Œç„¶åé€ä¸€å¯åŠ¨å„ä¸ªServerModuleï¼Œå¦‚tcpæœåŠ¡æ¨¡å—StreamServerã€udpæœåŠ¡æ¨¡å—PacketServerã€‚\nfile: test_nrpc/src/test_nrpc.go\npackage main import ( \u0026quot;git.code.oa.com/go-neat/core/nserver/default_nserver\u0026quot; _ \u0026quot;git.code.oa.com/go-neat/core/proto/nrpc/nrpc_svr/default_nrpc_handler\u0026quot; _ \u0026quot;git.code.oa.com/go-neat/core/proto/http/dft_httpsvr\u0026quot; _ \u0026quot;exec\u0026quot; ) func main() { default_nserver.Serve() }  file: go-neat/core/nserver/neat_svr.go\nfunc (svr *NServer) Serve() { ... for _, serverModule := range svr.serverModule { if e := serverModule.Serve(); e != nil { ... } } ... }  ä»¥ä¸‹æ˜¯Serverå®ä¾‹å¯åŠ¨è¿‡ç¨‹å›¾è§£ï¼š\n package default_nserverå®ä¾‹åŒ–äº†ä¸€ä¸ªServerå®ä¾‹ï¼Œpackage mainåªéœ€è¦importè¿™ä¸ªåŒ…å³å¯å®Œæˆå®ä¾‹åŒ–ï¼› package mainä¸­importå¯¹åº”çš„åè®®handlerï¼Œåè®®handlerå°†å‘é»˜è®¤Serverå®ä¾‹æ³¨å†Œhandlerï¼› æ¯ä¸ªåè®®handleråˆæœ‰åè®®ä¹‹åˆ†ï¼Œå¦‚æ”¯æŒtcpã€udpã€httpï¼Œè¦ä¸ºä¸åŒçš„åè®®åˆ›å»ºServerModuleå¹¶æ³¨å†Œåˆ°Serverï¼› Serverå®ä¾‹è°ƒç”¨Serve()å¼€å§‹å¯åŠ¨ï¼Œè¯¥æ–¹æ³•é€ä¸€å¯åŠ¨å·²æ³¨å†Œçš„æ‰€æœ‰ServerModuleï¼›   ä¸‹é¢ä»‹ç»ä¸‹æ¡†æ¶ä¸­å®ç°çš„å‡ ä¸ªServerModuleï¼Œäº†è§£ä¸‹å®ƒä»¬çš„è®¾è®¡ç»†èŠ‚ã€‚\nå¯åŠ¨ï¼šServerModule # Serverå…è®¸æ’å…¥å¤šä¸ªServerModuleå®ç°ï¼Œæ¥æ‰©å±•Serverçš„èƒ½åŠ›ï¼Œå¦‚æ”¯æŒä¸åŒåè®®çš„ServerModuleå®ç°ï¼štcpï¼ˆStreamServerï¼‰ã€udpï¼ˆPacketServerï¼‰ã€httpï¼ˆHttpServerï¼‰ã€‚\nfile: go-neat/core/nserver/neat_svr.go\ntype NServer struct { serverName string serverModule []NServerModule ... }  file: go-neat/core/nserver/neat_comm.go\ntype NServerModule interface { Init(nserver *NServer, module string, cfg *config.Ini, log *nlog.NLog) error SetHandler(requestHandler RequestHandler) GetProto() string Serve() error Close() }  Moduleï¼šStreamServer # StreamServeræ˜¯GoNeatå°è£…çš„é¢å‘å­—èŠ‚æµï¼ˆSOCK_STREAMï¼‰çš„æœåŠ¡æ¨¡å—ï¼Œæ”¯æŒtcpå’ŒunixæœåŠ¡ã€‚\nStreamServerçš„åˆ›å»ºæ—¶åˆ»ï¼Œæˆ‘ä»¬åœ¨å‰é¢æè¿°â€œæœåŠ¡å¯åŠ¨â€çš„éƒ¨åˆ†å·²æœ‰æåŠï¼Œè¿™é‡Œæè¿°å…¶å¯åŠ¨çš„è¿‡ç¨‹ã€‚\nå¯åŠ¨ç›‘å¬ï¼Œå¤„ç†å…¥è¿æ¥è¯·æ±‚ # func (svr *StreamServer) Serve() error { tcpListener, err := net.Listen(svr.Network, svr.Addr) if nil != err { panic(fmt.Errorf(\u0026quot;listen tcp error %s\u0026quot;, err.Error())) } svr.ctx, svr.cancel = context.WithCancel(context.Background()) if nil != tcpListener { go svr.tcpAccept(svr.protoHandler, tcpListener) } return nil }  StreamServerå¯åŠ¨çš„é€»è¾‘ç®€å•æ˜äº†ï¼Œå®ƒç›‘å¬svr.Addrï¼ˆä¼ è¾“å±‚åè®®svr.Networkï¼‰åˆ›å»ºä¸€ä¸ªç›‘å¬å¥—æ¥å­—ï¼Œç„¶åä¸ºè¯¥svr.ctxåˆ›å»ºä¸€ä¸ªCancelContextï¼Œç„¶åå¯åŠ¨ä¸€ä¸ªåç¨‹è´Ÿè´£æ‰§è¡Œsvr.tcpAccept(â€¦)ï¼Œå¤„ç†tcpå…¥è¿æ¥è¯·æ±‚ã€‚\nå¹¿æ’­äº‹ä»¶ï¼Œæ”¯æŒå¹³æ»‘é€€å‡º # è¿™é‡Œæä¸€ä¸‹svr.ctx, svr.cancelï¼ŒæœåŠ¡æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œæœ‰å¯åŠ¨ä¹Ÿæœ‰åœæ­¢ï¼ŒæœåŠ¡åœæ­¢çš„æ—¶å€™ï¼Œå­˜åœ¨æŸäº›æœªå®Œç»“çš„ä»»åŠ¡éœ€è¦æ¸…ç†ï¼Œå¦‚HippoServerä¸­å¯èƒ½æ‹‰å–äº†ä¸€æ‰¹æ¶ˆæ¯ä½†æ˜¯è¿˜æœªå¤„ç†å®Œæˆï¼ŒæœåŠ¡é‡å¯ä¼šé€ æˆæ¶ˆæ¯ä¸¢å¤±ã€‚ç±»ä¼¼è¿™æ ·çš„åœºæ™¯çš„å­˜åœ¨ï¼Œè¦æ±‚æ¡†æ¶å¿…é¡»æœ‰èƒ½åŠ›å¯¹æœåŠ¡åœæ­¢äº‹ä»¶è¿›è¡Œå¹¿æ’­ï¼Œå¹¿æ’­ç»™æœåŠ¡å†…çš„æ‰€æœ‰ç»„ä»¶ï¼Œå„ä¸ªç»„ä»¶æ ¹æ®éœ€è¦è‡ªè¡Œæ‰§è¡Œæ¸…ç†åŠ¨ä½œï¼Œå¦‚HippoServerå¯èƒ½ä¼šé€‰æ‹©åœæ­¢ç»§ç»­æ”¶æ¶ˆæ¯ã€å¤„ç†å®Œæ”¶å–æ¶ˆæ¯åé€€å‡ºã€‚\nè¿™é‡Œçš„svr.ctx, svr.cancelå°±æ˜¯è´Ÿè´£å¯¹æœåŠ¡åœæ­¢äº‹ä»¶è¿›è¡Œå¹¿æ’­çš„ï¼Œå½“Serverå®ä¾‹åœæ­¢æ—¶ï¼Œä¼šéå†å…¶ä¸Šæ³¨å†Œçš„æ‰€æœ‰ServerModuleå¹¶è°ƒç”¨å…¶Close()æ–¹æ³•ï¼Œä»¥StreamServerä¸ºä¾‹ï¼š\n// Close shutdown StreamServer func (svr *StreamServer) Close() { if svr.cancel != nil { svr.cancel() } }  StreamServer.Close()è°ƒç”¨äº†svr.cancel()æ¥å–æ¶ˆsvr.ctxçš„æ‰€æœ‰child contextï¼Œå› ä¸ºsvr.ctxæ˜¯æ•´ä¸ªtcpæœåŠ¡å¤„ç†çš„root contextï¼Œæ‰€æœ‰åç»­çš„è¯·æ±‚å¤„ç†çš„contextéƒ½æ˜¯æ´¾ç”Ÿè‡ªsvr.ctxï¼Œå½“æ‰§è¡Œsvr.cancel()çš„æ—¶å€™ï¼Œæ‰€æœ‰æ´¾ç”Ÿå‡ºæ¥çš„è¯·æ±‚å¤„ç†ï¼Œéƒ½å¯ä»¥é€šè¿‡å„ä¸ªchild contextçš„Done()æ–¹æ³•æ¥æ£€æµ‹StreamServeræ˜¯å¦å·²ç»å‡†å¤‡åœæ­¢ï¼Œä»è€Œé‡‡å–å¿…è¦çš„æ¸…ç†åŠ¨ä½œã€‚\nè¿™é‡Œçš„è®¾è®¡ï¼Œä¹Ÿä¸ºGoNeatæœåŠ¡èƒ½å¤Ÿä¼˜é›…åœ°â€œå®ç°å¹³æ»‘é€€å‡ºâ€æ‰“ä¸‹äº†åŸºçŸ³ã€‚\nå»ºç«‹è¿æ¥ï¼Œå…¨åŒå·¥å¤„ç† # func (svr *StreamServer) tcpAccept(handler NHandler, listener net.Listener) { defer listener.Close() ctx := svr.ctx for { select { case \u0026lt;-ctx.Done():	//æœåŠ¡åœæ­¢ï¼Œä¸å†æ¥å—å…¥è¿æ¥è¯·æ±‚ return default:	//å»ºç«‹æ–°è¿æ¥ï¼Œå¹¶å¤„ç† conn, ex := listener.Accept() if ex != nil { log.Error(\u0026quot;accept error:%s\u0026quot;, ex) } else { if svr.connLimiter.TakeTicket() { //è‡ªæˆ‘é˜²æŠ¤ï¼Œå¯¹å…¥è¿æ¥æ•°é‡è¿›è¡Œé™åˆ¶ if tcpConn, ok := conn.(*net.TCPConn); ok { tcpConn.SetKeepAlive(true) tcpConn.SetKeepAlivePeriod(10 * time.Second) } endpoint := newEndPoint(svr, conn) go endpoint.tcpReader()	//å…¨åŒå·¥æ¨¡å¼å¤„ç†ï¼Œæ”¶åŒ…ã€å¤„ç†ã€å›åŒ…ä»¥å¹¶å‘çš„æ–¹å¼è¿›è¡Œ go endpoint.tcpWriter()	//å……åˆ†å‘æŒ¥tcpå…¨åŒå·¥çš„ç‰¹ç‚¹å’Œä¼˜åŠ¿ } else { conn.Close()	//å…¥è¿æ¥æ•°é‡è¶…è¿‡ä¸Šé™ï¼Œå…³é—­è¿æ¥ } } } } }  å¯¹äºåˆ›å»ºå¥½çš„tcpè¿æ¥ï¼ŒStreamServerå……åˆ†å‘æŒ¥äº†tcpå…¨åŒå·¥çš„ç‰¹ç‚¹å’Œä¼˜åŠ¿ï¼š\n å¯åŠ¨ä¸€ä¸ªgoroutineä¸“é—¨è´Ÿè´£æ”¶åŒ… å¯åŠ¨ä¸€ä¸ªgoroutineä¸“é—¨è´Ÿè´£å›åŒ… é’ˆå¯¹è¿æ¥ä¸Šåˆ°è¾¾çš„è¯·æ±‚åŒ…ï¼Œåˆ™é€šè¿‡åç¨‹æ± è¿›è¡Œå¤„ç† åŒä¸€ä¸ªè¿æ¥ä¸Šçš„æ”¶åŒ…ã€å¤„ç†ã€å›åŒ…æ˜¯å¹¶å‘çš„  å›æƒ³ä¸‹æˆ‘ä»¬å†™C++æœåŠ¡ç«¯çš„ç»å†ï¼Œé€šè¿‡epollç›‘å¬æ¯ä¸ªè¿æ¥å¥—æ¥å­—ä¸Šçš„è¯»å†™å°±ç»ªäº‹ä»¶ï¼Œread-readyçš„æ—¶å€™è¦åŠæ—¶ä»è¿æ¥ä¸­å–å‡ºæ•°æ®æ”¾åˆ°è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼Œwrite-readyçš„æ—¶å€™å¦‚æœè¯·æ±‚å¤„ç†å®Œå°±å›åŒ…ã€‚å•è¿›ç¨‹å¤šçº¿ç¨‹æ¨¡å‹ï¼Œå¾€å¾€æœ‰ä¸“é—¨çš„ioçº¿ç¨‹æ¥è¿›è¡Œæ•°æ®åŒ…çš„æ”¶å‘ï¼Œé€»è¾‘å¤„ç†çº¿ç¨‹ä»è¯·æ±‚é˜Ÿåˆ—ä¸­å–èµ°è¯·æ±‚èµ¶ç´§å¤„ç†å¹¶å‡†å¤‡å¥½å›åŒ…æ•°æ®ï¼Œioçº¿ç¨‹å–èµ°å›åŒ…æ‰§è¡Œå“åº”åŠ¨ä½œï¼›å¦‚æœæ˜¯å•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹ï¼Œioäº‹ä»¶æœªå°±ç»ªçš„æƒ…å†µä¸‹å°±è¦èµ¶ç´§æ‰§è¡Œé€»è¾‘å¤„ç†ï¼›å¤šè¿›ç¨‹æ¨¡å‹ï¼Œåˆ™å¯èƒ½ä¼šé‡‡ç”¨ç±»ä¼¼sppçš„æ¶æ„ï¼Œproxyè´Ÿè´£ioï¼Œè¯·æ±‚æ”¾å…¥å…±äº«å†…å­˜ï¼Œworkerè¿›ç¨‹ä»å…±äº«å†…å­˜è·å–è¯·æ±‚å¹¶å†™å…¥å“åº”ï¼Œproxyå†è´Ÿè´£å›åŒ…ã€‚\nä½¿ç”¨goè¿›è¡Œå¼€å‘å‘¢ï¼Ÿgoå¯¹é˜»å¡å‹ç³»ç»Ÿè°ƒç”¨è¿›è¡Œäº†å®Œæ•´çš„è§£å‰–ï¼Œæ‰€æœ‰çš„ç½‘ç»œioã€è¯·æ±‚å¤„ç†ï¼Œéƒ½æ˜¾å¾—é‚£ä¹ˆç®€å•ã€è‡ªç„¶ï¼Œä»¥è‡³äºéƒ½å·²ç»æ·¡å¿˜äº†C++æœåŠ¡ç«¯å¼€å‘ä¸­å­˜åœ¨çš„ä¸åŒç½‘ç»œæ¨¡å‹ã€‚å½“ç„¶ï¼Œç½‘ç»œæ¨¡å‹çš„æ€æƒ³åœ¨ï¼Œä½†å·²ç»æ— éœ€å…³æ³¨å¤šè¿›ç¨‹å•è¿›ç¨‹ã€å¤šçº¿ç¨‹å•çº¿ç¨‹äº†ï¼Œåªéœ€è¦é“­è®° â€œtcpæ˜¯å…¨åŒå·¥æ¨¡å¼â€ï¼Œå€ŸåŠ©golangè¿™ä¸€å¼ºå¤§çš„åŸºç¡€è®¾æ–½æ¥æœ€ä¼˜åŒ–tcpæœåŠ¡æ€§èƒ½å³å¯ã€‚\nå…³äº go endpoint.tcpReader() å’Œ go endpoint.tcpWriter() çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨åé¢æœåŠ¡æ€ é€Ÿã€è¯·æ±‚å¤„ç†ä¸­ä»‹ç»ã€‚\nè¿‡è½½ä¿æŠ¤ï¼Œé™åˆ¶å…¥è¿æ¥æ•° # StreamServerå¾ªç¯æ‰§è¡ŒAccept()æ–¹æ³•æ¥å»ºç«‹è¿æ¥ï¼Œå½“ç„¶ç”±äºè®¡ç®—èµ„æºæœ‰é™ï¼ŒæœåŠ¡èƒ½å¤„ç†çš„è¿æ¥æ•°ã€è¯·æ±‚æ•°æ˜¯æœ‰é™çš„ï¼ŒæœåŠ¡éœ€è¦è¿›è¡Œä¸€å®šçš„é˜²æŠ¤é¿å…è¿‡è½½ã€é›ªå´©ã€‚å½“svr.connLimiter.TakeTicket()æˆåŠŸæ—¶è¡¨ç¤ºè¿æ¥æ•°æœªè¶…é™ï¼Œå¯ä»¥ç»§ç»­å¤„ç†ï¼Œåä¹‹è¡¨ç¤ºè¶…å‡ºå…¥è¿æ¥æ•°ä¸Šé™ï¼Œå…³é—­è¿æ¥ã€‚\nå¾ªç¯Accept()è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ£€æµ‹åˆ°StreamServeråœæ­¢ctx.Done()ï¼Œå…³é—­ç›‘å¬å¥—æ¥å­—ä¸å†æ¥å—å…¥è¿æ¥è¯·æ±‚ã€‚\nè¿‡è½½ä¿æŠ¤ï¼Œé™åˆ¶å…¥è¯·æ±‚æ•° # é™¤äº†å¯¹å…¥tcpè¿æ¥æ•°è¿›è¡Œé™åˆ¶ï¼ŒStreamServerä¹Ÿå¯¹å…¥è¯·æ±‚æ•°è¿›è¡Œé™åˆ¶ï¼Œè¿™éƒ¨åˆ†åœ¨åç»­â€œè¯·æ±‚å¤„ç†â€ä¸­ä»‹ç»ã€‚\nModuleï¼šPacketServer # PacketServeræ˜¯GoNeatå°è£…çš„é¢å‘æ•°æ®æŠ¥ï¼ˆSOCK_PACKETï¼‰çš„æœåŠ¡æ¨¡å—ï¼Œæ”¯æŒudpæœåŠ¡ã€‚\nä¸ä»‹ç»StreamServerçš„æ–¹å¼ç±»ä¼¼ï¼ŒPacketServerå®ä¾‹åŒ–çš„éƒ¨åˆ†å‰æ–‡å·²ä»‹ç»è¿‡ï¼Œè¿™é‡Œåªä»‹ç»å…¶å¯åŠ¨çš„è¿‡ç¨‹ã€‚\nå¯åŠ¨ç›‘å¬ï¼Œå¤„ç†å…¥udpè¯·æ±‚ # PacketServer.Server()ä¸­è°ƒç”¨ reuseport.ListenPacket(...) æˆ–è€… net.ListenPacket(...) ç›‘å¬svr.Addrï¼ˆä¼ è¾“å±‚åè®®ç±»å‹svr.Networkï¼‰åˆ›å»ºç›‘å¬å¥—æ¥å­—ï¼Œå¹¶ä»ä¸­æ¥æ”¶udpè¯·æ±‚ã€å¤„ç†è¯·æ±‚ã€å“åº”ï¼Œè¯¦è§svr.udpRead(â€¦)ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­â€œè¯·æ±‚å¤„ç†â€å°èŠ‚ä¸­è¿›è¡Œä»‹ç»ã€‚\n// Serve start the PacketServer func (svr *PacketServer) Serve() error { svr.ctx, svr.cancel = context.WithCancel(context.Background()) if svr.shouldReusePort() {	//å¦‚æœæ”¯æŒé‡ç”¨ç«¯å£ï¼Œlinux+darwin reuseNum := runtime.NumCPU() for i := 0; i \u0026lt; reuseNum; i++ { udpConn, err := reuseport.ListenPacket(svr.Network, svr.Addr) if nil != err { panic(fmt.Errorf(\u0026quot;listen udp error %s\u0026quot;, err.Error())) } if nil != udpConn { go svr.udpRead(svr.protoHandler, udpConn) } } } else {	//å¦‚æœä¸æ”¯æŒç«¯å£é‡ç”¨ï¼Œwindows udpConn, err := net.ListenPacket(svr.Network, svr.Addr) if nil != err { panic(fmt.Errorf(\u0026quot;listen udp error %s\u0026quot;, err.Error())) } if nil != udpConn { go svr.udpRead(svr.protoHandler, udpConn) } } return nil }  ç«¯å£é‡ç”¨ï¼ŒåŠ é€Ÿudpæ”¶åŒ… # é˜…è¯»ä¸Šè¿°ä»£ç ï¼Œæ‚¨ä¸€å®šå…³æ³¨åˆ°äº†è¿™ä¹ˆä¸€ç‚¹ï¼Œ reuseport.ListenPacket(...) å’Œ net.ListenPacket(...) ã€‚åœ¨ç»§ç»­æè¿°ä¹‹å‰ï¼Œéœ€è¦å¯¹æ¯”ä¸‹tcpæ”¶åŒ…å’Œudpæ”¶åŒ…çš„åŒºåˆ«ã€‚\n tcpæ˜¯é¢å‘è¿æ¥çš„ï¼Œå¾€å¾€ä¸ºæ¯ä¸€ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„goroutineè¿›è¡Œæ”¶åŒ…ï¼› udpæ˜¯æ— è¿æ¥çš„ï¼Œè¦åˆ†é…å¤šå°‘ä¸ªåç¨‹è¿›è¡Œæ”¶åŒ…å‘¢ï¼Ÿ1ä¸ªæˆ–è€…Nä¸ªï¼Ÿå¯¹åŒä¸€ä¸ªfdè¿›è¡Œæ“ä½œï¼Œå¼€å¤šä¸ªgoroutineæ˜¯æ²¡æœ‰ä»·å€¼çš„ï¼Œé‚£ä¹ˆ1ä¸ªçš„è¯å‘¢ï¼Œæ”¶åŒ…æ•ˆç‡å’Œtcpå¯¹æ¯”åˆæœ‰ç‚¹ä½æ•ˆã€‚è¿™å°±æ˜¯PacketServeré‡ç”¨ç«¯å£reuseportçš„ç”±æ¥äº†ï¼Œå€Ÿæ­¤æé«˜udpæ”¶åŒ…çš„æ•ˆç‡ã€‚  é‡ç”¨ç«¯å£ï¼ˆREUSEPORTï¼‰å’Œé‡ç”¨åœ°å€ï¼ˆREUSEADDRï¼‰ï¼ŒäºŒè€…è¯ç”Ÿçš„åˆè¡·å’Œä½œç”¨æ˜¯ä¸åŒçš„ï¼š\n TCP/UDPè¿æ¥ï¼ˆUDPæ— è¿æ¥ä½†å¯ä»¥connectï¼‰ï¼Œç”±äº”å…ƒç»„è¡¨ç¤ºï¼š\u0026lt;åè®®ç±»å‹ï¼Œæºipï¼Œæºç«¯å£ï¼Œç›®çš„ipï¼Œç›®çš„ç«¯å£\u0026gt;ï¼› REUSEADDRè§£å†³çš„æ˜¯ç›‘å¬æœ¬åœ°ä»»æ„åœ°å€0.0.0.0:portä¸å¦ä¸€ä¸ªç›‘å¬æœ¬åœ°ç‰¹å®šåœ°å€ç›¸åŒç«¯å£a.b.c.d:portçš„é—®é¢˜ï¼› REUSEPORTè§£å†³å¤šä¸ªsocketsï¼ˆå¯èƒ½å½’å±äºç›¸åŒæˆ–è€…ä¸åŒçš„è¿›ç¨‹ï¼‰æ˜¯å¦å…è®¸bindåˆ°ç›¸åŒç«¯å£çš„é—®é¢˜ï¼Œ  Linuxä¸‹ä¸ºäº†é¿å…port hijackï¼Œåªå…è®¸euidç›¸åŒçš„è¿›ç¨‹bindåˆ°ç›¸åŒçš„portï¼ˆbindè®¾ç½®socketæºportï¼Œconnectè®¾ç½®socketç›®çš„ç«¯å£ï¼‰ï¼ŒåŒæ—¶å¯¹äºtcp listen socketã€udp socketè¿˜ä¼šè¿›è¡Œâ€œå‡åŒ€çš„â€æµé‡åˆ†å‘ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè½»é‡çš„è´Ÿè½½å‡è¡¡æ–¹æ¡ˆã€‚\ngolangæ ‡å‡†åº“ä¸­æš‚æ²¡æœ‰æä¾›reuseportçš„èƒ½åŠ›ï¼Œè¿™é‡Œæ˜¯å¼•å…¥äº†ç¬¬ä¸‰æ–¹å®ç°ï¼Œç›®å‰æ”¯æŒLinux+Darwinå¹³å°ä¸‹çš„udp reuseportï¼ŒWindowsæš‚ä¸æ”¯æŒã€‚\nè¿‡è½½ä¿æŠ¤ï¼Œé™åˆ¶å…¥è¯·æ±‚æ•° # ä¸StreamServerç±»ä¼¼ï¼ŒPacketServerä¹Ÿæœ‰è¿‡è½½ä¿æŠ¤æœºåˆ¶ï¼Œå°±æ˜¯é™åˆ¶å…¥udpè¯·æ±‚æ•°ï¼Œæˆ‘ä»¬åœ¨åç»­â€œè¯·æ±‚å¤„ç†â€å°èŠ‚ä¸­ä»‹ç»ã€‚\nModuleï¼šHttpServer # HttpServeræ˜¯GoNeatåœ¨golangæ ‡å‡†åº“åŸºç¡€ä¸Šå°è£…çš„httpæœåŠ¡æ¨¡å—ï¼Œæ”¯æŒä¸StreamServerã€PacketServerä¸€æ ·çš„æ¥å£æ³¨å†Œã€æ¥å£è·¯ç”±ã€æ¥å£å¤„ç†é€»è¾‘ã€‚\næ ‡å‡†åº“httpåŸºç¡€ä¸Šå®ç° # ä»ä¸‹é¢ä»£ç ä¸éš¾çœ‹å‡ºï¼ŒHttpServerï¼Œè¯¥ServerModuleçš„å®ç°æ—¶åŸºäºæ ‡å‡†åº“http packageå®ç°çš„ï¼Œå¯¹å¤§å®¶æ¥è¯´åº”è¯¥éƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸ªé€‚é…GoNeatçš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯è¯·æ±‚è·¯ç”±è¿™é‡Œã€‚\n// Serve start HttpServer func (svr *HttpServer) Serve() error { svr.serve() return nil } // serve start HttpServer func (svr *HttpServer) serve() { var h http.Handler = http.HandlerFunc(svr.doService) listener, err := net.Listen(\u0026quot;tcp\u0026quot;, fmt.Sprintf(\u0026quot;:%d\u0026quot;, svr.port)) if err != nil { panic(err) } server := \u0026amp;http.Server{ Addr: fmt.Sprintf(\u0026quot;:%d\u0026quot;, svr.port), Handler: http.StripPrefix(svr.prefix, h), } go func() { err := server.Serve(listener) if err != nil { svr.log.Error(\u0026quot;http svr start failed, err: %v\u0026quot;, err) } }() }  httpserverè¯·æ±‚è·¯ç”±è½¬å‘ # å€ŸåŠ©æ ‡å‡†åº“å®ä¾‹åŒ– http.Server{} æ—¶ï¼ŒæŒ‡å®šäº†å°†è¯·æ±‚URI Prefixä¸ºsvr.prefixçš„è¯·æ±‚ï¼Œäº¤ç”±handler hå¤„ç†ã€‚è€Œhæ˜¯svr.doService(â€¦)å¼ºåˆ¶ç±»å‹è½¬æ¢æˆçš„http.HandlerFuncã€‚\nçœ‹doServiceçš„å®šä¹‰ï¼Œå¯çŸ¥å®ƒç¡®å®æ˜¯ä¸€ä¸ªhttp.HandlerFuncï¼ˆæ»¡è¶³HandlerFuncçš„å®šä¹‰ï¼‰ï¼Œè¿™æ ·è¯·æ±‚å°±é€’äº¤ç»™äº†doServiceè¿›è¡Œå¤„ç†ï¼ŒdoServiceä¸­è°ƒç”¨svr.requestHandler(req.Context(), httpSession)å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œæ³¨æ„è¿™é‡Œä¸ºè¯·æ±‚ä¸“é—¨åˆ›å»ºäº†ä¸€ä¸ªHttpSessionï¼Œè€Œè¿™é‡Œçš„svr.requestHandler(â€¦)æ˜¯åœ¨å“ªé‡Œè®¾ç½®å‘¢ï¼Ÿ\nsvr.requestHandlerå­—æ®µçš„è®¾ç½®ï¼Œè¦è¿½æº¯åˆ°HttpServerè¿™ä¸ªServerModuleå®ä¾‹åŒ–çš„æ—¶å€™ï¼Œdefault_nserverç¤ºä¾‹ä¼šè°ƒç”¨serverModule.SetHandler(nserver.process)æ–¹æ³•å°†HttpServer.requestHandlerè®¾ç½®ä¸ºnserver.process(â€¦)ï¼Œå³ï¼šfunc process(svr *NServer, ctx Context, NSession) erroræ‰æ˜¯è¯·æ±‚å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ä¹‹ä¸€ï¼Œæ¶‰åŠåˆ°é‰´æƒã€å‘½ä»¤å­—è·¯ç”±ã€è¯·æ±‚å¤„ç†ã€tracingã€è€—æ—¶ç›‘æ§ç­‰ï¼Œç¨ååœ¨â€œè¯·æ±‚å¤„ç†â€éƒ¨åˆ†è¿›è¡Œä»‹ç»ã€‚\n// HttpServer defines the http NServerModule implementation type HttpServer struct { nserver *NServer port int32 log *nlog.NLog prefix string requestHandler RequestHandler enableGzip bool svr *http.Server } ... // doService process http request `req` func (svr *HttpServer) doService(w http.ResponseWriter, req *http.Request) { requestLimiter := svr.nserver.reqLimiter if requestLimiter.TakeTicket() { addr := svr.getClientAddr(req) defer func() { requestLimiter.ReleaseTicket() }() httpSession := NewHttpSession(addr, svr.log, req, w) ex := svr.requestHandler(req.Context(), httpSession) if ex != nil { w.WriteHeader(505) return } if httpSession.retcode == errCodeCmdNotFound { w.WriteHeader(404) } else { if len(httpSession.rspData) \u0026gt; 0 { w.Write(httpSession.rspData) } } } else { svr.log.Error(\u0026quot;http svr req overload\u0026quot;) } }  è¿‡è½½ä¿æŠ¤ï¼Œé™åˆ¶å…¥httpè¯·æ±‚æ•° # HttpServerä¹Ÿå¯¹å…¥è¯·æ±‚æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œå®ç°å¯¹è‡ªèº«çš„è¿‡è½½ä¿æŠ¤ï¼Œé‡‡ç”¨çš„æ–¹å¼ä¸ä¹‹å‰tcpã€udpçš„å¤„ç†æ–¹å¼ç±»ä¼¼ã€‚\nModuleï¼šScheduleServer # ScheduleServeræ˜¯GoNeatä¸ºå®šæ—¶ä»»åŠ¡å°è£…çš„ä¸€ä¸ªæœåŠ¡æ¨¡å—ï¼Œç®€åŒ–å®šæ—¶ä»»åŠ¡å®ç°é€»è¾‘ã€‚\nç”±äºè¿™é‡Œçš„å®ç°é€»è¾‘æ¯”è¾ƒç®€å•ã€æ¸…æ™°ï¼Œè¿™é‡Œè¯»è€…å¯ä»¥è‡ªå·±é˜…è¯»ä»£ç è¿›è¡Œäº†è§£ã€‚\nModuleï¼šHippoServer # HippoServeræ˜¯é’ˆå¯¹æ¶ˆæ¯é©±åŠ¨çš„ä¸šåŠ¡åœºæ™¯å°è£…çš„ä¸€ä¸ªæ¶ˆè´¹è€…æœåŠ¡ï¼Œç®€åŒ–æ¶ˆæ¯æ¶ˆè´¹çš„ä»»åŠ¡å¤„ç†ã€‚\nç”±äºè¿™é‡Œçš„å®ç°é€»è¾‘æ¯”è¾ƒç®€å•ã€æ¸…æ™°ï¼Œè¿™é‡Œè¯»è€…å¯ä»¥è‡ªå·±é˜…è¯»ä»£ç è¿›è¡Œäº†è§£ã€‚\nGoNeat - è¯·æ±‚å¤„ç† # å‰æ–‡æè¿°äº†Serverå®ä¾‹åŠå„ä¸ªServerModuleå¯åŠ¨çš„è¿‡ç¨‹ï¼Œè‡³æ­¤æœåŠ¡å·²ç»å®Œå…¨å¯åŠ¨ï¼Œå¯ä»¥è¿›è¡Œè¯·æ±‚å¤„ç†äº†ã€‚\nè¿™é‡Œé€‰æ‹©StreamServerã€PacketServerã€HttpServerä½œä¸ºé‡ç‚¹æè¿°å¯¹è±¡ï¼Œè¿™å‡ ä¸ªServerModuleæ˜¯æ—¥å¸¸ä¸šåŠ¡å¼€å‘ä¸­ä½¿ç”¨æœ€é¢‘ç¹çš„ï¼Œåº”è¯¥ä¹Ÿæ˜¯è¯»è€…æœ€å¸Œæœ›äº†è§£çš„ã€‚åœ¨é€ä¸€æè¿°ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸‹ç”¨åˆ°çš„é‡è¦â€œåŸºç¡€è®¾æ–½â€ã€‚\nåŸºç¡€è®¾æ–½ï¼šåç¨‹æ±  # å¯¹äºæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œè¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯ä»»åŠ¡è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚åç¨‹æ˜¯ç›¸æ¯”äºçº¿ç¨‹è€Œè¨€æ›´åŠ è½»é‡çš„è°ƒåº¦å®ä½“ï¼Œå®ƒçš„è½»é‡ä½“ç°åœ¨åˆ›å»ºã€ä»»åŠ¡åˆ‡æ¢ã€é”€æ¯æ—¶çš„ä»£ä»·ï¼Œå¦‚åˆå§‹åˆ†é…çš„æ ˆå¸§å¤§å°ã€ä»»åŠ¡åˆ‡æ¢æ—¶ä¿å­˜æ¢å¤çš„å¯„å­˜å™¨æ•°é‡ç­‰ã€‚\ngoå®˜æ–¹å£°ç§°å¯ä»¥è½»æ¾åˆ›å»ºå‡ ç™¾ä¸‡çš„åç¨‹ï¼Œåˆå§‹åç¨‹æ ˆå¤§å°2KBï¼Œ100wçš„è¯ä¹Ÿå°±æ˜¯2GBï¼Œå°½ç®¡å½“å‰çš„æœåŠ¡ä¸»æµæœºå™¨é…ç½®åº”è¯¥éƒ½å¯ä»¥æ”¯æŒåˆ°ï¼Œä½†æ˜¯æœ‰äº›é—®é¢˜æˆ‘ä»¬å´ä¸èƒ½ä¸å»ä¸è€ƒè™‘ã€‚\n  ä¸€ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œè¯·æ±‚é‡å¤§æ—¶åç¨‹æ•°å¤§æ¶¨ï¼Œä¼šå› ä¸ºOOM Killè¢«æ“ä½œç³»ç»Ÿæ€æ­»ï¼›\nè¯·æ±‚é‡ä¸Šæ¶¨ã€åç¨‹æ•°ä¸Šæ¶¨ã€åƒå†…å­˜ä¸¥é‡ï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½ä¼šåˆ¤å®šOOMåˆ†å€¼æ—¶å°†å…¶ç‡å…ˆåˆ—å…¥æ­»äº¡åå•ï¼Œè¿›ç¨‹æŒ‚æ‰æœåŠ¡ä¸å¯ç”¨ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚æœåŠ¡å…è®¸å‡ºç°è¿‡è½½ã€å¤„ç†è¶…æ—¶ã€ä¸¢å¼ƒè¯·æ±‚è‡ªä¿ï¼Œä½†æ˜¯ä¸èƒ½æŒ‚æ‰ã€‚\n  å°½ç®¡åç¨‹çš„åˆ›å»ºã€é”€æ¯æ›´åŠ è½»é‡ï¼Œä½†æ˜¯å¼€é”€è¿˜æ˜¯å­˜åœ¨ï¼›\nåç¨‹æ± ï¼Œé¢„å…ˆåˆ›å»ºä¸€å®šæ•°é‡çš„åç¨‹å¤‡ç”¨ï¼Œåç¨‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œé¿å…é¢‘ç¹åˆ›å»ºã€é”€æ¯çš„å¼€é”€ã€‚åŒæ—¶ï¼Œä¸ºäº†é¿å…å•ä¸€é”ç«äº‰ï¼Œä¸ºæ¯ä¸ªåç¨‹åˆ†é…å•ç‹¬çš„ä¸€ä¸ªchanä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ã€‚\n  å°½ç®¡åç¨‹çš„åˆ‡æ¢ä»£ä»·æ›´å°ï¼Œå½“åç¨‹æ•°é‡å¾ˆå¤šæ—¶ï¼Œåç¨‹åˆ‡æ¢çš„ä»£ä»·å°±ä¸èƒ½å¿½ç•¥äº†ï¼›\nioäº‹ä»¶å°±ç»ªå¼•èµ·åç¨‹g1è¢«å”¤é†’ï¼Œæˆ‘ä»¬æœŸæœ›g1ç»§ç»­æ‰§è¡Œå¤„ç†ï¼Œç»“æœåç¨‹g2çš„ioäº‹ä»¶å°±ç»ªåˆå”¤é†’åç¨‹g2ï¼Œruntime schedulerå¯èƒ½åœ¨æŸä¸ªæ—¶åˆ»ï¼ˆå¦‚g1è¿›å…¥function prologueæ—¶ï¼‰å°†g1åˆ‡æ¢ä¸ºg2â€¦â€¦ç¨‹åºæ‰§è¡Œè·¯å¾„ç±»ä¼¼äºå¤šé‡ä¸­æ–­å¤„ç†ï¼Œé‚£ä»€ä¹ˆæ—¶å€™è¢«ä¸­æ–­çš„åç¨‹g1å¯ä»¥ç»§ç»­æ¢å¤æ‰§è¡Œå‘¢ï¼Ÿå¦‚æœåç¨‹æ•°é‡å¾ˆå¤šï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ä»·å°±éœ€è¦å¼•èµ·å…³æ³¨ã€‚\nç‰¹åˆ«æ˜¯å¸Œæœ›å°½å¯èƒ½å¹¶å‘å¤„ç†è¿æ¥ä¸Šçš„å¤šä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæ¯”ä¸€ä¸ªè¿æ¥ä¸€ä¸ªåç¨‹åˆ›å»ºæ›´å¤šçš„åç¨‹ã€‚åˆæƒ³å¹¶å‘å¤„ç†è¿æ¥ä¸Šçš„å¤šä¸ªè¯·æ±‚ï¼Œåˆæƒ³é™ä½åç¨‹æ•°è¿‡å¤šå¸¦æ¥çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œé€šè¿‡åç¨‹æ± é™åˆ¶åç¨‹æ•°é‡ï¼Œä¹Ÿæ˜¯ä¸€ç§é€‰æ‹©ã€‚\n  å…¶ä»–è€ƒè™‘ï¼›\n  é‰´äºä¸Šè¿°è€ƒè™‘ï¼Œæˆ‘ä»¬é‡‡ç”¨åç¨‹æ± æ¥å¤„ç†å¹¶å‘è¯·æ±‚ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªåç¨‹è¿›è¡Œå¤„ç†ã€‚\nåŸºç¡€è®¾æ–½ï¼šå†…å­˜æ±  # goè‡ªå¸¦å†…å­˜ç®¡ç†ï¼Œå†…å­˜åˆ†é…ã€é€ƒé€¸åˆ†æã€åƒåœ¾å›æ”¶ï¼Œå†…å­˜åˆ†é…ç®—æ³•å¦‚ä½•æé«˜åˆ†é…æ•ˆç‡ã€å‡å°‘ç¢ç‰‡æ˜¯ä¸€ä¸ªå¸¸è¢«æåŠçš„é—®é¢˜ï¼Œå³ä¾¿goåœ¨è¿™æ–¹é¢åŸºäºtcmallocå’Œgoè‡ªèº«ç‰¹æ€§åšäº†ä¼˜åŒ–ï¼Œæ¡†æ¶å¼€å‘ä»éœ€è¦å…³æ³¨å†…å­˜åˆ†é…é—®é¢˜ï¼Œæ­¤å¤–è¿˜è¦å…³æ³¨gcã€‚\nè€ƒè™‘å†…å­˜åˆ†é…çš„æƒ…æ™¯ï¼Œå¦‚æœæˆ‘ä»¬é¢‘ç¹åœ¨heapä¸­ç”³è¯·å†…å­˜ï¼ˆé€ƒé€¸åˆ†æä¼šå†³å®šåˆ†é…åœ¨heapä¸Šè¿˜æ˜¯stackä¸Šï¼‰ï¼Œä¸ä»…ä¼šå¢åŠ å†…å­˜åˆ†é…çš„å¼€é”€ï¼Œä¹Ÿä¼šå¢åŠ gcæ‰«æã€å›æ”¶æ—¶çš„å‹åŠ›ã€‚\nå†…å­˜åˆ†é…æ¬¡æ•°å¢åŠ å¼•å…¥é¢å¤–å¼€é”€ä¸éš¾ç†è§£ï¼Œä½¿ç”¨sync.Poolå¯ä»¥åœ¨ä¸¤æ¬¡gc cycleé—´éš™è¿”å›å·²åˆ†é…çš„å†…å­˜æ¥å¤ç”¨ä»¥å‡è½»å†…å­˜åˆ†é…çš„æ¬¡æ•°ï¼Œè‡ªç„¶ä¹Ÿä¼šå‡è½»gcæ‰«æã€æ ‡è®°ã€å›æ”¶çš„å‹åŠ›ã€‚\næ¯æ¬¡ gcStart(){...} å¼€å§‹æ–°ä¸€è½®gcæ—¶ï¼Œä¼šé¦–å…ˆæ¸…ç†sync.Poolsï¼Œæ¸…ç†é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•æš´åŠ›ï¼Œsync.Poolsä¸­çš„ç©ºé—²å†…å­˜å—éƒ½ä¼šè¢«æ¸…ç©ºï¼Œè¿›å…¥åç»­åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥å†…å­˜æ± ä¸é€‚åˆç”¨ä½œè¿æ¥æ± ç­‰æœ‰çŠ¶æ€çš„å¯¹è±¡æ± ã€‚\nåœ¨GoNeatæ¡†æ¶ä¸­æˆ‘ä»¬å°†å…¶ç”¨ä½œæ”¶å‘åŒ…bufferæ± ï¼Œç”¨å®Œå³é‡Šæ”¾ï¼Œä¸å­˜åœ¨ä¸Šè¿°æœ‰çŠ¶æ€å¯¹è±¡è¢«æ¸…ç†çš„é—®é¢˜ã€‚\nModuleï¼šStreamServer # StreamServerï¼Œæä¾›tcpç½‘ç»œæœåŠ¡ï¼Œå‰æ–‡å·²ç»ä»‹ç»äº†StreamServeræ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªå¤§è‡´æƒ…å†µï¼ŒåŒ…æ‹¬å¯åŠ¨ç›‘å¬ã€å»ºç«‹è¿æ¥ã€æ¥æ”¶è¯·æ±‚ã€è¿‡è½½ä¿æŠ¤ã€é€€å‡ºç­‰ï¼Œç°åœ¨æˆ‘ä»¬æŠŠè§†è§’é”å®šåœ¨â€œè¯·æ±‚å¤„ç†â€è¿™ä¸ªç¯èŠ‚ï¼Œè¿›ä¸€æ­¥äº†è§£å…¶å·¥ä½œè¿‡ç¨‹ã€‚\nå†ç®€å•å›é¡¾ä¸€ä¸‹ï¼ŒæœåŠ¡ç«¯StreamServerå·²ç»å¯åŠ¨ï¼Œç°åœ¨æ­£è°ƒç”¨listener.Accept()ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ã€‚\nfunc (svr *StreamServer) tcpAccept(handler NHandler, listener net.Listener) { ... for { ... conn, ex := listener.Accept() endpoint := newEndPoint(svr, conn) go endpoint.tcpReader() go endpoint.tcpWriter() } }  å®¢æˆ·ç«¯å‘èµ·å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œlistener.Accept()å°†è¿”å›å»ºç«‹çš„è¿æ¥ï¼Œå¹¶ä¸ºè¿æ¥åˆ›å»ºä¸¤ä¸ªåç¨‹ï¼Œä¸€ä¸ªè´Ÿè´£æ”¶åŒ…ï¼Œä¸€ä¸ªè´Ÿè´£å›åŒ…ã€‚ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸‹æ”¶åŒ…ã€è§£åŒ…ã€è¯·æ±‚å¤„ç†ã€ç»„åŒ…ã€å›åŒ…çš„å®Œæ•´è¿‡ç¨‹ã€‚\næ”¶åŒ…è§£åŒ… # go endpoint.tcpReader() åˆ›å»ºäº†ä¸€ä¸ªåç¨‹ä»è¿æ¥ä¸Šè¯»å–è¯·æ±‚æ•°æ®ã€‚ç”±äºtcpæ˜¯é¢å‘å­—èŠ‚æµçš„æ— è¾¹ç•Œåè®®ï¼Œå®¢æˆ·ç«¯å¯èƒ½ä¼šåŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚åŒ…è¿‡æ¥ï¼Œè¿™äº›åŒ…ä¸åŒ…ä¹‹é—´æ²¡æœ‰æ˜æ˜¾çš„æ•°æ®è¾¹ç•Œï¼Œå³æ‰€è°“çš„ç²˜åŒ…ã€‚tcpæœåŠ¡å¿…é¡»æ ¹æ®ä¸šåŠ¡åè®®ç¼–è§£ç è§„åˆ™å¤„ç†ç²˜åŒ…é—®é¢˜ï¼Œå¦åˆ™ä¼šå¯¼è‡´è¯·æ±‚è§£ç å¤±è´¥ï¼Œæ›´æ— æ³•æ­£å¸¸å¤„ç†è¯·æ±‚ã€‚\nä¸‹é¢çœ‹ä¸‹æ¡†æ¶æ˜¯å¦‚ä½•è¿›è¡Œæ”¶åŒ…è§£åŒ…çš„ï¼Œç½‘ç»œäº¤äº’è¿‡ç¨‹æ¶‰åŠåˆ°å¤§é‡çš„é”™è¯¯å¤„ç†ï¼ˆå…ˆä¸å±•å¼€ï¼‰ï¼Œè¿™é‡Œåªæˆªå–äº†æ”¶åŒ…ã€è§£åŒ…çš„éƒ¨åˆ†ä»£ç ï¼Œæ–¹ä¾¿å¤§å®¶ç†è§£ã€‚\nfunc (endpoint *EndPoint) tcpReader() { ... // å›å¿†ä¸‹ï¼Œä¸åŒçš„åè®®éƒ½æœ‰æ³¨å†Œå¯¹åº”çš„åè®®handlerï¼Œå¦‚nrpcåè®®å¯¹åº”NRPCHandler handler := svr.protoHandler // resizable bufferæ˜¯ç½‘ç»œæ”¶åŒ…è¿‡ç¨‹éå¸¸å€šé‡çš„ä¸€ç§å­˜å‚¨ç»“æ„ï¼Œå…¶å¤§å°å¯ä¼¸ç¼© // åŒæ—¶ä¸ºäº†å‡å°‘å†…å­˜åˆ†é…ã€å›æ”¶å‹åŠ›ï¼Œé‡‡ç”¨äº†å†…å­˜æ± çš„æ–¹å¼ï¼Œé¢„å…ˆåˆ†é…ç‰¹å®šå¤§å°çš„bufferç”¨äºæ”¶åŒ…ï¼Œ // å¦‚æœæ”¶åŒ…æ•°æ®å½“å‰bufferä¸å¤Ÿç”¨çš„æƒ…å†µä¸‹ï¼Œbufferå°±ä¼šåŠ¨æ€å¢é•¿ä»¥æ»¡è¶³å¯¹å­˜å‚¨ç©ºé—´çš„è¦æ±‚ buf := bufPool.Get() defer bufPool.Put(buf) OUT: for { select { case \u0026lt;-ctx.Done(): return default: // è¯»å–è¿æ¥ä¸Šåˆ°è¾¾çš„æ•°æ®ï¼Œè¿™é‡Œè®¾ç½®ä¸€ä¸ªè¯»è¶…æ—¶æ—¶é—´ // å¦‚æœè¿ç»­ä¸€æ®µæ—¶é—´(é»˜è®¤5min)è¿æ¥ä¸Šæ²¡æœ‰æ•°æ®åˆ°è¾¾ï¼Œåˆ™è®¤ä¸ºè¿æ¥ç©ºé—²ï¼ŒæœåŠ¡ç«¯ä¸ºèŠ‚çœèµ„æºå¯ä»¥ä¸»åŠ¨æ–­å¼€è¿æ¥ ex := conn.SetReadDeadline(time.Now().Add(time.Millisecond * time.Duration(timeout))) // è¯»å–è¿æ¥ä¸Šçš„è¯·æ±‚æ•°æ®ï¼Œä¸€æ¬¡è¯»å–å¯èƒ½é‡åˆ°å¦‚ä¸‹æƒ…å½¢ï¼š // - å®Œå…¨æ²¡æœ‰è¯»å–åˆ°æ•°æ®ï¼Œè¿™ç§ä¼šå‡ºç°è¯»å–è¶…æ—¶ï¼Œforå¾ªç¯continue OUTï¼Œç»§ç»­æ‰§è¡Œä¸‹æ¬¡è¯»å– // - è¯»å–åˆ°äº†ä¸è¶³ä¸€ä¸ªåŒ…çš„æ•°æ®ï¼Œè¿™ç§ä¼šè¿”å›io.ErrUnexpectedEOFï¼Œforå¾ªç¯continue OUTç»§ç»­æ”¶å–åŒ…çš„å‰©ä½™æ•°æ® // - åˆšå¥½è¯»å–åˆ°äº†ä¸€ä¸ªå®Œæ•´åŒ…çš„æ•°æ®ï¼Œè¿™ç§handler.Input(...)ä¼šè¿”å›ä¸€ä¸ªè¯·æ±‚sessionå¤„ç†ï¼Œ // - è¯»å–åˆ°äº†ä¸æ­¢ä¸€ä¸ªè¯·æ±‚åŒ…çš„æ•°æ®ï¼Œè¿™ç§ä¼šè¿”å›æœ€å‰é¢è¯·æ±‚å¯¹åº”çš„sessionï¼Œå‰©ä½™æ•°æ®å‚è€ƒä¸Šè¿°æƒ…å½¢ä¹‹ä¸€ç»§ç»­å¤„ç† _, ex = buf.ReadFromOnce(conn) // å¯èƒ½ä¸€æ¬¡è¯»å–äº†å¤šä¸ªè¯·æ±‚åŒ…ï¼Œéœ€è¦å¾ªç¯å¤„ç† for { buf.MarkReadIndex() // è¿™é‡Œä½¿ç”¨åè®®handlerå¯¹bufä¸­æ¥æ”¶çš„æ•°æ®è¿›è¡Œè§£ç æ“ä½œï¼Œå¦‚æœèƒ½æˆåŠŸè§£å‡ºä¸€ä¸ªè¯·æ±‚ä½“ï¼Œåˆ™è¿”å›å¯¹åº”çš„session nSession, ex := handler.Input(remoteAddr, buf) // åŒ…ä¸å®Œæ•´ä¸å…¨ç›´æ¥å¿½ç•¥ï¼Œç»§ç»­æ”¶åŒ… if io.ErrUnexpectedEOF == ex { buf.ResetReadIndex() continue OUT } // å¦‚æœåŒ…ä¸åˆæ³•ï¼Œå¦‚æ ¡éªŒå‘ç°ä¸¥é‡é”™è¯¯ï¼ˆéæ”¶åŒ…è¡¥å…¨ï¼‰å¦‚å¹»æ•°ã€é•¿åº¦æ ¡éªŒå¤±è´¥ï¼Œå…³é—­è¿æ¥ if ex != nil { return } } } ... }  è¯·æ±‚å¤„ç† # å‡å®šä»è¿æ¥ä¸Šè¯»å–çš„æ•°æ®ï¼Œç»åè®®handleræ ¡éªŒå¹¶è§£ç å‡ºäº†ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚åŒ…ï¼Œæ­¤æ—¶åè®®handlerä¼šåˆ›å»ºä¸€ä¸ªåŒ¹é…çš„sessionï¼ˆå¦‚nrpcåè®®å¯¹åº”NRPCSessionï¼‰ï¼Œè§ nSession,ex := handler.Input(remoteAddr, buf ã€‚åˆ›å»ºçš„sessionç”¨äºè·Ÿè¸ªä¸€ä¸ªè¯·æ±‚çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œsessionè®°å½•äº†å®¢æˆ·ç«¯è¯·æ±‚ã€æœåŠ¡ç«¯å“åº”ã€æœåŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„é”™è¯¯äº‹ä»¶ã€åˆ†å¸ƒå¼è·Ÿè¸ªã€æ—¥å¿—ä¿¡æ¯ç­‰ç­‰ã€‚\nå½“StreamServeræˆåŠŸä»è¿æ¥ä¸Šè¯»å–åˆ°ä¸€ä¸ªè¯·æ±‚å‡†å¤‡å¼€å§‹å¤„ç†ä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä¸‹å½“å‰æ˜¯å¦å·²ç»è¶…è¿‡äº†æœåŠ¡å…è®¸åŒæ—¶å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°ï¼Œå¦‚æœæœåŠ¡ç«¯å°†è§¦å‘è¿‡è½½ä¿æŠ¤åŠ¨ä½œï¼Œç›´æ¥ä¸¢å¼ƒè¯·æ±‚ã€‚\nfunc (endpoint *EndPoint) tcpReader() { ... OUT: for { select { ... //å¯èƒ½ä¸€æ¬¡æ”¶åˆ°å¤šä¸ªè¯·æ±‚åŒ…ï¼Œéœ€è¦å¾ªç¯å¤„ç† for { buf.MarkReadIndex() nSession, ex := handler.Input(remoteAddr, buf) ... if requestLimiter.TakeTicket() { svr.nserver.workpool.Submit(func() { //process defer func() { requestLimiter.ReleaseTicket() }() ex := svr.requestHandler(ctx, nSession) if ex != nil { svr.log.Error(\u0026quot;[tcp-%s] handler Process error:%s\u0026quot;, handler.GetProto(), ex.Error()) return } endpoint.sendChan \u0026lt;- nSession.GetResponseData() cost := time.Since(nSession.ProcessStartTime()).Nanoseconds() / 1000000 svr.nserver.monitorCost(nSession.GetCmdString(), cost) }) } else { //è¿‡è½½äº†ç›´æ¥å…³é—­è¿æ¥ log.Error(\u0026quot;[tcp-%s] [!!close conn!!] nserver reqs overload\u0026quot;, handler.GetProto()) return } } } } }  åœ¨è¯·æ±‚æ²¡æœ‰è§¦å‘æœåŠ¡è¿‡è½½ä¿æŠ¤çš„å‰æä¸‹ï¼Œå³ requestLimiter.TakeTicket() == true æ—¶ï¼Œæ­¤æ—¶ä¼šå°†è¯·æ±‚é€’äº¤ç»™åç¨‹æ± å¤„ç†ï¼Œsvr.nserver.workerpool.Submit(func(){â€¦})ã€‚åç¨‹æ± çš„å¤§è‡´å®ç°é€»è¾‘å‰é¢å·²æœ‰æåŠï¼Œå®ƒè´Ÿè´£æ‰§è¡Œæˆ‘ä»¬æäº¤çš„ä»»åŠ¡ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œworkerpool.Submit(f func(){â€¦})çš„å‚æ•°fã€‚æ³¨æ„åˆ°å‚æ•°fä¸­åŒ…å«äº†è¿™æ ·ä¸€æ®µä»£ç ï¼š\nfunc f() { defer func() { requestLimiter.ReleaseTicket() }() ex := svr.requestHandler(ctx, nSession) if ex != nil { return } endpoint.sendChan \u0026lt;- nSession.GetResponseData() cost := time.Since(nSession.ProcessStartTime()).Nanoseconds/1000000 svr.nserver.monitorCost(nSession.GetCmdString(), cost) }  æ”¶åŒ…å¤„ç†æµç¨‹ç»“æŸä¹‹åï¼Œéœ€è¦é‡Šæ”¾ticketï¼Œè§deferå‡½æ•°ã€‚å…³äºè¯·æ±‚çš„æ­£å¸¸å¤„ç†æµç¨‹çš„å…¥å£åˆ™æ˜¯ svr.requestHandler(ctx, nSession) ï¼Œè¿™é‡Œçš„svr.requestHandlerå…¶å®å°±æ˜¯ cmd_handler.go:process(â€¦) æ–¹æ³•ï¼Œåœ¨ neat_svr.go:NewNServer() æ–¹æ³•ä½“ä¸­ svr.requestHandler = NewRequestHandler()ï¼Œè€ŒNewRequestHandlerçš„è¿”å›å€¼åˆ™æ˜¯cmd_handler.go:process(â€¦) æ–¹æ³•ã€‚\ncmd_handler.go:process(ctx context.Context, session nserver.NSession)è¯·æ±‚å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼ŒåŒ…æ‹¬è¯·æ±‚å‘½ä»¤å­—ä¸å¤„ç†æ–¹æ³•çš„è·¯ç”±æ§åˆ¶ç­–ç•¥ã€è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰å¤„ç†å‡½æ•°ï¼Œæ–¹æ³•æ‰§è¡Œå®ŒæˆånSessionä¸­å°†åŒ…å«è¯¥è¯·æ±‚å¯¹åº”çš„å“åº”ç»“æœã€‚\nç»„åŒ…å›åŒ… # å›åŒ…åç¨‹ï¼Œæ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œå¾ªç¯ä»endpoint.sendChanä¸­å–å‡ºå“åº”åŒ…ï¼Œå¹¶å‘é€ç»™è¯·æ±‚æ–¹ã€‚\nfunc (endpoint *EndPoint) tcpWriter() { ... for { select { case \u0026lt;-ctx.Done(): return case dataRsp := \u0026lt;-endpoint.sendChan: conn.SetWriteDeadline(time.Now().Add(time.Millisecond * time.Duration(timeout))) dataLen, ex := conn.Write(dataRsp) } } }  StreamServerçš„å¤§è‡´æ‰§è¡Œé€»è¾‘å°±ä»‹ç»åˆ°æ­¤ï¼Œæ›´å¤šç»†èŠ‚ä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»ä¸‹ç›¸å…³ä»£ç ã€‚\nModuleï¼šPacketServer # PacketServerï¼Œæä¾›udpç½‘ç»œæœåŠ¡ï¼Œå‰æ–‡å·²ç»ä»‹ç»äº†PacketServeræ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªå¤§è‡´æƒ…å†µï¼ŒåŒ…æ‹¬å¯åŠ¨ç›‘å¬ã€ç«¯å£é‡ç”¨ã€è¿‡è½½ä¿æŠ¤ã€é€€å‡ºç­‰ï¼Œç°åœ¨æˆ‘ä»¬æŠŠè§†è§’é”å®šåœ¨â€œè¯·æ±‚å¤„ç†â€è¿™ä¸ªç¯èŠ‚ï¼Œè¿›ä¸€æ­¥äº†è§£å…¶å·¥ä½œè¿‡ç¨‹ã€‚\nREUSEPORT # UDPæ˜¯æ— è¿æ¥åè®®ï¼Œä¸å­˜åœ¨TCPæ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­çš„ç²˜åŒ…é—®é¢˜ï¼Œåœ¨æ”¶åŒ…ã€è§£åŒ…æ–¹é¢çš„å¤„ç†é€»è¾‘ä¼šç®€å•ä¸€ç‚¹ã€‚ä¸TCPä¸åŒçš„æ˜¯ï¼ŒtcpClientå’ŒtcpServerå»ºç«‹è¿æ¥çš„æ—¶å€™ï¼ŒtcpServerç«¯ä¼šåˆ›å»ºè¿æ¥å¥—æ¥å­—ï¼Œ æˆ‘ä»¬æ¯ä¸ªè¿æ¥å¥—æ¥å­—åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨çš„åç¨‹è¿›è¡Œæ”¶åŒ…ã€è§£åŒ…ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒUDPæœ¬èº«æ²¡æœ‰è¿æ¥çš„æ¦‚å¿µï¼ŒudpServeræ”¶åŒ…å°±æ˜¯é€šè¿‡ç›‘å¬å¥—æ¥å­—ï¼Œå¦‚æœæˆ‘ä»¬åªåˆ›å»ºä¸€ä¸ªåç¨‹æ¥è¿›è¡Œæ•°æ®åŒ…çš„æ”¶åŒ…ã€è§£åŒ…æ“ä½œï¼Œå’ŒtcpServerç›¸æ¯”ï¼Œåœ¨æ€§èƒ½ä¸Šå°±ä¼šæœ‰ç‚¹é€Šè‰²ã€‚\nä¸ºæ­¤ï¼ŒudpServerçš„æ”¶åŒ…ï¼Œè¿™é‡Œåˆ©ç”¨äº†reuseportç›¸å…³çš„èƒ½åŠ›ã€‚socketé€‰é¡¹SO_REUSEPORTå…è®¸å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹bindåˆ°ç›¸åŒçš„ç«¯å£ï¼Œç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾çš„æ—¶å€™ï¼Œå†…æ ¸ä¼šåœ¨è¿™äº›çº¿ç¨‹æˆ–è¿›ç¨‹ä¹‹é—´è¿›è¡Œåˆ†å‘ï¼Œå…·å¤‡ä¸€å®šçš„è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ã€‚ç›®å‰æ¡†æ¶æ˜¯åŸºäºå½“å‰CPUæ ¸æ•°Næ¥å†³å®šreuseportçš„æ¬¡æ•°ï¼Œæ¯reuseport.ListenPacket(â€¦)ä¸€æ¬¡ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªudpsocketï¼Œæ­¤æ—¶å†åˆ›å»ºä¸€ä¸ªåç¨‹ç”¨äºudpsocketçš„æ”¶åŒ…ã€è§£åŒ…æ“ä½œã€‚è¿™ç§æ–¹å¼å’Œå•çº¯ä»ä¸€ä¸ªç›‘å¬å¥—æ¥å­—ä¸Šæ”¶åŒ…ã€è§£åŒ…ç›¸æ¯”ï¼Œæé«˜äº†æ”¶åŒ…ã€è§£åŒ…çš„æ•ˆç‡ã€‚\nå…¶å®TCPã€UDPéƒ½å¯ä»¥åŸºäºreuseportè¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œæ¡†æ¶ç›®å‰å°†å…¶åº”ç”¨åœ¨UDPä¸Šã€‚\næ”¶åŒ…è§£åŒ… # ç›¸æ¯”è¾ƒTCPæ”¶åŒ…è€Œè¨€ï¼ŒUDPæ”¶åŒ…çš„é€»è¾‘å°±ç®€å•äº†å¾ˆå¤šã€‚\nåœ¨ç›‘å¬å¥—æ¥å­—ä¸Šå¾ªç¯æ”¶åŒ…ï¼Œä¸€æ—¦æ£€æµ‹åˆ°ctx.Doneä¸Šæ¸¸è¶…æ—¶ã€canceläº‹ä»¶ï¼Œåˆ™æ‰§è¡Œé€€å‡ºé€»è¾‘ï¼Œå…³é—­udpç›‘å¬å¥—æ¥å­—ã€‚åä¹‹ï¼Œåˆ™è¯»å–è¯·æ±‚ä½“ï¼Œæ³¨æ„ï¼Œè¿™é‡Œæœ‰ä¸ªå…è®¸åŒæ—¶å¤„ç†è¯·æ±‚æ•°é™åˆ¶ï¼Œå› æ­¤ä¼šå…ˆæ£€æŸ¥ requestLimiter.TakeTicket() æ˜¯å¦æˆåŠŸï¼Œå¦‚æœæˆåŠŸåˆ™æ‰§è¡Œå®é™…çš„æ”¶åŒ…ã€å¤„ç†é€»è¾‘ï¼Œåä¹‹æ¡†æ¶è®¤ä¸ºå½“å‰è¯·æ±‚é‡è¿‡è½½ï¼Œæ‰§è¡Œä¸¢å¼ƒé€»è¾‘ï¼Œè°ƒç”¨æ–¹ä¼šæ„ŸçŸ¥åˆ°è¶…æ—¶ã€‚\næœªè¿‡è½½çš„æƒ…å†µä¸‹ï¼Œæ¡†æ¶ä¼šä»å†…å­˜æ± é‡Œé¢åˆ†é…æˆ–è€…å¤ç”¨ä¸€ä¸ªä»¥å‰åˆ†é…çš„bufferï¼Œç”¨æ¥æ¥æ”¶UDPè¯·æ±‚ä½“ï¼Œå¹¶æ„å»ºä¸€ä¸ªåè®®åŒ¹é…çš„sessionï¼Œæ­¤æ—¶bufferå·²ç»å®Œæˆäº†å½“å‰æ¬¡çš„ä½¿å‘½ï¼Œå°†å…¶æ”¾å›å†…å­˜æ± å¤‡ç”¨ã€‚\nè¯¦ç»†çš„UDPæ”¶åŒ…å¤„ç†é€»è¾‘å¦‚ä¸‹æ‰€ç¤ºï¼š\nfunc (svr *PacketServer) udpRead(handler NHandler, udpConn net.PacketConn) { defer udpConn.Close() ctx, cancel := context.WithCancel(svr.ctx) ... requestLimiter := svr.nserver.reqLimiter for { select { case \u0026lt;-ctx.Done(): return default: if requestLimiter.TakeTicket() { data := udpRecvBufPool.Get().([]byte) n, remoteAddr, ex := udpConn.ReadFrom(data) ... r := bytes.NewBuffer(data[:n]) nSession, ex := handler.Input(remoteAddr, r) udpRecvBufPool.Put(data) ... } else { udpSvrReceiveExceedMax.Inc(1) //udp-svr æ”¶åŒ…è¿‡è½½ä¸¢å¼ƒ } } } }  è¯·æ±‚å¤„ç† # ä¸TCPçš„å¤„ç†æ–¹å¼ç±»ä¼¼ï¼Œå½“æ­£ç¡®æ”¶å–äº†ä¸€ä¸ªUDPè¯·æ±‚ï¼Œå¹¶ä¸ºä¹‹æ„å»ºå¥½åè®®åŒ¹é…çš„sessionä¹‹åï¼Œå°±ä¼šå°†å…¶ä¸€ä¸ªä»»åŠ¡å¤„ç†çš„é—­åŒ…å‡½æ•°ä½œä¸ºä¸€ä¸ªtaské€’äº¤ç»™workerpoolè¿›è¡Œå¤„ç†ï¼Œsvr.nserver.workpool.Submit(func() {â€¦})ï¼Œè¯¥é—­åŒ…å‡½æ•°æ‰§è¡Œå®Œæ¯•åä¹Ÿè¦æ³¨æ„é‡Šæ”¾requestLimiterï¼Œé—­åŒ…å‡½æ•°ä¸­çš„ svr.requestHandler(ctx, nSession) å°±æ˜¯ cmd_handler.go:process(ctx, session) æ–¹æ³•ï¼Œä¸TCPçš„å¤„ç†é€»è¾‘æ˜¯ä¸€è‡´çš„ã€‚ä¹‹æ‰€ä»¥åœ¨svr.requestHandlerå’Œcmd_handler.go:process(â€¦)ä¸­é—´å†åŠ ä¸€å±‚æŠ½è±¡ï¼Œæ˜¯è€ƒè™‘åˆ°ä¸šåŠ¡å¼€å‘è€…å¯èƒ½å¸Œæœ›å®šåˆ¶åŒ–requestHandlerçš„èƒ½åŠ›ï¼Œcmd_handler.go:process(\u0026hellip;)æ–¹æ³•åªæ˜¯æä¾›äº†ä¸€ä¸ªè¿˜ä¸é”™çš„é»˜è®¤å®ç°ã€‚\nsvr.requestHandler(ctx, nSession)æ‰§è¡Œå®Œæˆåï¼ŒnSessionä¸­å°†åŒ…å«è¯·æ±‚ä½“çš„å“åº”ç»“æœï¼Œå“åº”ç»“æœå°†å†™å…¥sendChanä¸­ï¼Œç”±è´Ÿè´£å›åŒ…çš„åç¨‹ go svr.udpWrite(...) æ‰§è¡Œå›åŒ…æ“ä½œã€‚\nfunc (svr *PacketServer) udpRead(handler NHandler, udpConn net.PacketConn) { ... sendChan := make(chan *packet, 1000) go svr.udpWrite(ctx, cancel, udpConn, sendChan) ... for { select { case \u0026lt;-ctx.Done(): ... default: if requestLimiter.TakeTicket() { nSession, ex := handler.Input(remoteAddr, r) svr.nserver.workpool.Submit(func() { defer func() { requestLimiter.ReleaseTicket() }() ex = svr.requestHandler(ctx, nSession) dataRsp := nSession.GetResponseData() ... sendChan \u0026lt;- \u0026amp;packet{dataRsp, remoteAddr} }) } else { ... } } } }  ç»„åŒ…å›åŒ… # å›åŒ…åç¨‹æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼Œå®ƒå¾ªç¯ä»sendChanä¸­æ”¶å–UDPè¯·æ±‚å¯¹åº”çš„å“åº”ï¼Œå¹¶æ£€æŸ¥å“åº”æ•°æ®æ˜¯å¦è¶…è¿‡64KBï¼Œè¶…è¿‡åˆ™ä¸¢å¼ƒï¼Œåä¹‹åˆ™å°†å“åº”è¿”å›ç»™è¯·æ±‚æ–¹ã€‚\nfunc (svr *PacketServer) udpWrite(ctx context.Context, cancel context.CancelFunc, conn net.PacketConn, sendChan chan *packet) { defer cancel() for { select { case \u0026lt;-ctx.Done(): return case p := \u0026lt;-sendChan: if len(p.data) \u0026gt; 65536 { udpRspExceed64k.Inc(1) //udpå›åŒ…è¶…è¿‡64k continue } conn.SetWriteDeadline(time.Now().Add(time.Millisecond * time.Duration(timeout))) datalen, ex := conn.WriteTo(p.data, p.addr) ... } } }  PacketServerçš„å¤§è‡´æ‰§è¡Œé€»è¾‘å°±ä»‹ç»åˆ°æ­¤ï¼Œæ›´å¤šç»†èŠ‚ä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»ä¸‹ç›¸å…³ä»£ç ã€‚\nModuleï¼šHttpServer # HttpServerä¸­æœ‰æ²¡æœ‰ä½¿ç”¨workeræ± ï¼ˆåç¨‹æ± ï¼‰è¿›è¡Œå¤„ç†å‘¢ï¼Ÿè¯¥ServerModuleæ˜¯å»ºç«‹åœ¨æ ‡å‡†åº“httpå®ç°ä¹‹ä¸Šçš„ï¼ŒGoNeatåªæ˜¯å°†è¯·æ±‚å¤„ç†çš„Handlerä¼ ç»™äº†æ ‡å‡†åº“httpå®ç°ï¼Œå¹¶æ²¡æœ‰å¯¹æ ‡å‡†åº“å…·ä½“å¦‚ä½•å¤„ç†è¯¥è¯·æ±‚åšä»€ä¹ˆå¹²é¢„ï¼Œæ¯”å¦‚æ˜¯å¦é‡‡ç”¨workeræ± ï¼ˆåç¨‹æ± ï¼‰ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œç­”æ¡ˆæ˜¯å¦ï¼Œå¯ä»¥æŸ¥çœ‹ä¸‹goæ ‡å‡†åº“æºç ã€‚\nä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªåç¨‹è¿›è¡Œå¤„ç† # æ ‡å‡†åº“å®ç°ä¸­ï¼Œå»ºç«‹ç›‘å¬å¥—æ¥å­—ä¹‹åï¼Œè°ƒç”¨ svr.Serve(listener) å¼€å§‹æ¥å—å…¥è¿æ¥è¯·æ±‚ï¼Œè¯¥æ–¹æ³•å¾ªç¯ Accept() å–å‡ºå»ºç«‹å¥½çš„tcpè¿æ¥å¹¶è¿›è¡Œå¤„ç†ã€‚æ ‡å‡†åº“å®ç°é’ˆå¯¹æ¯ä¸€ä¸ªè¿æ¥éƒ½å¯åŠ¨äº†ä¸€ä¸ªgoroutineè¿›è¡Œå¤„ç†ï¼Œè¿™ä¸æˆ‘ä»¬StreamServerçš„å®ç°æ–¹å¼æ˜¯ç±»ä¼¼çš„ï¼Œæ‰€ä¸åŒçš„æ˜¯å¤„ç†è¿æ¥ä¸Šå¹¶å‘è¯·æ±‚çš„æ–¹å¼ã€‚\nnet/http/server.go:\n// After Shutdown or Close, the returned error is ErrServerClosed. func (srv *Server) Serve(l net.Listener) error { ... for { rw, e := l.Accept() ... c := srv.newConn(rw) ... go c.serve(ctx) } }  åŒä¸€è¿æ¥ï¼Œä¸²è¡Œæ”¶åŒ…ã€å¤„ç†ã€å›åŒ… # æ³¨æ„ c.Serve(ctx context.Context) çš„æ³¨é‡Šéƒ¨åˆ†ï¼Œå…¶ä¸­æœ‰æåˆ°HTTP/1.x pipeliningçš„å¤„ç†å±€é™æ€§ï¼Œä¸€ä¸ªè¿æ¥ä¸Šå¯èƒ½ä¼šæœ‰å¤šä¸ªhttpè¯·æ±‚ï¼Œæ ‡å‡†åº“å½“å‰å®ç°é€»è¾‘æ˜¯è¯»å–ä¸€ä¸ªè¯·æ±‚ã€å¤„ç†ä¸€ä¸ªè¯·æ±‚ã€å‘é€ä¸€ä¸ªå“åº”ï¼Œç„¶åæ‰èƒ½ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªè¯·æ±‚å¹¶æ‰§è¡Œå¤„ç†ã€å“åº”ï¼Œæ‰€ä»¥å¤šä¸ªhttpè¯·æ±‚çš„å¤„ç†æ˜¯ä¸²è¡Œçš„ã€‚\næ³¨é‡Šä¸­ä¹Ÿæœ‰æåˆ°ï¼Œå¯ä»¥æ”¶å–å¤šä¸ªè¯·æ±‚ï¼Œå¹¶å‘å¤„ç†ï¼Œç„¶åæŒ‰ç…§pipelingè¯·æ±‚é¡ºåºæŒ‰åºè¿”å›ç»“æœï¼ˆhttpåè®®å¤´å¹¶æ²¡æœ‰ç±»ä¼¼æˆ‘ä»¬ä¸šåŠ¡åè®®seqnoçš„å­—æ®µï¼‰ï¼Œä½†æ˜¯å½“å‰æ²¡æœ‰è¿™ä¹ˆåšã€‚\nè¿æ¥ä¸Šè¯·æ±‚çš„è¯»å–ã€å¤„ç†ã€å›åŒ…éƒ½æ˜¯åœ¨åŒä¸€ä¸ªè¿æ¥ä¸­å®Œæˆå¤„ç†çš„ï¼Œå¹¶æ²¡æœ‰åƒæˆ‘ä»¬StreamServerã€PacketServeré‚£æ ·å°†è¯·æ±‚é€’äº¤ç»™workeræ± ï¼ˆåç¨‹æ± ï¼‰è¿›è¡Œå¤„ç†ã€‚\nnet/http/server.go:\n// Serve a new connection. func (c *conn) serve(ctx context.Context) { ... // HTTP/1.x from here on. c.r = \u0026amp;connReader{conn: c} for { // è¯»å–è¿æ¥ä¸Šçš„è¯·æ±‚ w, err := c.readRequest(ctx) // è¯»å–ä¸€ä¸ªè¯·æ±‚ï¼Œä¸²è¡Œå¤„ç†ä¸€ä¸ªè¯·æ±‚ // HTTP cannot have multiple simultaneous active requests.[*] // Until the server replies to this request, it can't read another, // so we might as well run the handler in this goroutine. // [*] Not strictly true: HTTP pipelining. We could let them all process // in parallel even if their responses need to be serialized. // But we're not going to implement HTTP pipelining because it // was never deployed in the wild and the answer is HTTP/2. serverHandler{c.server}.ServeHTTP(w, w.req) // è¯·æ±‚å¤„ç†ç»“æŸï¼ŒfinishRequest flushå“åº”æ•°æ® w.cancelCtx() w.finishRequest() ... } } func (sh serverHandler) ServeHTTP(rw ResponseWriter, req *Request) { handler := sh.srv.Handler if handler == nil { handler = DefaultServeMux } if req.RequestURI == \u0026quot;*\u0026quot; \u0026amp;\u0026amp; req.Method == \u0026quot;OPTIONS\u0026quot; { handler = globalOptionsHandler{} } handler.ServeHTTP(rw, req) }  sh.svr.Handlerå…¶å®å°±æ˜¯nserver.HttpServer.doService()æ–¹æ³•ã€‚\nnserver/neat_http.go:\n// doService process http request `req` func (svr *HttpServer) doService(w http.ResponseWriter, req *http.Request) { ... }  æ¥ç®¡æ ‡å‡†åº“Request URIè·¯ç”±è½¬å‘ # HttpServeråªæ˜¯åœ¨æ ‡å‡†åº“httpå®ç°åŸºç¡€ä¸Šè‡ªå®šä¹‰äº†è¯·æ±‚Handlerï¼Œæ‰€æœ‰Request URIåŒ¹é…http.prefixçš„è¯·æ±‚å°†é€’äº¤ç»™doService(â€¦)æ–¹æ³•å¤„ç†ï¼Œåœ¨doServiceæ–¹æ³•å†…å†è°ƒç”¨nserver.process()æ–¹æ³•è½¬å…¥GoNeatæ¡†æ¶å†…ç½®çš„å‘½ä»¤å­—è·¯ç”±é€»è¾‘ï¼Œä¸StreamServerã€PacketServerä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œçš„å‘½ä»¤å­—ä¸å†æ˜¯rpcæ–¹æ³•åã€å‘½ä»¤å­—æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯Request URIã€‚\nprocess()æ–¹æ³•å†…é€šè¿‡URIè·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°Execï¼Œå¹¶å®ŒæˆExecçš„è°ƒç”¨ï¼Œæ‹¿åˆ°å¤„ç†ç»“æœï¼Œprocess()æ–¹æ³•è¿”å›å¤„ç†ç»“æœï¼ŒdoServiceæ–¹æ³•è´Ÿè´£å°†å“åº”ç»“æœå†™å…¥è¿æ¥ä¸­ï¼Œc.Serve()ä¸­w.finishRequest()è´Ÿè´£å°†å“åº”æ•°æ®flushã€‚\nè‡³æ­¤ï¼Œä¸€æ¬¡httpè¯·æ±‚ã€å¤„ç†ã€å“åº”å°±ç»“æŸäº†ã€‚\nè€Œå…³äºHTTP/2ä¸­pipeliningçš„å¤„ç†æƒ…å†µï¼Œä¸ä¹‹ç±»ä¼¼ï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€è·Ÿè¿›æ ‡å‡†åº“å®ç°äº†è§£ç›¸å…³ç»†èŠ‚ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚\nHttpServerçš„å¤§è‡´æ‰§è¡Œé€»è¾‘å°±ä»‹ç»åˆ°æ­¤ï¼Œæ›´å¤šç»†èŠ‚ä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»ä¸‹ç›¸å…³ä»£ç ã€‚\nGoNeat - æœåŠ¡æ€ é€Ÿ # å‰æ–‡æè¿°äº†Serverå®ä¾‹åŠå„ä¸ªServerModuleå¯åŠ¨ã€è¯·æ±‚å¤„ç†çš„è¿‡ç¨‹ï¼Œå½“æœåŠ¡ç©ºé—²çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä¸ºè¿™ä¸ªé˜¶æ®µèµ·äº†ä¸€ä¸ªå¥½å¬çš„åå­—â€æ€ é€Ÿâ€ï¼Œâ€œæ€ é€Ÿâ€æ„å‘³ç€å¹¶ä¸æ˜¯åœæ­¢æœåŠ¡ï¼ŒæœåŠ¡ä¾æ—§åœ¨ç©ºè·‘ï¼Œé‚£ç©ºè·‘é˜¶æ®µä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ\nGoNeatæ¡†æ¶è¿˜æ˜¯ä¼šåšäº›äº‹æƒ…çš„ï¼Œæ¯”å¦‚æ¸…ç†ã€é‡Šæ”¾ä¸€äº›ä¸å¿…è¦çš„èµ„æºå ç”¨ï¼Œä¸ºåç»­è¯·æ±‚å¤„ç†å†æ¬¡åšå¥½å‡†å¤‡ã€‚\nsync.Pool # å‰æ–‡æåˆ°ï¼Œåœ¨ä¸¤æ¬¡gc cycleé—´éš”æœŸï¼Œsync.Poolå¯ä»¥æœ‰æ•ˆæå‡å†…å­˜åˆ†é…æ•ˆç‡ï¼Œsync.Pool.Get()ç”³è¯·æ–°å†…å­˜æˆ–è€…å¤ç”¨å·²åˆ†é…çš„å†…å­˜ï¼Œsync.Pool.Put(buf)é‡æ–°å°†sync.Pool.Get()è¿”å›çš„bufæ”¾å›æ± å­ä»¥å¤‡å¤ç”¨ï¼Œå¦‚æœgcæ¥ä¸´ï¼Œsync.Poolä¸­é—ç•™çš„æœªä½¿ç”¨çš„å†…å­˜åŒºå°†è¢«é‡Šæ”¾æ‰ã€‚\nfunc poolCleanup() { // This function is called with the world stopped, at the beginning of a garbage collection. // It must not allocate and probably should not call any runtime functions. // Defensively zero out everything, 2 reasons: // 1. To prevent false retention of whole Pools. // 2. If GC happens while a goroutine works with l.shared in Put/Get, // it will retain whole Pool. So next cycle memory consumption would be doubled. for i, p := range allPools { allPools[i] = nil for i := 0; i \u0026lt; int(p.localSize); i++ { l := indexLocal(p.local, i) l.private = nil for j := range l.shared { l.shared[j] = nil } l.shared = nil } p.local = nil p.localSize = 0 } allPools = []*Pool{} }  è™½ç„¶è¿™éƒ¨åˆ†ä¸æ˜¯æ¡†æ¶æœ¬èº«æ‰€æ–½åŠ çš„ï¼Œè¿™é‡Œåˆ—å‡ºæ¥ä¹Ÿæ˜¯ä¸ºäº†å¼ºè°ƒä¸‹ï¼Œå¸Œæœ›å¼€å‘è€…å¯¹è®¡ç®—èµ„æºä¿æŒè¶³å¤Ÿçš„æ•æ„Ÿåº¦ï¼Œå³ä¾¿æ˜¯åœ¨ä½¿ç”¨è‡ªå¸¦gcæœºåˆ¶çš„ç¼–ç¨‹è¯­è¨€æ¡ä»¶ä¸‹ï¼Œä¹Ÿåº”è¯¥ä¿æŒè¿™ç§æ•æ„Ÿåº¦ã€‚gcä¸æ˜¯ä¸‡èƒ½çš„ï¼Œå¯ä»¥æ‰¾å‡ºä¸€ç§caseå°†gcé˜ˆå€¼æ¨é«˜è¿›è€Œå°†å†…å­˜æ’‘çˆ†ã€‚\nworkerpool # ä¸€ä¸ªworkerpoolçš„å†…éƒ¨æ„é€ å¤§è‡´å¦‚ä¸‹ï¼Œæ¯ä¸ªworkerå…¶å®å°±æ˜¯ä¸€ä¸ªgoroutineï¼Œæ¯ä¸ªgoroutineéƒ½ç»‘å®šäº†ä¸€ä¸ªç‹¬å çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚å½“è¯·æ±‚é‡ä¸Šæ¶¨çš„æ—¶å€™ï¼Œåœ¨workerséƒ½å¤„äºbusyçŠ¶æ€çš„æƒ…å†µä¸‹ï¼Œworkerpoolä¼šæ£€æŸ¥workersæ•°é‡æ˜¯å¦å·²ç»è¶…è¿‡æŒ‡å®šçš„ä¸Šé™ï¼Œå¦‚æœæ²¡æœ‰å°±ç»§ç»­åˆ›å»ºworkerï¼Œå¦‚æ­¤workeræ•°é‡ä¼šè¶Šæ¥è¶Šå¤šâ€¦â€¦\nworkerpool |--worker1 ---- tasks|t1|t2|t3|..| |--worker2 ---- tasks|t4|t5|..| |--worker3 ---- tasks|| |--worker? ---- tasks|| |--workerN ---- tasks|tx|ty|tz|  å½“è¯·æ±‚é‡é™ä½ï¼Œç”šè‡³æ˜¯ç©ºé—²çš„æ—¶å€™å‘¢ï¼Ÿè¿™äº›workerï¼ˆgoroutineï¼‰éš¾é“è¿˜ä¼šå­˜åœ¨ï¼Ÿä¼¼ä¹æ²¡æœ‰å¿…è¦ã€‚workerpoolä¹Ÿä¼šå®šæ—¶æ£€æŸ¥workersç©ºé—²æ—¶é—´ï¼Œæ¯æ¬¡workerpool.Submit(task)çš„æ—¶å€™ï¼Œä¼šæ›´æ–°å®é™…æ¥æ”¶è¯¥taskçš„workerçš„æœ€è¿‘ä½¿ç”¨æ—¶é—´lastUsedTimeï¼Œå¦‚æœcurrentTime.Since(lastUsedTime) \u0026gt; maxIdleDurationï¼Œåˆ™è®¤ä¸ºworkerç©ºé—²ï¼Œç»ˆæ­¢workeræ‰§è¡Œå°±å¯ä»¥äº†ã€‚\nç©ºé—²è¿æ¥ # è¿æ¥ä¿æ´»ï¼Œæ˜¯ä¸€ä¸ªå®¹æ˜“å¼•èµ·äº‰è®ºçš„è¯é¢˜ï¼Œå½“å‰TCPåè®®æœ¬èº«æ”¯æŒè¿æ¥ä¿æ´»ï¼Œæ¯éš”ä¸€å®šæ—¶é—´å‘é€ä¸€ä¸ªTCPæ¢é’ˆï¼Œä½†æ˜¯ä¹Ÿæœ‰äººè®¤ä¸ºè¿™åŠ é‡äº†ç½‘ç»œæ‹¥å¡ï¼Œä¿æ´»åº”è¯¥åœ¨åº”ç”¨å±‚è‡ªå·±å®ç°ï¼Œå¦‚é€šè¿‡å¿ƒè·³æœºåˆ¶ã€‚\nå°½ç®¡å­˜åœ¨è¿™äº›äº‰è®®ï¼ŒTCPä¿æ´»æœºåˆ¶ä»ç„¶æ˜¯é¦–é€‰çš„ä¿æ´»æœºåˆ¶ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒä¸éœ€è¦å¼•å…¥é¢å¤–çš„å¼€å‘ã€ä¿æ´»ç­–ç•¥ã€‚è¿æ¥ä¿æ´»å¯ä»¥åœ¨å®¢æˆ·ç«¯åšï¼Œä¹Ÿå¯ä»¥åœ¨æœåŠ¡ç«¯åšï¼Œå…¶ä½œç”¨åªæ˜¯ä¸ºäº†æ¢æµ‹è¿æ¥æ˜¯å¦è¿˜å¥åº·åœ°ä¿æŒç€ã€‚æ¡†æ¶ä¸­åœ¨æœåŠ¡ç«¯è¿›è¡Œä¿æ´»ï¼Œå¯¹äºçŸ­è¿æ¥çš„æƒ…å†µï¼Œç»§ç»­ä¿æ´»æ˜¾å¾—æœ‰ç‚¹å¤šä½™ï¼Œé‚£ä¸ºä»€ä¹ˆæ¡†æ¶å®ç°æ—¶é€‰æ‹©äº†åœ¨æœåŠ¡ç«¯è¿›è¡Œä¿æ´»å‘¢ï¼Ÿ\nå› ä¸ºæ¡†æ¶ä¸­å¯¹TCPå®Œå…¨æ˜¯ä»¥åŒå·¥çš„æ–¹å¼è¿›è¡Œå¤„ç†çš„ï¼Œå¦‚åœ¨ä¸€ä¸ªè¿æ¥ä¸Šå¾ªç¯æ”¶åŒ…ã€å¤„ç†ã€å›åŒ…ï¼Œå¹¶æ²¡æœ‰åšå®¢æˆ·ç«¯æ˜¯TCPçŸ­è¿æ¥çš„å‡è®¾ï¼Œå®¢æˆ·ç«¯ä¸ç®¡æ˜¯TCPçŸ­è¿æ¥ã€é•¿è¿æ¥ï¼ŒStreamServeréƒ½æ˜¯ä¸€æ ·çš„å¤„ç†é€»è¾‘ï¼Œä¹Ÿå¯ä»¥ç†è§£æˆStreamServeré¼“åŠ±å®¢æˆ·ç«¯ä½¿ç”¨TCPé•¿è¿æ¥ï¼Œæ‰€ä»¥åœ¨æœåŠ¡ç«¯å‘èµ·ä¿æ´»æœºåˆ¶ä¹Ÿæ˜¯å¾ˆè‡ªç„¶çš„é€‰æ‹©ã€‚\nä¸€ä¸ªè¿›ç¨‹å…è®¸æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdæ•°é‡ï¼‰æ˜¯æœ‰é™çš„ï¼ŒLinuxä¸‹å¯ä»¥é€šè¿‡ulimit -sè¿›è¡Œè®¾ç½®ã€‚å…è®¸æ‰“å¼€çš„fdæ•°é‡æœ‰é™ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Ÿåœ¨Linuxä¸‹ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œå‡ ä¹æ‰€æœ‰çš„èµ„æºéƒ½è¢«æŠ½è±¡æˆäº†æ–‡ä»¶ï¼Œè€Œæ¯ä¸ªæ–‡ä»¶â€å¥æŸ„â€œåŸºæœ¬ä¸Šéƒ½å¯¹åº”ç€ä¸€ä¸ªfdã€‚fdæ•°é‡æœ‰é™ï¼Œæ„å‘³ç€å…è®¸åˆ›å»ºçš„socketæ•°é‡ä¹Ÿæ˜¯æœ‰é™çš„ã€‚\nè€Œulimit -så¯èƒ½ç»™åˆ°äº†ä¸€ä¸ªå¾ˆé«˜çš„å€¼ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸å°å¿ƒï¼Œä¹Ÿæå®¹æ˜“æ³„éœ²fdã€‚ç¬”è€…å°±æ›¾ç»è§è¿‡WebæœåŠ¡ä¸­clientå®ä¾‹åŒ–æ²¡æœ‰ä½¿ç”¨å•ä¾‹ã€å¹¶ä¸”clienté”€æ¯æ—¶æ²¡æœ‰close(fd)è€Œå¯¼è‡´fdæ³„éœ²ï¼Œè¿›è€Œè¿…é€Ÿæ‹–å®äº†ç°ç½‘å‡ åå°WebæœåŠ¡å™¨çš„æ¡ˆä¾‹ã€‚\nè€ƒè™‘åˆ°è¿™ç§ç§å› ç´ ï¼Œæ¡†æ¶è¿˜æ˜¯éœ€è¦åšäº›äº‹æƒ…ï¼Œå°†è¿™äº›æœåŠ¡ç«¯ç©ºé—²çš„TCPè¿æ¥åŠæ—¶é”€æ¯ï¼Œå¹¶ä¸”ä¸ºäº†é€‚åº”ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œå…è®¸è‡ªå®šä¹‰è¿æ¥ç©ºé—²æ—¶é—´ï¼ˆè®°ä¸ºTï¼‰ã€‚å½“è¿æ¥ä¸Šè¿ç»­æ—¶é—´Tæ²¡æœ‰è¯·æ±‚åˆ°è¾¾ï¼ŒæœåŠ¡ç«¯è®¤ä¸ºè¿æ¥ç©ºé—²ï¼Œå¹¶å…³é—­è¿æ¥é‡Šæ”¾ç³»ç»Ÿèµ„æºã€‚\nserverç«¯å…³é—­ç©ºé—²è¿æ¥ï¼Œå¯¹clientç«¯æ¥è¯´ï¼Œclientæ”¶åˆ°TCP FINåŒ…ï¼Œclientè®¤ä¸ºserverç«¯åªæ˜¯å…³é—­äº†è¿æ¥çš„å†™ç«¯ã€è¯»ç«¯å¹¶æœªå…³é—­ï¼Œæ‰€ä»¥ä¸‹æ¬¡clientç»§ç»­å‘serverå‘é€æ•°æ®æ—¶ï¼Œç½‘ç»œioä¹Ÿå·²ç»è®¾ç½®ä¸ºéé˜»å¡ï¼Œæ­¤æ—¶conn.Write(â€¦)è¿”å›æˆåŠŸï¼Œä½†å…¶å®ç¨åè¯·æ±‚åˆ°è¾¾serverç«¯ï¼Œserverç«¯è¯·æ±‚çš„ç«¯å£æ—©å°±å·²ç»æ²¡æœ‰è¿›ç¨‹ä½¿ç”¨äº†ï¼Œå› æ­¤ä¼šè¿”å›TCP RSTï¼Œæ­¤æ—¶clientç«¯æ„è¯†åˆ°å¯¹ç«¯å·²ç»å…³é—­è¿æ¥äº†ï¼Œä½†æ˜¯è¿™ä¸ªé”™è¯¯clientå¦‚ä½•èƒ½æ„ŸçŸ¥åˆ°ï¼Ÿåªèƒ½é€šè¿‡é¢å¤–çš„conn.Read(â€¦)æ¥æ„ŸçŸ¥ï¼\nè¿™é‡Œä¼šå½±å“åˆ°å®¢æˆ·ç«¯TCPè¿æ¥æ± çš„å®ç°ï¼Œè¦æƒ³å®ç°ä¸€ä¸ªå¯é çš„TCPè¿æ¥æ± ï¼Œå¿…é¡»æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜çš„å­˜åœ¨ï¼Œæˆ‘ä»¬ä¼šåœ¨åç»­clientç›¸å…³å®ç°ä¸­ç»§ç»­æè¿°ã€‚\nå…¶ä»–é—®é¢˜ # å…¶ä»–çš„ä¸€äº›ä¸å¯æˆ–ç¼ºï¼Œä½†æ˜¯å¯èƒ½æ²¡é‚£ä¹ˆé‡è¦çš„ç‚¹ï¼Œè¿™é‡Œå…ˆæš‚æ—¶ä¸åˆ—å‡ºã€‚\nGoNeat - ç›‘æ§ä¸ŠæŠ¥ #   Metric\næ¡†æ¶æ”¯æŒmetricï¼Œå°†æ¡†æ¶å±æ€§ç›‘æ§èƒ½åŠ›ä¸å…¬å¸ç»„ä»¶è¿›è¡Œäº†è§£è€¦ï¼Œmetricå½“å‰æ”¯æŒ4ä¸ªç»´åº¦ï¼šcounterã€gaugeã€timerã€histogramï¼Œä¹Ÿæä¾›äº†é€‚é…monitorçš„metric reporterã€‚æ¡†æ¶ä¸ŠæŠ¥äº†è‡ªèº«çš„ä¸€äº›å…³é”®æŒ‡æ ‡ï¼Œæ–¹ä¾¿ä¸šåŠ¡å¼€å‘äººå‘˜åŠæ—¶æ ¹æ®æ¡†æ¶ç›‘æ§ï¼Œæ„ŸçŸ¥ä¸šåŠ¡ä¸­æ½œä¼çš„é—®é¢˜ã€‚\n  Tracing\næ¡†æ¶æ”¯æŒåˆ†å¸ƒå¼è·Ÿè¸ªï¼Œå¯¹rpcè°ƒç”¨è‡ªåŠ¨æ¤å…¥traceæ•°æ®ï¼Œä¸šåŠ¡å¼€å‘æ— æ„ŸçŸ¥ï¼Œåªéœ€éƒ¨ç½²æˆ–è€…æ¥å…¥ç›¸å…³çš„tracing backendï¼ˆå¦‚zipkinã€jaegeræˆ–è€…å¤©æœºé˜å³å¯ï¼‰ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å…¨é“¾è·¯è¿›è¡Œè·Ÿè¸ªã€é”™è¯¯å›æº¯ã€‚\n  Monitor\nä½œä¸ºå…¬å¸å¸¸ç”¨ç›‘æ§ç»„ä»¶ï¼Œgo-neat/tencent/attræä¾›äº†monitorç›¸å…³çš„å°è£…ï¼Œä¸šåŠ¡å¼€å‘äººå‘˜å¯ä»¥æ–¹ä¾¿åœ°æ‹¿æ¥ä½¿ç”¨ï¼Œå¹¶æä¾›äº†æ‰¹é‡ç”³è¯·monitorçš„å·¥å…·ï¼Œç®€è½»ä¸šåŠ¡å¼€å‘äººå‘˜ç›‘æ§æ‰“ç‚¹çš„è´Ÿæ‹…ã€‚\n  Habo\nå“ˆå‹ƒä½œä¸ºå…¬å¸çº§ä¸‹ä¸€ä»£ç›‘æ§å¹³å°ï¼Œæ¡†æ¶å±‚ä¹Ÿè¿›è¡Œäº†å°è¯•ï¼Œç›®å‰å¯¹æ¨¡è°ƒä¿¡æ¯è¿›è¡Œäº†ä¸ŠæŠ¥ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹æœåŠ¡æˆåŠŸç‡ã€è€—æ—¶åˆ†å¸ƒè¿›è¡Œç»Ÿè®¡ï¼Œå¯ä»¥ä½œä¸ºæœåŠ¡è¿è¥è´¨é‡çš„ä¸€ä¸ªå‚è€ƒæŒ‡æ ‡ã€‚\n  GoNeat - å¹³æ»‘é€€å‡º #   ç›‘å¬ä¿¡å·ï¼Œå¹³æ»‘é€€å‡º\næ¡†æ¶æ”¯æŒç›‘å¬æŒ‡å®šä¿¡å·æ‰§è¡Œå¹³æ»‘é€€å‡ºé€»è¾‘ï¼Œç›®å‰æ¥çœ‹æ¡†æ¶é€€å‡ºæ—¶ï¼Œä¼šå®Œæˆlogåˆ·ç›˜ã€ç­‰å¾…æŒ‡å®šæ—¶é•¿åå†é€€å‡ºï¼Œç­‰å¾…é€€å‡ºæœŸé—´serverç«¯å¯ä»¥å°½åŠ›å¤„ç†å…¥é˜Ÿè¯·æ±‚ï¼Œä½†æ˜¯ä¸ä¿è¯100%å¤„ç†å®Œã€‚\n  context.Contextè¶…æ—¶\næ¡†æ¶è®¾è®¡æ—¶å¯¹context.Contextçš„ä½¿ç”¨åœºæ™¯éå¸¸æ˜ç¡®ï¼Œå°†å…¶ç”¨äºå…¨å±€è¶…æ—¶æ§åˆ¶ï¼Œè€Œä¸ç”¨æ¥ä¼ å€¼ã€‚ç»™åˆ°ä¸€ä¸ªcontextï¼Œæƒ³äº†è§£å®ƒé‡Œé¢æºå¸¦äº†ä»€ä¹ˆæ•°æ®ï¼Œé™¤äº†æ˜ç¡®çŸ¥é“keyæ²¡æœ‰ä»€ä¹ˆæ›´åŠ ç›´è§‚çš„æ–¹æ³•ï¼Œè€Œkeyå¯èƒ½åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ã€åŒä¸€ä¸ªæ–‡ä»¶çš„ä¸åŒåœ°æ–¹ï¼Œè¿™éå¸¸ä¸ç›´è§‚ã€ä¸å‹å¥½ã€‚æˆ‘ä»¬ä¸å¸Œæœ›ä¸šåŠ¡å¼€å‘è€…æ¥çŒœæµ‹ï¼Œæˆ‘ä»¬ä¼šåœ¨contexté‡Œé¢å¡å…¥ä»€ä¹ˆç‰¹æ®Šçš„ä¸œè¥¿ï¼Œæˆ‘ä»¬ä»€ä¹ˆéƒ½ä¸å¡ï¼Œä»…ä»…æ˜¯å…¨å±€è¶…æ—¶æ§åˆ¶ã€‚\nnserver.ctxæ˜¯root contextï¼Œæ¡†æ¶ä¸­ServerModuleã€Endpointã€æ”¶å‘åŒ…å®ç°ã€ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­ç­‰ç­‰å‡ºç°çš„contextï¼Œé»˜è®¤éƒ½æ˜¯æ´¾ç”Ÿè‡ªnserver.ctxï¼Œè¿™æ„å‘³ç€å½“æ¡†æ¶æ”¶åˆ°ä¿¡å·æ‰§è¡Œé€€å‡ºé€»è¾‘æ—¶ï¼Œå–æ¶ˆnserver.ctxå°†å–æ¶ˆæ‰€æœ‰çš„child contextï¼Œæˆ‘ä»¬åœ¨ServerModuleã€Endpointã€æ”¶å‘åŒ…å®ç°ã€ä¸šåŠ¡é€»è¾‘å¤„ç†ä»£ç ä¸­ç­‰ç­‰ï¼Œéƒ½æ¤å…¥äº†æ£€æµ‹context.Done()çš„åˆ¤æ–­é€»è¾‘ï¼Œä»¥è®©ç³»ç»Ÿä¸­å„ä¸ªé›¶éƒ¨ä»¶åŠæ—¶ä½œå‡ºæ­¥è°ƒä¸€è‡´çš„åŠ¨ä½œï¼Œå¦‚loggerç»„ä»¶å¿«é€Ÿåˆ·ç›˜åé€€å‡ºã€StreamServerå…³é—­ç›‘å¬å¥—æ¥å­—å°½æœ€å¤§åŠªåŠ›å¤„ç†å·²å…¥é˜Ÿè¯·æ±‚ç­‰ã€‚\n  è¿˜æ²¡æœ‰é‚£ä¹ˆå¹³æ»‘ï¼Ÿ\nå¯èƒ½çœ‹åˆ°è¿™é‡Œï¼Œä¸å°‘å¼€å‘è€…è®¤ä¸ºï¼Œä¼¼ä¹è¿˜æ²¡æœ‰é‚£ä¹ˆå¹³æ»‘ï¼Œå…³äºå¹³æ»‘é€€å‡ºçš„è®¾è®¡å¯ä»¥åœ¨go-neat/core issuesä¸­è¿›è¡Œæ›´è¯¦ç»†åœ°è®¨è®ºã€‚\n  GoNeat - More # å…¶å®è¿˜æœ‰å¾ˆå¤šåœ°æ–¹æ²¡æœ‰ä»‹ç»ï¼Œå¦‚ClientAdapterå®ç°ã€é«˜å¹¶å‘å†™æ“ä½œMapå®ç°ã€Json Map WeakDecodeã€é™é¢‘æªæ–½ã€å®¢æˆ·ç«¯è¿æ¥æ± æ›´å¯é åœ°è¿æ¥æ´»æ€§æ£€æµ‹ã€å¯é çš„åº”ç”¨å±‚åè®®è®¾è®¡ç­‰ï¼Œè¿™é‡Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å…ˆæŸ¥é˜…ä¸‹ç›¸å…³ä»£ç ï¼Œç¨åæˆ‘ä»¬ä¼šç»§ç»­è¡¥å……ã€‚\nå†™åœ¨æœ€åï¼ŒGoNeatæ¡†æ¶ä¸€ç›´å¤„äºæ¯”è¾ƒæ´»è·ƒçš„å¼€å‘çŠ¶æ€ï¼Œæ¡†æ¶ä»£ç ä¸€ç›´åœ¨å°å¹…åº¦ã€ä¸é—´æ–­åœ°ä¼˜åŒ–ä¸­ï¼Œæ–‡æ¡£å’Œæ¡†æ¶æ¯”è¾ƒèµ·æ¥ï¼Œå¯èƒ½ä¼šç•¥æ˜¾æ»åï¼Œå¦‚æœæ‚¨å‘ç°æ–‡æ¡£æœ‰é—®é¢˜ï¼Œä¹Ÿè¯·åé¦ˆç»™æˆ‘ä»¬ã€‚\næ„Ÿè°¢å¦‚ä¸‹åŒå­¦ä¸ºæ¡†æ¶å¼€å‘ä½œå‡ºçš„è´¡çŒ®ï¼šè„±æ•å¤„ç† :)\n GoNeat - End of Life :( # 2020å¹´7æœˆä»½å¼€å§‹ï¼ŒPCGå¼€å§‹ç»„ç»‡å¤§è§„æ¨¡çš„æŠ€æœ¯æ²»ç†ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº‹å®ä¸Šçš„å…¬å¸çº§çš„å¾®æœåŠ¡æ¡†æ¶tRPCçš„å»ºè®¾ï¼Œè‡ªæ­¤ä»¥åæˆ‘ä¾¿å°†äººåŠ›æŠ•å…¥åˆ°äº†tRPCçš„å»ºè®¾ã€è´¡çŒ®ä¸­ï¼ŒGoNeatè‡ªè¿™ä¸ªæ—¶é—´ç‚¹å¼€å§‹å¼€å§‹åœæ­¢æ–°ç‰¹æ€§æ›´æ–°ã€‚\nGoNeatæ¡†æ¶æ˜¯ä¸€æ¬¾åœ¨2018.3æœˆå¼€å§‹é™†é™†ç»­ç»­ç¼–å†™çš„æ¡†æ¶ï¼Œåˆ°2018.8æœˆä»½å¼€å§‹å°è§„æ¨¡æµ‹è¯•ï¼Œä¹‹åçš„ä¸¤å¹´é‡Œæˆä¸ºäº†å›¢é˜Ÿçš„æ ¸å¿ƒå¼€å‘æ¡†æ¶ï¼Œæ”¯æ’‘äº†å›¢é˜Ÿå‡ åƒä¸ªå¾®æœåŠ¡ï¼Œç›´åˆ°PCGå»ºè®¾tRPCæ¡†æ¶åï¼ŒGoNeatæ¡†æ¶ä¹Ÿæœ€ç»ˆèµ°å‘äº†åœæ­¢åç»­å¼€å‘çš„å‘½è¿ã€‚\nè™½ç„¶æœªæ¥éš¾å…è¢«é—å¿˜ã€åºŸå¼ƒï¼Œä½†æ˜¯å®ƒè¿‡å»ä¹Ÿæ›¾ç»â€ç¹è£â€œè¿‡ï¼Œå‡ åäººçš„æ´»è·ƒå¼€å‘ç»„ç»‡ï¼Œå‡ ç™¾ä¸ªçš„issueæ²Ÿé€šè®¨è®ºã€å‡ åƒçš„commitã€å¾ˆå¤šæ¬¡æŠ€æœ¯åˆ†äº«ï¼Œæ²‰æ·€ä¸‹æ¥çš„ä¸œè¥¿ä¹Ÿå¯ä»¥å¯¹æ–°åŒå­¦æˆé•¿èµ·åˆ°äº›æŒ‡å¼•å¸®åŠ©ä½œç”¨ï¼Œå¯¹åç»­æ¡†æ¶è®¾è®¡å¼€å‘è€…ä¹Ÿå…·æœ‰ä¸€å®šçš„å‚è€ƒä»·å€¼ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹æ¡†æ¶è®¾è®¡å®ç°æ„Ÿå…´è¶£çš„åŒå­¦æœ‰å¸®åŠ©ã€‚\n"}),a.add({id:312,href:"/tags/microservice/",title:"microservice",description:"",content:""}),a.add({id:313,href:"/tags/rpc/",title:"rpc",description:"",content:""}),a.add({id:314,href:"/tags/trpc/",title:"trpc",description:"",content:""}),a.add({id:315,href:"/tags/rm/",title:"rm",description:"",content:""}),a.add({id:316,href:"/tags/rm-safe/",title:"rm-safe",description:"",content:""}),a.add({id:317,href:"/blog/2019-10-18-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%AE%89%E5%85%A8%E7%9A%84%E5%88%A0%E9%99%A4%E5%91%BD%E4%BB%A4rm/",title:"å¦‚ä½•å®ç°ä¸€ä¸ªæ›´å®‰å…¨çš„åˆ é™¤å‘½ä»¤rm",description:"img { width: 680px; padding-bottom: 1rem; }  èƒŒæ™¯ # å¤§å®¶æœ‰æ²¡æœ‰å› ä¸ºä¸€æ—¶å¤§æ„ï¼Œé”™è¯¯åœ°æ‰§è¡Œäº†rm -rfè€Œå¯¼è‡´é‡è¦æ–‡ä»¶è¢«åˆ é™¤çš„æƒ…å†µï¼Ÿä¸€å®šæœ‰é‚£ä¹ˆä¸€æ¬¡ä¸¤æ¬¡çš„å§ã€‚å‰å‡ å¤©ï¼Œæˆ‘åˆçŠ¯äº†è¿™ä¸€æ¬¡è¿™æ ·çš„é”™è¯¯ã€‚æœ¬æ¥æ˜¯è¦åˆ é™¤å½“å‰ç›®å½•ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œäºæ˜¯æ‰§è¡Œ rm -rf .ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰è¾“å…¥å®Œï¼Œå› ä¸ºæˆ‘è°ƒæ•´äº†KeyRepeatè®¾ç½®é¡¹çš„åŸå› å§ï¼ŒæŒ‰é”®å»¶è¿Ÿå¾ˆçŸ­ï¼Œç»“æœå‘½ä»¤å˜æˆäº† rm -rf ..ï¼Œè¿™ä¸ªæ—¶å€™..å·²ç»æŒ‡å‘äº†HOMEç›®å½•â€¦â€¦é¢ï¼Œæ²¡å…³æ³¨å³æ‰‹ï¼Œå·¦æ‰‹è¿˜æ²¡æœ‰tabå€™é€‰ï¼Œå³æ‰‹å·²ç»é”®å…¥äº†å›è½¦ï¼Œggï¼Œçœ¼ççåœ°çœ‹ç€å¤§é‡æ–‡ä»¶è¢«åˆ é™¤ï¼Œctrl+cå·²ç»å¤ªæ™šäº† :( ã€‚\nå¤šäºmacOSé»˜è®¤å¯¹Desktopã€Documentç­‰ç›®å½•ä¸‹çš„æ–‡ä»¶åšäº†è‡ªåŠ¨åœ°å¤‡ä»½ï¼Œä¸ç„¶å°±çœŸçš„è¦è‹¦äº†ï¼Œè™½ç„¶å¯¹é‡è¦æ–‡ä»¶ã€æ•°æ®ä¹Ÿæœ‰åšè¿‡å¤‡ä»½ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½åšåˆ°æŒ‰æœˆã€æŒ‰å¤©çš„å¤‡ä»½ï¼Œå“ªæ€•æ˜¯æœ€è¿‘å‡ ä¸ªæœˆçš„æ•°æ®ã€é…ç½®çš„ä¸¢å¤±ï¼Œå¯¹æˆ‘æ¥è¯´ä¹Ÿæ˜¯æŒºä¼¤çš„ã€‚æœä¸å…¶ç„¶ï¼Œåç»­å‡ å¤©é™†é™†ç»­ç»­å‘ç°ä¸¢å¤±äº†å„ç§å„æ ·çš„é…ç½®ï¼ŒIDEçš„ã€bashçš„ã€gitçš„ã€petçš„â€¦â€¦å„ç§å„æ ·çš„ï¼\nä¸å¹¸ä¸­çš„ä¸‡å¹¸ï¼Œä¸€äº›è‡ªå·±è®¤ä¸ºçœŸçš„å¾ˆé‡è¦çš„æ•°æ®ï¼Œä¸€èˆ¬åœ¨Documentä¸­äº¤ç»™icloudåšäº†å¤‡ä»½ï¼Œè¿™äº›æ•°æ®å€’æ˜¯å¯ä»¥æ¢å¤ï¼Œè™½ç„¶æ…¢äº†ç‚¹ï¼Œä½†æ˜¯èƒ½æ¢å¤æ€»è¿˜æ˜¯å¥½çš„ï¼æ„Ÿè°¢icloudæä¾›çš„äº‘å­˜å‚¨æœåŠ¡ï¼\nå¦‚ä½•é¿å…è¯¯åˆ é™¤æ–‡ä»¶ # ç»æ­¤ä¸€å½¹ä¹‹åï¼Œæˆ‘è¿˜æ˜¯æ€è€ƒäº†ä¸€äº›å¦‚ä½•è§„é¿çš„é—®é¢˜ï¼Œæˆ‘æœ‰å¤šå¹´çš„Linuxä½¿ç”¨ç»éªŒï¼Œç«Ÿç„¶ä¹Ÿä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ï¼Œæˆ‘å°†å…¶å½’å› äºï¼šè¿‡å¤±é—®é¢˜ï¼Œè™½ç„¶åƒæˆ‘è¿™æ ·çš„æœ‰ç»éªŒçš„å¼€å‘è€…æå°‘ä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šå¶å°”å‘ç”Ÿï¼å¾ˆå¤šå¼€å‘è€…éƒ½æå‡ºäº†è‡ªå·±çš„ä¸€äº›æƒ³æ³•ï¼Œå¦‚ä½•è§„é¿rmé€ æˆçš„æ–‡ä»¶è¯¯åˆ é—®é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è€ƒè™‘å¦‚ä½•æ¢å¤çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ç§äººç¬”è®°æœ¬å•ç¡¬ç›˜å•åˆ†åŒºçš„è¯ï¼Œæ¢å¤çš„å›°éš¾åº¦æ˜¯æ¯”è¾ƒé«˜çš„ã€‚\n  åˆ é™¤åªç”¨ç³»ç»Ÿguiåˆ é™¤ï¼Œå¦‚macOSã€windowsã€kdeä¸‹åˆ é™¤æ–‡ä»¶åˆ°åƒåœ¾ç®±ï¼Œè¯¯åˆ çš„è¯è¿˜æ˜¯å¯ä»¥ä»åƒåœ¾ç®±æ¢å¤çš„ï¼›\nä¸é€‚ç”¨ï¼šæ‰§è¡Œåˆ é™¤åŠ¨ä½œæ˜¯å¾ˆå¸¸è§çš„ï¼Œä½œä¸ºä¸€åå¼€å‘è€…ï¼Œæˆ‘ä¸å¤§å¯èƒ½ä½¿ç”¨guiæ¥é¢‘ç¹åˆ‡æ¢ç›®å½•åæ‰åˆ é™¤æ–‡ä»¶ã€‚\n  è‡ªå®šä¹‰bashä¸­çš„aliasï¼Œå¦‚alias rm=\u0026ldquo;function rm() {\u0026hellip;.}\u0026quot;ï¼Œè¯¥å‡½æ•°å†…éƒ¨åšä¸€äº›æ£€æŸ¥ï¼Œä»¥å†³å®šæ˜¯å¦åˆ é™¤æ–‡ä»¶ï¼›\nä¸é€‚ç”¨ï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªè§£å†³é—®é¢˜çš„æ€è·¯ï¼Œä½†æ˜¯èƒ½å¦ä¸åŸç”Ÿçš„/bin/rmå‘½ä»¤å®Œå…¨å…¼å®¹æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè€Œä¸”æ£€æŸ¥é€»è¾‘å¯èƒ½è¦é¢‘ç¹æ”¹åŠ¨æ‰èƒ½èƒœä»»å„ç§é¿å…è¯¯åˆ çš„åœºæ™¯ï¼Œä½¿ç”¨èµ·æ¥ä¸æ˜¯é‚£ä¹ˆçµæ´»ã€‚\n  ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„åˆ é™¤å·¥å…·ï¼Œå¦‚githubä¸Šçš„ä¸€äº›ç±»ä¼¼rm-safeçš„å·¥å…·ï¼Œä»£æ›¿åŸç”Ÿçš„/bin/rmå‘½ä»¤ï¼›\nä¸é€‚ç”¨ï¼šè¿™äº›å·¥å…·ä¸èƒ½å®Œå…¨ä¸/bin/rmå…¼å®¹ï¼Œå°¤å…¶æ˜¯é‚£äº›å‘½ä»¤é€‰é¡¹ä¸å®Œå…¨å…¼å®¹ï¼Œè€Œ/bin/rmæ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å·¥å…·ï¼Œæˆ‘ä»¬åªæ˜¯æƒ³å°½åŠ›è§„é¿ä¸‹è¯¯åˆ é™¤çš„é£é™©è€Œå·²ã€‚\n  çœ‹ä¸Šå»æ²¡æœ‰ä¸€ä¸ªç°æœ‰å·¥å…·èƒ½å¤Ÿå®Œå…¨æ»¡è¶³è‡ªå·±çš„é€‰æ‹©ï¼Œé‚£å°±è‡ªå·±æŒ‰è‡ªå·±çš„éœ€è¦å¼€å‘ä¸€ä¸ªå§ï¼\nè®¾è®¡æ›´å®‰å…¨çš„rmå·¥å…· # åˆ†æ/bin/rm # é¦–å…ˆï¼Œä¸å¾—ä¸è¯´ï¼Œ/bin/rmæ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å‘½ä»¤ï¼Œåˆ é™¤æ–‡ä»¶ã€åˆ é™¤æ²¡ç›®å½•ç­‰ç­‰ï¼Œå¯ä»¥è¯´ä½¿ç”¨é¢‘ç‡éå¸¸é«˜ï¼Œå®ƒä¹Ÿç¡®å®å¾ˆå¥½ç”¨ã€‚è¯´ç™½äº†ï¼Œæˆ‘ä»¬åªæ˜¯è¦åœ¨å®ƒçš„åŸºç¡€ä¸Šåšäº›å®‰å…¨æ–¹é¢çš„é£é™©è§„é¿å°±èƒ½æ»¡è¶³éœ€æ±‚ã€‚\n/bin/rmï¼Œå®ƒæœ‰ä¸€ç³»åˆ—çš„å‘½ä»¤é€‰é¡¹ï¼Œä¸”æ˜¯POSIXé£æ ¼çš„ã€‚\n å¦‚æœæˆ‘ä»¬å¼€å‘ä¸€ä¸ªå·¥å…·ï¼Œæˆ–è€…åœ¨/bin/rmåŸºç¡€ä¸ŠåŒ…ä¸€å±‚çš„è¯ï¼Œæˆ‘ä»¬æœ€å¥½ä¹Ÿä½¿ç”¨POSIXé£æ ¼çš„å‘½ä»¤é€‰é¡¹æ¥è§£æ; æ¶‰åŠåˆ°rmç›¸å…³çš„é€‰é¡¹ï¼ŒåŸæ¥rmæœ‰çš„æˆ‘ä»¬ä¹Ÿè¦æœ‰ï¼Œè€Œä¸”åŠŸèƒ½å¿…é¡»ä¿æŒä¸€è‡´ï¼›  è¯´ç™½äº†å°±æ˜¯ï¼Œæˆ‘ä»¬è¦ä¿è¯ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹ æƒ¯ä¿æŒä¸å˜ï¼Œç”šè‡³æ²¡æœ‰æ„è¯†åˆ°è‡ªå·±åœ¨ä½¿ç”¨ä¸€ä¸ªå®‰å…¨å¢å¼ºçš„rmã€‚\nå¦‚ä½•å®‰å…¨å¢å¼º # rmåŠ¨ä½œæ˜¯ç”¨æˆ·è‡ªå·±æ‰§è¡Œçš„ï¼Œé™¤äº†ç”¨æˆ·è‡ªå·±æ¸…æ¥šç›®æ ‡æ–‡ä»¶æ˜¯å¦é‡è¦ï¼Œæ²¡æœ‰å…¶ä»–äººå¯ä»¥åšå‡ºèƒœè¿‡æ–‡ä»¶æ‹¥æœ‰è€…çš„å†³å®šï¼Œæ‰€ä»¥å®‰å…¨å¢å¼ºçš„å†³å®šè¿˜æ˜¯äº¤ç»™ç”¨æˆ·è‡ªå·±æ¥åšå‡ºï¼Œæˆ‘ä»¬çš„å·¥å…·åªæ˜¯ååŠ©ç”¨æˆ·å®Œæˆè¿™æ ·çš„åŠ¨ä½œã€‚\nè®¾è®¡ä¸€ä¸ªå®‰å…¨å¢å¼ºçš„rmï¼š\n æ”¯æŒpinå‘½ä»¤ï¼Œå¦‚rm pin Documentsï¼Œä¿æŠ¤Documentsç›®å½•åŠå…¶ä¸‹çš„æ–‡ä»¶ï¼›  å½“æ‰§è¡Œrm -rf Documentsæ—¶ï¼Œå‘ç°æœ‰.pinLockæ–‡ä»¶å­˜åœ¨ï¼Œè¡¨ç¤ºDocumentsç›®å½•åŠå…¶ä¸‹çš„æ–‡ä»¶ã€å­ç›®å½•å—ä¿æŠ¤ï¼Œæ‹’ç»åˆ é™¤ï¼› å½“æ‰§è¡Œrm -rf Documents/dir/fileæ—¶ï¼Œä¼šé€’å½’åœ°å›æº¯ç›®å½•å±‚çº§ï¼Œå¦‚æœè·¯å¾„ä¸Šä»»ä¸€çˆ¶ç›®å½•å—ä¿æŠ¤ï¼Œè¯¥æ–‡ä»¶ä¸èƒ½è¢«åˆ é™¤ï¼›   æ”¯æŒunpinå‘½ä»¤ï¼Œå¦‚rm unpin Documentsï¼Œå–æ¶ˆDocumentså½“å‰ä¸€çº§ç›®å½•çš„ä¿æŠ¤ï¼›  å½“æ‰§è¡Œrm -rf Documents/dir/fileæ—¶ï¼Œå¦‚æœDocumentså¤„äºunpinçŠ¶æ€ï¼Œä½†æ˜¯dirå¤„äºpinçŠ¶æ€ï¼Œfileä¹Ÿæ˜¯å—ä¿æŠ¤çš„ï¼Œä¸èƒ½åˆ é™¤ï¼›   æ”¯æŒ-ré€‰é¡¹ï¼Œå…è®¸é€’å½’åœ°æ·»åŠ ã€ç§»é™¤ä¿æŠ¤ï¼›  å®ç°è¯¥rmå‘½ä»¤ # ä»¥ä¸‹æ˜¯å¤§è‡´çš„rmå‘½ä»¤æ“ä½œçš„helpä¿¡æ¯ï¼Œå®ƒæœ‰3ä¸ªå­å‘½ä»¤ï¼Œhelpæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼Œpinç”¨æ¥å¯¹ç›®å½•æ·»åŠ ä¿æŠ¤ï¼Œunpinç§»é™¤ä¿æŠ¤ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  èƒŒæ™¯ # å¤§å®¶æœ‰æ²¡æœ‰å› ä¸ºä¸€æ—¶å¤§æ„ï¼Œé”™è¯¯åœ°æ‰§è¡Œäº†rm -rfè€Œå¯¼è‡´é‡è¦æ–‡ä»¶è¢«åˆ é™¤çš„æƒ…å†µï¼Ÿä¸€å®šæœ‰é‚£ä¹ˆä¸€æ¬¡ä¸¤æ¬¡çš„å§ã€‚å‰å‡ å¤©ï¼Œæˆ‘åˆçŠ¯äº†è¿™ä¸€æ¬¡è¿™æ ·çš„é”™è¯¯ã€‚æœ¬æ¥æ˜¯è¦åˆ é™¤å½“å‰ç›®å½•ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œäºæ˜¯æ‰§è¡Œ rm -rf .ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰è¾“å…¥å®Œï¼Œå› ä¸ºæˆ‘è°ƒæ•´äº†KeyRepeatè®¾ç½®é¡¹çš„åŸå› å§ï¼ŒæŒ‰é”®å»¶è¿Ÿå¾ˆçŸ­ï¼Œç»“æœå‘½ä»¤å˜æˆäº† rm -rf ..ï¼Œè¿™ä¸ªæ—¶å€™..å·²ç»æŒ‡å‘äº†HOMEç›®å½•â€¦â€¦é¢ï¼Œæ²¡å…³æ³¨å³æ‰‹ï¼Œå·¦æ‰‹è¿˜æ²¡æœ‰tabå€™é€‰ï¼Œå³æ‰‹å·²ç»é”®å…¥äº†å›è½¦ï¼Œggï¼Œçœ¼ççåœ°çœ‹ç€å¤§é‡æ–‡ä»¶è¢«åˆ é™¤ï¼Œctrl+cå·²ç»å¤ªæ™šäº† :( ã€‚\nå¤šäºmacOSé»˜è®¤å¯¹Desktopã€Documentç­‰ç›®å½•ä¸‹çš„æ–‡ä»¶åšäº†è‡ªåŠ¨åœ°å¤‡ä»½ï¼Œä¸ç„¶å°±çœŸçš„è¦è‹¦äº†ï¼Œè™½ç„¶å¯¹é‡è¦æ–‡ä»¶ã€æ•°æ®ä¹Ÿæœ‰åšè¿‡å¤‡ä»½ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½åšåˆ°æŒ‰æœˆã€æŒ‰å¤©çš„å¤‡ä»½ï¼Œå“ªæ€•æ˜¯æœ€è¿‘å‡ ä¸ªæœˆçš„æ•°æ®ã€é…ç½®çš„ä¸¢å¤±ï¼Œå¯¹æˆ‘æ¥è¯´ä¹Ÿæ˜¯æŒºä¼¤çš„ã€‚æœä¸å…¶ç„¶ï¼Œåç»­å‡ å¤©é™†é™†ç»­ç»­å‘ç°ä¸¢å¤±äº†å„ç§å„æ ·çš„é…ç½®ï¼ŒIDEçš„ã€bashçš„ã€gitçš„ã€petçš„â€¦â€¦å„ç§å„æ ·çš„ï¼\nä¸å¹¸ä¸­çš„ä¸‡å¹¸ï¼Œä¸€äº›è‡ªå·±è®¤ä¸ºçœŸçš„å¾ˆé‡è¦çš„æ•°æ®ï¼Œä¸€èˆ¬åœ¨Documentä¸­äº¤ç»™icloudåšäº†å¤‡ä»½ï¼Œè¿™äº›æ•°æ®å€’æ˜¯å¯ä»¥æ¢å¤ï¼Œè™½ç„¶æ…¢äº†ç‚¹ï¼Œä½†æ˜¯èƒ½æ¢å¤æ€»è¿˜æ˜¯å¥½çš„ï¼æ„Ÿè°¢icloudæä¾›çš„äº‘å­˜å‚¨æœåŠ¡ï¼\nå¦‚ä½•é¿å…è¯¯åˆ é™¤æ–‡ä»¶ # ç»æ­¤ä¸€å½¹ä¹‹åï¼Œæˆ‘è¿˜æ˜¯æ€è€ƒäº†ä¸€äº›å¦‚ä½•è§„é¿çš„é—®é¢˜ï¼Œæˆ‘æœ‰å¤šå¹´çš„Linuxä½¿ç”¨ç»éªŒï¼Œç«Ÿç„¶ä¹Ÿä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ï¼Œæˆ‘å°†å…¶å½’å› äºï¼šè¿‡å¤±é—®é¢˜ï¼Œè™½ç„¶åƒæˆ‘è¿™æ ·çš„æœ‰ç»éªŒçš„å¼€å‘è€…æå°‘ä¼šçŠ¯è¿™æ ·çš„é”™è¯¯ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šå¶å°”å‘ç”Ÿï¼å¾ˆå¤šå¼€å‘è€…éƒ½æå‡ºäº†è‡ªå·±çš„ä¸€äº›æƒ³æ³•ï¼Œå¦‚ä½•è§„é¿rmé€ æˆçš„æ–‡ä»¶è¯¯åˆ é—®é¢˜ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è€ƒè™‘å¦‚ä½•æ¢å¤çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ç§äººç¬”è®°æœ¬å•ç¡¬ç›˜å•åˆ†åŒºçš„è¯ï¼Œæ¢å¤çš„å›°éš¾åº¦æ˜¯æ¯”è¾ƒé«˜çš„ã€‚\n  åˆ é™¤åªç”¨ç³»ç»Ÿguiåˆ é™¤ï¼Œå¦‚macOSã€windowsã€kdeä¸‹åˆ é™¤æ–‡ä»¶åˆ°åƒåœ¾ç®±ï¼Œè¯¯åˆ çš„è¯è¿˜æ˜¯å¯ä»¥ä»åƒåœ¾ç®±æ¢å¤çš„ï¼›\nä¸é€‚ç”¨ï¼šæ‰§è¡Œåˆ é™¤åŠ¨ä½œæ˜¯å¾ˆå¸¸è§çš„ï¼Œä½œä¸ºä¸€åå¼€å‘è€…ï¼Œæˆ‘ä¸å¤§å¯èƒ½ä½¿ç”¨guiæ¥é¢‘ç¹åˆ‡æ¢ç›®å½•åæ‰åˆ é™¤æ–‡ä»¶ã€‚\n  è‡ªå®šä¹‰bashä¸­çš„aliasï¼Œå¦‚alias rm=\u0026ldquo;function rm() {\u0026hellip;.}\u0026quot;ï¼Œè¯¥å‡½æ•°å†…éƒ¨åšä¸€äº›æ£€æŸ¥ï¼Œä»¥å†³å®šæ˜¯å¦åˆ é™¤æ–‡ä»¶ï¼›\nä¸é€‚ç”¨ï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªè§£å†³é—®é¢˜çš„æ€è·¯ï¼Œä½†æ˜¯èƒ½å¦ä¸åŸç”Ÿçš„/bin/rmå‘½ä»¤å®Œå…¨å…¼å®¹æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œè€Œä¸”æ£€æŸ¥é€»è¾‘å¯èƒ½è¦é¢‘ç¹æ”¹åŠ¨æ‰èƒ½èƒœä»»å„ç§é¿å…è¯¯åˆ çš„åœºæ™¯ï¼Œä½¿ç”¨èµ·æ¥ä¸æ˜¯é‚£ä¹ˆçµæ´»ã€‚\n  ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„åˆ é™¤å·¥å…·ï¼Œå¦‚githubä¸Šçš„ä¸€äº›ç±»ä¼¼rm-safeçš„å·¥å…·ï¼Œä»£æ›¿åŸç”Ÿçš„/bin/rmå‘½ä»¤ï¼›\nä¸é€‚ç”¨ï¼šè¿™äº›å·¥å…·ä¸èƒ½å®Œå…¨ä¸/bin/rmå…¼å®¹ï¼Œå°¤å…¶æ˜¯é‚£äº›å‘½ä»¤é€‰é¡¹ä¸å®Œå…¨å…¼å®¹ï¼Œè€Œ/bin/rmæ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å·¥å…·ï¼Œæˆ‘ä»¬åªæ˜¯æƒ³å°½åŠ›è§„é¿ä¸‹è¯¯åˆ é™¤çš„é£é™©è€Œå·²ã€‚\n  çœ‹ä¸Šå»æ²¡æœ‰ä¸€ä¸ªç°æœ‰å·¥å…·èƒ½å¤Ÿå®Œå…¨æ»¡è¶³è‡ªå·±çš„é€‰æ‹©ï¼Œé‚£å°±è‡ªå·±æŒ‰è‡ªå·±çš„éœ€è¦å¼€å‘ä¸€ä¸ªå§ï¼\nè®¾è®¡æ›´å®‰å…¨çš„rmå·¥å…· # åˆ†æ/bin/rm # é¦–å…ˆï¼Œä¸å¾—ä¸è¯´ï¼Œ/bin/rmæ˜¯ä¸€ä¸ªéå¸¸å¥½ç”¨çš„å‘½ä»¤ï¼Œåˆ é™¤æ–‡ä»¶ã€åˆ é™¤æ²¡ç›®å½•ç­‰ç­‰ï¼Œå¯ä»¥è¯´ä½¿ç”¨é¢‘ç‡éå¸¸é«˜ï¼Œå®ƒä¹Ÿç¡®å®å¾ˆå¥½ç”¨ã€‚è¯´ç™½äº†ï¼Œæˆ‘ä»¬åªæ˜¯è¦åœ¨å®ƒçš„åŸºç¡€ä¸Šåšäº›å®‰å…¨æ–¹é¢çš„é£é™©è§„é¿å°±èƒ½æ»¡è¶³éœ€æ±‚ã€‚\n/bin/rmï¼Œå®ƒæœ‰ä¸€ç³»åˆ—çš„å‘½ä»¤é€‰é¡¹ï¼Œä¸”æ˜¯POSIXé£æ ¼çš„ã€‚\n å¦‚æœæˆ‘ä»¬å¼€å‘ä¸€ä¸ªå·¥å…·ï¼Œæˆ–è€…åœ¨/bin/rmåŸºç¡€ä¸ŠåŒ…ä¸€å±‚çš„è¯ï¼Œæˆ‘ä»¬æœ€å¥½ä¹Ÿä½¿ç”¨POSIXé£æ ¼çš„å‘½ä»¤é€‰é¡¹æ¥è§£æ; æ¶‰åŠåˆ°rmç›¸å…³çš„é€‰é¡¹ï¼ŒåŸæ¥rmæœ‰çš„æˆ‘ä»¬ä¹Ÿè¦æœ‰ï¼Œè€Œä¸”åŠŸèƒ½å¿…é¡»ä¿æŒä¸€è‡´ï¼›  è¯´ç™½äº†å°±æ˜¯ï¼Œæˆ‘ä»¬è¦ä¿è¯ç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹ æƒ¯ä¿æŒä¸å˜ï¼Œç”šè‡³æ²¡æœ‰æ„è¯†åˆ°è‡ªå·±åœ¨ä½¿ç”¨ä¸€ä¸ªå®‰å…¨å¢å¼ºçš„rmã€‚\nå¦‚ä½•å®‰å…¨å¢å¼º # rmåŠ¨ä½œæ˜¯ç”¨æˆ·è‡ªå·±æ‰§è¡Œçš„ï¼Œé™¤äº†ç”¨æˆ·è‡ªå·±æ¸…æ¥šç›®æ ‡æ–‡ä»¶æ˜¯å¦é‡è¦ï¼Œæ²¡æœ‰å…¶ä»–äººå¯ä»¥åšå‡ºèƒœè¿‡æ–‡ä»¶æ‹¥æœ‰è€…çš„å†³å®šï¼Œæ‰€ä»¥å®‰å…¨å¢å¼ºçš„å†³å®šè¿˜æ˜¯äº¤ç»™ç”¨æˆ·è‡ªå·±æ¥åšå‡ºï¼Œæˆ‘ä»¬çš„å·¥å…·åªæ˜¯ååŠ©ç”¨æˆ·å®Œæˆè¿™æ ·çš„åŠ¨ä½œã€‚\nè®¾è®¡ä¸€ä¸ªå®‰å…¨å¢å¼ºçš„rmï¼š\n æ”¯æŒpinå‘½ä»¤ï¼Œå¦‚rm pin Documentsï¼Œä¿æŠ¤Documentsç›®å½•åŠå…¶ä¸‹çš„æ–‡ä»¶ï¼›  å½“æ‰§è¡Œrm -rf Documentsæ—¶ï¼Œå‘ç°æœ‰.pinLockæ–‡ä»¶å­˜åœ¨ï¼Œè¡¨ç¤ºDocumentsç›®å½•åŠå…¶ä¸‹çš„æ–‡ä»¶ã€å­ç›®å½•å—ä¿æŠ¤ï¼Œæ‹’ç»åˆ é™¤ï¼› å½“æ‰§è¡Œrm -rf Documents/dir/fileæ—¶ï¼Œä¼šé€’å½’åœ°å›æº¯ç›®å½•å±‚çº§ï¼Œå¦‚æœè·¯å¾„ä¸Šä»»ä¸€çˆ¶ç›®å½•å—ä¿æŠ¤ï¼Œè¯¥æ–‡ä»¶ä¸èƒ½è¢«åˆ é™¤ï¼›   æ”¯æŒunpinå‘½ä»¤ï¼Œå¦‚rm unpin Documentsï¼Œå–æ¶ˆDocumentså½“å‰ä¸€çº§ç›®å½•çš„ä¿æŠ¤ï¼›  å½“æ‰§è¡Œrm -rf Documents/dir/fileæ—¶ï¼Œå¦‚æœDocumentså¤„äºunpinçŠ¶æ€ï¼Œä½†æ˜¯dirå¤„äºpinçŠ¶æ€ï¼Œfileä¹Ÿæ˜¯å—ä¿æŠ¤çš„ï¼Œä¸èƒ½åˆ é™¤ï¼›   æ”¯æŒ-ré€‰é¡¹ï¼Œå…è®¸é€’å½’åœ°æ·»åŠ ã€ç§»é™¤ä¿æŠ¤ï¼›  å®ç°è¯¥rmå‘½ä»¤ # ä»¥ä¸‹æ˜¯å¤§è‡´çš„rmå‘½ä»¤æ“ä½œçš„helpä¿¡æ¯ï¼Œå®ƒæœ‰3ä¸ªå­å‘½ä»¤ï¼Œhelpæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼Œpinç”¨æ¥å¯¹ç›®å½•æ·»åŠ ä¿æŠ¤ï¼Œunpinç§»é™¤ä¿æŠ¤ã€‚\n$ rm help hitzhangjie/rm is an security-enhanced version of /bin/rm, which could avoid the deletion of files by mistake. rm help: display help info rm pin: -r, pin target recursively rm unpin: -r, unpin target recursively  å½“ä¼ é€’ç»™rmçš„é€‰é¡¹ï¼Œä¸æ˜¯rm help/pin/unpinè¿™æ ·çš„é€‰é¡¹æ—¶ï¼Œä¼šå°†é€‰é¡¹å½“åš/bin/rmçš„é€‰é¡¹ï¼Œè¿›è€Œæ‰§è¡Œrmç›¸å…³çš„åŠ¨ä½œï¼Œæ‰€ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œçš„åˆ é™¤å¹¶ä¸æ˜¯ç”±/bin/rmæ¥æ‰§è¡Œï¼Œè€Œæ˜¯ç”±æˆ‘ä»¬é‡å†™çš„ä¸€ä¸ªrmCmdæ¥æ‰§è¡Œï¼Œå…¶å†…éƒ¨ä¼šé¦–å…ˆæ£€æŸ¥å¾…åˆ é™¤æ–‡ä»¶ã€ç›®å½•æ˜¯å¦æ­£åœ¨è¢«ä¿æŠ¤ã€‚\nè¯¥å®‰å…¨å¢å¼ºçš„rmå·¥å…·çš„ä»£ç ï¼Œè¯·æˆ³ hitzhangjie/rm æŸ¥çœ‹ã€‚\nä»£ç é‡ä¸å¤šï¼Œæœ‰å‡ ä¸ªé‡è¦çš„ç‚¹é˜è¿°ä¸‹ï¼š\n æ‰§è¡Œrmå‘½ä»¤æ—¶ï¼Œç»™ç”¨æˆ·å¿…è¦çš„æç¤ºä¿¡æ¯ï¼Œè®©ç”¨æˆ·çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå®‰å…¨å¢å¼ºç‰ˆçš„rmå‘½ä»¤ï¼Œå¹¶éshellåŸç”Ÿçš„rmï¼› æ‰§è¡Œrm pinæ—¶ï¼Œåˆ›å»ºæ–‡ä»¶é”.pinLockï¼Œè¯¥æ–‡ä»¶çš„å­˜åœ¨è¡¨ç¤ºå…¶æ‰€åœ¨çš„ç›®å½•åŠç›®å½•ä¸‹çš„æ–‡ä»¶ã€å­ç›®å½•ç»Ÿç»Ÿå—ä¿æŠ¤ï¼Œæ‰§è¡Œrmæ—¶ä¸èƒ½åˆ é™¤ï¼› æ‰§è¡Œrm unpinæ—¶ï¼Œåˆ é™¤æ–‡ä»¶é”.pinLockï¼Œæ”¹æ–‡ä»¶å¤‡ç§»é™¤ä¹‹åï¼Œè¡¨ç¤ºæ‰€å±ç›®å½•åŠç›®å½•ä¸‹çš„åŒçº§æ–‡ä»¶ã€ç›®å½•ä¸å†å—ä¿æŠ¤ï¼Œä½†æ˜¯è‹¥å­ç›®å½•ä¸­æœ‰.pinLockæ–‡ä»¶ä»å—ä¿æŠ¤ï¼› æ‰§è¡Œrmæ—¶ï¼Œå› ä¸ºrmæ˜¯POSIXé£æ ¼çš„å‘½ä»¤é€‰é¡¹ï¼Œæ„å‘³ç€å®ç°pinã€unpinæ—¶ï¼Œæœ€å¥½å°±åˆ«å†ä½¿ç”¨goæ ‡å‡†åº“æä¾›çš„é€‰é¡¹é£æ ¼è¿›è¡Œè§£æï¼Œä¸ç„¶ä¸¤ç§é£æ ¼çš„é€‰é¡¹æ··åœ¨ä¸€èµ·ï¼Œä½¿ç”¨èµ·æ¥å¤šæœ‰ä¸ä¾¿ï¼› è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯pflagsè¿™ä¸€åŸºäºPOSIXé£æ ¼çš„flagsè§£æåº“ã€‚  ä»£ç é‡ä¸å¤šï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºç ï¼Œäº†è§£å…·ä½“çš„å®ç°ç»†èŠ‚ã€‚\nå¦‚æœå¸Œæœ›è‡ªå·±ä¹Ÿèƒ½é¿å…å› ä¸ºæ‰‹è´±å¸¦æ¥çš„æ–‡ä»¶è¯¯åˆ é—®é¢˜ï¼Œæ¬¢è¿ä½¿ç”¨ä½“éªŒè¯¥å·¥å…·ï¼\nå°ç»“ # ä»æ—¥å¸¸ä½¿ç”¨è§’åº¦å‡ºå‘ï¼Œæ€è€ƒäº†é äººæ¥é¿å…è¯¯åˆ é™¤æ–‡ä»¶çš„æ“ä½œæ˜¯åŸºæœ¬è¡Œä¸é€šçš„ï¼Œè¿˜æ˜¯è¦æä¾›æœ‰æ•ˆçš„å·¥å…·å»ååŠ©äººæ¥å¯¹é‡è¦æ–‡ä»¶è¿›è¡Œä¿æŠ¤ã€‚ç»å†è¿‡ä¸€ä¸¤æ¬¡è¿™æ ·çš„æ–‡ä»¶è¯¯åˆ é™¤æ“ä½œä¹‹åï¼Œç—›å¾—éš¾å—ï¼Œå°±é†’äº†ï¼Œäºæ˜¯è‡ªå·±å¼€å‘äº†è¿™ä¸ªå®‰å…¨å¢å¼ºç‰ˆæœ¬çš„rmå·¥å…·ï¼Œå…¶å®å¯¥å¯¥æ•°è¡Œä»£ç è€Œå·²ï¼Œä½†æ˜¯å´å¸®äº†æˆ‘å¤§å¿™ã€‚ç°åœ¨å¶å°”ä¹Ÿæ˜¯ä¼šæ•²å‡ºå¾ˆå¯æ€•çš„å‘½ä»¤ï¼Œä½†æ˜¯å› ä¸ºæˆ‘å·²ç»æå‰å¯¹é‡è¦æ–‡ä»¶ç›®å½•åšäº†ä¿æŠ¤ï¼Œå†æ²¡å‘ç”Ÿè¿‡é‡è¦æ–‡ä»¶è¢«rmè¯¯åˆ é™¤çš„åœºæ™¯äº†ã€‚\næˆ‘ä¸èƒ½ä¿è¯è‡ªå·±ä»¥åä¸ä¼šæ‰‹è´±ï¼Œä½†æ˜¯æœ‰è¿™ä¸ªå·¥å…·çš„å­˜åœ¨ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå‡è½»äº†æˆ‘çš„å¿ƒç†å‹åŠ›ï¼Œå“ˆå“ˆï¼å¸Œæœ›å¯¹è¯»è€…ä»¬æœ‰å¸®åŠ©! :)\n"}),a.add({id:318,href:"/tags/code-reivew/",title:"code reivew",description:"",content:""}),a.add({id:319,href:"/tags/cr/",title:"cr",description:"",content:""}),a.add({id:320,href:"/tags/google/",title:"google",description:"",content:""}),a.add({id:321,href:"/blog/2019-09-10-%E5%A6%82%E4%BD%95%E6%9B%B4%E5%A5%BD%E5%9C%B0%E8%BF%9B%E8%A1%8C%E4%BB%A3%E7%A0%81review/",title:"Google CRæŒ‡å¼•, å¦‚ä½•æ¨è¿›ä»£ç è¯„å®¡",description:"æœ€è¿‘å­¦ä¹ äº†Googleçš„CodeReviewæŒ‡å¼•ï¼Œæ•´ç†äº†å…¶ä¸­ä¸€äº›æ¯”è¾ƒæœ‰ä»·å€¼çš„ç‚¹ï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚\nGoogle Code Review Guidelines # Googleç§¯ç´¯äº†å¾ˆå¤šæœ€ä½³å®è·µï¼Œæ¶‰åŠä¸åŒçš„å¼€å‘è¯­è¨€ã€é¡¹ç›®ï¼Œè¿™äº›æ–‡æ¡£ï¼Œå°†Googleå·¥ç¨‹å¸ˆå¤šå¹´æ¥ç§¯æ”’çš„ä¸€äº›æœ€ä½³å®è·µç»éªŒè¿›è¡Œäº†æ€»ç»“å¹¶åˆ†äº«ç»™ä¼—å¼€å‘è€…ã€‚å­¦ä¹ ä¸‹è¿™é‡Œçš„ç»éªŒï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œé¡¹ç›®å¼€å‘ã€å¼€æºååŒçš„è¿‡ç¨‹ä¸­ï¼Œç›¸ä¿¡ä¹Ÿå¯ä»¥ä»ä¸­å—ç›Šã€‚\nGoogleç›®å‰å…¬å¼€çš„æœ€ä½³å®è·µç›¸å…³æ–‡æ¡£ï¼Œç›®å‰åŒ…æ‹¬ï¼š\n Google\u0026rsquo;s Code Review Guidelinesï¼ŒGoogleä»£ç reviewæŒ‡å¼•ï¼ŒåŒ…å«ä»¥ä¸‹ä¸¤ä¸ªç³»åˆ—çš„å†…å®¹ï¼š  The Code Reviewer\u0026rsquo;s Guide The Change Author\u0026rsquo;s Guide    è¿™äº†æ¶‰åŠåˆ°Googleå†…éƒ¨ä½¿ç”¨çš„ä¸€äº›æœ¯è¯­ï¼Œå…ˆæä¸‹ï¼š\n  CL: ä»£è¡¨changelistï¼Œè¡¨ç¤ºä¸€ä¸ªæäº¤åˆ°VCSçš„ä¿®æ”¹ï¼Œæˆ–è€…ç­‰å¾…reviewçš„ä¿®æ”¹ï¼Œä¹Ÿæœ‰ç»„ç»‡ç§°ä¹‹ä¸ºchangeæˆ–patchï¼›\n  LGTMï¼šä»£è¡¨Looks Good to MEï¼Œè´Ÿè´£ä»£ç reviewçš„å¼€å‘è€…å¯¹æ²¡æœ‰é—®é¢˜çš„CLè¿›è¡Œçš„è¯„è®ºï¼Œè¡¨æ˜ä»£ç çœ‹ä¸Šå»OKï¼›\n  The Code Reviewer\u0026rsquo;s Guide # ä»ä»£ç reviewerçš„è§’åº¦å‡ºå‘ï¼Œä»‹ç»ä¸‹Googleå†…éƒ¨ç§¯ç´¯çš„ä¸€äº›good practicesã€‚\nIntroduction # Code Reviewï¼ˆä»£ç è¯„å®¡ï¼‰æŒ‡çš„æ˜¯è®©ç¬¬ä¸‰è€…æ¥é˜…è¯»ä½œè€…ä¿®æ”¹çš„ä»£ç ï¼Œä»¥å‘ç°ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜ã€‚åŒ…æ‹¬Googleåœ¨å†…çš„å¾ˆå¤šå…¬å¸ä¼šé€šèƒ½è¿‡Code Reviewçš„æ–¹å¼æ¥ä¿è¯ä»£ç å’Œäº§å“çš„è´¨é‡ã€‚\nå‰æ–‡å·²æœ‰æåŠï¼ŒCRç›¸å…³å†…å®¹ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªç³»åˆ—ï¼š\n The Code Reviewer\u0026rsquo;s Guide The Change Author\u0026rsquo;s Guide  è¿™é‡Œå…ˆä»‹ç»ä¸‹CRè¿‡ç¨‹ä¸­åº”è¯¥åšä»€ä¹ˆï¼Œæˆ–è€…CRçš„ç›®æ ‡æ˜¯ä»€ä¹ˆã€‚\nWhat Do Code Reviewers Look For? # Code reviewåº”è¯¥å…³æ³¨å¦‚ä¸‹æ–¹é¢ï¼š",content:"æœ€è¿‘å­¦ä¹ äº†Googleçš„CodeReviewæŒ‡å¼•ï¼Œæ•´ç†äº†å…¶ä¸­ä¸€äº›æ¯”è¾ƒæœ‰ä»·å€¼çš„ç‚¹ï¼Œåˆ†äº«ç»™å¤§å®¶ã€‚\nGoogle Code Review Guidelines # Googleç§¯ç´¯äº†å¾ˆå¤šæœ€ä½³å®è·µï¼Œæ¶‰åŠä¸åŒçš„å¼€å‘è¯­è¨€ã€é¡¹ç›®ï¼Œè¿™äº›æ–‡æ¡£ï¼Œå°†Googleå·¥ç¨‹å¸ˆå¤šå¹´æ¥ç§¯æ”’çš„ä¸€äº›æœ€ä½³å®è·µç»éªŒè¿›è¡Œäº†æ€»ç»“å¹¶åˆ†äº«ç»™ä¼—å¼€å‘è€…ã€‚å­¦ä¹ ä¸‹è¿™é‡Œçš„ç»éªŒï¼Œæˆ‘ä»¬åœ¨è¿›è¡Œé¡¹ç›®å¼€å‘ã€å¼€æºååŒçš„è¿‡ç¨‹ä¸­ï¼Œç›¸ä¿¡ä¹Ÿå¯ä»¥ä»ä¸­å—ç›Šã€‚\nGoogleç›®å‰å…¬å¼€çš„æœ€ä½³å®è·µç›¸å…³æ–‡æ¡£ï¼Œç›®å‰åŒ…æ‹¬ï¼š\n Google\u0026rsquo;s Code Review Guidelinesï¼ŒGoogleä»£ç reviewæŒ‡å¼•ï¼ŒåŒ…å«ä»¥ä¸‹ä¸¤ä¸ªç³»åˆ—çš„å†…å®¹ï¼š  The Code Reviewer\u0026rsquo;s Guide The Change Author\u0026rsquo;s Guide    è¿™äº†æ¶‰åŠåˆ°Googleå†…éƒ¨ä½¿ç”¨çš„ä¸€äº›æœ¯è¯­ï¼Œå…ˆæä¸‹ï¼š\n  CL: ä»£è¡¨changelistï¼Œè¡¨ç¤ºä¸€ä¸ªæäº¤åˆ°VCSçš„ä¿®æ”¹ï¼Œæˆ–è€…ç­‰å¾…reviewçš„ä¿®æ”¹ï¼Œä¹Ÿæœ‰ç»„ç»‡ç§°ä¹‹ä¸ºchangeæˆ–patchï¼›\n  LGTMï¼šä»£è¡¨Looks Good to MEï¼Œè´Ÿè´£ä»£ç reviewçš„å¼€å‘è€…å¯¹æ²¡æœ‰é—®é¢˜çš„CLè¿›è¡Œçš„è¯„è®ºï¼Œè¡¨æ˜ä»£ç çœ‹ä¸Šå»OKï¼›\n  The Code Reviewer\u0026rsquo;s Guide # ä»ä»£ç reviewerçš„è§’åº¦å‡ºå‘ï¼Œä»‹ç»ä¸‹Googleå†…éƒ¨ç§¯ç´¯çš„ä¸€äº›good practicesã€‚\nIntroduction # Code Reviewï¼ˆä»£ç è¯„å®¡ï¼‰æŒ‡çš„æ˜¯è®©ç¬¬ä¸‰è€…æ¥é˜…è¯»ä½œè€…ä¿®æ”¹çš„ä»£ç ï¼Œä»¥å‘ç°ä»£ç ä¸­å­˜åœ¨çš„é—®é¢˜ã€‚åŒ…æ‹¬Googleåœ¨å†…çš„å¾ˆå¤šå…¬å¸ä¼šé€šèƒ½è¿‡Code Reviewçš„æ–¹å¼æ¥ä¿è¯ä»£ç å’Œäº§å“çš„è´¨é‡ã€‚\nå‰æ–‡å·²æœ‰æåŠï¼ŒCRç›¸å…³å†…å®¹ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªç³»åˆ—ï¼š\n The Code Reviewer\u0026rsquo;s Guide The Change Author\u0026rsquo;s Guide  è¿™é‡Œå…ˆä»‹ç»ä¸‹CRè¿‡ç¨‹ä¸­åº”è¯¥åšä»€ä¹ˆï¼Œæˆ–è€…CRçš„ç›®æ ‡æ˜¯ä»€ä¹ˆã€‚\nWhat Do Code Reviewers Look For? # Code reviewåº”è¯¥å…³æ³¨å¦‚ä¸‹æ–¹é¢ï¼š\n Designï¼šç¨‹åºè®¾è®¡ã€æ¶æ„è®¾è®¡æ˜¯å¦è®¾è®¡åˆç† Functionalityï¼šä»£ç åŠŸèƒ½æ˜¯å¦ç¬¦åˆä½œè€…é¢„æœŸï¼Œä»£ç è¡Œä¸ºæ˜¯å¦ç”¨æˆ·å‹å¥½ Complexityï¼šå®ç°æ˜¯å¦èƒ½ç®€åŒ–ï¼Œä»£ç å¯è¯»æ€§æ˜¯å¦è‰¯å¥½ï¼Œæ¥å£æ˜¯å¦æ˜“ç”¨ Testsï¼šæ˜¯å¦æä¾›äº†æ­£ç¡®ã€è®¾è®¡è‰¯å¥½çš„è‡ªåŠ¨åŒ–æµ‹è¯•ã€å•å…ƒæµ‹è¯• Namingï¼šå˜é‡åã€ç±»åã€æ–¹æ³•åç­‰å­—é¢é‡çš„é€‰æ‹©æ˜¯å¦æ¸…æ™°ã€ç²¾ç‚¼ Commentsï¼šæ˜¯å¦ç¼–å†™äº†æ¸…æ™°çš„ã€æœ‰ç”¨çš„æ³¨é‡Š Styleï¼šä»£ç é£æ ¼æ˜¯å¦ç¬¦åˆè§„èŒƒ Documentationï¼šä¿®æ”¹ä»£ç çš„åŒæ—¶ï¼Œæ˜¯å¦åŒæ­¥æ›´æ–°äº†ç›¸å…³æ–‡æ¡£  Picking the Best Reviewers # ä¸€èˆ¬ï¼ŒCode reviewä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥ç¡®å®šè°æ‰æ˜¯æœ€å¥½çš„ã€æœ€åˆé€‚çš„reviewerï¼Œè¿™ä¸ªrevieweråº”è¯¥**â€œæœ‰èƒ½åŠ›åœ¨æ¯”è¾ƒåˆç†çš„æ—¶é—´å†…å¯¹ä»£ç ä¿®æ”¹æ˜¯å¦OKåšå‡ºé€å½»ã€å…¨é¢çš„åˆ¤æ–­â€**ã€‚é€šå¸¸revieweråº”è¯¥æ˜¯ç¼–å†™è¢«ä¿®æ”¹ä»£ç çš„ownerï¼Œå¯èƒ½ä»–æ˜¯ç›¸å…³é¡¹ç›®ã€ç›¸å…³æºæ–‡ä»¶ã€ç›¸å…³ä»£ç è¡Œçš„åˆ›å»ºè€…æˆ–è€…ä¿®æ”¹è€…ï¼Œæ„å‘³ç€æˆ‘ä»¬å‘èµ·Code reviewæ—¶ï¼ŒåŒä¸€ä¸ªé¡¹ç›®å¯èƒ½éœ€è¦æ¶‰åŠåˆ°å¤šä¸ªreviewerè¿›è¡ŒCode reviewï¼Œè®©ä¸åŒçš„ã€æœ€åˆé€‚çš„revieweræ¥review CLä¸­æ¶‰åŠåˆ°çš„ä¸åŒéƒ¨åˆ†ã€‚\nå¦‚æœä½ å¿ƒç›®ä¸­æœ‰ä¸€ä¸ªåˆé€‚çš„revieweräººé€‰ï¼Œä½†æ˜¯è¿™ä¸ªäººå½“å‰æ— æ³•reviewï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡³å°‘åº”è¯¥â€œ@â€æˆ–è€…â€œé‚®ä»¶æŠ„é€â€è¯¥reviewerã€‚\nIn-Person Reviews # å¦‚æœæ˜¯ç»“å¯¹ç¼–ç¨‹çš„è¯ï¼ŒAå†™çš„ä»£ç Båº”è¯¥æœ‰èƒ½åŠ›è¿›è¡Œä»£ç reviewï¼Œé‚£ä¹ˆç›´æ¥æ‰¾Bè¿›è¡Œreviewå°±å¯ä»¥äº†ã€‚\nä¹Ÿå¯ä»¥è¿›è¡Œç°åœºè¯„å®¡ï¼ˆIn-Person Reviewsï¼‰ï¼Œä¸€èˆ¬æ˜¯å¼€å‘è€…ä»‹ç»æœ¬æ¬¡CLçš„ä¸»è¦å†…å®¹ã€é€»è¾‘ï¼Œå…¶ä»–reviewerå¯¹ä»£ç ä¸­å¹´å¯èƒ½çš„é—®é¢˜ã€ç–‘æƒ‘è¿›è¡Œæé—®ï¼Œæœ¬æ¬¡CLçš„å¼€å‘è€…è¿›è¡Œè§£ç­”ï¼Œè¿™ç§æ–¹å¼æ¥å‘ç°CLä¸­çš„é—®é¢˜ä¹Ÿæ˜¯å¸¸è§çš„ä¸€ç§æ–¹å¼ã€‚è¾ƒå¤§å‹ã€æ€¥é€Ÿä¸Šçº¿çš„é¡¹ç›®ï¼Œè¿™ç§æ–¹å¼å›¢é˜Ÿå†…éƒ¨ç”¨çš„è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚\nHow to Do a Code Review # è¿™é‡Œæ€»è®¡äº†ä¸€äº›Code reviewçš„å»ºè®®ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸€äº›æ–¹é¢ï¼š\n The Standard of Code Review What to Look For In a Code Review Navigating a CL in Review Speed of Code Reviews How to Write Code Review Comments Handling Pushback in Code Reviews  The Standard of Code Review # ä»£ç reviewçš„ä¸»è¦ç›®çš„å°±æ˜¯ä¸ºäº†ä¿è¯ä»£ç è´¨é‡ã€äº§å“è´¨é‡ï¼Œå¦å¤–Googleçš„å¤§éƒ¨åˆ†ä»£ç éƒ½æ˜¯å†…éƒ¨å…¬å¼€çš„ï¼Œä¸€ä¸ªç»Ÿä¸€çš„å¤§ä»“åº“ï¼Œé€šè¿‡ä»£ç reviewçš„æ–¹å¼æ¥ä¿è¯æœªæ¥Googleä»£ç ä»“åº“çš„è´¨é‡ï¼ŒGoogleè®¾è®¡çš„ä»£ç reviewå·¥å…·ä»¥åŠä¸€ç³»åˆ—çš„reviewè§„èŒƒä¹Ÿéƒ½æ˜¯ä¸ºäº†è¿™ä¸ªç›®çš„ã€‚\nä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼ŒæŸäº›æ–¹é¢éœ€è¦åšä¸€äº›æƒè¡¡å’Œå–èˆã€‚\né¦–å…ˆï¼Œå¼€å‘è€…å¿…é¡»èƒ½å¤ŸæŒç»­ä¼˜åŒ–ã€‚å¦‚æœå¼€å‘è€…ä»æ¥ä¸å¯¹ä»£ç åšä¼˜åŒ–ï¼Œé‚£ä¹ˆæœ€ç»ˆä»£ç ä»“åº“ä¸€å®šä¼šçƒ‚æ‰ã€‚å¦‚æœä¸€ä¸ªreviewerè¿›è¡Œä»£ç reviewæ—¶å¾ˆéš¾å¿«é€ŸæŠ•å…¥ï¼Œå¦‚ä¸çŸ¥é“åšäº†å“ªäº›å˜æ›´ï¼Œé‚£ä¹ˆä»£ç reviewerä¹Ÿä¼šå˜å¾—å¾ˆæ²®ä¸§ã€‚è¿™æ ·å°±ä¸åˆ©äºæ•´ä½“ä»£ç è´¨é‡çš„æé«˜ã€‚\nå¦å¤–ï¼Œä»£ç revieweræœ‰è´£ä»»ç»´æŠ¤CLä¸­æ¶‰åŠåˆ°çš„ä¿®æ”¹çš„è´¨é‡ï¼Œè¦ä¿è¯ä»£ç è´¨é‡ä¸ä¼šå‡ºç°ä¸‹é™ï¼Œæ—¶é—´ä¹…äº†ä¹Ÿä¸è‡³äºçƒ‚å°¾ã€‚æœ‰çš„æ—¶å€™ï¼ŒæŸäº›å›¢é˜Ÿå¯èƒ½ç”±äºæ—¶é—´æœ‰é™ã€èµ¶é¡¹ç›®ï¼Œä»£ç è´¨é‡å°±å¯èƒ½ä¼šå‡ºç°ä¸€å®šçš„ä¸‹é™ã€‚\nè¿˜æœ‰ï¼Œä»£ç reviewerå¯¹è‡ªå·±reviewè¿‡çš„ä»£ç æ‹¥æœ‰owneræƒé™ï¼Œå¹¶è¦ä¸ºä»£ç åç»­å‡ºç°çš„é—®é¢˜æ‰¿æ‹…è´£ä»»ã€‚é€šè¿‡è¿™ç§æ–¹å¼æ¥è¿›ä¸€æ­¥å¼ºåŒ–ä»£ç è´¨é‡ã€ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§ã€‚\nåŸºäºä¸Šè¿°è€ƒè™‘ï¼ŒGoogleåˆ¶å®šäº†å¦‚ä¸‹è§„å®šæ¥ä½œä¸ºCode reviewçš„å†…éƒ¨æ ‡å‡†ï¼š\n In general, reviewers should favor approving a CL once it is in a state where it definitely improves the overall code health of the system being worked on, even if the CL isnâ€™t perfect.\nä¸€èˆ¬ï¼Œreviewerså¯¹CLè¿›è¡Œreviewçš„æ—¶å€™ï¼Œè¾¾åˆ°approvedçš„æ¡ä»¶æ˜¯ï¼ŒCLæœ¬èº«å¯èƒ½ä¸æ˜¯å®Œç¾çš„ï¼Œä½†æ˜¯å®ƒè‡³å°‘åº”ä¿è¯ä¸ä¼šå¯¼è‡´ç³»ç»Ÿæ•´ä½“ä»£ç è´¨é‡çš„ä¸‹é™ã€‚\n å½“ç„¶ï¼Œä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªCLæ·»åŠ äº†ä¸€ä¸ªæ–°ç‰¹æ€§ï¼Œreviewerç›®å‰ä¸æƒ³å°†å…¶æ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼Œå°½ç®¡è¿™ä¸ªCLè®¾è®¡è‰¯å¥½ã€ç¼–ç è‰¯å¥½ï¼Œreviewerå¯èƒ½ä¹Ÿä¼šæ‹’ç»æ‰ã€‚\nå€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ²¡æœ‰æ‰€è°“çš„perfect codeï¼Œåªæœ‰better codeã€‚\n ä»£ç reviewersåº”è¯¥è¦æ±‚å¼€å‘è€…å¯¹CLä¸­æ¯ä¸€è¡Œä»£ç è¿›è¡Œç²¾é›•ç»†ç¢ï¼Œç„¶åå†äºˆä»¥é€šè¿‡ï¼Œè¿™ä¸ªè¦æ±‚å¹¶ä¸è¿‡åˆ†ã€‚ æˆ–è€…ï¼Œä»£ç reviewerséœ€è¦æƒè¡¡ä¸‹ä»–ä»¬å»ºè®®çš„â€œç²¾é›•ç»†ç¢â€çš„å¿…è¦æ€§å’Œé‡è¦æ€§ã€‚ä»£ç reviewersåº”è¯¥è¿½æ±‚ä»£ç çš„æŒç»­ä¼˜åŒ–ï¼Œä¸èƒ½ä¸€å‘³åœ°è¿½æ±‚å®Œç¾ã€‚å¯¹äºæå‡ç³»ç»Ÿå¯ç»´æŠ¤æ€§ã€å¯è¯»æ€§ã€å¯ç†è§£æ€§çš„ä»£ç CLï¼Œreviewersåº”è¯¥å°½å¿«ç»™å‡ºç­”å¤ï¼Œä¸èƒ½å› ä¸ºä¸€å‘³è¿½æ±‚å®Œç¾ä¸»ä¹‰å°†å…¶æç½®å‡ å¤©æˆ–è€…å‡ å‘¨ã€‚  Mentoring # Code reviewå¯¹äºæ•™æˆå¼€å‘è€…ä¸€äº›æ–°çš„ä¸œè¥¿ï¼Œå¦‚ç¼–ç¨‹è¯­è¨€ã€æ¡†æ¶ã€è½¯ä»¶è®¾è®¡åŸåˆ™ç­‰æ˜¯éå¸¸é‡è¦çš„æ‰‹æ®µã€‚è¿›è¡Œä»£ç reviewçš„æ—¶å€™æ·»åŠ ä¸€äº›commentsæœ‰åŠ©äºå¸®åŠ©å¼€å‘è€…ä¹‹é—´åˆ†äº«ã€å­¦ä¹ ä¸€äº›æ–°ä¸œè¥¿ã€‚åˆ†äº«çŸ¥è¯†ä¹Ÿæ˜¯æŒç»­æ”¹è¿›ä»£ç è´¨é‡çš„é‡è¦ä¸€ç¯ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœcommentså†…å®¹æ˜¯çº¯æ•™è‚²æ€§çš„ã€åˆ†äº«æ€§çš„ï¼Œä¸æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„å¼ºåˆ¶æ€§çš„å¿…é¡»åº”è¯¥åšå‡ºä¼˜åŒ–çš„ï¼Œé‚£ä¹ˆæœ€å¥½åœ¨commentså†…å®¹é‡Œé¢æ·»åŠ å‰ç¼€â€œNit (Not Important)â€ï¼Œè¿™æ ·çš„è¯„è®ºè¡¨ç¤ºå½“å‰CLä¸­ä¸ä¸€å®šéè¦åšå‡ºå¯¹åº”çš„ä¼˜åŒ–ã€ä¿®æ”¹ï¼Œåªæ˜¯ä¸€ä¸ªå»ºè®®ã€åˆ†äº«ã€‚\nPrinciples #  æŠ€æœ¯æœ¬èº«ã€æ•°æ®è‡³ä¸Šï¼Œä»¥åŠä¸€äº›ä¸ªäººåå¥½ ä»£ç é£æ ¼çš„é‡è¦æ€§ï¼ŒåŠ›æ±‚ä»£ç é£æ ¼çš„ä¸€è‡´ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®çš„ä»£ç é£æ ¼ï¼Œå°±ç”¨ä¹‹å‰ä½œè€…çš„é£æ ¼ ä¸šå†…çš„ä»£ç é£æ ¼ã€ä¸ªäººåå¥½ï¼Œéœ€è¦åœ¨äºŒè€…ä¹‹é—´é€‚å½“å¹³è¡¡ï¼Œreviewerä¹Ÿåº”è¯¥åœ¨ä»£ç é£æ ¼ä¸Šæ³¨æ„ å¦‚æœæ²¡æœ‰æ˜ç¡®çš„ä¸€äº›è§„å®šï¼Œreviewerå¯ä»¥è¦æ±‚CLä½œè€…éµå¾ªå½“å‰ä»£ç åº“ä¸­çš„ä¸€äº›æƒ¯ç”¨çš„åšæ³•  ä¸Šè¿°å„æ¡ï¼Œå‡ä»¥ä¸é™ä½ç³»ç»Ÿæ•´ä½“ä»£ç è´¨é‡ä¸ºåº¦é‡æ ‡å‡†ã€‚\nResolving Conflicts # å¦‚æœåœ¨ä»£ç reviewä¸­å‡ºç°äº†å†²çªçš„æ„è§ã€è§‚ç‚¹ï¼Œé¦–å…ˆï¼Œå¼€å‘è€…ã€revieweråº”å°½å¯èƒ½åŸºäºä¹‹å‰çš„ä»£ç ã€ç°åœ¨CLçš„ä»£ç è¾¾æˆä¸€ä¸ªå…±è¯†ï¼Œå¦‚æœä»ç„¶è¾¾ä¸æˆå…±è¯†ï¼Œæˆ–è€…å¾ˆå›°éš¾ï¼Œæœ€å¥½èƒ½è¿›è¡Œé¢å¯¹é¢æ²Ÿé€šï¼Œæˆ–è€…å°†å½“å‰CLå‡çº§ä¸€ä¸‹ï¼Œä¾›æ›´å¤šçš„äººå‘˜è¿›è¡Œè®¨è®ºã€‚å¯ä»¥è€ƒè™‘å°†æŠ€æœ¯Leaderã€é¡¹ç›®ç»ç†æ‹‰è¿›æ¥ä¸€èµ·è®¨è®ºä¸‹ã€‚\nè¿™ç§é¢å¯¹é¢çš„æ–¹å¼æ¯”å•çº¯åœ°é€šè¿‡commentsè¿›è¡Œè®¨è®ºè¦é«˜æ•ˆã€å‹å¥½åœ°å¤šï¼Œå¦‚æœæ¡ä»¶ä¸å…è®¸åªèƒ½é€šè¿‡commentsæ–¹å¼è¿›è¡Œï¼Œé‚£ä¹ˆå¯¹äºè®¨è®ºçš„ç»“æœï¼Œåº”è¿›è¡Œé€‚å½“çš„æ€»ç»“ï¼Œç»™å‡ºä¸€ä¸ªç»“è®ºï¼Œæ–¹ä¾¿ä¹‹åçš„å¼€å‘è€…èƒ½å¤Ÿäº†è§£ä¹‹å‰çš„è®¨è®ºç»“æœã€‚\nç›®æ ‡å°±æ˜¯ï¼Œä¸è¦å› ä¸ºä»£ç reviewerå’ŒCLä½œè€…ä¹‹é—´è¾¾ä¸æˆä¸€è‡´ï¼Œå°±é•¿æ—¶é—´å°†CLæç½®ã€‚\nWhat to Look For In a Code Review # ç»“åˆå‰é¢æåˆ°çš„ä¸€äº›Code reviewæ ‡å‡†ï¼Œå°†Code reviewä¸­åº”è¯¥å…³æ³¨çš„ç‚¹è¿›ä¸€æ­¥ç»†åŒ–ï¼Œä¸»è¦ä»¥ä¸‹å†…å®¹ã€‚\nDesign # Code reviewè¿‡ç¨‹ä¸­æœ€é‡è¦çš„äº‹æƒ…å°±æ˜¯çœ‹CLçš„æ•´ä½“è®¾è®¡æ˜¯å¦åˆç†ï¼Œå¦‚CLä¸­æ¶‰åŠåˆ°çš„å„ä¸ªéƒ¨åˆ†çš„ä»£ç ä¹‹é—´çš„æ¥å£ã€äº¤äº’ã€è¡”æ¥æ˜¯å¦åˆç†ï¼Œæ˜¯ä¸šåŠ¡ä»£ç ä¿®æ”¹è¿˜æ˜¯åº“çš„ä¿®æ”¹ï¼Œå’Œç³»ç»Ÿæ•´ä½“çš„é›†æˆæ˜¯å¦åˆç†ï¼Œç°åœ¨è¿™ä¸ªæ—¶é—´ç‚¹æ·»åŠ è¿™ä¸ªæ–°ç‰¹æ€§æ˜¯å¦åˆç†ç­‰ç­‰ã€‚\nFunctionality # CLçš„åŠŸèƒ½æ˜¯å¦ç¬¦åˆå¼€å‘è€…é¢„æœŸï¼Œå¼€å‘è€…æœŸæœ›çš„è¿™éƒ¨åˆ†ä¿®æ”¹æ˜¯å¦å¯¹ç”¨æˆ·å‹å¥½ï¼Œè¿™é‡Œçš„ç”¨æˆ·åŒ…æ‹¬äº§å“ç”¨æˆ·ï¼ˆå®é™…ä½¿ç”¨äº§å“çš„äººå‘˜ï¼‰å’Œå¼€å‘è€…ï¼ˆå°†æ¥å¯èƒ½ä½¿ç”¨è¿™éƒ¨åˆ†ä»£ç çš„äººå‘˜ï¼Œå¦‚CLä¿®æ”¹çš„åº“ä»£ç ï¼‰ã€‚\nä¸€èˆ¬ï¼Œæˆ‘ä»¬å¸Œæœ›å¼€å‘è€…å‘èµ·Code reviewä¹‹å‰ï¼Œèƒ½å¤Ÿå¯¹CLè¿›è¡Œå……åˆ†çš„æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ˜¯ç¬¦åˆé¢„æœŸçš„ã€‚ä½†ä½œä¸ºreviewerï¼Œè¿˜æ˜¯è¦æ£€æŸ¥ä¸‹è¾¹ç•Œæ¡ä»¶çš„å¤„ç†æ˜¯å¦åˆ°ä½ï¼Œæ¯”å¦‚å¹¶å‘ä¸­çš„data raceé—®é¢˜ï¼Œç¡®ä¿ä»£ç ä¸­ä¸å­˜åœ¨â€œå¯èƒ½â€çš„bugã€‚\nrevieweræœ‰æ¡ä»¶çš„è¯ï¼Œä¹Ÿå¯ä»¥äº²è‡ªéªŒè¯ä¸‹CLï¼Œæ¯”å¦‚CLæ˜¯é¢å‘ç”¨æˆ·çš„äº§å“ï¼ˆå¦‚UIæ”¹å˜ï¼‰ï¼Œå•çº¯çœ‹ä»£ç ä¸èƒ½ç›´è§‰åœ°æ„Ÿå—åˆ°åšçš„è°ƒæ•´ï¼Œreviewerå¯ä»¥äº²è‡ªpatchè¿™éƒ¨åˆ†ä»£ç ã€ç¼–è¯‘æ„å»ºã€å®‰è£…ä¹‹åæ¥ä½“éªŒä¸‹å…·ä½“çš„æ”¹å˜ã€‚å¦‚æœä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿çš„è¯ï¼Œä¹Ÿå¯ä»¥æ‰¾ç›¸åº”çš„å¼€å‘è€…æä¾›ä¸€ä¸ªdemoæ¼”ç¤ºä¸‹CLä¸­æ¶‰åŠçš„å˜åŒ–ã€‚\nå¦ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹æ˜¯ï¼Œè¦æ£€æŸ¥CLä¸­æ˜¯å¦å­˜åœ¨æŸç§ç±»å‹çš„å¹¶å‘é—®é¢˜ï¼Œå¦‚deadlocksã€race conditionsç­‰ã€‚è¿™äº›é—®é¢˜ä¹Ÿä¸æ˜¯è¿è¡Œä¸€ä¸‹ä»£ç å°±èƒ½å‘ç°çš„ï¼Œå¾€å¾€éœ€è¦revieweræ¥ç»†è‡´åœ°è€ƒè™‘ä¸‹ç›¸å…³çš„æ“ä½œï¼Œæ‰èƒ½åˆ¤å®šæ˜¯å¦æœ‰å¼•å…¥è¯¥ç±»é—®é¢˜ã€‚\nComplexity # CLæ˜¯å¦è¿‡äºå¤æ‚ï¼Œè¿™ä¸ªéœ€è¦å¯¹CLä¸­çš„ä¸åŒå±‚æ¬¡çš„å†…å®¹è¿›è¡Œé€ä¸€æ£€æŸ¥ï¼Œå¦‚æ¯è¡Œä»£ç æ˜¯å¦è¿‡äºå¤æ‚ï¼Œå‡½æ•°å®ç°æ˜¯å¦è¿‡äºå¤æ‚ï¼Œç±»å®ç°æ˜¯å¦è¿‡äºå¤æ‚ç­‰ã€‚â€œè¿‡äºå¤æ‚â€æ„å‘³ç€ï¼Œä¸èƒ½è¢«å…¶ä»–å¼€å‘è€…å¿«é€Ÿå¸æ”¶ã€ç†è§£ã€‚ä¹Ÿæœ‰ä¸ªç¬‘è¯ï¼Œå¼€å‘è€…åœ¨è°ƒç”¨ã€ä¿®æ”¹è‡ªå·±ç¼–å†™çš„ä»£ç çš„æ—¶å€™å®¹æ˜“å¼•å…¥å¼•å…¥bugã€‚è¿™äº›éƒ½è¯´æ˜äº†å¤æ‚æ€§çš„é—®é¢˜æ‰€åœ¨ã€‚\nè¿‡åº¦è®¾è®¡ä¹Ÿæ˜¯Complexityä¸­çš„ä¸€ç§ï¼Œå¼€å‘äººå‘˜å¯èƒ½å¯¹å½“å‰éœ€è¦è§£å†³çš„é—®é¢˜è¿›è¡Œäº†è§£å†³ï¼Œä½†æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†è¿‡åº¦çš„ã€ä¸å¿…è¦çš„å»¶ä¼¸ã€‚reviewerséœ€è¦å°å¿ƒåˆ¤æ–­ï¼Œè¯†åˆ«å‡ºä¸€ä¸ªCLä¸­æ˜¯å¦å­˜åœ¨è¿‡åº¦è®¾è®¡çš„é—®é¢˜ã€‚reviewersåº”é¼“åŠ±å¼€å‘äººå‘˜è§£å†³å½“å‰å·²ç»å­˜åœ¨çš„ã€æ˜ç¡®çš„é—®é¢˜ï¼Œé¿å…å¼€å‘äººå‘˜åšäº›ä¸»è§‚ä¸Šè®¤ä¸ºæœªæ¥å¯èƒ½éœ€è¦çš„æŸäº›åŠŸèƒ½ã€‚\nTests # CLä¸­åº”è¯¥åŒ…å«å¿…è¦çš„å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ç­‰å¿…è¦çš„æµ‹è¯•ç”¨ä¾‹ï¼Œé™¤éè¿™ä¸ªCLæ˜¯ä¸ºäº†ç´§æ€¥è§£å†³çº¿ä¸Šé—®é¢˜ï¼Œè¿™ç§æƒ…å†µä¸‹æœªèƒ½åŠæ—¶æ·»åŠ å¯ä»¥åŸè°…ã€‚\nç¡®ä¿CLä¸­åŒ…å«çš„æµ‹è¯•ç”¨ä¾‹æ˜¯æ­£ç¡®çš„ã€æœ‰æ„ä¹‰çš„ã€æœ‰æ•ˆçš„ï¼Œä¸è¦ä¸ºäº†å†™æµ‹è¯•ç”¨ä¾‹è€Œå†™æµ‹è¯•ç”¨ä¾‹ï¼Œæµ‹è¯•ç”¨ä¾‹æ˜¯ä¸ºäº†è¾…åŠ©éªŒè¯æˆ‘ä»¬çš„ä»£ç æ˜¯å¦ç¬¦åˆé¢„æœŸçš„ï¼Œå› æ­¤å‡ ä¹ä»»ä½•æ—¶å€™ï¼Œç¡®ä¿æµ‹è¯•ç”¨ä¾‹æœ‰æ•ˆéƒ½æ˜¯è‡³å…³é‡è¦çš„ï¼Œæµ‹è¯•ç”¨ä¾‹ä¹Ÿæ˜¯ä»£ç ç»´æŠ¤å·¥ä½œçš„ä¸€éƒ¨åˆ†ã€‚\nNaming # å‘½åï¼ˆå˜é‡åã€å‡½æ•°åã€ç±»åç­‰ç­‰ï¼‰æ˜¯å¦åˆç†ï¼Œä¸€ä¸ªå¥½çš„åå­—åº”è¯¥é•¿åº¦é€‚ä¸­ï¼Œåˆèƒ½å¤Ÿæ¸…æ™°åœ°è¡¨è¾¾å…¶ä»£è¡¨ä»€ä¹ˆã€‚\nComments # å¼€å‘è€…æ˜¯å¦æä¾›äº†æ¸…æ™°ã€æ˜“äºç†è§£çš„è‹±æ–‡æ³¨é‡Šã€‚\næä¾›çš„æ³¨é‡Šæ˜¯å¦æ˜¯å¿…è¦çš„ï¼Œæ³¨é‡Šä¸æ˜¯ç¬”è®°ï¼Œæ³¨é‡Šåº”è¯¥ç”¨æ¥è§£é‡ŠæŸæ®µä»£ç ä¸ºä»€ä¹ˆå­˜åœ¨ï¼Œä¸éœ€è¦è§£é‡Šè¿™æ®µä»£ç è¦å¹²ä»€ä¹ˆï¼Œè¿™æ ·çš„æ³¨é‡Šæ‰æœ‰æ„ä¹‰ã€‚å¦‚æœä¸æä¾›è¯¥æ³¨é‡Šå°†æ— æ³•ç†è§£è¯¥ä»£ç ï¼Œè¯·è€ƒè™‘ä¸€ä¸‹è®¾è®¡ã€ç¼–ç å®ç°å¤æ‚åº¦ç­‰æ˜¯å¦æœ‰é—®é¢˜ï¼Œæ˜¯å¦å¯ä»¥ç®€åŒ–ã€‚ä¹Ÿæœ‰ä¸€äº›ä¾‹å¤–æƒ…å†µï¼Œå¦‚æ­£åˆ™è¡¨è¾¾å¼æˆ–è€…å¤æ‚çš„ç®—æ³•ï¼Œæä¾›æ³¨é‡Šæ³¨æ˜å…¶ä½œç”¨æ˜¯æœ‰ä»·å€¼çš„ã€‚\nå½“å‰CLä¹‹å‰çš„æ³¨é‡Šï¼Œä¹Ÿéœ€è¦æ£€æŸ¥ä¸€ä¸‹ï¼Œå¯èƒ½å½“å‰CLè§£å†³äº†ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹åº”çš„æŸä¸ªTODOå¯ä»¥åˆ é™¤äº†ã€‚\næ³¨ï¼šè¿™é‡Œçš„æ³¨é‡Šä¸åŒäºç±»æ³¨é‡Šã€æ¨¡å—æ³¨é‡Šã€å‡½æ•°æ³¨é‡Šï¼Œè¿™äº›æ³¨é‡Šéœ€è¦è¡¨æ˜å…¶å­˜åœ¨çš„ç›®çš„ã€åŠŸèƒ½ã€å¦‚ä½•ä½¿ç”¨ã€æœ‰ä»€ä¹ˆè¡Œä¸ºæˆ–å‰¯ä½œç”¨ã€‚\nStyle # ä»£ç é£æ ¼é—®é¢˜ï¼ŒGoogleä¹Ÿæä¾›äº†ä¸€äº›ä»£ç è§„èŒƒï¼Œè¿™é‡Œçš„è§„èŒƒæ¶µç›–äº†å¤šç§ç¼–ç¨‹è¯­è¨€çš„è§„èŒƒï¼Œè¯·ç¡®è®¤CLéµå¾ªæ­¤è§„èŒƒã€‚\nå¦‚æœæŸäº›åœ°æ–¹æ²¡æœ‰æ˜ç¡®çš„ä»£ç è§„èŒƒæŒ‡å¼•ï¼Œè€Œä½ æœ‰è§‰å¾—å¼€å‘è€…è¿™ç§å†™æ³•ä¸å¤ªå¥½ï¼Œä½ æƒ³æå‡ºç‚¹å»ºè®®çš„è¯ï¼Œreviewçš„æ—¶å€™è¯·åœ¨æ„è§é‡Œé¢åŠ ä¸ªå‰ç¼€â€œNit:â€ï¼ŒNot Import Pickï¼Œä»¥è¡¨æ˜è¿™æ˜¯ä¸ªéå¼ºåˆ¶æ€§çš„å»ºè®®ã€‚ä¸è¦å› ä¸ºä¸ªäººåå¥½é—®é¢˜ï¼Œé˜»å¡CLçš„ä»£ç reviewè¿‡ç¨‹ã€‚\nCLé‡Œé¢ä¸è¦æ—¢åšä»£ç é€»è¾‘ä¿®æ”¹ï¼Œåˆåšå¤§èŒƒå›´æ ¼å¼åŒ–çš„æ“ä½œï¼Œè¿™å¯èƒ½è®©reviewã€mergeã€rollbackç­‰å˜å¾—å¤æ‚ï¼Œå¦‚æœç¡®å®æœ‰å¿…è¦åšè¿™æ ·çš„è°ƒæ•´ï¼Œè¯·æä¾›ä¸¤ä¸ªCLã€‚ç¬¬ä¸€ä¸ªç”¨æ¥æ ¼å¼åŒ–ï¼Œç¬¬äºŒä¸ªåœ¨æ­¤åŸºç¡€ä¸Šå†è¿›è¡Œä»£ç é€»è¾‘çš„ä¿®æ”¹ã€‚åè¿‡æ¥ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯ä¸è¦ä¸€æ¬¡åšä¸¤ä»¶â€œå˜åŠ¨å·¨å¤§â€çš„äº‹æƒ…ã€‚\nDocumentation # å¦‚æœä¸€ä¸ªCLæ”¹å˜äº†ç”¨æˆ·buildã€testã€interact withã€release codeçš„æ–¹å¼ï¼Œè¯·åŒæ­¥æ£€æŸ¥ä¸‹æ–‡æ¡£æ˜¯å¦ä¹Ÿè¦æ›´æ–°ï¼ŒåŒ…å«READMEsã€g3doc pagesä»¥åŠå…¶ä»–ä¸€äº›ç”Ÿæˆçš„reference docsã€‚å¦‚æœCLåˆ é™¤äº†æˆ–è€…åºŸå¼ƒäº†æŸäº›ä»£ç ï¼Œè€ƒè™‘ä¸‹æ˜¯å¦å¯¹åº”çš„æ–‡æ¡£å†…å®¹ä¹Ÿæœ‰éœ€è¦åˆ é™¤çš„ã€‚\nå¦‚æœå‘ç°ç¼ºå°‘æŸäº›æ–‡æ¡£å†…å®¹ï¼Œè¯·è”ç³»å¼€å‘è€…è¡¥é½ã€‚\nEvery Line # æ£€æŸ¥reviewä»»åŠ¡ä¸­ä½ åˆ†é…çš„æ¯ä¸€è¡Œä»£ç ã€‚å¯¹äºæŸäº›è‡ªåŠ¨åŒ–ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶ã€ä»£ç æ–‡ä»¶ï¼ˆå¦‚*.pb.goï¼‰ã€å¤§å‹æ•°æ®ç»“æ„ï¼Œä½ å¯ä»¥å¿«é€Ÿæ‰«è¿‡å»ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¼€å‘è€…è‡ªå·±å†™çš„classã€functionã€block of codeï¼Œè¿™ç§ä¸èƒ½æ‰«ä¸€ä¸‹å°±è¿‡å»äº†ï¼Œéœ€è¦ä»”ç»†æ£€æŸ¥ã€‚\nå¼€å‘è€…è‡ªå·±å†™çš„ä»£ç ï¼Œä¹Ÿæœ‰é‡è¦çš„ã€ä¸é‡è¦çš„ä¹‹åˆ†ï¼ŒæŸäº›ä»£ç ç‰‡æ®µéœ€è¦æ›´ä»”ç»†åœ°reviewï¼Œæ¯”å¦‚æŸäº›åˆ†æ”¯åˆ¤æ–­é€»è¾‘ï¼Œrevieweréœ€è¦åŸ¹å…»è¿™æ–¹é¢çš„è¯†åˆ«é‡è¦ä»£ç è·¯å¾„çš„èƒ½åŠ›ã€‚å¦‚æœç›®å‰æ²¡æœ‰è¿™ç§è¯†åˆ«å…³é”®è·¯å¾„çš„èƒ½åŠ›ï¼Œä¹Ÿè‡³å°‘åº”è¯¥ç¡®ä¿ä½ çœ‹æ‡‚äº†è¿™äº›ä»£ç ã€‚\nå¦‚æœreviewè¿‡ç¨‹ä¸­ï¼Œä½ å‘ç°æŸäº›ä»£ç å®åœ¨æ˜¯è´¹è§£ï¼Œä¸¥é‡æ‹–æ…¢äº†reviewè¿›åº¦ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸è¦çŠ¹è±«ï¼Œç›´æ¥è”ç³»ä»£ç ä½œè€…æ¥è§£é‡Šå®ƒæ˜¯å¹²ä»€ä¹ˆçš„ã€èƒ½å¦ç®€åŒ–å®ç°ï¼Œç„¶åå†reviewã€‚åœ¨Googleé›‡ä½£äº†å¾ˆå¤šä¼˜ç§€çš„å¼€å‘è€…ï¼Œå¦‚æœæŸä½çœ‹ä¸æ‡‚ï¼Œé‚£ä¹ˆå…¶ä»–äººå¯èƒ½ä¹Ÿçœ‹ä¸æ‡‚ï¼Œéšç€ä¸šåŠ¡éœ€æ±‚å˜æ›´ï¼Œå°†æ¥æ–°åŠ å…¥çš„å¼€å‘è€…æ›´å¯èƒ½çœ‹ä¸æ‡‚ã€‚åœ¨Tencentä»¥åŠå…¶ä»–å…¬å¸ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œrevieweråº”è¯¥ç›´æ¥è”ç³»ä»£ç ä½œè€…æ¥è§£é‡Šã€ä¼˜åŒ–ä»£ç å®ç°ï¼ŒæŸç§æ„ä¹‰ä¸Šè¿™ä¹Ÿæ˜¯ä¸ºæå‡æ•´ä½“ä»£ç è´¨é‡åšè´¡çŒ®äº†ã€‚\nå¦‚æœä½ ç†è§£äº†ä»£ç é€»è¾‘ï¼Œä½†æ˜¯å¯¹äºæŸäº›éƒ¨åˆ†ä½ æ‹¿ä¸å‡†ï¼Œè¯·é‚€è¯·å¦ä¸€ä½èµ„å†æ›´æ·±çš„revieweræ¥reviewï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›å®‰å…¨ã€å¹¶å‘ã€å¯ç”¨ã€å›½é™…åŒ–ç­‰æ–¹é¢å¤æ‚çš„é—®é¢˜ã€‚\nContext # reviewè¿‡ç¨‹ä¸­æŸ¥çœ‹CLç›¸å…³ä»£ç ä¸Šæ–‡æ˜¯æœ‰å¸®åŠ©çš„ã€‚ä»£ç reviewçš„æ—¶å€™ï¼Œä»£ç reviewå·¥å…·åªä¼šæ˜¾ç¤ºå‡ è¡Œä¿®æ”¹çš„ä»£ç ï¼Œä½†æ˜¯å‰åä¸ä¹‹ç›¸å…³çš„ä»£ç å´å¯èƒ½å¤§èŒƒå›´æŠ˜å ã€‚æœ‰æ—¶ï¼Œä½ ä¸å¾—ä¸æŸ¥çœ‹æ•´ä¸ªæ–‡ä»¶å†…å®¹æ¥ç¡®ä¿CLæ˜¯æœ‰æ„ä¹‰çš„ã€‚å†æ¯”å¦‚ï¼Œæœ‰æ—¶reviewå·¥å…·åªæ˜¾ç¤ºäº†4è¡Œä»£ç ï¼Œä½†æ˜¯è¿™å››è¡Œä»£ç ä½äºä¸€ä¸ªå‡ åä¸Šç™¾è¡Œçš„æ–¹æ³•ä¸­ï¼Œå¦‚æœä½ æŸ¥çœ‹äº†CLçš„ä¸Šä¸‹æ–‡ï¼Œå°±ä¼šæ„è¯†åˆ°è¿™ä¸ªå‡½æ•°çš„å®ç°éœ€è¦é€‚å½“æ‹†åˆ†æˆå‡ ä¸ªå°çš„å‡½æ•°ã€‚\nå°†æ•´ä¸ªç³»ç»Ÿçš„ä»£ç ä½œä¸ºContextæ¥åˆ¤å®šCLä»£ç è´¨é‡ä¹Ÿæ˜¯æœ‰å¿…è¦çš„ï¼Œå¦‚æœè¿™ä¸ªCLä¸­çš„ä»£ç è´¨é‡ä½äºç³»ç»Ÿæ•´ä½“ä»£ç çš„è´¨é‡ï¼Œè¯·ä¸è¦æ¥å—è¿™æ ·çš„ä»£ç ï¼Œè¿™å›å¯¼è‡´æ•´ä½“ä»£ç è´¨é‡çš„ä¸‹é™ã€‚\nGood Things # å¦‚æœCLä¸­æœ‰æ¯”è¾ƒå¥½çš„åšæ³•ï¼Œè¯·å‘Šè¯‰å¼€å‘è€…ï¼Œç‰¹åˆ«æ˜¯å¯¹äºä½ çš„ä¿®æ”¹å»ºè®®å¼€å‘è€…å¾ˆå¥½åœ°å®Œæˆçš„æ—¶å€™ã€‚ä»£ç reviewé€šå¸¸æ˜¯èšç„¦äºå¯èƒ½çš„é”™è¯¯ï¼Œä½†æ˜¯è¿™ä¸ªè¿‡ç¨‹ä¹Ÿç»™äº†æˆ‘ä»¬é¼“åŠ±ã€å­¦ä¹ good practicesçš„æœºä¼šã€‚Mentoringæœºåˆ¶ï¼Œæˆ‘ä»¬Tencentä¹Ÿæœ‰ï¼Œå»é¼“åŠ±æ–°äººå¦‚ä½•åšçš„æ›´å¥½ï¼Œæ¯”å‘Šè¯‰ä»–ä»¬å“ªé‡Œé”™äº†ï¼Œæ›´æœ‰ä»·å€¼ã€‚\nSummary # ç®€å•æ€»ç»“ä¸‹ï¼ŒCode reviewçš„æ—¶å€™ä¹Ÿç¡®ä¿å¦‚ä¸‹å‡ ç‚¹ï¼š\n ä»£ç æ˜¯å¦è®¾è®¡è‰¯å¥½ åŠŸèƒ½å¯¹äºä»£ç çš„ä½¿ç”¨è€…è€Œè¨€æ›´å‹å¥½ UIçš„æ”¹å˜æ˜¯æœ‰æ„ä¹‰çš„ å¹¶å‘å¤„ç†æ˜¯å®‰å…¨çš„ ä¸è¿›è¡Œè¿‡åº¦è®¾è®¡ï¼Œæ²¡æœ‰æ¼”å˜åˆ°é‚£ç§ä¸å¿…è¦çš„å¤æ‚ æ²¡æœ‰å»å®ç°ä¸€äº›å°†æ¥å¯èƒ½éœ€è¦ä½†æ˜¯ç°åœ¨ä¸éœ€è¦çš„ä¸œè¥¿ æä¾›äº†æœ‰æ•ˆçš„æµ‹è¯•ç”¨ä¾‹ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ç­‰ æµ‹è¯•æ˜¯æœ‰ç”¨çš„ï¼Œæµ‹è¯•æ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„ï¼Œä¸è¦å†™ä¸€å †æ²¡ç”¨çš„æµ‹è¯• å‘½åé€‰æ‹©éƒ½æ˜¯åˆç†çš„ï¼Œå¦‚å˜é‡åã€å‡½æ•°åç­‰ æ³¨é‡Šæ˜¯æœ‰ä»·å€¼çš„ã€æœ‰ç”¨çš„ï¼Œæ³¨é‡Šè§£é‡Šäº†whyè€Œä¸æ˜¯whatï¼Œå½“ç„¶ä¹Ÿæœ‰ä¾‹å¤– æ–‡æ¡£ä¸­å¯¹ä»£ç å˜æ›´ä¹Ÿè¿›è¡Œäº†åˆç†çš„è¡¥å…… ä»£ç éµå¾ªåˆ¶å®šå¥½çš„ä»£ç è§„èŒƒ  ç¡®ä¿é€è¡Œreviewåˆ†é…çš„ä»£ç ï¼ˆä»£ç ç”Ÿæˆå·¥å…·ç”Ÿæˆçš„å¯ä»¥å¿«é€Ÿæµè§ˆï¼‰ï¼Œå½“ç„¶ä½ å¯ä»¥åˆç†åˆ†é…reviewæ—¶é—´å¯¹éƒ¨åˆ†ä»£ç è¿›è¡Œé‡ç‚¹reviewï¼Œä½†è¯·ç¡®ä¿ä½ çœ‹æ‡‚äº†æ¯è¡Œä»£ç ã€‚æ³¨æ„code contextï¼Œç¡®ä¿æå‡æ•´ä½“ä»£ç è´¨é‡ï¼Œå¯¹äºreviewè¿‡ç¨‹ä¸­å‘ç°çš„good practicesé€‚å½“é¼“åŠ±å¼€å‘è€…ã€‚\nNavigating a CL in Review # ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†What to look forï¼Œå¦‚æœreviewæ¶‰åŠåˆ°å¤šä¸ªæ–‡ä»¶ï¼Œå¦‚ä½•æœ€é«˜æ•ˆåœ°è¿›è¡Œreviewå‘¢ï¼Ÿ\n reviewä¹‹å‰ï¼ŒæŸ¥çœ‹CLçš„æ•´ä½“è¡¨è¿°ï¼Œç¡®è®¤æ˜¯å¦æœ‰æ„ä¹‰ é¦–å…ˆï¼Œçœ‹CLä¸­æœ€æœ‰ä»·å€¼çš„éƒ¨åˆ†ï¼Œæ•´ä½“è®¾è®¡æ˜¯å¦è‰¯å¥½ ç„¶åï¼Œå†æ ¹æ®åˆç†é¡ºåºçœ‹CLä¸­å‰©ä½™çš„éƒ¨åˆ†  Step One: Take a broad view of the change # æŸ¥çœ‹CLæè¿°ï¼Œå…ˆç†è§£CLæ˜¯åšäº†ä»€ä¹ˆå·¥ä½œï¼Œè¿™ä¸ªCLæ˜¯å¦æœ‰æ„ä¹‰ã€‚å¦‚æœreviewerè§‰å¾—è¿™ä¸ªä¿®æ”¹æ²¡æœ‰æ„ä¹‰ï¼Œå¹¶å†³å®šæ‹’ç»è¯¥CLçš„æ—¶å€™ï¼Œè¯·é€‰æ‹©åˆé€‚çš„æªè¾å‘å¼€å‘è€…è§£é‡Šæ¸…æ¥šã€‚\nä¾‹å¦‚ï¼Œreviewerï¼šâ€œå“‡çœ‹ä¸Šå»ä½ åšäº†å¾ˆå¤šå·¥ä½œï¼Œéå¸¸æ„Ÿè°¢ï¼Œä½†æ˜¯æˆ‘ä»¬æœªæ¥æ–¹å‘æ˜¯è¦ç§»é™¤ä½ è¿™é‡Œä¿®æ”¹çš„FooWidgetç»„ä»¶ï¼Œå¦‚æœä½ æœ‰æ—¶é—´ï¼Œå¯ä»¥å¸®å¿™é‡æ„ä¸‹BarWidgetç»„ä»¶å—ï¼Ÿâ€\né€šèƒ½è¿‡è¿™ç§æ–¹å¼ï¼Œrevieweræ—¢å‘developer or contributorè¡¨æ˜äº†ç«‹åœºã€æ€åº¦ï¼Œä¹Ÿä¸å¤±ç¤¼è²Œï¼Œä¿æŒç¤¼è²Œæ˜¯é‡è¦çš„ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¼€æºé¡¹ç›®ï¼Œå³ä¾¿æ˜¯ä½ ä¸è®¤åŒè´¡çŒ®è€…çš„CLï¼Œä¹Ÿè‡³å°‘åº”çœ‹åˆ°ä»–å°è¯•è¿›è¡Œä»˜å‡ºã€‚ä¿æŒç¤¼è²Œçš„reviewã€è®¨è®ºã€æ²Ÿé€šæœ‰åŠ©äºç»´æŠ¤å¼€æºååŒçš„æ°›å›´ã€‚\nå¦‚æœä½ æ”¶åˆ°äº†ä¸å°‘CLsï¼Œä½†æ˜¯è¿™äº›éƒ½ä¸æ˜¯ä½ æƒ³è¦çš„ï¼Œå¯èƒ½å°±éœ€è¦ä»æ›´é«˜è§’åº¦å‡ºå‘æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚å®Œå–„ä¸‹Contributingæ–‡æ¡£ï¼Œå‘ŠçŸ¥å¼€å‘è€…é¡¹ç›®éœ€è¦ä»€ä¹ˆï¼Œå“ªäº›æ–¹é¢é¼“åŠ±ä¼˜å…ˆè§£å†³ç­‰ç­‰ã€‚\nStep Two: Examine the main parts of the CL # æ‰¾åˆ°CLæ¶‰åŠçš„æœ€ä¸»è¦ä¿®æ”¹éƒ¨åˆ†ï¼Œä¼˜å…ˆè¿›è¡Œreviewã€‚CLä¸­é€»è¾‘çš„å˜åŠ¨å¯èƒ½ä¸»è¦é›†ä¸­åœ¨å°‘æ•°å‡ ä¸ªæ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°è¿™äº›changesä¼˜å…ˆè¿›è¡Œreviewï¼Œè¿™æœ‰åŠ©äºèšç„¦ä¿®æ”¹çš„ä¸»è¦éƒ¨åˆ†ï¼ŒåŠ é€Ÿæ•´ä½“çš„reviewè¿›åº¦ã€‚å¦‚æœCLæ¶‰åŠä»£ç å¤ªå¤šï¼Œå¾ˆéš¾è¯†åˆ«å“ªéƒ¨åˆ†æ˜¯ä¸»è¦éƒ¨åˆ†ï¼Œé‚£å¯ä»¥å…ˆé—®ä¸‹å¼€å‘è€…å“ªéƒ¨åˆ†æ˜¯ä¸»è¦ä¿®æ”¹ï¼Œæˆ–è€…è®©å¼€å‘è€…æŠŠå½“å‰è¿™æ¬¡CLæ‹†åˆ†æˆå¤šä¸ªCLsï¼Œç„¶åå†å‘èµ·reviewã€‚\nå¦‚æœåœ¨review CLä¸»è¦éƒ¨åˆ†çš„æ—¶å€™ï¼Œå‘ç°è®¾è®¡ä¸Šæ˜æ˜¾å­˜åœ¨ä¸åˆç†çš„åœ°æ–¹ï¼Œrevieweråº”è¯¥ç«‹å³å‘é€review commentsç»™å¼€å‘è€…ï¼Œå…¶ä»–çš„ä»£ç å¯ä»¥ä¸ç”¨reviewäº†ï¼Œç»§ç»­reviewçº¯ç²¹æ˜¯æµªè´¹æ—¶é—´ã€‚å› ä¸ºæ—¢ç„¶å­˜åœ¨æ˜æ˜¾çš„è®¾è®¡é—®é¢˜ï¼Œç­‰å¼€å‘è€…ä¿®æ”¹ä¹‹åï¼Œå‰©ä½™çš„è¦reviewçš„ä»£ç å¯èƒ½æ ¹æœ¬ä¸å­˜åœ¨äº†ã€‚\nå‘ç°æœ‰æ˜æ˜¾è®¾è®¡é—®é¢˜ï¼Œç«‹å³å‘é€design review commentsï¼Œè¿˜æœ‰ä¸¤ä¸ªå¥½å¤„ï¼š\n å¼€å‘è€…å¯èƒ½ä¼šå‘èµ·ä¸€ä¸ªCLä¹‹åï¼Œä¼šç«‹å³åœ¨è¿™ä¸ªCLçš„åŸºç¡€ä¸Šç»§ç»­è¿›è¡Œå…¶ä»–çš„ä¿®æ”¹å·¥ä½œã€‚å¦‚æœå‰é¢çš„CLå­˜åœ¨æ˜æ˜¾çš„è®¾è®¡é—®é¢˜ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ä¼šå°†è¿™é‡Œçš„é—®é¢˜ç»§ç»­å¸¦å…¥åˆ°åç»­çš„CLä¸­ï¼Œå¹¶ç»§ç»­å‘èµ·æ–°çš„Code reviewã€‚æ‰€ä»¥å°½å¿«å‘é€è®¾è®¡ä¸Šçš„reviewæ„è§ä¸€å®šç¨‹åº¦ä¸Šä¼šé¿å…ã€å‡å°‘è¿™ç±»é—®é¢˜çš„å‘ç”Ÿï¼Œé¿å…åç»­reviewé‡å¤è§£å†³åŒä¸€ç±»é—®é¢˜ã€‚ ä¸»è¦çš„è®¾è®¡å˜æ›´ï¼Œæ¯”å…¶ä»–å°ä¿®å°è¡¥ï¼ŒèŠ±è´¹çš„æ—¶é—´æ›´å¤šï¼Œæ¯ä¸ªå¼€å‘è€…æ’éœ€æ±‚éƒ½æ˜¯æœ‰deadlineçš„ï¼ŒåŠæ—¶å‘é€reviewæ„è§æœ‰åŠ©äºåœ¨deadlineä¹‹å‰ï¼Œè®©å¼€å‘è€…ä»ç„¶ç”±æœºä¼šå¯¹è®¾è®¡åšå‡ºè°ƒæ•´ï¼Œä»¥ä¿è¯é¡¹ç›®è¿›åº¦ï¼Œåˆèƒ½å…¼é¡¾æ•´ä½“ä»£ç è´¨é‡ã€‚  Step Three: Look through the rest of the CL in an appropriate sequence # ä¸€æ—¦ç¡®å®šCLä¸­ä¸»ä½“ä»£ç æ²¡æœ‰æ˜æ˜¾çš„è®¾è®¡é—®é¢˜ï¼Œå°±å¯ä»¥æŒ‰ç…§åˆç†çš„é¡ºåºreviewå‰©ä¸‹çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚æŒ‰ç…§é€»è¾‘å¤„ç†çš„é¡ºåºæ¥reviewï¼Œreviewerå¯ä»¥æ ¹æ®é€»è¾‘å¤„ç†ä¸­çš„è¿‡ç¨‹ã€åˆ†æ”¯åˆ¤æ–­æ¥reviewç›¸å…³çš„ä»£ç ï¼Œä»è€Œç¡®ä¿ä¸é—æ¼æ¯ä¸€è¡Œå˜æ›´ã€‚\né€šå¸¸reviewå®ŒCLçš„ä¸»ä½“éƒ¨åˆ†ä¹‹åï¼Œreviewå‰©ä¸‹çš„éƒ¨åˆ†å°±ç›¸å¯¹ç®€å•å¤šäº†ã€‚æœ‰æ—¶é˜…è¯»æµ‹è¯•ç”¨ä¾‹å¯¹äºreviewä»£ç ä¹Ÿæ˜¯æœ‰å¸®åŠ©çš„ï¼Œæ¯”å¦‚ï¼Œé€šè¿‡æµ‹è¯•ç”¨ä¾‹ä½ èƒ½æ¸…æ¥šåœ°çŸ¥é“å„ä¸ªå‡½æ•°å‚æ•°çš„å«ä¹‰ï¼Œå¦‚ä½•ä½¿ç”¨è¯¥å‡½æ•°ï¼Œå½“ç„¶ä½ å¯ä»¥è”æƒ³åˆ°ä¸€äº›è¾¹ç•Œæ¡ä»¶ï¼Œå¸¦ç€è¿™äº›é—®é¢˜å»review CLä¸»ä½“ä»£ç æ•ˆæœä¹Ÿä¸é”™ã€‚\nSpeed of Code Reviews # Why Should Code Reviews Be Fast? # Googleå¯¹äºSpeedçš„è¿½æ±‚ï¼Œæ›´æœŸæœ›çš„æ˜¯å›¢é˜Ÿèƒ½å¤Ÿæ›´å¿«æ›´å¥½åœ°ç”Ÿäº§ä¸€ä¸ªå¥½çš„äº§å“çš„é€Ÿåº¦ï¼Œè€Œä¸æ˜¯ä¸ªäººå¼€å‘è€…ç¼–ç çš„é€Ÿåº¦ï¼Œå½“ç„¶è¿™å¹¶ä¸æ˜¯è¯´å¼€å‘è€…çš„å¼€å‘æ•ˆç‡å°±ä¸é‡è¦ã€‚å›¢é˜Ÿæ•´ä½“æ¨è¿›çš„é€Ÿåº¦æ˜¯éå¸¸é‡è¦çš„ï¼Œå®ƒå…³ç³»åˆ°äº§å“è¿­ä»£çš„è¿›åº¦ï¼Œå…³ç³»åˆ°å›¢é˜Ÿçš„æ°›å›´ï¼Œå…³ç³»åˆ°æ¯ä¸ªå¼€å‘è€…çš„æ„Ÿå—ï¼Œè®¾ç½®æ˜¯ä»–ä»¬çš„æ—¥å¸¸ç”Ÿæ´»ã€‚\nåœ¨è¿½æ±‚é€Ÿåº¦çš„è¿‡ç¨‹ä¸­ï¼ŒCode reviewçš„é€Ÿåº¦æ‰®æ¼”è€…ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„è§’è‰²ã€‚å¦‚æœreviewé€Ÿåº¦å¾ˆæ…¢ï¼Œå¯èƒ½ä¼šå‘ç”Ÿï¼š\n  å›¢é˜Ÿæ•´ä½“æ¨è¿›çš„é€Ÿåº¦è¢«ä¸¥é‡æ‹–æ…¢ã€‚\nå¦‚æœrevieweræ²¡æœ‰å¯¹CLè¿›è¡Œå¿«é€Ÿçš„å“åº”ï¼Œå¯èƒ½å°±ä¼šè€½è¯¯CLä½œè€…çš„å…¶ä»–åç»­å·¥ä½œï¼Œå› ä¸ºå®ƒå¯èƒ½è¦åœ¨æ­¤CLä¸Šå¼€å±•å…¶ä»–å·¥ä½œã€‚å¦‚æœè¿™é‡Œçš„ä¿®æ”¹æ˜¯è§£å†³ä¸€ä¸ªçº¿ä¸Šbugã€é‡è¦çš„featuresç­‰ï¼Œå¦‚æœæç½®æ¢ä¸€ä¸ªå‡ å¤©ã€å‘¨ã€æœˆï¼Œè¿™ç§é¡¹ç›®é€Ÿåº¦æ˜¯ä¸å¯æ¥å—çš„ã€‚\n  å¼€å‘è€…å¼€å§‹æŠ—è®®æˆ–è€…ä¸é‡è§†Code reviewã€‚\nå¦‚æœä¸€ä¸ªrevieweræ¯éš”å‡ å¤©æ‰å›å¤ä¸€æ¬¡CL reviewæ„è§ï¼Œä½†æ˜¯æ¯æ¬¡reviewæ„è§éƒ½è¦æ±‚CLä½œè€…è¿›è¡Œä¿®æ”¹ï¼Œå¯¹äºCLä½œè€…è¿™ç§ä½“éªŒæ˜¯éå¸¸æ²®ä¸§çš„ï¼Œå¼€å‘è€…å¯èƒ½ä¼šæŠ±æ€¨è¿™æ ·çš„reviewerï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆreviewä¸ªä»£ç è¿™ä¹ˆè‹›åˆ»ã€‚ä½†æ˜¯å¦‚æœreviewerèƒ½å¤Ÿå¿«é€Ÿã€åŠæ—¶åœ°å›å¤reviewæ„è§ï¼Œè¿™ç§æŠ±æ€¨å¾€å¾€ä¼šæ¶ˆå¤±äº†ã€‚å¤§å®¶åœ¨æ„çš„ä¸æ˜¯CLæœ‰æ²¡æœ‰é—®é¢˜ï¼Œè€Œæ˜¯reviewerçš„æ€ æ…¢ã€ååº”è¿Ÿç¼“ã€‚æ‰€ä»¥reviewerè¦å°½å¿«å›å¤reviewæ„è§ã€‚\n  ä»£ç æ•´ä½“å¥åº·åº¦ä¼šå—åˆ°å½±å“ã€‚\nå¦‚æœreviewé€Ÿåº¦è¿‡æ…¢ï¼Œå°±ä¼šç»™å¼€å‘äººå‘˜ã€revieweräººå‘˜æŒç»­å¸¦æ¥æ›´å¤šçš„å‹åŠ›ï¼Œè¿™æ„å‘³ç€å¼€å‘äººå‘˜ä¼šæäº¤æ›´å¤šä¸ç¬¦åˆæ ‡å‡†çš„CLsï¼Œrevieweräººå‘˜éœ€è¦å›å¤ã€æ‹’ç»ã€è§£é‡Šã€äºŒæ¬¡reviewçš„å·¥ä½œåšä¼šæ›´å¤šã€‚è¿›ä¸€æ­¥ï¼Œä¹Ÿä¼šé™ä½å¼€å‘è€…ä»£ç æ¸…ç†ã€é‡æ„ã€ä¼˜åŒ–çš„ç§¯ææ€§ï¼Œå¯¼è‡´æ•´ä½“ä»£ç è´¨é‡ä¸‹é™ã€‚\n  How Fast Should Code Reviews Be? # å¦‚æœå½“å‰æ²¡æœ‰å¯¹ä¸“æ³¨åº¦è¦æ±‚å¾ˆé«˜çš„ä»»åŠ¡çš„è¯ï¼Œrevieweråº”è¯¥ç«‹å³æˆ–è€…ç¨åè¿›è¡Œreviewã€‚\nä¸€ä¸ªå·¥ä½œæ—¥ï¼Œè¿™ä¸ªæ˜¯Googleå†…éƒ¨æŒ‡å®šçš„ä¸Šé™ï¼Œåœ¨Code reviewå‘èµ·çš„ä¸€ä¸ªå·¥ä½œæ—¥å†…ï¼Œreviewerå¿…é¡»è¿›è¡Œreviewã€‚\nå¦‚æœä¸€ä¸ªCLè¿›è¡Œreviewä¹‹åï¼Œæå‡ºäº†ä¿®æ”¹æ„è§ï¼Œå¹¶ä¸”CLä½œè€…è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¸€å¤©ä¹‹å†…å¯èƒ½è¦è¿›è¡Œå¤šè½®reviewï¼Œå°½é‡ä¸è¦æ‹–åˆ°ç¬¬äºŒå¤©ï¼Œè·¨å¤©å°±ä¸å¤ªå¥½äº†ã€‚\nSpeed vs. Interruption # å¯¹äºreviewé€Ÿåº¦å’Œä¸ªäººå·¥ä½œä¸“æ³¨åº¦ä¹‹é—´éœ€è¦åšä¸ªæƒè¡¡ï¼Œå¦‚æœæ­£åœ¨è¿›è¡ŒæŸäº›å¯¹ä¸“æ³¨åº¦è¦æ±‚æ¯”è¾ƒé«˜çš„ä»»åŠ¡ï¼Œå¦‚æ­£åœ¨å†™ä»£ç ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ˜¯ä¸è¦è®©è‡ªå·±çš„å·¥ä½œä¸­æ–­ã€‚ç ”ç©¶è¡¨æ˜å¼€å‘è€…è¢«ä¸­æ–­ä¹‹åï¼Œå†å›åˆ°ä¹‹å‰çš„å·¥ä½œï¼Œæ˜¯éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´çš„ï¼Œä¸ºäº†è¿½æ±‚reviewè¿›åº¦åè€Œæ‹–æ…¢äº†ä¸ªä½“å¼€å‘è¿›åº¦ï¼Œåè¿‡æ¥ä¹Ÿå¯èƒ½ä¼šæ‹–æ…¢é¡¹ç›®æ•´ä½“è¿›åº¦ã€‚\næ‰€ä»¥å»ºè®®åœ¨å½“å‰æ²¡æœ‰å¯¹ä¸“æ³¨åº¦è¦æ±‚å¾ˆé«˜çš„æ—¶é—´è¿›è¡Œreviewï¼Œæ¯”å¦‚ä½ å†™å®Œä¸€æ®µå…³é”®ä»£ç ä¹‹åï¼Œæˆ–è€…åƒå®Œåˆé¥­ã€åˆä¼‘ä¹‹åï¼Œç­‰ç­‰ï¼Œè¿™ä¸ªå°±è¦æ ¹æ®è‡ªå·±æƒ…å†µé€‰æ‹©äº†ã€‚\nFast Responses # æˆ‘ä»¬è°ˆè®ºCode reviewçš„é€Ÿåº¦ï¼Œå…¶å®å¼ºè°ƒçš„æ˜¯CLçš„reviewæ„è§çš„å›å¤é€Ÿåº¦ï¼Œè€Œä¸æ˜¯CLæœ€ç»ˆé€šè¿‡çš„é€Ÿåº¦ã€‚å½“ç„¶ï¼Œå¦‚æœreviewæ„è§å›å¤é€Ÿåº¦å¤Ÿå¿«ï¼ŒCLä½œè€…ä¿®æ”¹ä¹Ÿä¼šæ›´å¿«ï¼ŒCLæ•´ä½“é€šè¿‡é€Ÿåº¦ä¹Ÿä¼šå¿«äº›ã€‚\nå°½ç®¡CLæ•´ä½“é€šè¿‡è€—æ—¶å¯èƒ½æ¯”è¾ƒä¹…ï¼Œç»´æŒæ¯”è¾ƒå¿«çš„CL reviewæ„è§è¿˜æ˜¯å¾ˆé‡è¦ï¼ŒCLä½œè€…ä¸ä¼šå› ä¸ºreviewè¿‡æ…¢è€Œæ²®ä¸§ã€‚\nå¦‚æœä½ ç°åœ¨å¤ªå¿™äº†ï¼Œå®åœ¨æ²¡æœ‰æ—¶é—´å¯¹CLè¿›è¡Œå®Œæ•´çš„reviewï¼Œä½ ä¹Ÿå¯ä»¥å‘é€ä¸€ä¸ªå›å¤ä¿¡æ¯è®©å¼€å‘è€…çŸ¥é“ä½ å¤§çº¦ä¼šåœ¨ä»€ä¹ˆæ—¶é—´æ®µè¿›è¡Œreviewï¼Œå¥½è®©ä»–å¿ƒç†æœ‰åº•ï¼Œä»–ä¹Ÿå¯ä»¥ç»§ç»­å®‰æ’è‡ªå·±æ¥ä¸‹æ¥çš„å·¥ä½œã€‚æˆ–è€…ä½ ä¹Ÿå¯ä»¥é‚€è¯·å…¶ä»–åˆé€‚çš„reviewä»£ä½ è¿›è¡Œreviewã€‚è¿™é‡Œå¹¶ä¸æ˜¯è¯´ä½ å°±è¦ç«‹å³æ”¾ä¸‹æ‰‹é‡Œçš„ç¼–ç å·¥ä½œç«‹å³å»å›å¤ï¼Œä½ å¯ä»¥é€‰ä¸ªç¨å¾®å¯ä»¥æ”¾æ¾éš¾ç‚¹çš„æ—¶é—´å»å›å¤ï¼Œæ¯”å¦‚ä½ åˆšåˆšå†™å®Œä¸€æ®µå…³é”®ä»£ç ï¼Œå¤§è„‘å¯ä»¥ç¨å¾®ä¼‘æ¯å‡ åˆ†é’Ÿçš„æ—¶å€™ã€‚\nreviewersèŠ±è´¹è¶³å¤Ÿçš„æ—¶é—´è¿›è¡Œreviewæ˜¯å¾ˆé‡è¦çš„ï¼Œæ—¶é—´å……è¶³ï¼Œreviewerå›å¤â€œLGTMâ€æ‰æ›´æœ‰åº•æ°”ã€‚CLä¸­æ¯ä¸ªæ„è§çš„å›å¤è¿˜æ˜¯è¦èƒ½å¿«å°±å¿«ã€‚\nCross-Time-Zone Reviews # å¦‚æœreviewæ¶‰åŠåˆ°å¤šåœ°çš„ã€ä¸åŒæ—¶åŒºçš„å¼€å‘äººå‘˜ï¼Œrevieweræœ€å¥½èƒ½åœ¨CLä½œè€…è¿˜åœ¨å…¬å¸å·¥ä½œçš„æ—¶å€™ç»™åˆ°å›å¤reviewæ„è§ï¼Œå¦‚æœå¼€å‘äººå‘˜å·²ç»ä¸‹ç­å›å®¶äº†ï¼Œå°½é‡åœ¨éš”æ—¥å¼€å‘äººå‘˜ä¸Šç­å‰å®Œæˆreviewï¼Œå°½é‡ä¸è¦ä¸­æ–­ã€delayä»–äººçš„å·¥ä½œã€‚\nLGTM With Comments # ä¸ºäº†åŠ é€ŸCode reviewæ•´ä½“é€šè¿‡è¿›åº¦ï¼Œæœ‰äº›åœºæ™¯ä¸‹ï¼Œå³ä¾¿å¼€å‘è€…æ²¡æœ‰å®Œå…¨å®Œæˆreviewerçš„ä¿®æ”¹æ„è§ï¼Œreviewerå¯èƒ½ä¹Ÿä¼šç»™é€šè¿‡â€œLGTMâ€ or â€œApprovalâ€ï¼Œè¿™å‡ ç§æƒ…å†µä¸‹æ˜¯å…è®¸çš„ï¼š\n revieweræœ‰ä¿¡å¿ƒï¼Œå¼€å‘è€…ä¼šåœ¨ä¹‹åä¸ä¹…å®ŒæˆæåŠçš„ä¿®æ”¹æ„è§ å‰©ä½™çš„è¿˜æœªä¿®æ”¹ä¹‹å¤„ï¼Œæ˜¯äº›å¾®å°çš„ä¿®æ”¹ï¼Œå¯ä»¥åé¢æ”¹ï¼Œæˆ–è€…ä¸ä¸€å®šè¦å½“å‰å¼€å‘è€…æ¥ä¿®æ”¹  revieweré’ˆå¯¹ä¸Šè¿°ä¸¤ä¸ªæƒ…å†µï¼Œåœ¨LGTMçš„æ—¶å€™åº”è¯¥æ³¨æ˜æ˜¯å“ªç§æƒ…å†µã€‚LGTM With Commentså¯¹äºå¤šåœ°ã€è·¨æ—¶åŒºçš„å¼€å‘è€…è€Œè¨€ï¼Œæ˜¯æ¯”è¾ƒæœ‰ä»·å€¼çš„ï¼Œå› ä¸ºrevieweræœ€ç»ˆç»™LGTMæˆ–è€…Approvalå¯èƒ½è¦éš”ä¸€å¤©çš„æ—¶é—´å‘¢ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæ¯”è¾ƒä¹…ï¼Œå¦‚æœæ˜¯LGTMçš„åŒæ—¶é™„å¸¦ä¸Šreviewerå¯¹å¼€å‘è€…çš„ä¸€ç‚¹å°æœŸæœ›ï¼Œå¼€å‘è€…åç»­å†ä¿®æ”¹ã€ä¼˜åŒ–ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ¯•ç«Ÿè¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¯æ— ä¼¤å¤§é›…çš„äº‹æƒ…ã€‚\nLarge CLs # å¦‚æœå¼€å‘è€…æäº¤çš„ä¸€ä¸ªCLéå¸¸å¤§ï¼Œä»¥è‡³äºä½ ä¸çŸ¥é“è¦ä»å“ªå¼€å§‹çœ‹èµ·ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è¦æ±‚å¼€å‘è€…å°†è¿™ä¸ªå¤§çš„CLæ‹†åˆ†æˆå‡ ä¸ªå°çš„CLï¼ŒCL2 build on CL1ï¼Œ CL3 build on CL2\u0026hellip; ç„¶åå†è¿›è¡Œreviewã€‚è¿™å¯¹reviewerè€Œè¨€æ˜¯æ¯”è¾ƒæœ‰å¸®åŠ©çš„ï¼Œå¯¹å¼€å‘è€…è€Œè¨€å¯èƒ½éœ€è¦é¢å¤–çš„ä¸€ç‚¹å·¥ä½œã€‚\nå¦‚æœæ¢ä¸€ä¸ªCLæ— æ³•æ‹†åˆ†æˆå¤šä¸ªå°çš„CLsï¼Œå¹¶ä¸”ä½ çœ¼ä¸‹ä¹Ÿæ²¡æœ‰æ—¶é—´å»å¿«é€Ÿåœ°å®Œæˆæ•´ä½“çš„reviewï¼Œå¯ä»¥è€ƒè™‘çœ‹ä¸‹æ•´ä½“è®¾è®¡ï¼Œå›å¤ä¸‹å¯¹æ•´ä½“è®¾è®¡çš„æ„è§ï¼Œå¼€å‘è€…å¯ä»¥å…ˆè¿›è¡Œé€‚å½“çš„ä¼˜åŒ–ã€‚reviewerçš„ç›®æ ‡ï¼Œå°±æ˜¯æ¿€åŠ±å¼€å‘è€…æŒç»­åœ°å¯¹ä»£ç è´¨é‡è¿›è¡Œæå‡ã€‚\nCode Review Improvements Over Time # æŒç»­åœ°éµå¾ªä¸Šè¿°çš„Code reviewæµç¨‹ï¼ŒåšæŒä¸‹å»ï¼Œå°±ä¼šå‘ç°è‡ªå·±åœ¨reviewä»£ç çš„æ—¶å€™ï¼Œå¤„ç†åœ°è¶Šæ¥è¶Šå¥½ã€è¶Šæ¥è¶Šå¿«ã€‚å¼€å‘è€…ä¹Ÿèƒ½å¤Ÿå­¦ä¹ åˆ°ç¬¦åˆä»£ç è´¨é‡è¦æ±‚çš„ä»£ç åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œåç»­æäº¤çš„CLsä¹Ÿä¼šå˜å¾—è¶Šæ¥è¶Šåˆç†ï¼ŒèŠ±è´¹çš„reviewerçš„æ—¶é—´ä¹Ÿä¼šè¶Šæ¥è¶Šå°‘ã€‚reviewerä¹Ÿä¼šæ›´å¿«åœ°è¿›è¡Œreviewæ„è§å›å¤ï¼Œå¯¹äºæ•´ä½“reviewè¿›åº¦delayçš„æ—¶é—´ä¹Ÿä¼šè¶Šæ¥è¶Šå°‘ã€‚\nä½†æ˜¯ï¼Œä½†æ˜¯ï¼Œä½†æ˜¯â€¦â€¦ä¸è¦ä¸ºäº†â€œå¿«â€è€Œé™ä½Code reviewæ ‡å‡†æˆ–è€…ç ´åæ•´ä½“ä»£ç çš„è´¨é‡ã€‚\nEmergencies # ä¹Ÿå­˜åœ¨ä¸€äº›éå¸¸ç´§æ€¥çš„æƒ…å†µï¼Œè¿™äº›æƒ…å†µä¸‹CLså¯èƒ½å¿…é¡»éå¸¸å¿«åœ°é€šè¿‡reviewè¿‡ç¨‹ï¼Œè¿™ç§æƒ…å†µä¸‹reviewæ—¶çš„è¦æ±‚å¯ä»¥é€‚å½“æ”¾ä½ã€‚åœ¨åº”ç”¨è¿™é‡Œçš„EmergenciesæŒ‡å¼•ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹What is An Emergency?ï¼ŒåŒºåˆ†ä»€ä¹ˆæ˜¯ç´§æ€¥åœºæ™¯ï¼Œä»€ä¹ˆä¸æ˜¯ï¼Œé¿å…æ»¥ç”¨ã€‚\nHow to Write Code Review Comments # Summary #  ä¿æŒå‹å¥½ è§£é‡ŠåŸå›  æƒè¡¡â€œç»™å‡ºå¯èƒ½çš„æ–¹æ¡ˆå¹¶æŒ‡å‡ºé—®é¢˜â€ã€â€œç»™å‡ºå¯èƒ½çš„æ–¹æ¡ˆè®©å¼€å‘è€…è‡ªä¸»å†³ç­–â€ä¸¤ç§æ–¹å¼ é¼“åŠ±å¼€å‘è€…ç®€åŒ–ä»£ç ï¼Œé¼“åŠ±å¼€å‘è€…æ·»åŠ æ³¨é‡Šï¼Œè€Œä¸æ˜¯è§£é‡Šé—®é¢˜æœ‰å¤šå¤æ‚  Courtesy # reviewåˆ«äººä»£ç çš„æ—¶å€™ï¼Œä¿æŒç¤¼è²Œã€å°Šé‡æ˜¯éå¸¸é‡è¦çš„ï¼Œè‡³å°‘ä¸è¦è®©å¼€å‘è€…ã€è´¡çŒ®è€…æ„Ÿè§‰åˆ°æ˜æ˜¾çš„ä¸é€‚ï¼Œå¦‚ä½•åšåˆ°è¿™ç‚¹å‘¢ï¼Ÿä¸€ä¸ªæ¯”è¾ƒå¥½çš„åŠæ³•å°±æ˜¯åœ¨å†™reviewæ„è§çš„æ—¶å€™ï¼Œåªå¯¹codeæœ¬èº«è¿›è¡Œè¯„è®ºï¼Œä¸è¦å¯¹å¼€å‘è€…æœ¬äººè¿›è¡Œè¯„è®ºï¼Œå¯¹äºæŸäº›äººç§°ä»£è¯æ˜¯å¦æœ‰å¿…è¦å‡ºç°ï¼Œä¹Ÿéœ€è¦æ–Ÿé…Œä¸‹ã€‚\nä¸¾ä¸ªä¾‹å­ï¼š\nBadï¼šâ€œ%#@!$ è¿™ä¸ªåœºæ™¯ä¸‹å¤šçº¿ç¨‹å¹¶ä¸ä¼šæœ‰å¤ªå¤§çš„æ€§èƒ½æå‡ï¼Œä¸ºä»€ä¹ˆä½ è¦ç”¨å¤šçº¿ç¨‹ï¼Ÿâ€\nGoodï¼šâ€œå¤šçº¿ç¨‹å¹¶å‘å¢åŠ äº†å¤æ‚æ€§ï¼Œä½†%#@!$ åœºæ™¯ä¸‹æ”¶åˆ°çš„æ€§èƒ½æå‡å¹¶ä¸æ˜æ˜¾ï¼Œæœ€å¥½ç”¨å•çº¿ç¨‹æ¨¡å‹ä»£æ›¿å¤šçº¿ç¨‹ã€‚â€\nExplain Why # ä¸Šé¢å±•ç¤ºçš„è¿™ä¸ªgood exampleå‘å¼€å‘è€…è§£é‡Šäº†reviewä¸é€šè¿‡çš„åŸå› ï¼ŒåŒæ—¶ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆå¤šçº¿ç¨‹æ¨¡å‹åœ¨è¿™ä¸ªåœºæ™¯ %#@!$ ä¸‹å¹¶ä¸å¥½ï¼Œå¼€å‘è€…å°±ä¼šä»ä¸­å­¦ä¹ ï¼Œæ„è¯†åˆ°è‡ªå·±çš„æ–¹æ¡ˆå­˜åœ¨çš„é—®é¢˜ï¼Œå¹¶è¿›è¡Œä¼˜åŒ–ã€‚\nå½“ç„¶ä¸éœ€è¦æ¯æ¬¡reviewçš„æ—¶å€™éƒ½è¿›è¡Œå¤§ç¯‡å¹…çš„è§£é‡Šï¼Œä½†æ˜¯é€‚å½“çš„è§£é‡Šæ˜¯æœ‰å¿…è¦çš„ã€‚\nGiving Guidance # ä¿®å¤ä¸€ä¸ªCLä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œæ˜¯CLå¼€å‘è€…çš„è´£ä»»ï¼Œè€Œä¸æ˜¯reviewerçš„è´£ä»»ã€‚æ²¡æœ‰è¦æ±‚reviewerè¦ä»£æ›¿å¼€å‘è€…ç»™å‡ºä¸€ä¸ªå®Œæ•´çš„è¯¦ç»†è®¾è®¡ï¼Œæˆ–è€…äº²è‡ªå¸®åŠ©å…¶å†™ä»£ç ã€‚\nä½†æ˜¯è¿™å¹¶ä¸æ„å‘³ç€reviewerå¯ä»¥æ— è§†ï¼Œä¸å»ä¸»åŠ¨å¸®åŠ©ä»–äººï¼Œç‰¹åˆ«æ˜¯åœ¨CLå¼€å‘è€…ç¡®å®getä¸åˆ°reviewerçš„ç‚¹æˆ–è€…æŸæ‰‹æ— ç­–çš„æ—¶å€™ï¼Œreviewerå¯ä»¥é€‰æ‹©æ€§çš„æŒ‡å‡ºé—®é¢˜ï¼Œå¹¶ç»™å‡ºä¸€ä¸ªç›´æ¥çš„æŒ‡å¼•ï¼Œæˆ–è€…ç»™å‡ºå‡ ä¸ªå¤‡é€‰æ–¹æ¡ˆè®©å¼€å‘è€…å»å¯¹æ¯”ã€é€‰æ‹©ï¼Œæˆ–è€…ç»™ä¸€ä¸ªç®€å•çš„è®¾è®¡è®©å¼€å‘è€…å»è¿›ä¸€æ­¥ç»†åŒ–ã€å®Œå–„ï¼Œæˆ–è€…å¯ä»¥å†™ä¸€ä¸ªç®€å•çš„demoä»¥ä¾›å¼€å‘è€…å‚è€ƒã€‚è¿™ä¹Ÿæ˜¯Mentoringç²¾ç¥çš„ä¸€ç§å‘æ‰¬å§ï¼Œè¿™å¯ä»¥å¸®åŠ©å¼€å‘è€…å­¦ä¹ ï¼Œä½¿å¾—Code reviewå˜å¾—æ›´åŠ ç®€å•ã€æ­£å‘ã€ç§¯æã€‚æœ€ç»ˆè¾¾æˆçš„ç»“æœä¹Ÿå¾€å¾€æ›´å¥½ã€‚\nCode reviewè¿½æ±‚çš„ç¬¬ä¸€ç›®æ ‡å°±æ˜¯å°½å¯èƒ½é«˜è´¨é‡çš„CLï¼Œç¬¬äºŒç›®æ ‡å°±æ˜¯æå‡å¼€å‘è€…çš„æŠ€èƒ½ï¼Œè¿™æ ·åç»­çš„å¼€å‘ã€Code reviewå·¥ä½œéƒ½ä¼šå˜å¾—è¶Šæ¥è¶Šç®€å•ã€ç§¯æï¼ŒæŠ€æœ¯ä¼ æ‰¿ä¹Ÿæ›´åŠ æ¸©å’Œã€æœ‰æ•ˆã€‚\nAccepting Explanations # å¦‚æœrevieweræœ‰æ®µä»£ç ä¸å¤ªæ‡‚ï¼Œå¹¶è¯·å¼€å‘è€…è¿›è¡Œè§£é‡Šçš„è¯ï¼Œæœ€ç»ˆçš„ç»“æœå¾€å¾€æ˜¯å¼€å‘è€…éœ€è¦é‡å†™è¿™æ®µä¸æ¸…æ™°çš„ä»£ç ã€‚å¶å°”ï¼Œä»£ç ä¸­æ·»åŠ æ³¨é‡Šä¹Ÿæ˜¯ä¸€ç§ç±»ä¼¼äºâ€œè§£é‡Šâ€çš„å›åº”ï¼Œä½†æ˜¯å¦‚æœä»£ç å®ç°å¤ªè¿‡å¤æ‚ï¼Œè¯¥é‡å†™è¿˜æ˜¯è¦é‡å†™ï¼Œä¸èƒ½ç”¨æ³¨é‡Šè§£é‡Šï¼Œå¥—é€ƒè„±åº”è¯¥ç®€åŒ–ã€é‡æ„çš„å·¥ä½œã€‚\nä»£ç reviewå·¥å…·ä¸­å¡«å†™çš„è§£é‡Šï¼ˆå¯¹reviewerç–‘é—®çš„è§£é‡Šï¼‰å¯¹å°†æ¥é˜…è¯»ä»£ç çš„äººçš„å¸®åŠ©å¾®ä¹å…¶å¾®ï¼Œè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œé˜…è¯»å·¥ç¨‹ä»£ç æ—¶ï¼Œåˆ«äººå¾ˆå°‘ä¼šå»ç¿»ä¹‹å‰çš„reviewæ„è§ï¼Œè€Œè¦ç­‰åˆ°ç¿»reviewæ„è§çš„æ—¶å€™ï¼Œæ„å‘³ç€è¿™é‡Œçš„ä»£ç å¯èƒ½å·²ç»éœ€è¦é‡å†™äº†ã€‚\né€šè¿‡æ³¨é‡Šçš„æ–¹å¼æ¥è§£é‡Šä»£ç çš„è¡Œä¸ºï¼Œå¾€å¾€åªåœ¨å¾ˆå°‘çš„å‡ ç§åœºæ™¯ä¸‹æœ‰æ•ˆï¼Œæ¯”å¦‚åœ¨reviewä¸€ä¸ªè‡ªå·±ä¸å¤ªç†Ÿæ‚‰çš„é¢†åŸŸçš„ä»£ç æ—¶ï¼Œå¦‚æœæœ‰æ³¨é‡Šrevieweræ›´å®¹æ˜“ç†è§£ï¼Œä½†æ˜¯å¯¹äºç†ŸçŸ¥è¿™ä¸ªé¢†åŸŸçš„äººè€Œè¨€ï¼Œè¿™äº›æ³¨é‡Šå¯èƒ½éƒ½æ˜¯äº›å¸¸è¯†ï¼Œæ˜¯å¤šä½™çš„ã€‚\nHandling Pushback in Code Reviews # Handling Pushback in Code Reviews # æœ‰æ—¶å€™ï¼Œreviewerçš„æ„è§å¼€å‘è€…ä¼šâ€œæ€¼â€å›æ¥ï¼Œå¯èƒ½æ˜¯å¼€å‘è€…ä¸åŒæ„reviewerçš„å»ºè®®ï¼Œä¹Ÿå¯èƒ½æ˜¯æŠ±æ€¨reviewerè¿‡äºè‹›åˆ»ã€‚\nWho is Right? # å½“å¼€å‘è€…ä¸åŒæ„reviewerçš„å»ºè®®æ—¶ï¼Œrevieweråº”è¯¥åœä¸‹æ¥å…ˆæƒ³æƒ³ä»–ä»¬çš„æƒ³æ³•æ˜¯ä¸æ˜¯å¯¹çš„ã€‚é€šå¸¸ï¼Œå¼€å‘è€…å¯èƒ½æ¯”revieweræ›´åŠ ç†Ÿæ‚‰ç›¸å…³ä»£ç ï¼Œå¯èƒ½åœ¨æŸäº›æ–¹é¢ä»–ä»¬ç†è§£çš„æ¯”revieweræ›´æ¸…æ¥šã€‚é‚£ä¹ˆï¼Œä»–ä»¬çš„äº‰è®ºæ˜¯å¦æœ‰æ„ä¹‰?ä»ä»£ç å¥åº·åº¦çš„è§’åº¦è€ƒè™‘ï¼Œä»–ä»¬çš„ä¿®æ”¹æ˜¯å¦æœ‰æ„ä¹‰ï¼Ÿå¦‚æœç¡®å®æœ‰æ„ä¹‰ï¼Œè®©ä»–ä»¬çŸ¥é“ä»–ä»¬æ˜¯å¯¹çš„ï¼Œå¹¶ä¸”è§£å†³æ‰issueã€‚\nç„¶è€Œï¼Œå¼€å‘è€…ä¹Ÿä¸éƒ½æ˜¯å¯¹çš„ã€‚æœ‰äº›æƒ…å†µä¸‹ï¼Œrevieweråº”è¯¥æ›´é€å½»åœ°è§£é‡Šä¸ºä»€ä¹ˆä»–ä»¬ç»™å‡ºçš„å»ºè®®æ—¶æ­£ç¡®çš„ã€‚ä¸€ä¸ªå¥½çš„è§£é‡Šåº”è¯¥èƒ½å±•ç¤ºå‡ºå¼€å‘è€…è§’åº¦çš„ç†è§£ã€reviewerè§’åº¦çš„ç†è§£ï¼Œä»¥åŠreviewerçš„ä¿®æ”¹å»ºè®®ä¸ºä»€ä¹ˆæ˜¯æœ‰ä»·å€¼çš„ã€‚\næŸäº›æƒ…å†µä¸‹ï¼Œreviewerå¯èƒ½è¦ä¸å¼€å‘è€…è¿›è¡Œå¥½å‡ è½®çš„æ²Ÿé€šã€è§£é‡Šï¼Œä¸ç®¡æ€ä¹ˆæ ·ï¼Œä¿æŒç¤¼è²Œçš„æ€åº¦ï¼Œåº”è¯¥è®©å¼€å‘è€…æ„Ÿè§‰åˆ°â€œä½ ä¸€ç›´åœ¨å€¾å¬ä»–ä»¬åœ¨è¯´ä»€ä¹ˆï¼Œä½ åªæ˜¯ä¸åŒæ„ä»–ä»¬çš„åšæ³•â€ã€‚\nUpsetting Developers # reviewersæœ‰æ—¶ä¼šè§‰å¾—è‡ªå·±ä¸€ç›´åšæŒCLä»£ç çš„ä¼˜åŒ–ï¼Œå¼€å‘è€…æœ¬äººä¼šä¸ä¼šè§‰å¾—æœ‰ç‚¹æ²®ä¸§ã€‚æœ‰æ—¶ï¼Œå¼€å‘è€…å¯èƒ½ä¼šï¼Œæˆ–è€…åˆšå¼€å§‹æ—¶ï¼Œå¼€å‘è€…å¯èƒ½ä¼šï¼Œä½†æ˜¯å½“ä»–ä»¬è§‰å¾—reviewerçš„å»ºè®®æœ‰æ•ˆç¡®å®å¸®åŠ©ä»–æå‡äº†ä»£ç è´¨é‡çš„æ—¶å€™ï¼Œä»–å°±ä¸ä¼šè§‰å¾—æ²®ä¸§äº†ã€‚\né€šå¸¸ï¼Œåªè¦åœ¨reviewçš„æ—¶å€™ä¿æŒç¤¼è²Œçš„æ²Ÿé€šï¼Œå¼€å‘è€…å¯èƒ½æ ¹æœ¬ä¸ä¼šæ„Ÿè§‰åˆ°æ²®ä¸§ï¼Œè¿™é‡Œçš„æ‹…å¿ƒå¯èƒ½åªæ˜¯reviewerè‡ªå·±å¤´è„‘ä¸­çš„ä¸€ç§ç›´è§‰è€Œå·²ã€‚\nCleaning it Up Later # å¼€å‘è€…é’ˆå¯¹reviewerçš„å»ºè®®ï¼Œæœ‰æ—¶ä¼šç”¨è¿™æ ·çš„æ–¹å¼ï¼Œâ€œè¿™æ¬¡å…ˆreviewé€šè¿‡å§ï¼Œæˆ‘åé¢å†ä¼˜åŒ–ä¸‹â€ï¼Œç¡®å®æœ‰äº›å¼€å‘è€…ä¼šè¿™ä¹ˆåšï¼Œä»–ä»¬è¿™ä¹ˆåšçš„åŸå› ï¼Œæ— éæ˜¯ä¸æƒ³å†ç»è¿‡ä¸€è½®æ–°çš„è€—æ—¶çš„reviewè¿‡ç¨‹ã€‚\nreviewerå¯èƒ½ä¼šç»™é€šè¿‡ï¼Œæœ‰äº›å¼€å‘è€…ç¡®å®ä¼šåœ¨æœ¬æ¬¡CLé€šè¿‡åï¼Œç»§ç»­å†™ä¸€ä¸ªæ–°çš„CLæ¥è§£å†³ä¸Šæ¬¡revieweræåˆ°çš„é—®é¢˜ï¼Œå¤§éƒ¨åˆ†æ˜¯è¿™æ ·çš„ã€‚ä½†æ˜¯ä¹Ÿæœ‰ä¸å°‘å¼€å‘è€…äº‹åå°±å¿˜äº†è¿™äº›ï¼Œå¹¶æ²¡æœ‰æäº¤æ–°çš„CL cleanupä¹‹å‰é—ç•™çš„é—®é¢˜ã€‚å¹¶ä¸æ˜¯è¯´è¿™äº›å¼€å‘è€…å°±æ˜¯ä¸è´Ÿè´£ä»»ï¼Œå¾ˆå¯èƒ½æ˜¯å› ä¸ºä»–ä»¬è¢«å…¶ä»–å·¥ä½œå¡«æ»¡äº†ï¼Œæ—¶é—´è¢«æŒ¤å äº†ä¹‹åäººå°±ä¼šå¤±å¿†æˆ–è€…â€œé€‰æ‹©æ€§â€å¤±å¿†ï¼Œæœ€ç»ˆæ…¢æ…¢åœ°å°±å¿˜äº†cleanupã€‚\nå› æ­¤ï¼Œä¸€ä¸ªå¥½çš„åšæ³•æ˜¯ï¼ŒCLé€šè¿‡ä¹‹åï¼Œrevieweråº”è¯¥ç«‹å³é€šè¿‡å¼€å‘è€…ã€ç£ä¿ƒå¼€å‘è€…cleanupé—ç•™çš„é—®é¢˜ã€‚\nGeneral Complaints About Strictness # å¦‚æœä¹‹å‰Code reviewéƒ½æ¯”è¾ƒæ¾ï¼Œåé¢Code reviewæ¯”è¾ƒä¸¥çš„è¯ï¼Œå¼€å‘è€…åˆšå¼€å§‹è‚¯å®šä¸é€‚åº”ï¼Œä»–ä»¬å¯èƒ½ä¼šæŠ±æ€¨å¤šèµ·æ¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæå‡ä¸‹Code reviewçš„é€Ÿåº¦æœ‰åŠ©äºå‡å°‘å¤§å®¶çš„æŠ±æ€¨ã€‚\nå¯¹äºä¸€ä¸ªå›¢é˜Ÿè€Œè¨€ï¼Œå¦‚æœæ˜¯Code reviewä»æ¾åˆ°ä¸¥ï¼Œå¤§å®¶æŠ±æ€¨çš„æ—¶é—´å¯èƒ½æŒç»­çš„æ¯”è¾ƒä¹…ï¼Œå‡ ä¸ªæœˆéƒ½æœ‰å¯èƒ½ï¼Œä½†æ˜¯æœ€ç»ˆå¼€å‘è€…ä¼šçœ‹åˆ°ä¸¥æ ¼æ‰§è¡ŒCode reviewçš„å¥½å¤„ï¼ŒæŠ—è®®å£°æœ€é«˜çš„å¼€å‘è€…å¯èƒ½ä¼šå˜æˆæœ€æœ‰åŠ›çš„æ”¯æŒè€…ï¼Œåªè¦ä»–èƒ½æ„Ÿå—åˆ°ä¸¥æ ¼ä¹‹ä¸Šçš„ä»·å€¼ã€‚\nResolving Conflicts # å¦‚æœåœ¨reviewä»£ç æ—¶éµå¾ªäº†ä¸Šè¿°Code reviewçš„å»ºè®®ï¼Œä½†æ˜¯ä»ç„¶é‡åˆ°äº†ä¸€äº›å’Œå¼€å‘è€…ä¹‹é—´éš¾ä»¥è§£å†³çš„é—®é¢˜ï¼Œè¯·å‚è€ƒ å‰é¢çš„ç« èŠ‚ The Standard of Code Reviewæ¥æµè§ˆä¸‹ç›¸å…³çš„æŒ‡å¼•å’ŒåŸåˆ™ï¼Œåº”è¯¥æœ‰åŠ©äºè§£å†³é‡åˆ°çš„é—®é¢˜æˆ–å†²çªã€‚\nThe Change Author\u0026rsquo;s Guide # ä»ä»£ç CLå¼€å‘è€…çš„è§’åº¦å‡ºå‘ï¼Œä»‹ç»ä¸‹Googleå†…éƒ¨ç§¯ç´¯çš„ä¸€äº›good practicesã€‚\nWriting Good CL Descriptions # CLæè¿°ç”¨æ¥è®°å½•åšäº†ä»€ä¹ˆæ”¹å˜ã€ä¸ºä»€ä¹ˆåšè¿™ä¸ªæ”¹å˜ï¼Œå®ƒä¼šä½œä¸ºVCSä¸­çš„æäº¤å†å²è®°å½•ä¸‹æ¥ï¼Œä¹‹åå¯èƒ½ä¼šæœ‰æ›´å¤šçš„å¼€å‘è€…é˜…è¯»åˆ°è¿™é‡Œçš„CLæè¿°ã€‚\nå°†æ¥ï¼Œå¼€å‘è€…ä¹Ÿå¯èƒ½æ ¹æ®ä¸€äº›å…³é”®è¯æ¥æœç´¢è¿™é‡Œçš„CLæè¿°ï¼Œå¦‚æœCLç›¸å…³çš„å…³é”®ä¿¡æ¯åªè®°å½•åœ¨ä»£ç ä¸­ï¼Œåœ¨CLæè¿°ä¸­ä¸èƒ½äºˆä»¥ä½“ç°çš„è¯ï¼Œé‚£ä¹ˆåˆ«äººå®šä½ä½ çš„CLå°±ä¼šå¼‚å¸¸å›°éš¾ã€‚\nFirst Line #  éœ€è¦å¯¹ä¿®æ”¹è¿›è¡Œä¸€ä¸ªç²¾ç‚¼çš„æ€»ç»“ æè¿°åº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­ æè¿°åè·Ÿä¸€ä¸ªç©ºè¡Œ  CLæè¿°çš„é¦–è¡Œåº”è¯¥å¯¹åšçš„ä¿®æ”¹è¿›è¡Œä¸€ä¸ªç²¾ç‚¼çš„æ€»ç»“ã€æ¦‚æ‹¬ï¼Œç„¶ååé¢è·Ÿä¸€ä¸ªç©ºè¡Œã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¼€å‘è€…æŸ¥çœ‹ã€æ£€ç´¢CLæè¿°ä¿¡æ¯ï¼ˆlogä¿¡æ¯ï¼‰æ˜¯çœ‹çš„è¿™äº›å†…å®¹ï¼Œæ‰€ä»¥CLæè¿°çš„é¦–è¡Œä¿¡æ¯æ˜¯è‡³å…³é‡è¦çš„ã€‚\né€šå¸¸ï¼Œé¦–è¡Œä¿¡æ¯åº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ªå¥½çš„é¦–è¡Œè¡¨è¿°ï¼š\u0026quot;Delete the FizzBuzz RPC and replace it with the new system.\u0026quot;, ä¸‹é¢è¿™ä¸ªåˆ™æ˜¯ä¸€ä¸ªä¸å¥½çš„ç¤ºä¾‹ï¼š\u0026quot;Deleting the FizzBuzz RPC and replacing it with the new system.\u0026quot;\nBody is Informative # CLæè¿°çš„å‰©ä½™éƒ¨åˆ†åº”è¯¥è¯¦ç»†ä¸€ç‚¹ï¼Œå¯ä»¥åŒ…å«å¯¹è¦è§£å†³é—®é¢˜çš„æè¿°ï¼Œä»¥åŠä¸ºä»€ä¹ˆCLä¸­çš„å®ç°æ˜¯æ¯”è¾ƒå¥½çš„æˆ–è€…æ˜¯æœ€ä¼˜çš„æ–¹æ¡ˆã€‚å¦‚æœè¯¥æ–¹æ³•æœ‰ä»€ä¹ˆä¸è¶³ï¼Œä¹Ÿåº”è¯¥æä¸€ä¸‹ã€‚å¦‚æœæœ‰ä¸€äº›bugç¼–å·ã€æ€§èƒ½ç»“æœã€è®¾è®¡æ–‡æ¡£ä¹‹ç±»çš„èƒŒæ™¯ä¿¡æ¯ï¼Œä¹Ÿåº”è¯¥åŒ…å«è¿›æ¥ï¼Œæ–¹ä¾¿åæ¥è€…æŸ¥çœ‹ã€‚\nå³ä½¿CLsæ¶‰åŠåˆ°çš„æ”¹åŠ¨ä¸å¤šï¼Œæœ‰å¿…è¦çš„è¯ï¼Œä¹Ÿéœ€è¦åœ¨bodyéƒ¨åˆ†æè¿°ä¸‹ã€‚\nBad CL Descriptions # â€œFix bugâ€ä¸æ˜¯ä¸€ä¸ªè¶³å¤Ÿå……åˆ†çš„CLæè¿°ï¼Œä¿®çš„ä»€ä¹ˆbugï¼Ÿä¸ºäº†ä¿®bugåšäº†å“ªäº›ä¿®æ”¹ï¼Ÿå…¶ä»–ç±»ä¼¼çš„ä¸è‰¯CLè¡¨è¿°åŒ…æ‹¬ï¼š\n Fix build Add patch Moving code from A to B Add convennience functions kill weired URLs  ä¸Šé¢è¿™äº›æ˜¯Googleä»£ç ä»“åº“ä¸­æå‡ºæ¥çš„çœŸå®CLæè¿°ï¼Œä½œè€…å¯èƒ½è®¤ä¸ºä»–ä»¬çš„æè¿°æ¯”è¾ƒæ¸…æ™°äº†ï¼Œä½†æ˜¯å®é™…ä¸Šè¿™æ ·çš„CLæè¿°æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œå®Œå…¨æ²¡æœ‰èµ·åˆ°CLæè¿°åº”æœ‰çš„ä½œç”¨ã€‚\nGood CL Descriptions # ä¸‹é¢æ˜¯ä¸€äº›æ¯”è¾ƒå¥½çš„CLæè¿°ç¤ºä¾‹ã€‚\nFunctionality change #  rpc: remove size limit on RPC server message freelist.\nServers like FizzBuzz have very large messages and would benefit from reuse. Make the freelist larger, and add a goroutine that frees the freelist entries slowly over time, so that idle servers eventually release all freelist entries.\n è¿™ä¸ªCLæè¿°çš„é¦–è¡Œä¿¡æ¯æ¦‚è¿°äº†åšçš„ä¿®æ”¹ï¼Œåé¢bodyéƒ¨åˆ†åˆè§£é‡Šäº†ä¸ºä»€ä¹ˆåšè¿™ä¸ªä¿®æ”¹ï¼Œä»¥åŠè‡ªå·±æ˜¯æ€ä¹ˆåšçš„ï¼Œæœ‰ä»€ä¹ˆå¥½å¤„ï¼Œè¿˜æä¾›äº†å®ç°ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ã€‚\nRefactoring #  Construct a Task with a TimeKeeper to use its TimeStr and Now methods.\nAdd a Now method to Task, so the borglet() getter method can be removed (which was only used by OOMCandidate to call borgletâ€™s Now method). This replaces the methods on Borglet that delegate to a TimeKeeper.\nAllowing Tasks to supply Now is a step toward eliminating the dependency on Borglet. Eventually, collaborators that depend on getting Now from the Task should be changed to use a TimeKeeper directly, but this has been an accommodation to refactoring in small steps.\nContinuing the long-range goal of refactoring the Borglet Hierarchy.\n è¿™ä¸ªCLæè¿°çš„é¦–è¡Œä¿¡æ¯æŒ‡å‡ºäº†CLåšäº†ä»€ä¹ˆï¼Œç›¸å¯¹äºä»¥å‰çš„å®ç°åšäº†å“ªäº›ä¿®æ”¹ã€‚bodyéƒ¨åˆ†ä»‹ç»äº†å®ç°ç»†èŠ‚ã€CLçš„contextï¼Œä¹ŸæŒ‡å‡ºäº†è™½ç„¶è¿™ä¸ªæ–¹æ¡ˆæ²¡æœ‰é‚£ä¹ˆç†æƒ³ï¼Œä½†æ˜¯ä¹ŸæŒ‡å‡ºäº†æœªæ¥çš„æ”¹è¿›æ–¹å‘ã€‚åŒæ—¶ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦åšè¿™é‡Œçš„é‡æ„ã€‚\nSmall CL that needs some context #  Create a Python3 build rule for status.py.\nThis allows consumers who are already using this as in Python3 to depend on a rule that is next to the original status build rule instead of somewhere in their own tree. It encourages new consumers to use Python3 if they can, instead of Python2, and significantly simplifies some automated build file refactoring tools being worked on currently.\n è¿™ä¸ªCLçš„é¦–è¡Œä¿¡æ¯æè¿°äº†åšäº†ä»€ä¹ˆï¼Œbodyéƒ¨åˆ†è§£é‡Šäº†ä¸ºä»€ä¹ˆè¦åšè¿™é‡Œçš„ä¿®æ”¹ï¼Œå¹¶ä¸”ç»™revieweræä¾›äº†å……åˆ†çš„contextï¼ˆé¢†åŸŸç›¸å…³çŸ¥è¯†ï¼‰ä¿¡æ¯ã€‚\nReview the description before submitting the CL # CLsåœ¨reviewè¿‡ç¨‹ä¸­å¯èƒ½ä¼šå†æ¬¡ä¿®æ”¹ï¼Œå†æ¬¡reviewçš„æ—¶å€™ï¼ŒCLæè¿°ä¿¡æ¯å¯èƒ½ä¼šä¸æœ€æ–°çš„ä¿®æ”¹ä¸ç¬¦ï¼Œåœ¨æäº¤CLä¹‹å‰reviewä¸€ä¸‹æè¿°ä¿¡æ¯æ˜¯å¦ä¸ä»£ç ä¿®æ”¹ä»ç„¶ä¸€è‡´ï¼Œè¿™ä¸ªæ˜¯æœ‰å¿…è¦çš„ã€‚\nSmall CLs # Why Write Small CLs? # Small, simple CLsæœ‰è¿™æ ·çš„å¥½å¤„ï¼š\n **Reviewæ›´å¿«ã€‚**å¦‚æœæäº¤ä¸€ä¸ªå¤§çš„CLï¼Œreviewerå¯èƒ½è¦ä¸“é—¨æŠ½30åˆ†é’Ÿæ‰èƒ½å®Œæˆreviewè¿‡ç¨‹ï¼Œè¿™ä¸ªå¯èƒ½æ¯”è¾ƒå›°éš¾ï¼Œä½†æ˜¯å¦‚æœCLæ‹†çš„éƒ½æ¯”è¾ƒå°ï¼Œrevieweræ¯æ¬¡æŠ½ä¸ª5åˆ†é’Ÿå®Œæˆä¸€æ¬¡reviewï¼Œå¤šæ¬¡reviewï¼Œå›æ¯”å‰è€…æ›´å¿«å®Œæˆã€‚ **Reviewæ›´å……åˆ†ã€‚**å¦‚æœæäº¤ä¸€ä¸ªå¤§çš„CLï¼Œæ”¹åŠ¨ä¸œè¥¿å¾ˆå¤šæƒ…å†µä¸‹ï¼Œrevieweréœ€è¦æ¸¸èµ°åœ¨æ›´å¤šä»£ç ä¸­ï¼Œå¿ƒç†ä¸Šä¼šå€¾å‘äºå…³æ³¨æ›´åŠ é‡è¦çš„ä»£ç ï¼Œéš¾å…æŸäº›ä»£ç ä¼šè¢«é™æƒï¼Œreviewå¯èƒ½ä¸é‚£ä¹ˆå……åˆ†ã€‚å¦‚æœCLæ¯”è¾ƒå°ï¼Œå¾ˆå®¹æ˜“å°±èƒ½çœ‹æ‡‚ï¼Œä¹Ÿä¸éœ€è¦æ¥å›ç¿»ä»£ç ï¼Œreviewçš„ä¼šæ›´å……åˆ†ã€‚ **ä¸æ˜“å¼•å…¥bugã€‚**å› ä¸ºæ¯æ¬¡æ”¹åŠ¨éƒ½æ¯”è¾ƒå°ï¼ŒCLä½œè€…ä¸å®¹æ˜“å¼•å…¥bugï¼Œreviewerä¹Ÿæ›´å®¹æ˜“å‘ç°bugã€‚ **å¦‚æœè¢«æ‹’ç»ï¼Œå¯å‡å°‘æ— è°“çš„å·¥ä½œã€‚**CLå¯èƒ½ä¼šè¢«æ‹’ç»ï¼Œå¦‚æœä¸€æ¬¡åšå¤§é‡ä¿®æ”¹ï¼Œè¢«æ‹’ç»çš„è¯ï¼ŒCLä¸­çš„æ‰€æœ‰ä¿®æ”¹åŠ¨ä½œå¯èƒ½éƒ½è¦é‡æ–°æ¥è¿‡ï¼Œä¸ç®¡æ˜¯åˆç†çš„ã€ä¸åˆç†çš„ï¼Œç›¸å½“äºåšäº†æ›´å¤šæ— è°“çš„å·¥ä½œã€‚ **æ›´æ˜“mergeã€‚**å¦‚æœæäº¤ä¸€ä¸ªå¤§çš„CLï¼Œæ¶‰åŠä¿®æ”¹æ¯”è¾ƒå¤šï¼Œå†²çªå¯èƒ½ä¹Ÿä¼šæ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆè§£å†³å†²çªèŠ±è´¹çš„æ—¶é—´ä¼šæ›´å¤šï¼Œä¸å®¹æ˜“mergeã€‚å°çš„CLåœ¨mergeçš„æ—¶å€™å°±ç®€å•å¤šäº†ã€‚ **è®¾è®¡ä¸è‡³äºå‡ºå¤§é—®é¢˜ã€‚**å¦‚æœCLæ¶‰åŠä¿®æ”¹æ¯”è¾ƒå°‘ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“æŠŠä¿®æ”¹ä¼˜åŒ–åˆ°æœ€ä½³ï¼Œå¯¹äºreviewerçš„å»ºè®®ä¹Ÿæ›´å®¹æ˜“å®Œæˆï¼Œå¦‚æœCLæ¯”è¾ƒå¤§ï¼Œrevieweræ„è§ã€å»ºè®®æ¯”è¾ƒå¤šï¼Œå°±å¾ˆéš¾ä¸€æ¬¡å®Œæˆäº†ã€‚ **åç»­å·¥ä½œä¸è‡³äºé˜»å¡åœ¨reviewä¸Šã€‚**CLä½œè€…å¯èƒ½å¸Œæœ›åŸºäºè¿™ä¸ªCLåšæ›´å¤šå·¥ä½œï¼Œå¦‚æœCLæ¯”è¾ƒå°é‚£ä¹ˆreviewå¯ä»¥å¾ˆå¿«é€šè¿‡ï¼Œä½†æ˜¯å¦‚æœCLæ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆCLä½œè€…å°†ä¸å¾—ä¸ç­‰å¾…æ›´å¤šçš„æ—¶é—´ **mergeåæœ‰é—®é¢˜ï¼Œæ›´æ˜“å›é€€ã€‚**mergeä¹‹åæœ‰æ—¶å€™ä¹Ÿä¼šæ„è¯†åˆ°mergeçš„ä»£ç æœ‰é—®é¢˜ï¼Œå¦‚æœè¦å›é€€çš„è¯ï¼Œå°çš„CLæ›´å®¹æ˜“å›é€€ï¼Œå¦‚æœCLå¾ˆå¤§ï¼Œå“‡ï¼Œæ¶‰åŠåˆ°çš„ä»£ç å¤šï¼Œå›é€€å°±æ¯”è¾ƒç—›è‹¦ã€å¤æ‚ã€‚  reviewerä¸ä¼šå› ä¸ºæŸä¸ªCLå¾ˆå¤§ï¼Œæˆ‘ä¸reviewäº†ï¼Œç„¶åç»™ä½ æ‹’ç»æ‰ï¼Œé€šå¸¸ä»–ä»¬ä¼šè¡¨ç°çš„æ¯”è¾ƒç¤¼è²Œï¼Œå‘ŠçŸ¥ä½ å°†è¿™ä¸ªå¤§çš„CLæ‹†åˆ†æˆå‡ ä¸ªå°çš„CLsã€‚å½“ä½ å·²ç»å®Œæˆäº†ä¸€ä¸ªCLæ—¶ï¼Œå†å°†å…¶æ‹†åˆ†æˆå‡ ä¸ªå°çš„CLsï¼Œå…¶å®è¿™é‡Œçš„å·¥ä½œé‡å¯èƒ½ä¸å°‘çš„ï¼Œå½“ç„¶å’Œrevieweräº‰è¾©ä¸ºä»€ä¹ˆè¦æ±‚æ‹†åˆ†æˆå¤šä¸ªCLsèŠ±çš„æ—¶é—´å¯èƒ½ä¹Ÿä¼šå¾ˆé•¿ã€‚æœ€çœåŠ›çš„åšæ³•å°±æ˜¯ï¼Œä¸€å¼€å§‹å°±åšæŒå†™å°çš„CLï¼Œå¤šæ¬¡CLsã€‚\nWhat is Small? # ä¸€èˆ¬ï¼ŒCLä¸€èˆ¬å»ºè®®çš„å¤§å°ï¼š\n CLåŒ…å«æœ€å°‘å†…å®¹ï¼Œä¸€æ¬¡åªåšä¸€ä»¶äº‹æƒ…ï¼Œæ¯”å¦‚æ–°å¢featureï¼ŒCLåªåŒ…å«featureçš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çš„éƒ¨åˆ†ã€‚ä¹Ÿå¯ä»¥ä¸reviewerè¿›è¡Œæ²Ÿé€šï¼Œç¡®å®šåˆé€‚çš„CLå¤§å°ï¼Œä¸åŒçš„reviewerä¹ æƒ¯ä¹Ÿä¸ä¸€æ ·ï¼Œå¯¹reviewerè€Œè¨€ï¼ŒCLå¤ªå¤§å¤ªå°éƒ½æ˜¯è´Ÿæ‹…ã€‚æˆ‘ä»¬çš„å»ºè®®æ˜¯CLä¸€æ¬¡åªåšä¸€ä»¶äº‹æƒ…ã€‚ revieweréœ€è¦çœ‹åˆ°çš„ä»»ä½•ä¸œè¥¿éƒ½å·²ç»åŒ…å«åœ¨äº†CLä¸­ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä½äºCLä»£ç ä¸­ã€æè¿°ä¸­ã€å·²ç»å­˜åœ¨çš„ä»£ç ä¸­ã€reviewerä¹‹å‰reviewè¿‡çš„CLä¸­ã€‚ å½“æŠŠè¿™ä¸ªCLåˆå…¥ä¹‹åï¼Œç³»ç»Ÿä»ç„¶èƒ½å¤Ÿå·¥ä½œçš„å¾ˆå¥½ã€‚ CLä¹Ÿä¸å°åˆ°éšæ™¦éš¾æ‡‚çš„ç¨‹åº¦ã€‚æ¯”å¦‚æ–°å¢äº†ä¸€ä¸ªAPIï¼Œåº”è¯¥åŒæ—¶åŒ…å«APIçš„ä½¿ç”¨ç¤ºä¾‹ï¼Œè¿™æ ·reviewerèƒ½å¤Ÿæ›´å¥½åœ°ç†è§£APIçš„ä½¿ç”¨æ–¹å¼ï¼Œè¿™æ ·ä¹Ÿå¯ä»¥é¿å…å¼•å…¥æ²¡æœ‰ç”¨çš„APIã€‚  ä¹Ÿæ²¡æœ‰ç¡¬æ€§çš„è§„å®šæŒ‡æ˜CLå¤šå¤§æ‰ç®—å¤§ï¼Œä¸€èˆ¬100è¡Œä»£ç æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„CLå°ºå¯¸ï¼Œ1000è¡Œæœ‰ç‚¹å¤ªå¤§äº†ï¼Œä¸»è¦è¿˜æ˜¯è¦çœ‹reviewerçš„æ€åº¦ã€‚CLä¸­æ¶‰åŠåˆ°çš„æ–‡ä»¶çš„æ•°é‡ä¹Ÿæ˜¯CLå¤§å°çš„ä¸€ä¸ªåº¦é‡ç»´åº¦ï¼Œå¦‚æœCLä¸­åŒ…å«äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶ä¿®æ”¹äº†200è¡Œä»£ç ï¼Œè¿™ä¸ªæ„Ÿè§‰è¿˜æ˜¯OKçš„ï¼Œä½†æ˜¯å¦‚æœåŒæ ·æ˜¯ä¿®æ”¹äº†200è¡Œä»£ç ä½†æ˜¯æ•£è½åœ¨50ä¸ªæ–‡ä»¶ä¸­ï¼Œé‚£CLæœ‰ç‚¹å¤ªå¤§äº†ã€‚\nä½“ä¼šä¸€ä¸‹ï¼Œæˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™æ˜¯æœ‰äº†è§£å¯¹åº”çš„èƒŒæ™¯çš„ï¼Œä½†æ˜¯reviewerå¯èƒ½äº†è§£æ¯”è¾ƒå°‘æˆ–è€…å®Œå…¨ä¸çŸ¥é“ã€‚ä¸€ä¸ªå¯æ¥å—çš„CLå¤§å°ï¼Œå¯¹reviewerè€Œè¨€æ˜¯å¾ˆé‡è¦çš„ã€‚å¦‚æœä½ ä¸ç¡®å®šrevieweræœŸå¾…çš„CLå¤§å°æ˜¯æ€æ ·çš„ï¼Œé‚£å°±å°½é‡å†™ä¸€ä¸ªæ¯”è‡ªå·±é¢„æœŸä¸­çš„åˆç†å¤§å°æ›´å°ç‚¹çš„ï¼Œå¾ˆå°‘æœ‰reviewerä¼šå«Œå¼ƒCLå¤ªå°ã€‚\nWhen are Large CLs OK? # ä¸‹é¢è¿™äº›åœºæ™¯ï¼Œå¦‚æœCLæ¯”è¾ƒå¤§ä¹Ÿè¿˜OKï¼Œä¸ç®—åï¼š\n åˆ é™¤æ•´ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œæˆ–è€…åˆ é™¤å¤§æ®µå†…å®¹ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€è¡Œä¿®æ”¹ï¼Œå› ä¸ºå®ƒä¸ä¼šèŠ±è´¹reviewerå¤ªå¤šæ—¶é—´reviewã€‚ æœ‰æ—¶ä¸€ä¸ªå¤§çš„CLæ˜¯æœ‰è‡ªåŠ¨åŒ–refactorå·¥å…·ç”Ÿæˆçš„ï¼Œè€Œæˆ‘ä»¬ä¿¡ä»»è¿™äº›å·¥å…·ï¼Œreviewerçš„å·¥ä½œå°±æ˜¯æ£€æŸ¥å¹¶ç¡®è®¤è¿™é‡Œçš„ä¿®æ”¹æ²¡é—®é¢˜ã€‚è¿™æ ·çš„CLå¾ˆå¤§ï¼Œä½†æ˜¯å¯¹reviewerè€Œè¨€ä»ç„¶ä¸ä¼šèŠ±å¤ªå¤šæ—¶é—´ã€‚  Splitting by Files # å¦ä¸€ç§æ‹†åˆ†å¤§çš„CLçš„æ–¹å¼æ˜¯ï¼Œå°†ä¿®æ”¹çš„æ–‡ä»¶è¿›è¡Œé€‚å½“åˆ†ç»„ï¼Œå¹¶å°†ä¸åŒåˆ†ç»„çš„æ–‡ä»¶åšæˆCLå¹¶æäº¤ä¸åŒçš„reviewerè¿›è¡Œreviewã€‚\nä¾‹å¦‚ï¼šä½ å‘é€äº†ä¸€ä¸ªCLä¿®æ”¹ï¼ŒåŒæ—¶åŒ…å«äº†å¯¹protocol bufferæ–‡ä»¶çš„ä¿®æ”¹ï¼Œå¦ä¸€ä¸ªCLæ˜¯ä¸šåŠ¡ä»£ç ä¿®æ”¹ä½†æ˜¯ä½¿ç”¨äº†è¿™é‡Œä¿®æ”¹åçš„protocol bufferæ–‡ä»¶ã€‚é¦–å…ˆæˆ‘ä»¬è¦å…ˆæäº¤protoæ–‡ä»¶å¯¹åº”çš„CLï¼Œç„¶åå†æäº¤å¼•ç”¨å®ƒçš„ä¸šåŠ¡ä»£ç CLã€‚è™½ç„¶æäº¤çš„æ—¶å€™æœ‰å…ˆåï¼Œä½†æ˜¯reviewè¿‡ç¨‹å¯ä»¥æ˜¯åŒæ—¶è¿›è¡Œçš„ã€‚è¿™ä¹ˆåšçš„åŒæ—¶ï¼Œæœ€å¥½ä¹ŸçŸ¥ä¼šä¸‹reviewerå¦ä¸€ä¸ªCLä¸­çš„å­˜åœ¨ä»¥åŠä¸å½“å‰CLçš„å…³ç³»ã€‚\nSeparate Out Refactorings # ä¸€èˆ¬å°†CLä¸­çš„é‡æ„ä¹‹ç±»çš„å·¥ä½œå’Œå…¶ä¸­åŒ…å«çš„featureå¼€å‘ã€bugä¿®æ”¹åŒºåˆ†å¼€æ˜¯æ¯”è¾ƒå¥½çš„åšæ³•ã€‚ä¾‹å¦‚ï¼Œå°†CLä¸­åŒ…å«çš„ç§»åŠ¨ã€é‡å‘½åç±»åä¹‹ç±»çš„æ“ä½œå•ç‹¬æ”¾åœ¨ä¸€ä¸ªCLä¸­ï¼Œè¿™æ ·reviewerèƒ½å¤Ÿæ›´å®¹æ˜“ç†è§£æ¯ä¸ªCLä¸­çš„ä¿®æ”¹ã€‚\nä¸è¿‡ï¼Œä¸€ä¸ªå°çš„å˜é‡åä¿®æ”¹çš„ä¹Ÿå¯ä»¥åŒ…å«åœ¨å¦ä¸€ä¸ªfeature changeæˆ–è€…bugfixç›¸å…³çš„CLä¸­ã€‚å¦‚æœä¸€ä¸ªCLä¸­åŒ…å«äº†ä¸€äº›é‡æ„ä¹‹ç±»çš„ä¿®æ”¹ï¼Œè®©å¼€å‘è€…ã€revieweråˆ¤æ–­è¿™éƒ¨åˆ†é‡æ„ç›¸å…³çš„ä¿®æ”¹æ˜¯å¦å¯¹å½“å‰CLæ¥è¯´å¤ªå¤§äº†ï¼Œå¤ªå¤§äº†ä¼šè®©reviewå˜å¾—æ›´åŠ å›°éš¾ï¼Œå¼€å‘è€…åº”è¯¥æ®æ­¤ä½œå‡ºä¸€äº›è°ƒæ•´ã€‚\nKeep related test code in the same CL # é¿å…å°†ç›¸å…³çš„æµ‹è¯•ä»£ç å•ç‹¬æ”¾åœ¨å¦ä¸€ä¸ªCLä¸­ã€‚æµ‹è¯•ä»£ç éªŒè¯ä»£ç ä¿®æ”¹çš„æ­£ç¡®æ€§ï¼Œæ‰€ä»¥å’Œä»£ç ä¿®æ”¹ç›¸å…³çš„æµ‹è¯•ä»£ç ï¼Œåº”è¯¥æ”¾ç½®åœ¨ä¸€ä¸ªç›¸åŒçš„CLä¸­ï¼Œå°½ç®¡æµ‹è¯•ä»£ç å¢åŠ äº†ä¿®æ”¹ä»£ç çš„è¡Œæ•°ã€‚\nä¸ç›¸å…³çš„æµ‹è¯•ä»£ç ä¿®æ”¹ï¼Œå¯ä»¥æ”¾åˆ°å¦ä¸€ä¸ªCLä¸­ï¼Œç±»ä¼¼äº Separate Out Refactoringsï¼Œ åŒ…å«ï¼š\n éªŒè¯å·²ç»å­˜åœ¨çš„ã€æäº¤è¿‡çš„ä»£ç ï¼Œå½“å‰åªæ˜¯æ–°å¢ã€å®Œå–„æµ‹è¯•ä»£ç ï¼› é‡æ„æµ‹è¯•ä»£ç ï¼ˆå¦‚å¼•å…¥äº†æ–°çš„helperå‡½æ•°ï¼‰ å¼•å…¥äº†æ›´å¤§çš„æµ‹è¯•æ¡†æ¶ï¼ˆå¦‚é›†æˆæµ‹è¯•ï¼‰  Don\u0026rsquo;t Break the Build # å¦‚æœå¤šä¸ªCLsäº’ç›¸ä¾èµ–ï¼Œéœ€è¦æ‰¾ä¸€ä¸ªåŠæ³•æ¥ç¡®ä¿è¿™å‡ ä¸ªCLæ¯æäº¤ä¸€ä¸ªï¼Œç³»ç»Ÿæ•´ä½“ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œä¸èƒ½å› ä¸ºæäº¤äº†ä¸€ä¸ªCLå°±å¯¼è‡´ç³»ç»Ÿæ„å»ºå¤±è´¥æˆ–è€…å·¥ä½œä¸æ­£å¸¸ã€‚æ¯”å¦‚ï¼Œå¯ä»¥è€ƒè™‘å°†å‡ ä¸ªä¾èµ–çš„å°çš„CLä¿®æ”¹åˆå¹¶ã€‚\nCan\u0026rsquo;t Make it Small Enough # æœ‰æ—¶ä¼šé‡åˆ°è¿™ç§æƒ…å†µï¼Œçœ‹ä¸Šå»CLä¼šæ— å¯é¿å…åœ°å˜å¾—å¾ˆå¤§ï¼Œå…¶å®ï¼Œè¿™ç§æƒ…å†µå‡ ä¹æ˜¯ä¸å­˜åœ¨çš„ã€‚åªè¦å¼€å‘è€…å°è¯•ç»ƒä¹ å»å†™å°çš„CLså¤šæ¬¡code reviewï¼Œä¹ æƒ¯äº†ä¹‹åå¼€å‘è€…æ€»èƒ½æ‰¾åˆ°åˆé€‚çš„åŠæ³•æ¥å°†ä¸€ä¸ªå¤§çš„ä¿®æ”¹åˆ†è§£æˆå‡ ä¸ªå°çš„ä¿®æ”¹ã€‚\nåœ¨å¼€å‘è€…åŠ¨æ‰‹è¿›è¡Œä¸€ä¸ªå¾ˆå¤§çš„CLä¹‹å‰ï¼Œå¼€å‘è€…åº”è€ƒè™‘ä¸‹æ˜¯å¦å…ˆæ¥ä¸€æ¬¡åªåŒ…å«é‡æ„ï¼ˆåªä¿®æ”¹è®¾è®¡ï¼Œä¸å˜åŠ¨åŠŸèƒ½ï¼‰çš„CLç„¶ååœ¨æ­¤åŸºç¡€ä¸Šå†åšä¿®æ”¹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯ä¼šæ›´å¥½ä¸€ç‚¹ã€‚å¦‚æœä¸€ä¸ªCLä¸­æ—¢åŒ…å«é‡æ„ä»£ç ï¼ŒåˆåŒ…å«é€»è¾‘å˜åŠ¨ä»£ç ï¼Œè¿™ä¸ªä¿®æ”¹å°±å¾ˆé‡ã€‚å¤šæ•°æƒ…å†µä¸‹ï¼Œå…ˆæ¥ä¸€æ¬¡åªåŒ…å«é‡æ„çš„CLä¼šä¸ºåç»­çš„ä¿®æ”¹æ‰«æ¸…éšœç¢ï¼Œåç»­çš„ä¿®æ”¹ä¼šæ›´cleanã€‚\nå¦‚æœå› ä¸ºæŸäº›å®¢è§‚åŸå› ï¼Œæ— æ³•åšåˆ°ä¸Šè¿°è¿™äº›ï¼Œé‚£å°±å…ˆæå‰å‘reviewerè¯´æ˜æƒ…å†µï¼Œè®©revieweråšå¥½å¿ƒç†å‡†å¤‡ï¼Œå‡†å¤‡å¥½reviewä¸€ä¸ªå¤§çš„CLï¼Œreviewå¯èƒ½èŠ±è´¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œè¯·åŠ¡å¿…å°å¿ƒå¼•å…¥bugã€åŠ¡å¿…æ·»åŠ å¥½æµ‹è¯•ç”¨ä¾‹å¹¶é€šè¿‡æµ‹è¯•ï¼Œrevieweråœ¨è¿™ä¹ˆå¤§çš„CLä¸­reviewçš„æ•ˆæœå¯èƒ½ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚\nHow to Handle Reviewer Comments # å½“å¼€å‘è€…é’ˆå¯¹CLå‘èµ·Code reviewæ—¶ï¼Œreviewerä¸€èˆ¬ä¼šé€šè¿‡commentså†™ä¸€äº›æ„è§ã€å»ºè®®ï¼Œé‚£å¼€å‘è€…è¯¥å¦‚ä½•å¤„ç†reviewer commentså‘¢ï¼Ÿ\nDon\u0026rsquo;t Take it Personally # Code reviewçš„åˆè¡·æ˜¯ä¸ºäº†ç»´æŠ¤ä»£ç çš„è´¨é‡ã€äº§å“çš„è´¨é‡ï¼Œå½“ä¸€ä¸ªreviewerå¯¹å¼€å‘è€…ä»£ç å†™äº†äº›æ„è§æ—¶ï¼Œå¼€å‘è€…åº”è¯¥å°†å…¶çœ‹ä½œæ˜¯æ¥è‡ªreviewerçš„å¸®åŠ©ï¼Œä¸è¦å°†å…¶çœ‹åšæ˜¯å¯¹å¼€å‘è€…ä¸ªäººã€ä¸ªäººèƒ½åŠ›çš„äººèº«æ”»å‡»ã€‚\næœ‰æ—¶ï¼Œreviewersä¼šå˜å¾—å¾ˆæ²®ä¸§ï¼Œå¹¶ä¸”å¯èƒ½å°†æ²®ä¸§ã€ä¸æ»¡æƒ…ç»ªåœ¨è¯„è®ºä¸­ä½“ç°å‡ºæ¥ã€‚ä¸€ä¸ªå¥½çš„revieweræ˜¯ä¸ä¼šè¿™ä¹ˆåšçš„ï¼Œä½†æ˜¯ä½œä¸ºä¸€ä¸ªå¥½çš„å¼€å‘è€…ï¼Œåº”è¯¥åšå¥½é¢å¯¹è¿™ç§æƒ…å†µçš„å‡†å¤‡ã€‚å¼€å‘è€…å¯ä»¥åé—®ä¸‹è‡ªå·±ï¼Œå½“reviewerçš„è¯„è®ºåˆ°åº•æ˜¯åœ¨æè¿°ä¸€ä¸ªä»€ä¹ˆä»£ç é—®é¢˜ï¼Œç„¶åå°è¯•å»ä¿®æ”¹å°±å¯ä»¥äº†ã€‚\n**å¯¹äºåˆ«äººçš„reviewæ„è§ï¼Œæ°¸è¿œä¸è¦ç”¨æ„¤æ€’å»å›åº”ï¼**è¿™è¿åäº†Code reviewæˆ–è€…å¼€æºååŒçš„ç²¾ç¥ï¼Œå¹¶ä¸”è¿™æ ·çš„è´Ÿé¢ä¿¡æ¯å¯èƒ½ä¼šæ°¸è¿œç•™å­˜åœ¨reviewå†å²ä¸­ã€‚å¦‚æœä½ å¿ƒé‡Œé¢å¾ˆæ„¤æ€’ï¼Œå¹¶ä¸”æƒ³æ„¤æ€’åœ°åšå‡ºå›åº”ï¼Œè¯·å°è¯•ç¦»å¼€ä½ çš„ç”µè„‘ã€é”®ç›˜ï¼Œæˆ–è€…å…ˆå¹²ç‚¹åˆ«çš„ï¼Œç›´åˆ°ä½ å†…å¿ƒå¹³é™ä¸‹æ¥å†ç¤¼è²Œåœ°åšå‡ºå›åº”ã€‚\nä¸€èˆ¬ï¼Œå¦‚æœreviewerå›å¤çš„è¯„å®¡æ„è§ä¸æ˜¯å»ºè®¾æ€§çš„ï¼Œæˆ–è€…æ²¡æœ‰ç¤¼è²Œï¼Œå¯ä»¥è¯•ç€å‘reviewerç§ä¸‹é‡Œè¯‰è¯´ä¸‹ä½ çš„çœ‹æ³•ã€‚å¦‚æœèƒ½é¢å¯¹é¢äº¤æµæœ€å¥½ï¼Œä¸èƒ½å°±å°è¯•å‘ä¸€å°ç§äººé‚®ä»¶ï¼Œå‘reviewerè¯´ä¸‹ä½ ä¸å–œæ¬¢ä»–çš„è¿™ç§reviewæ–¹å¼ï¼Œä½ æœŸæœ›ä»–èƒ½åšå‡ºå¥½çš„æ”¹å˜ã€‚å¦‚æœå¯¹æ–¹è¿˜æ˜¯æ‹’ç»åšå‡ºæ”¹å˜ï¼Œé‚£å°±ä¸è¦æµªè´¹æ—¶é—´äº†ï¼Œå‡çº§ä¸€ä¸‹çŸ¥ä¼šä½ çš„é¡¹ç›®ç»ç†ã€‚\nFix the Code # å¦‚æœreviewerè¯´ä»–çœ‹ä¸æ‡‚ä½ çš„ä»£ç ä¸­çš„æŸä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆä½ åº”è¯¥å°è¯•ç®€åŒ–è¿™é‡Œçš„ä»£ç å®ç°ã€‚å¦‚æœä»£ç å·²ç»æ— æ³•å†ç²¾ç®€å®ç°ï¼Œé‚£å°±åœ¨ä»£ç ä¸­æ·»åŠ åˆé€‚çš„æ³¨é‡Šæ¥è§£é‡Šã€‚å¦‚æœæ·»åŠ é¢å¤–çš„æ³¨é‡Šæ²¡æœ‰ä»€ä¹ˆå¤ªå¤§æ„ä¹‰ï¼Œåªæœ‰è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å°è¯•é€šè¿‡code reviewå·¥å…·æ·»åŠ ä¸€äº›commentsæ¥è§£é‡Šã€‚\nå¦‚æœæŸä¸ªreviewerçœ‹ä¸æ‡‚è¿™é‡Œçš„ä»£ç ï¼Œé‚£ä¹ˆå°†æ¥å¯èƒ½å…¶ä»–å¼€å‘è€…é˜…è¯»ä»£ç çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯çœ‹ä¸æ‡‚çš„ã€‚ä½†æ˜¯é€šè¿‡code reviewå·¥å…·æ·»åŠ commentsè¿›è¡Œè§£é‡Šï¼Œå¯¹å°†æ¥çš„å¼€å‘è€…æ˜¯æ²¡æœ‰å¸®åŠ©çš„ï¼Œä½†æ˜¯ç²¾ç®€ä»£ç å®ç°ã€ä»£ç æ·»åŠ æ³¨é‡Šæ˜¯æœ‰å¸®åŠ©çš„ã€‚\n"}),a.add({id:322,href:"/tags/float/",title:"float",description:"",content:""}),a.add({id:323,href:"/blog/2019-05-23-%E5%88%AB%E7%94%A8float%E4%BD%9C%E4%B8%BAmap%E7%9A%84key/",title:"åˆ«ç”¨floatä½œä¸ºmapçš„key",description:"é‡åˆ°ä¸ªå¥½ç©çš„é—®é¢˜ï¼Œä½¿ç”¨floatç±»å‹ä½œä¸ºgo mapçš„keyï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š å…¶å®å°±æ˜¯æµ®ç‚¹æ•°ç²¾åº¦çš„é—®é¢˜ï¼Œéšæ‰‹ç¿»äº†ä¸‹go mapçš„æºç ï¼Œå¤‡å¿˜ä¸‹ã€‚è¿™é‡Œè¦æ¶‰åŠåˆ°å‡ ä¸ªé—®é¢˜ï¼š\n  golangå¦‚ä½•é’ˆå¯¹keyè®¡ç®—hashçš„ï¼Œé˜…è¯»æºç åå‘ç°å°±æ˜¯æœ‰ä¸ªkey *_typeï¼Œh.key.alg.hash(key)æ¥è®¡ç®—å¾—åˆ°hashï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™é‡Œçš„hashè®¡ç®—è¿‡ç¨‹ï¼Œå¯ä»¥é˜…è¯»ä¸‹alg.goï¼Œé‡Œé¢é’ˆå¯¹ä¸åŒçš„keyç±»å‹å®šä¹‰äº†è®¡ç®—hashçš„æ–¹æ³•ï¼š\nvar algarray = [alg_max]typeAlg{ alg_NOEQ: {nil, nil}, alg_MEM0: {memhash0, memequal0}, alg_MEM8: {memhash8, memequal8}, alg_MEM16: {memhash16, memequal16}, alg_MEM32: {memhash32, memequal32}, alg_MEM64: {memhash64, memequal64}, alg_MEM128: {memhash128, memequal128}, alg_STRING: {strhash, strequal}, alg_INTER: {interhash, interequal}, alg_NILINTER: {nilinterhash, nilinterequal}, alg_FLOAT32: {f32hash, f32equal}, alg_FLOAT64: {f64hash, f64equal}, alg_CPLX64: {c64hash, c64equal}, alg_CPLX128: {c128hash, c128equal}, }  float64å°±æ˜¯è¦ä½¿ç”¨f64hashè¿™ä¸ªæ–¹æ³•æ¥è®¡ç®—hashå€¼ã€‚\n  golangé‡Œé¢åˆ©ç”¨è®¡ç®—å¾—åˆ°çš„hashå€¼çš„å5ä½ä½œä¸ºhmapçš„bucket indexï¼Œå…ˆå®šä½åˆ°bucketï¼Œç„¶åå†æ ¹æ®hashçš„å‰8ä½ä½œä¸ºä¸bucketå†…éƒ¨\u0026lt;k,v\u0026gt; entriesçš„hashè¿›è¡Œæ¯”è¾ƒæ‰¾åˆ°å¯¹åº”çš„entryã€‚\n  ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹f64hashçš„å®ç°ï¼š\nfunc f64hash(p unsafe.Pointer, h uintptr) uintptr { f := *(*float64)(p) switch { case f == 0: return c1 * (c0 ^ h) // +0, -0 case f !",content:"é‡åˆ°ä¸ªå¥½ç©çš„é—®é¢˜ï¼Œä½¿ç”¨floatç±»å‹ä½œä¸ºgo mapçš„keyï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š å…¶å®å°±æ˜¯æµ®ç‚¹æ•°ç²¾åº¦çš„é—®é¢˜ï¼Œéšæ‰‹ç¿»äº†ä¸‹go mapçš„æºç ï¼Œå¤‡å¿˜ä¸‹ã€‚è¿™é‡Œè¦æ¶‰åŠåˆ°å‡ ä¸ªé—®é¢˜ï¼š\n  golangå¦‚ä½•é’ˆå¯¹keyè®¡ç®—hashçš„ï¼Œé˜…è¯»æºç åå‘ç°å°±æ˜¯æœ‰ä¸ªkey *_typeï¼Œh.key.alg.hash(key)æ¥è®¡ç®—å¾—åˆ°hashï¼Œé—®é¢˜å°±å‡ºåœ¨è¿™é‡Œçš„hashè®¡ç®—è¿‡ç¨‹ï¼Œå¯ä»¥é˜…è¯»ä¸‹alg.goï¼Œé‡Œé¢é’ˆå¯¹ä¸åŒçš„keyç±»å‹å®šä¹‰äº†è®¡ç®—hashçš„æ–¹æ³•ï¼š\nvar algarray = [alg_max]typeAlg{ alg_NOEQ: {nil, nil}, alg_MEM0: {memhash0, memequal0}, alg_MEM8: {memhash8, memequal8}, alg_MEM16: {memhash16, memequal16}, alg_MEM32: {memhash32, memequal32}, alg_MEM64: {memhash64, memequal64}, alg_MEM128: {memhash128, memequal128}, alg_STRING: {strhash, strequal}, alg_INTER: {interhash, interequal}, alg_NILINTER: {nilinterhash, nilinterequal}, alg_FLOAT32: {f32hash, f32equal}, alg_FLOAT64: {f64hash, f64equal}, alg_CPLX64: {c64hash, c64equal}, alg_CPLX128: {c128hash, c128equal}, }  float64å°±æ˜¯è¦ä½¿ç”¨f64hashè¿™ä¸ªæ–¹æ³•æ¥è®¡ç®—hashå€¼ã€‚\n  golangé‡Œé¢åˆ©ç”¨è®¡ç®—å¾—åˆ°çš„hashå€¼çš„å5ä½ä½œä¸ºhmapçš„bucket indexï¼Œå…ˆå®šä½åˆ°bucketï¼Œç„¶åå†æ ¹æ®hashçš„å‰8ä½ä½œä¸ºä¸bucketå†…éƒ¨\u0026lt;k,v\u0026gt; entriesçš„hashè¿›è¡Œæ¯”è¾ƒæ‰¾åˆ°å¯¹åº”çš„entryã€‚\n  ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹f64hashçš„å®ç°ï¼š\nfunc f64hash(p unsafe.Pointer, h uintptr) uintptr { f := *(*float64)(p) switch { case f == 0: return c1 * (c0 ^ h) // +0, -0 case f != f: return c1 * (c0 ^ h ^ uintptr(fastrand())) // any kind of NaN default: return memhash(p, h, 8) } }  f==0æˆ–è€…f!=fæ˜¯ä¸¤ç§æç«¯æƒ…å†µï¼Œä¸è€ƒè™‘ç›´æ¥çœ‹f64hashé‡Œé¢è°ƒç”¨æ–¹æ³•memhash(p, h, 8)ï¼Œmemhashå®ç°ï¼Œçœç•¥æ— å…³ä»£ç ï¼š\nfunc memhash(p unsafe.Pointer, seed, s uintptr) uintptr { if (GOARCH == \u0026quot;amd64\u0026quot; || GOARCH == \u0026quot;arm64\u0026quot;) \u0026amp;\u0026amp; GOOS != \u0026quot;nacl\u0026quot; \u0026amp;\u0026amp; useAeshash { return aeshash(p, seed, s) } h := uint64(seed + s*hashkey[0]) tail: switch { case s == 0: case s \u0026lt; 4: ... case s \u0026lt;= 8: h ^= uint64(readUnaligned32(p)) h ^= uint64(readUnaligned32(add(p, s-4))) \u0026lt;\u0026lt; 32 h = rotl_31(h*m1) * m2 case s \u0026lt;= 16: ... case s \u0026lt;= 32: ... default: ... } h ^= h \u0026gt;\u0026gt; 29 h *= m3 h ^= h \u0026gt;\u0026gt; 32 return uintptr(h) }  ç°åœ¨å¯ä»¥çœ‹åˆ°å®ƒå…¶å®æ˜¯æŠŠæµ®ç‚¹æ•°çš„å†…å­˜è¡¨ç¤ºï¼ˆIEEE 754 double encoding format) å½“åšä¸€ä¸ªæ™®é€šçš„æ•°å­—æ¥è®¡ç®—çš„ï¼Œå…ˆè¯»4å­—èŠ‚è®¡ç®—ï¼Œå†è¯»å‰©ä¸‹çš„4å­—èŠ‚è®¡ç®—ï¼Œå†åšå…¶ä»–è®¡ç®—ã€‚\nä¸¤ä¸ªæµ®ç‚¹æ•°æœ€ç»ˆhashå€¼ç›¸åŒï¼Œå…¶å®å°±æ˜¯æµ®ç‚¹æ•°ç²¾åº¦å¯¼è‡´çš„ï¼Œå†™ä»£ç çš„æ—¶å€™ï¼Œçœ‹ä¸Šå»æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„æµ®ç‚¹æ•°ï¼Œä½†æ˜¯å†…å­˜ä¸­æŒ‰ç…§IEEE 754 doubleçš„è§„èŒƒè¿›è¡Œå†…å­˜è¡¨ç¤ºçš„æ—¶å€™ï¼Œå¾ˆå¯èƒ½å°±æ˜¯ä¸€æ ·çš„ã€‚\nä¸Šé¢æ˜¯IEEE 754 doubleçš„æ ¼å¼ï¼Œ1ä½ç¬¦å·ä½ï¼Œ11ä½é˜¶ç ï¼Œ52ä½å°¾æ•°ï¼ŒåƒNaNã€Infçš„å®šä¹‰ä¹Ÿéƒ½è·Ÿè¿™äº›ä¸åŒçš„ç»„æˆéƒ¨åˆ†æœ‰å…³ã€‚è¿™é‡Œåªå…³å¿ƒå°¾æ•°éƒ¨åˆ†å°±å¥½äº†ï¼Œåªæœ‰52ä½ï¼Œå½“è¶…è¿‡52 bitså¯ä»¥è¡¨ç¤ºçš„ç²¾åº¦ä¹‹åï¼Œä»£ç é‡Œé¢å®šä¹‰çš„æ•°å€¼å°±è¢«æˆªæ–­äº†ã€‚\nç¤ºä¾‹ä»£ç ä¸­ï¼Œçœ‹ä¼¼æ•°å€¼ä¸Šæœ‰ä¸€ä¸¤ä½æœ«å°¾æ•°å­—ä¸åŒçš„æµ®ç‚¹æ•°ï¼Œå†…å­˜è¡¨ç¤ºæ˜¯ç›¸åŒçš„ï¼Œhashå€¼ä¹Ÿç›¸åŒï¼Œå°±ä¼šå‡ºç°mapèµ‹å€¼æ—¶å€¼è¢«è¦†ç›–çš„é—®é¢˜ã€‚\næµ®ç‚¹æ•°çš„æ›´å¤šç»†èŠ‚å¦‚ç¬¦å·ä½ã€é˜¶ç ï¼ˆbiasï¼‰ã€å°¾æ•°ï¼Œä»¥åŠNaNã€Infçš„å®šä¹‰ç­‰ï¼Œå¯ä»¥å‚è€ƒwikipediaäº†è§£æ›´å¤šç»†èŠ‚ã€‚\n"}),a.add({id:324,href:"/tags/%E6%B3%A2%E9%9F%B3737/",title:"æ³¢éŸ³737",description:"",content:""}),a.add({id:325,href:"/blog/2019-03-17-%E6%B3%A2%E9%9F%B3737%E5%9D%A0%E6%AF%81%E4%BA%8B%E6%95%85%E7%9A%84%E8%83%8C%E5%90%8E/",title:"æ³¢éŸ³737å æ¯äº‹æ•…çš„èƒŒå",description:"æ³¢éŸ³ï¼Œä»è¯ç”Ÿåˆ°ç°åœ¨ï¼Œä¸€ç›´éƒ½æ˜¯å…¨çƒç©ºå®¢å¸‚åœºçš„å¼ºæœ‰åŠ›ç«äº‰è€…ï¼Œç„¶è€Œï¼Œå°±æ˜¯è¿™ä¹ˆä¸€å®¶é¡¶å°–çš„ä¼ä¸šï¼Œå´æ¥è¿åˆ¶é€ äº†æƒ¨ä¸å¿ç¹çš„æ€äººäº‹æ•…ã€‚æ³¢éŸ³737 Maxï¼Œåœ¨äººä»¬å¿ƒç›®ä¸­å·²ç„¶æˆä¸ºäº†ä¸€æ¬¾â€œæ€äººâ€æœºå™¨ï¼Œå‡ ç™¾ä¸ªå®¶åº­å°±æ­¤é™·å…¥æ— å°½çš„æ‚²ä¼¤ï¼Œå³ä¾¿èƒ½è·å–é«˜é¢èµ”å¿ï¼Œåˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¿ä¸ä½å†…å¿ƒçš„æ€’ç«ï¼Œå¿ä¸ä½è¦è¿½é—®ï¼Œç©¶ç«Ÿæ˜¯è°å¯¼è‡´äº†è¿™ä¸€ç³»åˆ—äº‹æ•…çš„å‘ç”Ÿï¼\næ³¢éŸ³737 Maxæœºå‹äº‹æ•…å›é¡¾\n2019å¹´3æœˆ10æ—¥ï¼Œä¸€æ¶è½½æœ‰149åä¹˜å®¢å’Œ8ä½æœºç»„äººå‘˜çš„æ³¢éŸ³737 Maxï¼Œä»åŸƒè‰²ä¿„æ¯”äºšçš„äºšçš„æ–¯äºšè´å·´æœºåœºèµ·é£åå¤§çº¦6åˆ†é’Ÿå æ¯ã€‚é£æœºèµ·é£åï¼Œå‚ç›´é€Ÿåº¦ä¸€ç›´ä¸ç¨³å®šï¼Œæœºé•¿ä¹Ÿéå¸¸è­¦è§‰åœ°å‘ç°äº†é—®é¢˜è¯·æ±‚è¿”èˆªï¼Œä½†æ˜¯ä»–æ²¡æƒ³åˆ°çš„æ˜¯ï¼Œä»–é©¾é©¶çš„æ˜¯ä¸€æ¶æ€äººæœºå™¨ï¼Œè€Œä¸æ˜¯å—é£è¡Œå‘˜æ§åˆ¶çš„é£æœºï¼Œåœ¨å…¶å‡ æ¬¡ä¸é£æ§ç³»ç»Ÿç»„ä»¶MCASï¼ˆå¼ºåˆ¶å‹ä½æœºå¤´è½¯ä»¶ç³»ç»Ÿï¼‰æŠ¢å¤ºæ§åˆ¶æƒåè¿˜æ˜¯å¤±è´¥äº†ï¼Œ157æ¡ç”Ÿå‘½å°±æ­¤é”€å£°åŒ¿è¿¹ã€‚\næ³¢éŸ³737 Maxæœºå‹äº‹æ•…åŸå› \nç„¶è€Œï¼Œåœ¨å…¨ä¸–ç•Œäººæ°‘å…³æ³¨çš„ç›®å…‰ä¸­ï¼Œåœ¨å…¨ä¸–ç•Œäººæ°‘è¡¨è¾¾å“€æ‚¼ã€åŒæƒ…çš„åŒæ—¶ï¼Œæ³¢éŸ³å…¬å¸å´ä¸‘é™‹åœ°ç«™åœ¨äº†åˆ©ç›Šçš„ä¸€è¾¹ï¼Œè€Œå®Œå…¨å°†è´£ä»»ã€é“ä¹‰æŠ›ä¹‹ä¸é¡¾ã€‚æ³¢éŸ³å‘è¡¨å£°æ˜ç§°ï¼Œå¯¹737 Maxçš„æŠ€æœ¯è¶³å¤Ÿè‡ªä¿¡ï¼Œå¹¶è¡¨ç¤ºå¦‚æœåŸƒèˆªç©ºå…¬å¸æœ‰éœ€è¦ï¼Œä¼šååŠ©å…¶æ¢å¤æœºé˜Ÿäººå‘˜çš„æ–°äººã€‚å®Œå…¨æ²¡æœ‰è‡ªæˆ‘å®¡è§†çš„æ„è¯†ï¼Œè¿™æ˜¯æå…¶ä¸åº”è¯¥çš„ï¼å› ä¸ºè¿™æ¬¾æœºå‹737 Maxåœ¨æ­¤ä¹‹å‰ï¼Œå·²ç»å‡ºç°äº†ä¸¤æ¬¡å æœºäº‹æ•…ï¼Œä¸”å æœºè¿‡ç¨‹ä¸­è¡¨ç°çš„å¼‚å¸¸æä¸ºç›¸ä¼¼ï¼è¿™å®Œå…¨æ˜¯åŸºäºæ³¢éŸ³è‡ªèº«åˆ©ç›Šè€ƒé‡ï¼Œå®å¯ä¸ºäº†å¤šå–å‡ºå‡ æ¶é£æœºï¼Œä¹Ÿä¸æ„¿æ„ä¸ºæœ¬æ¬¡äº‹æ•…æ‰¿æ‹…è´£ä»»ã€èµ”å¿ã€å®‰æŠšé‡éš¾è€…å®¶å±ï¼\n2018å¹´10æœˆ29æ—¥ï¼Œå°åº¦å°¼è¥¿äºšç‹®èˆª737 Max 8èµ·é£13åˆ†é’Ÿåå å…¥çˆªå“‡æµ·ï¼Œè€ŒåŒå¹´12æœˆ14æ—¥ï¼ŒæŒªå¨èˆªç©ºå…¬å¸737 Max 8èµ·é£åä¹Ÿè¢«è¿«åšå‡ºç´§æ€¥è¿«é™ã€‚å¯ç¬‘çš„æ˜¯ï¼Œç‹®èˆªäº‹æ•…å‘ç”Ÿä¹‹åæ³¢éŸ³æ‰é©¬åç‚®ä¼¼çš„å‘ç‹®èˆªæä¾›äº†ä¸€ä»½æ“ä½œæ‰‹å†Œï¼Œç”¨æ¥è§£å†³é”™è¯¯çš„é©¾é©¶èˆ±è¯»æ•°é—®é¢˜ï¼Œä»è¿™ä¸ªæ—¶å€™å¼€å§‹ï¼ŒMCASï¼ˆå¼ºåˆ¶å‹ä½æœºå¤´è½¯ä»¶ç³»ç»Ÿï¼‰æ‰è¢«æ­éœ²äºé£è¡Œå‘˜é¢å‰ï¼Œè€Œæ³¢éŸ³å¯¹è¿™ä¸ªè½¯ä»¶çš„éšç’æ›´åŠ å‡¸æ˜¾äº†åœ¨åˆ©ç›Šé¢å‰æ³¢éŸ³çš„èƒ¡ä½œéä¸ºã€‚\nMCASï¼ˆå¼ºåˆ¶å‹ä½æœºå¤´è½¯ä»¶ç³»ç»Ÿï¼‰æ˜¯åœ¨è®¾è®¡737 Maxæœºå‹æ—¶å¼•å…¥çš„ï¼Œç”±äºä¸ºäº†æ›´å¥½åœ°ä¸æ¬§æ´²ç©ºä¸­å®¢è½¦èˆªç©ºå…¬å¸è¿›è¡Œç«äº‰ï¼Œæ³¢éŸ³åœ¨åŸæ¥çš„737æœºå‹ä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œä¸€æ˜¯ä¸ºäº†è½½å®¢é‡ï¼Œä¸€æ˜¯ä¸ºäº†çœæ²¹ï¼Œé£æœºåç«¯è¿›è¡Œäº†çª„ä½“è®¾è®¡ï¼Œå¹¶å¢é«˜äº†èµ·è½æ¶é«˜åº¦ï¼Œä»¥æ–¹ä¾¿åœ¨é£æœºå‰ç«¯æŒ‚è£…æ€§èƒ½æ›´å¥½çš„å‘åŠ¨æœºã€‚ä½†è¿™ä¸€è®¾è®¡å­˜åœ¨ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼Œé£æœºèµ·é£æ—¶å®¹æ˜“ä»°è§’è¿‡å¤§å¯¼è‡´é£æœºå æ¯ã€‚ä¸ºæ­¤æ³¢éŸ³å¼•å…¥äº†è½¯ä»¶ç³»ç»ŸMCASï¼Œåœ¨é£æœºé€Ÿåº¦æ¯”è¾ƒä½æ—¶ï¼ˆå¦‚èµ·é£è¿‡ç¨‹ä¸­ï¼‰å¼ºåˆ¶å‹ä½æœºå¤´ã€‚\næ³¢éŸ³å¤„äºè‡ªèº«åˆ©ç›Šçš„è€ƒè™‘ï¼Œå¹¶æ²¡æœ‰åœ¨ä¸€å¼€å§‹å°±å¤–ç•Œå‘ŠçŸ¥æœ‰è¿™æ ·çš„ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿå­˜åœ¨ï¼Œè€Œä¸”æ›´åŠ ç³Ÿç³•çš„æ˜¯ï¼Œè¯¥è½¯ä»¶ç³»ç»Ÿå¯¹é£æœºçš„æ“æ§æƒé™ï¼Œæ¯”é£è¡Œå‘˜è¿˜è¦é«˜ï¼Œå³ä¾¿é£è¡Œå‘˜å¾ˆæœ‰ç»éªŒï¼Œæ„è¯†åˆ°å‡ºç°äº†å±é™©ï¼Œå¦‚é£æœºå‹ä½æœºå¤´å å‘åœ°é¢ï¼Œé£è¡Œå‘˜ä¹Ÿæ²¡åŠæ³•å°†æœºå¤´æ‹‰é«˜å›å½’è‡³æ­£å¸¸é£è¡ŒçŠ¶æ€ï¼Œé£æœºä¹Ÿå°±ä¼šè¡¨ç°å‡ºå‚ç›´é«˜åº¦ä¸ç¨³å®šï¼Œç›´è‡³å æ¯ã€‚\næ³¢éŸ³åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­æç«¯ä¸è´Ÿè´£ä»»ï¼Œå·²ç»å‘ç”Ÿäº†å¤šèµ·äº‹æ•…ï¼Œè‡ªå·±ä¸å»å¬å›å¹¶ä¿®æ­£è®¾è®¡ä¸Šçš„ç¼ºé™·ï¼Œåè€Œç»§ç»­ç­¾è®¢äº†æ›´å¤šçš„è®¢å•ï¼Œå…¨çƒè®¢å•é‡5500+ï¼Œå·²å‡ºè´§350+ã€‚è¢«å…¨ä¸–ç•Œå„å›½ç›¸ç»§åœé£ã€æ‹’å•ï¼Œç®€ç›´æ˜¯æ´»è¯¥ï¼è°æ„¿æ„èŠ±é‡é‡‘ä¹°ä¸€ä¸ªæœºå™¨å›æ¥â€œæ®‹å®³â€è‡ªå·±çš„äººæ°‘å‘¢ï¼Ÿ\nç¾å›½æ”¿åºœåœ¨å½“ä¸­æ‰®æ¼”çš„è§’è‰²\nåœ¨åŸƒèˆªå æœºäº‹æ•…å‘ç”Ÿåï¼Œå…ˆå‰å‘ç”Ÿè¿‡ç±»ä¼¼äº‹æ•…çš„ç‹®èˆªé«˜åº¦æ•æ„Ÿï¼Œæ•´ä»¶äº‹æƒ…ä¹Ÿæ„ˆæ¼”æ„ˆçƒˆï¼Œè¢«å®Œæ•´åœ°æ›å…‰äºä¸–ç•Œé¢å‰ã€‚å„å›½ç›¸ç»§åœé£737 Maxæœºå‹ï¼Œå¹¶å‡ºç°äº†å¤§é‡æ‹’å•çš„æƒ…å†µã€‚ç¾å›½æ”¿åºœæœ€ç»ˆä¹Ÿä¸å¾—ä¸å®£å¸ƒåœé£ï¼Œè¿˜æœ‰è·Ÿå±è™«åŠ æ‹¿å¤§ï¼æ³¢éŸ³å…¬å¸å¯¹äº‹æ•…çš„å¤„ç†è¿‡ç¨‹ï¼Œè®©æˆ‘ä»¬å¯’å¿ƒï¼Œç¾å›½æ”¿åºœåœ¨ä¸–ç•Œäººæ°‘é¢å‰è¡¨ç°å‡ºæ¥çš„å†·æ¼ ä¹Ÿè®©æˆ‘ä»¬åšä¿¡ï¼Œç¾å›½å¹¶æ²¡æœ‰é‚£ä¹ˆç¾ï¼Œåœ¨äººæ°‘é¢å‰ï¼Œè¿˜æ˜¯æœ¬å›½æ”¿åºœæœ€å…³å¿ƒè‡ªå·±çš„äººæ°‘ã€‚\næœ€åå¸Œæœ›æˆ‘å›½å•†é£èƒ½æŒºèµ·æ°‘æ—çš„è„Šæ¢ï¼Œè‡ªå¤ä»¥æ¥â€œé¢†è¢–â€ä»æ¥éƒ½æ˜¯æœ‰èƒ½è€…å±…ä¹‹ï¼Œå¸Œæœ›å•†é£èƒ½åœ¨ä¸è¿œçš„å°†æ¥ï¼Œåœ¨èˆªç©ºå¸‚åœºä¸Šå‚²è§†ç¾¤é›„ã€‚",content:"æ³¢éŸ³ï¼Œä»è¯ç”Ÿåˆ°ç°åœ¨ï¼Œä¸€ç›´éƒ½æ˜¯å…¨çƒç©ºå®¢å¸‚åœºçš„å¼ºæœ‰åŠ›ç«äº‰è€…ï¼Œç„¶è€Œï¼Œå°±æ˜¯è¿™ä¹ˆä¸€å®¶é¡¶å°–çš„ä¼ä¸šï¼Œå´æ¥è¿åˆ¶é€ äº†æƒ¨ä¸å¿ç¹çš„æ€äººäº‹æ•…ã€‚æ³¢éŸ³737 Maxï¼Œåœ¨äººä»¬å¿ƒç›®ä¸­å·²ç„¶æˆä¸ºäº†ä¸€æ¬¾â€œæ€äººâ€æœºå™¨ï¼Œå‡ ç™¾ä¸ªå®¶åº­å°±æ­¤é™·å…¥æ— å°½çš„æ‚²ä¼¤ï¼Œå³ä¾¿èƒ½è·å–é«˜é¢èµ”å¿ï¼Œåˆæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿå¿ä¸ä½å†…å¿ƒçš„æ€’ç«ï¼Œå¿ä¸ä½è¦è¿½é—®ï¼Œç©¶ç«Ÿæ˜¯è°å¯¼è‡´äº†è¿™ä¸€ç³»åˆ—äº‹æ•…çš„å‘ç”Ÿï¼\næ³¢éŸ³737 Maxæœºå‹äº‹æ•…å›é¡¾\n2019å¹´3æœˆ10æ—¥ï¼Œä¸€æ¶è½½æœ‰149åä¹˜å®¢å’Œ8ä½æœºç»„äººå‘˜çš„æ³¢éŸ³737 Maxï¼Œä»åŸƒè‰²ä¿„æ¯”äºšçš„äºšçš„æ–¯äºšè´å·´æœºåœºèµ·é£åå¤§çº¦6åˆ†é’Ÿå æ¯ã€‚é£æœºèµ·é£åï¼Œå‚ç›´é€Ÿåº¦ä¸€ç›´ä¸ç¨³å®šï¼Œæœºé•¿ä¹Ÿéå¸¸è­¦è§‰åœ°å‘ç°äº†é—®é¢˜è¯·æ±‚è¿”èˆªï¼Œä½†æ˜¯ä»–æ²¡æƒ³åˆ°çš„æ˜¯ï¼Œä»–é©¾é©¶çš„æ˜¯ä¸€æ¶æ€äººæœºå™¨ï¼Œè€Œä¸æ˜¯å—é£è¡Œå‘˜æ§åˆ¶çš„é£æœºï¼Œåœ¨å…¶å‡ æ¬¡ä¸é£æ§ç³»ç»Ÿç»„ä»¶MCASï¼ˆå¼ºåˆ¶å‹ä½æœºå¤´è½¯ä»¶ç³»ç»Ÿï¼‰æŠ¢å¤ºæ§åˆ¶æƒåè¿˜æ˜¯å¤±è´¥äº†ï¼Œ157æ¡ç”Ÿå‘½å°±æ­¤é”€å£°åŒ¿è¿¹ã€‚\næ³¢éŸ³737 Maxæœºå‹äº‹æ•…åŸå› \nç„¶è€Œï¼Œåœ¨å…¨ä¸–ç•Œäººæ°‘å…³æ³¨çš„ç›®å…‰ä¸­ï¼Œåœ¨å…¨ä¸–ç•Œäººæ°‘è¡¨è¾¾å“€æ‚¼ã€åŒæƒ…çš„åŒæ—¶ï¼Œæ³¢éŸ³å…¬å¸å´ä¸‘é™‹åœ°ç«™åœ¨äº†åˆ©ç›Šçš„ä¸€è¾¹ï¼Œè€Œå®Œå…¨å°†è´£ä»»ã€é“ä¹‰æŠ›ä¹‹ä¸é¡¾ã€‚æ³¢éŸ³å‘è¡¨å£°æ˜ç§°ï¼Œå¯¹737 Maxçš„æŠ€æœ¯è¶³å¤Ÿè‡ªä¿¡ï¼Œå¹¶è¡¨ç¤ºå¦‚æœåŸƒèˆªç©ºå…¬å¸æœ‰éœ€è¦ï¼Œä¼šååŠ©å…¶æ¢å¤æœºé˜Ÿäººå‘˜çš„æ–°äººã€‚å®Œå…¨æ²¡æœ‰è‡ªæˆ‘å®¡è§†çš„æ„è¯†ï¼Œè¿™æ˜¯æå…¶ä¸åº”è¯¥çš„ï¼å› ä¸ºè¿™æ¬¾æœºå‹737 Maxåœ¨æ­¤ä¹‹å‰ï¼Œå·²ç»å‡ºç°äº†ä¸¤æ¬¡å æœºäº‹æ•…ï¼Œä¸”å æœºè¿‡ç¨‹ä¸­è¡¨ç°çš„å¼‚å¸¸æä¸ºç›¸ä¼¼ï¼è¿™å®Œå…¨æ˜¯åŸºäºæ³¢éŸ³è‡ªèº«åˆ©ç›Šè€ƒé‡ï¼Œå®å¯ä¸ºäº†å¤šå–å‡ºå‡ æ¶é£æœºï¼Œä¹Ÿä¸æ„¿æ„ä¸ºæœ¬æ¬¡äº‹æ•…æ‰¿æ‹…è´£ä»»ã€èµ”å¿ã€å®‰æŠšé‡éš¾è€…å®¶å±ï¼\n2018å¹´10æœˆ29æ—¥ï¼Œå°åº¦å°¼è¥¿äºšç‹®èˆª737 Max 8èµ·é£13åˆ†é’Ÿåå å…¥çˆªå“‡æµ·ï¼Œè€ŒåŒå¹´12æœˆ14æ—¥ï¼ŒæŒªå¨èˆªç©ºå…¬å¸737 Max 8èµ·é£åä¹Ÿè¢«è¿«åšå‡ºç´§æ€¥è¿«é™ã€‚å¯ç¬‘çš„æ˜¯ï¼Œç‹®èˆªäº‹æ•…å‘ç”Ÿä¹‹åæ³¢éŸ³æ‰é©¬åç‚®ä¼¼çš„å‘ç‹®èˆªæä¾›äº†ä¸€ä»½æ“ä½œæ‰‹å†Œï¼Œç”¨æ¥è§£å†³é”™è¯¯çš„é©¾é©¶èˆ±è¯»æ•°é—®é¢˜ï¼Œä»è¿™ä¸ªæ—¶å€™å¼€å§‹ï¼ŒMCASï¼ˆå¼ºåˆ¶å‹ä½æœºå¤´è½¯ä»¶ç³»ç»Ÿï¼‰æ‰è¢«æ­éœ²äºé£è¡Œå‘˜é¢å‰ï¼Œè€Œæ³¢éŸ³å¯¹è¿™ä¸ªè½¯ä»¶çš„éšç’æ›´åŠ å‡¸æ˜¾äº†åœ¨åˆ©ç›Šé¢å‰æ³¢éŸ³çš„èƒ¡ä½œéä¸ºã€‚\nMCASï¼ˆå¼ºåˆ¶å‹ä½æœºå¤´è½¯ä»¶ç³»ç»Ÿï¼‰æ˜¯åœ¨è®¾è®¡737 Maxæœºå‹æ—¶å¼•å…¥çš„ï¼Œç”±äºä¸ºäº†æ›´å¥½åœ°ä¸æ¬§æ´²ç©ºä¸­å®¢è½¦èˆªç©ºå…¬å¸è¿›è¡Œç«äº‰ï¼Œæ³¢éŸ³åœ¨åŸæ¥çš„737æœºå‹ä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œä¸€æ˜¯ä¸ºäº†è½½å®¢é‡ï¼Œä¸€æ˜¯ä¸ºäº†çœæ²¹ï¼Œé£æœºåç«¯è¿›è¡Œäº†çª„ä½“è®¾è®¡ï¼Œå¹¶å¢é«˜äº†èµ·è½æ¶é«˜åº¦ï¼Œä»¥æ–¹ä¾¿åœ¨é£æœºå‰ç«¯æŒ‚è£…æ€§èƒ½æ›´å¥½çš„å‘åŠ¨æœºã€‚ä½†è¿™ä¸€è®¾è®¡å­˜åœ¨ä¸€ä¸ªè‡´å‘½ç¼ºé™·ï¼Œé£æœºèµ·é£æ—¶å®¹æ˜“ä»°è§’è¿‡å¤§å¯¼è‡´é£æœºå æ¯ã€‚ä¸ºæ­¤æ³¢éŸ³å¼•å…¥äº†è½¯ä»¶ç³»ç»ŸMCASï¼Œåœ¨é£æœºé€Ÿåº¦æ¯”è¾ƒä½æ—¶ï¼ˆå¦‚èµ·é£è¿‡ç¨‹ä¸­ï¼‰å¼ºåˆ¶å‹ä½æœºå¤´ã€‚\næ³¢éŸ³å¤„äºè‡ªèº«åˆ©ç›Šçš„è€ƒè™‘ï¼Œå¹¶æ²¡æœ‰åœ¨ä¸€å¼€å§‹å°±å¤–ç•Œå‘ŠçŸ¥æœ‰è¿™æ ·çš„ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿå­˜åœ¨ï¼Œè€Œä¸”æ›´åŠ ç³Ÿç³•çš„æ˜¯ï¼Œè¯¥è½¯ä»¶ç³»ç»Ÿå¯¹é£æœºçš„æ“æ§æƒé™ï¼Œæ¯”é£è¡Œå‘˜è¿˜è¦é«˜ï¼Œå³ä¾¿é£è¡Œå‘˜å¾ˆæœ‰ç»éªŒï¼Œæ„è¯†åˆ°å‡ºç°äº†å±é™©ï¼Œå¦‚é£æœºå‹ä½æœºå¤´å å‘åœ°é¢ï¼Œé£è¡Œå‘˜ä¹Ÿæ²¡åŠæ³•å°†æœºå¤´æ‹‰é«˜å›å½’è‡³æ­£å¸¸é£è¡ŒçŠ¶æ€ï¼Œé£æœºä¹Ÿå°±ä¼šè¡¨ç°å‡ºå‚ç›´é«˜åº¦ä¸ç¨³å®šï¼Œç›´è‡³å æ¯ã€‚\næ³¢éŸ³åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­æç«¯ä¸è´Ÿè´£ä»»ï¼Œå·²ç»å‘ç”Ÿäº†å¤šèµ·äº‹æ•…ï¼Œè‡ªå·±ä¸å»å¬å›å¹¶ä¿®æ­£è®¾è®¡ä¸Šçš„ç¼ºé™·ï¼Œåè€Œç»§ç»­ç­¾è®¢äº†æ›´å¤šçš„è®¢å•ï¼Œå…¨çƒè®¢å•é‡5500+ï¼Œå·²å‡ºè´§350+ã€‚è¢«å…¨ä¸–ç•Œå„å›½ç›¸ç»§åœé£ã€æ‹’å•ï¼Œç®€ç›´æ˜¯æ´»è¯¥ï¼è°æ„¿æ„èŠ±é‡é‡‘ä¹°ä¸€ä¸ªæœºå™¨å›æ¥â€œæ®‹å®³â€è‡ªå·±çš„äººæ°‘å‘¢ï¼Ÿ\nç¾å›½æ”¿åºœåœ¨å½“ä¸­æ‰®æ¼”çš„è§’è‰²\nåœ¨åŸƒèˆªå æœºäº‹æ•…å‘ç”Ÿåï¼Œå…ˆå‰å‘ç”Ÿè¿‡ç±»ä¼¼äº‹æ•…çš„ç‹®èˆªé«˜åº¦æ•æ„Ÿï¼Œæ•´ä»¶äº‹æƒ…ä¹Ÿæ„ˆæ¼”æ„ˆçƒˆï¼Œè¢«å®Œæ•´åœ°æ›å…‰äºä¸–ç•Œé¢å‰ã€‚å„å›½ç›¸ç»§åœé£737 Maxæœºå‹ï¼Œå¹¶å‡ºç°äº†å¤§é‡æ‹’å•çš„æƒ…å†µã€‚ç¾å›½æ”¿åºœæœ€ç»ˆä¹Ÿä¸å¾—ä¸å®£å¸ƒåœé£ï¼Œè¿˜æœ‰è·Ÿå±è™«åŠ æ‹¿å¤§ï¼æ³¢éŸ³å…¬å¸å¯¹äº‹æ•…çš„å¤„ç†è¿‡ç¨‹ï¼Œè®©æˆ‘ä»¬å¯’å¿ƒï¼Œç¾å›½æ”¿åºœåœ¨ä¸–ç•Œäººæ°‘é¢å‰è¡¨ç°å‡ºæ¥çš„å†·æ¼ ä¹Ÿè®©æˆ‘ä»¬åšä¿¡ï¼Œç¾å›½å¹¶æ²¡æœ‰é‚£ä¹ˆç¾ï¼Œåœ¨äººæ°‘é¢å‰ï¼Œè¿˜æ˜¯æœ¬å›½æ”¿åºœæœ€å…³å¿ƒè‡ªå·±çš„äººæ°‘ã€‚\næœ€åå¸Œæœ›æˆ‘å›½å•†é£èƒ½æŒºèµ·æ°‘æ—çš„è„Šæ¢ï¼Œè‡ªå¤ä»¥æ¥â€œé¢†è¢–â€ä»æ¥éƒ½æ˜¯æœ‰èƒ½è€…å±…ä¹‹ï¼Œå¸Œæœ›å•†é£èƒ½åœ¨ä¸è¿œçš„å°†æ¥ï¼Œåœ¨èˆªç©ºå¸‚åœºä¸Šå‚²è§†ç¾¤é›„ã€‚\n"}),a.add({id:326,href:"/tags/%E7%A7%91%E6%8A%80/",title:"ç§‘æŠ€",description:"",content:""}),a.add({id:327,href:"/tags/calendar/",title:"calendar",description:"",content:""}),a.add({id:328,href:"/tags/macos/",title:"macOS",description:"",content:""}),a.add({id:329,href:"/blog/2019-02-23-macos%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%95%88todolist/",title:"macOSå®ç°é«˜æ•ˆtodolist",description:"img { width: 680px; padding-bottom: 1rem; }  é«˜æ•ˆ â€œTodoâ€ # Appleè®¾å¤‡ä¸Šæœ‰ä¸€ä¸ªéå¸¸å¥½çš„æ•ˆç‡å·¥å…·â€œCalendar.appï¼ˆæ—¥å†ï¼‰â€ï¼Œåœ¨æ—¥å†ä¸­å¯ä»¥æ·»åŠ å¾…åŠäº‹é¡¹ï¼Œå¹¶ä¸”æ”¯æŒæŒ‰å¤©ã€å‘¨ã€æœˆã€å¹´è§†å›¾è¿›è¡Œå¿«é€Ÿæµè§ˆï¼Œæ˜¯å·¥ä½œã€å­¦ä¹ çš„å¥½å¸®æ‰‹ã€‚å·¥ä½œä¸­ï¼Œè‡ªå·±çš„æƒ³æ³•ã€ä»–äººçš„åé¦ˆã€é—®é¢˜è¦ç‚¹ç­‰éœ€è¦å¿«é€Ÿè®°å½•ä¸‹æ¥ï¼Œæ¯æ¬¡å”¤é†’æ—¥å†è¿›è¡Œæ‰‹åŠ¨æ·»åŠ è¿˜æ˜¯æœ‰ç‚¹ä½æ•ˆï¼Œèƒ½ä¸èƒ½å®ç°æ›´é«˜æ•ˆåœ°â€œTodoâ€å‘¢ï¼Ÿ æƒ³è±¡ä¸€ä¸‹æ‰‹åŠ¨æ‰“å¼€æ—¥å†ï¼Œå®šä½åˆ°ä»Šå¤©ï¼Œæ»‘åŠ¨åˆ°ä¸‹æ–¹æ‰¾ä¸€ä¸ªåˆé€‚çš„æ—¶é—´ç‚¹æ·»åŠ å¾…åŠäº‹é¡¹ï¼Œè¾“å…¥æè¿°ä¿¡æ¯å†å›åˆ°åŸæ¥çš„å·¥ä½œï¼Œéº»çƒ¦ï¼ç»“åˆAlfred+AppleScriptç¼–å†™äº†ä¸€ä¸ªWorkflowï¼Œç°åœ¨æ–¹ä¾¿å¤šäº†ï¼Œå®ç°äº†å¦‚ä¸‹æ•ˆæœã€‚å¿«æ·é”®å¿«é€Ÿå‘¼å‡ºAlfredäº¤äº’è¾“å…¥æ¡†ï¼Œç„¶åé”®å…¥â€œtodo å¾…åŠäº‹é¡¹æè¿°ä¿¡æ¯ï¼Œç„¶åé”®å…¥â€œå›è½¦â€ï¼Œæ­¤æ—¶å°±å¯ä»¥è‡ªåŠ¨æ·»åŠ ä¸€æ¡æ–°çš„å¾…åŠäº‹é¡¹åˆ°æ—¥å†ä¸­ï¼Œæ˜¯ä¸æ˜¯æ–¹ä¾¿å¤šäº†ï¼ æ‰§è¡Œä¸Šè¿°æ“ä½œä¹‹åï¼š\n è‹¥æ—¥å†ç¨‹åºæ²¡å¯åŠ¨ï¼Œæ·»åŠ æˆåŠŸä¼šå¯åŠ¨æ—¥å†å¹¶æåˆ°å‰å°ï¼Œå±•ç¤ºå½“å‰æ·»åŠ çš„å¾…åŠäº‹é¡¹ï¼› è‹¥æ—¥å†ç¨‹åºå·²å¯åŠ¨ï¼Œæ·»åŠ æˆåŠŸä¸ä¼šå†å°†æ—¥å†æåˆ°å‰å°ï¼Œåœ¨é€šçŸ¥ä¸­å¿ƒå‘ä¸€æ¡æ·»åŠ æˆåŠŸçš„é€šçŸ¥ï¼›   æˆ‘æƒ³è¦çš„é«˜æ•ˆâ€œTodoâ€æ˜¯è¿‘ä¼¼è¿™æ ·çš„ï¼Œç›®å‰èƒ½åŸºæœ¬æ»¡è¶³æˆ‘çš„è¦æ±‚ã€‚è¿™é‡Œçš„å®ç°æ–¹å¼æ˜¯ï¼Œæ‰“å¼€Alfred-\u0026gt;Preferences-\u0026gt;Workflowsï¼Œæ–°å»ºä¸€ä¸ªBlank Flowï¼Œç„¶åé…ç½®å¦‚ä¸‹ï¼š workflowä¸­todoèŠ‚ç‚¹è·å–è¾“å…¥çš„å¾…åŠäº‹é¡¹ï¼Œå¹¶å°†è¾“å…¥ä¿¡æ¯é€šè¿‡è„šæœ¬å‚æ•°çš„å½¢å¼ä¼ é€’ç»™åç»­çš„osacriptè¿›è¡Œå¤„ç†ï¼Œè¯¥è„šæœ¬è´Ÿè´£æ·»åŠ å¾…åŠäº‹é¡¹åˆ°æ—¥å†ã€‚workflowä¸­ä¸¤ä¸ªèŠ‚ç‚¹çš„é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š å®Œæ•´çš„è„šæœ¬ä»£ç å¦‚ä¸‹ï¼š\non run set theQuery to \u0026quot;{query}\u0026quot; -------------------------------------------------------------------------- -- ä»Šå¤©çš„å¼€å§‹ã€ç»“æŸï¼Œç”¨äºç­›é€‰ä»Šå¤©çš„äº‹ä»¶åˆ—è¡¨ set todayStart to (current date) set time of todayStart to 0 copy todayStart to todayEnd set time of todayEnd to 86400 -- å¾…æ·»åŠ äº‹ä»¶çš„å¼€å§‹ã€ç»“æŸæ—¶é—´ï¼Œæˆ‘å–œæ¬¢æŒ‰ç…§æ—¶é—´é¡ºåºè¿½åŠ çš„æ·»åŠ æ–¹å¼ copy todayStart to todoStart set minutes of todoStart to 0 set seconds of todoStart to 0 -- å¯åŠ¨Calendarç­›é€‰ä»Šå¤©å†…æ·»åŠ çš„todoäº‹ä»¶åˆ—è¡¨ tell application \u0026quot;Calendar\u0026quot; tell calendar \u0026quot;todo\u0026quot; -- éå†todoäº‹ä»¶åˆ—è¡¨æ‰¾åˆ°æœ€åæ·»åŠ çš„äº‹ä»¶ set allEvents to (every event where its start date is greater than or equal to todayStart and end date is less than todayEnd) repeat with e in allEvents set t to start date of e if t â‰¥ todoStart then copy t to todoStart end if end repeat -- ç»§ç»­è¿½åŠ æ–°todoäº‹ä»¶ if hours of todoStart is equal to 0 then set hours of todoStart to 8 else set todoStart to todoStart + (1 * hours) end if set todoEnd to todoStart + (1 * hours) make new event with properties {summary:theQuery, start date:todoStart, end date:todoEnd} end tell -- å¯åŠ¨Calendaræ˜¾ç¤º if not running then run delay 0.",content:" img { width: 680px; padding-bottom: 1rem; }  é«˜æ•ˆ â€œTodoâ€ # Appleè®¾å¤‡ä¸Šæœ‰ä¸€ä¸ªéå¸¸å¥½çš„æ•ˆç‡å·¥å…·â€œCalendar.appï¼ˆæ—¥å†ï¼‰â€ï¼Œåœ¨æ—¥å†ä¸­å¯ä»¥æ·»åŠ å¾…åŠäº‹é¡¹ï¼Œå¹¶ä¸”æ”¯æŒæŒ‰å¤©ã€å‘¨ã€æœˆã€å¹´è§†å›¾è¿›è¡Œå¿«é€Ÿæµè§ˆï¼Œæ˜¯å·¥ä½œã€å­¦ä¹ çš„å¥½å¸®æ‰‹ã€‚å·¥ä½œä¸­ï¼Œè‡ªå·±çš„æƒ³æ³•ã€ä»–äººçš„åé¦ˆã€é—®é¢˜è¦ç‚¹ç­‰éœ€è¦å¿«é€Ÿè®°å½•ä¸‹æ¥ï¼Œæ¯æ¬¡å”¤é†’æ—¥å†è¿›è¡Œæ‰‹åŠ¨æ·»åŠ è¿˜æ˜¯æœ‰ç‚¹ä½æ•ˆï¼Œèƒ½ä¸èƒ½å®ç°æ›´é«˜æ•ˆåœ°â€œTodoâ€å‘¢ï¼Ÿ æƒ³è±¡ä¸€ä¸‹æ‰‹åŠ¨æ‰“å¼€æ—¥å†ï¼Œå®šä½åˆ°ä»Šå¤©ï¼Œæ»‘åŠ¨åˆ°ä¸‹æ–¹æ‰¾ä¸€ä¸ªåˆé€‚çš„æ—¶é—´ç‚¹æ·»åŠ å¾…åŠäº‹é¡¹ï¼Œè¾“å…¥æè¿°ä¿¡æ¯å†å›åˆ°åŸæ¥çš„å·¥ä½œï¼Œéº»çƒ¦ï¼ç»“åˆAlfred+AppleScriptç¼–å†™äº†ä¸€ä¸ªWorkflowï¼Œç°åœ¨æ–¹ä¾¿å¤šäº†ï¼Œå®ç°äº†å¦‚ä¸‹æ•ˆæœã€‚å¿«æ·é”®å¿«é€Ÿå‘¼å‡ºAlfredäº¤äº’è¾“å…¥æ¡†ï¼Œç„¶åé”®å…¥â€œtodo å¾…åŠäº‹é¡¹æè¿°ä¿¡æ¯ï¼Œç„¶åé”®å…¥â€œå›è½¦â€ï¼Œæ­¤æ—¶å°±å¯ä»¥è‡ªåŠ¨æ·»åŠ ä¸€æ¡æ–°çš„å¾…åŠäº‹é¡¹åˆ°æ—¥å†ä¸­ï¼Œæ˜¯ä¸æ˜¯æ–¹ä¾¿å¤šäº†ï¼ æ‰§è¡Œä¸Šè¿°æ“ä½œä¹‹åï¼š\n è‹¥æ—¥å†ç¨‹åºæ²¡å¯åŠ¨ï¼Œæ·»åŠ æˆåŠŸä¼šå¯åŠ¨æ—¥å†å¹¶æåˆ°å‰å°ï¼Œå±•ç¤ºå½“å‰æ·»åŠ çš„å¾…åŠäº‹é¡¹ï¼› è‹¥æ—¥å†ç¨‹åºå·²å¯åŠ¨ï¼Œæ·»åŠ æˆåŠŸä¸ä¼šå†å°†æ—¥å†æåˆ°å‰å°ï¼Œåœ¨é€šçŸ¥ä¸­å¿ƒå‘ä¸€æ¡æ·»åŠ æˆåŠŸçš„é€šçŸ¥ï¼›   æˆ‘æƒ³è¦çš„é«˜æ•ˆâ€œTodoâ€æ˜¯è¿‘ä¼¼è¿™æ ·çš„ï¼Œç›®å‰èƒ½åŸºæœ¬æ»¡è¶³æˆ‘çš„è¦æ±‚ã€‚è¿™é‡Œçš„å®ç°æ–¹å¼æ˜¯ï¼Œæ‰“å¼€Alfred-\u0026gt;Preferences-\u0026gt;Workflowsï¼Œæ–°å»ºä¸€ä¸ªBlank Flowï¼Œç„¶åé…ç½®å¦‚ä¸‹ï¼š workflowä¸­todoèŠ‚ç‚¹è·å–è¾“å…¥çš„å¾…åŠäº‹é¡¹ï¼Œå¹¶å°†è¾“å…¥ä¿¡æ¯é€šè¿‡è„šæœ¬å‚æ•°çš„å½¢å¼ä¼ é€’ç»™åç»­çš„osacriptè¿›è¡Œå¤„ç†ï¼Œè¯¥è„šæœ¬è´Ÿè´£æ·»åŠ å¾…åŠäº‹é¡¹åˆ°æ—¥å†ã€‚workflowä¸­ä¸¤ä¸ªèŠ‚ç‚¹çš„é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š å®Œæ•´çš„è„šæœ¬ä»£ç å¦‚ä¸‹ï¼š\non run set theQuery to \u0026quot;{query}\u0026quot; -------------------------------------------------------------------------- -- ä»Šå¤©çš„å¼€å§‹ã€ç»“æŸï¼Œç”¨äºç­›é€‰ä»Šå¤©çš„äº‹ä»¶åˆ—è¡¨ set todayStart to (current date) set time of todayStart to 0 copy todayStart to todayEnd set time of todayEnd to 86400 -- å¾…æ·»åŠ äº‹ä»¶çš„å¼€å§‹ã€ç»“æŸæ—¶é—´ï¼Œæˆ‘å–œæ¬¢æŒ‰ç…§æ—¶é—´é¡ºåºè¿½åŠ çš„æ·»åŠ æ–¹å¼ copy todayStart to todoStart set minutes of todoStart to 0 set seconds of todoStart to 0 -- å¯åŠ¨Calendarç­›é€‰ä»Šå¤©å†…æ·»åŠ çš„todoäº‹ä»¶åˆ—è¡¨ tell application \u0026quot;Calendar\u0026quot; tell calendar \u0026quot;todo\u0026quot; -- éå†todoäº‹ä»¶åˆ—è¡¨æ‰¾åˆ°æœ€åæ·»åŠ çš„äº‹ä»¶ set allEvents to (every event where its start date is greater than or equal to todayStart and end date is less than todayEnd) repeat with e in allEvents set t to start date of e if t â‰¥ todoStart then copy t to todoStart end if end repeat -- ç»§ç»­è¿½åŠ æ–°todoäº‹ä»¶ if hours of todoStart is equal to 0 then set hours of todoStart to 8 else set todoStart to todoStart + (1 * hours) end if set todoEnd to todoStart + (1 * hours) make new event with properties {summary:theQuery, start date:todoStart, end date:todoEnd} end tell -- å¯åŠ¨Calendaræ˜¾ç¤º if not running then run delay 0.25 activate else set msg to \u0026quot;æ·»åŠ æˆåŠŸï¼š\u0026quot; \u0026amp; theQuery display notification msg end if end tell ---------------------------------------------------------------------- return theQuery end run  AppleScriptä¸å¤ªç†Ÿï¼Œä¸œæ‹¼è¥¿å‡‘æ”’å‡ºæ¥è¿™ä¸ªå°å·¥å…·ï¼Œè¿˜æ”’äº†ä¸€äº›å…¶ä»–å°å·¥å…·\u0026hellip; å¸Œæœ›å¯¹å¤§å®¶æœ‰å¸®åŠ©ï¼\n"}),a.add({id:330,href:"/tags/todo/",title:"todo",description:"",content:""}),a.add({id:331,href:"/tags/todolist/",title:"todolist",description:"",content:""}),a.add({id:332,href:"/tags/eof/",title:"eof",description:"",content:""}),a.add({id:333,href:"/tags/fin/",title:"fin",description:"",content:""}),a.add({id:334,href:"/tags/half-closed/",title:"half closed",description:"",content:""}),a.add({id:335,href:"/tags/tcp/",title:"tcp",description:"",content:""}),a.add({id:336,href:"/blog/2018-12-20-write-closed-tcpconn/",title:"write closed tcpconn",description:"é—®é¢˜èƒŒæ™¯ # tcp client: write to a half-closed tcp connection!\nè¿™é‡Œæ¢è®¨ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼ŒWrite to a closed tcp connectionçš„é—®é¢˜ã€‚åœ¨æ·±å…¥è®¨è®ºè¿™äº›é—®é¢˜ä¹‹å‰ï¼Œé¦–å…ˆè¦äº†è§£tcp state diagramï¼Œä¸ºæ­¤æ–‡æœ«ç‰¹åœ°é™„ä¸Šäº†ç»å…¸çš„tcpçŠ¶æ€è½¬æ¢å›¾ã€‚\næˆ‘ä»¬çš„åœºæ™¯æ˜¯è¿™æ ·çš„ï¼Œtcp serverå·²ç»å¯åŠ¨ï¼Œç„¶åtcp clientä¸»åŠ¨å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œè¿æ¥æˆåŠŸå»ºç«‹åï¼Œtcp clientå¹¶ä¸ç«‹å³å‘é€æ•°æ®è€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå‘é€æ•°æ®ï¼ˆè¿™ç§åœ¨clientç«¯çš„tcpè¿æ¥æ± ä¸­éå¸¸å¸¸è§ï¼‰ï¼Œtcp serverç«¯ä¸ºäº†é˜²æ­¢è¿æ¥è¢«æ»¥ç”¨ï¼Œä¼šæ¯éš”30sé’Ÿæ£€æŸ¥ä¸€ä¸‹tcpè¿æ¥æ˜¯å¦ç©ºé—²ï¼Œå¦‚æœä¸¤æ¬¡æ£€æŸ¥éƒ½å‘ç°tcpè¿æ¥ç©ºé—²åˆ™ä¸»åŠ¨å°†è¿æ¥å…³é—­ã€‚\nåŸå› åˆ†æ # æ­¤æ—¶tcp serverç«¯ä¼šè°ƒç”¨conn.Close()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šå¯¼è‡´ä¼ è¾“å±‚å‘é€tcp FINåŒ…ç»™å¯¹ç«¯ï¼Œtcp clientè¿™è¾¹çš„æœºå™¨æ”¶åˆ°FINåŒ…åä¼šå›ä¸€ä¸ªACKï¼Œç„¶åå‘¢ï¼Ÿtcp clientä¸ä¼šç»§ç»­å‘FINåŒ…ç»™tcp serverå—ï¼Ÿä¸ä¼šï¼ä»…æ­¤è€Œå·²ã€‚é—®é¢˜å°±æ˜¯è¿™ä¹ˆè¯ç”Ÿçš„ï¼Œä»€ä¹ˆé—®é¢˜å‘¢ï¼Œtcp clientä»ç„¶å¯ä»¥å‘åŒ…ï¼Œä½†æ˜¯n, err := tcpconn.Write(...)è¿™ä¸ªæ—¶å€™å¹¶ä¸ä¼šæ£€æµ‹åˆ°err != nilï¼Œåªæœ‰ç­‰åˆ°n, err := tcpconn.Read(...)çš„æ—¶å€™æ‰ä¼šå‘ç°errä¸ºio.EOFï¼Œè¿™ä¸ªæ—¶å€™æ‰èƒ½åˆ¤æ–­å¾—çŸ¥tcp serverå·²ç»æŠŠè¿æ¥é”€æ¯äº†ã€‚\nä»RPCæ¡†æ¶è§’åº¦è€Œè¨€ï¼Œå¸Œæœ›ä¸ºclientç»´æŠ¤çš„tcpè¿æ¥æ± æ˜¯é«˜æ•ˆå¯ç”¨çš„ï¼Œæ‰€ä»¥æƒ³å¯¹ä¸Šè¿°æƒ…å†µä¸‹çš„å®¢æˆ·ç«¯è¿æ¥è¿›è¡Œæ£€æµ‹ï¼Œé¿å…è¿æ¥æ± ä¸­å­˜åœ¨ä¸Šè¿°è¢«tcp serverå…³é—­çš„è¿æ¥ã€‚\nå†ç®€å•æ€»ç»“ä¸‹tcp serverã€tcp clientä¸¤ç«¯çš„ä¸åŒå¤„ç†é€»è¾‘ï¼š\n  ä»tcp serverçš„è§†è§’æ¥çœ‹ï¼Œ\ntcp serverè°ƒç”¨çš„conn.Close()ï¼Œå¯¹åº”çš„æ˜¯ç³»ç»Ÿè°ƒç”¨closeï¼Œtcp serverç«¯è®¤ä¸ºå®ƒå·²ç»å½»åº•å…³é—­è¿™ä¸ªè¿æ¥äº†ï¼\n  ä»tcp clientçš„è§†è§’æ¥çœ‹ï¼Œ\nè¿™ä¸ªè¿æ¥æ˜¯æˆ‘ä¸»åŠ¨å»ºç«‹çš„ï¼Œæˆ‘è¿˜æ²¡æœ‰ç»™ä½ å‘é€FINåŒ…å‘èµ·å…³é—­åºåˆ—å‘¢ï¼Œå› æ­¤è¿™ä¸ªè¿æ¥ä»ç„¶æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚tcp clientè®¤ä¸ºtcp serveråªæ˜¯å…³é—­äº†å†™ç«¯ï¼Œæ²¡æœ‰å…³é—­è¯»ç«¯ï¼Œå› æ­¤tcp clientä»ç„¶æ˜¯å¯å†™çš„ï¼Œå¹¶ä¸”socketè¢«è®¾ç½®æˆäº†nonblockingï¼Œconn.Write()ä»ç„¶æ˜¯æˆåŠŸè¿”å›çš„ï¼Œè¿”å›çš„err == nilã€‚ä½†æ˜¯å½“çœŸæ­£ä¼ è¾“å±‚æ‰§è¡Œæ•°æ®å‘é€çš„æ—¶å€™ï¼Œtcp serverç«¯è®¤ä¸ºè¿™ä¸ªè¿æ¥å·²é”€æ¯ï¼Œå› æ­¤ä¼šè¿”å›RSTï¼è¿™ä¸ªæ—¶å€™ä¸Šå±‚goä»£ç å› ä¸ºå·²ç»è¿”å›å·²ç»æ„ŸçŸ¥ä¸åˆ°å†™çš„æ—¶å€™å­˜åœ¨é”™è¯¯ï¼Œè¿™ä¸ªRSTä¼šå°†tcp clientç«¯çš„socketæ ‡è®°ä¸ºå·²å…³é—­ã€‚ä¸‹æ¬¡tcpconn.Readçš„æ—¶å€™å°±èƒ½æ„ŸçŸ¥åˆ°io.EOFé”™è¯¯äº†ï¼Œå¦‚æœå†å‘èµ·ä¸€æ¬¡tcpconn.Writeä¹Ÿå¯ä»¥ç«‹å³è¿”å›é”™è¯¯ã€‚\n  å…³äºcloseä¸shutdown # å‡å¦‚tcp serverè°ƒç”¨çš„ä¸æ˜¯conn.",content:"é—®é¢˜èƒŒæ™¯ # tcp client: write to a half-closed tcp connection!\nè¿™é‡Œæ¢è®¨ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼ŒWrite to a closed tcp connectionçš„é—®é¢˜ã€‚åœ¨æ·±å…¥è®¨è®ºè¿™äº›é—®é¢˜ä¹‹å‰ï¼Œé¦–å…ˆè¦äº†è§£tcp state diagramï¼Œä¸ºæ­¤æ–‡æœ«ç‰¹åœ°é™„ä¸Šäº†ç»å…¸çš„tcpçŠ¶æ€è½¬æ¢å›¾ã€‚\næˆ‘ä»¬çš„åœºæ™¯æ˜¯è¿™æ ·çš„ï¼Œtcp serverå·²ç»å¯åŠ¨ï¼Œç„¶åtcp clientä¸»åŠ¨å»ºç«‹è¿æ¥è¯·æ±‚ï¼Œè¿æ¥æˆåŠŸå»ºç«‹åï¼Œtcp clientå¹¶ä¸ç«‹å³å‘é€æ•°æ®è€Œæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åæ‰ä¼šå‘é€æ•°æ®ï¼ˆè¿™ç§åœ¨clientç«¯çš„tcpè¿æ¥æ± ä¸­éå¸¸å¸¸è§ï¼‰ï¼Œtcp serverç«¯ä¸ºäº†é˜²æ­¢è¿æ¥è¢«æ»¥ç”¨ï¼Œä¼šæ¯éš”30sé’Ÿæ£€æŸ¥ä¸€ä¸‹tcpè¿æ¥æ˜¯å¦ç©ºé—²ï¼Œå¦‚æœä¸¤æ¬¡æ£€æŸ¥éƒ½å‘ç°tcpè¿æ¥ç©ºé—²åˆ™ä¸»åŠ¨å°†è¿æ¥å…³é—­ã€‚\nåŸå› åˆ†æ # æ­¤æ—¶tcp serverç«¯ä¼šè°ƒç”¨conn.Close()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æœ€ç»ˆä¼šå¯¼è‡´ä¼ è¾“å±‚å‘é€tcp FINåŒ…ç»™å¯¹ç«¯ï¼Œtcp clientè¿™è¾¹çš„æœºå™¨æ”¶åˆ°FINåŒ…åä¼šå›ä¸€ä¸ªACKï¼Œç„¶åå‘¢ï¼Ÿtcp clientä¸ä¼šç»§ç»­å‘FINåŒ…ç»™tcp serverå—ï¼Ÿä¸ä¼šï¼ä»…æ­¤è€Œå·²ã€‚é—®é¢˜å°±æ˜¯è¿™ä¹ˆè¯ç”Ÿçš„ï¼Œä»€ä¹ˆé—®é¢˜å‘¢ï¼Œtcp clientä»ç„¶å¯ä»¥å‘åŒ…ï¼Œä½†æ˜¯n, err := tcpconn.Write(...)è¿™ä¸ªæ—¶å€™å¹¶ä¸ä¼šæ£€æµ‹åˆ°err != nilï¼Œåªæœ‰ç­‰åˆ°n, err := tcpconn.Read(...)çš„æ—¶å€™æ‰ä¼šå‘ç°errä¸ºio.EOFï¼Œè¿™ä¸ªæ—¶å€™æ‰èƒ½åˆ¤æ–­å¾—çŸ¥tcp serverå·²ç»æŠŠè¿æ¥é”€æ¯äº†ã€‚\nä»RPCæ¡†æ¶è§’åº¦è€Œè¨€ï¼Œå¸Œæœ›ä¸ºclientç»´æŠ¤çš„tcpè¿æ¥æ± æ˜¯é«˜æ•ˆå¯ç”¨çš„ï¼Œæ‰€ä»¥æƒ³å¯¹ä¸Šè¿°æƒ…å†µä¸‹çš„å®¢æˆ·ç«¯è¿æ¥è¿›è¡Œæ£€æµ‹ï¼Œé¿å…è¿æ¥æ± ä¸­å­˜åœ¨ä¸Šè¿°è¢«tcp serverå…³é—­çš„è¿æ¥ã€‚\nå†ç®€å•æ€»ç»“ä¸‹tcp serverã€tcp clientä¸¤ç«¯çš„ä¸åŒå¤„ç†é€»è¾‘ï¼š\n  ä»tcp serverçš„è§†è§’æ¥çœ‹ï¼Œ\ntcp serverè°ƒç”¨çš„conn.Close()ï¼Œå¯¹åº”çš„æ˜¯ç³»ç»Ÿè°ƒç”¨closeï¼Œtcp serverç«¯è®¤ä¸ºå®ƒå·²ç»å½»åº•å…³é—­è¿™ä¸ªè¿æ¥äº†ï¼\n  ä»tcp clientçš„è§†è§’æ¥çœ‹ï¼Œ\nè¿™ä¸ªè¿æ¥æ˜¯æˆ‘ä¸»åŠ¨å»ºç«‹çš„ï¼Œæˆ‘è¿˜æ²¡æœ‰ç»™ä½ å‘é€FINåŒ…å‘èµ·å…³é—­åºåˆ—å‘¢ï¼Œå› æ­¤è¿™ä¸ªè¿æ¥ä»ç„¶æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚tcp clientè®¤ä¸ºtcp serveråªæ˜¯å…³é—­äº†å†™ç«¯ï¼Œæ²¡æœ‰å…³é—­è¯»ç«¯ï¼Œå› æ­¤tcp clientä»ç„¶æ˜¯å¯å†™çš„ï¼Œå¹¶ä¸”socketè¢«è®¾ç½®æˆäº†nonblockingï¼Œconn.Write()ä»ç„¶æ˜¯æˆåŠŸè¿”å›çš„ï¼Œè¿”å›çš„err == nilã€‚ä½†æ˜¯å½“çœŸæ­£ä¼ è¾“å±‚æ‰§è¡Œæ•°æ®å‘é€çš„æ—¶å€™ï¼Œtcp serverç«¯è®¤ä¸ºè¿™ä¸ªè¿æ¥å·²é”€æ¯ï¼Œå› æ­¤ä¼šè¿”å›RSTï¼è¿™ä¸ªæ—¶å€™ä¸Šå±‚goä»£ç å› ä¸ºå·²ç»è¿”å›å·²ç»æ„ŸçŸ¥ä¸åˆ°å†™çš„æ—¶å€™å­˜åœ¨é”™è¯¯ï¼Œè¿™ä¸ªRSTä¼šå°†tcp clientç«¯çš„socketæ ‡è®°ä¸ºå·²å…³é—­ã€‚ä¸‹æ¬¡tcpconn.Readçš„æ—¶å€™å°±èƒ½æ„ŸçŸ¥åˆ°io.EOFé”™è¯¯äº†ï¼Œå¦‚æœå†å‘èµ·ä¸€æ¬¡tcpconn.Writeä¹Ÿå¯ä»¥ç«‹å³è¿”å›é”™è¯¯ã€‚\n  å…³äºcloseä¸shutdown # å‡å¦‚tcp serverè°ƒç”¨çš„ä¸æ˜¯conn.Close()ï¼Œè€Œæ˜¯conn.CloseWrite()ï¼Œè¿™ä¸ªå¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨shutdown(SHUT_WR)ï¼Œé‚£åªè¡¨ç¤ºå†™ç«¯å…³é—­ï¼Œè¿™ä¸ªæ—¶å€™tcp clientå‘é€æ•°æ®è¿‡å»ï¼Œtcp serverç«¯è¿”å›çš„å°±ä¸æ˜¯RSTäº†ï¼Œè€Œæ˜¯æ­£å¸¸çš„ACKï¼Œå› ä¸ºtcp serverç«¯ä¹Ÿè®¤ä¸ºè¿™ä¸ªè¿æ¥åªæ˜¯å…³é—­äº†å†™ç«¯ã€‚\næœ¬è´¨ä¸Šæ¥è¯´ï¼Œå†…æ ¸åœ¨å¤„ç†ç³»ç»Ÿè°ƒç”¨closeã€shutdownçš„æ—¶å€™å¯¹å¥—æ¥å­—çš„å¤„ç†æ˜¯æœ‰å·®å¼‚çš„ï¼Œcloseçš„æ—¶å€™å¯¹fdå¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥é”€æ¯å¥—æ¥å­—ï¼Œè®¤ä¸ºå¯¹åº”çš„è¿æ¥ä¸å†æœ‰æ•ˆäº†ï¼ˆæ‰€ä»¥æ”¶åˆ°tcp clientå‘æ¥çš„æ•°æ®ä¼šå›RSTï¼‰ã€‚ä½†æ˜¯shutdown(SHUT_WR)çš„æ—¶å€™ï¼Œä¸ä¼šå‡å¼•ç”¨è®¡æ•°ï¼Œå†…æ ¸å¹¶ä¸ä¼šç›´æ¥é”€æ¯å¥—æ¥å­—ï¼Œè™½ç„¶ä¹Ÿä¼šå‘FINåŒ…ï¼Œä½†ä¹Ÿåªæ˜¯è®¤ä¸ºè¿™ä¸ªè¿æ¥æ˜¯å†™ç«¯å…³é—­ã€è¯»ç«¯æ­£å¸¸ï¼Œæ‰€ä»¥è¿˜å¯ä»¥æ­£å¸¸æ¥æ”¶æ•°æ®ï¼\nRPCæ¡†æ¶å…³å¿ƒè¿™ä¸ªé—®é¢˜ # é—®é¢˜å‡ºç°ï¼š\nå¯¹äºä¸Šå±‚åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œconn.Write()è¿”å›nilå°±è®¤ä¸ºæ˜¯è¿”å›æˆåŠŸäº†ï¼Œä½†æ˜¯å®é™…åŒ…å¹¶æ²¡æœ‰å‘é€å‡ºå»ï¼Œæ‰€ä»¥åç»­ç­‰å¾…æ¥æ”¶å“åº”çš„æ—¶å€™conn.Read()å°±ä¼šè¿”å›io.EOFé”™è¯¯æ˜¾ç¤ºå¯¹ç«¯è¿æ¥å·²å…³é—­ã€‚\nå‡å¦‚æ»¡è¶³ä¸‹é¢å‡ ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆtcp clientè¯·æ±‚tcp serverå¤±è´¥çš„æ¦‚ç‡å°±ä¼šå¾ˆå¤§äº†ï¼\n tcp clientè¯·æ±‚tcp serveræ˜¯é€šè¿‡è¿æ¥æ± æ¥å®ç°çš„ï¼› tcp clientè¯·æ±‚tcp serverå¹¶ä¸é¢‘ç¹çš„æƒ…å†µä¸‹ï¼› tcp serveråˆå­˜åœ¨ä¸»åŠ¨é”€æ¯ç©ºé—²è¿æ¥çš„æ—¶å€™ï¼›  å¦‚ä½•é¿å…è¿™é‡Œçš„é—®é¢˜å‘¢ï¼Ÿåœ¨goé‡Œé¢tcp clientä¸­çš„è¿æ¥æ± å®ç°ï¼Œå¯ä»¥å®šæœŸåœ°æ£€æŸ¥tcpè¿æ¥æ˜¯å¦æœ‰æ•ˆï¼Œå®ç°æ–¹æ³•å°±æ˜¯conn.Read()ä¸€ä¸‹ï¼Œå¦‚æœè¿”å›çš„æ˜¯io.EOFé”™è¯¯åˆ™è¡¨ç¤ºè¿æ¥å·²å…³é—­ï¼Œæ‰§è¡Œconn.Close()å¹¶é‡æ–°è·å–è¿æ¥å³å¯ã€‚conn.Write()æ˜¯ä¸ä¼šè¿”å›è¿™ä¸ªio.EOFé”™è¯¯çš„ï¼Œä¼šæƒ³ä¸Šé¢çš„åœºæ™¯æ¥çœ‹ï¼Œtcp clientç«¯ç°åœ¨è¿˜è®¤ä¸ºtcpè¿æ¥æ˜¯æœ‰æ•ˆçš„å‘¢ï¼Œæ‰€ä»¥conn.Write()æ˜¯è‚¯å®šä¸ä¼šè¿”å›io.EOFé”™è¯¯çš„ã€‚\ngoç½‘ç»œåº“ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ # è¿™é‡Œå†å»¶ä¼¸ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆgoé‡Œé¢conn.Write()çš„æ—¶å€™ä¸å»æ£€æŸ¥ä¸€ä¸‹è¿æ¥æ˜¯å¦å·²å…³é—­å‘¢ï¼Ÿæ¯”å¦‚æ˜¾ç¤ºåœ°conn.Read()ä¸€ä¸‹ï¼Ÿè¿™è¦è€ƒè™‘tcpçš„è®¾è®¡å®—æ—¨äº†ï¼Œtcpæœ¬èº«å°±æ˜¯æ”¯æŒå…¨åŒå·¥æ¨¡å¼çš„ï¼Œtcpè¿æ¥çš„ä»»æ„ä¸€ç«¯éƒ½æœ‰æƒåˆ©å…³é—­è¯»ç«¯æˆ–è€…å†™ç«¯ï¼Œæ‰€ä»¥ä»go apiè®¾è®¡è€…çš„è§’åº¦æ¥çœ‹ï¼Œconn.Write()å°±åªæ˜¯å•çº¯åœ°è®¤ä¸ºæˆ‘è¿™æ®µtcpconnçš„å†™ç«¯æœªå…³é—­å³å¯ï¼å¯¹ç«¯æ˜¯å¦å†™å…³é—­æ ¹æœ¬æ— éœ€è€ƒè™‘ï¼Œè€Œä»æ›´é€šç”¨çš„è§’åº¦æ¥è€ƒè™‘ï¼Œæœ‰äº›æœåŠ¡ç«¯é€»è¾‘ä¸Šå¯ä»¥åªæ”¶è¯·æ±‚ä¸å›å“åº”ã€‚ä¸ºäº†é€šç”¨æ€§ï¼Œconn.Write()ä¸å¯èƒ½å»æ£€æŸ¥å¯¹ç«¯æ˜¯å¦å†™å…³é—­ï¼\né‚£ä»ä¸€ä¸ªç½‘ç»œæ¡†æ¶è®¾è®¡æˆ–è€…ä¸€ä¸ªåº”ç”¨ç¨‹åºå¼€å‘è€…è§’åº¦æ¥è¯´å‘¢ï¼Ÿæˆ‘ä»¬å…³å¿ƒä¸€ä¸ªè¯·æ±‚æ˜¯å¦èƒ½æ‹¿åˆ°å¯¹åº”çš„å“åº”ï¼å¦‚æœæˆ‘ä»¬è¦é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä»¥cã€c++ä¸ºä¾‹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥å€ŸåŠ©epoll_waitæ¥è½®è¯¢æ˜¯å¦æœ‰EPOLLRDHUPäº‹ä»¶å°±ç»ªï¼Œæœ‰å°±è®¤ä¸ºè¿æ¥å…³é—­é”€æ¯å°±å¯ä»¥äº†ï¼Œæˆ–è€…è½®è¯¢EPOLLINäº‹ä»¶å°±ç»ªæ¥ç€read(fd, buf, 0)è¿”å›0==EOFå°±å¯ä»¥äº†ã€‚ä½†æ˜¯æ¯æ¬¡writeä¹‹å‰éƒ½è¿™æ ·æ£€æŸ¥ä¸€ä¸‹ï¼Œè¿˜æ˜¯å¾ˆè›‹ç–¼çš„ï¼Œè¦é™·å…¥å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œä¸”å³ä¾¿åœ¨epoll_waitè¿”å›ä¹‹åã€writeä¹‹å‰è¿™æ®µæ—¶é—´å†…ï¼Œä»ç„¶å¯¹ç«¯å¯èƒ½ä¼šå‘ä¸€ä¸ªFINåŒ…è¿‡æ¥ï¼æ‰€ä»¥è¯´è¿™æ ·ä¹Ÿå¹¶ä¸èƒ½ä¸€åŠ³æ°¸é€¸åœ°è§£å†³é—®é¢˜ï¼\nå¦‚ä½•æ›´å¥½åœ°è§£å†³é—®é¢˜ # å†å›åˆ°é—®é¢˜çš„èµ·ç‚¹ï¼Œå…¶å®æˆ‘ä»¬ä¸æƒ³å…³å¿ƒè¿™äº›ç½‘ç»œç»†èŠ‚ï¼Œæˆ‘ä»¬åªæƒ³å…³å¿ƒï¼Œæˆ‘å‘é€å‡ºå»çš„è¯·æ±‚æ˜¯å¦å¾—åˆ°äº†å¯é çš„å“åº”ï¼\nå¤±è´¥é‡è¯•ï¼å¤±è´¥åé‡è¯•ä¸€æ¬¡ã€ä¸¤æ¬¡å·²ç»æˆä¸ºäº†å¤§å®¶å†™ä»£ç æ—¶å€™çš„å¸¸æ€ï¼Œä½†æ˜¯ä¸€ä¸ªç½‘ç»œæ¡†æ¶ï¼Œæ˜¯å¦åº”è¯¥å‡å°‘è¿™ç§è´Ÿæ‹…ï¼Ÿå¯èƒ½ä¸Šé¢æˆ‘ä»¬è®¨è®ºçš„æƒ…å½¢åœ¨çº¿ä¸Šç¯å¢ƒä¸­å¹¶ä¸å¤šè§ï¼Œä½†å®ƒç¡®å®æ˜¯ä¸€ä¸ªå·²çŸ¥çš„é—®é¢˜ï¼å¦‚æœè¯·æ±‚é‡æ¯”è¾ƒå¤§ï¼Œè¿æ¥ä¸ä¼šå› ä¸ºç©ºé—²è¢«å…³æ‰ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜å‡ºç°çš„æ¦‚ç‡å¾ˆå°‘ï¼Œä½†æ˜¯å‡å¦‚è¯·æ±‚é‡ç¡®å®ä¸å¤§ï¼Œè¿™ä¸ªé—®é¢˜å°±ä¼šå‡¸æ˜¾å‡ºæ¥äº†ã€‚\nè¿æ¥æ± è¿æ¥æ´»æ€§æ£€æµ‹ä¼˜åŒ– # ä¸ºæ­¤æˆ‘ä»¬æƒ³äº†ä¸€ç§æ”¹è‰¯çš„æ–¹æ³•æ¥æ£€æµ‹æ˜¯å¦å‡ºç°äº†å¯¹ç«¯å…³é—­è¿æ¥çš„æƒ…å†µï¼Œæ€è·¯æ˜¯è¿™æ ·çš„ï¼Œå› ä¸ºä¸æ–¹ä¾¿å†å»pollç±»ä¼¼çš„EPOLLINã€EPOLLRDHUPäº‹ä»¶ï¼Œè¿™é‡Œå†ä»è¿æ¥æ± è·å–ç©ºé—²è¿æ¥æ—¶ï¼Œå€ŸåŠ©ç³»ç»Ÿè°ƒç”¨n, err := syscall.Read(fd, buf)ç›´æ¥å»éé˜»å¡è¯»ä¸€ä¸‹ï¼Œå¦‚æœè¿”å›err == nil å¹¶ä¸” n==0ï¼Œé‚£ä¹ˆå°±å¯ä»¥åˆ¤å®šå¯¹ç«¯è¿æ¥å†™å…³é—­ï¼ˆrefer to poll/fd_unix.go:145~180, fd.eofError(n, err)ï¼‰ã€‚\nfunc (nci *NConnItem) readClosed(conn net.Conn) bool { var ( readClosed bool rawConn syscall.RawConn err error ) f := func(fd uintptr) bool { one := []byte{0} n, e := syscall.Read(int(fd), one) if e != nil \u0026amp;\u0026amp; e != syscall.EAGAIN { // connection broken, close it readClosed = true } if e == nil \u0026amp;\u0026amp; n == 0 { // peer half-close connection, refer to poll/fd_unix.go:145~180, fd.eofError(n, err) readClosed = true } // only detect whether peer half-close connection, don't block to wait read-ready. return true } switch conn.(type) { case *net.TCPConn: tcpconn, _ := conn.(*net.TCPConn) rawConn, err = tcpconn.SyscallConn() case *net.UnixConn: unixconn, _ := conn.(*net.UnixConn) rawConn, err = unixconn.SyscallConn() default: return false } err = rawConn.Read(f) if err != nil { return true } if readClosed { return true } return false }  å¦‚æœæˆ‘ä»¬åˆ©ç”¨tcpå…¨åŒå·¥èƒ½åŠ›ï¼Œå®ç°clientã€serverçš„å…¨åŒå·¥é€šä¿¡æ¨¡å¼ï¼Œä¸€è¾¹å‘é€å¤šä¸ªè¯·æ±‚ã€ä¸€è¾¹æ¥æ”¶å¤šä¸ªå“åº”ï¼Œå‡å¦‚æ¥æ”¶å“åº”çš„æ—¶å€™å‘ç°io.EOFï¼Œé‚£ä¹ˆåç»­çš„å‘é€ç›´æ¥è¿”å›å¤±è´¥å°±è¡Œäº†ã€‚ä½†æ˜¯å‡å¦‚ç½‘ç»œæŠ–åŠ¨çš„æƒ…å†µä¸‹ï¼Œè¿™ç§å…¨åŒå·¥é€šä¿¡æ¨¡å¼å®¹æ˜“å‡ºç°å¤±è´¥æ¿€å¢çš„æ¯›åˆºã€‚\nè¿™ç§æƒ…å¢ƒä¸‹ï¼Œè²Œä¼¼UDPä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå½“ç„¶ä¹Ÿè¦è€ƒè™‘æœåŠ¡ç«¯æ˜¯å¦æ”¯æŒUDPã€‚\nåœ¨RPCçº§åˆ«æ”¯æŒé‡è¯•å¯¹å†² # è¿˜æœ‰ä¸€ç§æ›´ä¼˜é›…çš„åšæ³•ï¼Œåœ¨RPCæ¡†æ¶è®¾è®¡ä¸Šæ”¯æŒinterceptoræ‰©å±•ï¼ŒåŒ…æ‹¬å‰ç½®interceptorã€åç½®interceptorï¼Œæ¯”å¦‚grpcæ¡†æ¶çš„interceptoræ˜¯ä»¥é€’å½’çš„å½¢å¼å½¢æˆäº†ä¸€ä¸ªé“¾æ¡ï¼Œå‰é¢interceptorçš„å®Œæˆé©±åŠ¨åä¸€ä¸ªæ‰§è¡Œï¼Œæœ€åçš„interceptoré©±åŠ¨çœŸæ­£çš„RPCæ–¹æ³•æ‰§è¡Œã€‚\næˆ‘ä»¬å¯ä»¥åœ¨interceptorå±‚é¢ä¸Šæ”¯æŒé‡è¯•å¯¹å†²ï¼Œæ¯”å¦‚æœ¬æ–‡æåŠçš„å¤±è´¥é‡è¯•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç”¨è¿‡åº¦ä¼˜åŒ–tcpè¿æ¥æ± è¿æ¥æ´»æ€§æ£€æµ‹ï¼Œè€Œæ˜¯å°†å…³æ³¨é‡ç‚¹æ”¾åœ¨å¦‚ä½•æ›´å¥½åœ°è§£å†³å¤±è´¥åçš„é‡è¯•ä¸Šï¼š\n ç«‹å³é‡è¯• é‡è¯•æ¬¡æ•° æŒ‡æ•°é€€é¿ etc  RPCæ–¹æ³•ä¸­ï¼Œåœ¨tcpconn.Writeå‘é€è¯·æ±‚æˆåŠŸåï¼Œç»§ç»­é€šè¿‡tcpconn.Readè¯»å–å“åº”ï¼Œæ­¤æ—¶è¯»å–åˆ°io.EOFåˆ™è¿”å›é”™è¯¯ï¼Œæ­¤æ—¶é©±åŠ¨è¯¥RPCæ–¹æ³•æ‰§è¡Œçš„é‡è¯•interceptorä¼šæ ¹æ®é…ç½®çš„é‡è¯•ç­–ç•¥è¿›è¡Œé‡è¯•ï¼Œä»è€Œæ›´ä¼˜é›…åœ°è§£å†³è¿™é‡Œwrite closed tcpconnçš„é—®é¢˜ã€‚\né™„å½• # 1 æµ‹è¯•tcp server closeç©ºé—²è¿æ¥\nmacä¸‹æµ‹è¯•æ–¹æ³•ï¼š\n æœåŠ¡ç«¯ï¼šnc -kl 5555 -w 2 å®¢æˆ·ç«¯ï¼šgo run client.goï¼Œclient.goä»£ç å¦‚é™„å½•3ã€‚  linuxä¸‹æµ‹è¯•æ–¹æ³•ï¼š\n æœåŠ¡ç«¯ï¼šnc -kl 5555 -i 2ï¼ˆä¸macä¸‹å‚æ•°ä¸åŒï¼Œæ•ˆæœç›¸åŒï¼Œéƒ½æ˜¯2såcloseè¿æ¥ï¼‰ å®¢æˆ·ç«¯ï¼šgo run client.goï¼Œclient.goä»£ç å¦‚é™„å½•3ã€‚  2 æµ‹è¯•tcp server shutdown(SHUT_WR)ç©ºé—²è¿æ¥\næœåŠ¡ç«¯ï¼šgo run server.go\n3 æµ‹è¯•ä»£ç server.go+client.go\nfile server.go\npackage main import ( \u0026quot;fmt\u0026quot; \u0026quot;net\u0026quot; \u0026quot;os\u0026quot; \u0026quot;time\u0026quot; ) func init() { log.SetFlags(log.LstdFlags | log.Lshortfile) } func main() { listener, err := net.Listen(\u0026quot;tcp4\u0026quot;, \u0026quot;:5555\u0026quot;) if err != nil { fmt.Println(err) os.Exit(1) } for { conn, err := listener.Accept() if err != nil { fmt.Println(err) continue } go func() { go func() { time.Sleep(time.Second * time.Duration(2)) tcpconn, ok := conn.(*net.TCPConn) if !ok { fmt.Println(err) return } tcpconn.CloseWrite() }() time.Sleep(time.Second * time.Duration(4)) buf := make([]byte, 1024) n, err := conn.Read(buf) if err != nil { fmt.Println(err) return } fmt.Println(\u0026quot;read bytes size:%v, data:%s\u0026quot;, n, string(buf)) }() } }  file: client.go\npackage main import ( \u0026quot;os\u0026quot; \u0026quot;net\u0026quot; \u0026quot;time\u0026quot; ) func main() { strEcho := \u0026quot;Halo\u0026quot; servAddr := \u0026quot;localhost:5555\u0026quot; tcpAddr, err := net.ResolveTCPAddr(\u0026quot;tcp\u0026quot;, servAddr) if err != nil { println(\u0026quot;ResolveTCPAddr failed:\u0026quot;, err.Error()) os.Exit(1) } println(\u0026quot;connection established\u0026quot;) conn, err := net.DialTCP(\u0026quot;tcp\u0026quot;, nil, tcpAddr) if err != nil { println(\u0026quot;Dial failed:\u0026quot;, err.Error()) os.Exit(1) } // sleep until connection closed time.Sleep(3000 * time.Millisecond) // first write to half-closed connection time.Sleep(3000 * time.Millisecond) _, err = conn.Write([]byte(strEcho)) if err != nil { println(\u0026quot;Write to server failed:\u0026quot;, err.Error()) os.Exit(1) } println(\u0026quot;writen to server = \u0026quot;, strEcho) // second write to half-closed connection time.Sleep(3000 * time.Millisecond) strEcho = \u0026quot;Halo2\u0026quot; _, err = conn.Write([]byte(strEcho)) if err != nil { println(\u0026quot;Write to server failed:\u0026quot;, err.Error()) os.Exit(1) } println(\u0026quot;writen to server = \u0026quot;, strEcho) conn.Close() }  4 c++ç‰ˆçš„tcp client\nä¸€ä¸ªç±»ä¼¼ä¸Šè¿°goç‰ˆtcp clientçš„c++ç‰ˆå®ç°ï¼Œçœ‹çœ‹è¦å¤šå°‘ä»£ç å§ã€‚\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;netinet/in.h\u0026gt; #include \u0026lt;sys/un.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;sys/unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;sys/epoll.h\u0026gt; #define MAX_EVENTS 1024 static int processClient(); int main(int argc, char *argv[]) { int fd; int ret; struct sockaddr_in addr = { 0 }; struct in_addr x; inet_aton(\u0026quot;127.0.0.1\u0026quot;, \u0026amp;x); addr.sin_family = AF_INET; addr.sin_addr = x; addr.sin_port = htons(5555); int set = 30; int i = 0; int fdFlag = 0; int epollFd = epoll_create(MAX_EVENTS); if (epollFd == -1) { printf(\u0026quot;epoll_create failed\\n\u0026quot;); return -1; } struct epoll_event ev; // epollÃŠÂ¼Ã¾Â½á¹¹ÃŒ struct epoll_event events[MAX_EVENTS]; // ÃŠÂ¼Ã¾Â¼Ã Â¶Ã“Ã // connect to server fd = socket(AF_INET, SOCK_STREAM, 0); if (fd == -1) { printf(\u0026quot;error:%s\\n\u0026quot;, strerror(errno)); return -1; } // set timer is valid ? //setsockopt(fd, SOL_SOCKET, SO_KEEPALIVE, \u0026amp;set, sizeof(set)); // set socket non block? if ((fdFlag = fcntl(fd, F_GETFL, 0)) \u0026lt; 0) printf(\u0026quot;F_GETFL error\u0026quot;); fdFlag |= O_NONBLOCK; if (fcntl(fd, F_SETFL, fdFlag) \u0026lt; 0) printf(\u0026quot;F_SETFL error\u0026quot;); // connect to server ret = connect(fd, (struct sockaddr *)\u0026amp;addr, sizeof(addr)); if (ret == -1) { if (errno == EINPROGRESS) { printf(\u0026quot; connect error:%s\\n\u0026quot;, strerror(errno)); //return -1; } else { printf(\u0026quot; connect error:%s\\n\u0026quot;, strerror(errno)); return -1; } } // epoll watch socket EPOLLOUT ev.events = EPOLLOUT; ev.data.fd = fd; if (epoll_ctl(epollFd, EPOLL_CTL_ADD, fd, \u0026amp;ev) == -1) { printf(\u0026quot;epoll_ctl:server_sockfd register failed\u0026quot;); return -1; } int nfds; // check whether tcpconn established, howto? write-ready! while (1) { nfds = epoll_wait(epollFd, events, MAX_EVENTS, -1); if (nfds == -1) { printf(\u0026quot;start epoll_wait failed\u0026quot;); return -1; } if (nfds == 0) { continue; } if (events[0].events \u0026amp; EPOLLOUT) { printf(\u0026quot; connection is established\\n\u0026quot;); break; } } // sleep 3 seconds, before wakeup let the server close connection! // nc -kl 5555 -w 1 sleep(3); char sendbuf[512] = { 0 }; char recvbuf[5120] = { 0 }; int count = 0; // check whether epoll_wait can detect half-open tcpconn ev.events = EPOLLIN | EPOLLET | EPOLLRDHUP; ev.data.fd = fd; if (epoll_ctl(epollFd, EPOLL_CTL_MOD, fd, \u0026amp;ev) == -1) { printf(\u0026quot;epoll_ctl:server_sockfd register failed\\n\u0026quot;); return -1; } while (1) { nfds = epoll_wait(epollFd, events, MAX_EVENTS, -1); if (nfds == -1) { printf(\u0026quot;start epoll_wait failed\\n\u0026quot;); return -1; } if (nfds == 0) { printf(\u0026quot;epoll_wait: no events ready\\n\u0026quot;); continue; } int i = 0; for (i=0; i\u0026lt;nfds; i++) { /* if (events[i].events \u0026amp; EPOLLRDHUP) { printf(\u0026quot; epoll_wait: EPOLLRDHUP, peer close connection\\n\u0026quot;); close(events[i].data.fd); return -1; } */ if (events[i].events \u0026amp; EPOLLIN) { printf(\u0026quot; epoll_wait: read-ready\\n\u0026quot;); memset(recvbuf, 0, sizeof(recvbuf)); count = recv(events[i].data.fd, recvbuf, sizeof(recvbuf), 0); printf(\u0026quot;read bytes size:%d, data:%s\\n\u0026quot;, count, recvbuf); if (count == -1) { /* If errno == EAGAIN, that means we have read all data. So go back to the main loop. */ if (errno != EAGAIN) { printf(\u0026quot;read error\\n\u0026quot;); close(events[i].data.fd); return -1; } } else if (count == 0) { /* End of file. The remote has closed the connection. */ close(events[i].data.fd); printf(\u0026quot;tcpconn is closed by peer\\n\u0026quot;); return -1; } } } } // when write-ready, send data to server // when read-ready, read data from server int token_length = 5; char *token_str = \u0026quot;12345\u0026quot;; char *ch = \u0026quot;yumgkevin\u0026quot;; char socketId[10] = { 0 }; while (1) { nfds = epoll_wait(epollFd, events, MAX_EVENTS, -1); if (nfds == -1) { printf(\u0026quot;start epoll_wait failed\u0026quot;); return -1; } for (i = 0; i \u0026lt; nfds; i++) { /* if ((events[i].events \u0026amp; EPOLLERR) || (events[i].events \u0026amp; EPOLLHUP) || (!(events[i].events \u0026amp; EPOLLIN)) || (!(events[i].events \u0026amp; EPOLLOUT)) ) { printf(\u0026quot;enter 1\u0026quot;); fprintf (stderr, \u0026quot;epoll error\\n\u0026quot;); close (events[i].data.fd); continue; } */ if (events[i].events \u0026amp; EPOLLOUT) { printf(\u0026quot;write-ready, send data to server\\n\u0026quot;); memset(sendbuf, 0, sizeof(sendbuf)); memset(socketId, 0, sizeof(socketId)); strcpy(sendbuf, token_str); strcat(sendbuf, \u0026quot;hellow, world\u0026quot;); strcat(sendbuf, ch); sprintf(socketId, \u0026quot;%d\u0026quot;, events[i].data.fd); strcat(sendbuf, socketId); strcat(sendbuf, \u0026quot;\\r\\n\u0026quot;); ret = send(events[i].data.fd, sendbuf, strlen(sendbuf), 0); if (ret == -1) { if (errno != EAGAIN) { printf(\u0026quot;error:%s\\n\u0026quot;, strerror(errno)); close(events[i].data.fd); } continue; } printf(\u0026quot;send buf content is %s, size is %d\\n\u0026quot;, sendbuf, ret); // add revelant socket read event ev.data.fd = events[i].data.fd; ev.events = EPOLLIN | EPOLLET; epoll_ctl(epollFd, EPOLL_CTL_MOD, events[i].data.fd, \u0026amp;ev); } else if (events[i].events \u0026amp; EPOLLIN) { printf(\u0026quot;read-ready, read data from server\\n\u0026quot;); count = 0; memset(recvbuf, 0, sizeof(recvbuf)); count = recv(events[i].data.fd, recvbuf, sizeof(recvbuf), 0); if (count == -1) { /* If errno == EAGAIN, that means we have read all data. So go back to the main loop. */ if (errno != EAGAIN) { printf(\u0026quot;read error\\n\u0026quot;); close(events[i].data.fd); } continue; } else if (count == 0) { /* End of file. The remote has closed the connection. */ close(events[i].data.fd); continue; } printf(\u0026quot;receive data is:%s\u0026quot;, recvbuf); // add revelant socket write event ev.data.fd = events[i].data.fd; ev.events = EPOLLOUT; epoll_ctl(epollFd, EPOLL_CTL_MOD, events[i].data.fd, \u0026amp;ev); } } } // close socket close(fd); return 0; }  5 tcpçŠ¶æ€è½¬æ¢å›¾ "}),a.add({id:337,href:"/tags/dapper/",title:"dapper",description:"",content:""}),a.add({id:338,href:"/tags/opentracing/",title:"opentracing",description:"",content:""}),a.add({id:339,href:"/tags/tracing/",title:"tracing",description:"",content:""}),a.add({id:340,href:"/blog/2018-10-03-%E5%A4%A7%E8%A7%84%E6%A8%A1%E5%88%86%E5%B8%83%E5%BC%8F%E8%B7%9F%E8%B8%AA%E7%B3%BB%E7%BB%9Fdapper/",title:"å¤§è§„æ¨¡åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿdapper",description:"dapperï¼Œå¤§è§„æ¨¡åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œç°åœ¨æœ‰ä¸å°‘å¼€æºå®ç°æ˜¯åŸºäºdapperçš„æ ¸å¿ƒæ€æƒ³æ¥è®¾è®¡çš„ï¼Œå¦‚zipkinã€jaegerã€lightstepã€appdashç­‰ã€‚äº†è§£dapperçš„å·¥ä½œåŸç†ï¼Œä¹Ÿæ–¹ä¾¿ç†è§£zipkinã€jaegerè¿™å‡ ä¸ªå¸¸ç”¨çš„åˆ†å¸ƒå¼è·Ÿè¸ªå®ç°ï¼Œä½¿ç”¨opentracingæ¥é›†æˆä¸åŒçš„backendçš„æ—¶å€™ä¹Ÿä¸è‡³äºä¸€å¤´é›¾æ°´ã€‚æ‰€ä»¥åˆæŠŠdapperçš„è®ºæ–‡é˜…è¯»äº†å‡ éï¼Œæ¢³ç†äº†ä¸‹å…¶æ ¸å¿ƒæ€æƒ³ã€‚ç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘è¿™ç¯‡è®ºæ–‡çš„ä¸­æ–‡è¯‘æ–‡ï¼Œä½†æ˜¯ç¿»è¯‘çš„è¹©è„šï¼Œç†è§£èµ·æ¥å¾ˆæ™¦æ¶©ï¼Œæ‰€ä»¥è¿˜æ˜¯è‡ªå·±æ¢³ç†ä¸‹æ–¹ä¾¿ä»¥åæŸ¥é˜…ï¼Œä¹Ÿå¸Œæœ›å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  dapperï¼Œå¤§è§„æ¨¡åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œç°åœ¨æœ‰ä¸å°‘å¼€æºå®ç°æ˜¯åŸºäºdapperçš„æ ¸å¿ƒæ€æƒ³æ¥è®¾è®¡çš„ï¼Œå¦‚zipkinã€jaegerã€lightstepã€appdashç­‰ã€‚äº†è§£dapperçš„å·¥ä½œåŸç†ï¼Œä¹Ÿæ–¹ä¾¿ç†è§£zipkinã€jaegerè¿™å‡ ä¸ªå¸¸ç”¨çš„åˆ†å¸ƒå¼è·Ÿè¸ªå®ç°ï¼Œä½¿ç”¨opentracingæ¥é›†æˆä¸åŒçš„backendçš„æ—¶å€™ä¹Ÿä¸è‡³äºä¸€å¤´é›¾æ°´ã€‚æ‰€ä»¥åˆæŠŠdapperçš„è®ºæ–‡é˜…è¯»äº†å‡ éï¼Œæ¢³ç†äº†ä¸‹å…¶æ ¸å¿ƒæ€æƒ³ã€‚ç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘è¿™ç¯‡è®ºæ–‡çš„ä¸­æ–‡è¯‘æ–‡ï¼Œä½†æ˜¯ç¿»è¯‘çš„è¹©è„šï¼Œç†è§£èµ·æ¥å¾ˆæ™¦æ¶©ï¼Œæ‰€ä»¥è¿˜æ˜¯è‡ªå·±æ¢³ç†ä¸‹æ–¹ä¾¿ä»¥åæŸ¥é˜…ï¼Œä¹Ÿå¸Œæœ›å¯¹å¤§å®¶æœ‰å¸®åŠ©ã€‚\n[TOC]\nåˆ†å¸ƒå¼è·Ÿè¸ª # åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿå°†ç³»ç»Ÿä¸­å„ä¸ªæœåŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»ï¼ˆä¾èµ–å…³ç³»ï¼‰ã€è¯·æ±‚è€—æ—¶æƒ…å†µã€è¯·æ±‚æ–¹å¼ï¼ˆä¸²è¡Œã€å¹¶å‘ï¼‰ç­‰ç­‰æ¸…æ™°åœ°å±•ç¤ºå‡ºæ¥ï¼Œå¯¹äºå¿«é€Ÿå®šä½ç³»ç»Ÿè°ƒç”¨é“¾è·¯ä¸­å‡ºç°çš„å¼‚å¸¸é—®é¢˜æœ‰ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚ä¸ç®¡æ˜¯æ™®é€šç¨‹åºå¼€å‘äººå‘˜ï¼Œè¿˜æ˜¯webã€rpcæˆ–å…¶ä»–æ¡†æ¶å¼€å‘äººå‘˜ï¼Œéƒ½å¸Œæœ›èƒ½é›†æˆåˆ†å¸ƒå¼è·Ÿè¸ªçš„èƒ½åŠ›ã€‚\ndapperç®€ä»‹ # ç°åœ¨ä¸»æµçš„åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼ŒåŸºæœ¬éƒ½æ˜¯åŸºäºgoogleå‘å¸ƒçš„è®ºæ–‡dapperæ¥è¿›è¡Œåç»­å¼€å‘çš„ï¼Œè®ºæ–‡ä¸­è¯¦ç»†è§£é‡Šäº†dapperå®ç°åˆ†å¸ƒå¼è·Ÿè¸ªçš„åŸç†ï¼Œç‚¹å‡»æŸ¥çœ‹ dapperï¼šå¤§è§„æ¨¡åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿã€‚\nè®¾è®¡åˆè¡· # åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œå…¶èŒè´£å°±æ˜¯â€œæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²ï¼ŒæŒç»­çš„ç›‘æ§â€ï¼Œè¿™ä¹Ÿæ˜¯çœŸæ­£æç°åˆ†å¸ƒå¼è·Ÿè¸ªèƒ½åŠ›çš„å‰æã€‚â€œæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²â€ï¼Œè¿™éå¸¸é‡è¦ï¼Œå› ä¸ºå³ä½¿ä¸€å°éƒ¨åˆ†ç›‘æ§æ²¡æœ‰ç›‘æ§åˆ°ï¼Œä¹Ÿä¼šè®©äººå¯¹æ•´ä¸ªè·Ÿè¸ªç»“æœäº§ç”Ÿè´¨ç–‘ã€‚â€œæŒç»­çš„ç›‘æ§â€ï¼Œç›‘æ§åº”è¯¥æ˜¯7x24å°æ—¶ä¸é—´æ–­çš„ï¼Œå¯¹äºæŸäº›å°æ¦‚ç‡äº‹ä»¶æˆ–è€…éš¾ä»¥é‡ç°çš„äº‹ä»¶ï¼Œå¦‚æœä¸èƒ½åšåˆ°æŒç»­ç›‘æ§å°±æœ‰å¯èƒ½é—æ¼è¿™éƒ¨åˆ†å¼‚å¸¸ã€‚\nè®¾è®¡ç›®æ ‡ # dapperå°†â€œæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²ï¼ŒæŒç»­çš„ç›‘æ§â€ä½œä¸ºå¤§çš„æ–¹å‘ï¼Œç”±æ­¤ä¹Ÿç¡®å®šäº†å…·ä½“çš„3ä¸ªè®¾è®¡ç›®æ ‡ã€‚\n ä½å¼€é”€ï¼Œè·Ÿè¸ªç³»ç»Ÿå¯¹åœ¨çº¿æœåŠ¡çš„å½±å“åº”è¯¥è¶³å¤Ÿå° æœ‰äº›æœåŠ¡æ˜¯ç»è¿‡å¼€å‘äººå‘˜é«˜åº¦ä¼˜åŒ–åçš„ï¼Œå¦‚æœè·Ÿè¸ªç³»ç»Ÿå¼•å…¥çš„overheadæ¯”è¾ƒå¤§ï¼Œå°±å¯èƒ½æŠµæ¶ˆæ‰ä¹‹å‰ä¼˜åŒ–å·¥ä½œå¸¦æ¥çš„æ€§èƒ½æå‡ï¼Œå¼€å‘äººå‘˜ä¸å¾—ä¸å…³åœåˆ†å¸ƒå¼è·Ÿè¸ªèƒ½åŠ›ã€‚ åº”ç”¨é€æ˜ï¼Œåˆ†å¸ƒå¼è·Ÿè¸ªçš„å®ç°ç»†èŠ‚åº”è¯¥å¯¹åº”ç”¨å¼€å‘äººå‘˜é€æ˜ åº”ç”¨å¼€å‘äººå‘˜æ˜¯ä¸éœ€è¦çŸ¥é“æœ‰åˆ†å¸ƒå¼è·Ÿè¸ªè¿™å›äº‹çš„ï¼Œå¦‚æœä¸€ä¸ªè·Ÿè¸ªç³»ç»Ÿä¸èƒ½å±è”½è¿™äº›ç»†èŠ‚ã€éœ€è¦å¼€å‘è€…é…åˆçš„è¯ï¼Œè¿™ç§ä¸šåŠ¡ä¾µå…¥æ€§å¾ˆå¼ºçš„è·Ÿè¸ªç³»ç»Ÿæ˜¯éš¾ä»¥å¤§åŠ›æ¨å¹¿çš„ï¼Œä¹Ÿå°±éš¾ä»¥å®ç°â€œæ— æ‰€ä¸åœ¨çš„éƒ¨ç½²â€è¿™æ ·çš„èƒ½åŠ›ï¼Œä¹Ÿå°±ä¸èƒ½å®ç°å…¨é¢ç»†è‡´çš„è·Ÿè¸ªã€‚ å¯ä¼¸ç¼©æ€§ï¼Œé¢å¯¹æœªæ¥Nå¹´æœåŠ¡é›†ç¾¤æ‰©å¤§çš„è¶‹åŠ¿ï¼Œéƒ½åº”è¯¥èƒ½å¯¹å…¶è¿›è¡Œæœ‰åŠ›åœ°æŠŠæ§ åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿä¸åªæ˜¯è·Ÿè¸ªå‡ ä¸ªã€åå‡ ä¸ªæœåŠ¡ï¼Œå®ƒåœ¨è®¾è®¡ä¸Šè¦èƒ½å¤Ÿå¯¹å¤§è§„æ¨¡çš„æœåŠ¡é›†ç¾¤è¿›è¡Œå…¨å±€æŠŠæ§ã€‚è¿™å°±è¦æ±‚å…¶å¿…é¡»ä¿æŒè¶³å¤Ÿçš„å¯ä¼¸ç¼©æ€§ï¼Œåœ¨æœåŠ¡é›†ç¾¤æ‰©å¤§ä¹‹åè¦é€šè¿‡æŸç§å½¢å¼çš„â€œæ‰©å®¹â€æ¥ä¿è¯åˆ†å¸ƒå¼è·Ÿè¸ªèƒ½åŠ›çš„çº¿æ€§å¢é•¿ã€‚è¿™é‡Œçš„æ‰©å®¹å¯èƒ½æ˜¯æœºå™¨çº§åˆ«çš„ã€ç½‘ç»œçº§åˆ«çš„ã€å­˜å‚¨çº§åˆ«çš„ã€‚  è¿™3ä¸ªè®¾è®¡ç›®æ ‡ä¹‹å¤–ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªè®¾è®¡ç›®æ ‡ï¼Œâ€œä¿¡æ¯å¤„ç†çš„é€Ÿåº¦è¦è¶³å¤Ÿå¿«â€ã€‚å¦‚æœä¿¡æ¯å¤„ç†çš„é€Ÿåº¦è¶³å¤Ÿå¿«ï¼Œå°±å¯ä»¥è¿‘ä¹å®æ—¶åœ°å‘ç°çº¿ä¸Šç³»ç»Ÿä¸­å­˜åœ¨çš„å¼‚å¸¸é—®é¢˜ã€‚\nå®ç°æ–¹æ¡ˆ # dapperåœ¨è®¸å¤šé«˜é˜¶çš„è®¾è®¡æ€æƒ³ä¸Šå¸å–äº†pinpointå’ŒMagpieçš„ç ”ç©¶æˆæœï¼Œä½†åœ¨åˆ†å¸ƒå¼è·Ÿè¸ªé¢†åŸŸä¸­ï¼Œdapperçš„å®ç°åŒ…å«äº†è®¸å¤šæ–°çš„è´¡çŒ®ã€‚ä¾‹å¦‚ä¸ºäº†ä¿è¯å¯¹ä¸šåŠ¡æœåŠ¡çš„â€œä½å¼€é”€â€ï¼Œå¼•å…¥äº†â€œé‡‡æ ·ç‡â€ã€‚dapperçš„å¦ä¸€ä¸ªç‰¹å¾å°±æ˜¯åœ¨è¶³å¤Ÿä½çš„å±‚çº§å®ç°åˆ†å¸ƒå¼è·Ÿè¸ªï¼Œä»¥å¯¹åº”ç”¨çº§é€æ˜ã€‚\nè·Ÿè¸ªæ ‘ # dapperçš„åˆ†å¸ƒå¼è·Ÿè¸ªæ–¹æ¡ˆå¯ä»¥å€ŸåŠ©ä¸‹å›¾æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯ä»å®¢æˆ·ç«¯ï¼ˆuserï¼‰å‘èµ·çš„è¯·æ±‚ä¸€ç›´åˆ°æ¥å…¥å±‚æœåŠ¡Aï¼Œå†åˆ°åç«¯æœåŠ¡Bã€Cï¼Œå†ä»Cåˆ°Dã€Eï¼Œæ•´ä¸ªè¯·æ±‚å¤„ç†é“¾è·¯å¯ä»¥å€Ÿç”±ä¸€ä¸ªæ ‘å½¢ç»“æ„æ¥è¡¨ç¤ºå‡ºæ¥ã€‚å¯ä»¥é€šè¿‡å°†æœåŠ¡å™¨ä¸Šå‘ç”Ÿçš„æ¯ä¸€æ¬¡è¯·æ±‚ã€å“åº”ä½œä¸ºä¸€ä¸ªè®°å½•æ”¶é›†èµ·æ¥ï¼Œæ”¶é›†ä¿¡æ¯åŒ…æ‹¬è·Ÿè¸ªæ ‡è¯†ç¬¦ï¼ˆmessage identifierï¼‰å’Œæ—¶é—´æˆ³ï¼ˆtimestamped eventsï¼‰ã€‚é€šè¿‡æ·»åŠ æ ‡æ³¨ï¼ˆannotationï¼‰ï¼Œä¾èµ–äºåº”ç”¨ç¨‹åºæˆ–ä¸­é—´ä»¶æ˜ç¡®åœ°æ ‡è®°ä¸€ä¸ªå…¨å±€idï¼Œä»è€Œè¿æ¥æ¯ä¸€æ¡æ”¶é›†çš„è®°å½•å’Œç”¨æˆ·å‘èµ·çš„è¯·æ±‚ã€‚æ˜¾ç„¶è¿™é‡Œéœ€è¦ä»£ç æ¤å…¥ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä»£ç æ¤å…¥çš„èŒƒå›´æ”¶æ•›åˆ°æ¡†æ¶å±‚ï¼Œä¿è¯å¯¹åº”ç”¨å±‚é€æ˜ã€‚\nä¸‹é¢å¯¹dapperçš„è®¾è®¡æ€æƒ³è¿›è¡Œæ›´æ·±å…¥çš„äº†è§£ï¼Œæˆ‘ä»¬å°†å…ˆä»ä¸Šå›¾ä¸­æ¶‰åŠåˆ°çš„å‡ ä¸ªå…³é”®æ¦‚å¿µå¼€å§‹ã€‚\nè·Ÿè¸ªï¼ˆtraceï¼‰ # åœ¨dapperè·Ÿè¸ªæ ‘ç»“æ„ä¸­ï¼Œæ ‘èŠ‚ç‚¹æ˜¯æ•´ä¸ªæ¶æ„çš„åŸºæœ¬å•å…ƒï¼Œè€Œæ¯ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªspanï¼Œå®ƒåˆåŒ…å«äº†å¯¹å…¶ä»–spançš„å¼•ç”¨ã€‚èŠ‚ç‚¹ä¹‹é—´çš„è¿çº¿è¡¨ç¤ºçš„æ˜¯å½“å‰spanä¸å®ƒçš„çˆ¶spanæˆ–è€…æ´¾ç”Ÿå‡ºçš„å­spanä¹‹é—´çš„å…³ç³»ã€‚spanåœ¨æ—¥å¿—æ–‡ä»¶ä¸­çš„è¡¨ç¤ºåªæ˜¯ç®€å•çš„è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ã€è¯·æ±‚ç»“æŸæ—¶é—´ï¼Œspanåœ¨æ•´ä¸ªæ ‘å½¢ç»“æ„ä¸­å®ƒä»¬æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚\n)\nä¸Šå›¾æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è·Ÿè¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾ï¼Œå›¾ä¸­è¯´æ˜äº†spanåœ¨ä¸€ä¸ªå®Œæ•´çš„è·Ÿè¸ªè¿‡ç¨‹ä¸­æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œdapperè®°å½•äº†spançš„åç§°ã€span-idã€çˆ¶span-idï¼Œä»¥é‡å»ºä¸€æ¬¡è·Ÿè¸ªè¿‡ç¨‹ä¸­ä¸åŒspanä¹‹é—´çš„å…³ç³»ã€‚å¦‚æœä¸€ä¸ªspanæ²¡æœ‰çˆ¶span-idé‚£ä¹ˆå®ƒæ˜¯root spanï¼Œä¹Ÿå°±æ˜¯æ•´ä¸ªè°ƒç”¨é“¾çš„èµ·å§‹ç‚¹ã€‚æ‰€æœ‰spanéƒ½æŒ‚åœ¨ä¸€ä¸ªç‰¹å®šçš„è·Ÿè¸ªé“¾ä¸Šï¼Œä¹Ÿå…±ç”¨åŒä¸€ä¸ªè·Ÿè¸ªidï¼Œå³trace-idï¼ˆå›¾ä¸­æœªæ ‡å‡ºï¼‰ã€‚æ‰€æœ‰è¿™äº›idï¼ˆtrace-idã€span-idï¼‰éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„64ä½æ•´æ•°è¡¨ç¤ºã€‚\nåœ¨ä¸€ä¸ªå…¸å‹çš„dapperè·Ÿè¸ªä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸ºæ¯ä¸€ä¸ªrpcå¯¹åº”åˆ°ä¸€ä¸ªå•ä¸€çš„spanä¸Šï¼Œè€Œä¸”æ¯ä¸€ä¸ªé¢å¤–çš„ç»„ä»¶å±‚éƒ½å¯¹åº”åˆ°ä¸€ä¸ªè·Ÿè¸ªæ ‘å‹ç»“æ„çš„å±‚çº§ã€‚\nè·¨åº¦ï¼ˆspanï¼‰ # ä¸‹å›¾ä¸­ç»™å‡ºäº†ä¸€ä¸ªæ›´åŠ è¯¦ç»†çš„dapperè·Ÿè¸ªä¸­spanè®°å½•ç‚¹çš„è§†å›¾ï¼Œå…¶å®æ¯ä¸ªspanè®°å½•ç‚¹éƒ½åŒ…å«äº†ä¸¤ä¸ªä¸åŒçš„è§†è§’ï¼ˆclientç«¯RPCè§†è§’ï¼Œserverç«¯RPCè§†è§’ï¼‰ï¼Œå›¾ä¸­ä¹Ÿç”»å‡ºäº†rpc Helper.Callçš„clientã€serverç«¯è§†è§’ï¼Œå¦‚clientå‘é€è¯·æ±‚ã€serveræ¥æ”¶è¯·æ±‚ã€serverå¤„ç†ã€serverå‘é€å“åº”ã€clientæ¥æ”¶å“åº”çš„è¿‡ç¨‹ã€‚spançš„å¼€å§‹ã€ç»“æŸæ—¶é—´ï¼Œä»¥åŠä»»ä½•rpcçš„æ—¶é—´ä¿¡æ¯éƒ½å¯ä»¥é€šè¿‡dapperåœ¨rpcç»„ä»¶åº“ä¸­æ¤å…¥ä»£ç ä»¥è®°å½•ä¸‹æ¥ã€‚\nå¦‚æœåº”ç”¨ç¨‹åºå¼€å‘è€…å¸Œæœ›åœ¨è·Ÿè¸ªä¸­å¢åŠ è‡ªå·±çš„æ³¨é‡Šä¿¡æ¯ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰ï¼Œå¦‚å›¾ä¸­çš„â€œfooâ€ï¼Œè¿™äº›ä¿¡æ¯ä¹Ÿä¼šå’Œå…¶ä»–spanä¸€æ ·è®°å½•ä¸‹æ¥ã€‚\næ­¤å¤–ï¼Œä»»ä½•ä¸€ä¸ªspanè®°å½•ç‚¹éƒ½åŒ…æ‹¬äº†æ¥è‡ªrpc clientã€rpc serverç«¯çš„ä¸»æœºä¿¡æ¯ã€‚æ¯ä¸€ä¸ªspanè®°å½•ç‚¹å¯ä»¥åŒ…å«æ¥è‡ªclientã€serverä¸¤ç«¯çš„æ³¨é‡Šä¿¡æ¯ï¼Œä½¿å¾—spanè®°å½•ç‚¹èƒ½å¤Ÿè®°å½•è¯·æ±‚æ–¹ã€å“åº”æ–¹è¿™ä¸¤ä¸ªä¸»æœºçš„ä¿¡æ¯ã€‚å¦å¤–ç”±äºè®°å½•çš„æ—¶é—´æˆ³æ¥è‡ªä¸åŒçš„ä¸»æœºï¼Œä¸åŒçš„ä¸»æœºä¸Šçš„æ—¶é—´å¯èƒ½å­˜åœ¨ä¸€å®šçš„æ—¶é—´åå·®ï¼ˆæ—¶é’Ÿæ¼‚ç§»ï¼‰ï¼Œå¿…é¡»è€ƒè™‘æ—¶é—´åå·®å¸¦æ¥çš„å½±å“ï¼Œå› ä¸ºå®ƒä¼šå½±å“åˆ°æˆ‘ä»¬åˆ¤æ–­æŸä¸ªspançš„å‘ç”Ÿæ—¶é—´çš„å…ˆåé¡ºåºã€‚æˆ‘ä»¬å¯ä»¥åŸºäºè¿™æ ·çš„ä¸€ä¸ªäº‹å®ï¼Œå°±æ˜¯rpc clientå‘é€ä¸€ä¸ªè¯·æ±‚ä¹‹åserveræ‰å¯ä»¥æ”¶åˆ°ï¼Œå¯¹äºå“åº”ä¹Ÿæ˜¯ä¸€æ ·ï¼Œserverå“åº”ä¹‹åclientæ‰èƒ½æ”¶åˆ°å“åº”ï¼Œè¿™æ ·ä¸€æ¥rpc serverç«¯çš„æ¥æ”¶å“åº”æ—¶é—´æˆ³ã€å‘é€å“åº”æ—¶é—´æˆ³å°±ç¡®å®šäº†ä¸€ä¸ªä¸Šä¸‹é™ã€‚\næ¤å…¥ç‚¹ï¼ˆinstrumentation pointï¼‰ # dapperå¯ä»¥å¯¹åº”ç”¨å¼€å‘è€…ä»¥è¿‘ä¹é›¶ä¾µå…¥çš„æˆæœ¬å¯¹åˆ†å¸ƒå¼æ§åˆ¶è·¯å¾„è¿›è¡Œè·Ÿè¸ªï¼Œå‡ ä¹å®Œå…¨ä¾èµ–äºå°‘é‡é€šç”¨ç»„ä»¶åº“çš„æ”¹é€ ï¼Œå¦‚åœ¨æ¡†æ¶å±‚å¯¹ç°æœ‰rpcä»£ç è¿›è¡Œæ”¹é€ ï¼Œæ¤å…¥åˆ†å¸ƒå¼è·Ÿè¸ªç›¸å…³çš„ä»£ç ã€‚\nå¦‚ä½•è®°å½•è·Ÿè¸ªä¸Šä¸‹æ–‡ä¿¡æ¯å‘¢ï¼ˆtrace-idã€parent span-idã€span-idï¼‰ï¼Ÿä¸åŒçš„rpcæ¡†æ¶å¯èƒ½åŸºäºä¸åŒçš„ç½‘ç»œæœåŠ¡æ¨¡å‹ï¼ˆåŒæ­¥ã€å¼‚æ­¥ã€å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ã€åç¨‹ï¼‰å®ç°ï¼Œéœ€è¦è€ƒè™‘æ¸…æ¥šå¦‚ä½•ä¿å­˜è¿™é‡Œçš„è·Ÿè¸ªä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ç»“åˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€æä¾›çš„è¯­è¨€ç‰¹æ€§æ¥è¾…åŠ©å®ç°ï¼Œå¦‚åŸºäºjavaå¤šçº¿ç¨‹æ¨¡å‹å®ç°çš„rpcæ¡†æ¶å¯èƒ½ä¼šè€ƒè™‘é€šè¿‡ThreadLocalæ¥å­˜å‚¨è·Ÿè¸ªä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œgolangå¯ä»¥é€šè¿‡goroutineå±€éƒ¨å˜é‡æ¥å¯„å­˜è·Ÿè¸ªä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒC++å¯ä»¥é€šè¿‡ä¸€ä¸ªå…¨å±€mapç»“æ„æ¥ç»´æŠ¤è¯·æ±‚seqä¸è·Ÿè¸ªä¸Šä¸‹æ–‡çš„æ˜ å°„å…³ç³»ç­‰ï¼Œè¿™åªæ˜¯ä¸€ç§ä¿å­˜è·Ÿè¸ªä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ€è·¯ï¼Œå…·ä½“çš„åœºæ™¯è¿˜éœ€è¦å…·ä½“åˆ†æã€‚\næ³¨é‡Šï¼ˆannotationï¼‰ # ä¸‹é¢æ˜¯é€šè¿‡c++å’Œjavaå‘è·Ÿè¸ªä¸­spanè®°å½•ç‚¹æ·»åŠ æ³¨é‡Šçš„æ–¹æ³•ï¼š\nä¸Šè¿°æ¤å…¥ç‚¹å¯ä»¥å¸®åŠ©æ¨å¯¼å‡ºå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„è·Ÿè¸ªç»†èŠ‚ï¼Œä½¿å¾—dapperå¯ä»¥åœ¨ä¸æ”¹åŠ¨åº”ç”¨ä»£ç çš„æƒ…å¢ƒä¸‹å°±å¯ä»¥å‘æŒ¥å…¶æ ¸å¿ƒåŠŸèƒ½ã€‚ç„¶è€Œï¼Œdapperè¿˜å…è®¸åº”ç”¨å¼€å‘äººå‘˜åœ¨è·Ÿè¸ªçš„è¿‡ç¨‹ä¸­æ·»åŠ é¢å¤–çš„ä¿¡æ¯ï¼Œä»¥ç›‘æ§æ›´é«˜çº§åˆ«çš„ç³»ç»Ÿè¡Œä¸ºï¼Œæˆ–å¸®åŠ©è°ƒè¯•é—®é¢˜ã€‚\ndapperå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªç®€å•çš„apiæ¥å®šä¹‰æ—¶é—´æˆ³çš„annotationï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™äº›annotationå¯ä»¥æ·»åŠ ä»»æ„å†…å®¹ï¼Œä¸ºäº†é¿å…dapperä½¿ç”¨è€…è¿‡åˆ†çƒ­è¡·äºæ·»åŠ æ³¨é‡Šï¼Œdapperä¹Ÿæ·»åŠ äº†ä¸€äº›é™åˆ¶ï¼Œå³å•ä¸ªspanæœ‰ä¸€ä¸ªå¯é…ç½®çš„annotationæ•°é‡ä¸Šé™ã€‚\né™¤äº†ä¸Šå›¾ä¸­å±•ç¤ºçš„æ·»åŠ çš„æ–‡æœ¬annotationï¼Œdapperä¹Ÿæ”¯æŒæ·»åŠ key-valueå½¢å¼çš„annotationï¼Œæä¾›ç»™å¼€å‘äººå‘˜æ›´å¼ºçš„è·Ÿè¸ªèƒ½åŠ›ã€‚\né‡‡æ ·ç‡ï¼ˆsamplingï¼‰ # ä½å¼€é”€æ˜¯dapperçš„å…³é”®è®¾è®¡ç›®æ ‡ä¹‹ä¸€ï¼Œå¦‚æœè¿™ä¸ªå·¥å…·ä¸€å¼€å§‹è®¾è®¡çš„æ—¶å€™å…¶ä»·å€¼è¿˜æœªè¢«å……åˆ†è®¤å¯ï¼Œè€Œåˆå¯¹æ€§èƒ½æœ‰æ˜æ˜¾å¼€é”€çš„è¯ï¼Œå…¶ä»–å¼€å‘äººå‘˜ã€è¿ç»´äººå‘˜æ˜¯è‚¯å®šä¸æ„¿æ„å»åº”ç”¨ã€æ¨å¹¿è¿™ä¸ªç©æ„çš„ã€‚å†µä¸”ï¼Œdapperå¸Œæœ›èƒ½å¤Ÿè®©å¼€å‘äººå‘˜é€šè¿‡ä½¿ç”¨annotationçš„æ–¹å¼æ¥å¢å¼ºè·Ÿè¸ªèƒ½åŠ›ï¼Œè€Œåˆä¸ç”¨æ‹…å¿ƒæ€§èƒ½æ–¹é¢çš„å¼€é”€ã€‚è€Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ä¹Ÿå‘ç°ï¼ŒæŸäº›ç±»å‹çš„webæœåŠ¡æ€§èƒ½å¯¹æ¤å…¥ä»£ç ç¡®å®æ¯”è¾ƒæ˜æ˜¾ã€‚å› æ­¤dapperå¼€å‘äººå‘˜é™¤äº†æŠŠdapperçš„æ”¶é›†å·¥ä½œè¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œä½¿å…¶å¯¹åº”ç”¨æ€§èƒ½å½±å“å°½å¯èƒ½å°ä¹‹å¤–ï¼Œè¿˜å¼•å…¥äº†è¿›ä¸€æ­¥æ§åˆ¶æ€§èƒ½å¼€é”€çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯å½“é‡åˆ°å¤§é‡è¯·æ±‚æ—¶åªè®°å½•å…¶ä¸­ä¸€å°éƒ¨åˆ†ã€‚æˆ‘ä»¬åœ¨æ–‡ç« çš„åç»­éƒ¨åˆ†ä¼šè¿›ä¸€æ­¥æè¿°é‡‡æ ·ç‡æ–¹æ¡ˆæ›´å¤šçš„ç»†èŠ‚ã€‚\nè·Ÿè¸ªçš„æ”¶é›† # ä¸‹å›¾å±•ç¤ºäº†dapperçš„è·Ÿè¸ªçš„æ”¶é›†è¿‡ç¨‹ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºå›¾ä¸­1ã€2ã€3ä¸‰ä¸ªè¿‡ç¨‹ã€‚\n åº”ç”¨ç¨‹åºé€šè¿‡dapper apiå°†spanæ•°æ®å†™å…¥æœ¬åœ°æ—¥å¿—æ–‡ä»¶ä¸­ dapperå®ˆæŠ¤è¿›ç¨‹å’Œæ”¶é›†ç»„ä»¶æŠŠè¿™äº›æ—¥å¿—ä¿¡æ¯ä»ç”Ÿäº§ç¯å¢ƒçš„æ—¥å¿—æ–‡ä»¶ä¸­æ‹‰å–å‡ºæ¥ dapperå®ˆæŠ¤è¿›ç¨‹å’Œæ”¶é›†ç»„ä»¶å°†æ‹‰å–åˆ°çš„æ—¥å¿—ä¿¡æ¯æ•´ç†ï¼Œå¹¶å†™å…¥BigTableä»“åº“ä¸­  ä¸€æ¬¡è·Ÿè¸ªï¼Œè¢«è®¾è®¡æˆBigTableä¸­çš„ä¸€è¡Œ æ¯è¡Œä¸­çš„æ¯ä¸€åˆ—éƒ½ä»£è¡¨äº†ä¸€ä¸ªspan ä¸åŒè·Ÿè¸ªæ¶‰åŠåˆ°çš„spanæ•°é‡å¯èƒ½ä¸åŒï¼ŒBigTableæ”¯æŒç¨€ç–è¡¨æ ¼ï¼Œå¾ˆé€‚åˆè¿™ç§åœºæ™¯    dapperè¿˜æä¾›äº†é¢å¤–çš„apiæ¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè®¿é—®BigTableä»“åº“ä¸­çš„è·Ÿè¸ªæ•°æ®ã€‚\nå®‰å…¨å’Œéšç§ # å‰é¢æåˆ°äº†åº”ç”¨ç¨‹åºä¸­å¯ä»¥åœ¨å½“å‰spanä¸­æ·»åŠ ä¸€å®šæ•°é‡çš„annotationæ¥è¿›ä¸€æ­¥å¢å¼ºè·Ÿè¸ªèƒ½åŠ›ï¼ˆå› ä¸ºtraceåˆ†æå·¥å…·å¯ä»¥åœ¨æ”¶é›†åˆ°çš„æ—¥å¿—æ•°æ®ä¸­æå–å‡ºè¿™äº›ä¿¡æ¯ï¼‰ï¼Œè¿™äº›annotationå¯ä»¥å¸®åŠ©å®šä½ç³»ç»Ÿä¸ºä½•è¡¨ç°å¼‚å¸¸çš„åŸå› ã€‚ç„¶è€Œï¼Œæœ‰äº›æƒ…å†µä¸‹ï¼Œè¿™äº›æ•°æ®ä¸­å¯èƒ½åŒ…å«äº†æ•æ„Ÿä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¸åº”è¯¥æš´éœ²ç»™æœªç»æˆæƒçš„ç”¨æˆ·ï¼ˆåŒ…æ‹¬æ­£åœ¨debugçš„å·¥ç¨‹å¸ˆï¼‰ã€‚\nå®‰å…¨å’Œéšç§é—®é¢˜åº”äºˆä»¥è¶³å¤Ÿçš„é‡è§†ï¼Œdapperä¸­å¯ä»¥è®°å½•rpcçš„åç§°ï¼Œä½†æ˜¯ä¸è®°å½•ä»»ä½•æœ‰æ•ˆè½½è·æ•°æ®ï¼Œå¦‚è¯·æ±‚ä½“ã€å“åº”ä½“ä¿¡æ¯ã€‚ç›¸åï¼Œåº”ç”¨ç¨‹åºçº§åˆ«çš„annotationæä¾›äº†ä¸€ä¸ªæ–¹ä¾¿çš„å¯é€‰æœºåˆ¶ï¼šåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜å¯ä»¥åœ¨spanä¸­é€‰æ‹©å…³è”é‚£äº›ä¸ºä»¥ååˆ†ææä¾›ä»·å€¼çš„æ³¨é‡Šä¿¡æ¯ã€‚\ndapperè¿˜æä¾›äº†ä¸€äº›å®‰å…¨ä¸Šçš„ä¾¿åˆ©ï¼Œè¿™æ˜¯dapperçš„è®¾è®¡è€…æ‰€å§‹æ–™æœªåŠçš„ã€‚é€šè¿‡è·Ÿè¸ªå…¬å¼€çš„å®‰å…¨åè®®å‚æ•°ï¼Œdapperå¯ä»¥è¿‡æ£€ç›¸åº”çº§åˆ«çš„è®¤è¯æˆ–åŠ å¯†ç³»ç»Ÿï¼Œæ¥ç›‘è§†åº”ç”¨ç¨‹åºæ˜¯å¦æ»¡è¶³å®‰å…¨ç­–ç•¥ã€‚dapperè¿˜å¯ä»¥æä¾›ä¿¡æ¯æ¥å†³å®šæ˜¯å¦å¯ç”¨æœŸæœ›çš„ç³»ç»Ÿéš”ç¦»ç­–ç•¥ï¼Œä¾‹å¦‚æ”¯æ’‘æ•æ„Ÿæ•°æ®çš„åº”ç”¨ç¨‹åºä¸å¾—ä¸æœªç»æˆæƒçš„ç³»ç»Ÿç»„ä»¶è¿›è¡Œäº¤äº’ã€‚è¿™æ ·çš„æªæ–½æä¾›äº†æ¯”æºç å®¡æ ¸æ›´å¼ºå¤§çš„å®‰å…¨ä¿éšœã€‚\néƒ¨ç½²çŠ¶å†µ # æ— å¤„ä¸åœ¨çš„éƒ¨ç½²ï¼ŒæŒç»­ç›‘æ§ï¼Œåº”ç”¨çº§é€æ˜ï¼dapperåœ¨è°·æ­Œä½¿ç”¨å·²ç»æœ‰å¤šå¹´ï¼Œé€šè¿‡äº†çº¿ä¸Šç¯å¢ƒçš„æ£€éªŒã€‚\ndapperè¿è¡Œåº“ # åœ¨è°·æ­Œå†…éƒ¨ï¼Œdapperä¸»è¦æ˜¯è¢«æ¤å…¥åˆ°äº†ä¸€äº›é€šç”¨çš„åŸºç¡€rpcæ¡†æ¶ã€çº¿ç¨‹æ§åˆ¶å’Œæµç¨‹æ§åˆ¶ç»„ä»¶åº“ä¸­ï¼Œå…¶ä¸­åŒ…æ‹¬spançš„åˆ›å»ºã€é‡‡æ ·ç‡è®¾ç½®ï¼Œä»¥åŠæŠŠæ—¥å¿—å†™å…¥æœ¬åœ°ç£ç›˜ä¸­ã€‚é™¤äº†åšåˆ°è½»é‡çº§ï¼Œæ¤å…¥çš„ä»£ç æ›´éœ€è¦ç¨³å®šå’Œå¥å£®ï¼Œå› ä¸ºå®ƒä¸æµ·é‡çš„åº”ç”¨å¯¹æ¥ï¼Œä¸€æ—¦æ¤å…¥ä»£ç æœ‰é—®é¢˜ï¼Œå°†ä½¿å¾—ç»´æŠ¤å’Œä¿®å¤bugå˜å¾—å¾ˆå›°éš¾ã€‚å®é™…æ¤å…¥çš„ä»£ç æ˜¯ç”±æœªè¶…è¿‡1000è¡Œçš„c++å’Œä¸è¶…è¿‡800è¡Œçš„javaä»£ç ç»„æˆã€‚ä¸ºäº†æ”¯æŒkey-valueå½¢å¼çš„annotationè¿˜é¢å¤–æ¤å…¥äº†500è¡Œå·¦å³ä»£ç ã€‚\ndapperè¦†ç›–æƒ…å†µ # dapperçš„æ¨å¹¿æ˜¯ä»ä¸¤ä¸ªç»´åº¦è¿›è¡Œï¼Œä¸€ä¸ªæ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒåº”ç”¨ä¸­ç”Ÿæˆdapper tracesï¼ˆè¿™é‡Œçš„åº”ç”¨é“¾æ¥äº†å‰é¢æåˆ°çš„dapperè¿è¡Œåº“ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯æ”¶dapper traces colletion daemonæ¥æ”¶é›†ç”Ÿæˆçš„è¿™äº›dapper tracesã€‚dapper daemonæ˜¯æˆ‘ä»¬çš„æœºå™¨å®‰è£…çš„OSé•œåƒçš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤å‡ ä¹è°·æ­Œå†…éƒ¨çš„æ‰€æœ‰çš„çº¿ä¸ŠæœåŠ¡å™¨éƒ½æ”¯æŒdapperè·Ÿè¸ªã€‚\nåœ¨æŸäº›æƒ…å†µä¸‹dapperå¯èƒ½ä¸èƒ½å¤Ÿæ­£ç¡®åœ°è·Ÿè¸ªæ§åˆ¶è·¯å¾„ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºä½¿ç”¨äº†éæ ‡å‡†çš„æ§åˆ¶æµæ“ä½œï¼Œæˆ–è€…æ˜¯dapperé”™è¯¯åœ°å°†è·Ÿè¸ªä¿¡æ¯å½’ç±»åˆ°ä¸ç›¸å…³çš„äº‹ä»¶ä¸Šã€‚dapperæä¾›äº†ä¸€ä¸ªç®€å•çš„åº“æ¥å¸®åŠ©å¼€å‘äººå‘˜æ‰‹åŠ¨æ§åˆ¶è·Ÿè¸ªçš„ä¼ æ’­ä¿¡æ¯ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§ä¸Šè¿°é—®é¢˜çš„åŠæ³•å§ã€‚å½“å‰å¤§çº¦æœ‰40å¤šä¸ªc++ç¨‹åºå’Œ33ä¸ªjavaç¨‹åºéœ€è¦æ‰‹åŠ¨æ§åˆ¶è·Ÿè¸ªä¿¡æ¯ä¼ æ’­ï¼Œåªæ˜¯googleçº¿ä¸Šåº”ç”¨çš„ä¹ç‰›ä¸€æ¯›ï¼Œè¶³å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯å› ä¸ºæ²¡æœ‰ä½¿ç”¨dapperè¿è¡Œæ—¶åº“ï¼Œå¦‚ä½¿ç”¨åŸç”Ÿçš„tcp socketã€soap rpcè¿›è¡Œé€šä¿¡ï¼Œè¿™ç§dapperè‚¯å®šä¹Ÿæ˜¯æ— æ³•è·Ÿè¸ªçš„ã€‚\næ—©æœŸéƒ¨ç½²çš„æ—¶å€™ï¼Œdapperè¿˜æ²¡æœ‰é‚£ä¹ˆç¨³å®šï¼Œæ‰€ä»¥é»˜è®¤æ˜¯å…³é—­çš„ï¼Œ ç›´åˆ°dapperå¼€å‘äººå‘˜å¯¹å…¶ç¨³å®šæ€§å’Œå¼€é”€æœ‰äº†è¶³å¤Ÿçš„ä¿¡å¿ƒä¹‹åæ‰å°†å…¶ä¿®æ”¹ä¸ºé»˜è®¤å¼€å¯ã€‚\næ³¨é‡Šä½¿ç”¨æƒ…å†µ # ç¨‹åºå‘˜å€¾å‘äºå°†åº”ç”¨å±‚çº§çš„ä¸€äº›dapper annotationä½œä¸ºä¸€ç§åˆ†å¸ƒå¼è°ƒè¯•æ—¥å¿—ä½¿ç”¨ï¼Œæˆ–è€…ç”¨æ¥å¯¹dapper tracesè¿›è¡Œåˆ†ç±»ã€‚ä¾‹å¦‚ï¼Œæ‰€æœ‰çš„BigTableè¯·æ±‚éƒ½æ·»åŠ äº†è¦è®¿é—®çš„è¡¨åæ¥ä½œä¸ºannotationã€‚å½“å‰å‡ ä¹70%çš„dapper spansä»¥åŠ90%çš„dapper tracesåŒ…æ‹¬äº†è‡³å°‘1ä¸ªdapper annotationä¿¡æ¯ã€‚\n41ä¸ªjavaåº”ç”¨ã€68ä¸ªc++åº”ç”¨æ·»åŠ äº†è‡ªå®šä¹‰åº”ç”¨å±‚çº§çš„annotationæ¥æ›´å¥½åœ°ç†è§£spanå†…çš„æ´»åŠ¨ä¿¡æ¯ã€‚ç°åœ¨æ¥çœ‹javaå¼€å‘äººå‘˜åœ¨spanå†…æ·»åŠ çš„annotationæ¯”c++å¼€å‘äººå‘˜è¦å¤šä¸€äº›ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºc++æœåŠ¡æ›´ååº•å±‚ï¼Œjavaåº”ç”¨æ›´æ¥è¿‘ç”¨æˆ·ï¼Œé€»è¾‘æ›´é‡ä¸€äº›ï¼Œå…¶ä¸­æ¶‰åŠåˆ°çš„å„ç§æœåŠ¡å™¨è¯·æ±‚æ›´å¤šä¸€äº›ã€‚\nç®¡ç†è·Ÿè¸ªå¼€é”€ # è·Ÿè¸ªç³»ç»Ÿçš„å¼€é”€ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€æ˜¯è¢«ç›‘æ§ç³»ç»Ÿç”Ÿæˆtraceæ•°æ®å’Œtrace daemonæ”¶é›†è¿™éƒ¨åˆ†traceæ•°æ®æ‰€å¸¦æ¥çš„ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼ŒäºŒæ˜¯éœ€è¦ä½¿ç”¨ä¸€éƒ¨åˆ†èµ„æºæ¥å­˜å‚¨å’Œåˆ†ætraceæ•°æ®ã€‚è™½ç„¶è¯´æˆ‘ä»¬è®¤ä¸ºå¯¹ä¸€ä¸ªæœ‰ä»·å€¼çš„ä¸­é—´ä»¶æ¤å…¥è·Ÿè¸ªå¸¦æ¥ä¸€éƒ¨åˆ†æ€§èƒ½å¼€é”€æ˜¯å€¼å¾—ï¼Œä½†æ˜¯å¦‚æœèƒ½è®²è¿™é‡Œçš„å¼€é”€é™ä½åˆ°å¯ä»¥å¿½ç•¥çš„ç¨‹åº¦ï¼Œé‚£æ˜¯æœ€å¥½ä¸è¿‡äº†ï¼Œæ¨å¹¿è¯¥è·Ÿè¸ªç³»ç»Ÿä¹Ÿä¼šå˜å¾—æ›´åŠ ç®€å•ã€‚\nä»3ä¸ªæ–¹é¢å±•ç¤ºè·Ÿè¸ªç³»ç»Ÿçš„å¼€é”€æƒ…å†µï¼šdapperç»„ä»¶æ“ä½œçš„å¼€é”€ï¼Œè·Ÿè¸ªæ”¶é›†çš„å¼€é”€ï¼Œdapperå¯¹ç”Ÿäº§ç¯å¢ƒè´Ÿè½½çš„å½±å“ã€‚è¿™é‡Œä¹Ÿä¼šä»‹ç»dapperçš„å¯å˜é‡‡æ ·ç‡æœºåˆ¶å¦‚ä½•å¸®åŠ©é™ä½å¼€é”€ï¼Œä»¥åŠå¦‚ä½•åœ¨ä½å¼€é”€å’Œè·å¾—ä»£è¡¨æ€§çš„è·Ÿè¸ªäºŒè€…ä¹‹é—´è·å¾—å¹³è¡¡ã€‚\nç”Ÿæˆè·Ÿè¸ªçš„å¼€é”€ # ç”Ÿæˆtraceæ•°æ®çš„å¼€é”€æ˜¯dapperæ€§èƒ½å½±å“ä¸­æœ€å…³é”®çš„éƒ¨åˆ†ï¼Œå› ä¸ºæ”¶é›†ã€åˆ†ætraceæ•°æ®çš„å·¥ä½œå¯ä»¥åœ¨ç´§æ€¥æƒ…å†µä¸‹æ›´å®¹æ˜“è¢«å…³é—­ã€‚dapperè¿è¡Œåº“ä¸­ç”Ÿæˆtraceæ•°æ®çš„å¼€é”€ï¼Œä¸»è¦æ˜¯åˆ›å»ºå’Œé”€æ¯spanã€annotationï¼Œå¹¶å°†å…¶è®°å½•åˆ°ç£ç›˜ä¾›åç»­æ”¶é›†è€Œå¼•å…¥çš„ã€‚root spançš„åˆ›å»ºå’Œé”€æ¯å¹³å‡éœ€è¦æ¶ˆè€—204nsçš„äº‹ä»¶ï¼Œåˆ›å»ºã€é”€æ¯å…¶ä»–spanåˆ™åªéœ€è¦å¤§çº¦176nsï¼Œè¿™æ˜¯å› ä¸ºroot spançš„åˆ›å»ºéœ€è¦ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„idï¼Œå¼€é”€ç¨å¤§äº›ã€‚\nå¦‚æœä¸€ä¸ªspanæ²¡æœ‰è¢«é‡‡æ ·çš„è¯ï¼Œè¿™ä¸ªspanä¸‹åˆ›å»ºannotationçš„æˆæœ¬å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå¹³å‡åªéœ€è¦9nsã€‚å¦‚æœè¢«çº³å…¥é‡‡æ ·çš„è¯ï¼Œä¼šç”¨ä¸€ä¸ªå­—ç¬¦ä¸²æ¥è¿›è¡Œæ ‡æ³¨ï¼Œå¹³å‡éœ€è¦40nsã€‚è¿™äº›æ•°æ®éƒ½æ˜¯åœ¨2.2GHzçš„x86æœåŠ¡å™¨ä¸Šé‡‡é›†çš„ã€‚\nåœ¨dapperè¿è¡ŒæœŸå°†traceæ•°æ®å†™å…¥åˆ°æœ¬åœ°ç£ç›˜æ˜¯å¼€é”€æœ€å¤§çš„æ“ä½œï¼Œä½†æ˜¯ä»–ä»¬çš„å¯è§å¼€é”€å¤§å¤§å‡å°‘äº†ï¼Œå› ä¸ºå†™å…¥æ—¥å¿—æ–‡ä»¶çš„æ“ä½œç›¸å¯¹äºè¢«è·Ÿè¸ªçš„åº”ç”¨ç³»ç»Ÿæ¥è¯´æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œã€‚ä¸è¿‡ï¼Œå¦‚æœè¯·æ±‚é‡ç‰¹åˆ«å¤§çš„æƒ…å†µä¸‹ï¼Œå°¤å…¶æ˜¯é‡‡æ ·ç‡å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼Œæ—¥å¿—å†™å…¥çš„æ“ä½œä»ç„¶æ˜¯å¼€é”€æ¯”è¾ƒå¤§çš„æ“ä½œã€‚åé¢ä¼šå±•ç¤ºä¸€ä¸ªwebæœç´¢çš„è´Ÿè½½ä¸‹çš„çš„æ€§èƒ½å¼€é”€ç¤ºä¾‹ã€‚\nè·Ÿè¸ªæ”¶é›†çš„å¼€é”€ # è¯»å–ç”Ÿæˆçš„traceæ•°æ®ä¹Ÿä¼šå¯¹è´Ÿè½½äº§ç”Ÿä¸€å®šçš„å¹²æ‰°ï¼Œä¸‹è¡¨å±•ç¤ºäº†æœ€åæƒ…å†µä¸‹ï¼Œdapper trace collector daemonåœ¨é«˜äºå®é™…æƒ…å†µè´Ÿè½½æƒ…å†µä¸‹è¿›è¡Œtraceæ”¶é›†è¿‡ç¨‹ä¸­cpuä½¿ç”¨ç‡æƒ…å†µã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹ä»æ¥æ²¡æœ‰è¶…è¿‡0.3%çš„å•æ ¸cpuä½¿ç”¨ç‡ï¼Œè€Œä¸”åªæœ‰å¾ˆå°‘é‡çš„å†…å­˜ä½¿ç”¨ï¼ˆä»¥åŠå †ç¢ç‰‡å™ªéŸ³ï¼‰ã€‚æˆ‘ä»¬è¿˜é™åˆ¶äº†dapperå®ˆæŠ¤è¿›ç¨‹çš„è°ƒåº¦ä¼˜å…ˆçº§ä¸ºæœ€ä½ä¼˜å…ˆçº§ï¼Œä»¥é¿å…åœ¨ä¸€å°é«˜è´Ÿè½½çš„æœåŠ¡å™¨ä¸Šå‡ºç°cpuç«äº‰ã€‚\ndapperä¹Ÿæ˜¯ä¸€ä¸ªå¸¦å®½èµ„æºçš„è½»é‡çº§æ¶ˆè´¹è€…ï¼Œæ¯ä¸€ä¸ªspanåœ¨ä¼ è¾“åˆ°BigTableä»“åº“è¿‡ç¨‹ä¸­å¹³å‡åªå ç”¨äº†426ä¸ªå­—èŠ‚ã€‚ä½œä¸ºç½‘ç»œè¡Œä¸ºä¸­çš„æå°éƒ¨åˆ†ï¼Œdapperçš„traceæ•°æ®æ”¶é›†åœ¨è°·æ­Œçš„ç”Ÿäº§ç¯å¢ƒä¸­åªå ç”¨äº†0.01%çš„ç½‘ç»œèµ„æºã€‚\nç”Ÿäº§ç¯å¢ƒçš„å¼€é”€ # æ¯ä¸ªç”¨æˆ·è¯·æ±‚å¯èƒ½ä¼šç‰µæ‰¯åˆ°å¯¹å¤§é‡çš„é«˜ååé‡çš„çº¿ä¸ŠæœåŠ¡çš„è¯·æ±‚è°ƒç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†è¿›è¡Œåˆ†å¸ƒå¼è·Ÿè¸ªçš„åŸå› ä¹‹ä¸€ã€‚è¿™ç§æƒ…å†µä¸‹ä¼šç”Ÿæˆå¤§é‡çš„traceæ•°æ®ï¼Œå¹¶ä¸”ä»–ä»¬å¯¹æ€§èƒ½çš„å½±å“æ˜¯æœ€æ•æ„Ÿçš„ã€‚åœ¨ä¸‹è¡¨ä¸­æˆ‘ä»¬ç”¨é›†ç¾¤ä¸‹çš„ç½‘ç»œæœç´¢ä½œä¸ºä¾‹å­ï¼Œé€šè¿‡è°ƒæ•´é‡‡æ ·ç‡æ¥è¡¡é‡dapperåœ¨å»¶è¿Ÿå’Œååé‡æ–¹é¢å¯¹çº¿ä¸ŠæœåŠ¡æ€§èƒ½çš„å½±å“ã€‚\nä»è¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé‡‡æ ·ç‡çš„å˜åŒ–å¯¹æœåŠ¡ååé‡çš„å½±å“ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œä½†æ˜¯å¯¹æœåŠ¡å»¶è¿Ÿçš„å½±å“è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå› æ­¤ä¹Ÿå¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼Œå¯¹traceæ•°æ®è¿›è¡Œé‡‡æ ·è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚\nå½“æˆ‘ä»¬æŠŠé‡‡æ ·ç‡è°ƒæ•´åˆ°1/16ä¹‹åï¼Œå¼•å…¥çš„æœåŠ¡å»¶è¿Ÿå’Œååé‡çš„å¼€é”€å°±å…¨éƒ¨åœ¨å®éªŒè¯¯å·®èŒƒå›´å†…äº†ã€‚åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬è¿˜å‘ç°å³ä¾¿é‡‡æ ·ç‡è°ƒæ•´åˆ°1/1024åä»ç„¶æœ‰è¶³å¤Ÿé‡çš„traceæ•°æ®æ¥è·Ÿè¸ªå¤§é‡æœåŠ¡ã€‚ä¿æŒdapperçš„æ€§èƒ½å¼€é”€åŸºå‡†åœ¨ä¸€ä¸ªéå¸¸ä½çš„æ°´å¹³æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºå®ƒä¸ºå“ªäº›åº”ç”¨æä¾›äº†ä¸€ä¸ªå®½æ¾çš„ç¯å¢ƒæ¥ä½¿ç”¨å®Œæ•´çš„annotation apiæ¥å¢å¼ºè·Ÿè¸ªèƒ½åŠ›çš„åŒæ—¶è€Œæ— éœ€æ‹…å¿ƒæ€§èƒ½æŸå¤±ã€‚ä½¿ç”¨è¾ƒä½çš„é‡‡æ ·ç‡ä¹Ÿæ˜¯æœ‰é¢å¤–çš„å¥½å¤„çš„ï¼Œå¯ä»¥è®©æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸­çš„traceæ•°æ®åœ¨åƒåœ¾å›æ”¶æœºåˆ¶å¤„ç†ä¹‹å‰ä¿ç•™æ›´é•¿çš„äº‹ä»¶ï¼Œè¿™æ ·ä¸ºdapperçš„æ”¶é›†ç»„ä»¶ä¿ç•™äº†æ›´å¤šçš„çµæ´»æ€§ã€‚\nå¯å˜é‡‡æ · # è¿›ç¨‹ä¸­dapperæ‰€å¼•å…¥çš„å¼€é”€ä¸é‡‡æ ·ç‡æˆæ­£æ¯”ã€‚dapperçš„ç¬¬ä¸€ä¸ªç”Ÿäº§ç‰ˆæœ¬ç»Ÿä¸€å°†é‡‡æ ·ç‡è®¾ç½®ä¸ºäº†1/1024ã€‚è¿™ä¸ªç®€å•çš„æ–¹æ¡ˆå¯¹é«˜ååé‡çš„çº¿ä¸ŠæœåŠ¡æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œå› ä¸ºé‚£äº›æ„Ÿå…´è¶£çš„äº‹ä»¶åœ¨ååé‡å¤§äº†ä¹‹åé€šå¸¸å¯èƒ½ä¼šç»å¸¸å‡ºç°ï¼Œå®¹æ˜“è¢«å†æ¬¡æ•æ‰åˆ°ã€‚\nä½†æ˜¯ï¼Œè¿™ç§è¾ƒä½çš„é‡‡æ ·ç‡ï¼Œå¯¹äºååé‡æ¯”è¾ƒå°çš„çº¿ä¸ŠæœåŠ¡å¯èƒ½å°±ä¸å¤ªæ˜æ™ºäº†ï¼Œä¼šå¾ˆå®¹æ˜“é”™è¿‡ä¸€äº›äº‹ä»¶ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½å¸Œæœ›é…ç½®æˆè¾ƒé«˜çš„é‡‡æ ·ç‡ï¼Œå¦‚1ï¼Œä½†æ˜¯åˆå¯èƒ½è¦æ‹…å¿ƒå¼•å…¥çš„æ€§èƒ½å¼€é”€ã€‚å…³é”®çš„æ˜¯ï¼Œè¿™ç§æƒ…å†µä¸‹è¦è¦†ç›–é»˜è®¤çš„é‡‡æ ·ç‡1/1024è¿˜éœ€è¦äººå·¥è¿›è¡Œå¹²é¢„ï¼Œè¿™å¯ä¸æ˜¯dapperè®¾è®¡è€…æ‰€æœŸæœ›çš„ï¼Œè¿™æ ·å°±å¼•å…¥äº†å¯å˜é‡‡æ ·ã€‚\nåœ¨éƒ¨ç½²å¯å˜é‡‡æ ·(ä¹Ÿç§°è‡ªé€‚åº”é‡‡æ ·)çš„è¿‡ç¨‹ä¸­ï¼Œå‚æ•°åŒ–é…ç½®é‡‡æ ·ç‡æ—¶ï¼Œä¸å†ä½¿ç”¨ä¸€ä¸ªç»Ÿä¸€çš„é‡‡æ ·æ–¹æ¡ˆï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªé‡‡æ ·æœŸæœ›ç‡æ¥æ ‡è¯†å•ä½æ—¶é—´å†…é‡‡æ ·çš„traceæ•°é‡ã€‚ä¾‹å¦‚å¸Œæœ›1minå†…é‡‡æ ·100æ¡è®°å½•ï¼Œåœ¨é«˜ååé‡çš„çº¿ä¸ŠæœåŠ¡ä¸­å°±å¤šä¸¢å¼ƒä¸€äº›traceæ•°æ®ï¼Œåœ¨ä½ååé‡çš„çº¿ä¸ŠæœåŠ¡ä¸­å°±å°‘ä¸¢å¼ƒä¸€äº›traceæ•°æ®ã€‚è¿™æ ·ä¸€æ¥ï¼Œé«˜ååé‡çš„å°†è‡ªåŠ¨é™ä½é‡‡æ ·ç‡ï¼Œä½ååé‡çš„å°†è‡ªåŠ¨æé«˜é‡‡æ ·ç‡ï¼Œä»è€Œä½¿å¾—å¼€é”€ä¸€ç›´ä½äºå¼€é”€åŸºå‡†ä»¥ä¸‹ã€‚å®é™…ä½¿ç”¨çš„é‡‡æ ·ç‡ä¼šéšç€è·Ÿè¸ªæœ¬èº«è®°å½•ä¸‹æ¥ï¼Œæœ‰åˆ©äºtraceåˆ†æå·¥å…·è¿›è¡Œå‡†ç¡®çš„åˆ†æã€‚\nåº”å¯¹ç§¯æé‡‡æ · # åœ¨é«˜ååé‡çš„çº¿ä¸ŠæœåŠ¡ä¸­å¾€å¾€é‡‡æ ·ç‡ä¼šä½è‡³0.01%ï¼Œæ–°çš„dapperç”¨æˆ·å¾€å¾€ä¼šè§‰å¾—è¿™ä¸åˆ©äºä»–ä»¬çš„åˆ†æã€‚ä½†æˆ‘ä»¬åœ¨è°·æ­Œçš„å®è·µç»éªŒä½¿æˆ‘ä»¬ç›¸ä¿¡ï¼Œå¯¹äºé«˜ååé‡æœåŠ¡ï¼Œå¦‚æœä¸€ä¸ªæ˜¾è‘—çš„æ“ä½œåœ¨ç³»ç»Ÿå‡ºå‘ç”Ÿäº†ä¸€æ¬¡ï¼Œé‚£å®ƒå°±ä¼šå‡ºç°æˆåƒä¸Šä¸‡æ¬¡ï¼Œå› æ­¤ç§¯æé‡‡æ ·ï¼ˆagreessive samplingï¼‰ï¼ˆæŒ‡çš„åº”è¯¥æ˜¯å¯å˜é‡‡æ ·åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡ï¼‰å¹¶ä¸ä¼šå¦¨ç¢ä»–ä»¬çš„åˆ†æã€‚ä½ååé‡çš„æœåŠ¡ï¼Œä¹Ÿè®¸æ¯ç§’å°±å‡ åæ¬¡è¯·æ±‚ï¼Œè€Œä¸æ˜¯å‡ åä¸‡ï¼Œå³ä¾¿é‡‡æ ·ç‡ä¸º100%ä¹Ÿå¯ä»¥è´Ÿæ‹…çš„èµ·æ¯ä¸€ä¸ªè¯·æ±‚ã€‚ç»¼åˆè¿™ä¸¤ç§æƒ…å†µï¼Œç§¯æé‡‡æ ·ï¼ˆå¯å˜é‡‡æ ·è€Œéå›ºå®šé‡‡æ ·ç‡ä¸å˜ï¼‰æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œè¿™æ˜¯ä¿ƒä½¿æˆ‘ä»¬å†³å¿ƒä½¿ç”¨å¯å˜é‡‡æ ·çš„åŸå› ã€‚\né¢å¤–é‡‡æ · # ä¸Šè¿°é‡‡æ ·ç­–ç•¥æè¿°çš„æ˜¯åº”ç”¨ç¨‹åºç”Ÿæˆtraceæ•°æ®æ—¶æ˜¯å¦è®°å½•åˆ°æœ¬åœ°ç£ç›˜ä¸­ï¼Œé€šè¿‡å¯å˜é‡‡æ ·å‡å°‘æ€§èƒ½å¼€é”€çš„åŒæ—¶ä¸ä¸¢å¤±è¿‡å¤šçš„è·Ÿè¸ªäº‹ä»¶ä»¥ä¿è¯è·Ÿè¸ªèƒ½åŠ›ã€‚dapperçš„å›¢é˜Ÿè¿˜éœ€è¦å°†æ”¶é›†åˆ°çš„traceæ•°æ®å†™å…¥ä¸­å¤®èµ„æ–™åº“çš„BigTableä»“åº“ä¸­ï¼Œéœ€è¦æ§åˆ¶å†™å…¥è§„æ¨¡ï¼Œå› æ­¤ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œè¿˜éœ€è¦ç»“åˆâ€œäºŒçº§é‡‡æ ·â€ã€‚\nç›®å‰æˆ‘ä»¬çš„ç”Ÿäº§é›†ç¾¤æ¯å¤©äº§ç”Ÿè¶…è¿‡1TBçš„traceæ•°æ®ï¼Œdapperçš„ç”¨æˆ·å¸Œæœ›ç”Ÿäº§ç¯å¢ƒä¸‹çš„è¿›ç¨‹çš„è·Ÿè¸ªæ•°æ®ä»è¢«è®°å½•ä¹‹åèƒ½å¤Ÿä¿å­˜è‡³å°‘ä¸¤å‘¨çš„äº‹ä»¶ã€‚é€æ¸å¢é•¿çš„traceæ•°æ®å¯†åº¦å¿…é¡»å’Œdapperä¸­å¤®ä»“åº“é”æ¶ˆè€—çš„æœåŠ¡å™¨åŠç¡¬ç›˜å­˜å‚¨è¿›è¡Œæƒè¡¡ã€‚é«˜é‡‡æ ·ç‡è¿˜ä½¿å¾—dapperæ”¶é›†å™¨å†™å…¥BigTableä¸­å¤®ä»“åº“çš„é€Ÿç‡æ¥è¿‘äº†BigTableå†™ååé‡ä¸Šé™ã€‚\nä¸ºäº†ç»´æŒæ‰€éœ€çš„ç¡¬ä»¶æˆæœ¬å’Œæ¸å¢çš„BigTableå†™ååé‡ä¹‹é—´çš„çµæ´»æ€§ï¼Œæˆ‘ä»¬åœ¨traceæ•°æ®æ”¶é›†ç³»ç»Ÿè‡ªèº«ä¸­å¢åŠ äº†é¢å¤–çš„é‡‡æ ·æ§åˆ¶ã€‚è¿™é‡Œå……åˆ†åˆ©ç”¨äº†æ‰€æœ‰spanéƒ½æ¥è‡ªä¸€ä¸ªç‰¹å®šçš„traceå¹¶å…±äº«åŒä¸€ä¸ªtrace-idè¿™ä¸ªäº‹å®ï¼Œæœ‰äº›spanå¯èƒ½æ¨ªè·¨äº†æ•°åƒä¸ªä¸»æœºã€‚å¯¹äºæ”¶é›†ç³»ç»Ÿä¸­çš„æ¯ä¸€ä¸ªspanï¼Œæˆ‘ä»¬ç”¨hashç®—æ³•æŠŠtrace-idè½¬æˆä¸€ä¸ªæ ‡é‡zï¼Œè¿™é‡Œ0\u0026lt;=z\u0026lt;=1ã€‚å¦‚æœzæ¯”æˆ‘ä»¬æ”¶é›†ç³»ç»Ÿä¸­æŒ‡å®šçš„ç³»æ•°ï¼ˆé˜ˆå€¼ï¼‰ä½çš„è¯ï¼Œæˆ‘ä»¬å°±ä¿ç•™è¿™ä¸ªspanä¿¡æ¯ï¼Œå¹¶å†™å…¥åˆ°BigTableä»“åº“ä¸­ï¼›åä¹‹ï¼Œæˆ‘ä»¬å°±ä¸¢å¼ƒå®ƒã€‚trace-idå”¯ä¸€æ ‡è¯†äº†ä¸€ä¸ªtraceï¼Œæˆ‘ä»¬è¦ä¹ˆä¿å­˜æ•´ä¸ªè·Ÿè¸ªä¿¡æ¯ï¼Œè¦ä¹ˆå…¨éƒ¨ä¸¢å¼ƒï¼Œè€Œä¸æ˜¯å•ç‹¬å¤„ç†traceæ•°æ®å†…çš„æŸä¸ªspanã€‚\næœ‰äº†è¿™ä¸ªé¢å¤–çš„â€œå…¨å±€å†™å…¥ç‡å‚æ•°â€ä¹‹åï¼Œä½¿æˆ‘ä»¬çš„æ”¶é›†ç®¡é“å˜å¾—ç®€å•å¤šäº†ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨é…ç½®æ–‡ä»¶ä¸­è°ƒæ•´å®ƒæ¥æ§åˆ¶å†™å…¥ç‡ã€‚\næ€»ç»“ # dapperç»“åˆä¸¤ç§é‡‡æ ·ç­–ç•¥ï¼Œæ¥å¹³è¡¡å¼€é”€ã€è·Ÿè¸ªæ•ˆæœã€ç¡¬ä»¶æˆæœ¬ä¹‹é—´çš„å…³ç³»ï¼š\n åº”ç”¨ç¨‹åºä¸­ç”Ÿæˆtraceæ•°æ®å¹¶è®°å½•åˆ°æœ¬åœ°ç£ç›˜ï¼Œæ­¤è¿‡ç¨‹åº”ç”¨â€œå¯å˜é‡‡æ ·ç­–ç•¥â€ï¼› traceæ•°æ®æ”¶é›†ç³»ç»Ÿæ”¶é›†æ•°æ®å†™å…¥BigTableä¸­å¤®ä»“åº“ï¼Œæ­¤è¿‡ç¨‹åº”ç”¨â€œé¢å¤–é‡‡æ ·ç­–ç•¥â€ï¼›  dapperå·¥å…· # å…³äºdapperçš„é…å¥—å·¥å…·ï¼Œè¿™é‡Œåªç»™ä¸€ä¸ªdapperæ“ä½œç•Œé¢çš„å±•ç¤ºï¼Œæ–¹ä¾¿å¤§å®¶äº†è§£å¤§è‡´ä¸Šå…·å¤‡å“ªäº›èƒ½åŠ›ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nå¤§å®¶å¯ä»¥äº†è§£ä¸‹zipkinã€jaegerï¼Œä»–ä»¬éƒ½æ˜¯åŸºäºdapperæ¼”åŒ–è€Œæ¥ï¼Œè¿™é‡Œæˆ‘ä»¬å°±å†è¯¦ç»†ä»‹ç»dapperè‡ªèº«çš„å·¥å…·äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¹Ÿæ— æ³•ä½¿ç”¨å®ƒï¼Œåªèƒ½ç”¨å¼€æºå®ç°zipkinã€jaegerä¹‹ç±»çš„ã€‚\næœ¬æ–‡ä¸»è¦æ˜¯ä¸ºäº†é˜è¿°dapperçš„è®¾è®¡æ€æƒ³ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¤§å®¶äº†è§£åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿçš„å·¥ä½œåŸç†ï¼Œç„¶åæ–¹ä¾¿æˆ‘ä»¬å°†ç°æœ‰çš„å¼€æºå®ç°zipkinã€jaegeré›†æˆåˆ°æˆ‘ä»¬è‡ªèº«çš„æ¡†æ¶ä¸­ï¼Œæ–¹ä¾¿è‡ªå·±çš„ä¸šåŠ¡å¼€å‘äººå‘˜å®šä½çº¿ä¸Šé—®é¢˜ã€‚\nå¦‚æœå¯¹è°·æ­Œdapperçš„å·¥å…·æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥å‚è€ƒè¿™é‡Œçš„è¯´æ˜ï¼Œç‚¹å‡»æŸ¥çœ‹ dapperï¼šå¤§è§„æ¨¡åˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿã€‚\ndapperä½¿ç”¨ # dapperåœ¨è°·æ­Œè¢«å¹¿æ³›ä½¿ç”¨ï¼Œä¸€éƒ¨åˆ†ç›´æ¥é€šè¿‡dapperçš„ç”¨æˆ·ç•Œé¢ï¼Œå¦ä¸€éƒ¨åˆ†é—´æ¥åœ°é€šè¿‡å¯¹dapper apiçš„äºŒæ¬¡å¼€å‘æˆ–è€…åœ¨ç°æœ‰çš„apiåŸºç¡€ä¸Šå»ºç«‹çš„åº”ç”¨ã€‚\nåŸdapperè®ºæ–‡ä¸­åˆ—ä¸¾äº†ä¸€äº›æˆåŠŸçš„dapperä½¿ç”¨åœºæ™¯ï¼Œå¤§å®¶ä¹Ÿå¯ä»¥å‚è€ƒä¸‹ï¼Œå†³å®šå°†dapperï¼Œæˆ–è€…zipkinã€jaegerç”¨åœ¨ä»€ä¹ˆåœºæ™¯ä¸‹å‘¢ï¼Ÿèƒ½å¤Ÿé€šè¿‡äºŒæ¬¡å¼€å‘å®šåˆ¶åŒ–ä¸€äº›è‡ªå·±éœ€è¦çš„å¯è§†åŒ–å·¥å…·å‡ºæ¥å‘¢ï¼Ÿè¿™ä¸ªæ˜¯æˆ‘ä»¬è¦æ€è€ƒçš„ï¼Œä¹Ÿæ˜¯å¯¹æˆ‘ä»¬çš„åº”ç”¨å¼€å‘äººå‘˜ã€ç»´æŠ¤äººå‘˜æœ€ä¼˜ä»·å€¼çš„éƒ¨åˆ†ã€‚\nåœ¨å¼€å‘ä¸­ä½¿ç”¨dapper # Google AdWordså€ŸåŠ©dapperæ¥ä¼˜åŒ–è‡ªå·±çš„ç³»ç»Ÿï¼Œå‘ç°ç³»ç»Ÿä¸­å»¶è¿Ÿè¿‡é«˜çš„æœåŠ¡è°ƒç”¨ï¼Œå‘ç°ä¸å¿…è¦çš„ä¸²è¡Œè¯·æ±‚å¹¶æ¨åŠ¨å›¢é˜Ÿä¿®å¤ï¼Œä»¥æ”¹å–„æ€§èƒ½é—®é¢˜ç­‰ç­‰ã€‚\nä¸å¼‚å¸¸ç›‘æ§çš„é›†æˆ # Googleç»´æŠ¤äº†ä¸€ä¸ªä¸æ–­ä»è¿›ç¨‹ä¸­æ”¶é›†å¼‚å¸¸ä¿¡æ¯å¹¶é›†ä¸­å¼‚å¸¸ä¿¡æ¯æŠ¥å‘Šçš„æœåŠ¡ï¼Œå¦‚æœè¿™äº›å¼‚å¸¸å‘ç”Ÿåœ¨è·Ÿè¸ªé‡‡æ ·çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹åº”çš„trace-idå’Œspan-idä¹Ÿä¼šè¢«è®°å½•åˆ°å¼‚å¸¸è®°å½•ä¸­ï¼Œåç»­å€ŸåŠ©å¯è§†åŒ–å·¥å…·å¯ä»¥å®¹æ˜“å®šä½å¼‚å¸¸å‘ç”Ÿåœ¨é“¾è·¯ä¸­çš„å“ªä¸€ä¸ªç¯èŠ‚ï¼Œå¹¶å€ŸåŠ©annotationæ¥è¿›ä¸€æ­¥å®šä½é—®é¢˜ã€‚\nè§£å†³å»¶è¿Ÿçš„é•¿å°¾æ•ˆåº” # å½“ä¸€ä¸ªç³»ç»Ÿä¸ä»…æ¶‰åŠæ•°ä¸ªå­ç³»ç»Ÿï¼Œè€Œæ˜¯å‡ åä¸ªå¼€å‘å›¢é˜Ÿçš„æ¶‰åŠåˆ°çš„ç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œç«¯åˆ°ç«¯æ€§èƒ½è¾ƒå·®çš„æ ¹æœ¬åŸå› åˆ°åº•åœ¨å“ªï¼Œè¿™ä¸ªé—®é¢˜å³ä½¿æ˜¯æˆ‘ä»¬æœ€å¥½çš„å’Œæœ€æœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆä¹Ÿæ— æ³•æ­£ç¡®å›ç­”ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDapperå¯ä»¥æä¾›æ€¥éœ€çš„æ•°æ®ï¼Œè€Œä¸”å¯ä»¥å¯¹è®¸å¤šé‡è¦çš„æ€§èƒ½é—®é¢˜å¾—å‡ºç»“è®ºã€‚\næ¨æ–­æœåŠ¡ä¾èµ– # çº¿ä¸ŠæœåŠ¡åŸºæœ¬éƒ½æ˜¯é›†ç¾¤éƒ¨ç½²ï¼Œæ¯ä¸€ä¸ªæœåŠ¡ä¸Šè¿è¡Œçš„ä»»åŠ¡å¯èƒ½ä¾èµ–äº†å…¶ä»–çš„å¾ˆå¤šæœåŠ¡ï¼Œè€Œä¸åŒçš„ä»»åŠ¡ä¾èµ–çš„æœåŠ¡ä¹Ÿæ˜¯æ˜¯åŠ¨æ€æ”¹å˜çš„ï¼Œæ‰€ä»¥ä¸å¯èƒ½ä»…ä»é…ç½®ä¿¡æ¯ä¸Šæ¨æ–­å‡ºæ‰€æœ‰è¿™äº›æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚dapperæ ¸å¿ƒç»„ä»¶ä¸dapperè·Ÿè¸ªannotationä¸€å¹¶ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œâ€œService Dependenciesâ€é¡¹ç›®èƒ½å¤Ÿæ¨ç®—å‡ºä»»åŠ¡å„è‡ªä¹‹é—´çš„ä¾èµ–ï¼Œä»¥åŠä»»åŠ¡å’Œå…¶ä»–è½¯ä»¶ç»„ä»¶ä¹‹é—´çš„ä¾èµ–ã€‚åœ¨å…¬å¸å†…éƒ¨çš„å„ä¸ªæµç¨‹éœ€è¦å‡†ç¡®çš„æœåŠ¡ä¾èµ–å…³ç³»ä¿¡æ¯ï¼Œä»¥ç¡®å®šç“¶é¢ˆæ‰€åœ¨ï¼Œä»¥åŠæŒ‡å¯¼æœåŠ¡çš„è¿ç§»è®¡åˆ’ã€‚\nä¸åŒæœåŠ¡çš„ç½‘ç»œä½¿ç”¨ç‡ # è°·æ­ŒæŠ•å…¥äº†å¤§é‡çš„äººåŠ›å’Œç‰©åŠ›ä¼˜åŒ–å…¶ç½‘ç»œï¼Œä»¥å‰ç½‘ç»œç®¡ç†å‘˜åªèƒ½å…³æ³¨ç‹¬ç«‹çš„ç¡¬ä»¶ä¿¡æ¯ã€å¸¸ç”¨å·¥å…·åŠä»¥åŠæ­å»ºå‡ºçš„å„ç§å…¨å±€ç½‘ç»œé¸Ÿç°å›¾çš„dashboardä¸Šçš„ä¿¡æ¯ã€‚ç½‘ç»œç®¡ç†å‘˜ç¡®å®å¯ä»¥ä¸€è§ˆæ•´ä¸ªç½‘ç»œçš„å¥åº·çŠ¶å†µï¼Œä½†æ˜¯ï¼Œå½“é‡åˆ°é—®é¢˜æ—¶ï¼Œä»–ä»¬å¾ˆå°‘æœ‰å·¥å…·å¯ä»¥åŠæ—¶å‡†ç¡®åœ°å®šä½åˆ°å¯¼è‡´ç½‘ç»œè´Ÿè½½é«˜çš„åº”ç”¨ç¨‹åºçº§åˆ«çš„ç½ªé­ç¥¸é¦–ã€‚ è™½ç„¶dapperä¸æ˜¯è®¾è®¡ç”¨æ¥åšé“¾è·¯çº§çš„ç›‘æ§çš„ï¼Œä½†æˆ‘ä»¬å‘ç°ï¼Œå®ƒéå¸¸é€‚åˆå»åšé›†ç¾¤ä¹‹é—´åº”ç”¨çº§ç½‘ç»œæ´»åŠ¨çš„åˆ†æã€‚è°·æ­Œåˆ©ç”¨dapperè¿™ä¸ªå¹³å°ï¼Œå»ºç«‹ä¸€ä¸ªä¸æ–­æ›´æ–°çš„æ§åˆ¶å°ï¼Œæ¥æ˜¾ç¤ºé›†ç¾¤ä¹‹é—´æœ€æ´»è·ƒçš„åº”ç”¨çº§ç½‘ç»œæµé‡çƒ­ç‚¹ã€‚æ­¤å¤–ï¼Œä½¿ç”¨dapperæˆ‘ä»¬èƒ½å¤Ÿä¸ºæ˜‚è´µçš„ç½‘ç»œè¯·æ±‚æŒ‡å‡ºå…·ä½“åˆ°åº”ç”¨çº§çš„åŸå› ï¼Œè€Œä¸æ˜¯é¢å¯¹ä¸åŒæœåŠ¡å™¨ä¹‹é—´çš„ä¿¡æ¯å­¤å²›æ— æ‰€é€‚ä»ã€‚\nåˆ†å±‚å’Œå…±äº«å­˜å‚¨ç³»ç»Ÿ # åœ¨Googleçš„è®¸å¤šå­˜å‚¨ç³»ç»Ÿæ˜¯ç”±å¤šé‡ç‹¬ç«‹å¤æ‚å±‚çº§çš„åˆ†å¸ƒå¼åŸºç¡€è®¾å¤‡ç»„æˆçš„ã€‚ä¾‹å¦‚ï¼ŒGoogleçš„App Engineå°±æ˜¯æ­å»ºåœ¨ä¸€ä¸ªå¯æ‰©å±•çš„å®ä½“å­˜å‚¨ç³»ç»Ÿä¸Šçš„ï¼Œè¯¥å®ä½“å­˜å‚¨ç³»ç»Ÿåœ¨BigTableåŸºç¡€ä¸Šå°è£…ã€æš´éœ²äº†æŸäº›RDBMSåŠŸèƒ½ã€‚ BigTableå‘¢ï¼ŒåˆåŒæ—¶ä½¿ç”¨äº†Chubbyï¼ˆåˆ†å¸ƒå¼é”ç³»ç»Ÿï¼‰åŠGFSã€‚ åœ¨è¿™ç§åˆ†å±‚çš„ç³»ç»Ÿä¸­ï¼Œå¹¶ä¸æ€»æ˜¯å¾ˆå®¹æ˜“ç¡®å®šæœ€ç»ˆç”¨æˆ·èµ„æºçš„æ¶ˆè´¹æ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œé’ˆå¯¹ä¸€ä¸ªç»™å®šçš„BigTableå•å…ƒæ ¼çš„å¤§é‡GFSè¯·æ±‚ä¸»è¦æ¥è‡ªäºä¸€ä¸ªç”¨æˆ·æˆ–æ˜¯ç”±å¤šä¸ªç”¨æˆ·ï¼Œä½†æ˜¯åœ¨GFSå±‚é¢ï¼Œè¿™ä¸¤ç§æ˜æ˜¾çš„ä½¿ç”¨åœºæ™¯æ˜¯å¾ˆéš¾ç•Œå®šçš„ã€‚è€Œä¸”ï¼Œå¦‚æœç¼ºä¹ä¸€ä¸ªåƒdapperä¸€æ ·çš„å·¥å…·çš„æƒ…å†µä¸‹ï¼Œå¯¹å…±äº«æœåŠ¡çš„ç«äº‰å¯èƒ½ä¼šåŒæ ·éš¾äºè°ƒè¯•ã€‚ dapperçš„ç”¨æˆ·ç•Œé¢å¯ä»¥èšåˆé‚£äº›è°ƒç”¨ä»»æ„å…¬å…±æœåŠ¡çš„å¤šä¸ªå®¢æˆ·ç«¯çš„è·Ÿè¸ªçš„æ€§èƒ½ä¿¡æ¯ã€‚è¿™å°±å¾ˆå®¹æ˜“è®©æä¾›è¿™äº›æœåŠ¡ä»å¤šä¸ªç»´åº¦ç»™ä»–ä»¬çš„ç”¨æˆ·æ’åï¼Œä¾‹å¦‚ï¼Œå…¥ç«™çš„ç½‘ç»œè´Ÿè½½ï¼Œå‡ºç«™çš„ç½‘ç»œè´Ÿè½½ï¼Œæˆ–æœåŠ¡è¯·æ±‚çš„æ€»æ—¶é—´ã€‚è¿™æ ·å°±ä¾¿äºå¯¹ä¸€ä¸ªå…±äº«æœåŠ¡ç¡®å®šå…¶ä¸Šæ¸¸æœåŠ¡å¯¹å…¶é€ æˆçš„è´Ÿè½½æƒ…å†µè¿›è¡Œç•Œå®šï¼Œä¾¿äºåç»­æ¨åŠ¨ä¸Šæ¸¸ä¼˜åŒ–æœåŠ¡è°ƒç”¨é€»è¾‘æˆ–è€…ç‹¬ç«‹éƒ¨ç½²å…±äº«æœåŠ¡ç­‰ç­‰å§ã€‚\ndapperçš„æ•‘ç«èƒ½åŠ› # å¯¹äºä¸€äº›â€œæ•‘ç«â€ä»»åŠ¡ï¼Œdapperå¯ä»¥å¤„ç†å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å¯¹äºé‚£äº›é«˜å»¶è¿Ÿï¼Œä¸ï¼Œå¯èƒ½åœ¨æ­£å¸¸è´Ÿè½½ä¸‹éƒ½ä¼šå“åº”è¶…æ—¶çš„æœåŠ¡ï¼ŒDapperç”¨æˆ·ç•Œé¢é€šå¸¸ä¼šæŠŠè¿™äº›ç“¶é¢ˆçš„ä½ç½®éš”ç¦»å‡ºæ¥ã€‚é€šè¿‡ä¸dapperæ”¶é›†è·Ÿè¸ªçš„å®ˆæŠ¤è¿›ç¨‹çš„ç›´æ¥é€šä¿¡ï¼Œé‚£äº›ç‰¹å®šçš„é«˜å»¶è¿Ÿçš„è·Ÿè¸ªæ•°æ®è½»æ˜“çš„å°±èƒ½æ”¶é›†åˆ°ã€‚å½“å‡ºç°ç¾éš¾æ€§æ•…éšœæ—¶ï¼Œé€šå¸¸æ˜¯æ²¡æœ‰å¿…è¦å»çœ‹ç»Ÿè®¡æ•°æ®ä»¥ç¡®å®šæ ¹æœ¬åŸå› çš„ï¼ŒåªæŸ¥çœ‹ç¤ºä¾‹è·Ÿè¸ªå°±è¶³å¤Ÿäº†ã€‚ ä½†æ˜¯ï¼Œé™¤éæ”¶é›†åˆ°çš„dapperæ•°æ®çš„æ‰¹é‡åˆ†æèƒ½åœ¨é—®é¢˜å‡ºç°10åˆ†é’Ÿä¹‹å†…å®Œæˆï¼Œå¦åˆ™dapperå°±ä¸èƒ½å¤„ç†è¿™æ ·çš„â€œæ•‘ç«â€ä»»åŠ¡ã€‚\næ€»ç»“ # æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†è°·æ­Œdapperåˆ†å¸ƒå¼è·Ÿè¸ªç³»ç»Ÿï¼Œå¹¶æ±‡æŠ¥äº†è°·æ­Œå†…éƒ¨çš„å¼€å‘ã€ä½¿ç”¨ç»éªŒã€‚ dapperå‡ ä¹éƒ¨ç½²åœ¨æ‰€æœ‰çš„è°·æ­Œçº¿ä¸Šç³»ç»Ÿä¸Šï¼Œå¹¶å¯ä»¥åœ¨ä¸éœ€è¦åº”ç”¨çº§ä¿®æ”¹çš„æƒ…å†µä¸‹è¿›è¡Œè·Ÿè¸ªï¼Œè€Œä¸”æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½å¼€é”€ã€‚dapperå¯¹äºå¼€å‘äººå‘˜å’Œè¿ç»´å›¢é˜Ÿå¸¦æ¥çš„å¥½å¤„ï¼Œå¯ä»¥ä»å¤§å®¶å¯¹è·Ÿè¸ªç”¨æˆ·ç•Œé¢çš„å¹¿æ³›ä½¿ç”¨ä¸Šçœ‹å‡ºæ¥ï¼Œå¦å¤–æˆ‘ä»¬è¿˜åˆ—ä¸¾äº†ä¸€äº›dapperçš„ä½¿ç”¨æ¡ˆä¾‹æ¥è¯´æ˜dapperçš„ä½œç”¨ï¼Œè¿™äº›æ¡ˆä¾‹æœ‰äº›ç”šè‡³éƒ½æ²¡æœ‰dapperå¼€å‘å›¢é˜Ÿå‚ä¸ï¼Œè€Œæ˜¯è¢«åº”ç”¨çš„å¼€å‘è€…è®¾è®¡ã€å¼€å‘å‡ºæ¥çš„ã€‚\næ®æˆ‘ä»¬æ‰€çŸ¥ï¼Œè¿™æ˜¯ç¬¬ä¸€ç¯‡æ±‡æŠ¥ç”Ÿäº§ç¯å¢ƒä¸‹åˆ†å¸ƒå¼ç³»ç»Ÿè·Ÿè¸ªæ¡†æ¶çš„è®ºæ–‡ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬çš„ä¸»è¦è´¡çŒ®æºäºè¿™ä¸ªäº‹å®ï¼šè®ºæ–‡ä¸­å›é¡¾çš„è¿™ä¸ªç³»ç»Ÿå·²ç»è¿è¡Œä¸¤å¹´ä¹‹ä¹…ã€‚æˆ‘ä»¬å‘ç°ï¼Œç»“åˆå¯¹å¼€å‘äººå‘˜æä¾›ç®€å•APIå’Œå¯¹åº”ç”¨ç³»ç»Ÿå®Œå…¨é€æ˜æ¥å¢å¼ºè·Ÿè¸ªçš„è¿™ä¸ªå†³å®šï¼Œæ˜¯éå¸¸å€¼å¾—çš„ã€‚\næˆ‘ä»¬ç›¸ä¿¡ï¼ŒDapperæ¯”ä»¥å‰çš„åŸºäºAnnotationçš„åˆ†å¸ƒå¼è·Ÿè¸ªè¾¾åˆ°æ›´é«˜çš„åº”ç”¨é€æ˜åº¦ï¼Œè¿™ä¸€ç‚¹å·²ç»é€šè¿‡åªéœ€è¦å°‘é‡äººå·¥å¹²é¢„çš„å·¥ä½œé‡å¾—ä»¥è¯æ˜ã€‚è™½ç„¶ä¸€å®šç¨‹åº¦ä¸Šå¾—ç›Šäºæˆ‘ä»¬çš„ç³»ç»Ÿçš„åŒè´¨æ€§ï¼Œä½†å®ƒæœ¬èº«ä»ç„¶æ˜¯ä¸€ä¸ªé‡å¤§çš„æŒ‘æˆ˜ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬çš„è®¾è®¡æå‡ºäº†ä¸€äº›å®ç°åº”ç”¨çº§é€æ˜æ€§çš„å……åˆ†æ¡ä»¶ï¼Œå¯¹æ­¤æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå¯¹æ›´é”™æ‚ç¯å¢ƒä¸‹çš„è§£å†³æ–¹æ¡ˆçš„å¼€å‘æœ‰æ‰€å¸®åŠ©ã€‚\næœ€åï¼Œé€šè¿‡å¼€æ”¾dapperè·Ÿè¸ªä»“åº“çš„ä»£ç ç»™å†…éƒ¨å¼€å‘è€…ï¼Œä¿ƒä½¿äº†æ›´å¤šçš„åŸºäºè·Ÿè¸ªä»“åº“çš„åˆ†æå·¥å…·çš„äº§ç”Ÿï¼Œè€Œä»…ä»…ç”±dapperå›¢é˜ŸåŸ‹å¤´è‹¦å¹²çš„æ˜¯è¿œè¿œä¸èƒ½è¾¾åˆ°ç°åœ¨è¿™ä¹ˆå¤§è§„æ¨¡çš„ï¼Œè¿™ä¸ªå†³å®šä¿ƒä½¿äº†è®¾è®¡å’Œå®æ–½çš„å±•å¼€ã€‚\nå‚è€ƒæ–‡çŒ®ï¼š\n Dapper, a Large-Scale Distributed Systems Tracing Infrastructure Dapperï¼Œå¤§è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„è·Ÿè¸ªç³»ç»Ÿ  "}),a.add({id:341,href:"/tags/bloom-filter/",title:"bloom filter",description:"",content:""}),a.add({id:342,href:"/tags/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/",title:"å¸ƒéš†è¿‡æ»¤å™¨",description:"",content:""}),a.add({id:343,href:"/blog/2018-09-29-%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/",title:"å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†åŠåº”ç”¨",description:"å¸ƒéš†è¿‡æ»¤å™¨åœ¨å¾ˆå¤šåœºæ™¯ä¸­éƒ½æœ‰åº”ç”¨ï¼Œå¦‚æ ¹æ®å‘ä»¶äººè¿‡æ»¤åƒåœ¾é‚®ä»¶ã€é¿å…å·²æµè§ˆè§†é¢‘çš„é‡å¤æ¨èã€é¿å…åˆ†å¸ƒå¼ç¼“å­˜ä¸­ä¸å­˜åœ¨keyçš„è®¿é—®ç©¿é€ï¼Œç­‰ç­‰ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å‘æŒ¥äº†éå¸¸å¤§çš„ä½œç”¨ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å…¶å®ä¹Ÿå­˜åœ¨å¾ˆå¤šçš„å˜ä½“ã€‚æœ¬æ–‡å°±æ¥ç»“åˆä½œè€…ä¸šåŠ¡ä¸­é‡åˆ°çš„é—®é¢˜ã€å¸ƒéš†è¿‡æ»¤å™¨çš„åº”ç”¨æ¥è¯¦ç»†äº†è§£ä¸‹å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†åŠåº”ç”¨ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  å¸ƒéš†è¿‡æ»¤å™¨åœ¨å¾ˆå¤šåœºæ™¯ä¸­éƒ½æœ‰åº”ç”¨ï¼Œå¦‚æ ¹æ®å‘ä»¶äººè¿‡æ»¤åƒåœ¾é‚®ä»¶ã€é¿å…å·²æµè§ˆè§†é¢‘çš„é‡å¤æ¨èã€é¿å…åˆ†å¸ƒå¼ç¼“å­˜ä¸­ä¸å­˜åœ¨keyçš„è®¿é—®ç©¿é€ï¼Œç­‰ç­‰ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å‘æŒ¥äº†éå¸¸å¤§çš„ä½œç”¨ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å…¶å®ä¹Ÿå­˜åœ¨å¾ˆå¤šçš„å˜ä½“ã€‚æœ¬æ–‡å°±æ¥ç»“åˆä½œè€…ä¸šåŠ¡ä¸­é‡åˆ°çš„é—®é¢˜ã€å¸ƒéš†è¿‡æ»¤å™¨çš„åº”ç”¨æ¥è¯¦ç»†äº†è§£ä¸‹å¸ƒéš†è¿‡æ»¤å™¨çš„åŸç†åŠåº”ç”¨ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨ # æè¿°å¸ƒéš†è¿‡æ»¤å™¨ä¹‹å‰ï¼Œé¦–å…ˆæè¿°ä¸‹èƒŒæ™¯ï¼Œç»å¸¸é‡åˆ°â€œå¿«é€ŸæŸ¥è¯¢ã€æ’å…¥â€ç­‰æ“ä½œçš„åœºæ™¯ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å¯èƒ½æ˜¯setã€mapæ•°æ®ç»“æ„ï¼Œå› ä¸ºå®ƒçš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œæ˜¯é¦–é€‰çš„æ•°æ®ç»“æ„ã€‚ä½†æ˜¯å½“è¦è®°å½•çš„æ•°æ®é‡éå¸¸å¤§æ—¶ï¼Œsetã€mapå¯èƒ½å¹¶ä¸æ˜¯ä¸€ç§åˆé€‚çš„é€‰æ‹©ã€‚\nå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªçŸ­è§†é¢‘æ¨èçš„åœºæ™¯ï¼Œç”¨æˆ·æ¯æ¬¡æ‹‰å–çŸ­è§†é¢‘åˆ—è¡¨æ—¶éƒ½åªè¿”å›ç”¨æˆ·æ²¡æœ‰çœ‹è¿‡çš„çŸ­è§†é¢‘ï¼ŒçŸ­è§†é¢‘é€šè¿‡çŸ­è§†é¢‘idï¼ˆuint32ï¼‰å”¯ä¸€æ ‡è¯†ï¼Œå‡å¦‚æˆ‘ä»¬ç”¨mapæ¥å­˜å‚¨ï¼Œä¸€ä¸ªçŸ­è§†é¢‘idå°±éœ€è¦4å­—èŠ‚ï¼Œå‡å¦‚ä¸€ä¸ªç”¨æˆ·ä¸€å¤©å¯ä»¥è§‚çœ‹50ä¸ªçŸ­è§†é¢‘ï¼Œ1ä¸ªæœˆå°±æ˜¯1500ä¸ªï¼Œ1å¹´å°±æ˜¯18000ä¸ªï¼Œè¿™æ ·ä¸€ä¸ªç”¨æˆ·1å¹´å°±éœ€è¦å ç”¨å­˜å‚¨72KBï¼Œå‡å¦‚æˆ‘ä»¬æœ‰100wç”¨æˆ·ï¼Œé‚£å°±æ˜¯72GBï¼Œè¿™äº›ä¿¡æ¯æ˜¯è¦æ”¾åœ¨å†…å­˜é‡Œé¢è¿›è¡Œè®¡ç®—çš„ï¼Œä»€ä¹ˆæ ·çš„æœºå‹æ‰å¯ä»¥æ‹¥æœ‰72GBå¤§å°çš„å†…å­˜å•Šï¼Ÿè¦å°½é‡åšåˆ°â€œä½æˆæœ¬ã€é«˜æ€§èƒ½â€çš„æ–¹æ¡ˆè®¾è®¡ï¼Œè¿™ç§é€‰å‹æ˜¯æœ‰é—®é¢˜çš„ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆbloom filterï¼‰ï¼Œå…¶å®å°±æ˜¯ä¸€ç§æŠ˜ä¸­çš„è®¾è®¡æ–¹æ¡ˆã€‚å†…å­˜æ˜¯æŒ‰å­—èŠ‚å¯»å€ï¼Œä½†æ˜¯1ä¸ªå­—èŠ‚æ˜¯8ä½ï¼Œå­˜å‚¨1ä¸ªçŸ­è§†é¢‘idï¼Œæ¯”å¦‚å€¼1ï¼Œ1bitå°±å¯ä»¥è¡¨ç¤ºçš„æƒ…å†µä¸‹å´éœ€è¦å¤šå ç”¨31ä¸ªbitï¼Œå²‚ä¸æ˜¯æå¤§çš„æµªè´¹ï¼Ÿå¸ƒéš†è¿‡æ»¤å™¨çš„åº•å±‚å­˜å‚¨å…¶å®ä¹Ÿå°±æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢ã€æ’å…¥æ“ä½œéƒ½è½¬æ¢æˆå¯¹bitçš„æŸ¥è¯¢ã€å†™å…¥æ“ä½œã€‚æ¯”å¦‚è¦å†™å…¥ä¸€ä¸ªçŸ­è§†é¢‘idï¼Œå°†é€šè¿‡å¤šè½®hash(çŸ­è§†é¢‘id)è®¡ç®—å‡ºå¤šä¸ªbit offsetï¼Œå¦‚b1~b8ï¼Œç„¶åå­˜å‚¨æ“ä½œå°±è½¬æ¢ä¸ºå°†b1~b8å…¨éƒ¨è®¾ç½®ä¸º1ï¼ŒæŸ¥è¯¢æ“ä½œå°±è½¬æ¢ä¸ºæŸ¥è¯¢b1~b8æ˜¯å¦å…¨éƒ¨ä¸º1ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨ï¼Œä»¥æ¥è¿‘O(1)çš„æ€§èƒ½è¿›è¡ŒæŸ¥è¯¢ã€æ’å…¥æ“ä½œï¼Œä½†æ˜¯ç”±äºhashç¢°æ’çš„å­˜åœ¨ï¼Œä¼šå¼•å…¥ä¸€å®šçš„è¯¯å·®ç‡ã€‚å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œæœ¬æ¥çŸ­è§†é¢‘id NNNæ²¡æœ‰å­˜å‚¨ï¼Œä½†æ˜¯å´ç”±äºå¤šè½®hash(NNN)å¾—åˆ°çš„b1~b8ä¸å…¶ä»–æŸä¸ªçŸ­è§†é¢‘id MMMè®¡ç®—å¾—åˆ°çš„b1~b8å®Œå…¨ç›¸åŒï¼Œæ›´å¯èƒ½ç”±äºä¹‹å‰å­˜å‚¨å¤šä¸ªçŸ­è§†é¢‘id Aã€Bã€Cã€Dæ—¶å°†b1~b8è®¾ç½®ä¸º1ï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´åˆ¤æ–­NNNå·²å­˜å‚¨ã€‚è¿™ç§æƒ…å†µå°±å¼•å…¥äº†â€œè¯¯å·®ç‡â€çš„æ¦‚å¿µã€‚\nè¯¯å·®ç‡ï¼š å¸ƒéš†è¿‡æ»¤å™¨ç°åœ¨è¦å­˜å‚¨Nä¸ªå…ƒç´ ï¼Œå­˜å‚¨æŒ‡å®šå…ƒç´ eæ—¶ï¼Œå…ˆè¿›è¡Œå¤šè½®hashè®¡ç®—å¾—åˆ°b1~bnï¼Œç„¶åä¾æ¬¡æ£€æŸ¥offsetä¸ºb1~bnçš„bitä½æ˜¯å¦å·²ç»è®¾ç½®ä¸º1ï¼Œå¦‚æœå…¨éƒ¨ä¸º1åˆ™è¡¨ç¤ºå¸ƒéš†è¿‡æ»¤å™¨ä¸­å·²å­˜å‚¨è¯¥å…ƒç´ ã€‚å½“ä¸å…¨ä¸º1æ—¶è®¤ä¸ºæ²¡æœ‰å­˜å‚¨è¿‡å…ƒç´ eï¼Œå°†b1~bnè®¾ç½®ä¸º1ã€‚ ç”±äºå†™å…¥æ“ä½œæ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯éµå¾ªtestã€setçš„æ–¹å¼ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬é€æ¬¡å°†Nä¸ªå…ƒç´ å†™å…¥å¸ƒéš†è¿‡æ»¤å™¨æ—¶ï¼Œå‡å¦‚testæ—¶å‘ç°å…ƒç´ å·²å­˜å‚¨ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸€å®šæ˜¯ç”±äºhashç¢°æ’å¼•èµ·ï¼Œå¼•å…¥äº†è¯¯å·®ã€‚ æ‰€ä»¥å¦‚æœè¦æ±‚å†™å…¥Nä¸ªå…ƒç´ å´åªæˆåŠŸå†™å…¥äº†Mä¸ªå…ƒç´ ï¼ˆM\u0026lt;=Nï¼‰ï¼Œè¯¯å·®ç‡=(N-M)/Nã€‚\nä¼˜ç¼ºç‚¹ï¼š ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ï¼ŒåˆèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚ ç¼ºç‚¹ï¼šå­˜åœ¨ä¸€å®šçš„è¯¯å·® \u0026amp;\u0026amp; ä¸æ”¯æŒåˆ é™¤æ“ä½œã€‚\nå¦‚æœåº”ç”¨åœºæ™¯å…è®¸ä¸€å®šçš„åˆ¤å®šè¯¯å·®ï¼Œä¾‹å¦‚çŸ­è§†é¢‘æ¨èåœºæ™¯ã€ä¿¡æ¯æµæ¨èåœºæ™¯ç­‰ï¼Œé‚£ä¹ˆå¸ƒéš†è¿‡æ»¤å™¨ä¹Ÿä¸å¤±ä¸ºä¸€ç§åˆé€‚çš„é€‰æ‹©ã€‚åˆšæ‰æåˆ°setã€mapå ç”¨å†…å­˜ç©ºé—´å¤§ï¼Œé‚£ä¹ˆå¸ƒéš†è¿‡æ»¤èƒ½å ç”¨å¤šå°‘å‘¢ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°è¯¯å·®ç‡å’Œå­˜å‚¨æˆæœ¬ä¹‹é—´çš„æƒè¡¡äº†ã€‚\nè¯¯å·®ç‡ \u0026amp; å­˜å‚¨ç©ºé—´ # è¯¯å·®ç‡ï¼Œä¸€èˆ¬æ˜¯æ ¹æ®åº”ç”¨åœºæ™¯æˆ–è€…äº§å“ä½“éªŒã€äº§å“è¡¨ç°æ¥æŒ‡å®šçš„ï¼Œå¦‚ç”¨å¸ƒéš†è¿‡æ»¤å™¨è®°å½•ç”¨æˆ·è§‚çœ‹è¿‡çš„çŸ­è§†é¢‘idè¯¯å·®ç‡ä¸è¶…è¿‡1/1000ã€‚\nå…¶å®æŒ‡å®šäº†è¯¯å·®ç‡ä¹‹åï¼Œä¸€èˆ¬ä¹Ÿå°±å¯ä»¥ç¡®å®šå­˜å‚¨1ä¸ªè¿™æ ·çš„çŸ­è§†é¢‘idæ‰€éœ€è¦çš„å¤§è‡´bitæ•°é‡äº†ï¼Œç®€ç§°bpeï¼ˆbits per elementï¼‰ï¼Œdouble bpe = - (log(error) / (ln(2)^2))ï¼Œä½†æ˜¯åˆ°åº•éœ€è¦å¤šå°‘bitæ•°é‡ï¼ˆbpeæ˜¯æµ®ç‚¹å‹ï¼‰ï¼Œè¿˜éœ€è¦è¿›ä¸€æ­¥ç¡®å®šï¼Œint hashes = (int)ceil(ln(2) * bpe)ï¼Œè¿™è¡¨åè¦è®¡ç®—å¾—åˆ°hashesä¸ªhashå€¼ï¼Œç„¶åç”¨è¿™ä¸ªå€¼å¯¹å¸ƒéš†è¿‡æ»¤å™¨å†…å­˜ç©ºé—´bitsæ•°é‡å–æ¨¡ï¼Œä»è€Œå¾—åˆ°hashesä¸ªbit offsetã€‚\ndouble denom = 0.480453013918201; // ln(2)^2 double bpe = -(log(error) / denom); int hashes = (int)ceil(0.693147180559945 * bpe); // ln(2)  å‡å¦‚å¸Œæœ›å­˜å‚¨entriesä¸ªå…ƒç´ çš„è¯ï¼Œåœ¨æ»¡è¶³ä¸Šè¿°è¯¯å·®ç‡çš„æƒ…å†µä¸‹ï¼Œå¸ƒéš†è¿‡æ»¤å™¨éœ€è¦åˆ†é…å†…å­˜ç©ºé—´ä¸ºint bits = (int)(bpe * entries)ã€‚\nint bits = (int)(bpe * entries)  murmurhashç®—æ³• # å‰é¢æè¿°äº†åœ¨é¢„æœŸè¯¯å·®ç‡çš„æƒ…å†µä¸‹ï¼Œå­˜å‚¨ä¸€ä¸ªå…ƒç´ æ‰€éœ€è¦çš„å¹³å‡å­˜å‚¨ç©ºé—´æ˜¯å¤šå°‘bpeï¼Œä»¥åŠå®é™…å­˜å‚¨æ—¶éœ€è¦è®¾ç½®çš„bitsæ•°é‡ï¼Œä¹Ÿå°±æ˜¯éœ€è¦è®¡ç®—çš„hashè½®æ•°ã€‚ç°åœ¨æè¿°ä¸‹hashç®—æ³•ï¼Œmurmurhashæ˜¯ç°åœ¨æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§hashç®—æ³•ï¼Œä¸å°‘å¼€æºçš„å¸ƒéš†è¿‡æ»¤å™¨å®ç°éƒ½æ˜¯é‡‡ç”¨äº†murmurhashç®—æ³•æ¥å®ç°ã€‚\nmurmurhashç®—æ³•çš„åå­—æ¥æºäºå®ƒçš„ä¸¤ä¸ªé‡è¦æ“ä½œMUï¼ˆmultiplyï¼‰ä»¥åŠRï¼ˆRotateï¼‰ï¼Œå®ƒåœ¨è®¾è®¡ä¸Šå¹¶ä¸æ˜¯ä¸ºäº†å¯†ç å­¦ä¸Šå¢åŠ å•å‘åŠ å¯†çš„éš¾åº¦ï¼Œæ‰€ä»¥å®ƒä¸é€‚ç”¨äºå®‰å…¨é¢†åŸŸã€‚å¦‚æœæ˜¯å‘åšä¸€ä¸ªå¿«é€Ÿçš„hashä¸”å¸Œæœ›hashç¢°æ’æ»¡è¶³é¢„è®¾æŒ‡æ ‡çš„è¯ï¼Œmurmurhashæ˜¯ä¸€ä¸ªä¸é”™çš„hashç®—æ³•ã€‚\nè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒwikipediaï¼Œç‚¹å‡»æŸ¥çœ‹ MurmurHashç®—æ³•ã€‚\nå¤šåˆ†åŒºå¸ƒéš†è¿‡æ»¤å™¨ # ä¸Šè¿°æè¿°äº†ä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨çš„å¤§è‡´åŸç†ã€å¦‚ä½•ç¡®å®šè¯¯å·®ç‡ä»¥åŠbpeå’Œhashè½®æ•°ã€ä¾èµ–çš„hashç®—æ³•ç­‰ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°æ›´å¤šçš„é—®é¢˜ã€‚\nä»ä»¥çŸ­è§†é¢‘æ¨èåœºæ™¯ä¸ºä¾‹ï¼Œå‡å®šæˆ‘ä»¬è®¾è®¡å®¹é‡æ˜¯ä¸ºæ¯ä¸ªç”¨æˆ·è®°å½•æœ€è¿‘è®¿é—®è¿‡çš„2000ä¸ªçŸ­è§†é¢‘ï¼Œå‡å®šéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯mï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¸­çš„bit=1çš„bitsè¶Šæ¥è¶Šå¤šï¼Œæˆ‘ä»¬ä¸èƒ½å°†æ‰€æœ‰çš„bitså†™çš„è¿‡å¤šï¼Œæ›´ä¸èƒ½å†™æ»¡ï¼Œä»¥ä¸ºä¼šå¯¼è‡´è¯¯å·®ç‡æ€¥å‰§å‡é«˜ï¼Œç”šè‡³è¶…è¿‡é¢„è®¾çš„è¯¯å·®ç‡ã€‚\né‚£ä¹ˆå†™å¤šå°‘bitsç®—æ˜¯åˆç†çš„å‘¢ï¼Ÿè¿™ä¸ªå¯ä»¥é€šè¿‡å®æµ‹è¿›è¡Œè®¡ç®—ï¼Œçœ‹çœ‹å†™äº†å¤šå°‘bitsåè¯¯å·®ç‡å‡é«˜åˆ°é¢„è®¾å€¼ï¼Œå½“å¸ƒéš†è¿‡æ»¤å™¨æ‰€æœ‰bitsçš„1/2éƒ½æ˜¯1æ—¶å¯ä»¥çœ‹åšæ˜¯â€œå†™æ»¡â€çš„æ ‡è¯†ã€‚è¿™ä¸ªæ—¶å€™è¯¥å¦‚ä½•æ“ä½œå‘¢ï¼Ÿ\n1ï¼‰ä¸€ç§æ–¹å¼æ˜¯æ¸…ç©ºå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆå…¨éƒ¨è®¾ä¸º0ï¼‰ï¼Œä½†æ˜¯ä¼šå¯¼è‡´ç”¨æˆ·æœ€è¿‘çœ‹è¿‡çš„çŸ­è§†é¢‘è¢«é‡å¤æ‹‰å–åˆ°ï¼Œä¼šç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒã€‚\n2ï¼‰å¦ä¸€ç§æ€è·¯æ˜¯ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å†…éƒ¨å­˜å‚¨ç”±ä¸€å—å›ºå®šå†…å­˜ä¿®æ”¹ä¸ºå¯åŠ¨æ€å¢åŠ çš„å¤šå—åˆ†åŒºï¼ˆsliceï¼‰å½¢å¼ï¼Œå½“ä¸€ä¸ªsliceå†™æ»¡ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„sliceç”¨æ¥æ‰§è¡Œå†™å…¥æ“ä½œï¼ŒæŸ¥è¯¢æ“ä½œåœ¨æ–°ã€æ—§sliceåŒæ—¶æŸ¥è¯¢ï¼Œä»»ä¸€ä¸ªsliceå‘½ä¸­åˆ™è®¤ä¸ºå‘½ä¸­ã€‚ç­‰æ–°çš„sliceä¹Ÿå†™æ»¡æ—¶æ¸…ç©ºæ—§çš„ï¼Œç»§ç»­ç”¨æ¥å†™å…¥ï¼Œä¹Ÿå¯ä»¥ç»§ç»­åˆ›å»ºæ–°çš„sliceã€‚è¿™ç§å¸¦æ¥äº†æŸ¥è¯¢æ“ä½œè€—æ—¶ç¨å¾®å¢åŠ ï¼Œå­˜å‚¨å ç”¨æœ‰æ‰€å¢åŠ ï¼Œä½†æ˜¯å¯ä»¥é¿å…å¯¹ç”¨æˆ·ä½“éªŒé€ æˆå½±å“ï¼Œå¯¹äºæ¨èè¿™ç§è¦æ±‚ä¿è¯ç”¨æˆ·ä½“éªŒçš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯ä¿è¯ä¸é‡å¤è§‚çœ‹åŒä¸€ä¸ªå†…å®¹ï¼Œè¿™ç§æ€è·¯ä¹Ÿæ˜¯å¯å–çš„ã€‚\n3ï¼‰è¿˜éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œäº§å“ç­–ç•¥æ˜¯éšæ—¶ä¼šè¿›è¡Œè°ƒæ•´çš„ï¼Œå½“äº§å“å¸Œæœ›è¿›ä¸€æ­¥é™ä½è¯¯å·®ç‡æ—¶ï¼Œè¯¥å¦‚ä½•æ“ä½œå‘¢ï¼Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹æ¥é€‚é…é”™è¯¯ç‡è°ƒæ•´ï¼Œå¹¶å¢åŠ ä¸€ä¸ªè¿‡æ¸¡æœŸï¼Œåœ¨è¿™ä¸ªè¿‡æ¸¡æœŸå†…ï¼Œæ–°æ—§ä¸¤ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ä¾‹åŒæ—¶æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ–°å¸ƒéš†è¿‡æ»¤å™¨è´Ÿè´£å†™å…¥ï¼Œç­‰è¿‡æ¸¡æœŸç»“æŸä¹‹åï¼ŒåºŸå¼ƒæ—§çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ–°çš„å¸ƒéš†è¿‡æ»¤å™¨å•ç‹¬å·¥ä½œã€‚è¿™æ ·å¯ä»¥åŠ¨æ€æ”¯æŒäº§å“ç­–ç•¥è°ƒæ•´ï¼Œä¸è¶³æ˜¯è¯¯å·®ç‡åœ¨è¿‡æ¸¡æœŸå†…å¯èƒ½ä¼šå‘ç”ŸçŸ­æš‚æ³¢åŠ¨ã€‚\nåœ¨ä¸Šè¿°2ï¼‰3ï¼‰æ€è·¯çš„åŸºç¡€ä¸Šï¼Œåœ¨é¡¹ç›®å¼€å‘ä¸­æˆ‘è®¾è®¡å¼€å‘äº†ä¸€ä¸ªbloomå®ä¾‹æ”¯æŒå¤šåˆ†åŒºçš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¹¶æä¾›äº†åºåˆ—åŒ–ã€ååºåˆ—åŒ–èƒ½åŠ›ï¼Œæ˜¯å¯¹æ™®é€šå¸ƒéš†è¿‡æ»¤å™¨çš„ä¸€ç§æ”¹è¿›å‹è®¾è®¡ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒï¼Œç‚¹å‡»æŸ¥çœ‹ ä¸€ç§æ”¹è¿›çš„å¸ƒéš†è¿‡æ»¤å™¨å®ç°ã€‚\nè®¡æ•°å¸ƒéš†è¿‡æ»¤å™¨ # ä¸Šè¿°æ‰€æè¿°çš„å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸æ”¯æŒåˆ é™¤æ“ä½œçš„ï¼Œä½†æ˜¯æŸäº›æƒ…å¢ƒä¸‹æˆ‘ä»¬æ˜¯æœ‰åˆ é™¤éœ€æ±‚çš„ï¼ˆè¿™é‡Œæˆ‘ä»¬å°±ä¸ä¸¾ä¾‹äº†ï¼‰ï¼Œå¦‚æœè¦å¢åŠ åˆ é™¤çš„èƒ½åŠ›ï¼Œè¿˜éœ€è¦é¢å¤–å¢åŠ ä¸€äº›overheadã€‚\nè€ƒè™‘ä¸€ä¸‹ï¼Œæ ‡å‡†çš„å¸ƒéš†è¿‡æ»¤å™¨ä¸èƒ½æ”¯æŒåˆ é™¤æ“ä½œçš„åŸå› ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯å› ä¸ºè¦clearçš„bitså¯èƒ½åŒæ—¶è¢«å¤šä¸ªå…ƒç´ æ‰€ä½¿ç”¨äº†ï¼Œç›´æ¥clear bitså°†å½±å“åˆ°å¯¹å…¶ä»–å·²å­˜å‚¨å…ƒç´ çš„åˆ¤æ–­é€»è¾‘ã€‚é‚£ä¹ˆåˆæƒ³åˆ é™¤å½“å‰å…ƒç´ ï¼Œåˆä¸å½±å“åˆ°å…±ç”¨è¯¥bitsçš„å…¶ä»–å…ƒç´ ï¼Œæ€ä¹ˆåŠï¼Ÿ\nåˆ¤æ–­å†…å­˜å¯¹è±¡æ˜¯å¦è¢«ä½¿ç”¨ç»å¸¸é€šè¿‡å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥è§£å†³ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¹Ÿå¯ä»¥å€ŸåŠ©å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥æ ‡å¿—æŸä¸ªbitsæ˜¯å¦æ˜¯å¦è¢«ä½¿ç”¨ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸ªbitä½é¢å¤–ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°å€¼ï¼Œå½“è¯¥bitè¢«setä¸º1æ—¶ï¼Œå¼•ç”¨è®¡æ•°+1ï¼Œå½“è¯¥bitè¢«clearä¸º0æ—¶ï¼Œå¼•ç”¨è®¡æ•°-1ã€‚è¿™æ ·å°±è§£å†³äº†ç›´æ¥clearè¯¥bitæ‰€å¸¦æ¥çš„é—®é¢˜ã€‚\næœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ç‚¹ï¼Œè¦å›å¿†ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ•°æ®ç»“æ„é€‰å‹ä¸é€‰ç”¨setã€mapæ˜¯ä¸ºäº†èŠ‚çœå†…å­˜å­˜å‚¨ç©ºé—´ï¼Œç°åœ¨æˆ‘ä»¬å´ä¸ºæ¯ä¸€ä¸ªbitæ¥é¢å¤–åˆ†é…äº†ä¸€ä¸ªå¼•ç”¨è®¡æ•°å€¼ï¼Œè¿™é‡Œçš„å€¼åˆè¦å ç”¨ä¸€å®šçš„å­˜å‚¨ç©ºé—´ã€‚è¿™ä¸æ˜¯åˆç»•å›ä»¥å‰äº†å—ï¼Ÿ\nè¿™é‡Œå°±è¦è€ƒè™‘ä¸‹å¼•ç”¨è®¡æ•°å€¼å ç”¨bitsæ•°é‡çš„é—®é¢˜äº†ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥å¼•å‡ºå¦ä¸€ç§å¸ƒéš†è¿‡æ»¤å™¨å˜ä½“äº†ï¼ŒCounting Bloom Filterï¼Œç®€ç§°CBFã€‚CBFå°†æ ‡å‡†çš„å¸ƒéš†è¿‡æ»¤å™¨ä½æ•°ç»„çš„æ¯ä¸€ä½æ‰©å±•ä¸ºä¸€ä¸ªå°çš„è®¡æ•°å™¨ï¼ˆCounterï¼‰ï¼Œåœ¨æ’å…¥å…ƒç´ æ—¶ç»™å¯¹åº”çš„kï¼ˆkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼‰ä¸ªCounterçš„å€¼åˆ†åˆ«åŠ 1ï¼Œåˆ é™¤å…ƒç´ æ—¶ç»™å¯¹åº”çš„kä¸ªCounterçš„å€¼åˆ†åˆ«å‡1ã€‚Counting Bloom Filteré€šè¿‡å¤šå ç”¨å‡ å€çš„å­˜å‚¨ç©ºé—´çš„ä»£ä»·ï¼Œç»™Bloom Filterå¢åŠ äº†åˆ é™¤æ“ä½œã€‚ä¸‹ä¸€ä¸ªé—®é¢˜è‡ªç„¶å°±æ˜¯ï¼Œåˆ°åº•è¦å¤šå ç”¨å‡ å€å‘¢ï¼Ÿ\næˆ‘ä»¬å…ˆè®¡ç®—ç¬¬iä¸ªCounterè¢«å¢åŠ jæ¬¡çš„æ¦‚ç‡ï¼Œå…¶ä¸­nä¸ºé›†åˆå…ƒç´ ä¸ªæ•°ï¼Œkä¸ºå“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼Œmä¸ºCounterä¸ªæ•°ï¼ˆå¯¹åº”ç€åŸæ¥ä½æ•°ç»„çš„å¤§å°ï¼‰ï¼š\nä¸Šé¢ç­‰å¼å³ç«¯çš„è¡¨è¾¾å¼ä¸­ï¼Œå‰ä¸€éƒ¨åˆ†è¡¨ç¤ºä»nkæ¬¡å“ˆå¸Œä¸­é€‰æ‹©jæ¬¡ï¼Œä¸­é—´éƒ¨åˆ†è¡¨ç¤ºjæ¬¡å“ˆå¸Œéƒ½é€‰ä¸­äº†ç¬¬iä¸ªCounterï¼Œåä¸€éƒ¨åˆ†è¡¨ç¤ºå…¶å®ƒnk â€“ jæ¬¡å“ˆå¸Œéƒ½æ²¡æœ‰é€‰ä¸­ç¬¬iä¸ªCounterã€‚å› æ­¤ï¼Œç¬¬iä¸ªCounterçš„å€¼å¤§äºjçš„æ¦‚ç‡å¯ä»¥é™å®šä¸ºï¼š\nä¸Šå¼ç¬¬äºŒæ­¥ç¼©æ”¾ä¸­åº”ç”¨äº†ä¼°è®¡é˜¶ä¹˜çš„æ–¯ç‰¹æ—å…¬å¼ï¼š\nåœ¨Bloom Filteræ¦‚å¿µå’ŒåŸç†ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æåˆ°è¿‡kçš„æœ€ä¼˜å€¼ä¸º(ln2)m/nï¼Œç°åœ¨æˆ‘ä»¬é™åˆ¶k â‰¤ (ln2)m/nï¼Œå°±å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®ºï¼š\nå¦‚æœæ¯ä¸ªCounteråˆ†é…4ä½ï¼Œé‚£ä¹ˆå½“Counterçš„å€¼è¾¾åˆ°16æ—¶å°±ä¼šæº¢å‡ºã€‚è¿™ä¸ªæ¦‚ç‡ä¸ºï¼š\nè¿™ä¸ªå€¼è¶³å¤Ÿå°ï¼Œå› æ­¤å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œ4ä½å°±è¶³å¤Ÿäº†ã€‚\nå…¶ä»–å¸ƒéš†è¿‡æ»¤å™¨å˜ä½“ # ç”±äºç°å®åº”ç”¨åœºæ™¯å¤šæ ·ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å˜ä½“ä¹Ÿéå¸¸å¤šã€‚ç»´åŸºç™¾ç§‘ä¸­åˆ—å‡ºäº†å¾ˆå¤šå¸ƒéš†è¿‡æ»¤å™¨å˜ä½“ï¼Œä¾‹å¦‚ï¼š\n Cache Filtering Avoiding False Positives in a Finite Universe Counting filters Decentralized aggregation Data synchronization Bloomier filters Compact approximators Stable Bloom filters Scalable Bloom filters Spatial Bloom filters Layered Bloom filters Attenuated Bloom filters Chemical structure searching  æ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒç»´åŸºç™¾ç§‘ä¸­çš„ç›¸å…³æè¿°ï¼Œè¿™é‡ŒæƒåšæŠ›ç –å¼•ç‰äº†ï¼Œç‚¹å‡»æŸ¥çœ‹ å¸ƒéš†è¿‡æ»¤å™¨ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨è®¾è®¡å®ç° # ä½œè€…åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œå†™è¿‡ä¸€ä¸ªC++ç‰ˆæœ¬çš„åˆ†æ®µå¼çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ”¯æŒæŒ‡å®šè¯¯å·®ç‡æ¥æ¨ç®—å®¹é‡ï¼Œå¹¶èƒ½æ”¯æŒåæœŸçš„æ‰©å®¹éœ€æ±‚ï¼Œæ„Ÿå…´è¶£è¯·ç‚¹å‡»hitzhangjie/bloomfilterã€‚\n"}),a.add({id:344,href:"/tags/comment/",title:"comment",description:"",content:""}),a.add({id:345,href:"/tags/godoc/",title:"godoc",description:"",content:""}),a.add({id:346,href:"/blog/2018-06-29-godoc%E6%96%87%E6%A1%A3/",title:"godocæ–‡æ¡£",description:"äº†è§£godocæ–‡æ¡£çš„ä½œç”¨ï¼Œä»¥åŠå¦‚ä½•ä¸ºä½ çš„é¡¹ç›®ç”Ÿæˆgodocæ–‡æ¡£ï¼Œåº”è¯¥å¦‚ä½•ç¼–å†™godocæ³¨é‡Šã€‚",content:"godocæ–‡æ¡£ # æ ‡å‡†åº“æ–‡æ¡£ # å½“è¦æŸ¥çœ‹goæ ‡å‡†åº“æ–‡æ¡£æ—¶ï¼Œå¯å€ŸåŠ©godocå‘½ä»¤è¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚godoc container/listï¼Œä¹Ÿå¯ä»¥åœ¨æœ¬åœ°å¼€å¯ä¸€ä¸ªwebæœåŠ¡æ¥æŸ¥è¯¢ï¼Œå¦‚godoc -http=:6060ã€‚\néæ ‡æ³¨åº“æ–‡æ¡£ # å½“è¦æŸ¥çœ‹éæ ‡å‡†åº“ï¼ˆå¦‚è‡ªå»ºé¡¹ç›®ï¼‰çš„æ–‡æ¡£æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å€ŸåŠ©godocæ¥æŸ¥çœ‹ï¼Œä½†æ˜¯æ‰§è¡Œgodocå‘½ä»¤ä¹‹å‰éœ€è¦åšäº›å‡†å¤‡å·¥ä½œã€‚\nå¸Œæœ›åœ¨æ–‡æ¡£ä¸­çœ‹åˆ°ä»€ä¹ˆä¿¡æ¯ #  packageä»‹ç» typeä»‹ç» funcä»‹ç» ç¤ºä¾‹ä»£ç  é’ˆå¯¹packageçš„ç¤ºä¾‹ä»£ç  é’ˆå¯¹typeçš„ç¤ºä¾‹ä»£ç   ä¸Šè¿°å‡ ç§å¸Œæœ›çœ‹åˆ°çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åœ¨ä»£ç ä¸­æŒ‰ç…§godocçº¦å®šçš„æ–¹å¼æä¾›ä¸Šè¿°ä¿¡æ¯ï¼Œgodocæ‰èƒ½æ‰¾åˆ°è¿™äº›ä¿¡æ¯å±•ç¤ºå‡ºæ¥ã€‚ä¸‹é¢å°±åˆ†åˆ«æè¿°ä¸‹å¦‚ä½•åœ¨ä»£ç ä¸­åŒ…å«ä¸Šè¿°ä¿¡æ¯ã€‚\npackage \u0026amp; type \u0026amp; func ä»‹ç» # è¿™é‡Œå¯¹packageã€typeã€funcçš„ä»‹ç»æ˜¯ä»¥leading commentsçš„æ–¹å¼åœ¨ä»£ç ä¸­ç›´æ¥æä¾›çš„ï¼Œå°±æ˜¯packageå£°æ˜ã€typeå£°æ˜ã€funcå£°æ˜å‰é¢ç´§é‚»çš„æ³¨é‡Šï¼Œè¯¥æ³¨é‡Šä¸å£°æ˜ä¹‹é—´æ²¡æœ‰ç©ºè¡Œåˆ†éš”ã€‚\nä»¥å¦‚ä¸‹æ–‡ä»¶$GOPATH/src/kisslulu/conf/conf.goä¸ºä¾‹ï¼š\n// Package conf provides support for loading json, ini, properties configuration. package conf // JsonCfg type JsonCfg struct { } // IniCfg type IniCfg struct { } // PropCfg type PropCfg struct { } // Load json config from filepath func LoadJsonCfg(filepath string) (*JsonCfg, error) { } // Load Ini config from filePath func LoadIniCfg(filepath string) (*IniCfg, error) { } // Load PropCfg from filepath func LoadPropCfg(filepath string) (*PropCfg, error) { }  è¿è¡Œgodoc -http=:6060æ‰¾åˆ°å¯¹åº”çš„package kisslulu/confå³å¯é¢„è§ˆæ–‡æ¡£ä¸­å¯¹packageã€typeã€funcçš„ä»‹ç»ã€‚\npackage \u0026amp; type ç¤ºä¾‹ä»£ç  # godocä¸­çš„ç¤ºä¾‹ä»£ç æ˜¯å­˜æ”¾åœ¨ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶â€œexample_test.goâ€ä¸­çš„ï¼Œè¿™ä¸ªæ–‡ä»¶åæ˜¯å›ºå®šçš„ã€‚ä»¥ä¸Šæ–‡ä¸­è¿™ä¸ªconf packageä¸ºä¾‹ï¼Œä¸ºå…¶ç¼–å†™ç›¸åº”çš„packageç¤ºä¾‹ä»£ç å’Œtypeç¤ºä¾‹ä»£ç ã€‚\nexample_test.go # è¿™ä¸ªç¤ºä¾‹ä»£ç æ–‡ä»¶çš„åŒ…åå®šä¹‰ä¸ºpackage conf_testæˆ–è€…package conféƒ½å¯ä»¥ï¼Œå…¶ä»–åŒ…çš„è¯go installä¼šæç¤ºerror: can't load package...ï¼Œgodocè¿è¡Œæ—¶ä¼šå¯¹example_test.goä¸­çš„ç¤ºä¾‹ä»£ç è¿›è¡ŒåŠ è½½å¹¶æ¸²æŸ“ã€‚\npackageç¤ºä¾‹ä»£ç  # packageç¤ºä¾‹ä»£ç æ˜¯ç¼–å†™åœ¨åœ¨func example() {...}å‡½æ•°é‡Œé¢ï¼Œåªèƒ½åŒ…å«ä¸€ä¸ªpackageç¤ºä¾‹ä»£ç ï¼Œé€šå¸¸åœ¨packageç¤ºä¾‹ä»£ç é‡Œé¢è¯¦ç»†æè¿°è¯¥packageçš„ä½¿ç”¨æ–¹æ³•ï¼Œæ¯”å¦‚å®Œæ•´package confè§£æjsonã€iniã€propé…ç½®æ–‡ä»¶çš„æ–¹æ³•ã€‚\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š\npackage conf_test import \u0026quot;fmt\u0026quot; func example() { fmt.Println(\u0026quot;hello world\u0026quot;) // how to load json cfg fp1 := \u0026quot;path1\u0026quot; cfg1, _ := LoadJsonCfg(fp1) // how to load ini cfg fp2 := \u0026quot;path2\u0026quot; cfg2,_ := LoadIniCfg(fp2) // how to load prop cfg fp3 := \u0026quot;path3\u0026quot; cfg3,_ := LoadPropCfg(fp3) fmt.Println(\u0026quot;cfg1:\u0026quot;, cfg1) fmt.Println(\u0026quot;cfg2:\u0026quot;, cfg2) fmt.Println(\u0026quot;cfg3:\u0026quot;, cfg3) // Output: {\u0026quot;port\u0026quot;:8000,\u0026quot;timeout\u0026quot;:2000} // Output: \u0026quot;ilive-service.port\u0026quot;:8000, \u0026quot;ilive-service.timeout\u0026quot;:2000 // Output: port=8000, timeout=2000 }  typeç¤ºä¾‹ä»£ç  # æ¯ä¸­ç±»å‹ä¸‹å¾€å¾€å®šä¹‰äº†å¤šä¸ªæ–¹æ³•ï¼Œå¯èƒ½æœ‰éœ€è¦å¯¹å¤šä¸ªæ–¹æ³•æä¾›ç¤ºä¾‹ä»£ç ï¼Œæ‰€ä»¥å¯ä»¥godocçº¦å®šå…è®¸é€šè¿‡å‡½æ•°â€œfunc Example${type}_${testcase} {\u0026hellip;}â€æä¾›å¤šä¸ªç¤ºä¾‹ä»£ç ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯${testcase}å¿…é¡»é¦–å­—æ¯å°å†™ï¼Œå¦åˆ™godocä¼šå¿½ç•¥ã€‚\nä»¥type JsonCfgä¸ºä¾‹ï¼š\npackage conf_test import \u0026quot;fmt\u0026quot; func example() { // ... } func ExampleJsonCfg_testcase1 () { // here is the testcase 1 } func ExampleJsonCfg_testcase2 () { // here is the testcase 2 }  çœ‹ä¸‹æ–‡æ¡£æ•ˆæœ # è¿è¡Œgodoc -http=:6060ï¼Œç„¶åæµè§ˆå™¨ä¸­æ‰“å¼€localhost:6060ï¼Œå®šä½åˆ°package kisslulu/confå³å¯æŸ¥çœ‹æ–‡æ¡£æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ "}),a.add({id:347,href:"/blog/2018-05-21-golang-method-receiver-type%E7%9A%84%E6%A2%97/",title:"golang method receiver-typeçš„æ¢—",description:"golangä¸­æ–¹æ³•ä¸ºä»€ä¹ˆreceiver-typeä¸èƒ½ä¸ºæŒ‡é’ˆç±»å‹ã€æ¥å£ç±»å‹",content:"è¿™é‡Œæ¥èŠèŠmethod receiver typeä¸ºä»€ä¹ˆä¸èƒ½æ˜¯pointerå’Œinterfaceç±»å‹ã€‚\n1 receiver-typeå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ # golangé‡Œé¢æä¾›äº†ä¸€å®šçš„é¢å‘å¯¹è±¡æ”¯æŒï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä¸ºç±»å‹Tæˆ–è€…*Tå®šä¹‰æˆå‘˜æ–¹æ³•ï¼ˆç±»å‹Tç§°ä¸ºæˆå‘˜æ–¹æ³•çš„receiver-typeï¼‰ï¼Œä½†æ˜¯è¿™é‡Œçš„ç±»å‹Tå¿…é¡»æ»¡è¶³å¦‚ä¸‹å‡ ä¸ªæ¡ä»¶ï¼š\n Tå¿…é¡»æ˜¯å·²ç»å®šä¹‰è¿‡çš„ç±»å‹ï¼› Tä¸å½“å‰æ–¹æ³•å®šä¹‰å¿…é¡»åœ¨åŒä¸€ä¸ªpackageä¸‹é¢ï¼› Tä¸èƒ½æ˜¯æŒ‡é’ˆï¼› Tä¸èƒ½æ˜¯æ¥å£ç±»å‹ï¼›  å‰é¢ä¸¤ç‚¹éƒ½æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¸‹é¢ä¸¤ç‚¹æ˜¯ä»€ä¹ˆæ¢—ï¼Ÿä¸ºä»€ä¹ˆå°±ä¸èƒ½åœ¨æŒ‡é’ˆç±»å‹ä¸Šæ·»åŠ æ–¹æ³•ï¼Ÿä¸ºä»€ä¹ˆå°±ä¸èƒ½åœ¨interfaceä¸Šæ·»åŠ æ–¹æ³•ï¼Ÿå½“ç„¶å¯ä»¥ä¸€å¥è¯å¾…è¿‡ï¼Œgolangä¸æ”¯æŒï¼Œä½†æ˜¯æˆ‘æƒ³é—®ä¸‹ä¸ºä»€ä¹ˆï¼Ÿ\n2 receiver-typeä¸ºä»€ä¹ˆä¸èƒ½æ˜¯æŒ‡é’ˆç±»å‹ï¼Ÿ # golangå…è®¸ä¸º ç±»å‹æŒ‡é’ˆ*T æ·»åŠ æ–¹æ³•ï¼Œä½†æ˜¯ä¸å…è®¸ä¸º æŒ‡é’ˆç±»å‹æœ¬èº« æ·»åŠ æ–¹æ³•ã€‚æŒ‰ç°æœ‰golangçš„å®ç°æ–¹å¼ï¼Œä¸ºæŒ‡é’ˆç±»å‹æ·»åŠ æ–¹æ³•ä¼šå¯¼è‡´æ–¹æ³•è°ƒç”¨æ—¶çš„æ­§ä¹‰ã€‚\nçœ‹ä¸‹é¢è¿™ä¸ªç¤ºä¾‹ç¨‹åºã€‚\ntype T int func (t *T) Get() T { return *t + 1 } type P *T func (p P) Get() T { return *p + 2 } func F() { var v1 T var v2 = \u0026amp;v1 var v3 P = \u0026amp;v1 fmt.Println(v1.Get(), v2.Get(), v3.Get()) }  ç¤ºä¾‹ç¨‹åºä¸­ v3.Get() å­˜åœ¨è°ƒç”¨æ­§ä¹‰ï¼Œç¼–è¯‘å™¨ä¸çŸ¥é“è¯¥è°ƒç”¨å“ªä¸ªæ–¹æ³•äº†ã€‚å¦‚æœè¦æ”¯æŒåœ¨æŒ‡é’ˆè¿™ç§receiver-typeä¸Šå®šä¹‰æ–¹æ³•ï¼Œgolangç¼–è¯‘å™¨åŠ¿å¿…è¦å®ç°åœ°æ›´å¤æ‚æ‰èƒ½æ”¯æŒåˆ°ï¼ŒæŒ‡é’ˆæœ¬æ¥å°±æ¯”è¾ƒå®¹æ˜“ç ´åå¯è¯»æ€§ï¼Œè¿˜è¦åœ¨ä¸€ç§æŒ‡é’ˆç±»å‹ä¸Šå®šä¹‰æ–¹æ³•ï¼Œå¯¹ä½¿ç”¨è€…ã€ç¼–è¯‘å™¨å¼€å‘è€…è€Œè¨€å¯èƒ½éƒ½æ˜¯ä»¶è´¹åŠ›ä¸è®¨å¥½çš„äº‹æƒ…ã€‚\n3 receiver-typeä¸ºä»€ä¹ˆä¸èƒ½æ˜¯æ¥å£ç±»å‹ï¼Ÿ # è¿™æ²¡æœ‰ä»€ä¹ˆå¥½æ£æµ‹çš„ï¼Œåªæ˜¯golang runtimeä¸æ”¯æŒè€Œå·²ã€‚golangç°åœ¨çš„å®ç°é‡Œï¼Œinterfaceå†…éƒ¨ç»“æ„åªèƒ½è¡¨ç¤ºæ–¹æ³•åŸå‹ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬æ–¹æ³•å®šä¹‰ï¼Œstructæ‰å¯ä»¥åŒ…æ‹¬æ–¹æ³•å®šä¹‰ï¼ˆè¿™éƒ¨åˆ†å†…å®¹æ„Ÿå…´è¶£çš„å¯ä»¥ç¿»ä¸‹golangçš„æºç ï¼Œè¿™é‡Œä¸å±•å¼€äº†ï¼‰ã€‚\nå½“ä¸€ä¸ªç±»å‹å®ç°äº†æŸä¸ªæ¥å£å£°æ˜çš„å…¨éƒ¨æ–¹æ³•æ—¶ï¼Œå°±è¯´è¿™ä¸ªç±»å‹å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå°±å¯ä»¥å°†è¿™ä¸ªç±»å‹çš„å€¼èµ‹å€¼ç»™è¯¥æ¥å£ç±»å‹çš„å€¼ï¼Œæ­¤æ—¶ä¼šæ›´æ–°æ¥å£å€¼çš„ dynamic valueå’Œdynamic type å­—æ®µã€‚è¿™é‡Œéœ€è¦ æ ¹æ®æ¥å£ä¸­æ˜¯å¦å®šä¹‰äº†æ–¹æ³•åˆ—è¡¨ æ¥è¿›ä¸€æ­¥åˆ†æï¼Œå¯ä»¥ç»†åˆ†ä¸º æ¥å£æ–¹æ³•åˆ—è¡¨ä¸ºç©º å’Œ æ¥å£æ–¹æ³•åˆ—è¡¨ä¸ç©º ä¸¤ç§æƒ…å†µè®¨è®ºã€‚\nä¸‹é¢ä»¥è¿™é‡Œçš„ç¤ºä¾‹ä»£ç ä¸ºä¾‹è¿›è¡Œåˆ†æï¼š\n// - æ¥å£ç±»å‹1 type EmptyIface interface{ } // - æ¥å£ç±»å‹2 type Stringer interface { String() string } // - ç±»å‹Binaryå®ç°äº†æ¥å£Stringerï¼Œä¹Ÿå®ç°äº†EmptyIface type Binary uint64 func (i Binary) String() string { return strconv.Uitob64(i.Get(), 2) } func (i Binary) Get() uint64 { return uint64(i) } // - ä¸ºæ¥å£å€¼èµ‹å€¼ var b Binary = Binary(1) var eface EmptyIface = b var iface Stringer = b fmt.Println(iface)  3.1 ç©ºæ¥å£interface # efaceå¯¹åº”æ¥å£ç±»å‹æ˜¯interface{}ï¼Œå¹¶ä¸”Binaryå€¼bå°äºç­‰äºsizeof(uintptr)ï¼Œé‚£ä¹ˆefaceçš„dynamic valueå°±æ˜¯ç›´æ¥æ‹·è´bï¼›å¦‚æœè¿™é‡Œæ˜¯eface := anyBigStruct {\u0026hellip;.}ï¼Œå¹¶ä¸”anyBigStruct sizeå¤§äºsizeof(uintptr)ï¼Œé‚£ä¹ˆå°±éœ€è¦å¼€è¾Ÿå†…å­˜æ‹·è´anyBigStructçš„å€¼ï¼Œå¹¶å°†æ–°å¼€è¾Ÿå†…å­˜çš„åœ°å€è®¾ç½®åˆ°dynamic valueå­—æ®µã€‚dynamic typeå°±æŒ‡å‘å¯¹åº”ç±»å‹çš„å®šä¹‰äº†ã€‚\næ­¤æ—¶çš„æ¥å£ç±»å‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š\ntype eface struct { _type *_type data unsafe.Pointer }  æ­¤æ—¶çš„æ¥å£å€¼å¯ä»¥è¡¨ç¤ºä¸ºï¼š 3.2 éç©ºæ¥å£interface{ method-list } # å¦‚æœifaceå¯¹åº”æ¥å£ç±»å‹interface{methods-list}ï¼Œè¿™ä¸ªæ—¶å€™dynamic valueè¿˜æ˜¯ä¸1ï¼‰ä¸­åŒæ ·çš„å¤„ç†ï¼Œä½†æ˜¯dynamic typeå¤„ç†æ–¹å¼ä¸åŒï¼Œéœ€è¦å¯¹è¿è¡Œæ—¶æ¥å£æ–¹æ³•çš„è°ƒç”¨åœ°å€è¿›è¡Œå¤„ç†ã€‚\nè¿™æ—¶ä¼šåˆ›å»ºä¸€ä¸ª itableï¼ˆç±»ä¼¼c++è™šå‡½æ•°vtableï¼‰ï¼Œè¿™ä¸ªitableé‡Œé¢ä¿å­˜äº†ifaceçš„æ¥å£ç±»å‹ä»¥åŠæ¥å£ä¸­å£°æ˜çš„å„ä¸ªæ–¹æ³•åŸå‹å¯¹åº”çš„è°ƒç”¨åœ°å€ï¼Œè°ƒç”¨åœ°å€ä»ä½•è€Œæ¥ï¼Ÿè¿™é‡Œçš„è°ƒç”¨åœ°å€ä¹Ÿå°±æ˜¯æ¥å£å€¼åŠ¨æ€ç±»å‹ä¸­å®ç°çš„æ–¹æ³•çš„è°ƒç”¨åœ°å€ã€‚è®¾ç½®å®Œæ¥å£æ–¹æ³•çš„æ‰€æœ‰è°ƒç”¨åœ°å€åï¼Œitableæ„å»ºå®Œæˆï¼Œç„¶åå°†ifaceæ¥å£å€¼é‡Œé¢çš„tabå­—æ®µæŒ‡å‘è¯¥itableã€‚\næ­¤æ—¶çš„æ¥å£ç±»å‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š\ntype iface struct { tab *itab data unsafe.Pointer }  æ­¤æ—¶çš„æ¥å£å€¼å¯ä»¥è¡¨ç¤ºä¸ºï¼š 3.3 æ¥å£æ–¹æ³•è°ƒç”¨ # é€šè¿‡æ¥å£å€¼è°ƒç”¨æ–¹æ³•çš„æ—¶å€™ï¼Œéœ€è¦æ ¹æ® â€œè¯¥æ¥å£å€¼ç±»å‹ã€æ¥å£å€¼å¯¹åº”çš„åŠ¨æ€ç±»å‹â€ æŸ¥è¯¢å¯¹åº”çš„æ¥å£æ–¹æ³•å®é™…çš„è°ƒç”¨åœ°å€ã€‚å¦‚æœè¯¥æ¥å£ç±»å‹é‡Œé¢æ ¹æœ¬å°±æ²¡æœ‰æ–¹æ³•åˆ—è¡¨ï¼Œé‚£è‚¯å®šå°±æŠ¥é”™äº†ä¹Ÿä¸ä¼šæŸ¥è¯¢tabï¼Œefaceé‡Œé¢ä¹Ÿæ²¡è¿™ä¸ªå­—æ®µï¼›å¦‚æœæ¥å£ç±»å‹é‡Œé¢æœ‰è¿™ä¸ªæ–¹æ³•å®šä¹‰ï¼Œé‚£å°±æ ¹æ®iface.tabæŒ‡å‘çš„itableå»æŸ¥è¯¢å¯¹åº”è¯¥æ¥å£ç±»å‹ã€åŠ¨æ€ç±»å‹çš„å¯¹åº”æ–¹æ³•çš„è°ƒç”¨åœ°å€ï¼Œç„¶åæ‰§è¡Œç›®æ ‡åœ°å€å¤„çš„æ–¹æ³•ä½“ã€‚\nä»å°†Binaryå€¼bèµ‹å€¼ç»™ifaceï¼Œå†åˆ°é€šè¿‡ifaceæŸ¥è¯¢åŠ¨æ€ç±»å‹Binaryä¸­å®ç°çš„æ–¹æ³•Stringerè°ƒç”¨åœ°å€ï¼Œæœ€ç»ˆæ‰§è¡ŒBinaryä¸­å®ç°çš„æ–¹æ³•String()ï¼Œè¿™æ•´ä¸ªé€»è¾‘å¤„ç†è¿‡ç¨‹ä¸­å¦‚ä½•å¯¹æ¥å£ç±»å‹å£°æ˜æ–¹æ³•åˆ—è¡¨ã€åŠ¨æ€ç±»å‹å®ç°æ–¹æ³•åˆ—è¡¨è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬åº”è¯¥æ¸…æ¥šäº†ã€‚\næ€»è€Œè¨€ä¹‹ï¼Œç°åœ¨golangå®ç°ä¸­interfaceçš„å†…éƒ¨è¡¨ç¤ºä¸åŒ…å«â€œæ–¹æ³•å®šä¹‰â€ç›¸å…³çš„å­—æ®µï¼Œæ— æ³•è¡¨ç¤ºä¸ºinterfaceæ·»åŠ çš„æ–¹æ³•å®šä¹‰ï¼Œç¼–è¯‘å™¨å½“ç„¶ä¹Ÿä¸å…è®¸ã€‚\nä¸åŒçš„ç¼–ç¨‹è¯­è¨€å¯¹å‡½æ•°è°ƒç”¨çš„å¤šæ€å®ç°æœ‰ä¸åŒçš„æ€è·¯ï¼Œc++æ˜¯é€šè¿‡å¡«å……åŸºæœ¬ç±»å‹çš„è™šå‡½æ•°è¡¨çš„æ–¹å¼ï¼Œgolangæ˜¯é€šè¿‡ç±»ä¼¼çš„è¿™æ ·ä¸€ç§æŸ¥è¯¢è¡¨çš„å½¢å¼ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯å¹¶égolangæ— æ³•é€šè¿‡æ‰©å±•æ”¯æŒåœ¨æ¥å£ä¸Šæ·»åŠ æ–¹æ³•ï¼Œåªæ˜¯è¿™æ ·æ˜¯å¦çœŸçš„æœ‰å¿…è¦ï¼Œå€¼å¾—å•†æ¦·ã€‚è‡³å°‘éç©ºæ¥å£æ˜¯ç”¨æ¥å®šä¹‰ä¸€ç§æ˜ç¡®çš„è¡Œä¸ºï¼ˆcontractï¼‰çš„ï¼Œåœ¨ä¸Šé¢åˆåŠ ä¸ªæ–¹æ³•ï¼Œæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå› æ­¤ä¸å…è®¸å°†æ¥å£ç±»å‹å®šä¹‰ä¸ºreceiver typeä¹Ÿæ˜¯ä¸æ¥å£çš„å®šä½ç›¸å¯¹åº”çš„å§ã€‚\n4 æ€»ç»“ # receiver-typeä¸å…è®¸ä¸ºæŒ‡é’ˆç±»å‹å’Œæ¥å£ç±»å‹ï¼Œå¯¹å…¶ä¸­åŸå› è¿›è¡Œäº†ä¸€ç‚¹æ€è€ƒå’Œæ€»ç»“ã€‚\nå‚è€ƒèµ„æ–™\n Russ Cox, â€œæ¥å£ä¸itableå…³ç³»â€, https://research.swtch.com/interfaces  å‚è€ƒå›¾ç‰‡\n"}),a.add({id:348,href:"/tags/method/",title:"method",description:"",content:""}),a.add({id:349,href:"/tags/receiver/",title:"receiver",description:"",content:""}),a.add({id:350,href:"/tags/closure/",title:"closure",description:"",content:""}),a.add({id:351,href:"/blog/2018-05-19-golang-function-closure%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/",title:"golang function-closure å®ç°æœºåˆ¶",description:"goå‡½æ•°é—­åŒ…è®¾è®¡å®ç°",content:"golangé‡Œé¢å‡½æ•°æ—¶first-class citizenï¼Œå¯ä»¥ä½œä¸ºå€¼è¿›è¡Œå‚æ•°ä¼ é€’ï¼Œä¸ç®¡æ˜¯æ™®é€šå‡½æ•°â€œfunc abc()â€ï¼Œè¿˜æ˜¯æˆå‘˜æ–¹æ³•â€œfunc (x X) xxx()â€ï¼Œè¿˜æ˜¯ä¸€ä¸ªé—­åŒ…â€œfunc () { return func(){\u0026hellip;.}}â€â€¦â€¦çœ‹ä¸Šå»å¾ˆæ–¹ä¾¿ï¼Œä¸ç¦è¦é—®ï¼Œgolangé‡Œé¢funcitonå’Œclosureæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ‰’æ‹‰äº†ä¸‹æºç ï¼Œè¿™é‡Œç®€å•æ€»ç»“ä¸‹ã€‚\n1 golangä¸­å‡½æ•°å†…éƒ¨è¡¨ç¤ºæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Ÿ # çœ‹ä¸‹golang cmd/compile/internal/types/type.goä¸­å¯¹Funcç±»å‹çš„å®šä¹‰ï¼š\n// Func contains Type fields specific to func types. type Func struct { Receiver *Type // function receiverï¼Œæ¥å—è€…ç±»å‹ï¼Œæ¯ä¸ªå‡½æ•°å®šä¹‰éƒ½åŒ…æ‹¬è¯¥å­—æ®µï¼Œå¯ä»¥ä¸ºnilæˆ–non-nil Results *Type // function resultsï¼Œè¿”å›å€¼ç±»å‹ Params *Type // function paramsï¼Œå‚æ•°åˆ—è¡¨ç±»å‹ Nname *Node // function nameï¼Œå‡½æ•°å // Argwid is the total width of the function receiver, params, and results. // It gets calculated via a temporary TFUNCARGS type. // Note that TFUNC's Width is Widthptr. Argwid int64 Outnamed bool // æ˜¯å¦æ˜¯å¯å¯¼å‡ºçš„ï¼Ÿ }  é€šè¿‡è¿™ä¸ªFuncå®šä¹‰æ¥çœ‹ï¼Œå…¶å¯ä»¥è¦†ç›–golangé‡Œé¢æ‰€æœ‰çš„å‡½æ•°ç±»å‹å£°æ˜äº†ï¼Œä¸ç®¡æ˜¯æ™®é€šå‡½æ•°ï¼Œè¿˜æ˜¯æˆå‘˜æ–¹æ³•ç­‰ç­‰ã€‚\n2 golangä¸­é—­åŒ…æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ # å‰ç«¯æ—¶é—´ç»„å†…åˆ†äº«é—­åŒ…ä½¿ç”¨çš„æ—¶å€™ï¼Œè§‰å¾—è¿™ç©æ„è™½ç„¶è½»å·§ä½†æ˜¯å¤ªå®¹æ˜“å‡ºé”™äº†ï¼Œç©¶å…¶åŸå› æ˜¯å› ä¸ºä¸äº†è§£é—­åŒ…çš„å®ç°åŸç†ã€‚é‚£ä¹ˆé—­åŒ…æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼ŒæŠ½æ—¶é—´æ‰’æ‹‰äº†ä¸€ä¸‹golangä¸­å®ç°é—­åŒ…çš„ä»£ç ï¼Œçœ‹å®Œåç¬é—´è§‰å¾—é—­åŒ…å¾ˆç®€å•ã€‚\næ¥ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œé—­åŒ…å°±æ˜¯å‡½æ•°+ç¯å¢ƒï¼Œé—®é¢˜æ˜¯è¿™é‡Œçš„ç¯å¢ƒæ˜¯å¦‚ä½•ä¸å‡½æ•°è¿›è¡Œç»‘å®šçš„å‘¢ï¼Ÿ\n remark: ä¸€å¼€å§‹çœ‹äº†ä¸Šé¢çš„Funcç±»å‹å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¥ä¸ºæ˜¯golangåˆ›å»ºäº†ä¸€ä¸ªè™šæ‹Ÿçš„ç±»å‹ï¼ˆé‡Œé¢å„ä¸ªå­—æ®µå€¼ä¸ºé—­åŒ…æ•è·çš„å˜é‡å€¼ï¼‰ç„¶åå°†è¯¥è™šæ‹Ÿç±»å‹ä½œä¸ºreceiver-typeæ¥å®ç°çš„å‘¢ï¼Œå¯æ˜¯ä»”ç»†ä¸€æƒ³è¿™ç§æ€è·¯ç«™ä¸ä½è„šï¼Œå› ä¸ºé—­åŒ…æ˜¯golangé‡Œé¢çš„first-class citizenï¼Œé—­åŒ…å®ç°åº”è¯¥éå¸¸è½»é‡æ‰å¯¹ï¼Œå¦‚æœåƒæˆ‘æœ€åˆè¿™ç§æƒ³æ³•é‚£å®åœ¨æ˜¯å¤ªå¤æ‚äº†ï¼Œæƒ³æƒ³è¦åˆ›å»ºå¤šå°‘è™šæ‹Ÿç±»å‹åŠå…¶å¯¹è±¡å§ã€‚\n çœ‹äº†ä¸‹æºä»£ç ï¼Œæ€»ç»“ä¸€ä¸‹golangä¸­çš„å®ç°æ€è·¯ï¼Œè€ƒè™‘åˆ°é—­åŒ…å¯¹è±¡æ˜¯å¦èƒ½é‡å¤ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸¤ä¸ªåœºæ™¯è¿›è¡Œå¤„ç†ï¼š\n1) å‡å¦‚é—­åŒ…å®šä¹‰åç«‹å³è¢«è°ƒç”¨ å› ä¸ºåªä¼šè¢«ä½¿ç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åº”è¯¥åŠ›å›¾é¿å…é—­åŒ…å¯¹è±¡çš„å†…å­˜åˆ†é…æ“ä½œï¼Œé‚£æ€ä¹ˆä¼˜åŒ–ä¸€ä¸‹å‘¢ï¼Œä»¥ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä¸ºä¾‹ã€‚\nfunc(a int) { println(byval) byref++ }(42)  ä¸Šé¢çš„é—­åŒ…å°†è¢«è½¬æ¢ä¸ºç®€å•å‡½æ•°è°ƒç”¨çš„å½¢å¼ï¼š\nfunc(byval int, \u0026amp;byref *int, a int) { println(byval) (*\u0026amp;byref)++ }(byval, \u0026amp;byref, 42)  æ³¨æ„çœ‹å‡½æ•°åŸå‹çš„å˜åŒ–ï¼ŒåŸæ¥é—­åŒ…é‡Œé¢æ•è·çš„å˜é‡éƒ½è¢«è½¬æ¢æˆäº†é€šè¿‡å‡½æ•°å‚æ•°æ¥ä¾›å€¼ï¼š\n å› ä¸ºprintlnæ“ä½œä¸æ¶‰åŠå¯¹byvalå˜é‡çš„ä¿®æ”¹æ“ä½œï¼Œæ‰€ä»¥æ˜¯æŒ‰å€¼æ•è·ï¼› è€Œbyref++æ¶‰åŠåˆ°å¯¹æ•è·å˜é‡çš„ä¿®æ”¹ï¼Œæ‰€ä»¥æ˜¯æŒ‰å¼•ç”¨æ•è·ï¼Œå¯¹äºæŒ‰å¼•ç”¨æ•è·çš„å˜é‡ä¼šè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œgolangç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶å°†æŒ‰å¼•ç”¨æ•è·çš„å˜é‡åbyrefè½¬æ¢æˆâ€œ\u0026amp;byrefâ€ï¼ŒåŒæ—¶å°†å…¶ç±»å‹è½¬æ¢æˆpointerç±»å‹ï¼Œæ•è·å˜é‡å¯¹åº”çš„å†™æ“ä½œä¹Ÿä¼šè½¬æ¢ä¸ºé€šè¿‡pointeræ¥æ“ä½œã€‚  2ï¼‰ å‡å¦‚é—­åŒ…å®šä»¥åå¹¶ä¸æ˜¯ç«‹å³è°ƒç”¨ é—­åŒ…å®šä¹‰åä¸æ˜¯ç«‹å³ä½¿ç”¨ï¼Œè€Œæ˜¯åç»­è°ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹åŒä¸€ä¸ªé—­åŒ…å¯èƒ½è°ƒç”¨å¤šæ¬¡ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦åˆ›å»ºé—­åŒ…å¯¹è±¡ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ\n å¦‚æœå˜é‡æ˜¯æŒ‰å€¼æ•è·ï¼Œå¹¶ä¸”è¯¥å˜é‡å ç”¨å­˜å‚¨ç©ºé—´å°äº2*sizeof(int)ï¼Œé‚£ä¹ˆå°±é€šè¿‡åœ¨å‡½æ•°ä½“å†…åˆ›å»ºå±€éƒ¨å˜é‡çš„å½¢å¼æ¥shadowæ•è·çš„å˜é‡ï¼Œç›¸æ¯”äºé€šè¿‡å¼•ç”¨æ•è·ï¼Œè¿™ä¹ˆåšçš„å¥½å¤„åº”è¯¥æ˜¯è€ƒè™‘åˆ°å‡å°‘å¼•ç”¨æ•°é‡ã€å‡å°‘é€ƒé€¸åˆ†æç›¸å…³çš„è®¡ç®—ã€‚ å¦‚æœå˜é‡æ˜¯æŒ‰å¼•ç”¨æ•è·ï¼Œæˆ–è€…æŒ‰å€¼æ•è·ä½†æ˜¯æ•è·çš„å˜é‡å ç”¨å­˜å‚¨ç©ºé—´è¾ƒå¤§ï¼ˆæ‹·è´åˆ°æœ¬åœ°åšå±€éƒ¨å˜é‡ä»£ä»·å¤ªå¤§ï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹å°±å°†æ•è·çš„å˜é‡varè½¬æ¢æˆpointerç±»å‹çš„â€œ\u0026amp;varâ€ï¼Œå¹¶åœ¨å‡½æ•°prologueé˜¶æ®µå°†å…¶åˆå§‹åŒ–ä¸ºæ•è·å˜é‡çš„å€¼ã€‚  è¿™éƒ¨åˆ†çš„ä»£ç è¯¦è§ï¼šcmd/compile/gc/closure.goä¸­çš„æ–¹æ³•transformclosure(\u0026hellip;)ã€‚ é—­åŒ…å°±æ˜¯å‡½æ•°ä½“+ç¯å¢ƒï¼Œç¯å¢ƒå°±æ˜¯åƒè¿™æ ·ç»‘å®šçš„ã€‚\n3 æ€»ç»“ # æœ¬æ–‡ç®€è¦æè¿°äº†golangä¸­å¯¹å‡½æ•°çš„å†…éƒ¨å®šä¹‰ï¼Œä»¥åŠé—­åŒ…çš„å¤§è‡´å®ç°æ€è·¯ï¼ŒåŠ æ·±äº†ç†è§£ã€‚\né™„ï¼šgolangé—­åŒ…å¤„ç†å…³é”®ä»£ç  # func transformclosure(xfunc *Node) { lno := lineno lineno = xfunc.Pos func_ := xfunc.Func.Closure if func_.Func.Top\u0026amp;Ecall != 0 { // If the closure is directly called, we transform it to a plain function call // with variables passed as args. This avoids allocation of a closure object. // Here we do only a part of the transformation. Walk of OCALLFUNC(OCLOSURE) // will complete the transformation later. // For illustration, the following closure: //	func(a int) { //	println(byval) //	byref++ //	}(42) // becomes: //	func(byval int, \u0026amp;byref *int, a int) { //	println(byval) //	(*\u0026amp;byref)++ //	}(byval, \u0026amp;byref, 42) // f is ONAME of the actual function. f := xfunc.Func.Nname // We are going to insert captured variables before input args. var params []*types.Field var decls []*Node for _, v := range func_.Func.Cvars.Slice() { if v.Op == OXXX { continue } fld := types.NewField() fld.Funarg = types.FunargParams if v.Name.Byval() { // If v is captured by value, we merely downgrade it to PPARAM. v.SetClass(PPARAM) fld.Nname = asTypesNode(v) } else { // If v of type T is captured by reference, // we introduce function param \u0026amp;v *T // and v remains PAUTOHEAP with \u0026amp;v heapaddr // (accesses will implicitly deref \u0026amp;v). addr := newname(lookup(\u0026quot;\u0026amp;\u0026quot; + v.Sym.Name)) addr.Type = types.NewPtr(v.Type) addr.SetClass(PPARAM) v.Name.Param.Heapaddr = addr fld.Nname = asTypesNode(addr) } fld.Type = asNode(fld.Nname).Type fld.Sym = asNode(fld.Nname).Sym params = append(params, fld) decls = append(decls, asNode(fld.Nname)) } if len(params) \u0026gt; 0 { // Prepend params and decls. f.Type.Params().SetFields(append(params, f.Type.Params().FieldSlice()...)) xfunc.Func.Dcl = append(decls, xfunc.Func.Dcl...) } dowidth(f.Type) xfunc.Type = f.Type // update type of ODCLFUNC } else { // The closure is not called, so it is going to stay as closure. var body []*Node offset := int64(Widthptr) for _, v := range func_.Func.Cvars.Slice() { if v.Op == OXXX { continue } // cv refers to the field inside of closure OSTRUCTLIT. cv := nod(OCLOSUREVAR, nil, nil) cv.Type = v.Type if !v.Name.Byval() { cv.Type = types.NewPtr(v.Type) } offset = Rnd(offset, int64(cv.Type.Align)) cv.Xoffset = offset offset += cv.Type.Width if v.Name.Byval() \u0026amp;\u0026amp; v.Type.Width \u0026lt;= int64(2*Widthptr) { // If it is a small variable captured by value, downgrade it to PAUTO. v.SetClass(PAUTO) xfunc.Func.Dcl = append(xfunc.Func.Dcl, v) body = append(body, nod(OAS, v, cv)) } else { // Declare variable holding addresses taken from closure // and initialize in entry prologue. addr := newname(lookup(\u0026quot;\u0026amp;\u0026quot; + v.Sym.Name)) addr.Type = types.NewPtr(v.Type) addr.SetClass(PAUTO) addr.Name.SetUsed(true) addr.Name.Curfn = xfunc xfunc.Func.Dcl = append(xfunc.Func.Dcl, addr) v.Name.Param.Heapaddr = addr if v.Name.Byval() { cv = nod(OADDR, cv, nil) } body = append(body, nod(OAS, addr, cv)) } } if len(body) \u0026gt; 0 { typecheckslice(body, Etop) walkstmtlist(body) xfunc.Func.Enter.Set(body) xfunc.Func.SetNeedctxt(true) } } lineno = lno }  "}),a.add({id:352,href:"/tags/chann/",title:"chann",description:"",content:""}),a.add({id:353,href:"/blog/2018-05-19-golang-select-case%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/",title:"golang select-case å®ç°æœºåˆ¶",description:"golang chan select-caseè®¾è®¡å®ç°",content:"1 chanæ“ä½œè§„åˆ™ # åœ¨ä»‹ç»select-caseå®ç°æœºåˆ¶ä¹‹å‰ï¼Œæœ€å¥½å…ˆäº†è§£ä¸‹chanæ“ä½œè§„åˆ™ï¼Œæ˜ç™½goroutineä½•æ—¶é˜»å¡ï¼Œåˆåœ¨ä»€ä¹ˆæ—¶æœºè¢«å”¤é†’ï¼Œè¿™å¯¹åç»­ç†è§£select-caseå®ç°æœ‰å¸®åŠ©ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å…ˆä»‹ç»chanæ“ä½œè§„åˆ™ï¼Œç„¶åå†ä»‹ç»select-caseçš„å®ç°ã€‚\n1.1 chanæ“ä½œè§„åˆ™1 # å½“ä¸€ä¸ªgoroutineè¦ä»ä¸€ä¸ªnon-nil \u0026amp; non-closed chanä¸Šæ¥æ”¶æ•°æ®æ—¶ï¼Œgoroutineé¦–å…ˆä¼šå»è·å–chanä¸Šçš„é”ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹æ“ä½œç›´åˆ°æŸä¸ªæ¡ä»¶è¢«æ»¡è¶³ï¼š\n1ï¼‰å¦‚æœchanä¸Šçš„value bufferä¸ç©ºï¼Œè¿™ä¹Ÿæ„å‘³ç€chanä¸Šçš„recv goroutine queueä¹Ÿä¸€å®šæ˜¯ç©ºçš„ï¼Œè¯¥æ¥æ”¶goroutineå°†ä»value bufferä¸­unshiftå‡ºä¸€ä¸ªvalueã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœsend goroutineé˜Ÿåˆ—ä¸ç©ºçš„æƒ…å†µä¸‹ï¼Œå› ä¸ºåˆšæ‰value bufferä¸­ç©ºå‡ºäº†ä¸€ä¸ªä½ç½®ï¼Œæœ‰ä½ç½®å¯å†™ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¼šä»send goroutine queueä¸­unshiftå‡ºä¸€ä¸ªå‘é€goroutineå¹¶è®©å…¶æ¢å¤æ‰§è¡Œï¼Œè®©å…¶æ‰§è¡ŒæŠŠæ•°æ®å†™å…¥chançš„æ“ä½œï¼Œå®é™…ä¸Šæ˜¯æ¢å¤è¯¥å‘é€è¯¥goroutineæ‰§è¡Œï¼Œå¹¶æŠŠè¯¥å‘é€goroutineè¦å‘é€çš„æ•°æ®pushåˆ°value bufferä¸­ã€‚ç„¶åå‘¢ï¼Œè¯¥æ¥æ”¶goroutineä¹Ÿæ‹¿åˆ°äº†æ•°æ®äº†ï¼Œå°±ç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…æ™¯ï¼Œchannelçš„æ¥æ”¶æ“ä½œç§°ä¸ºnon-blockingæ“ä½œã€‚\n2ï¼‰å¦ä¸€ç§æƒ…å†µï¼Œå¦‚æœvalue bufferæ˜¯ç©ºçš„ï¼Œä½†æ˜¯send goroutine queueä¸ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥chanä¸€å®šæ˜¯unbufferred chanï¼Œä¸ç„¶value bufferè‚¯å®šæœ‰æ•°æ®å˜›ï¼Œè¿™ä¸ªæ—¶å€™æ¥æ”¶goroutineå°†ä»send goroutine queueä¸­unshiftå‡ºä¸€ä¸ªå‘é€goroutineï¼Œå¹¶å°†è¯¥å‘é€goroutineè¦å‘é€çš„æ•°æ®æ¥æ”¶è¿‡æ¥ï¼ˆä¸¤ä¸ªgoroutineä¸€ä¸ªæœ‰å‘é€æ•°æ®åœ°å€ï¼Œä¸€ä¸ªæœ‰æ¥æ”¶æ•°æ®åœ°å€ï¼Œæ‹·è´è¿‡æ¥å°±okï¼‰ï¼Œç„¶åè¿™ä¸ªå–å‡ºçš„å‘é€goroutineå°†æ¢å¤æ‰§è¡Œï¼Œè¿™ä¸ªæ¥æ”¶goroutineä¹Ÿå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchanæ¥æ”¶æ“ä½œä¹Ÿæ˜¯non-blockingæ“ä½œã€‚\n3ï¼‰å¦ä¸€ç§æƒ…å†µï¼Œå¦‚æœvalue bufferå’Œsend goroutine queueéƒ½æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰æ•°æ®å¯æ¥æ”¶ï¼Œå°†æŠŠè¯¥æ¥æ”¶goroutine pushåˆ°chançš„recv goroutine queueï¼Œè¯¥æ¥æ”¶goroutineå°†è½¬å…¥blockingçŠ¶æ€ï¼Œä»€ä¹ˆæ—¶å€™æ¢å¤æœŸæ‰§è¡Œå‘¢ï¼Œè¦ç­‰åˆ°æœ‰ä¸€ä¸ªgoroutineå°è¯•å‘chanå‘é€æ•°æ®çš„æ—¶å€™äº†ã€‚è¿™ç§åœºæ™¯ä¸‹ï¼Œchanæ¥æ”¶æ“ä½œæ˜¯blockingæ“ä½œã€‚\n1.2 chanæ“ä½œè§„åˆ™2 # å½“ä¸€ä¸ªgoroutineå¸¸è¯†å‘ä¸€ä¸ªnon-nil \u0026amp; non-closed chanå‘é€æ•°æ®çš„æ—¶å€™ï¼Œè¯¥goroutineå°†å…ˆå°è¯•è·å–chanä¸Šçš„é”ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹æ“ä½œç›´åˆ°æ»¡è¶³å…¶ä¸­ä¸€ç§æƒ…å†µã€‚\n1ï¼‰å¦‚æœchançš„recv goroutine queueä¸ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œvalue bufferä¸€å®šæ˜¯ç©ºçš„ã€‚å‘é€goroutineå°†ä»recv goroutine queueä¸­unshiftå‡ºä¸€ä¸ªrecv goroutineï¼Œç„¶åç›´æ¥å°†è‡ªå·±è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°è¯¥recv goroutineçš„æ¥æ”¶åœ°å€å¤„ï¼Œç„¶åæ¢å¤è¯¥recv goroutineçš„è¿è¡Œï¼Œå½“å‰å‘é€goroutineä¹Ÿç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchan sendæ“ä½œæ˜¯non-blockingæ“ä½œã€‚\n2ï¼‰å¦‚æœchançš„recv goroutine queueæ˜¯ç©ºçš„ï¼Œå¹¶ä¸”value bufferä¸æ»¡ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œsend goroutine queueä¸€å®šæ˜¯ç©ºçš„ï¼Œå› ä¸ºvalue bufferä¸æ»¡å‘é€goroutineå¯ä»¥å‘é€å®Œæˆä¸å¯èƒ½ä¼šé˜»å¡ã€‚è¯¥å‘é€goroutineå°†è¦å‘é€çš„æ•°æ®pushåˆ°value bufferä¸­ç„¶åç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchan sendæ“ä½œæ˜¯non-blockingæ“ä½œã€‚\n3ï¼‰å¦‚æœchançš„recv goroutine queueæ˜¯ç©ºçš„ï¼Œå¹¶ä¸”value bufferæ˜¯æ»¡çš„ï¼Œå‘é€goroutineå°†è¢«pushåˆ°send goroutine queueä¸­è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ç­‰åˆ°æœ‰å…¶ä»–goroutineå°è¯•ä»chanæ¥æ”¶æ•°æ®çš„æ—¶å€™æ‰èƒ½å°†å…¶å”¤é†’æ¢å¤æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchan sendæ“ä½œæ˜¯blockingæ“ä½œã€‚\n1.3 chanæ“ä½œè§„åˆ™3 # å½“ä¸€ä¸ªgoroutineå°è¯•closeä¸€ä¸ªnon-nil \u0026amp; non-closed chançš„æ—¶å€™ï¼Œcloseæ“ä½œå°†ä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹æ“ä½œã€‚\n1ï¼‰å¦‚æœchançš„recv goroutine queueä¸ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹value bufferä¸€å®šæ˜¯ç©ºçš„ï¼Œå› ä¸ºå¦‚æœvalue bufferå¦‚æœä¸ç©ºï¼Œä¸€å®šä¼šç»§ç»­unshift recv goroutine queueä¸­çš„goroutineæ¥æ”¶æ•°æ®ï¼Œç›´åˆ°value bufferä¸ºç©ºï¼ˆè¿™é‡Œå¯ä»¥çœ‹ä¸‹chan sendæ“ä½œï¼Œchan sendå†™å…¥æ•°æ®ä¹‹å‰ï¼Œä¸€å®šä¼šä»recv goroutine queueä¸­unshiftå‡ºä¸€ä¸ªrecv goroutineï¼‰ã€‚recv goroutine queueé‡Œé¢æ‰€æœ‰çš„goroutineå°†ä¸€ä¸ªä¸ªunshiftå‡ºæ¥å¹¶è¿”å›ä¸€ä¸ªval=0å€¼å’ŒsentBeforeClosed=falseã€‚\n2ï¼‰å¦‚æœchançš„send goroutine queueä¸ç©ºï¼Œæ‰€æœ‰çš„goroutineå°†è¢«ä¾æ¬¡å–å‡ºå¹¶ç”Ÿæˆä¸€ä¸ªpanic for closing a close chanã€‚åœ¨è¿™closeä¹‹å‰å‘é€åˆ°chançš„æ•°æ®ä»ç„¶åœ¨chançš„value bufferä¸­å­˜ç€ã€‚\n1.4 chanæ“ä½œè§„åˆ™4 # ä¸€æ—¦chanè¢«å…³é—­äº†ï¼Œchan recvæ“ä½œå°±æ°¸è¿œä¹Ÿä¸ä¼šé˜»å¡ï¼Œchançš„value bufferä¸­åœ¨closeä¹‹å‰å†™å…¥çš„æ•°æ®ä»ç„¶å­˜åœ¨ã€‚ä¸€æ—¦value bufferä¸­closeä¹‹å‰å†™å…¥çš„æ•°æ®éƒ½è¢«å–å‡ºä¹‹åï¼Œåç»­çš„æ¥æ”¶æ“ä½œå°†ä¼šè¿”å›val=0å’ŒsentBeforeClosed=trueã€‚\n1.5 å°ç»“ # ç†è§£è¿™é‡Œçš„goroutineçš„blockingã€non-blockingæ“ä½œå¯¹äºç†è§£é’ˆå¯¹chançš„select-caseæ“ä½œæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ä¸‹é¢ä»‹ç»select-caseå®ç°æœºåˆ¶ã€‚\n2 select-caseå®ç° # 2.1 select-caseåŸç†ç®€è¿° # select-caseä¸­å‡å¦‚æ²¡æœ‰defaultåˆ†æ”¯çš„è¯ï¼Œä¸€å®šè¦ç­‰åˆ°æŸä¸ªcaseåˆ†æ”¯æ»¡è¶³æ¡ä»¶ç„¶åå°†å¯¹åº”çš„goroutineå”¤é†’æ¢å¤æ‰§è¡Œæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ä»£ç å°±ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œå³å°†å½“å‰goroutine pushåˆ°å„ä¸ªcaseåˆ†æ”¯å¯¹åº”çš„chçš„recvæˆ–è€…send goroutine queueä¸­ï¼Œå¯¹åŒä¸€ä¸ªchanä¹Ÿå¯èƒ½å°†å½“å‰goroutineåŒæ—¶pushåˆ°recvã€send goroutine queueè¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ã€‚\nä¸ç®¡æ˜¯æ™®é€šçš„chan sendã€recvæ“ä½œï¼Œè¿˜æ˜¯select chan sendã€recvæ“ä½œï¼Œå› ä¸ºchanæ“ä½œé˜»å¡çš„goroutineéƒ½æ˜¯ä¾é å…¶ä»–goroutineå¯¹chançš„sendã€recvæ“ä½œæ¥å”¤é†’çš„ã€‚å‰é¢æˆ‘ä»¬å·²ç»è®²è¿‡äº†goroutineè¢«å”¤é†’çš„æ—¶æœºï¼Œè¿™é‡Œè¿˜è¦å†ç»†åˆ†ä¸€ä¸‹ã€‚\nchançš„sendã€recv goroutine queueä¸­å­˜å‚¨çš„å…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆ*sudogï¼Œæˆå‘˜gp *gæŒ‡å‘å¯¹åº”çš„goroutineï¼Œelem unsafe.PointeræŒ‡å‘å¾…è¯»å†™çš„å˜é‡åœ°å€ï¼Œc *hchanæŒ‡å‘goroutineé˜»å¡åœ¨å“ªä¸ªchanä¸Šï¼ŒisSelectä¸ºtrueè¡¨ç¤ºselect chan sendã€recvï¼Œåä¹‹è¡¨ç¤ºchan sendã€recvã€‚g.selectDoneè¡¨ç¤ºselectæ“ä½œæ˜¯å¦å¤„ç†å®Œæˆï¼Œå³æ˜¯å¦æœ‰æŸä¸ªcaseåˆ†æ”¯å·²ç»æˆç«‹ã€‚\n2 select-caseæ‰§è¡Œæµç¨‹ # 2.1 chanæ“ä½œé˜»å¡çš„goroutineå”¤é†’æ—¶æ‰§è¡Œé€»è¾‘ # ä¸‹é¢æˆ‘ä»¬å…ˆæè¿°ä¸‹chanä¸ŠæŸä¸ªgoroutineè¢«å”¤é†’æ—¶çš„å¤„ç†é€»è¾‘ï¼Œå‡å¦‚ç°åœ¨æœ‰ä¸ªgoroutineå› ä¸ºselect chan æ“ä½œé˜»å¡åœ¨äº†ch1ã€ch2ä¸Šï¼Œé‚£ä¹ˆä¼šåˆ›å»ºå¯¹åº”çš„sudogå¯¹è±¡ï¼Œå¹¶å°†å¯¹åº”çš„æŒ‡é’ˆ*sudog pushåˆ°å„ä¸ªcaseåˆ†æ”¯å¯¹åº”çš„ch1ã€ch2ä¸Šçš„sendã€recv goroutine queueä¸­ï¼Œç­‰å¾…å…¶ä»–åç¨‹æ‰§è¡Œ(select) chan sendã€recvæ“ä½œæ—¶å°†å…¶å”¤é†’ï¼š 1ï¼‰æºç æ–‡ä»¶chan.goï¼Œå‡å¦‚ç°åœ¨æœ‰å¦å¤–ä¸€ä¸ªgoroutineå¯¹ch1è¿›è¡Œäº†æ“ä½œï¼Œç„¶åå¯¹ch1çš„goroutineæ‰§è¡Œunshiftæ“ä½œå–å‡ºä¸€ä¸ªé˜»å¡çš„goroutineï¼Œåœ¨unshiftæ—¶è¦æ‰§è¡Œæ–¹æ³• **func (q waitq) dequeue() sudogï¼Œè¿™ä¸ªæ–¹æ³•ä»ch1çš„ç­‰å¾…é˜Ÿåˆ—ä¸­è¿”å›ä¸€ä¸ªé˜»å¡çš„goroutineã€‚\nfunc (q *waitq) dequeue() *sudog { for { sgp := q.first if sgp == nil { return nil } y := sgp.next if y == nil { q.first = nil q.last = nil } else { y.prev = nil q.first = y sgp.next = nil // mark as removed (see dequeueSudog) } // if a goroutine was put on this queue because of a // select, there is a small window between the goroutine // being woken up by a different case and it grabbing the // channel locks. Once it has the lock // it removes itself from the queue, so we won't see it after that. // We use a flag in the G struct to tell us when someone // else has won the race to signal this goroutine but the goroutine // hasn't removed itself from the queue yet. if sgp.isSelect { if !atomic.Cas(\u0026amp;sgp.g.selectDone, 0, 1) { continue } } return sgp } }  å‡å¦‚é˜Ÿé¦–å…ƒç´ å°±æ˜¯ä¹‹å‰é˜»å¡çš„goroutineï¼Œé‚£ä¹ˆæ£€æµ‹åˆ°å…¶sgp.isSelect=trueï¼Œå°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå› ä¸ºselect chan sendã€recvé˜»å¡çš„goroutineï¼Œç„¶åé€šè¿‡CASæ“ä½œå°†sgp.g.selectDoneè®¾ä¸ºtrueæ ‡è¯†å½“å‰goroutineçš„selectæ“ä½œå·²ç»å¤„ç†å®Œæˆï¼Œä¹‹åå°±å¯ä»¥å°†è¯¥goroutineè¿”å›ç”¨äºä»value bufferè¯»æˆ–è€…å‘value bufferå†™æ•°æ®äº†ï¼Œæˆ–è€…ç›´æ¥ä¸å”¤é†’å®ƒçš„goroutineäº¤æ¢æ•°æ®ï¼Œç„¶åè¯¥é˜»å¡çš„goroutineå°±å¯ä»¥æ¢å¤æ‰§è¡Œäº†ã€‚\nè¿™é‡Œå°†sgp.g.selectDoneè®¾ä¸ºtrueï¼Œç›¸å½“äºä¼ è¾¾äº†è¯¥sgp.gå·²ç»ä»åˆšæ‰é˜»å¡å®ƒçš„select-caseå—ä¸­é€€å‡ºäº†ï¼Œå¯¹åº”çš„select-caseå—å¯ä»¥ä½œåºŸäº†ã€‚æœ‰å¿…è¦ææä¸€ä¸‹ä¸ºä»€ä¹ˆè¦æŠŠè¿™é‡Œçš„sgp.g.selectDoneè®¾ä¸ºtrueå‘¢ï¼Ÿç›´æ¥å°†è¯¥goroutineå‡ºé˜Ÿä¸å°±å®Œäº†å—ï¼Ÿä¸è¡Œï¼è€ƒè™‘ä»¥ä¸‹å¯¹chançš„æ“ä½œdequeueæ˜¯éœ€è¦å…ˆæ‹¿åˆ°chanä¸Šçš„lockçš„ï¼Œä½†æ˜¯åœ¨å°è¯•lock chanä¹‹å‰æœ‰å¯èƒ½åŒæ—¶æœ‰å¤šä¸ªcaseåˆ†æ”¯å¯¹åº”çš„chanå‡†å¤‡å°±ç»ªã€‚çœ‹ä¸ªç¤ºä¾‹ä»£ç ï¼š\n// g1 go func() { ch1 \u0026lt;- 1\u2028}() // g2 go func() { ch2 \u0026lt;- 2 } select { case \u0026lt;- ch1: doSomething() case \u0026lt;- ch2: doSomething() }  åç¨‹g1åœ¨ chan.chansendæ–¹æ³•ä¸­æ‰§è¡Œäº†ä¸€èˆ¬ï¼Œå‡†å¤‡lock ch1ï¼Œåç¨‹g2ä¹Ÿæ‰§è¡Œäº†ä¸€åŠï¼Œä¹Ÿå‡†å¤‡lock ch2; åç¨‹g1æˆåŠŸlock ch1æ‰§è¡Œdequeueæ“ä½œï¼Œåç¨‹g2é¡µæˆåŠŸlock ch2æ‰§è¡Œdeq	ueueæ“ä½œï¼› å› ä¸ºåŒä¸€ä¸ªselect-caseå—ä¸­åªèƒ½æœ‰ä¸€ä¸ªcaseåˆ†æ”¯å…è®¸æ¿€æ´»ï¼Œæ‰€ä»¥åœ¨åç¨‹gé‡Œé¢åŠ äº†ä¸ªæˆå‘˜g.selectDoneæ¥æ ‡è¯†è¯¥åç¨‹å¯¹åº”çš„select-caseæ˜¯å¦å·²ç»æˆåŠŸæ‰§è¡Œç»“æŸï¼ˆä¸€ä¸ªåç¨‹åœ¨æŸä¸ªæ—¶åˆ»åªå¯èƒ½æœ‰ä¸€ä¸ªselect-caseå—åœ¨å¤„ç†ï¼Œè¦ä¹ˆé˜»å¡æ²¡æ‰§è¡Œå®Œï¼Œè¦ä¹ˆç«‹å³æ‰§è¡Œå®Œï¼‰ï¼Œå› æ­¤dequeueæ—¶è¦é€šè¿‡CASæ“ä½œæ¥æ›´æ–°g.selectDoneçš„å€¼ï¼Œæ›´æ–°æˆåŠŸè€…å®Œæˆå‡ºé˜Ÿæ“ä½œæ¿€æ´»caseåˆ†æ”¯ï¼ŒCASå¤±è´¥çš„åˆ™è®¤ä¸ºè¯¥select-caseå·²ç»æœ‰å…¶ä»–åˆ†æ”¯è¢«æ¿€æ´»ï¼Œå½“å‰caseåˆ†æ”¯ä½œåºŸï¼Œselect-caseç»“æŸã€‚\nè¿™é‡Œçš„CASæ“ä½œä¹Ÿå°±æ˜¯è¯´çš„å¤šä¸ªåˆ†æ”¯æ»¡è¶³æ¡ä»¶æ—¶ï¼Œgolangä¼šéšæœºé€‰æ‹©ä¸€ä¸ªåˆ†æ”¯æ‰§è¡Œçš„é“ç†ã€‚\n2.2 select-caseå—golangæ˜¯å¦‚ä½•æ‰§è¡Œå¤„ç†çš„ # æºæ–‡ä»¶select.goä¸­æ–¹æ³• *selectgo(sel hselect) ï¼Œå®ç°äº†å¯¹select-caseå—çš„å¤„ç†é€»è¾‘ï¼Œä½†æ˜¯ç”±äºä»£ç ç¯‡å¹…è¾ƒé•¿ï¼Œè¿™é‡Œä¸å†å¤åˆ¶ç²˜è´´ä»£ç ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æŸ¥çœ‹ï¼Œè¿™é‡Œåªç®€è¦æè¿°ä¸‹å…¶æ‰§è¡Œæµç¨‹ã€‚\nselectgoé€»è¾‘å¤„ç†ç®€è¿°ï¼š\n é¢„å¤„ç†éƒ¨åˆ† å¯¹å„ä¸ªcaseåˆ†æ”¯æŒ‰ç…§chåœ°å€æ’åºï¼Œä¿è¯åç»­æŒ‰åºåŠ é”ï¼Œé¿å…äº§ç”Ÿæ­»é”é—®é¢˜ï¼› pass 1 éƒ¨åˆ†å¤„ç†å„ä¸ªcaseåˆ†æ”¯çš„åˆ¤æ–­é€»è¾‘ï¼Œä¾æ¬¡æ£€æŸ¥å„ä¸ªcaseåˆ†æ”¯æ˜¯å¦æœ‰ç«‹å³å¯æ»¡è¶³chè¯»å†™æ“ä½œçš„ã€‚å¦‚æœå½“å‰åˆ†æ”¯æœ‰åˆ™ç«‹å³æ‰§è¡Œchè¯»å†™å¹¶å›ï¼Œselectå¤„ç†ç»“æŸï¼›æ²¡æœ‰åˆ™ç»§ç»­å¤„ç†ä¸‹ä¸€åˆ†æ”¯ï¼›å¦‚æœæ‰€æœ‰åˆ†æ”¯å‡ä¸æ»¡è¶³ç»§ç»­æ‰§è¡Œä»¥ä¸‹æµç¨‹ã€‚ pass 2 æ²¡æœ‰ä¸€ä¸ªcaseåˆ†æ”¯ä¸Šchanæ“ä½œç«‹å³å¯å°±ç»ªï¼Œå½“å‰goroutineéœ€è¦é˜»å¡ï¼Œéå†æ‰€æœ‰çš„caseåˆ†æ”¯ï¼Œåˆ†åˆ«æ„å»ºgoroutineå¯¹åº”çš„sudogå¹¶pushåˆ°caseåˆ†æ”¯å¯¹åº”chançš„å¯¹åº”goroutine queueä¸­ã€‚ç„¶ågoparkæŒ‚èµ·å½“å‰goroutineï¼Œç­‰å¾…æŸä¸ªåˆ†æ”¯ä¸Šchanæ“ä½œå®Œæˆæ¥å”¤é†’å½“å‰goroutineã€‚æ€ä¹ˆè¢«å”¤é†’å‘¢ï¼Ÿå‰é¢æåˆ°äº†chan.waitq.dequeue()æ–¹æ³•ä¸­é€šè¿‡CASå°†sudog.g.selectDoneè®¾ä¸º1ä¹‹åå°†è¯¥sudogè¿”å›å¹¶æ¢å¤æ‰§è¡Œï¼Œå…¶å®ä¹Ÿå°±æ˜¯å€ŸåŠ©è¿™ä¸ªæ“ä½œæ¥å”¤é†’ã€‚ pass 3 æ•´ä¸ªselect-caseå—å·²ç»ç»“æŸä½¿å‘½ï¼Œä¹‹å‰é˜»å¡çš„goroutineå·²è¢«å”¤é†’ï¼Œå…¶ä»–caseåˆ†æ”¯æ²¡ä»€ä¹ˆä½œç”¨äº†ï¼Œéœ€è¦åºŸå¼ƒæ‰ï¼Œpass 3éƒ¨åˆ†ä¼šå°†è¯¥goroutineä»ä¹‹å‰é˜»å¡å®ƒçš„select-caseå—ä¸­å„caseåˆ†æ”¯å¯¹åº”çš„chan recvã€send goroutine queueä¸­ç§»é™¤ï¼Œé€šè¿‡æ–¹æ³•chan.waitq.dequeueSudog(sgp *sudog)æ¥ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œé˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨ï¼Œé€šè¿‡sudog.prevå’Œsudog.nextåˆ é™¤sudogæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚  3 æ€»ç»“ # æœ¬æ–‡ç®€è¦æè¿°äº†golangä¸­select-caseçš„å®ç°é€»è¾‘ï¼Œä»‹ç»äº†goroutineä¸chanæ“ä½œä¹‹é—´çš„åä½œå…³ç³»ã€‚ä¹‹å‰ZMQä½œè€…Martin Sustrikä»¿ç€golangå†™è¿‡ä¸€ä¸ªé¢å‘cçš„åº“ï¼Œlibmillï¼Œå®é™…å®ç°æ€è·¯å·®ä¸å¤šï¼Œæ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥ç¿»ç¿»çœ‹ï¼Œlibmillæºç åˆ†æã€‚\n"}),a.add({id:354,href:"/tags/chrome/",title:"chrome",description:"",content:""}),a.add({id:355,href:"/blog/2018-03-02-chrome%E5%88%86%E5%B1%8F%E9%98%85%E8%AF%BB%E6%8F%92%E4%BB%B6pagesplit/",title:"chromeåˆ†å±é˜…è¯»æ’ä»¶ï¼špagesplit",description:"chromeä¼˜ç§€çš„æ‰©å±•æ€§ä½¿å¾—å®ƒæˆä¸ºå¾ˆå¤šå¼€å‘äººå‘˜çš„é¦–é€‰æµè§ˆå™¨ï¼Œä¸å°‘å¼€å‘äººå‘˜åœ¨ä½¿ç”¨Vimæˆ–è€…IDEé˜…è¯»æºç æ—¶ï¼Œéƒ½å­˜åœ¨vsplit/hsplitåˆ†å±çš„ä¹ æƒ¯ï¼Œé‚£ä¹ˆåœ¨é€šè¿‡æµè§ˆå™¨æµè§ˆç½‘ç»œä¸Šçš„ä»£ç æˆ–è€…é¡µé¢æ—¶ï¼Œå¦‚ä½•åœ¨æµè§ˆå™¨é¡µé¢ä¸­å®ç°ç±»ä¼¼Vimçš„åˆ†å±åŠŸèƒ½å‘¢ï¼Ÿæœ¬æ–‡ç»“åˆä½œè€…çš„ä¸ªäººé¡¹ç›®pagesplitæ¥ä»‹ç»ä¸‹å¦‚ä½•å¼€å‘ä¸€ä¸ªchromeåˆ†å±é˜…è¯»æ’ä»¶ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  å‰è¨€ # è¿™å‡ å¤©åœ¨é’»ç ”golangï¼Œç»å¸¸åœ¨ç½‘ä¸Šçœ‹äº›æºç åˆ†æçš„æ–‡ç« ï¼Œæ—¢ç„¶æ˜¯æºç åˆ†æå°±å°‘ä¸äº†codeå’Œåˆ†æçš„å„ç§ç©¿æ’æè¿°ï¼Œæ–‡ç« ç¯‡å¹…ä¸€é•¿æˆ–è€…code blockå—æ¯”è¾ƒé•¿ï¼Œç»å¸¸éœ€è¦æ»šåŠ¨é¼ æ ‡ä¸Šä¸‹ç¿»é¡µï¼Œè¿™ç§é˜…è¯»ä½“éªŒå¥½å·®åŠ²ã€‚å¿ƒæƒ³è¦æ˜¯èƒ½å¤Ÿå°†webé¡µé¢è¿›è¡Œç±»ä¼¼äºvimçš„vsplitæˆ–è€…lsplitå°±å¥½äº†ã€‚äºæ˜¯å°±æœ‰äº†è¿™ä¸ªchromeæ‰©å±•ã€‚\näº§å“è°ƒç ” # chromeç½‘ä¸Šåº”ç”¨å•†åº—ä¸­æœç´¢äº†ä¸€ä¸‹ï¼Œæ‰¾åˆ°äº†å‡ ä¸ªç±»ä¼¼åŠŸèƒ½çš„æ’ä»¶â€œsplit tabsâ€ã€â€œtab resizeâ€ï¼Œä½“éªŒä¹‹åä¸å¤ªæ»¡è¶³ä¸ªäººéœ€è¦ã€‚åŸå› æ˜¯ï¼šè¿™ä¸¤ä¸ªæ‰©å±•éƒ½æ˜¯é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–°çš„æµè§ˆå™¨çª—å£æ¥æ‰“å¼€å½“å‰webé¡µé¢ï¼Œç„¶åå¹¶æ’æ˜¾ç¤ºï¼ˆæ”¯æŒæ°´å¹³ã€å‚ç›´å¹¶æ’æ˜¾ç¤ºï¼‰ï¼Œå¦‚ä¸‹å›¾ã€‚ è¿™ç§å®ç°æ–¹å¼ï¼Œå®é™…ä½¿ç”¨æ—¶å­˜åœ¨å¦‚ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š\n  å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æ‰“å¼€çš„åº”ç”¨ç¨‹åºçª—å£å¯èƒ½ä¼šå¾ˆå¤šï¼Œæ¯”å¦‚rtxï¼Œå„ç§ideï¼Œå„ç§ç»ˆç«¯â€¦â€¦è¿™æ ·alt+tabåˆ‡å‡ æ¬¡ä¹‹åå°±éš¾å—äº†ï¼Œéœ€è¦æ‰‹åŠ¨å°†ä¸¤ä¸ªæµè§ˆå™¨çª—å£ç»™é€‰æ‹©å‡ºæ¥å¹¶æ’æ˜¾ç¤ºã€‚ä¸å¥½ç”¨ï¼\n  å·¥ä½œä¸­ï¼Œå¯èƒ½å·¥ä½œç”¨çš„webæ ‡ç­¾é¡µæœ‰å¾ˆå¤šï¼Œå„ç§è¿ç»´å¹³å°ï¼Œå„ç§è§†å›¾ï¼Œå„ç§ç®¡ç†åå°â€¦â€¦å¦‚æœåœ¨æµè§ˆå™¨çª—å£ä¸­é€‰æ‹©äº†å…¶ä»–çš„tabï¼Œå†æ¬¡åˆ‡æ¢å›ä¹‹å‰çš„tabæ¯”è¾ƒå›°éš¾ï¼Œä¹Ÿä¸å®¹æ˜“å›åˆ°åˆå§‹çš„å¹¶æ’æ˜¾ç¤ºçŠ¶æ€ã€‚ä¸å¥½ç”¨ï¼\n  è§£å†³æ–¹æ¡ˆ # ä¸ªäººæ„Ÿè§‰è¿˜æ˜¯åŒä¸€ä¸ªtabä¸‹èƒ½å¤Ÿvsplitã€splitæ¯”è¾ƒæ–¹ä¾¿ï¼Œchromeç½‘ä¸Šåº”ç”¨å•†åº—æ‰¾ä¸åˆ°åˆé€‚çš„äº†ï¼Œgoogleäº†ä¸€ä¸‹ï¼Œæ‰¾åˆ°å¦ä¸€æ¬¾æ‰©å±•ï¼š\u0026ldquo;Frame two pages\u0026rdquo;ï¼Œè¿™ä¸ªæ’ä»¶åœ¨åŠŸèƒ½ä¸Šèƒ½æ»¡è¶³éœ€è¦ï¼Œèƒ½å¤Ÿå®ç°åŒä¸€ä¸ªtabä¸‹vsplitã€splitï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nä½†æ˜¯å…¶åœ¨ä½¿ç”¨æ—¶æ¯”è¾ƒç¹çï¼Œå½“æˆ‘ä»¬æ‰“å¼€ä¸€ä¸ªwebé¡µé¢ï¼Œå¸Œæœ›å¯¹å…¶è¿›è¡Œvsplitæ“ä½œæ—¶ï¼Œé¡µé¢ä¼šå¼¹å‡ºä¸€ä¸ªæç¤ºçª—å£ï¼Œè¾“å…¥splitæ–¹å¼ï¼Œç„¶åä¼šæ‰§è¡Œå¯¹åº”çš„åˆ†å‰²æ–¹å¼ï¼Œçœ‹ä¸Šå»ä¸é”™ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªé—®é¢˜è®©äººç”¨èµ·æ¥å¾ˆéš¾å—ï¼š\n æ²¡æœ‰è€ƒè™‘æµè§ˆå™¨çš„X-Frame-Optionså¯¹iframeçš„å½±å“ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šâ€œè«åå…¶å¦™â€åœ°splitå¤±è´¥ï¼Œæ¯”å¦‚æˆ‘æ­£åœ¨å†™è¿™ç¯‡æ–‡ç« ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹vsplitä»€ä¹ˆæ•ˆæœï¼Œå¦‚ä¸‹å›¾ï¼Œå¹¶æ²¡æœ‰æˆåŠŸvsplitï¼›   ä¸å®ç”¨ï¼Œå¦‚æœé€‰æ‹©çš„tabç´¢å¼•indexå¤§äº0ï¼Œä¼šå°†index-1å’Œindexè¿›è¡Œå¹¶æ’å±•ç¤ºï¼Œè‡³å°‘ä¸æˆ‘çš„é¡µé¢åˆ†å‰²çš„åˆè¡·ä¸ä¸€è‡´ï¼›  äºæ˜¯ä¹ï¼Œæˆ‘æƒ³æ”¹è¿›ä¸‹è¿™ä¸ªæ’ä»¶ä¸ºæˆ‘æ‰€ç”¨ï¼Œè¯´ä¸å®šä¹Ÿå¯ä»¥æ–¹ä¾¿å¤§å®¶ï¼Œæœ¬ç€ä¸é‡å¤é€ è½®å­çš„åŸåˆ™ï¼Œå®‰è£…ä¸Šäº†è¿™ä¸ªFrame two pagesæ‰©å±•çœ‹äº†ä¸‹å®ƒçš„ä»£ç ï¼Œäº†è§£äº†chromeæ‰©å±•çš„å¤§è‡´å†™æ³•ï¼Œç„¶åå¯¹å…¶è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼ŒåŸºæœ¬ç¬¦åˆæˆ‘çš„åŠŸèƒ½æ€§è¦æ±‚ã€‚\nè®¾è®¡å®ç° # ç°åœ¨å®ç°çš„åŠŸèƒ½åŒ…æ‹¬ï¼š\n1ï¼‰ç‚¹å‡»æ’ä»¶æŒ‰é’®ï¼Œé€‰æ‹©splitæ–¹å¼ï¼Œæ”¯æŒå¯¹å½“å‰å·²ç»æ‰“å¼€çš„webé¡µé¢è¿›è¡Œsplitã€vsplitåˆ†å‰²ã€‚\nä»¥å‚ç›´åˆ†å‰²å½“å‰webé¡µé¢ä¸ºä¾‹ï¼Œé¦–å…ˆç‚¹å‡»æ‰©å±•å›¾æ ‡ï¼Œé€‰æ‹©åˆ†å‰²æ–¹å¼ä¸ºverticalåˆ†å‰²ã€‚\nå°±å¾—åˆ°äº†å¦‚ä¸‹æ•ˆæœçš„åˆ†å‰²é¡µé¢ï¼Œè¿™ä¸ªé¡µé¢æ˜¯åœ¨åŸé¡µé¢tabä¹‹ååˆ›å»ºçš„ä¸€ä¸ªtabï¼Œä¸å½±å“åŸæ¥çš„tabã€‚\n2ï¼‰å¿½ç•¥æ‰€æœ‰é¡µé¢çš„X-Frame-Optionsé€‰é¡¹ï¼Œä¿è¯å¯ä»¥æ‰“å¼€é¡µé¢ï¼ˆä¸ºäº†å®‰å…¨ä½¿ç”¨è€…è‡ªå·±å†³å®šç”¨ä¸ç”¨å§ï¼‰ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿æˆ‘æˆ‘å¿½ç•¥æ‰äº†æ‰€æœ‰çš„X-Frame-Optionsï¼Œä½¿å¾—iframeå¯ä»¥æ­£å¸¸åŠ è½½ã€‚\n3ï¼‰æŸäº›æƒ…å†µä¸‹å¯èƒ½å¸Œæœ›åˆ†å‰²çš„ä¸¤éƒ¨åˆ†åˆ†åˆ«å±•ç¤ºä¸åŒçš„é¡µé¢ï¼Œä¹Ÿæ˜¯æ”¯æŒçš„ï¼Œéœ€è¦åœ¨ä¸€ä¸ªç©ºç™½çš„tabé¡µä¸Šç‚¹å‡»é¡µé¢åˆ†å‰²ï¼Œæ­¤æ—¶ä¼šå±•ç¤ºå‡ºå¦‚ä¸‹è¾“å…¥urlçš„è¾“å…¥æ¡†ï¼Œç„¶åç‚¹å‡»ä¸‹æ–¹çš„æŒ‰é’®å°±å¯ä»¥äº†ã€‚\næ¯”å¦‚ä¸€ä¸ªè¿›ç™¾åº¦ï¼Œä¸€ä¸ªè¿›googleã€‚\n4ï¼‰æˆ‘è§‰å¾—å­˜åœ¨è¿™æ ·çš„ä½¿ç”¨æƒ…æ™¯ï¼Œæ¯”å¦‚æ­£åœ¨çœ‹ä¸€ä¸ªåšå®¢æ—¶ï¼Œå¸Œæœ›æ‰“å¼€æœç´¢å¼•æ“æ£€ç´¢éƒ¨åˆ†ä¿¡æ¯ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯æ‰“å¼€ä¸€ä¸ªæ–°çš„æ ‡ç­¾é¡µè¿›æœç´¢å¼•æ“ï¼Œçœ‹å®Œæœç´¢ç»“æœåå†è·³å›åŸæ¥çš„tabâ€¦â€¦é˜…è¯»æœŸé—´å¯èƒ½è¦å¤šæ¬¡è·³æ¥è·³å»â€¦â€¦å¸Œæœ›èƒ½åœ¨å·²ç»æˆåŠŸvsplitã€splitçš„é¡µé¢é‡Œé¢ï¼Œå°†å…¶ä¸­ä¸€ä¸ªresetå…è®¸æˆ‘ä»¬é‡æ–°è¾“å…¥urlæ‰“å¼€æ–°çš„é¡µé¢ã€‚\näºæ˜¯ä¸ºè¿™ä¸ªæ’ä»¶åŠ äº†èœå•ï¼š\nä»¥é‡ç½®vsplitåçš„å·¦åŠéƒ¨åˆ†é¡µé¢ä¸ºä¾‹ï¼Œé€‰æ‹©â€œSplit Page -\u0026gt; Reset left/top pageâ€ã€‚\nå·¦åŠéƒ¨åˆ†å°±è¢«é‡ç½®åˆ°é‡æ–°è¾“å…¥urlçš„çŠ¶æ€äº†ï¼Œæ¯”å¦‚å¸Œæœ›è¿›å…¥googleï¼Œè¾“å…¥googleç½‘å€ï¼Œç‚¹å‡»è·³è½¬æŒ‰é’®å³å¯ã€‚\næ€»ç»“ # ç®€è¦äº†è§£äº†chrome extensionçš„å¼€å‘è¿‡ç¨‹ï¼Œchromeä¸åŒçš„ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹ä¸­å¢åŠ äº†å¾ˆå¤šå®‰å…¨é™åˆ¶ï¼Œå¼€å‘ã€è°ƒè¯•è¿‡ç¨‹ä¸­è¦å¤šæ³¨æ„ã€‚è¿™åªæ˜¯ä¸ºäº†å¹³æ—¶é˜…è¯»ä»£ç æ–¹ä¾¿äºŒæ¬¡å¼€å‘çš„ä¸€ä¸ªå°å·¥å…·ï¼Œå¦å¤–å¯¹jsäº†è§£çš„ä¸å¤šï¼Œå¯èƒ½å­˜åœ¨bugï¼Œä¹Ÿæ¬¢è¿åé¦ˆã€‚\næ„Ÿå…´è¶£çš„å¯ä»¥ä»githubä¸‹è½½è¿›è¡Œä½“éªŒï¼Œä»“åº“åœ°å€ï¼šhttps://github.com/hitzhangjie/PageSplitã€‚\n"}),a.add({id:356,href:"/tags/extension/",title:"extension",description:"",content:""}),a.add({id:357,href:"/tags/hsplit/",title:"hsplit",description:"",content:""}),a.add({id:358,href:"/tags/pagesplit/",title:"pagesplit",description:"",content:""}),a.add({id:359,href:"/tags/vsplit/",title:"vsplit",description:"",content:""}),a.add({id:360,href:"/blog/2017-10-14-assembly-language/",title:"Assembly Language",description:"ç°åœ¨é«˜çº§è¯­è¨€è¿™ä¹ˆæ–¹ä¾¿ã€ç¼–è¯‘å™¨è¿™ä¹ˆç‰›ï¼Œè¿˜éœ€è¦æŒæ¡æ±‡ç¼–è¯­è¨€å—ï¼Ÿæˆ‘è®¤ä¸ºéœ€è¦ï¼Œè‡³å°‘è¦èƒ½çœ‹æ‡‚ï¼Œæœ‰äº›å¯¹æ€§èƒ½è¦æ±‚å¾ˆé«˜ã€å¸Œæœ›è°ƒä¼˜çš„åœºæ™¯ä¸‹ï¼Œå¯èƒ½è¦ç›´æ¥ç”¨æ±‡ç¼–æ¥å®ç°ï¼Œå¦‚å­—ç¬¦ä¸²æ‹·è´ï¼Œç­‰ç­‰ã€‚è€Œä¸”é«˜çº§è¯­è¨€å€ŸåŠ©ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ï¼Œæœ‰æ—¶ä¹Ÿå­˜åœ¨å±€é™æ€§ï¼Œæ¯”å¦‚æœ‰éœ€è¦å¼€å…³ä¸­æ–­çš„åœºæ™¯ï¼Œå°±å¿…é¡»è¦å€ŸåŠ©å†…è”æ±‡ç¼–ã€‚æ‰€ä»¥æŒæ¡æ±‡ç¼–è‡³å°‘ä¸æ˜¯ä¸€ä»¶åäº‹ã€‚",content:"å¤„ç†å™¨æ˜¯ç®—é€»è¿ç®—ã€æ§åˆ¶æ“ä½œçš„æ‰§è¡Œéƒ¨ä»¶ï¼Œå®ƒåªèƒ½è¯†åˆ«æœºå™¨æŒ‡ä»¤å¹¶æ‰§è¡ŒåŠ¨ä½œã€‚æœºå™¨æŒ‡ä»¤æ˜¯ä¸€ç³»åˆ—çš„0ã€1å­—ç¬¦ä¸²ï¼Œæœ¬è´¨ä¸Šå¯¹åº”äº†æ€»çº¿ä¸Šçš„é«˜ä½ç”µå¹³ä¿¡å·ï¼Œæ‰€ä»¥æœºå™¨è¯­è¨€éƒ½æ˜¯ç‰¹å®šäºç¡¬ä»¶çš„ã€‚\nç”±äº0ã€1å­—ç¬¦ä¸²å¾ˆéš¾è®°å¿†ï¼Œç”¨æœºå™¨è¯­è¨€å¼€å‘æ˜¯ä¸€ä¸ªè€å¤§éš¾çš„é—®é¢˜ï¼Œæ±‡ç¼–è¯­è¨€å› æ­¤è¢«å¼€å‘å‡ºæ¥ç”¨äºä»£æ›¿æœºå™¨è¯­è¨€ã€‚æ±‡ç¼–æŒ‡ä»¤åªæ˜¯æœºå™¨æŒ‡ä»¤ä¸­æ“ä½œç çš„åŠ©è®°ç¬¦ï¼Œå› æ­¤æ±‡ç¼–è¯­è¨€ä»ç„¶æ˜¯æœºå™¨å¼ºç›¸å…³çš„ï¼Œä¸åŒçš„å¤„ç†å™¨å…¶å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ä¹Ÿä¸åŒã€‚\nå­¦ä¹ æ±‡ç¼–è¯­è¨€æœ‰åŠ©äºç†è§£ï¼š\n ç¨‹åºæ˜¯å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿã€å¤„ç†å™¨ã€biosè¿›è¡Œäº¤äº’çš„ï¼› æ•°æ®å¦‚ä½•åœ¨å†…å­˜ä¸­ä»¥åŠå¤–è®¾ä¸­è¡¨ç¤ºçš„ï¼› å¤„ç†å™¨å¦‚ä½•è®¿é—®ã€æ‰§è¡ŒæŒ‡ä»¤ï¼› æŒ‡ä»¤å¦‚ä½•è®¿é—®ã€å¤„ç†æ•°æ®ï¼› ç¨‹åºå¦‚ä½•è®¿é—®å¤–è®¾ï¼›  å…¶ä»–ä½¿ç”¨æ±‡ç¼–è¯­è¨€çš„ä¼˜åŠ¿ï¼š\n æ¶ˆè€—æ›´å°‘çš„å†…å­˜å’Œå¤„ç†å™¨æ‰§è¡Œæ—¶é—´ï¼› å…è®¸ä»¥æ›´ç®€å•çš„æ–¹å¼æ¥å®Œæˆç¡¬ä»¶ç‰¹å®šçš„å¤æ‚ä½œä¸šï¼› é€‚ç”¨äºæ—¶é—´æ•æ„Ÿçš„ä½œä¸šï¼› é€‚ç”¨äºç¼–å†™ä¸­æ–­æœåŠ¡ç¨‹åºå’Œå†…å­˜é©»ç•™ç¨‹åºï¼›  1.1 PCç¡¬ä»¶çš„åŸºæœ¬ç‰¹å¾ # æœºå™¨æŒ‡ä»¤æ˜¯0ã€1å­—ç¬¦ä¸²ï¼Œåˆ†åˆ«è¡¨ç¤ºONã€OFFï¼Œå¯¹åº”æ•°å­—ä¿¡å·çš„é«˜ä½ç”µå¹³ã€‚æœºå™¨ä¸­çš„æœ€ä½å­˜å‚¨å•ä½æ˜¯bitï¼Œé€šå¸¸8bitæ„æˆä¸€ä¸ªbyteï¼Œä¸ºäº†å¯¹æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ä¼ è¾“æ•°æ®çš„æœ‰æ•ˆæ€§è¿›è¡Œæ£€æŸ¥ï¼Œé€šå¸¸ä¼šåœ¨æ•°æ®byteå‘é€ä¹‹åå†è¿½åŠ ä¸€ä¸ªå¥‡å¶æ ¡éªŒbitã€‚\n å¥‡æ ¡éªŒï¼šä¿è¯8bitæ•°æ®+1bitæ ¡éªŒä½ä¸­çš„1çš„ä¸ªæ•°ä¸ºå¥‡æ•°ï¼› å¶æ ¡éªŒï¼šä¿è¯8bitæ•°æ®+1bitæ ¡éªŒä½ä¸­çš„1çš„ä¸ªæ•°ä¸ºå¶æ•°ï¼›  å‘é€æ–¹ã€æ¥æ”¶æ–¹éµå¾ªç›¸åŒçš„å¥‡å¶æ ¡éªŒè§„åˆ™ï¼Œå¦‚æœæ¥æ”¶æ–¹æ”¶åˆ°æ•°æ®åå‘ç°å¥‡å¶æ ¡éªŒä¸æ­£ç¡®ï¼Œåˆ™è¡¨ç¤ºå¯èƒ½ç¡¬ä»¶å‡ºé”™ï¼Œæˆ–è€…å‡ºç°äº†ç”µå¹³æ‰°åŠ¨ã€‚\nå¤„ç†å™¨æ”¯æŒå¦‚ä¸‹æ•°æ®å°ºå¯¸ï¼š\n|:\u0026mdash;|:\u0026mdash;\u0026mdash;| |Word|2 bytes| |Doubleword|4 bytes| |Quadword|8 bytes| |Paragraph|16 bytes| |Kilobyte|2^10 bytes| |Megabyte|2^20 bytes|\näºŒè¿›åˆ¶ \u0026amp; åå…­è¿›åˆ¶ç³»ç»Ÿï¼š\näºŒè¿›åˆ¶å¤©ç„¶é€‚ç”¨äºè®¡ç®—æœºè®¡ç®—é¢†åŸŸï¼Œ0ã€1åˆšå¥½ä»£è¡¨æ•°å­—ç”µè·¯ä¸­çš„é«˜ä½ç”µå¹³ï¼›è€Œåå…­è¿›åˆ¶æ˜¯ç”¨äºå¯¹æ¯”è¾ƒé•¿çš„äºŒè¿›åˆ¶æ•°å€¼è¿›è¡Œæ›´åŠ ä¼˜é›…åœ°ç®€å†™ï¼Œä½¿æˆ‘ä»¬è¡¨ç¤ºèµ·æ¥æ›´åŠ æ¸…æ™°ã€ç®€å•ã€‚\näºŒè¿›åˆ¶ã€åå…­è¿›åˆ¶çš„ç›¸å…³è¿ç®—ï¼Œç‰¹åˆ«æ˜¯æ¶‰åŠåˆ°åŸç ã€åç ã€è¡¥ç ã€ç§»ç çš„è¿ç®—ï¼Œéœ€è¦é‡ç‚¹äº†è§£ä¸‹ï¼Œå»ºè®®å‚è€ƒã€Šè®¡ç®—æœºç»„æˆåŸç†ã€‹ç›¸å…³ç« èŠ‚ã€‚\nè®¿é—®å†…å­˜ä¸­çš„æ•°æ®ï¼š\nå¤„ç†å™¨æ§åˆ¶æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸ºâ€å–æŒ‡ä»¤-æŒ‡ä»¤ç§»ç -æŒ‡ä»¤æ‰§è¡Œâ€œçš„å¾ªç¯ä½“ï¼Œä¸€ä¸ªâ€å–æŒ‡ä»¤-æŒ‡ä»¤è¯‘ç -æŒ‡ä»¤æ‰§è¡Œâ€œå‘¨æœŸç§°ä¹‹ä¸ºä¸€ä¸ªæœºå™¨å‘¨æœŸã€‚\n å–æŒ‡å‘¨æœŸï¼šæ ¹æ®CSã€IPä»å†…å­˜æŒ‡å®šä½ç½®å–æŒ‡ä»¤ï¼Œå¹¶å­˜å‚¨åˆ°æŒ‡ä»¤å¯„å­˜å™¨IRï¼› è¯‘ç å‘¨æœŸï¼šæ ¹æ®IRä¸­çš„æŒ‡ä»¤ï¼Œåˆ†æå‡ºæ“ä½œç OPã€æ“ä½œæ•°æˆ–æ“ä½œæ•°åœ°å€ï¼› æ‰§è¡Œå‘¨æœŸï¼šæ ¹æ®åˆ†æå‡ºçš„OPã€æ“ä½œæ•°æˆ–æ“ä½œåœ°å€ä¿¡æ¯æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œï¼›  Intelæ¶æ„çš„å¤„ç†å™¨åœ¨å†…å­˜ä¸­å­˜å‚¨æ—¶æ˜¯é‡‡ç”¨çš„å°ç«¯å­—èŠ‚åºï¼Œæ„å‘³ç€ä¸€ä¸ªå¤šå­—èŠ‚æ•°å€¼çš„ä½å­—èŠ‚éƒ¨åˆ†å°†åœ¨ä½åœ°å€å­˜å‚¨ï¼Œé«˜å­—èŠ‚éƒ¨åˆ†å°†åœ¨é«˜åœ°å€å­˜å‚¨ï¼Œä½†æ˜¯åœ¨å¤„ç†å™¨å¯„å­˜å™¨ä¸­å­˜å‚¨æ—¶ä½å­—èŠ‚éƒ¨åˆ†å°±åœ¨ä½å­—èŠ‚ï¼Œé«˜å­—èŠ‚éƒ¨åˆ†å°±åœ¨é«˜å­—èŠ‚ï¼Œæ‰€ä»¥åœ¨å¤„ç†å™¨å¯„å­˜å™¨ã€å†…å­˜ä¹‹é—´å­˜å‚¨ã€åŠ è½½æ•°æ®æ—¶éœ€è¦åšå­—èŠ‚åºæ–¹é¢çš„è½¬æ¢ã€‚\nä»¥å¤„ç†å™¨å¯„å­˜å™¨ä¸­æ•°å€¼0x1234ä¸ºä¾‹ï¼Œç°åœ¨è¦å°†å…¶å­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œå¤„ç†å™¨å…ˆå°†0x34å­˜å‚¨åˆ°å†…å­˜ä½åœ°å€ï¼Œç„¶åå†è§0x12å­˜å‚¨åˆ°å†…å­˜é«˜åœ°å€ï¼›å‡å¦‚å†…å­˜ä¸­æœ‰æ•°æ®0xabcdï¼Œç°åœ¨è¦å°†å…¶åŠ è½½åˆ°å¤„ç†å™¨å¯„å­˜å™¨ä¸­ï¼ŒåŠ è½½æ—¶ä¹Ÿä¼šåšå¯¹åº”çš„å¤„ç†ï¼Œå°†0xabæ”¾åœ¨å¯„å­˜å™¨é«˜ä½ï¼Œå°†0xcdæ”¾åœ¨å¯„å­˜å™¨ä½ä½ã€‚\næŒ‡ä»¤ä¸­çš„æ“ä½œæ•°åœ°å€ï¼Œåˆæœ‰å¤šç§ä¸åŒçš„å¯»å€æ–¹å¼ï¼Œç«‹å³æ•°å¯»å€ã€ç›´æ¥å¯»å€ã€é—´æ¥å¯»å€ã€å¯„å­˜å™¨å¯»å€ç­‰ï¼Œè¿™é‡Œåé¢ä¼šåšç›¸åº”çš„ä»‹ç»ã€‚\n1.2 å¼€å‘ç¯å¢ƒé…ç½® # æ±‡ç¼–æŒ‡ä»¤ç‰¹å®šäºå¤„ç†å™¨çš„ï¼Œå› æ­¤ä¸åŒçš„å¤„ç†å™¨ç³»åˆ—ã€å‹å·å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤å¯èƒ½ä¹Ÿä¼šæœ‰å·®å¼‚ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯Intel-32æ¶æ„çš„å¤„ç†å™¨ï¼Œä½¿ç”¨æ±‡ç¼–å™¨NASMè¿›è¡Œæ±‡ç¼–æ“ä½œï¼Œå…¶ä»–å¯é€‰çš„æ±‡ç¼–å™¨è¿˜æœ‰MASMã€TASMã€GASç­‰ã€‚\n1.3 åŸºæœ¬è¯­æ³• # æ±‡ç¼–ç¨‹åºé€šå¸¸åŒ…æ‹¬3ä¸ªèŠ‚ï¼Œåˆ†åˆ«æ˜¯dataã€bssã€textèŠ‚ï¼š\n dataï¼Œç”¨äºå£°æ˜åˆå§‹åŒ–çš„å˜é‡å’Œå¸¸é‡ï¼› bssï¼Œç”¨äºå£°æ˜æœªåˆå§‹åŒ–çš„å˜é‡ï¼Œè¿™éƒ¨åˆ†ä¸ä¼šå‡ºç°åœ¨ç¼–è¯‘åçš„ç¨‹åºä¸­ï¼› textï¼Œç”¨äºä¿å­˜ç¨‹åºæŒ‡ä»¤ï¼›  textèŠ‚ä¸­å¿…é¡»åŒ…æ‹¬\u0026quot;global ${entry}\u0026ldquo;å£°æ˜ï¼Œ${entry}æ˜¯ç¨‹åºå…¥å£ï¼Œé€šå¸¸å®šä¹‰æœª_startï¼Œè§æ–‡ç”Ÿä¹‰å˜›ã€‚\næ±‡ç¼–ç¨‹åºä¸­çš„æ³¨é‡Šå‡ä»¥\u0026rdquo;;\u0026ldquo;å¼€å¤´ï¼Œç›´åˆ°æ‰€åœ¨è¡Œç»“æŸã€‚\næ±‡ç¼–è¯­è¨€ç¨‹åºåŒ…æ‹¬3ç§ä¸åŒç±»å‹çš„è¯­å¥ï¼š\n å¯æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤ï¼› ä¼ é€’ç»™æ±‡ç¼–å™¨çš„æŒ‡ä»¤æˆ–ä¼ªæ“ä½œï¼› å®ï¼›  æ±‡ç¼–è¯­è¨€è¯­å¥éµå¾ªå¦‚ä¸‹ç»“æ„ï¼š\n[æ ‡è¯†] åŠ©è®°ç¬¦ [æ“ä½œæ•°] [;æ³¨é‡Š]   []å†…éƒ¨çš„éƒ¨åˆ†æ˜¯å¯é€‰çš„ï¼Œå°¤å…¶æ˜¯æ ‡è¯†å’Œæ³¨é‡Šéƒ¨åˆ†ï¼Œæ ¹æ®æ±‡ç¼–æŒ‡ä»¤çš„ä¸åŒï¼Œæœ‰æ— æ“ä½œæ•°ã€æ“ä½œæ•°ä¸ªæ•°ã€æ“ä½œæ•°ç±»å‹ç­‰å‡æœ‰æ‰€ä¸åŒã€‚æ±‡ç¼–æŒ‡ä»¤ä¸­åŒ…æ‹¬äº†æ“ä½œç å’Œæ“ä½œæ•°ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œçš„åŠ©è®°ç¬¦å…¶å®å°±æ˜¯æ“ä½œç çš„ç¬¦å·è¡¨ç¤ºã€‚\n ä¸‹é¢æ˜¯åº”ç”¨äº†ä¸Šè¿°åŸºæœ¬è¯­æ³•çš„ç¤ºä¾‹ç¨‹åºï¼š\nhello.asm\nsection	.text global _start ;must be declared for linker (ld) _start:	;tells linker entry point mov	edx,len ;message length mov	ecx,msg ;message to write mov	ebx,1 ;file descriptor (stdout) mov	eax,4 ;system call number (sys_write) int	0x80 ;call kernel mov	eax,1 ;system call number (sys_exit) int	0x80 ;call kernel section	.data msg db 'Hello, world!', 0xa ;string to be printed len equ $ - msg ;length of the string  åœ¨Linuxå¹³å°ä¸‹ç”±æ±‡ç¼–æ–‡ä»¶æ„å»ºå¯æ‰§è¡Œç¨‹åºåŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š\n æ±‡ç¼–ï¼Œnasm -f elf -o hello.o hello.asm è¿æ¥ï¼Œld -m elf_i386 -e _start -o hello hello.o  æ„å»ºå®Œæˆï¼Œå³å¯åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ./helloæ¥è¿›è¡Œæµ‹è¯•ã€‚\n1.4 å†…å­˜åˆ†æ®µ # å‰é¢ä¸€èŠ‚ä»‹ç»äº†æ±‡ç¼–è¯­è¨€ä¸­çš„sectionï¼ˆèŠ‚ï¼‰ï¼Œè¿™äº›èŠ‚ä¹Ÿä»£è¡¨ç€å„ç§å„æ ·çš„å†…å­˜segmentï¼ˆæ®µï¼‰ã€‚å°†å‰é¢ç¤ºä¾‹ä»£ç hello.asmä¸­çš„sectionå…³é”®å­—ç”¨segmentä»£æ›¿ï¼Œä¾ç„¶å¯ä»¥ç”¨ç›¸åŒçš„æ–¹æ³•æ„å»ºæˆåŠŸå¹¶å¾—åˆ°ç›¸åŒçš„æµ‹è¯•ç»“æœã€‚\næ±‡ç¼–è¯­è¨€ä¸­å¸¸è§çš„segmentï¼ˆæ®µï¼‰åŒ…æ‹¬ï¼š\n data segmentï¼Œæ•°æ®æ®µä»£è¡¨äº†data sectionå’Œbss sectionã€‚å…¶ä¸­data sectionç”¨äºå­˜å‚¨åˆå§‹åŒ–åçš„å…¨å±€å˜é‡å’Œå…¨å±€å˜é‡ï¼›bss sectionç”¨äºå£°æ˜æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ä¼šè¢«åˆå§‹åŒ–æœª0å€¼ã€‚ code segmentï¼Œä»£ç æ®µä¹Ÿå°±æ˜¯textèŠ‚ï¼Œç”¨äºå­˜å‚¨ç¨‹åºæŒ‡ä»¤ï¼› stack segmentï¼Œå †æ ˆæ®µç”¨äºåˆ†é…ä¸´æ—¶å˜é‡ã€è°ƒç”¨å‡½æ•°æ—¶ä¼ é€’å‚æ•°ä¿¡æ¯ç­‰ï¼›  1.5 å¯„å­˜å™¨ # å¤„ç†å™¨ä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œè®¡ç®—ï¼Œè®¡ç®—æ‰€éœ€è¦çš„æ•°æ®æ¥è‡ªäºå†…å­˜ï¼Œä½†æ˜¯å¤„ç†å™¨å­˜å–å†…å­˜æ•°æ®éœ€è¦çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œä¸ºäº†ALUåŠ é€Ÿå­˜å–æ“ä½œæ•°ï¼Œå¤„ç†å™¨é‡Œé¢å†…ç½®äº†å¯„å­˜å™¨ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®å…ˆåŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œç„¶åALUå¯¹å¯„å­˜å™¨ä¸­çš„æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œæœ€åå†å°†è®¡ç®—ç»“æœæ¬å›å†…å­˜ã€‚\nå¤„ç†å™¨ä¸­çš„å¯„å­˜å™¨ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å‡ ç±»ï¼š\n é€šç”¨ç›®çš„å¯„å­˜å™¨ï¼ŒåŒ…æ‹¬æ•°æ®å¯„å­˜å™¨ï¼ˆEAXã€EBXã€ECXã€EDXï¼‰ã€æŒ‡é’ˆå¯„å­˜å™¨ï¼ˆEIPã€ESPã€EBPï¼‰ã€ç´¢å¼•å¯„å­˜å™¨ï¼ˆESIã€EDIï¼‰ï¼›   å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå½¢æˆæ ˆå¸§ï¼Œebpå¯„å­˜å™¨æŒ‡å‘çš„æ˜¯æ ˆå¸§çš„æ ˆåº•ï¼ŒespæŒ‡å‘çš„å€¼æ ˆå¸§çš„æ ˆé¡¶ã€‚é€šè¿‡ebpä¾¿äºå®šä½ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ã€è¿”å›åœ°å€ä¿¡æ¯ï¼Œæ ˆå¸§å¼€å§‹æ„å»ºçš„æ—¶å€™ï¼Œé¦–å…ˆå°±ä¼šå°†callerçš„ebpå‹æ ˆï¼Œç„¶åå°†å½“å‰æ ˆå¸§æ ˆé¡¶espèµ‹å€¼ç»™ebpä½œä¸ºæ–°çš„æ ˆå¸§çš„æ ˆåº•ï¼Œåé¢espå‡å»ä¸€ä¸ªå€¼N,[esp-N,ebpï¼‰å°±æ˜¯æ–°çš„æ ˆç©ºé—´ã€‚\n  æ®µå¯„å­˜å™¨ï¼ŒåŒ…æ‹¬ECSã€ESSã€EDSï¼›   8086é‡Œé¢ï¼ŒCSåŒ…æ‹¬ä»£ç æ®µçš„èµ·å§‹åœ°å€ï¼Œä»80386è¿›å…¥ä¿æŠ¤æ¨¡å¼å¼€å§‹ï¼ŒCSé‡Œé¢å˜æˆäº†æ®µé€‰æ‹©ç¬¦ï¼Œå…·ä½“çš„ä»£ç æ®µèµ·å§‹åœ°å€è¦åˆ°gdbé‡Œé¢å»æŸ¥ã€‚DSå­˜å‚¨æ•°æ®æ®µçš„èµ·å§‹åœ°å€ï¼ŒSSå­˜å‚¨å †æ ˆæ®µçš„èµ·å§‹åœ°å€ã€‚\n  æ§åˆ¶å¯„å­˜å™¨ï¼Œ32ä½flagså¯„å­˜å™¨å’Œ32ä½æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨å…±åŒç§°ä¸ºæ§åˆ¶å¯„å­˜å™¨ã€‚   å¸¸è§çš„flagæ ‡å¿—ä½åŒ…æ‹¬ï¼šOFï¼ˆæº¢å‡ºï¼‰ã€DFï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒæ–¹å‘ï¼‰ã€IFï¼ˆæ˜¯å¦å…è®¸ä¸­æ–­ï¼‰ã€TFï¼ˆæ˜¯å¦å•æ­¥æ‰§è¡Œï¼‰ã€SFï¼ˆç¬¦å·ä½ï¼‰ã€ZFï¼ˆæ¯”è¾ƒç»“æœï¼‰ã€AFï¼ˆè¾…åŠ©è¿›ä½ï¼‰ã€PFï¼ˆ1æ•°é‡æ˜¯å¦ä¸ºå¥‡æ•°ï¼‰ã€CFï¼ˆæ˜¯å¦è¿›ä½ï¼‰ã€‚\n ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨å¤šä¸ªå¯„å­˜å™¨çš„ç¤ºä¾‹ç¨‹åºï¼š\nsection	.text global _start	;must be declared for linker (gcc) _start:	;tell linker entry point mov	edx,len ;message length mov	ecx,msg ;message to write mov	ebx,1 ;file descriptor (stdout) mov	eax,4 ;system call number (sys_write) int	0x80 ;call kernel mov	edx,9 ;message length mov	ecx,s2 ;message to write mov	ebx,1 ;file descriptor (stdout) mov	eax,4 ;system call number (sys_write) int	0x80 ;call kernel mov	eax,1 ;system call number (sys_exit) int	0x80 ;call kernel section	.data msg db 'Displaying 9 stars',0xa ;a message len equ $ - msg ;length of message s2 times 9 db '*'  1.6 ç³»ç»Ÿè°ƒç”¨ # ç³»ç»Ÿè°ƒç”¨æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„ç”¨æˆ·æ€ã€å†…æ ¸æ€ä¹‹é—´çš„æ¥å£ï¼Œç”¨æˆ·æ€é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®å†…æ ¸æœåŠ¡ã€‚\nå¦‚ä½•é€šè¿‡åœ¨æ±‡ç¼–ç¨‹åºé‡Œé¢ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å‘¢ï¼Ÿ\n åœ¨EAXå¯„å­˜å™¨é‡Œé¢è®¾ç½®ç³»ç»Ÿè°ƒç”¨å·ï¼› åœ¨EBXã€ECXã€EDXã€ESIã€EDIã€EBPä¸­è®¾ç½®ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼ˆå¦‚æœå‚æ•°æ•°é‡è¶…è¿‡6ä¸ªï¼Œåˆ™éœ€ç‰¹æ®Šå¤„ç†ï¼‰ï¼› è°ƒç”¨ä¸­æ–­æœåŠ¡int 0x80ï¼ˆç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯é€šè¿‡ä¸­æ–­æœåŠ¡çš„å½¢å¼å®ç°ï¼ŒintæŒ‡ä»¤ä½¿å¾—å¤„ç†å™¨ä»ring3åˆ‡æ¢åˆ°ring0ï¼Œiretä½¿å¤„ç†å™¨ä»ring0åˆ‡æ¢å›ring3ï¼‰ï¼› ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼é€šå¸¸ä¿å­˜åœ¨EAXä¸­ï¼›  Linuxä¸‹çš„ç³»ç»Ÿè°ƒç”¨å®šä¹‰åœ¨/usr/include/asm/unistd.hä¸­ï¼Œå¯ä»¥ä»ä¸­æŸ¥çœ‹ç³»ç»Ÿè°ƒç”¨åç§°ä»¥åŠç¼–å·ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç»¼åˆä½¿ç”¨ç³»ç»Ÿè°ƒç”¨readã€writeã€exitçš„ä¾‹å­ï¼Œç¨‹åºæç¤ºç”¨æˆ·è¾“å…¥ä¸€ä¸ªæ•°å­—å¹¶è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œç„¶åå›æ˜¾è¯¥æ•°å­—ã€‚\nsection .data ;Data segment userMsg db 'Please enter a number: ' ;Ask the user to enter a number lenUserMsg equ $-userMsg ;The length of the message dispMsg db 'You have entered: ' lenDispMsg equ $-dispMsg section .bss ;Uninitialized data num resb 5 section .text ;Code Segment global _start _start: ;User prompt mov eax, 4 mov ebx, 1 mov ecx, userMsg mov edx, lenUserMsg int 80h ;Read and store the user input mov eax, 3 mov ebx, 2 mov ecx, num mov edx, 5 ;5 bytes (numeric, 1 for sign) of that information int 80h ;Output the message 'The entered number is: ' mov eax, 4 mov ebx, 1 mov ecx, dispMsg mov edx, lenDispMsg int 80h ;Output the number entered mov eax, 4 mov ebx, 1 mov ecx, num mov edx, 5 int 80h ; Exit code mov eax, 1 mov ebx, 0 int 80h  1.7 å¯»å€æ¨¡å¼ # æ±‡ç¼–è¯­è¨€ä¸­çš„å¯»å€æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯æŒ‡ä»¤å¯»å€ï¼Œä¸€ç±»æ˜¯æ•°æ®å¯»å€ï¼š\n æŒ‡ä»¤å¯»å€ï¼šå¤„ç†å™¨è¦æ‰§è¡Œçš„æŒ‡ä»¤å¦‚ä½•å¯»å€ï¼Œåˆ†ä¸ºé¡ºåºå¯»å€ï¼ˆé¡ºåºæ‰§è¡Œï¼Œpc+=1ï¼‰ã€è·³è·ƒå¯»å€ï¼ˆjmpï¼‰ï¼› æ•°æ®å¯»å€ï¼šæ ¹æ®æ•°æ®æ‰€åœ¨å­˜å‚¨ä½ç½®çš„ä¸åŒï¼ˆå†…å­˜æˆ–å¯„å­˜å™¨ï¼‰ï¼Œä»¥åŠåœ°å€æä¾›æ–¹å¼çš„ä¸åŒï¼Œæ•°æ®å¯»å€æ–¹å¼å¤šç§å¤šæ ·ã€‚  æ•°æ®å¯»å€æ–¹å¼è™½ç„¶å¤šæ ·ï¼Œä½†æ˜¯éƒ½éµä»å¦‚ä¸‹æŒ‡ä»¤æ ¼å¼ï¼š\n|:\u0026ndash;:|:\u0026ndash;:|:\u0026ndash;:| |æ“ä½œç OP|å¯»å€ç‰¹å¾|å½¢å¼åœ°å€A|\næ ¹æ®å¯»å€ç‰¹å¾ä»¥åŠå½¢å¼åœ°å€Aï¼Œå¯ä»¥è®¡ç®—å‡ºæ“ä½œæ•°çš„æœ‰æ•ˆåœ°å€EAï¼Œä¸åŒçš„å¯»å€ç‰¹å¾å¯¹å½¢å¼åœ°å€Aæ–½åŠ çš„è®¡ç®—è§„åˆ™ä¹Ÿä¸ä¸€æ ·ã€‚ä¸‹é¢æ€»ç»“ä¸€ä¸‹å¸¸è§çš„æ•°æ®å¯»å€æ–¹å¼ã€‚\n ç«‹å³å¯»å€ï¼ŒAæ˜¯ç«‹å³æ•°ï¼ˆå¸¸é‡ï¼‰ï¼ŒEA=Aï¼› å¯„å­˜å™¨å¯»å€ï¼ŒAæ˜¯å¯„å­˜å™¨ç¼–å·ï¼ŒEA=A=Riï¼› ç›´æ¥å†…å­˜å¯»å€ï¼ŒAä¸ºæ•°æ®åœ¨å†…å­˜ä¸­çš„æœ‰æ•ˆåœ°å€ï¼Œå³EA=Aï¼› ç›´æ¥å†…å­˜åç§»é‡å¯»å€ï¼Œç±»ä¼¼äºåŸºå€å¯»å€æ–¹å¼ï¼ŒEBXåšåŸºåœ°å€ï¼ŒAä¸ºoffsetï¼› é—´æ¥å†…å­˜å¯»å€ï¼Œ(A)ä¸ºæ•°æ®åœ¨å†…å­˜ä¸­çš„æœ‰æ•ˆåœ°å€ï¼Œå³EA=(A),é—´æ¥å†…å­˜å¯»å€å¯èƒ½è¿˜ä¼šæ¶‰åŠåˆ°å¤šé‡é—´å€ï¼›   è®¡ç®—æœºç»„æˆåŸç†ä¸­å¯èƒ½æåˆ°çš„æ•°æ®å¯»å€æ–¹å¼æ›´åŠ åé‡äºç†è®ºï¼Œå¯»å€æ–¹å¼ä¹Ÿæ›´åŠ å¤šæ ·ï¼Œå®é™…çš„æ±‡ç¼–è¯­è¨€å®ç°ä¸­å¯èƒ½å¹¶æ²¡æœ‰é€ä¸€å®ç°ï¼Œæˆ–è€…åŒºåˆ†ä¸æ˜æ˜¾ï¼Œæˆ‘ä»¬è¿™é‡Œä»å®è·µå‡ºå‘ï¼Œæ›´åŠ ä¾§é‡äºå®ç”¨è€Œä¸æ˜¯ç†è®ºï¼Œå› æ­¤åœ¨ä½¿ç”¨æœ¯è¯­çš„é€‰æ‹©ä¸Šä¹Ÿæ›´åŠ åé‡äºä¸šå†…äººå‘˜çš„åå¥½ã€‚\n åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œè·å–ä¸€ä¸ªå†…å­˜å˜é‡çš„æœ‰æ•ˆåœ°å€çš„æ–¹å¼æ˜¯ï¼š[varname]ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç»¼åˆä½¿ç”¨äº†ä¸Šè¿°å¤šç§å¯»å€æ–¹å¼çš„ç¤ºä¾‹ç¨‹åºï¼š\nsection	.text global_start ;must be declared for linker (ld) _start: ;tell linker entry point ;writing the name 'Zara Ali' mov	edx,9 ;message length mov	ecx, name ;message to write mov	ebx,1 ;file descriptor (stdout) mov	eax,4 ;system call number (sys_write) int	0x80 ;call kernel mov	[name], dword 'Nuha' ; Changed the name to Nuha Ali ;writing the name 'Nuha Ali' mov	edx,8 ;message length mov	ecx,name ;message to write mov	ebx,1 ;file descriptor (stdout) mov	eax,4 ;system call number (sys_write) int	0x80 ;call kernel mov	eax,1 ;system call number (sys_exit) int	0x80 ;call kernel section	.data name db 'Zara Ali '  1.8 å®šä¹‰å˜é‡ # æ±‡ç¼–è¯­è¨€ä¸­æä¾›äº†å¤šä¸ªæ±‡ç¼–å™¨æŒ‡ä»¤ç”¨äºå®šä¹‰å˜é‡ã€é¢„ç•™å†…å­˜ç©ºé—´ã€‚\nsection .dataï¼Œä¸ºåˆå§‹åŒ–çš„æ•°æ®åˆ†é…å­˜å‚¨ç©ºé—´:\nvarname define-directive initial-value[,initial-value2]  å¸¸ç”¨çš„define-directiveåŒ…æ‹¬DBã€DWã€DDã€DQã€DTï¼Œåˆ†åˆ«ç”¨äºå®šä¹‰1byteã€1wordã€1doublewordã€1quadwordã€10bytesdå¹¶è¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚\nsection .bssï¼Œä¸ºæœªåˆå§‹åŒ–çš„æ•°æ®åˆ†é…å­˜å‚¨ç©ºé—´ï¼š\n[varname] reserve-directive quantity  å¸¸ç”¨çš„reserve-directieæŒ‡ä»¤åŒ…æ‹¬RESBã€RESWã€RESDã€RESQã€RESTï¼Œåˆ†åˆ«ç”¨äºåˆ†é…1byteã€1wordã€1doublewordã€1quadwordã€10bytesçš„å­˜å‚¨ç©ºé—´ï¼Œç»“åˆæ“ä½œæ•°quantityå¯ä»¥è®¡ç®—å‡ºéœ€è¦åˆ†é…å¤šå°‘ç©ºé—´ã€‚\n.bssèŠ‚æ¯ä¸€ä¸ªå¯¹åº”çš„define-directiveè¯­å¥éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„reserve-directiveä¸ä¹‹å¯¹åº”ï¼Œreserve-directiveä¹Ÿå¯ä»¥å•ç‹¬å­˜åœ¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nsection .bss age db resb 1 ;åªé¢„ç•™ç©ºé—´æ²¡å…³è”å˜é‡ num resb 1 ;é¢„ç•™ç©ºé—´å¹¶ç»‘å®šå˜é‡  times directiveå…è®¸å¤šä¸ªå˜é‡åˆå§‹åŒ–ä¸ºç›¸åŒçš„å€¼ï¼š\nvarname times quantity define-directive [intiail-val]  æ³¨æ„timesæŒ‡ä»¤ä¹Ÿå¯ä»¥ç”¨äº.bssèŠ‚ï¼Œä½†æ˜¯.bssèŠ‚æ±‡ç¼–çš„æ—¶å€™ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œç¨‹åºå¯åŠ¨çš„æ—¶å€™æ‰ä¼šè¿›è¡Œ0åˆå§‹åŒ–ã€‚\n å¦‚æœæ²¡æœ‰æä¾›initial-valï¼Œä¼šæç¤ºæ²¡æœ‰åˆå§‹å€¼ä¸è¿›è¡Œåˆå§‹åŒ–ï¼› å¦‚æœæä¾›äº†intiail-valï¼Œä¼šæç¤º.bssèŠ‚å¿½ç•¥äº†åˆå§‹å€¼ä¸è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼›  1.9 å®šä¹‰å¸¸é‡ # æ±‡ç¼–è¯­è¨€ä¸­å®šä¹‰å¸¸é‡çš„æŒ‡ä»¤åŒ…æ‹¬3ä¸ªï¼Œåˆ†åˆ«æ˜¯EQUã€%assignã€%defineã€‚\nconst-name EQU value ;å¯ä»¥å®šä¹‰å­—ç¬¦ä¸²æˆ–è€…æ•°å€¼å¸¸é‡ %assign const-name value ;åªå¯ä»¥å®šä¹‰æ•°å€¼å¸¸é‡ï¼Œå¯ä»¥é‡å®šä¹‰ %define const-name value ;å¯ä»¥å®šä¹‰å­—ç¬¦ä¸²æˆ–è€…æ•°å€¼å¸¸é‡  å‰é¢æ›¾å¤šæ¬¡ä½¿ç”¨EQUè¿›è¡Œå¸¸é‡å®šä¹‰ï¼Œè¿™é‡Œå°±ä¸å†æä¾›å…¶ä»–ç¤ºä¾‹ç¨‹åºäº†ã€‚\n1.10 ç®—æœ¯æŒ‡ä»¤ # æ±‡ç¼–è¯­è¨€ä¸­çš„ç®—æœ¯è¿ç®—æŒ‡ä»¤åŒ…æ‹¬ï¼š\n INCã€DECï¼Œè‡ªå¢ã€è‡ªå‡ä¸€ä¸ªå¯„å­˜å™¨æˆ–è€…å†…å­˜å˜é‡çš„å€¼ï¼Œç»“æœä¿å­˜åˆ°å½“å‰æ“ä½œæ•°ï¼› ADDã€SUBï¼ŒåŠ ã€å‡ä¸€ä¸ªå¯„å­˜å™¨æˆ–è€…å†…å­˜å˜é‡çš„å€¼ï¼Œç»“æœä¿å­˜åˆ°ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼› MULã€IMULï¼Œåˆ†åˆ«å¤„ç†æ— ç¬¦å·ã€æœ‰ç¬¦å·æ•°çš„ä¹˜æ³•ï¼Œä¿å­˜å­˜å‚¨éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š  8ä½ä¹˜æ³•ï¼Œå¦‚ï¼šAL * 8bit_source = AH ALï¼Œç»“æœé«˜8ä½ä¿å­˜åˆ°AHã€ä½8ä½ä¿å­˜åˆ°ALï¼› 16ä½ä¹˜æ³•ï¼Œå¦‚ï¼šAX * 16bit_source = DX AXï¼Œç»“æœé«˜16ä½ä¿å­˜åˆ°DXï¼Œä½16ä½ä¿å­˜åˆ°AXï¼› 32ä½ä¹˜æ³•ï¼Œå¦‚ï¼šEAX * 32bit_source = EDX EAXï¼Œç»“æœé«˜32ä½ä¿å­˜åˆ°EDXï¼Œä½32ä½ä¿å­˜åˆ°EAXï¼›   DIVã€IDIVï¼Œåˆ†åˆ«å¤„ç†æ— ç¬¦å·ã€æœ‰ç¬¦å·æ•°çš„é™¤æ³•ï¼Œç»“æœå­˜å‚¨éµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š  16ä½é™¤æ³•ï¼Œå¦‚ï¼šAX / 8bit_source = AL\u0026hellip;AHï¼Œå•†ä¿å­˜åˆ°ALï¼Œä½™æ•°ä¿å­˜åˆ°AHï¼› 32ä½é™¤æ³•ï¼Œå¦‚ï¼šDX AX / 16bit_source = AX\u0026hellip;DXï¼Œè¢«é™¤æ•°é«˜16ä½åœ¨DXã€ä½16ä½åœ¨AXï¼Œç»“æœå•†åœ¨AXã€ä½™æ•°åœ¨DXï¼› 64ä½é™¤æ³•ï¼Œå¦‚ï¼šEDX EAX / 32bit_source = EAX\u0026hellip;EDXï¼Œè¢«é™¤æ•°é«˜32ä½åœ¨EAXã€ä½32ä½åœ¨EAXï¼Œç»“æœå•†åœ¨EAXã€ä½™æ•°åœ¨EDXï¼›    1.11 é€»è¾‘æŒ‡ä»¤ # æ±‡ç¼–è¯­è¨€ä¸­çš„é€»è¾‘è¿ç®—æŒ‡ä»¤åŒ…æ‹¬ï¼š\n ANDï¼Œé€»è¾‘ä¸è¿ç®—ï¼Œç»“æœä¿å­˜åˆ°ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼› ORï¼Œé€»è¾‘æˆ–è¿ç®—ï¼Œç»“æœä¿å­˜åˆ°ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼› NOTï¼Œå¯¹å½“å‰æ“ä½œæ•°æ±‚åï¼Œç»“æœä¿å­˜åˆ°å½“å‰æ“ä½œæ•°ï¼› XORï¼Œå¼‚æˆ–è¿ç®—ï¼Œç»“æœä¿å­˜åˆ°ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼› TESTï¼Œæµ‹è¯•è¿ç®—ï¼Œä¸ä¼šæ”¹å˜æ“ä½œæ•°çš„å€¼ï¼Œä½†è¿ç®—ä¼šå½±å“ZFæ ‡è¯†ï¼›  1.12 åˆ†æ”¯æ§åˆ¶ # é€šè¿‡æŸäº›å¾ªç¯ã€åˆ†æ”¯æŒ‡ä»¤å¯ä»¥å®ç°åˆ†æ”¯è¯­å¥ï¼Œè¿™é‡Œå¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤ä¸»è¦éƒ½æ˜¯åŸºäºå¤„ç†å™¨ä¸­çš„æ ‡è¯†å¯„å­˜å™¨æ¥å®ç°çš„ã€‚\nå¸¸ç”¨æŒ‡ä»¤åŒ…æ‹¬ï¼š\n æ¯”è¾ƒæŒ‡ä»¤\nCMPï¼Œæ¯”è¾ƒä¸¤ä¸ªæ“ä½œæ•°æ˜¯å¦ç›¸åŒã€è°å¤§è°å°ï¼Œéœ€ç»“åˆå…¶ä»–æ¡ä»¶è½¬ç§»æŒ‡ä»¤ä½¿ç”¨ï¼› æ— æ¡ä»¶è½¬ç§»æŒ‡ä»¤\nJMPï¼Œæ— æ¡ä»¶è·³è½¬åˆ°åˆ¶å®šçš„æŒ‡ä»¤åœ°å€å¤„æ‰§è¡Œï¼› æ¡ä»¶è½¬ç§»æŒ‡ä»¤ æœ‰ç¬¦å·æ•°ã€æ— ç¬¦å·æ•°é€šç”¨çš„åŒ…æ‹¬ï¼šJE/JZï¼ŒJNE/JNZï¼› æ— ç¬¦å·æ•°ç‰¹æœ‰çš„åŒ…æ‹¬ï¼šJGã€JGEã€JLã€JLEç­‰ï¼› æœ‰ç¬¦å·æ•°ç‰¹æœ‰çš„åŒ…æ‹¬ï¼šJAã€JAEã€JBã€JBEç­‰ï¼› ç‰¹æ®Šç”¨é€”çš„åŒ…æ‹¬ï¼šJCã€JNCã€JOã€JNOã€JSã€JNSç­‰ï¼›  è¿™é‡Œæ¶‰åŠåˆ°çš„æ¡ä»¶è½¬ç§»æŒ‡ä»¤æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸ä¸€ä¸€è¿›è¡Œæè¿°äº†ï¼Œæœ‰éœ€è¦çš„è¯è¯»è€…æœ‹å‹å¯ä»¥å‚è€ƒâ€åˆ†æ”¯æ§åˆ¶æŒ‡ä»¤â€œï¼Œæˆ–è€…å¯ä»¥å‚è€ƒintelæŒ‡ä»¤é›†äº†è§£æ›´å¤šçš„ç»†èŠ‚ã€‚\n1.13 å¾ªç¯æ§åˆ¶ # å€ŸåŠ©æ¡ä»¶è½¬ç§»æŒ‡ä»¤å®ç°å¾ªç¯\næ¡ä»¶è½¬ç§»æŒ‡ä»¤å¯ä»¥ç”¨äºå®ç°å¾ªç¯æ§åˆ¶ï¼Œå¾ªç¯æ§åˆ¶æ¬¡æ•°å¯ä»¥å­˜å‚¨åœ¨ECXå¯„å­˜å™¨ä¸­ï¼Œå¾ªç¯ä½“å†…åŠ¨ä½œæ¯æ‰§è¡Œä¸€æ¬¡å°†ECXå€¼å‡1ï¼Œæ ¹æ®ECXå€¼æ˜¯å¦ä¸º0å†³å®šæ˜¯å¦è¿›è¡Œå¾ªç¯ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªæ ¹æ®è¿™ä¸ªç®€å•æ€è·¯å®ç°çš„å¾ªç¯ä½“ï¼š\nMOV	CL, 10 L1: \u0026lt;LOOP-BODY\u0026gt; DEC	CL JNZ	L1  å€ŸåŠ©å†…ç½®çš„loopæŒ‡ä»¤å®ç°å¾ªç¯\næ±‡ç¼–è¯­è¨€å†…éƒ¨æä¾›äº†æŒ‡ä»¤loopæ¥å®ç°å¾ªç¯ï¼Œèµ·å®ç°æ–¹å¼è·Ÿæˆ‘ä»¬ä¸Šé¢è¯´çš„æ˜¯ä¸€æ ·çš„ï¼ŒloopæŒ‡ä»¤ä¼šæ£€æŸ¥å½“å‰ECXå¯„å­˜å™¨çš„å€¼æ˜¯å¦ä¸º0ï¼Œä¸º0åˆ™é€€å‡ºå¾ªç¯ï¼Œå¤§äº0åˆ™æ‰§è¡ŒDEC ECXå¹¶ç»§ç»­æ‰§è¡Œå¾ªç¯ä½“ã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªå€ŸåŠ©loopæŒ‡ä»¤å®ç°çš„å¾ªç¯ä½“ç‰ˆæœ¬ï¼Œä¹¦å†™ä¸Šä¹Ÿæ›´åŠ ç®€ç»ƒï¼š\nMOV	CL, 10 L1: \u0026lt;LOOP-BODY\u0026gt; loop L1  1.14 æ•°å­— # å‰é¢æˆ‘ä»¬è¯»å…¥ä¸€ä¸ªæ•°ä½æ•°å€¼çš„æ—¶å€™éœ€è¦å°†å…¶å‡å»'0\u0026rsquo;ä¹‹åå¾—åˆ°å…¶çœŸå®æ•°å€¼ï¼Œè¿ç®—ç»“æœå†™å‡ºä¹‹å‰ä¹Ÿéœ€è¦å°†æ•°ä½æ•°å€¼åŠ ä¸Š'0\u0026rsquo;å†å†™å‡ºï¼Œä¸ºå•¥ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°ASCIIç ä¸æ•°å€¼ä¹‹é—´çš„è½¬æ¢ã€‚\nä¸Šè¿°å¤„ç†æ–¹å¼è™½ç„¶æ¯”è¾ƒç›´è§‚ï¼Œä½†æ˜¯è´Ÿè½½æ¯”è¾ƒå¤§ï¼Œæ±‡ç¼–è¯­è¨€ä¸­æœ‰æ›´åŠ é«˜æ•ˆçš„å¤„ç†æ–¹å¼ï¼Œå³ä»¥äºŒè¿›åˆ¶å½¢å¼å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚\nåè¿›åˆ¶æ•°å­—æœ‰ä¸¤ç§è¡¨ç¤ºå½¢å¼ï¼š\n ASCIIç å½¢å¼\nè¾“å…¥çš„åè¿›åˆ¶æ•°å­—æ¯ä¸ªæ•°ä½éƒ½ç”¨ASCIIæ¥è¡¨ç¤ºï¼Œåè¿›åˆ¶æ•°å­—1234çš„4ä¸ªæ•°ä½åˆ†åˆ«è¢«ç¼–ç ä¸ºå¯¹åº”çš„ASCIIç å­—ç¬¦ï¼Œå„ä¸ªå­—ç¬¦å¯¹åº”çš„åè¿›åˆ¶å€¼åˆ†åˆ«ä¸ºï¼š31 32 33 34ï¼Œå…±å ç”¨äº†4ä¸ªå­—èŠ‚ï¼› BCDç å½¢å¼  å¦‚æœæ˜¯unpacked BCDç¼–ç å½¢å¼ï¼Œè¾“å…¥çš„åè¿›åˆ¶æ•°å­—æ¯ä¸ªæ•°ä½éƒ½ç”¨1å­—èŠ‚çš„äºŒè¿›åˆ¶å½¢å¼æ¥è¡¨ç¤ºï¼Œåè¿›åˆ¶æ•°å­—1234çš„4ä¸ªæ•°ä½åˆ†åˆ«è¢«ç¼–ç ä¸ºï¼š01 02 03 04ï¼Œå…±å ç”¨4ä¸ªå­—èŠ‚ã€‚ å¦‚æœæ˜¯packed BCDç¼–ç å½¢å¼ï¼Œè¾“å…¥çš„åè¿›åˆ¶æ•°å­—æ¯ä¸ªæ•°ä½ç”¨4bitæ¥è¡¨ç¤ºï¼Œåè¿›åˆ¶æ•°å­—1234çš„4ä¸ªæ•°ä½è¢«ç¼–ç ä¸ºï¼š12 34ï¼Œå…±å ç”¨2ä¸ªå­—èŠ‚ã€‚    è¿ç®—å®Œæˆä¹‹åï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°æŸäº›ASCIIã€BCDç ä¹‹é—´çš„è½¬æ¢åŠ¨ä½œï¼Œå¯ä»¥å€ŸåŠ©äºå¯¹åº”çš„æ±‡ç¼–è°ƒæ•´æŒ‡ä»¤æ¥å®ç°ã€‚\n1.15 å­—ç¬¦ä¸² # è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦\nå‰é¢æˆ‘ä»¬æŒ‡å®šä¸€ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡å˜é‡æ¥æ˜¾ç¤ºåœ°æŒ‡æ˜ï¼Œä¹Ÿå¯ä»¥é€šè¿‡**â€$-msgâ€œ**æ¥è®¡ç®—å‡ºæ¥ï¼Œä½¿ç”¨åè€…çš„æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸ºmsgå­—ç¬¦ä¸²å°¾éƒ¨æ·»åŠ ä¸€ä¸ªå“¨å…µå­—ç¬¦ï¼Œä¾‹å¦‚ï¼š\nmsg db 'hello world',0xa len db $-msg  $ä»£è¡¨çš„æ˜¯å½“å‰çš„offsetï¼Œoffset-dbæ­£å¥½æ˜¯msgä¸­å­—ç¬¦çš„æ•°é‡ï¼Œä¸åŒ…æ‹¬0xaï¼Œå¦‚æœä¸æ·»åŠ 0xaè¿™ä¸ªå­—ç¬¦å“¨å…µçš„è¯ï¼Œlenå°±åº”è¯¥å®šä¹‰æˆ**\u0026quot;$-msg+1\u0026rdquo;**ã€‚\nå­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤ï¼š\n MOVSï¼Œç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼› LODSï¼Œä»å†…å­˜ä¸­è£…è½½å­—ç¬¦ä¸²ï¼› STOSï¼Œå­˜å‚¨å­—ç¬¦ä¸²åˆ°å†…å­˜ï¼› CMPSï¼Œæ¯”è¾ƒå­—ç¬¦ä¸²ï¼› SCASï¼Œæ¯”è¾ƒå¯„å­˜å™¨å’Œå†…å­˜ä¸­çš„å­—ç¬¦ä¸²ï¼› REP/REPZ/REPNZï¼Œä¾¿åˆ©å­—ç¬¦ä¸²å¹¶é’ˆå¯¹å„ä¸ªå­—ç¬¦é‡å¤æ‰§è¡ŒæŸä¸ªæ“ä½œï¼›  1.16 æ•°ç»„ # å®šä¹‰æ•°ç»„ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼Œæˆ‘ä»¬ä»¥å®šä¹‰ä¸€ä¸ªbyteæ•°ç»„ä¸ºä¾‹åˆ†åˆ«è¯´æ˜ã€‚\nå®šä¹‰æ•°ç»„æ–¹å¼ä¸€ï¼š\nnumbers db 0,1,2,3,4,5  å®šä¹‰æ•°ç»„æ–¹å¼äºŒï¼š\nnumbers db 0 db 1 db 2 db 3 db 4 db 5  è¿™ç§æ–¹å¼åº”è¯¥æ¯”è¾ƒå°‘ç”¨ï¼Œæ–¹å¼ä¸€å…¶å®æ˜¯è¿™ç§æ–¹å¼çš„ç®€åŒ–ç‰ˆã€‚\nå®šä¹‰æ•°ç»„æ–¹å¼ä¸‰ï¼š\nnumbers times 6 db 0  è¿™ç§æ–¹å¼å®šä¹‰çš„6ä¸ªbyteéƒ½è¢«åˆå§‹åŒ–ä¸ºç›¸åŒçš„å€¼0ã€‚\nè¿˜æ˜¯è¦æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥é€‰æ‹©åˆé€‚çš„æ•°ç»„å®šä¹‰æ–¹å¼ã€‚\nä¸‹é¢ç¤ºä¾‹ç¨‹åºå®šä¹‰äº†ä¸€ä¸ªæ•°ç»„byteæ•°ç»„xï¼Œç„¶åä»¥å¾ªç¯çš„å½¢å¼éå†xä¸­çš„å…ƒç´ å¹¶æ±‚å’Œï¼š\nsection	.text global _start ;must be declared for linker (ld) _start:	mov eax,3 ;number bytes to be summed mov ebx,0 ;EBX will store the sum mov ecx, x ;ECX will point to the current element to be summed top: add ebx, [ecx] add ecx,1 ;move pointer to next element dec eax ;decrement counter jnz top ;if counter not 0, then loop again done: add ebx, '0' mov [sum], ebx ;done, store result in \u0026quot;sum\u0026quot; display: mov edx,1 ;message length mov ecx, sum ;message to write mov ebx, 1 ;file descriptor (stdout) mov eax, 4 ;system call number (sys_write) int 0x80 ;call kernel mov eax, 1 ;system call number (sys_exit) int 0x80 ;call kernel section	.data global x x: db 2 db 4 db 3 sum: db 0  1.17 å‡½æ•° # æ±‡ç¼–è¯­è¨€ä¸­å‡½æ•°æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå®šä¹‰å‡½æ•°çš„è¯­æ³•å¦‚ä¸‹ï¼š\nfunction_name: \u0026lt;function_body\u0026gt; ret  ç¨‹åºä¸­è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æŒ‡ä»¤ä¸ºcallï¼š\ncall \u0026lt;function_name\u0026gt;  ä¸‹é¢ç¤ºä¾‹ä»£ç æ€»å®šä¹‰äº†ä¸€ä¸ªæ±‚å’Œå‡½æ•°ï¼š\nsection	.text global _start ;must be declared for using gcc _start:	;tell linker entry point mov	ecx,'4' sub ecx, '0' mov edx, '5' sub edx, '0' call sum ;call sum procedure mov [res], eax mov	ecx, msg	mov	edx, len mov	ebx,1	;file descriptor (stdout) mov	eax,4	;system call number (sys_write) int	0x80	;call kernel mov	ecx, res mov	edx, 1 mov	ebx, 1	;file descriptor (stdout) mov	eax, 4	;system call number (sys_write) int	0x80	;call kernel mov	eax,1	;system call number (sys_exit) int	0x80	;call kernel sum: mov eax, ecx add eax, edx add eax, '0' ret section .data msg db \u0026quot;The sum is:\u0026quot;, 0xA,0xD len equ $- msg segment .bss res resb 1  æ ˆstackï¼Œæ˜¯ä¸€ç§åè¿›å…ˆå‡ºLIFOçš„æ•°æ®ç»“æ„ï¼Œæ±‡ç¼–è¯­è¨€æä¾›äº†æŒ‡ä»¤pushã€popæ¥è¿›è¡Œå…¥æ ˆã€å‡ºæ ˆæ“ä½œã€‚\n1.18 é€’å½’ # é€’å½’æ“ä½œï¼ŒæŒ‡çš„æ˜¯ä¸€ä¸ªå‡½æ•°funcåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°è‡ªèº«çš„æƒ…å†µã€‚é€’å½’åˆå¯ä»¥ç»†åˆ†ä¸ºç›´æ¥é€’å½’å’Œé—´æ¥é€’å½’ã€‚\n ç›´æ¥é€’å½’ï¼Œå‡½æ•°funcçš„å‡½æ•°ä½“ä¸­ä¼šè°ƒç”¨è‡ªèº«ï¼› é—´æ¥é€’å½’ï¼Œå‡½æ•°funcçš„å‡½æ•°ä½“ä¸­è°ƒç”¨äº†å…¶ä»–çš„å‡½æ•°ï¼Œè€Œè¿™ä¸ªè¢«è°ƒç”¨çš„å‡½æ•°ä¸­åˆè°ƒç”¨äº†å‡½æ•°funcï¼›  æœ‰äº›é—®é¢˜é€‚åˆç”¨é€’å½’ç®—æ³•æ¥è§£å†³ï¼Œé€’å½’æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯å¯¹æ ˆç©ºé—´æ¶ˆè€—å¯èƒ½ä¼šè¶…å‡ºç³»ç»Ÿå…è®¸çš„ä¸Šé™å¯¼è‡´æ ˆæº¢å‡ºé—®é¢˜ï¼Œæ­¤æ—¶éœ€è¦å°†é€’å½’ç®—æ³•è½¬æ¢ä¸ºéé€’å½’ç®—æ³•ã€‚\n1.19 å® # æ±‡ç¼–è¯­è¨€ä¸­å¯ä»¥å°†å¸¸ç”¨çš„ã€å¯èƒ½å¤šæ¬¡é‡å¤ä½¿ç”¨çš„æŒ‡ä»¤åºåˆ—ä»¥å®macroçš„å½¢å¼è¿›è¡Œå°è£…ï¼Œåœ¨ç¨‹åºä¸­å¯ä»¥å¤šæ¬¡è°ƒç”¨ã€‚\nå®šä¹‰å®çš„å½¢å¼ä¸ºï¼š\n%macro macro_name params_quantity \u0026lt;macro_body\u0026gt; %endmacro  è°ƒç”¨å®çš„å½¢å¼ä¸ºï¼š\nmacro_name param1, param2  ä¸‹é¢çš„ç¤ºä¾‹ç¨‹åºä¸­ï¼Œå°†è¾“å‡ºå­—ç¬¦ä¸²çš„æŒ‡ä»¤åºåˆ—ä»¥å®çš„å½¢å¼è¿›è¡Œäº†å°è£…ï¼š\n; A macro with two parameters ; Implements the write system call %macro write_string 2 mov eax, 4 ;sys_write mov ebx, 1 ;stdout mov ecx, %1 ;param1, buf mov edx, %2 ;param2, buf_len int 80h ;call kernel %endmacro section	.text global _start ;must be declared for using gcc _start: ;tell linker entry point write_string msg1, len1 write_string msg2, len2 write_string msg3, len3 mov eax,1 ;sys_exit int 0x80 ;call kernel section	.data msg1 db	'Hello, programmers!',0xA,0xD len1 equ $ - msg1	msg2 db 'Welcome to the world of,', 0xA,0xD len2 equ $- msg2 msg3 db 'Linux assembly programming! ' len3 equ $- msg3  1.20 æ–‡ä»¶æ“ä½œ # Linuxå†…æ ¸æä¾›äº†ä¸€ç³»åˆ—æ–‡ä»¶æ“ä½œçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¸¸ç”¨çš„å‡ ä¸ªç³»ç»Ÿè°ƒç”¨å¦‚ä¸‹ï¼š\n sys_open sys_close sys_creat sys_read sys_write sys_lseek   ç³»ç»Ÿè°ƒç”¨ç¼–å·å¯ä»¥åœ¨/usr/include/asm/unistd.hä¸­æ£€æŸ¥åˆ°ï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°ã€è¿”å›å€¼ä¿¡æ¯å¯ä»¥å€ŸåŠ©Linux manæ‰‹å†Œè¿›è¡ŒæŸ¥è¯¢ã€‚\n æ±‡ç¼–è¯­è¨€é‡Œé¢å¯¹äºä¸Šè¿°ç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨ä¸å‰é¢sys_readã€sys_writeç¤ºä¾‹ç¨‹åºä¸­çš„ä½¿ç”¨æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œéƒ½æŒ‰ç…§å¦‚ä¸‹å‡ ä¸ªæ­¥éª¤è¿›è¡Œè°ƒç”¨ï¼š\n å°†ç³»ç»Ÿè°ƒç”¨çš„ç¼–å·è®¾ç½®åˆ°EAXï¼› å°†ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ä¾æ¬¡è®¾ç½®åˆ°EBXã€ECXã€EDXã€ESIã€EDIã€EBXï¼› è§¦å‘å†…æ ¸ä¸­æ–­int 80hï¼› æ£€æŸ¥EAXä¸­ä¿å­˜çš„ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼ï¼›  å¦‚ä¸‹ç¤ºä¾‹ç¨‹åºå¯¹æ–‡ä»¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨è¿›è¡Œäº†ç»„åˆä½¿ç”¨ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶å†™å…¥æ•°æ®ï¼Œç„¶åå…³é—­ï¼Œå†é‡æ–°æ‰“å¼€æ–‡ä»¶å¹¶è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæœ€ååœ¨stdoutä¸Šæ‰“å°æ–‡ä»¶å†…å®¹ã€‚\nsection	.text global _start ;must be declared for using gcc _start: ;tell linker entry point ;create the file mov eax, 8 mov ebx, file_name mov ecx, 0777 ;read, write and execute by all int 0x80 ;call kernel mov [fd_out], eax ; write into the file mov	edx,len ;number of bytes mov	ecx, msg ;message to write mov	ebx, [fd_out] ;file descriptor mov	eax,4 ;system call number (sys_write) int	0x80 ;call kernel ; close the file mov eax, 6 mov ebx, [fd_out] ; write the message indicating end of file write mov eax, 4 mov ebx, 1 mov ecx, msg_done mov edx, len_done int 0x80 ;open the file for reading mov eax, 5 mov ebx, file_name mov ecx, 0 ;for read only access mov edx, 0777 ;read, write and execute by all int 0x80 mov [fd_in], eax ;read from file mov eax, 3 mov ebx, [fd_in] mov ecx, info mov edx, 26 int 0x80 ; close the file mov eax, 6 mov ebx, [fd_in] ; print the info mov eax, 4 mov ebx, 1 mov ecx, info mov edx, 26 int 0x80 mov	eax,1 ;system call number (sys_exit) int	0x80 ;call kernel section	.data file_name db 'myfile.txt' msg db 'Welcome to Tutorials Point' len equ $-msg msg_done db 'Written to file', 0xa len_done equ $-msg_done section .bss fd_out resb 1 fd_in resb 1 info resb 26  1.21 å†…å­˜ç®¡ç† # Linuxå†…æ ¸æä¾›äº†ç³»ç»Ÿè°ƒç”¨sys_brkæ¥åˆ†é…å †å†…å­˜åŒºåŸŸï¼Œsys_brkå®é™…ä¸Šæ˜¯å¢åŠ äº†è¿›ç¨‹æœ€å¤§å¯åŠ¨æ€ç”³è¯·çš„å†…å­˜åœ°å€çš„ä¸Šé™ï¼Œbrkåˆ†é…çš„å†…å­˜åŒºåŸŸï¼ˆå †ï¼‰ä»…ä»…æŒ¨ç€.dataèŠ‚ï¼Œç³»ç»Ÿè°ƒç”¨sys_brkå‚æ•°ä¸º0æ—¶ä¼šè¿”å›å½“å‰å¯ç”³è¯·å†…å­˜çš„æœ€å¤§åœ°å€ï¼Œå‚æ•°ä¸ä¸º0æ—¶ä¼šè°ƒæ•´å½“å‰brkè¾¹ç•Œã€‚\nä¸‹é¢çš„ç¤ºä¾‹ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨sys_brkæ¥åŠ¨æ€åˆ†é…äº†16KBçš„å†…å­˜ç©ºé—´ï¼š\nsection	.text global _start ;must be declared for using gcc _start:	;tell linker entry point mov	eax, 45	;sys_brk xor	ebx, ebx int	80h add	eax, 16384	;number of bytes to be reserved mov	ebx, eax mov	eax, 45	;sys_brk int	80h cmp	eax, 0 jl	exit	;exit, if error mov	edi, eax	;EDI = highest available address sub	edi, 4	;pointing to the last DWORD mov	ecx, 4096	;number of DWORDs allocated xor	eax, eax	;clear eax std	;backward rep	stosd ;repete for entire allocated area cld	;put DF flag to normal state mov	eax, 4 mov	ebx, 1 mov	ecx, msg mov	edx, len int	80h	;print a message exit: mov	eax, 1 xor	ebx, ebx int	80h section	.data msg db	\u0026quot;Allocated 16 kb of memory!\u0026quot;, 10 len equ	$ - msg  1.22 æ€»ç»“ # è¿™é‡Œç»“åˆtutorialspointä¸Šçš„æ±‡ç¼–è¯­è¨€æ•™ç¨‹å¯¹ç›¸å…³çš„çŸ¥è¯†ç‚¹è¿›è¡Œäº†ç®€è¦å›é¡¾ï¼Œä¹Ÿæœ‰æ‰€æ”¶è·ï¼Œè¿™é‡Œä¹Ÿåˆ†äº«ç»™éœ€è¦çš„åŒå­¦ã€‚\n"}),a.add({id:361,href:"/tags/protobuf/",title:"protobuf",description:"",content:""}),a.add({id:362,href:"/tags/protoc/",title:"protoc",description:"",content:""}),a.add({id:363,href:"/tags/protoc-gen-go/",title:"protoc-gen-go",description:"",content:""}),a.add({id:364,href:"/blog/2017-05-23-protoc%E5%8F%8A%E6%8F%92%E4%BB%B6%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E7%B2%BE%E5%8D%8E%E7%89%88/",title:"ProtocåŠå…¶æ’ä»¶å·¥ä½œåŸç†åˆ†æ(ç²¾åç‰ˆ)",description:"å›¢é˜Ÿç»å¸¸ä½¿ç”¨protobufä½œä¸ºæ¶ˆæ¯äº¤æ¢æ ¼å¼ï¼Œç”±äºprotobufå…·æœ‰å¾ˆå¼ºçš„è‡ªæè¿°æ€§ï¼Œéå¸¸é€‚åˆå¯¹ä¸€ä¸ªæœåŠ¡è¿›è¡Œå»ºæ¨¡ã€‚ç»“åˆé…å¥—çš„ç¼–è¯‘å™¨protocï¼Œå¯ä»¥è½»æ¾ç†è§£æœåŠ¡ä¿¡æ¯ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥å¼€å‘ä¸€äº›è„šæ‰‹æ¶å·¥å…·ï¼ˆå¦‚protoc-gen-goï¼‰æ¥å®Œæˆä»£ç ç”Ÿæˆã€æ¥å£è‡ªåŠ¨æµ‹è¯•ã€ç”Ÿæˆapiæ–‡æ¡£ç­‰ç­‰å·¥ä½œã€‚æœ¬æ–‡å°±æ¥ä»‹ç»ä¸‹protocåŠå…¶æ’ä»¶çš„å·¥ä½œåŸç†ï¼Œè¯»å®Œåè¯»è€…å°†å…·å¤‡å®šåˆ¶åŒ–protocæ’ä»¶å¼€å‘çš„èƒ½åŠ›ã€‚",content:"åœ¨è¿›è¡Œprotocæ’ä»¶å¼€å‘ä¹‹å‰ï¼Œé¦–å…ˆè¦äº†è§£protocçš„å·¥ä½œåŸç†ã€‚protobufå…·æœ‰è¯¸å¤šä¼˜ç‚¹è¢«å¹¿æ³›ä½¿ç”¨ï¼Œç”±äºprotocå¯¹protoæ–‡ä»¶çš„å¼ºå¤§è§£æèƒ½åŠ›ä½¿æˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥æ¥å¼€å‘ä¸€äº›æ’ä»¶ï¼Œé€šè¿‡æ’ä»¶å¿«é€Ÿç”Ÿæˆç‰¹å®šäºprotoæ–‡ä»¶çš„å·¥å…·ç±»ã€é…ç½®æ–‡ä»¶ç­‰ï¼Œä»è€Œæé«˜å¼€å‘æ•ˆç‡ã€‚\næœ¬æ–‡é¦–å…ˆä¼šä»‹ç»ä¸€ä¸‹protocçš„æ•´ä½“å·¥ä½œåŸç†ï¼Œç„¶åè¯¦ç»†ä»‹ç»ä¸€ä¸‹protocå¯¹protoæ–‡ä»¶çš„è§£æè¿‡ç¨‹ï¼Œæœ€åç»™å‡ºç¼–å†™protocæ’ä»¶æ¥æ‰©å±•protocåŠŸèƒ½çš„ä¸€ä¸ªç¤ºä¾‹ï¼ˆè¿™é‡Œä»¥protoc-gen-goæ’ä»¶ä¸ºä¾‹ï¼‰ã€‚\n1. protocå·¥ä½œåŸç†åˆ†æ # 1.0. protocæºä»£ç å‡†å¤‡ # è¦æƒ³äº†è§£protocçš„å·¥ä½œæœºåˆ¶ï¼ŒæŸ¥çœ‹å…¶æºä»£ç äº†è§£å…¶æ ¸å¿ƒæµç¨‹æ˜¯æœ€é è°±çš„æ–¹æ³•ã€‚\nè·å–ç¨‹åºæºä»£ç çš„æ–¹å¼å¦‚ä¸‹ï¼š\ngit co https://github.com/google/protobuf  ç”±äºæˆ‘ä»¬å·¥ç¨‹ä¸­å¸¸ç”¨çš„protocç‰ˆæœ¬æ˜¯v2.5.0ï¼Œæ‰€ä»¥è¿™é‡Œæ£€å‡ºå¯¹åº”ç‰ˆæœ¬çš„tagã€‚\ngit ck v2.5.0  è€ƒè™‘åˆ°å¯èƒ½ä¼šè¿›è¡Œæµ‹è¯•ã€ä¿®æ”¹ã€æ³¨é‡Šç­‰å­¦ä¹ è¿‡ç¨‹ï¼Œè¿™é‡Œæœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯æ¥æ“ä½œã€‚\ngit branch -b ${new-branch-name}  ç°åœ¨æºä»£ç å‡†å¤‡å¥½äº†ï¼Œä¸‹é¢å¯ä»¥é˜…è¯»protocçš„æºç æ¢³ç†ä¸€ä¸‹å…¶å·¥ä½œåŸç†äº†ã€‚\nä¸Šè¿°gitæ£€å‡ºåçš„protobufè·¯å¾„ï¼Œè®°ä¸º${protobuf}ï¼Œåé¢å¦‚æœå‡ºç°${protobuf}è¯·çŸ¥æ™“å…¶å«ä¹‰ã€‚å¦‚æœåœ¨æè¿°æºä»£ç æ—¶æ²¡æœ‰æåŠä»£ç èµ·å§‹è·¯å¾„${protobuf}ï¼Œé‚£ä¹ˆèµ·å§‹è·¯å¾„å‡ä¸º${protobuf}ã€‚\n1.1. protocæ‰§è¡Œæµç¨‹è¯´æ˜ # protocæ‰§è¡Œæµç¨‹çš„ç›¸å…³æºç ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ã€‚\n1.1.1. protocç¨‹åºå…¥å£ # protocç¨‹åºå…¥å£ä¸ºä»¥ä¸‹æºæ–‡ä»¶mainå‡½æ•°ï¼Œè¯¥å…¥å£å‡½æ•°ä¸­å®Œæˆprotocå‘½ä»¤è¡Œæ¥å£åˆå§‹åŒ–ã€ç¼–ç¨‹è¯­è¨€åŠä»£ç ç”Ÿæˆå™¨æ³¨å†Œåï¼Œè°ƒç”¨cli.Run(argc,argv)è§£æprotoæ–‡ä»¶å¹¶ç”Ÿæˆç‰¹å®šè¯­è¨€çš„æºä»£ç ã€‚\nfile: src/google/protobuf/compiler/main.cc\n// Author: kenton@google.com (Kenton Varda) // è¿™ä¸ªå¤´æ–‡ä»¶å®šä¹‰äº†protocçš„å‘½ä»¤è¡Œæ¥å£ #include \u0026lt;google/protobuf/compiler/command_line_interface.h\u0026gt; // protocä¸­å†…ç½®äº†å¯¹cppã€pythonã€javaè¯­è¨€çš„æ”¯æŒï¼Œå¯¹å…¶ä»–è¯­è¨€çš„æ”¯æŒéœ€è¦ä»¥pluginçš„æ–¹å¼æ¥æ”¯æŒ #include \u0026lt;google/protobuf/compiler/cpp/cpp_generator.h\u0026gt; #include \u0026lt;google/protobuf/compiler/python/python_generator.h\u0026gt; #include \u0026lt;google/protobuf/compiler/java/java_generator.h\u0026gt; int main(int argc, char* argv[]) { // åˆå§‹åŒ–protocå‘½ä»¤è¡Œæ¥å£å¹¶å¼€å¯æ’ä»¶ // - æ’ä»¶åªæ˜¯æ™®é€šçš„å¯æ‰§è¡Œç¨‹åºï¼Œå…¶æ–‡ä»¶åä»¥AllowPluginså‚æ•°protoc-å¼€å¤´ // - å‡å®šprotoc --foo_outï¼Œé‚£ä¹ˆå®é™…è°ƒç”¨çš„æ’ä»¶æ˜¯protoc-foo google::protobuf::compiler::CommandLineInterface cli; cli.AllowPlugins(\u0026quot;protoc-\u0026quot;); // Proto2 C++ (æŒ‡å®šäº†--cpp_outå°†è°ƒç”¨cpp::Generator) google::protobuf::compiler::cpp::CppGenerator cpp_generator; cli.RegisterGenerator(\u0026quot;--cpp_out\u0026quot;, \u0026quot;--cpp_opt\u0026quot;, \u0026amp;cpp_generator, \u0026quot;Generate C++ header and source.\u0026quot;); // Proto2 Java (æŒ‡å®šäº†--java_outå°†è°ƒç”¨java::Generator) google::protobuf::compiler::java::JavaGenerator java_generator; cli.RegisterGenerator(\u0026quot;--java_out\u0026quot;, \u0026amp;java_generator, \u0026quot;Generate Java source file.\u0026quot;); // Proto2 Python (æŒ‡å®šäº†python_outå°†è°ƒç”¨python::Generator) google::protobuf::compiler::python::Generator py_generator; cli.RegisterGenerator(\u0026quot;--python_out\u0026quot;, \u0026amp;py_generator, \u0026quot;Generate Python source file.\u0026quot;); return cli.Run(argc, argv); }  1.1.2. å‘½ä»¤æ¥å£cli.Run(argc,argv)æ‰§è¡Œæµç¨‹ # cli.Run(\u0026hellip;)ä¸­ï¼Œå®Œæˆå¯¹protoæ–‡ä»¶çš„è¯»å–ã€è§£æï¼Œå¹¶é€šè¿‡æ³¨å†Œçš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…protocæ’ä»¶ç”Ÿæˆç‰¹å®šè¯­è¨€æºä»£ç ï¼Œå¹¶æœ€ç»ˆå®Œæˆæºä»£ç æ–‡ä»¶çš„åˆ›å»ºã€‚\nint CommandLineInterface::Run(int argc, const char* const argv[]) { Clear(); // è§£æå‘½ä»¤è¡Œå‚æ•° switch (ParseArguments(argc, argv)) { case PARSE_ARGUMENT_DONE_AND_EXIT: return 0; case PARSE_ARGUMENT_FAIL: return 1; case PARSE_ARGUMENT_DONE_AND_CONTINUE: break; } // è®¾ç½®æºç æ ‘ DiskSourceTree source_tree; for (int i = 0; i \u0026lt; proto_path_.size(); i++) { source_tree.MapPath(proto_path_[i].first, proto_path_[i].second); } ... // åˆ†é…ä¸€ä¸ªimporter(è´Ÿè´£è§£æprotoæ–‡ä»¶å¹¶åˆ›å»ºå¯¹åº”çš„FileDescriptorå¯¹è±¡) Importer importer(\u0026amp;source_tree, \u0026amp;error_collector); // è§£ææˆåŠŸåçš„protoæ–‡ä»¶éƒ½ä¼šé€šè¿‡ä¸€ä¸ªå¯¹åº”çš„FileDescriptoræ¥è¡¨ç¤º vector\u0026lt;const FileDescriptor*\u0026gt; parsed_files; // è§£æè¾“å…¥çš„protoæ–‡ä»¶ for (int i = 0; i \u0026lt; input_files_.size(); i++) { // è§£æå•ä¸ªprotoæ–‡ä»¶ const FileDescriptor* parsed_file = importer.Import(input_files_[i]); if (parsed_file == NULL) return 1; parsed_files.push_back(parsed_file); // å¦‚æœæŒ‡å®šäº†--disallow_servicesåˆ™æ‹’ç»å¤„ç†protoä¸­serviceå®šä¹‰ if (disallow_services_ \u0026amp;\u0026amp; parsed_file-\u0026gt;service_count() \u0026gt; 0) { cerr \u0026lt;\u0026lt; parsed_file-\u0026gt;name() \u0026lt;\u0026lt; \u0026quot;: This file contains services, but \u0026quot; \u0026quot;--disallow_services was used.\u0026quot; \u0026lt;\u0026lt; endl; return 1; } } // ä¸ºæ¯ä¸ªè¾“å‡ºä½ç½®æ„é€ ä¸€ä¸ªå•ç‹¬çš„GeneratorContextå¯¹è±¡ï¼Œæœ‰å¯èƒ½å¤šä¸ªä»£ç ç”Ÿæˆå™¨çš„è¾“å‡º // ä½ç½®æ˜¯ç›¸åŒçš„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¤šä¸ªä»£ç ç”Ÿæˆå™¨åº”è¯¥å…±ç”¨åŒä¸€ä¸ªGeneratorContextå¯¹è±¡ä»¥ // ä½¿å¾—OpenForInsert()èƒ½æ­£å¸¸å·¥ä½œ typedef hash_map\u0026lt;string, GeneratorContextImpl*\u0026gt; GeneratorContextMap; GeneratorContextMap output_directories; // é’ˆå¯¹protoæ–‡ä»¶ç”Ÿæˆç‰¹å®šè¯­è¨€çš„æºä»£ç  if (mode_ == MODE_COMPILE) { // ä¸€æ¬¡å¤„ç†ä¸€ä¸ªè¾“å‡ºæŒ‡ä»¤(--foo_out=params:dir) for (int i = 0; i \u0026lt; output_directives_.size(); i++) { string output_location = output_directives_[i].output_location; if (!HasSuffixString(output_location, \u0026quot;.zip\u0026quot;) \u0026amp;\u0026amp; !HasSuffixString(output_location, \u0026quot;.jar\u0026quot;)) { AddTrailingSlash(\u0026amp;output_location); } // å½“å‰è¾“å‡ºæŒ‡ä»¤ä¸­çš„è¾“å‡ºç›®å½•å¯èƒ½å·²ç»è¢«è®°å½•ä¸‹æ¥äº† GeneratorContextImpl** map_slot = \u0026amp;output_directories[output_location]; // - å¦‚æœæ²¡æœ‰è®°å½•ä¸‹æ¥åˆ™åˆ†é…ä¸€ä¸ªå…³è”çš„GeneratorContextImplå¯¹è±¡ if (*map_slot == NULL) { *map_slot = new GeneratorContextImpl(parsed_files); } // - å‚è€ƒè¾“å‡ºæŒ‡ä»¤ï¼Œå°†è§£ææˆåŠŸçš„protoæ–‡ä»¶ï¼Œç”Ÿæˆå¯¹åº”çš„æºä»£ç ä¿¡æ¯ï¼Œ // è¿™äº›ä¿¡æ¯ä¼šè¢«è®°å½•åœ¨GeneratorContextImpl *map_slotä¸­ if (!GenerateOutput(parsed_files, output_directives_[i], *map_slot)) { STLDeleteValues(\u0026amp;output_directories); return 1; } } } // åˆ›å»ºæºä»£ç æ–‡ä»¶ï¼Œå¹¶å°†ç”Ÿæˆçš„æºä»£ç ä¿¡æ¯å†™ä¼šç£ç›˜ for (GeneratorContextMap::iterator iter = output_directories.begin(); iter != output_directories.end(); ++iter) { const string\u0026amp; location = iter-\u0026gt;first; GeneratorContextImpl* directory = iter-\u0026gt;second; if (HasSuffixString(location, \u0026quot;/\u0026quot;)) { // åˆ›å»ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰çš„æºä»£ç æ–‡ä»¶ if (!directory-\u0026gt;WriteAllToDisk(location)) { STLDeleteValues(\u0026amp;output_directories); return 1; } } else { if (HasSuffixString(location, \u0026quot;.jar\u0026quot;)) { directory-\u0026gt;AddJarManifest(); } if (!directory-\u0026gt;WriteAllToZip(location)) { STLDeleteValues(\u0026amp;output_directories); return 1; } } } ... return 0; }  1.1.3. protocæ‰§è¡Œé€»è¾‘æ€»ç»“ # é€šè¿‡æŸ¥çœ‹2.1.1ã€2.1.2ä¸¤éƒ¨åˆ†ä»£ç ï¼Œå¯ä»¥å¯¹protocçš„æ‰§è¡Œæµç¨‹åšä¸€ä¸ªç®€å•çš„æ¦‚æ‹¬ï¼š\n  protoc mainä¸­åˆå§‹åŒ–å‘½ä»¤è¡Œå‚æ•°æ¥å£cli;\n  å¼€å¯ä»¥protoc-ä¸ºå‰ç¼€çš„æ’ä»¶ä½œä¸ºç¬¬ä¸‰æ–¹ä»£ç ç”Ÿæˆå™¨ä½¿ç”¨ï¼Œcli.AllowPlugins(\u0026ldquo;protoc-\u0026quot;)ï¼›\n  æ³¨å†Œç¼–ç¨‹è¯­è¨€cppã€javaã€pythonåŠå¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼Œcli.RegisterGenerator(\u0026hellip;)ï¼›\n  è§£æprotoæ–‡ä»¶å¹¶è¿è¡Œä»£ç ç”Ÿæˆå™¨æˆ–è€…protocæ’ä»¶ç”Ÿæˆç‰¹å®šè¯­è¨€æºä»£ç ã€åˆ›å»ºæºä»£ç æ–‡ä»¶ï¼Œcli.Run(argc, argv);\n Clear()æ¸…ç©ºæ‰€æœ‰çš„æ•°æ®å¤‡ç”¨ï¼› ParseArguments(argc,argv)è§£æå‚æ•°ï¼Œå¯¹äºprotocçš„æŸäº›å†…ç½®å‚æ•°çš„æ£€æŸ¥ï¼Œå¯¹æŸäº›æ’ä»¶ç›¸å…³çš„\u0026ndash;${lang}_outå‚æ•°çš„æ£€æŸ¥ç­‰ï¼Œå°†\u0026ndash;${lang}_outä½œä¸ºè¾“å‡ºæŒ‡ä»¤ä¿å­˜èµ·æ¥ï¼›  struct OutputDirective { string name; // E.g. \u0026quot;--foo_out\u0026quot; CodeGenerator* generator; // NULL for plugins string parameter; string output_location; };  ``\n å‚æ•°è§£ææˆåŠŸä¹‹åï¼Œç»§ç»­æ‰§è¡Œå¤„ç†ï¼Œè®¾ç½®æºä»£ç æ ‘ã€æ˜ å°„è¾“å…¥æ–‡ä»¶åˆ°è™šæ‹Ÿè·¯å¾„ã€åˆ†é…importerï¼› é’ˆå¯¹æ¯ä¸ªè¾“å…¥çš„protoæ–‡ä»¶è¿›è¡Œè§£æï¼Œconst FileDescriptor* parsed_file = importer.Import(input_files_[i])ï¼Œè§£ææˆåŠŸåçš„æ–‡ä»¶ä¼šè¢«åŠ å…¥åˆ°vector\u0026lt;FileDescriptor*\u0026gt; parsed_filesä¸­è®°å½•ï¼Œæ¯ä¸€ä¸ªprotoæ–‡ä»¶è§£æåéƒ½å¯ä»¥ç”¨ä¸€ä¸ªFileDescriptorç»“æ„ä½“æ¥è¡¨ç¤ºï¼›   å¤‡æ³¨ï¼š è¿™é‡Œè§£æprotoæ–‡ä»¶çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆå°†protoæ–‡ä»¶ä¸­çš„å†…å®¹åˆ†å‰²æˆä¸€ä¸ªä¸ªçš„tokenï¼Œå°†å†…å®¹æ‹†åˆ†æˆä¸€ä¸ªä¸ªè¯ç´ å¹¶æ£€æŸ¥æœ‰æ•ˆæ€§ï¼Œä¹Ÿå°±æ˜¯è¯æ³•åˆ†æã€‚å¦‚æœè¯æ³•åˆ†ææ£€æŸ¥æ— è¯¯åˆ™è¿›å…¥åç»­çš„è¯­æ³•åˆ†æè¿‡ç¨‹ï¼Œparserå¯¹è¾“å…¥tokenä¸²è¿›è¡Œæ–‡æ³•ç›¸å…³çš„åˆ†ææ£€æŸ¥æ˜¯å¦å¯ä»¥æ„æˆä¸€æ£µæœ‰æ•ˆçš„è¯­æ³•åˆ†ææ ‘ï¼Œå¦‚æœå¯ä»¥åˆ™è¡¨ç¤ºè¯­æ³•æ­£ç¡®ã€‚\n // Tokenå®šä¹‰å¦‚ä¸‹ struct Token { TokenType type; string text; // The exact text of the token as it appeared in // the input. e.g. tokens of TYPE_STRING will still // be escaped and in quotes. // \u0026quot;line\u0026quot; and \u0026quot;column\u0026quot; specify the position of the first character of // the token within the input stream. They are zero-based. int line; int column; int end_column; }; // Tokenç±»å‹å®šä¹‰å¦‚ä¸‹ enum TokenType { TYPE_START, // Next() has not yet been called. TYPE_END, // End of input reached. \u0026quot;text\u0026quot; is empty. TYPE_IDENTIFIER, // A sequence of letters, digits, and underscores, not // starting with a digit. It is an error for a number // to be followed by an identifier with no space in // between. TYPE_INTEGER, // A sequence of digits representing an integer. Normally // the digits are decimal, but a prefix of \u0026quot;0x\u0026quot; indicates // a hex number and a leading zero indicates octal, just // like with C numeric literals. A leading negative sign // is NOT included in the token; it's up to the parser to // interpret the unary minus operator on its own. TYPE_FLOAT, // A floating point literal, with a fractional part and/or // an exponent. Always in decimal. Again, never // negative. TYPE_STRING, // A quoted sequence of escaped characters. Either single // or double quotes can be used, but they must match. // A string literal cannot cross a line break. TYPE_SYMBOL, // Any other printable character, like '!' or '+'. // Symbols are always a single character, so \u0026quot;!+$%\u0026quot; is // four tokens. };  `` è¯­æ³•åˆ†æçš„è¿‡ç¨‹è¿™é‡Œå°±ä¸è§£é‡Šäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹protobufä¸­grammarçš„å®šä¹‰ï¼Œæ— éä¹Ÿå°±æ˜¯äº›è§„çº¦çš„äº‹æƒ…ï¼Œåªè¦èƒ½å¤ŸæŒ‰ç…§grammarå°†è¯æ³•åˆ†æè¾“å‡ºçš„tokenä¸²æ„å»ºå‡ºä¸€æ£µå®Œæ•´çš„è¯­æ³•åˆ†ææ ‘protoæ–‡ä»¶å°±æ˜¯åˆæ³•çš„ï¼Œå¦åˆ™å°±æ˜¯ä¸åˆæ³•çš„ï¼Œè‡³äºè¯­æ³•åˆ†æè¿‡ç¨‹ä¸­ä¼´éšçš„è¯­ä¹‰åˆ†æè¿‡ç¨‹ï¼Œè¯­ä¹‰åˆ†æè¿‡ç¨‹ä¸­æ‰§è¡Œå“ªäº›è¯­ä¹‰åŠ¨ä½œï¼Œä¸è¯´ä¹ŸçŸ¥é“ï¼Œè‚¯å®šæ˜¯ç”ŸæˆæŸäº›â€œä¸­é—´ä»£ç â€ä¹‹ç±»çš„é¬¼ä¸œè¥¿ã€‚å­¦è¿‡ç¼–è¯‘åŸç†çš„è¿™äº›å¤„ç†è¿‡ç¨‹åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚è¯­æ³•åˆ†ææˆåŠŸä¹‹åå°±å¾—åˆ°äº†protoå¯¹åº”çš„FileDescriptorå¯¹è±¡ï¼Œå› ä¸ºå¯èƒ½è¾“å…¥çš„æ˜¯å¤šä¸ªprotoï¼Œæ‰€ä»¥å¤šä¸ªFileDescriptorå°±ç”¨vectoræ¥å­˜å‚¨äº†ã€‚\n éå†ä¹‹å‰è®°å½•ä¸‹æ¥çš„è¾“å‡ºæŒ‡ä»¤OutputDirective output_directives[]ï¼Œoutput_directives[i].output_locationæŒ‡æ˜äº†è¾“å‡ºç›®å½•ï¼Œé’ˆå¯¹è¾“å‡ºç›®å½•åˆ›å»ºGeneratorContextImplï¼Œå¹¶è®°å½•åˆ°hash_map\u0026lt;string, GeneratorContextImpl*\u0026gt; output_directoriesè¿™ä¸ªmapä¸­ï¼Œkeyä¸ºflag_out,å¦‚\u0026ndash;foo_outï¼Œvalueä¸ºGeneratorContextImplã€‚ç”±äºå¯èƒ½å¤šä¸ª\u0026ndash;${lang}_outéƒ½æŒ‡å‘ç›¸åŒçš„è¾“å‡ºç›®å½•ï¼Œæ‰€ä»¥åŒä¸€ä¸ªGeneratorContextImplä¹Ÿå­˜åœ¨å¤ç”¨çš„æƒ…å†µã€‚æ¯ä¸ªGeneratorContextImplè®°å½•äº†ä¸€ä¸ªè¾“å‡ºç›®å½•ã€æ‰€æœ‰è¯¥ç›®å½•ä¸‹çš„å¾…åˆ›å»ºçš„æºä»£ç æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¾…åˆ›å»ºçš„æºä»£ç æ–‡ä»¶ä¿¡æ¯è®°å½•åœ¨map\u0026lt;string,string*\u0026gt; files_é‡Œé¢ï¼Œkeyä¸ºæºä»£ç æ–‡ä»¶åï¼Œvalä¸ºæºä»£ç æ–‡ä»¶çš„å†…å®¹ï¼Œå¦å¤–è¿˜åŒ…æ‹¬äº†ä¸€ä¸ªvector\u0026lt;FileDescriptor*\u0026gt; parsed_filesè®°å½•äº†æ‰€æœ‰è§£ææˆåŠŸçš„protoæ–‡ä»¶ä¿¡æ¯ã€‚ éå†output_directivesçš„åŒæ—¶ï¼Œå› ä¸ºåŒä¸€ä¸ªoutput_directives[i]å¯¹åº”çš„è¾“å‡ºç›®å½•ä¸‹å¯èƒ½æœ‰å¤šä¸ªæºä»£ç æ–‡ä»¶è¦è¾“å‡ºï¼Œå¹¶ä¸”ä¸ç®¡flag_nameæ˜¯ä»€ä¹ˆï¼Œè¦å¤„ç†çš„protoæ–‡ä»¶éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æ¯ä¸ªoutput_directives[i]éƒ½ä¼šå¯¹å…¶è°ƒç”¨GenerateOutput(parsed_files, output_directives[i], *map_slot)ï¼Œoutput_directives[i].pluginæŒ‡æ˜äº†è¯­è¨€çš„ä»£ç ç”Ÿæˆå™¨(ä¸ºNULLåˆ™ä½¿ç”¨æ’ä»¶)ï¼Œå¯¹æ‰€æœ‰çš„è§£ææˆåŠŸçš„protoæ–‡ä»¶parsed_files[i]ç”Ÿæˆæºä»£ç ï¼Œæºä»£ç å…¨éƒ¨è¾“å‡ºåˆ°output_directive[i].output_locationä¸‹ï¼Œæºä»£ç çš„æ–‡ä»¶åéƒ½è®°å½•åœ¨parsed_files[i].name()é‡Œé¢ï¼Œè€Œæœ€ç»ˆç”Ÿæˆçš„æºä»£ç ä¿¡æ¯éƒ½å­˜å‚¨åœ¨è¿™é‡Œçš„CodeGeneratorImpl **map_slotä¸­ï¼Œä¹Ÿå°±ç›¸å½“äºå­˜å‚¨åœ¨äº†output_directories[]ä¸­ã€‚ æœ€åéå†output_directories[]ï¼Œå°†æ¯ä¸ªè¾“å‡ºç›®å½•ä¸‹è¦å†™çš„æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®å…¨éƒ¨å†™å‡ºåˆ°ç£ç›˜ï¼Œå³output_directories[i]-\u0026gt;WriteAllToDisk()ã€‚ doneï¼    äº†è§£ä»protoåˆ°æºä»£ç ç”Ÿæˆçš„å…³é”®ä¹‹å¤„å°±æ˜¯2.1.2èŠ‚ä¸­cli.Run(\u0026hellip;)æ–¹æ³•ä¸­è°ƒç”¨çš„GenerateOutputæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæ¥ç€çœ‹ã€‚\n1.1.4 protoc CommandLineInterface::GenerateOutput(\u0026hellip;)å®ç° # ä¸‹é¢çœ‹ä¸‹GenerateOutputæ–¹æ³•åˆ°åº•æ‰§è¡Œäº†å“ªäº›æ“ä½œã€‚\n// æ ¹æ®è¾“å‡ºæŒ‡ç¤º, ä¸ºè§£ææˆåŠŸçš„protoæ–‡ä»¶è°ƒç”¨ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆå¯¹åº”çš„ä»£ç å¹¶å­˜å‚¨åˆ°generator_context //@param parsed_files æ‰€æœ‰è§£ææˆåŠŸçš„protoæ–‡ä»¶ï¼Œæ¯ä¸ªè§£ææˆåŠŸçš„protoæ–‡ä»¶éƒ½ç”¨ä¸€ä¸ªFileDescriptoræ¥è¡¨ç¤º //@param output_directive è¾“å‡ºæŒ‡ç¤ºï¼Œå…¶æŒ‡æ˜äº†ç›®æ ‡è¯­è¨€ã€è¯­è¨€å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ã€è¾“å‡ºç›®å½•ç­‰ //@param generator_context ä»£ç ç”Ÿæˆå™¨ä¸Šä¸‹æ–‡ï¼Œå¯è®°å½•ç”Ÿæˆçš„ä»£ç  bool CommandLineInterface::GenerateOutput(const vector\u0026lt;const FileDescriptor*\u0026gt;\u0026amp; parsed_files, const OutputDirective\u0026amp; output_directive, GeneratorContext* generator_context) { string error; // å¦‚æœè¾“å‡ºæŒ‡ä»¤ä¸­æ²¡æœ‰è®¾ç½®å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼Œè¡¨æ˜æ²¡æœ‰åœ¨protoc mainä¸­æ³¨å†Œè¯­è¨€å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼Œ // è¿™ç§æƒ…å†µä¸‹éœ€è¦ç»§ç»­æœç´¢æ˜¯å¦å­˜åœ¨å¯¹åº”çš„protocæ’ä»¶æ¥æ”¯æŒï¼Œè‹¥å­˜åœ¨åˆ™è°ƒç”¨è¯¥æ’ä»¶æ¥å……å½“ä»£ç ç”Ÿæˆå™¨ if (output_directive.generator == NULL) { // è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯${PATH}ä¸­å¯æœç´¢åˆ°çš„protocæ’ä»¶ GOOGLE_CHECK(HasPrefixString(output_directive.name, \u0026quot;--\u0026quot;) \u0026amp;\u0026amp; HasSuffixString(output_directive.name, \u0026quot;_out\u0026quot;)) \u0026lt;\u0026lt; \u0026quot;Bad name for plugin generator: \u0026quot; \u0026lt;\u0026lt; output_directive.name; // å®é™…ä¸Šprotocæœç´¢æ’ä»¶å¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œæœç´¢çš„åç§°æ˜¯â€œprotoc-gen-â€+â€œè¯­è¨€â€ï¼Œ // å¦‚æœæˆ‘ä»¬è°ƒç”¨çš„æ˜¯protoc --foo_outï¼Œé‚£ä¹ˆå®é™…æœç´¢çš„å°±æ˜¯protoc-gen-fooã€‚ string plugin_name = plugin_prefix_ + \u0026quot;gen-\u0026quot; + output_directive.name.substr(2, output_directive.name.size() - 6); // è°ƒç”¨protocæ’ä»¶æ¥ç”Ÿæˆä»£ç ï¼Œè¿™æ˜¯æˆ‘ä»¬è¦é‡ç‚¹çœ‹çš„ï¼Œæˆ‘ä»¬å°±æ˜¯è¦å®ç°è‡ªå·±çš„protocæ’ä»¶ if (!GeneratePluginOutput(parsed_files, plugin_name, output_directive.parameter, generator_context, \u0026amp;error)) { cerr \u0026lt;\u0026lt; output_directive.name \u0026lt;\u0026lt; \u0026quot;: \u0026quot; \u0026lt;\u0026lt; error \u0026lt;\u0026lt; endl; return false; } } else { // è¿™ç§æ˜¯protoc mainå‡½æ•°ä¸­æ­£å¸¸æ³¨å†Œçš„ç¼–ç¨‹è¯­è¨€å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ string parameters = output_directive.parameter; if (!generator_parameters_[output_directive.name].empty()) { if (!parameters.empty()) { parameters.append(\u0026quot;,\u0026quot;); } parameters.append(generator_parameters_[output_directive.name]); } // ä¸ºæ¯ä¸ªè§£ææˆåŠŸçš„protoæ–‡ä»¶ç”Ÿæˆä»£ç  for (int i = 0; i \u0026lt; parsed_files.size(); i++) { if (!output_directive.generator-\u0026gt;Generate(parsed_files[i], parameters, generator_context, \u0026amp;error)) { // Generator returned an error. cerr \u0026lt;\u0026lt; output_directive.name \u0026lt;\u0026lt; \u0026quot;: \u0026quot; \u0026lt;\u0026lt; parsed_files[i]-\u0026gt;name() \u0026lt;\u0026lt; \u0026quot;: \u0026quot; \u0026lt;\u0026lt; error \u0026lt;\u0026lt; endl; return false; } } } return true; }  1.1.5. protocè°ƒç”¨æ’ä»¶ç”Ÿæˆä»£ç çš„æ‰§è¡Œé€»è¾‘ # ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹GeneratePluginOutputæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\n// è°ƒç”¨protocæ’ä»¶ä¸ºè§£ææˆåŠŸçš„protoæ–‡ä»¶ç”Ÿæˆä»£ç  //@param parsed_files è§£ææˆåŠŸçš„æ–‡ä»¶ //@param plugin_name protocæ’ä»¶åç§°ï¼ˆè¿™ä¸ªæ˜¯æ‹¼æ¥å‡ºæ¥çš„protoc-gen-${lang}ï¼‰ //@param parameter ä¼ ç»™æ’ä»¶çš„å‚æ•° //@param generator_context ä»£ç ç”Ÿæˆå™¨ä¸Šä¸‹æ–‡ï¼Œå¯è®°å½•ç”Ÿæˆçš„ä»£ç  //@param error ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯ bool CommandLineInterface::GeneratePluginOutput(const vector\u0026lt;const FileDescriptor*\u0026gt;\u0026amp; parsed_files, const string\u0026amp; plugin_name, const string\u0026amp; parameter, GeneratorContext* generator_context, string* error) { // protocç”Ÿæˆä¸€ä¸ªä»£ç ç”Ÿæˆè¯·æ±‚ï¼Œå¹¶å‘é€ç»™æ’ä»¶ CodeGeneratorRequest request; // protocæ’ä»¶æ ¹æ®æ¥æ”¶åˆ°çš„ä»£ç ç”Ÿæˆè¯·æ±‚ç”Ÿæˆä»£ç ï¼Œå¹¶å‘é€å“åº”ç»™protoc CodeGeneratorResponse response; // Build the request. if (!parameter.empty()) { request.set_parameter(parameter); } set\u0026lt;const FileDescriptor*\u0026gt; already_seen; for (int i = 0; i \u0026lt; parsed_files.size(); i++) { request.add_file_to_generate(parsed_files[i]-\u0026gt;name()); GetTransitiveDependencies(parsed_files[i], true, // Include source code info. \u0026amp;already_seen, request.mutable_proto_file()); } // forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æ¥æ‰§è¡Œæ’ä»¶å®Œæˆä»£ç ç”Ÿæˆå·¥ä½œï¼Œ // çˆ¶å­è¿›ç¨‹ä¹‹é—´æ˜¯é€šè¿‡ç®¡é“é€šä¿¡å®Œæˆè¯·æ±‚ã€å“åº”è¿‡ç¨‹ï¼Œå¦‚ä½•æ§åˆ¶å­è¿›ç¨‹çš„stdinã€stdoutï¼Œ // è¿™ä¸ªå¯ä»¥é€šè¿‡dup2æˆ–è€…dup3æ¥æ§åˆ¶é—´fd 0ã€1åˆ†åˆ«è®¾ç½®åˆ°ç®¡é“çš„è¯»ç«¯ã€å†™ç«¯ã€‚ // äº‹å®ä¸Šprotobufçš„å¼€å‘äººå‘˜ä¹Ÿæ˜¯è¿™ä¹ˆæ¥å®ç°çš„ã€‚ // å­è¿›ç¨‹é€šè¿‡execæ¥æœç´¢æ‰§è¡Œæ’ä»¶ç¨‹åº Subprocess subprocess; if (plugins_.count(plugin_name) \u0026gt; 0) { subprocess.Start(plugins_[plugin_name], Subprocess::EXACT_NAME); } else { subprocess.Start(plugin_name, Subprocess::SEARCH_PATH); } string communicate_error; // è¯·æ±‚æ’ä»¶ç”Ÿæˆä»£ç  if (!subprocess.Communicate(request, \u0026amp;response, \u0026amp;communicate_error)) { *error = strings::Substitute(\u0026quot;$0: $1\u0026quot;, plugin_name, communicate_error); return false; } // Write the files. We do this even if there was a generator error in order // to match the behavior of a compiled-in generator. scoped_ptr\u0026lt;io::ZeroCopyOutputStream\u0026gt; current_output; for (int i = 0; i \u0026lt; response.file_size(); i++) { const CodeGeneratorResponse::File\u0026amp; output_file = response.file(i); if (!output_file.insertion_point().empty()) { // é¦–å…ˆå…³é—­å½“å‰æ­£åœ¨å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼ˆç”¨CodeGeneratorResponseè¡¨ç¤ºï¼‰ // æ‰“å¼€å¾…å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼Œè¿™ä¸ªæ–‡ä»¶æ•°æ®å·²ç»å­˜åœ¨ï¼Œå®šä½åˆ°å‡†ç¡®çš„æ’å…¥ç‚¹ä½ç½®æ‰§è¡Œå†™å…¥ï¼Œç„¶åå…³é—­æ–‡ä»¶ // - è¿™é‡Œçš„æ’å…¥ç‚¹å¦‚ä½•å®šä¹‰ï¼Œæˆ‘ä»¬åœ¨åé¢å†è¿›è¡Œè¯´æ˜ã€‚å…·ä½“å¯å‚è€ƒplugin.protoå’Œplugin.pb.hã€‚ current_output.reset(); // OpenForInsertè¿”å›ä¸€ä¸ªè¾“å‡ºæµï¼Œä»¥æ–¹ä¾¿åé¢å†™å…¥ç¼–ç åæ•°æ® current_output.reset(generator_context-\u0026gt;OpenForInsert(output_file.name(), output_file.insertion_point())); } else if (!output_file.name().empty()) { // é¦–å…ˆå…³é—­å½“å‰æ­£åœ¨å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼ˆç”¨CodeGeneratorResponseè¡¨ç¤ºï¼‰ // æ‰“å¼€å¾…å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼Œè¿™ä¸ªæ–‡ä»¶æ•°æ®ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨æ’å…¥ç‚¹ä¿¡æ¯ï¼Œä»å¼€å§‹å¤„æ‰§è¡Œå†™å…¥ current_output.reset(); // OpenForInsertè¿”å›ä¸€ä¸ªè¾“å‡ºæµï¼Œä»¥æ–¹ä¾¿åé¢å†™å…¥ç¼–ç åæ•°æ® current_output.reset(generator_context-\u0026gt;Open(output_file.name())); } else if (current_output == NULL) { *error = strings::Substitute( \u0026quot;$0: First file chunk returned by plugin did not specify a file name.\u0026quot;, plugin_name); return false; } // ä»CodeGeneratorResponseä¸­è·å–è¾“å‡ºæµï¼Œå†™å‡ºï¼Œè¿™é‡Œè¾“å‡ºæµä¸­çš„æ•°æ®æ—¶å­˜å‚¨åœ¨GeneratorContextImplä¸­çš„ï¼Œ // GenerateOutputè°ƒç”¨æˆåŠŸä¹‹ååé¢ä¼šéå†æ¯ä¸€ä¸ªGenerateContextImplå®ŒæˆWriteAllToDisk()çš„æ“ä½œã€‚ // Use CodedOutputStream for convenience; otherwise we'd need to provide // our own buffer-copying loop. io::CodedOutputStream writer(current_output.get()); writer.WriteString(output_file.content()); } // æ£€æŸ¥æœ‰æ²¡æœ‰é”™è¯¯ if (!response.error().empty()) { // Generator returned an error. *error = response.error(); return false; } return true; }  1.1.6. protoc \u0026amp; protocæ’ä»¶æ•°æ®äº¤äº’çš„æ‰§è¡Œé€»è¾‘ # æ•´ä½“æ‰§è¡Œé€»è¾‘å·®ä¸å¤šç†æ¸…æ¥šäº†ï¼Œç„¶åè¿™é‡Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹çˆ¶è¿›ç¨‹ç»™å­è¿›ç¨‹å‘é€çš„ä»£ç ç”Ÿæˆè¯·æ±‚æ˜¯ä»€ä¹ˆï¼Œæ”¶åˆ°çš„ä»£ç ç”Ÿæˆçš„å“åº”åˆæ˜¯ä»€ä¹ˆï¼Œä»¥åŠçˆ¶å­è¿›ç¨‹é€šä¿¡çš„ç»†èŠ‚ã€å­è¿›ç¨‹å¯¹è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ç­‰ã€‚\nå…ˆæ¥çœ‹ä¸‹plugin.protoçš„å®šä¹‰ï¼Œprotocå†…ç½®çš„æ”¯æŒè¯­è¨€é‡Œé¢å¹¶ä¸åŒ…å«goï¼Œæˆ‘ä»¬åé¢éœ€è¦ç”¨goæ¥ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„æ’ä»¶ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨protocçš„goæ’ä»¶æ¥ç”Ÿæˆgoå¯¹åº”çš„plugin.goä»£ç ï¼Œç„¶åæˆ‘ä»¬è‡ªå·±å†™ä¸€äº›ä¸šåŠ¡ç±»æ’ä»¶ï¼ˆéè¯­è¨€æ’ä»¶ï¼‰çš„æ—¶å€™æ‰èƒ½ç”¨ä¸Šplugin.goã€‚æ‰¯è¿™ä¹ˆå¤šæ˜¯ä¸ºäº†è®©å¤§å®¶æ˜ç™½è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦çœ‹ä¸‹plugin.protoï¼Œè€Œä¸æ˜¯è¯¯è§£ä¸ºåªæ˜¯åœ¨å †ç Œå†…å®¹ã€‚çœ‹äº†è¿™é‡Œçš„plugin.protoä¹‹åæ‰èƒ½ç†è§£åˆ°protocä¸­çš„æ’ä»¶æœºåˆ¶çš„è¾¹ç•Œæ—¶ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥æ˜ç™½åˆ©ç”¨protocçš„æ’ä»¶æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œå“ªäº›åŠŸèƒ½èƒ½å®ç°ï¼Œå“ªäº›å®ç°ä¸äº†ï¼Œè¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ã€‚\nfile: src/google/protobuf/compiler/plugin.proto\n// protoc (aka the Protocol Compiler) can be extended via plugins. A plugin is // just a program that reads a CodeGeneratorRequest from stdin and writes a // CodeGeneratorResponse to stdout. // // Plugins written using C++ can use google/protobuf/compiler/plugin.h instead // of dealing with the raw protocol defined here. // // A plugin executable needs only to be placed somewhere in the path. The // plugin should be named \u0026quot;protoc-gen-$NAME\u0026quot;, and will then be used when the // flag \u0026quot;--${NAME}_out\u0026quot; is passed to protoc. package google.protobuf.compiler; option java_package = \u0026quot;com.google.protobuf.compiler\u0026quot;; option java_outer_classname = \u0026quot;PluginProtos\u0026quot;; import \u0026quot;google/protobuf/descriptor.proto\u0026quot;; // å‘é€ç»™æ’ä»¶çš„ä»£ç ç”Ÿæˆè¯·æ±‚ // An encoded CodeGeneratorRequest is written to the plugin's stdin. message CodeGeneratorRequest { // The .proto files that were explicitly listed on the command-line. The // code generator should generate code only for these files. Each file's // descriptor will be included in proto_file, below. //protoæ–‡ä»¶åˆ—è¡¨å¯¹åº”çš„è¦ç”Ÿæˆçš„æ–‡ä»¶çš„æºä»£ç æ–‡ä»¶çš„åå­— repeated string file_to_generate = 1; // The generator parameter passed on the command-line. //ä¼ é€’ç»™æ’ä»¶ä»£ç ç”Ÿæˆå™¨çš„å‚æ•° optional string parameter = 2; // FileDescriptorProtos for all files in files_to_generate and everything // they import. The files will appear in topological order, so each file // appears before any file that imports it. // // protoc guarantees that all proto_files will be written after // the fields above, even though this is not technically guaranteed by the // protobuf wire format. This theoretically could allow a plugin to stream // in the FileDescriptorProtos and handle them one by one rather than read // the entire set into memory at once. However, as of this writing, this // is not similarly optimized on protoc's end -- it will store all fields in // memory at once before sending them to the plugin. // æ¯ä¸€ä¸ªæ­£ç¡®è§£æçš„protoæ–‡ä»¶éƒ½ç”¨ä¸€ä¸ªFileDescriptorProtoæ¥è¡¨ç¤ºï¼› // è¿™é‡Œçš„FileDescriptorProtoä¸FileDescriptorå…¶å®æ˜¯å¯¹åº”çš„ï¼Œåœ¨è¯·æ±‚æ’ä»¶è¿›è¡Œä»£ç  // ç”Ÿæˆçš„æ—¶å€™ç›´æ¥å°±æœ‰è¿™æ ·çš„ä»£ç FileDescriptor::CopyTo(FileDescriptorProto\u0026amp;) // çš„ç”¨æ³•ã€‚è€Œåœ¨descriptor.hå’Œdescriptor.protoä¸­æŸ¥çœ‹äºŒè€…çš„æè¿°æ—¶ï¼Œå…¶æ³¨é‡Šæ¸…æ¸… // æ¥šæ¥šåœ°å†™ç€éƒ½æ˜¯æè¿°çš„ä¸€ä¸ªå®Œæ•´çš„protoæ–‡ä»¶ã€‚ repeated FileDescriptorProto proto_file = 15; } // æ’ä»¶è¿”å›çš„ä»£ç ç”Ÿæˆå“åº” // The plugin writes an encoded CodeGeneratorResponse to stdout. message CodeGeneratorResponse { // Error message. If non-empty, code generation failed. The plugin process // should exit with status code zero even if it reports an error in this way. // // This should be used to indicate errors in .proto files which prevent the // code generator from generating correct code. Errors which indicate a // problem in protoc itself -- such as the input CodeGeneratorRequest being // unparseable -- should be reported by writing a message to stderr and // exiting with a non-zero status code. // é”™è¯¯ä¿¡æ¯ optional string error = 1; // Represents a single generated file. // ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶æ¶ˆæ¯ç±»å‹ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå†…éƒ¨ç±»å‹ message File { // å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶åï¼ˆç›¸å¯¹äºè¾“å‡ºç›®å½•ï¼‰ï¼Œæ–‡ä»¶åä¸­ä¸èƒ½åŒ…æ‹¬.æˆ–è€…..ï¼Œè·¯å¾„æ˜¯ // ç›¸å¯¹è¾“å‡ºç›®å½•çš„è·¯å¾„ï¼Œä¸èƒ½ç”¨ç»å¯¹è·¯å¾„ï¼Œå¦åˆ†éš”ç¬¦å¿…é¡»ç”¨/ã€‚ // å¦‚æœnameæ²¡æœ‰æŒ‡å®šï¼Œé‚£ä¹ˆè¾“å‡ºçš„å†…å®¹å°†è¿½åŠ åˆ°å‰ä¸€ä¸ªè¾“å‡ºçš„æºä»£ç æ–‡ä»¶ä¸­ï¼Œè¿™ç§ // æ–¹å¼ä½¿å¾—ä»£ç ç”Ÿæˆå™¨èƒ½å¤Ÿå°†ä¸€ä¸ªå¤§æ–‡ä»¶çš„ç”Ÿæˆåˆ†å¤šæ¬¡å†™å…¥æ¥å®Œæˆï¼Œä¸ç”¨ä¸€æ¬¡æ€§å°†å¾ˆ // å¤§æ•°æ®é‡çš„æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ã€‚è¿™é‡Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œprotocä¸­å¹¶æ²¡æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µ // è¿›è¡Œç‰¹æ®Šçš„ä¼˜åŒ–ï¼Œå®ƒç­‰å¾…è¯»å–å®Œæ•´çš„CodeGeneratorResponseå†å†™å‡ºåˆ°ç£ç›˜ã€‚ optional string name = 1; // å¦‚æœinsertion_pointä¸ç©ºçš„è¯ï¼Œnameå­—æ®µä¹Ÿä¸èƒ½ä¸ºç©ºï¼Œå¹¶ä¸”å‡å®šnameå­—æ®µæŒ‡å®šçš„ // æ–‡ä»¶å·²ç»å­˜åœ¨äº†ã€‚è¿™é‡Œçš„å†…å®¹å°†è¢«æ’å…¥åˆ°nameæŒ‡å®šçš„æ–‡ä»¶ä¸­çš„ç‰¹å®šæ’å…¥ç‚¹ï¼ˆæ³¨è§£ï¼‰çš„ // ä¸Šä¸€è¡Œã€‚è¿™æœ‰åŠ©äºæ‰©å±•ä»£ç ç”Ÿæˆå™¨è¾“å‡ºçš„å†…å®¹ã€‚åœ¨ä¸€æ¬¡protocè°ƒç”¨ä¸­ï¼Œå¯èƒ½ä¼šåŒ // æ—¶æŒ‡å®šå¤šä¸ªprotocæ’ä»¶ï¼Œå‰é¢çš„æ’ä»¶å¯èƒ½ä¼šåœ¨è¾“å‡ºçš„å†…å®¹ä¸­æŒ‡å®šæ’å…¥ç‚¹ï¼Œåé¢çš„ // æ’ä»¶å¯èƒ½ä¼šåœ¨è¿™äº›æŒ‡å®šçš„æ’å…¥ç‚¹çš„ä½ç½®ç»§ç»­æ‰©å±•ä»£ç å†…å®¹ã€‚ // ä¾‹å¦‚ï¼Œå‰é¢çš„ä¸€ä¸ªæ’ä»¶åœ¨è¾“å‡ºçš„ä»£ç å†…å®¹ä¸­å¢åŠ äº†è¿™æ ·ä¸€è¡Œæ³¨è§£ï¼š // @@protoc_insertion_point(NAME) // è¿™æ ·å°±å®šä¹‰äº†ä¸€ä¸ªæ’å…¥ç‚¹ï¼Œæ’å…¥ç‚¹å‰é¢ã€åé¢å¯ä»¥åŒ…å«ä»»æ„çš„æ–‡æœ¬å†…å®¹ï¼Œå³ä½¿åœ¨ // æ³¨é‡Šé‡Œé¢ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚è¿™é‡Œçš„æ’å…¥ç‚¹å®šä¹‰ä¸­çš„NAMEåº”è¯¥å¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ’å…¥ç‚¹ // æ‰å¯ä»¥ï¼Œç±»ä¼¼äºæ ‡è¯†ç¬¦ï¼Œä»¥ä¾›å…¶ä»–çš„æ’ä»¶ä½¿ç”¨ï¼Œæ’ä»¶æ’å…¥ä»£ç çš„æ—¶å€™å°†ä»æ’å…¥ç‚¹ // çš„ä¸Šä¸€è¡Œå¼€å§‹è‡ªè¡Œæ’å…¥ã€‚å¦‚æœåŒ…å«å¤šä¸ªæ’å…¥ç‚¹çš„è¯ï¼Œæ’å…¥ç‚¹çš„å†…å®¹å°†è¢«æ’ä»¶ä¾æ¬¡ // æ‰©å±•ã€‚ // // ä¸€å¼€å§‹åˆ›å»ºè¿™ä¸ªæºä»£ç æ–‡ä»¶çš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…æ’ä»¶ä¸åé¢çš„ç»§ç»­æ‰©å±•æºä»£ç æ’å…¥ // ç‚¹ä½ç½®å†…å®¹çš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…æ’ä»¶ï¼Œå¿…é¡»åœ¨protocçš„åŒä¸€æ¬¡è°ƒç”¨ä¸­ï¼Œä»£ç ç”Ÿæˆå™¨ // æˆ–è€…æ’ä»¶æŒ‰ç…§protocå‘½ä»¤è¡Œè°ƒç”¨è¿‡ç¨‹ä¸­æŒ‡å®šçš„é¡ºåºä¾æ¬¡è°ƒç”¨ã€‚ optional string insertion_point = 2; // å¾…å†™å…¥åˆ°æºä»£ç ä¸­çš„å†…å®¹ optional string content = 15; } // ä¸€æ¬¡è¦å¤„ç†çš„ protoæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥æ’ä»¶å¤„ç†åè¿™é‡Œçš„fileæ˜¯ä¸€ä¸ªlist repeated File file = 15; }  ä¸‹é¢çœ‹ä¸€ä¸‹protocä¸protocæ’ä»¶è¿™å¯¹çˆ¶å­è¿›ç¨‹ä¹‹é—´æ˜¯æ€ä¹ˆé€šä¿¡çš„ã€‚\nclass LIBPROTOC_EXPORT Subprocess { public: Subprocess(); ~Subprocess(); enum SearchMode { SEARCH_PATH, // Use PATH environment variable. EXACT_NAME // Program is an exact file name; don't use the PATH. }; // Start the subprocess. Currently we don't provide a way to specify // arguments as protoc plugins don't have any. void Start(const string\u0026amp; program, SearchMode search_mode); // Serialize the input message and pipe it to the subprocess's stdin, then // close the pipe. Meanwhile, read from the subprocess's stdout and parse // the data into *output. All this is done carefully to avoid deadlocks. // Returns true if successful. On any sort of error, returns false and sets // *error to a description of the problem. bool Communicate(const Message\u0026amp; input, Message* output, string* error); // win32 relevant ... neglect private: #ifdef _WIN32 // ... #else // !_WIN32 pid_t child_pid_; // The file descriptors for our end of the child's pipes. We close each and // set it to -1 when no longer needed. int child_stdin_; int child_stdout_; #endif };  ä¸‹é¢æ˜¯Linuxå¹³å°ä¸‹çš„å­è¿›ç¨‹å¯åŠ¨å¤„ç†é€»è¾‘ã€‚\nvoid Subprocess::Start(const string\u0026amp; program, SearchMode search_mode) { // Note that we assume that there are no other threads, thus we don't have to // do crazy stuff like using socket pairs or avoiding libc locks. // [0] is read end, [1] is write end. int stdin_pipe[2]; int stdout_pipe[2]; GOOGLE_CHECK(pipe(stdin_pipe) != -1); GOOGLE_CHECK(pipe(stdout_pipe) != -1); char* argv[2] = { strdup(program.c_str()), NULL }; child_pid_ = fork(); if (child_pid_ == -1) { GOOGLE_LOG(FATAL) \u0026lt;\u0026lt; \u0026quot;fork: \u0026quot; \u0026lt;\u0026lt; strerror(errno); } else if (child_pid_ == 0) { // We are the child. // å°†å­è¿›ç¨‹çš„stdiné‡å®šå‘åˆ°stdin_pipeçš„è¯»ç«¯ dup2(stdin_pipe[0], STDIN_FILENO); // å°†å­è¿›ç¨‹çš„stdouté‡å®šå‘åˆ°stdout_pipeçš„å†™ç«¯ dup2(stdout_pipe[1], STDOUT_FILENO); // å­è¿›ç¨‹é€šè¿‡0ã€1å¯¹ç®¡é“è¿›è¡Œæ“ä½œå°±å¤Ÿäº†ï¼Œé‡Šæ”¾å¤šä½™çš„fd close(stdin_pipe[0]); close(stdin_pipe[1]); close(stdout_pipe[0]); close(stdout_pipe[1]); // æ ¹æ®ç¨‹åºæœç´¢æ¨¡å¼è°ƒç”¨execæ—å‡½æ•°æ¥è°ƒç”¨æ’ä»¶æ‰§è¡Œï¼Œexecæ—å‡½æ•°é€šè¿‡æ›¿æ¢å½“å‰è¿› // ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µç­‰å†…å­˜æ•°æ®ä¿¡æ¯ï¼Œç„¶åè°ƒæ•´å¯„å­˜å™¨ä¿¡æ¯ï¼Œä½¿å¾—è¿›ç¨‹è½¬è€Œå»æ‰§ // è¡Œæ’ä»¶çš„ä»£ç ã€‚æ’ä»¶ä»£ç æ‰§è¡Œä¹‹å‰è¿›ç¨‹å°±å·²ç»å°†fd 0ã€1é‡å®šå‘åˆ°çˆ¶è¿›ç¨‹cloneè¿‡ // æ¥çš„ç®¡é“äº†ï¼Œå› æ­¤æ’ä»¶ç¨‹åºçš„è¾“å‡ºå°†ç›´æ¥è¢«è¾“å‡ºåˆ°çˆ¶è¿›ç¨‹åˆ›å»ºçš„ç®¡é“ä¸­ã€‚ // æ­£å¸¸æƒ…å†µä¸‹ï¼Œexecä¸€æ—¦æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆä¹…ç»ä¸å¯¹æ‰§è¡Œswitchåç»­çš„ä»£ç äº†ï¼Œåªæœ‰ // å‡ºé”™æ‰å¯èƒ½ä¼šæ‰§è¡Œåˆ°åç»­çš„ä»£ç ã€‚ switch (search_mode) { case SEARCH_PATH: execvp(argv[0], argv); break; case EXACT_NAME: execv(argv[0], argv); break; } // åªæœ‰å‡ºé”™æ‰å¯èƒ½ä¼šæ‰§è¡Œåˆ°è¿™é‡Œçš„ä»£ç ã€‚ // Write directly to STDERR_FILENO to avoid stdio code paths that may do // stuff that is unsafe here. int ignored; ignored = write(STDERR_FILENO, argv[0], strlen(argv[0])); const char* message = \u0026quot;: program not found or is not executable\\n\u0026quot;; ignored = write(STDERR_FILENO, message, strlen(message)); (void) ignored; // Must use _exit() rather than exit() to avoid flushing output buffers // that will also be flushed by the parent. _exit(1); } else { free(argv[0]); // çˆ¶è¿›ç¨‹é‡Šæ”¾æ— ç”¨çš„fd close(stdin_pipe[0]); close(stdout_pipe[1]); // å­è¿›ç¨‹çš„stdinï¼Œå¯¹çˆ¶è¿›ç¨‹æ¥è¯´ä¹Ÿå°±æ˜¯ç®¡é“stdin_pipeçš„å†™ç«¯ï¼ŒCodeGeneratorRequestå°†é€šè¿‡è¿™ä¸ªfdå†™ç»™å­è¿›ç¨‹ child_stdin_ = stdin_pipe[1]; // å­è¿›ç¨‹çš„stdoutï¼Œå¯¹çˆ¶è¿›ç¨‹æ¥è¯´ä¹Ÿå°±æ˜¯ç®¡é“stdout_pipeçš„è¯»ç«¯ï¼ŒCodeGeneratorResponseå°†é€šè¿‡è¿™ä¸ªfdä»å­è¿›ç¨‹è¯»å– child_stdout_ = stdout_pipe[0]; } }  ä¸‹é¢æ¥ç€çœ‹çˆ¶è¿›ç¨‹è¯»å–å­è¿›ç¨‹è¿”å›çš„CodeGeneratorResponseçš„æ‰§è¡Œé€»è¾‘ã€‚\n//protocè¿›ç¨‹å’Œprotocæ’ä»¶è¿›ç¨‹é€šä¿¡ // //@param protocè¿›ç¨‹å‘é€åˆ°protocæ’ä»¶è¿›ç¨‹çš„ä»£ç ç”Ÿæˆè¯·æ±‚ //@param protocæ’ä»¶è¿›ç¨‹è¿”å›ç»™protocè¿›ç¨‹çš„ä»£ç ç”Ÿæˆå“åº” //@param error é”™è¯¯ä¿¡æ¯ bool Subprocess::Communicate(const Message\u0026amp; input, Message* output, string* error) { GOOGLE_CHECK_NE(child_stdin_, -1) \u0026lt;\u0026lt; \u0026quot;Must call Start() first.\u0026quot;; // The \u0026quot;sighandler_t\u0026quot; typedef is GNU-specific, so define our own. typedef void SignalHandler(int); // å±è”½ä¿¡å·SIGPIPEï¼Œé˜²æ­¢æ²¡æœ‰æŒ‡å®šä¿¡å·å¤„ç†å‡½æ•°çš„æƒ…å†µä¸‹è¢«killæ‰ SignalHandler* old_pipe_handler = signal(SIGPIPE, SIG_IGN); string input_data = input.SerializeAsString(); string output_data; int input_pos = 0; int max_fd = max(child_stdin_, child_stdout_); // child_stdout==-1çš„æ—¶å€™è¡¨ç¤ºå­è¿›ç¨‹è¿”å›çš„æ•°æ®å·²ç»è¯»å–å®Œæ¯•äº†ï¼Œå¯ä»¥ggäº† while (child_stdout_ != -1) { fd_set read_fds; fd_set write_fds; FD_ZERO(\u0026amp;read_fds); FD_ZERO(\u0026amp;write_fds); if (child_stdout_ != -1) { FD_SET(child_stdout_, \u0026amp;read_fds); } if (child_stdin_ != -1) { FD_SET(child_stdin_, \u0026amp;write_fds); } // è¿™ç§æƒ…æ™¯ä¸‹ä¹Ÿç”¨selectï¼Œæœç„¶å¾ˆgoogleï¼ if (select(max_fd + 1, \u0026amp;read_fds, \u0026amp;write_fds, NULL, NULL) \u0026lt; 0) { if (errno == EINTR) { // è¢«ä¿¡å·ä¸­æ–­äº†ï¼Œå†æ¬¡å°è¯• continue; } else { GOOGLE_LOG(FATAL) \u0026lt;\u0026lt; \u0026quot;select: \u0026quot; \u0026lt;\u0026lt; strerror(errno); } } // stdout_pipeå†™äº‹ä»¶å°±ç»ªï¼Œå†™è¯·æ±‚CodeGeneratorRequestç»™å­è¿›ç¨‹ if (child_stdin_ != -1 \u0026amp;\u0026amp; FD_ISSET(child_stdin_, \u0026amp;write_fds)) { int n = write(child_stdin_, input_data.data() + input_pos, input_data.size() - input_pos); if (n \u0026lt; 0) { // Child closed pipe. Presumably it will report an error later. // Pretend we're done for now. input_pos = input_data.size(); } else { input_pos += n; } // ä»£ç ç”Ÿæˆè¯·æ±‚å·²ç»æˆåŠŸå†™ç»™å­è¿›ç¨‹äº†ï¼Œå…³é—­ç›¸å…³çš„fd if (input_pos == input_data.size()) { // We're done writing. Close. close(child_stdin_); child_stdin_ = -1; } } // stdin_pipeè¯»äº‹ä»¶å°±ç»ªï¼Œè¯»å–å­è¿›ç¨‹è¿”å›çš„CodeGeneratorResponse if (child_stdout_ != -1 \u0026amp;\u0026amp; FD_ISSET(child_stdout_, \u0026amp;read_fds)) { char buffer[4096]; int n = read(child_stdout_, buffer, sizeof(buffer)); if (n \u0026gt; 0) { output_data.append(buffer, n); } else { // å­è¿›ç¨‹è¿”å›çš„CodeGeneratorResponseå·²ç»è¯»å–å®Œæ¯•ï¼Œå…³é—­ç›¸å…³çš„fd close(child_stdout_); child_stdout_ = -1; } } } // å­è¿›ç¨‹è¿˜æ²¡æœ‰è¯»å–CodeGeneratorRequestå®Œæ¯•ï¼Œå°±å…³é—­äº†è¾“å‡ºï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸å¯ // èƒ½è¯»å–åˆ°è¿”å›çš„CodeGeneratorResponseäº†ï¼Œè¿™ç§æƒ…å†µå¾ˆå¯èƒ½æ˜¯å‡ºç°äº†å¼‚å¸¸ã€‚ if (child_stdin_ != -1) { // Child did not finish reading input before it closed the output. // Presumably it exited with an error. close(child_stdin_); child_stdin_ = -1; } // ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œå­è¿›ç¨‹é€€å‡ºä¹‹åï¼Œéœ€è¦çˆ¶è¿›ç¨‹æ¥æ¸…ç†å­è¿›ç¨‹å ç”¨çš„éƒ¨åˆ†èµ„æºã€‚ // å¦‚æœå½“å‰çˆ¶è¿›ç¨‹ä¸waitpidçš„è¯ï¼Œå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ä¼šå˜ä¸ºinitæˆ–è€…systemdè¿›ç¨‹ï¼ŒåŒ æ ·ä¹Ÿä¼šè¢«æ¸…ç†çš„ã€‚ int status; while (waitpid(child_pid_, \u0026amp;status, 0) == -1) { if (errno != EINTR) { GOOGLE_LOG(FATAL) \u0026lt;\u0026lt; \u0026quot;waitpid: \u0026quot; \u0026lt;\u0026lt; strerror(errno); } } // åˆšæ‰ä¸ºäº†é˜»æ­¢SIGPIPEä¿¡å·åˆ°è¾¾æ—¶å¯¼è‡´è¿›ç¨‹ç»ˆæ­¢ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†SIGPIPEçš„ä¿¡å·å¤„ç†å‡½ // æ•°ï¼Œè¿™é‡Œå¯ä»¥æ¢å¤ä¹‹å‰çš„SIGPIPEçš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚ signal(SIGPIPE, old_pipe_handler); // æ ¹æ®å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€æ‰§è¡Œåç»­çš„å¤„ç†é€»è¾‘ // - å¼‚å¸¸å¤„ç† if (WIFEXITED(status)) { if (WEXITSTATUS(status) != 0) { int error_code = WEXITSTATUS(status); *error = strings::Substitute(\u0026quot;Plugin failed with status code $0.\u0026quot;, error_code); return false; } } else if (WIFSIGNALED(status)) { int signal = WTERMSIG(status); *error = strings::Substitute(\u0026quot;Plugin killed by signal $0.\u0026quot;, signal); return false; } else { *error = \u0026quot;Neither WEXITSTATUS nor WTERMSIG is true?\u0026quot;; return false; } // å°†å­è¿›ç¨‹è¿”å›çš„ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGeneratorResponseæ•°æ®è¿›è¡Œåä¸²è¡ŒåŒ–ï¼Œåä¸²è¡ŒåŒ– // æˆMessageå¯¹è±¡ï¼Œå®é™…ä¸Šè¿™é‡Œçš„Message::ParseFromString(const string\u0026amp;)æ˜¯ä¸ªè™š // å‡½æ•°ï¼Œæ˜¯è¢«CodeGeneratorResponseè¿™ä¸ªç±»é‡å†™äº†çš„ï¼Œåä¸²è¡ŒåŒ–è¿‡ç¨‹ä¸å…·ä½“çš„ç±»å¯†åˆ‡ // ç›¸å…³ï¼Œä¹Ÿå¿…é¡»åœ¨æ´¾ç”Ÿç±»ä¸­äºˆä»¥å®ç°ã€‚ if (!output-\u0026gt;ParseFromString(output_data)) { *error = \u0026quot;Plugin output is unparseable.\u0026quot;; return false; } return true; }  åˆ°è¿™é‡Œä¸ºæ­¢protocè¿›ç¨‹çš„å…·ä½“æ‰§è¡Œé€»è¾‘æè¿°åœ°å·²ç»å¾ˆæ¸…æ¥šäº†å§ï¼Ÿä¸‹é¢å†çœ‹ä¸‹æ’ä»¶çš„æ‰§è¡Œé€»è¾‘ã€‚\næ”¯æŒä¸åŒè¯­è¨€çš„æ’ä»¶çš„æ‰§è¡Œé€»è¾‘ï¼Œæ€»ä½“ä¸Šæ¥è®²éƒ½åŒ…æ‹¬ä¸‹é¢çš„æ‰§è¡Œé€»è¾‘ï¼Œåªæ˜¯ç”Ÿæˆçš„ç›®æ ‡æºä»£ç ä¸åŒè€Œå·²ã€‚æ’ä»¶å°±åªæ˜¯ä»stdinè¯»å–ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGeneratorRequestè¯·æ±‚ï¼Œç„¶åæ‰§è¡Œåä¸²è¡ŒåŒ–å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„CodeGeneratorRequestå¯¹è±¡ï¼Œç„¶åæ ¹æ®è¯·æ±‚è¿›è¡Œå¿…è¦çš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œç¡®å®šè¦ç”Ÿæˆçš„æºä»£ç ä¿¡æ¯ï¼Œå¹¶å°†å…¶è®¾ç½®åˆ°CodeGeneratorResponseä¸­å¹¶ä¸²è¡ŒåŒ–åå†™å…¥åˆ°stdoutï¼Œæ’ä»¶çš„æ‰§è¡Œé€»è¾‘å°±è¿™ä¹ˆç®€å•ã€‚\n2. protocæ’ä»¶å·¥ä½œåŸç†åˆ†æ # åœ¨ç¬¬1èŠ‚ä¸­ç»“åˆprotocæºä»£ç å¯¹protocçš„å·¥ä½œåŸç†è¿›è¡Œäº†è¾ƒä¸ºè¯¦ç»†åœ°ä»‹ç»ï¼Œä¹Ÿé‡ç‚¹ä»‹ç»äº†é‡‡ç”¨protocæ’ä»¶ç”Ÿæˆæºä»£ç çš„æƒ…å†µä¸‹protocä¸protocæ’ä»¶çš„äº¤äº’è¿‡ç¨‹ã€‚ä¸‹é¢æˆ‘ä»¬å°†ä»¥protoc-gen-goä½œä¸ºä¸€ä¸ªå­¦ä¹ çš„èŒƒä¾‹æ¥è¿›ä¸€æ­¥ç†è§£ä¸€ä¸‹æ’ä»¶çš„å·¥ä½œåŸç†ï¼Œä¹Ÿå¯ä»¥ä¸ºæˆ‘ä»¬åç»­å¼€å‘protocæ’ä»¶æä¾›å‚è€ƒã€‚\n2.1. protoc-gen-goæºä»£ç å‡†å¤‡ # protoc-gen-goçš„æºä»£ç å¯ä»¥é€šè¿‡é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–ï¼š\ngit co https://github.com/golang/protobuf git branch -b ${new-branch}  è¿›è¡Œprotocæ’ä»¶å¼€å‘ï¼Œæ— éæ˜¯åŸºäºè§£æåçš„protoæ–‡ä»¶ç”Ÿæˆç‰¹å®šè¯­è¨€ï¼ˆä¸ä¸€å®šæ˜¯è¯­è¨€ï¼‰çš„ç›®æ ‡ä»£ç ï¼Œè¦æƒ³æ­£ç¡®åœ°ç”Ÿæˆç›®æ ‡ä»£ç ï¼Œé¦–è¦æ¡ä»¶å°±æ˜¯è¦èƒ½å¤Ÿæ­£ç¡®æå–protoæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œè€Œprotoæ–‡ä»¶ä¸­å®šä¹‰çš„å†…å®¹éƒ½å¯ä»¥é€šè¿‡descriptor.protoæ¥æè¿°ã€‚æ‰€ä»¥åœ¨æˆ‘ä»¬æ·±å…¥protoc-gen-goçš„æºä»£ç ä¹‹å‰ï¼Œä¸å¦¨å…ˆçœ‹ä¸‹descriptor.protoçš„å®šä¹‰æ¥çœ‹ä¸‹protobufæ˜¯å¦‚ä½•æŠ½è±¡ã€æè¿°ä¸€ä¸ªprotoæ–‡ä»¶çš„ã€‚\n2.2. descriptor.protoï¼Œå¯¹protoæ–‡ä»¶çš„æŠ½è±¡\u0026amp;æè¿° # protoæ–‡ä»¶ä¸­çš„æ•°æ®ç±»å‹éƒ½æ˜¯åœ¨descriptor.protoä¸­å®šä¹‰å¥½çš„ï¼Œä¸ºäº†æ›´å¥½åœ°å¸®åŠ©æˆ‘ä»¬å¯¹protoæ–‡ä»¶ä¸­çš„æ•°æ®ç±»å‹è¿›è¡Œè§£æï¼Œä¸ºäº†åœ¨æ’ä»¶å¼€å‘è¿‡ç¨‹ä¸­æ›´åŠ æ–¹ä¾¿å¿«é€Ÿåœ°è·å¾—ä¸æ•°æ®ç±»å‹ã€å˜é‡ã€rpcç­‰ç›¸å…³çš„ç›¸å…³å†…å®¹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ·±å…¥åœ°ç†è§£descriptor.protoä¸­çš„ç›¸å…³å®šä¹‰ä»¥åŠä»å®ƒå»¶ä¼¸å‡ºæ¥çš„ä¸€äº›æ¦‚å¿µã€ç®—æ³•ç­‰ã€‚\nè¿™éƒ¨åˆ†çš„å†…å®¹è¿˜ä¸å°‘ï¼Œåœ¨ä¸å½±å“ç†è§£çš„å¤§å‰æä¸‹ï¼Œæˆ‘è¿˜æ˜¯ç¨å¾®åˆ å‡äº†äº›ä»£ç ï¼Œé¿å…å¯¹å¤§å®¶ç†è§£é€ æˆä¸å¿…è¦çš„å¹²æ‰°ã€‚\nfile: src/google/protobuf/descriptor.proto\n// Author: kenton@google.com (Kenton Varda) // Based on original Protocol Buffers design by // Sanjay Ghemawat, Jeff Dean, and others. // descriptor.protoæ–‡ä»¶ä¸­çš„messageså®šä¹‰äº†protoæ–‡ä»¶ä¸­æ‰€èƒ½è§åˆ°çš„æ‰€æœ‰çš„å®šä¹‰ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„.protoæ–‡ä»¶åœ¨ä¸æä¾›å…¶ä»–ä¿¡æ¯ï¼ˆç”šè‡³ä¸éœ€è¦è¯»å–å®ƒçš„importsï¼‰èƒ½å¤Ÿç›´æ¥è¢«è½¬æ¢æˆä¸€ä¸ªFileDescriptorProtoå¯¹è±¡ã€‚ package google.protobuf; option java_package = \u0026quot;com.google.protobuf\u0026quot;; option java_outer_classname = \u0026quot;DescriptorProtos\u0026quot;; // descriptor.protoå¿…é¡»åœ¨é€Ÿåº¦æ–¹é¢ä¼˜åŒ–ï¼Œå› ä¸ºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åŸºäºåå°„çš„ç®—æ³•ä¸èµ·ä½œç”¨ option optimize_for = SPEED; // protocå¯ä»¥å°†è§£æçš„protoæ–‡ä»¶ä¸­çš„descriptoræ·»åŠ åˆ°FileDescriptorSetå¹¶è¾“å‡ºåˆ°æ–‡ä»¶ message FileDescriptorSet { repeated FileDescriptorProto file = 1; } // ä¸‹é¢çš„message FileDescriptorProtoå¯ä»¥ç”¨äºæè¿°ä¸€ä¸ªå®Œæ•´çš„protoæ–‡ä»¶ message FileDescriptorProto { optional string name = 1; // protoæ–‡ä»¶åï¼Œfile nameï¼Œç›¸å¯¹äºæºä»£ç æ ¹ç›®å½• optional string package = 2; // protoåŒ…åï¼Œä¾‹å¦‚ \u0026quot;foo\u0026quot;ã€\u0026quot;foo.bar\u0026quot; repeated string dependency = 3; // protoæ–‡ä»¶ä¸­importè¿›æ¥çš„å…¶ä»–protoæ–‡ä»¶åˆ—è¡¨ repeated int32 public_dependency = 10; // ä¸Šé¢public importçš„protoæ–‡ä»¶åœ¨protoæ–‡ä»¶åˆ—è¡¨ä¸­çš„ç´¢å¼• // Indexes of the weak imported files in the dependency list. repeated int32 weak_dependency = 11; // ä¸Šé¢weak importçš„protoæ–‡ä»¶åœ¨protoæ–‡ä»¶åˆ—è¡¨ä¸­çš„ç´¢å¼•ï¼Œä¸è¦ä½¿ç”¨ï¼Œåªç”¨äºgoogleå†…éƒ¨çš„è¿ç§» // protoæ–‡ä»¶ä¸­çš„æ‰€æœ‰é¡¶å±‚å®šä¹‰ä¿¡æ¯ repeated DescriptorProto message_type = 4; // æ‰€æœ‰çš„æ¶ˆæ¯(message)ç±»å‹å®šä¹‰ repeated EnumDescriptorProto enum_type = 5; // æ‰€æœ‰çš„æšä¸¾(enum)ç±»å‹å®šä¹‰ repeated ServiceDescriptorProto service = 6; // æ‰€æœ‰çš„æœåŠ¡(service)ç±»å‹å®šä¹‰ repeated FieldDescriptorProto extension = 7; // æ‰€æœ‰çš„æ‰©å±•å­—æ®µå®šä¹‰ optional FileOptions options = 8; // æ–‡ä»¶é€‰é¡¹ // è¿™ä¸ªå­—æ®µåŒ…æ‹¬äº†æºä»£ç çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œçš„ä¿¡æ¯å¯ä»¥ç»™å¼€å‘å·¥å…·ä½¿ç”¨ï¼Œä¹Ÿä»…åº”è¯¥æä¾›ç»™å¼€å‘å·¥å…·ä½¿ç”¨ï¼› // å¯ä»¥é€‰æ‹©å°†è¿™ä¸ªå­—æ®µä¸­çš„ä¿¡æ¯åˆ é™¤ï¼Œåœ¨ç¨‹åºè¿è¡ŒæœŸé—´å¹¶ä¸ä¼šé€ æˆç ´åã€‚ optional SourceCodeInfo source_code_info = 9; } // æè¿°æ¶ˆæ¯ç±»å‹Message message DescriptorProto { optional string name = 1; // Messageçš„ç±»å‹åç§° repeated FieldDescriptorProto field = 2; // Messageä¸­åŒ…æ‹¬çš„å­—æ®µåˆ—è¡¨ repeated FieldDescriptorProto extension = 6; // Messageä¸­åŒ…æ‹¬çš„æ‰©å±•åˆ—è¡¨ repeated DescriptorProto nested_type = 3; // Messageä¸­åµŒå¥—çš„Messageç±»å‹åˆ—è¡¨ repeated EnumDescriptorProto enum_type = 4; // Messageä¸­åµŒå¥—çš„æšä¸¾ç±»å‹åˆ—è¡¨ message ExtensionRange { optional int32 start = 1; optional int32 end = 2; } repeated ExtensionRange extension_range = 5; optional MessageOptions options = 7; } // æè¿°ä¸€ä¸ªå­—æ®µï¼ˆå­—æ®µå¯ä»¥æ˜¯Messageä¸­çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸäº›æ‰©å±•å­—æ®µï¼‰ message FieldDescriptorProto { // å­—æ®µæ•°æ®ç±»å‹ enum Type { // 0 is reserved for errors. // ç”±äºå†å²æ–¹é¢çš„åŸå› ï¼Œè¿™é‡Œçš„æšä¸¾å€¼çš„é¡ºåºæœ‰ç‚¹å¥‡æ€ª TYPE_DOUBLE = 1; TYPE_FLOAT = 2; // Not ZigZag encoded. Negative numbers take 10 bytes. Use TYPE_SINT64 if // negative values are likely. TYPE_INT64 = 3; TYPE_UINT64 = 4; // Not ZigZag encoded. Negative numbers take 10 bytes. Use TYPE_SINT32 if // negative values are likely. TYPE_INT32 = 5; TYPE_FIXED64 = 6; TYPE_FIXED32 = 7; TYPE_BOOL = 8; TYPE_STRING = 9; TYPE_GROUP = 10; // Tag-delimited aggregate. TYPE_MESSAGE = 11; // Length-delimited aggregate. // New in version 2. TYPE_BYTES = 12; TYPE_UINT32 = 13; TYPE_ENUM = 14; TYPE_SFIXED32 = 15; TYPE_SFIXED64 = 16; TYPE_SINT32 = 17; // Uses ZigZag encoding. TYPE_SINT64 = 18; // Uses ZigZag encoding. }; // å­—æ®µä¿®é¥°ç¬¦optionalã€requiredã€repeated enum Label { // 0 is reserved for errors LABEL_OPTIONAL = 1; LABEL_REQUIRED = 2; LABEL_REPEATED = 3; // TODO(sanjay): Should we add LABEL_MAP? }; optional string name = 1; // å­—æ®µåç§° optional int32 number = 3; // å­—æ®µtagç¼–å· optional Label label = 4; // å­—æ®µä¿®é¥°ç¬¦ // å¦‚æœtype_nameå·²è®¾ç½®ï¼Œè¿™ä¸ªå­—æ®µæ— é¡»è®¾ç½®ï¼› // å¦‚æœè¿™ä¸¤ä¸ªå­—æ®µéƒ½è®¾ç½®äº†ï¼Œè¿™é‡Œçš„typeå­—æ®µå¿…é¡»æ˜¯TYPE_ENUMç±»å‹æˆ–è€…TYPE_MESSAGEç±»å‹ optional Type type = 5; // å¯¹äºTYPE_ENUMæˆ–è€…TYPE_MESSAGEç±»å‹ï¼Œtype_nameå°±æ˜¯typeçš„åå­—ã€‚ // å¦‚æœnameä»¥â€œ.â€å¼€å¤´é‚£ä¹ˆå®ƒæ˜¯å®Œå…¨ä¿ç•™çš„ã€‚å¯¹äºC++æ¥è¯´ï¼Œå…¶ä½œç”¨åŸŸè§„åˆ™è¦æ±‚é¦–å…ˆæœ // ç´¢å½“å‰Messageç±»å‹çš„åµŒå¥—ç±»å‹ï¼Œç„¶åæ‰æ˜¯parent namespaceä¸­çš„ç±»å‹ï¼Œä¸€ç›´åˆ°root // namespaceã€‚ optional string type_name = 6; // å¯¹äºæ‰©å±•ï¼Œå®ƒå°±æ˜¯è¢«æ‰©å±•çš„ç±»å‹çš„åå­—ï¼Œå¯¹å®ƒçš„è§£æä¸å¯¹type_nameçš„è§£ææ—¶ä¸€æ ·çš„ optional string extendee = 2; // å¯¹äºæ•°å€¼ç±»å‹ï¼Œå­˜å‚¨äº†æ•°å€¼çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼ï¼› // å¯¹äºå¸ƒå°”ç±»å‹ï¼Œå­˜å‚¨å­—ç¬¦ä¸²\u0026quot;true\u0026quot;æˆ–\u0026quot;false\u0026quot;ï¼› // å¯¹äºå­—ç¬¦ä¸²ç±»å‹ï¼Œå­˜å‚¨åŸå§‹çš„æ–‡æœ¬å†…å®¹ï¼ˆæœªè½¬ä¹‰çš„ï¼‰ // å¯¹äºå­—èŠ‚ï¼Œå­˜å‚¨äº†cè½¬ä¹‰åçš„å€¼ï¼ˆæ‰€æœ‰\u0026gt;=128çš„å­—èŠ‚éƒ½ä¼šè¢«è½¬ä¹‰ï¼‰ // TODO(kenton)ï¼ŒåŸºäºbase64ç¼–ç çš„? optional string default_value = 7; optional FieldOptions options = 8; // å­—æ®µé€‰é¡¹ } // æè¿°ä¸€ä¸ªæšä¸¾ç±»å‹enum message EnumDescriptorProto { optional string name = 1; // æšä¸¾ç±»å‹åç§° repeated EnumValueDescriptorProto value = 2; // æšä¸¾ç±»å‹ä¸­åŒ…æ‹¬çš„æšä¸¾å€¼åˆ—è¡¨ optional EnumOptions options = 3; // æšä¸¾ç±»å‹é€‰é¡¹ } // æè¿°ä¸€ä¸ªæšä¸¾ç±»å‹ä¸­çš„ä¸€ä¸ªæšä¸¾å€¼ message EnumValueDescriptorProto { optional string name = 1; // æšä¸¾å€¼å¯¹åº”çš„name optional int32 number = 2; // æšä¸¾å€¼å¯¹åº”çš„numberï¼ˆé»˜è®¤ä¸º0ï¼Œä¾æ¬¡é€’å¢ï¼‰ optional EnumValueOptions options = 3; // æšä¸¾å€¼é€‰é¡¹ } // æè¿°ä¸€ä¸ªrpc service. message ServiceDescriptorProto { optional string name = 1; // æœåŠ¡åç§° repeated MethodDescriptorProto method = 2; // æœåŠ¡å¯¹åº”çš„æ–¹æ³•åˆ—è¡¨ optional ServiceOptions options = 3; // æœåŠ¡é€‰é¡¹ } // æè¿°ä¸€ä¸ªæœåŠ¡çš„æ–¹æ³• message MethodDescriptorProto { optional string name = 1; // æ–¹æ³•åç§° optional string input_type = 2; // æ–¹æ³•å…¥å‚ç±»å‹ optional string output_type = 3; // æ–¹æ³•å‡ºå‚ç±»å‹ optional MethodOptions options = 4; // æ–¹æ³•é€‰é¡¹ } // =================================================================== // Options // ä¸Šé¢çš„æ¯ä¸€ä¸ªå®šä¹‰åŸºæœ¬ä¸Šéƒ½åŒ…æ‹¬äº†é€‰é¡¹optionç›¸å…³çš„å­—æ®µï¼Œè¿™äº›é€‰é¡¹å­—æ®µä»…ä»…æ˜¯ä¸€äº› // æ³¨è§£ï¼Œè¿™äº›æ³¨è§£ä¼šå½±å“ä»£ç çš„ç”Ÿæˆï¼Œä½¿å¾—ç”Ÿæˆçš„ä»£ç ç¨æœ‰ä¸åŒï¼Œæ³¨è§£ä¹Ÿå¯èƒ½åŒ…å«äº†æ“ä½œ // messageçš„ä»£ç çš„ä¸€äº›æç¤ºä¿¡æ¯ã€è¯´æ˜ä¿¡æ¯ã€‚ // // clientså¯èƒ½ä¼šå®šä¹‰ä¸€äº›è‡ªå®šä¹‰çš„é€‰é¡¹æ¥ä½œä¸º*Options messageçš„extensionsï¼Œè¿™äº› // extensionsåœ¨parsingé˜¶æ®µå¯èƒ½è¿˜æ— æ³•ç¡®å®šä¸‹æ¥ï¼Œæ‰€ä»¥parserä¸èƒ½å­˜å‚¨ä»–ä»¬çš„å€¼ï¼Œè€Œæ˜¯ // å°†è¿™äº›è‡ªå®šä¹‰çš„é€‰é¡¹å…ˆå­˜å‚¨åˆ°ä¸€ä¸ª*Options messageé‡Œé¢ï¼Œç§°ä¹‹ä¸º // uinterpreted_optionã€‚è¿™ä¸ªå­—æ®µçš„åå­—åœ¨æ‰€æœ‰çš„*Options messageé‡Œé¢éƒ½å¿…é¡»ä¿è¯æ˜¯ // ç›¸åŒçš„ã€‚ä¹‹ååœ¨æˆ‘ä»¬æ„å»ºdescriptorçš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™æ‰€æœ‰çš„protoæ–‡ä»¶ä¹Ÿéƒ½è§£æå®Œäº†ã€ // æ‰€æœ‰çš„extensionsä¹Ÿéƒ½çŸ¥é“äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ç”¨è¿™é‡Œçš„uinterpreted_optionå­—æ®µå» // å¡«å……é‚£äº›extensionsã€‚ // // ç”¨äºè‡ªå®šä¹‰é€‰é¡¹çš„extensionsç¼–å·çš„é€‰æ‹©ä¸€èˆ¬éµå¾ªä¸‹é¢çš„æ–¹æ³•ï¼š // * å¯¹äºåªåœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–è€…ç»„ç»‡å†…ä½¿ç”¨çš„é€‰é¡¹ï¼Œæˆ–è€…ç”¨äºå®éªŒç›®çš„çš„é€‰é¡¹ï¼Œä½¿ç”¨å­— // æ®µç¼–å·50000~99999èŒƒå›´å†…çš„ã€‚å¯¹äºå¤šä¸ªé€‰é¡¹ï¼Œç”¨æˆ·éœ€è¦ç¡®ä¿ä¸ä½¿ç”¨ç›¸åŒçš„ç¼–å·ã€‚ // * å¯¹äºå¯èƒ½è¢«å¤šä¸ªäº’ä¸ä¾èµ–çš„å®ä½“æ‰€å…±åŒä½¿ç”¨çš„é€‰é¡¹ï¼Œéœ€è¦ç»™ // protobuf-global-extension-registry@google.comå‘é‚®ä»¶æ¥ç”³è¯·é¢„ç•™æ‰©å±•ç¼–å·ã€‚éœ€ // è¦æä¾›å·¥ç¨‹åç§°ã€å·¥ç¨‹ç«™ç‚¹ï¼Œæ²¡å¿…è¦è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ç”³è¯·é¢„ç•™æŸä¸ªç‰¹å®šçš„ç¼–å·ã€‚é€š // å¸¸åªéœ€è¦ä¸€ä¸ªæ‰©å±•ç¼–å·ï¼Œå¯ä»¥å£°æ˜å¤šä¸ªé€‰é¡¹ä½†æ˜¯åªä½¿ç”¨è¿™ä¸€ä¸ªç›¸åŒçš„æ‰©å±•ç¼–å·ã€‚å¦‚ // æœç”³è¯·å…¬å…±çš„æ‰©å±•ç¼–å·æ˜¯ä¸ªåˆšéœ€ï¼Œgoogleå¯èƒ½ä¼šå‘å¸ƒä¸€ä¸ªweb serviceæ¥å£æ¥è‡ªåŠ¨åˆ† // é…é€‰é¡¹ç¼–å·ã€‚ message FileOptions { // javaåŒ…åï¼Œå½“å‰protoæ–‡ä»¶ä¸­ç”Ÿæˆçš„javaç±»å°†ä½äºè¿™ä¸ªpackageä¸‹ optional string java_package = 1; // æŒ‡å®šä¸€ä¸ªå¤–éƒ¨ç±»åç§°ï¼Œå½“å‰protoæ–‡ä»¶ä¸­ç”Ÿæˆçš„æ‰€æœ‰çš„ç±»å°†è¢«å°è£…åœ¨è¿™ä¸ªå¤–éƒ¨ç±»å½“ä¸­ optional string java_outer_classname = 8; // å¦‚æœè®¾ç½®ä¸ºtrueï¼Œjavaä»£ç ç”Ÿæˆå™¨å°†ä¸ºæ¯ä¸ªé¡¶å±‚messageã€enumã€serviceå®šä¹‰ç”Ÿæˆ // å•ç‹¬çš„javaæ–‡ä»¶ï¼Œé»˜è®¤ä¸ºfalse optional bool java_multiple_files = 10 [default=false]; // å¦‚æœè®¾ç½®ä¸ºtrueï¼Œjavaä»£ç ç”Ÿæˆå™¨å°†æœªæ¯ä¸ªmessageå®šä¹‰ç”Ÿæˆequals()ã€hashCode() // æ–¹æ³•ï¼Œé»˜è®¤ä¸ºfalseã€‚æœ¬æ¥AbstractMessageåŸºç±»ç»åŒ…æ‹¬äº†ä¸€ä¸ªåŸºäºåå°„çš„equals()ã€ // hashCode()æ–¹æ³•å®ç°ï¼Œè¿™é‡Œçš„è¿™ä¸ªè®¾ç½®é¡¹æ˜¯ä¸€ä¸ªæ€§èƒ½æ–¹é¢çš„ä¼˜åŒ– optional bool java_generate_equals_and_hash = 20 [default=false]; // ä¼˜åŒ–ç±»å‹ï¼Œç”Ÿæˆçš„ç±»å¯ä»¥è¿›è¡Œé€Ÿåº¦ä¼˜åŒ–ã€ä»£ç å°ºå¯¸ä¼˜åŒ– enum OptimizeMode { SPEED = 1; // Generate complete code for parsing, serialization, // etc. CODE_SIZE = 2; // Use ReflectionOps to implement these methods. LITE_RUNTIME = 3; // Generate code using MessageLite and the lite runtime. } optional OptimizeMode optimize_for = 9 [default=SPEED]; // è®¾ç½®goä»£ç çš„åŒ…å optional string go_package = 11; // æ˜¯å¦åº”è¯¥é’ˆå¯¹æ¯ä¸€é—¨è¯­è¨€éƒ½ç”Ÿæˆgenerice servicesï¼ŸgenericæœåŠ¡å¹¶ä¸ç‰¹å®šäºä»»ä½• // çš„rpcç³»ç»Ÿï¼Œå®ƒæ˜¯ç”±æ¯ä¸ªè¯­è¨€çš„æ³¨ä»£ç ç”Ÿæˆå™¨æ¥ç”Ÿæˆçš„ï¼Œä¸å€ŸåŠ©äºé¢å¤–çš„æ’ä»¶ã€‚ // generic servicesæ˜¯æ—©æœŸprotoo2è¿™ä¸ªç‰ˆæœ¬è¯´æ”¯æŒçš„å”¯ä¸€ä¸€ç§æœåŠ¡ç±»å‹ã€‚ // // ç”±äºç°åœ¨æ¨å´‡ä½¿ç”¨pluginsï¼Œpluginså¯ä»¥ç”Ÿæˆé’ˆå¯¹ç‰¹å®šrpcç³»ç»Ÿçš„ä»£ç ï¼Œgeneric // servicesç°åœ¨å¯ä»¥çœ‹åšæ˜¯è¢«åºŸå¼ƒäº†ã€‚å› æ­¤ï¼Œä»¥å‰proto2æ€»çš„generice servicesçš„é»˜ // è®¤è®¾ç½®é»˜è®¤ä¸ºfalseï¼Œæ—©æœŸçš„ä¾èµ–äºgeneric servicesçš„ä»£ç éœ€è¦æ˜¾ç¤ºè®¾ç½®è¿™äº›é€‰é¡¹ // ä¸ºtrueã€‚ optional bool cc_generic_services = 16 [default=false]; optional bool java_generic_services = 17 [default=false]; optional bool py_generic_services = 18 [default=false]; // parserå°†ä¸è¯†åˆ«çš„é€‰é¡¹å­˜å‚¨åœ¨è¿™é‡Œçš„uinterpreted_option repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message extensions 1000 to max; } message MessageOptions { // è®¾ä¸ºtrueåˆ™ä½¿ç”¨è€çš„proto1 MessageSet wire formatâ€¦â€¦å…¼å®¹æ€§ç›®çš„ï¼Œæ²¡å¿…è¦ä½¿ç”¨ optional bool message_set_wire_format = 1 [default=false]; // ç¦ç”¨æ ‡å‡†çš„descriptor()æ–¹æ³•çš„ç”Ÿæˆï¼Œå› ä¸ºå¦‚æœæœ‰ä¸ªå­—æ®µåæ˜¯descriptorçš„è¯ä¼šç”Ÿ // æˆä¸€ä¸ªåŒåçš„å‡½æ•°ï¼Œä¼šå†²çªã€‚è¿™ä½¿å¾—ä»proto1è¿ç§»åˆ°åç»­ç‰ˆæœ¬æ›´ç®€å•ï¼Œä½†æ˜¯æ–°ç‰ˆæœ¬ // ä¸­è¿˜æ˜¯åº”è¯¥é¿å…ä½¿ç”¨å­—æ®µdescriptorã€‚ optional bool no_standard_descriptor_accessor = 2 [default=false]; // parserå°†ä¸è¯†åˆ«çš„é€‰é¡¹å­˜å‚¨åœ¨è¿™ä¸ªå­—æ®µé‡Œ repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message extensions 1000 to max; } message FieldOptions { // å¼€å¯packedé€‰é¡¹ä¹‹åï¼Œå¯¹äºrepeatedåŸºæœ¬æ•°æ®ç±»å‹å­—æ®µçš„è¡¨ç¤ºä¼šæ›´åŠ é«˜æ•ˆã€‚ä¸å†é’ˆ // å¯¹repeatedå­—æ®µä¸­çš„å„ä¸ªå…ƒç´ æ‰§è¡Œå†™tagã€ç±»å‹æ“ä½œï¼Œè€Œæ˜¯å°†æ•´ä¸ªæ•°ç»„ä½œä¸ºä¸€ä¸ªå›ºå®š // é•¿åº¦çš„blobæ¥å­˜å‚¨ã€‚ optional bool packed = 2; // å½“å‰å­—æ®µæ˜¯å¦éœ€è¦lazy parsingï¼Ÿåªæ˜¯å»ºè®®ï¼Œlazyä¸ºtrueï¼Œprotocä¸ä¸€å®šlazy parsing optional bool lazy = 5 [default=false]; // å½“å‰å­—æ®µæ˜¯å¦å·²ç»è¢«åºŸå¼ƒï¼Œè·Ÿç›®æ ‡å¹³å°ç›¸å…³ï¼Œè¿™ä¸ªå­—æ®µå¯ä»¥ä¸ºç”Ÿæˆçš„accessoræ–¹æ³• // ç”ŸæˆDeprecatedæ³¨è§£ï¼Œå¦‚æœç›®æ ‡å¹³å°ä¸æ”¯æŒå°±ä¼šå¿½ç•¥è¿™ä¸ªé€‰é¡¹ã€‚ä¸ç®¡ç›®æ ‡å¹³å°æ˜¯å¦ // æ”¯æŒï¼Œprotoé‡Œé¢è¦æƒ³åºŸå¼ƒä¸€ä¸ªå­—æ®µåŠ deprecatedé€‰é¡¹è¿˜æ˜¯éå¸¸æ­£ç¡®çš„åšæ³•ã€‚ optional bool deprecated = 3 [default=false]; // mapå­—æ®µï¼Œç›®å‰è¿˜æœªå®Œå…¨å®ç°ï¼Œåº”é¿å…ä½¿ç”¨ optional string experimental_map_key = 9; // googleå†…éƒ¨è¿ç§»ä½¿ç”¨ï¼Œå› é¿å…ä½¿ç”¨ optional bool weak = 10 [default=false]; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message EnumOptions { // ä¸å…è®¸å°†å¤šä¸ªä¸åŒçš„tag namesæ˜ å°„åˆ°ä¸€ä¸ªç›¸åŒçš„å€¼ // - æ„æ€æ˜¯è¯´ä¸å…è®¸å¤šä¸ªå­—æ®µçš„ç¼–å·ç›¸åŒ optional bool allow_alias = 2 [default=true]; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message EnumValueOptions { // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message ServiceOptions { // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message MethodOptions { // æ³¨æ„ï¼šå­—æ®µç¼–å·1~32è¢«ä¿ç•™ç»™googleå†…éƒ¨rpcæ¡†æ¶ä½¿ç”¨ï¼Œgoogleçš„è§£é‡Šæ˜¯ï¼Œåœ¨ // protobufè¢«å…¬å¼€ç»™å¤–éƒ¨ä½¿ç”¨ä¹‹å‰å†…éƒ¨å°±å·²ç»å¤§é‡ä½¿ç”¨äº†ï¼Œä¸”1~32å€ä½¿ç”¨çš„å¾ˆå¤šï¼Œä¹Ÿ // æ˜¯ä¸å¾—å·²çš„äº‹æƒ…ï¼Œæ€»ä¸èƒ½ä¸ºäº†å¼€æºã€æ¨å¹¿ä¸€ä¸ªå†…éƒ¨ç»„ä»¶å°±æŠŠè‡ªå·±çš„ç”Ÿæ„ç ¸äº†å§ã€‚ // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } // æè¿°ä¸€ä¸ªparserä¸è®¤è¯†çš„option message // - UninterpretedOptionåªä¼šå‡ºç°åœ¨compiler::Parserç±»åˆ›å»ºçš„options protosä¸­ï¼› // - æ„å»ºDescriptorå¯¹è±¡çš„æ—¶å€™DescriptorPoolä¼šè§£æUninterpretedOptionsï¼› // å› æ­¤ï¼Œdescriptorå¯¹è±¡ä¸­çš„options protosï¼ˆé€šè¿‡Descriptor::options()è¿”å›ï¼Œæˆ–è€… // é€šè¿‡Descriptor::CopyTo()ç”Ÿæˆï¼‰æ˜¯ä¸ä¼šåŒ…æ‹¬UinterpretedOptionsçš„ã€‚ message UninterpretedOption { // uinterpretedé€‰é¡¹çš„åå­—ï¼Œnameä¸­æ¯ä¸ªå…ƒç´ çš„name_partå­—æ®µéƒ½è¡¨ç¤ºnameä¸­çš„ç‚¹åˆ†å­— // ç¬¦ä¸²çš„ä¸€æ®µï¼Œå¦‚æœname_partæ˜¯ä¸€ä¸ªæ‰©å±•ï¼ˆé€šè¿‡åœ¨å­—ç¬¦ä¸²ä¸¤ç«¯ç”¨æ‹¬å·æ‹¬èµ·æ¥è¡¨ç¤ºï¼‰ï¼Œ // is_extensionå­—æ®µä¸ºtrueã€‚ // ä¾‹å¦‚ï¼Œ{[\u0026quot;foo\u0026quot;, false], [\u0026quot;bar.baz\u0026quot;,true], [\u0026quot;qux\u0026quot;,false]}è¡¨ç¤º\u0026quot;foo.(bar.baz).qux\u0026quot;ã€‚ message NamePart { required string name_part = 1; required bool is_extension = 2; } repeated NamePart name = 2; // uinterpretedé€‰é¡¹çš„å€¼ï¼Œä¼šè®¾ç½®ä¸‹é¢å­—æ®µä¸­å…¶ä¸­ä¸€ä¸ªçš„å€¼ optional string identifier_value = 3; optional uint64 positive_int_value = 4; optional int64 negative_int_value = 5; optional double double_value = 6; optional bytes string_value = 7; optional string aggregate_value = 8; } // =================================================================== // Optional source code info // FileDescriptorProtoæ˜¯ä»ä¹‹å‰çš„source fileä¸­ç”Ÿæˆçš„ï¼ˆsource fileæŒ‡çš„æ˜¯protoæ–‡ // ä»¶ï¼‰ï¼Œè¿™é‡Œçš„SourceCodeInfoæŒ‡çš„æ˜¯protoä¸­çš„â€œæºä»£ç â€ä¿¡æ¯ã€‚ message SourceCodeInfo { // Locationç”¨äºè¯†åˆ«protoæ–‡ä»¶ä¸­çš„æºä»£ç ç‰‡æ®µï¼Œå¾€å¾€å¯¹åº”ç€ä¸€ä¸ªç‰¹å®šçš„å®šä¹‰ã€‚è¿™äº› // Locationä¿¡æ¯å¯¹äºIDEã€ä»£ç ç´¢å¼•å·¥å…·ã€æ–‡æ¡£ç”Ÿæˆå·¥å…·ç­‰æ˜¯éå¸¸é‡è¦çš„ã€‚ // // ä¸‹é¢è¯´æ˜ä¸€ä¸‹Locationçš„æ¦‚å¿µå’Œä½œç”¨ï¼Œä»¥ä¸‹é¢è¿™ä¸ªmessageä¸ºä¾‹ï¼š // message Foo { // optional string foo = 1; // } // æˆ‘ä»¬å…ˆåªçœ‹ä¸Šé¢è¿™ä¸ªmessageä¸­çš„å­—æ®µå®šä¹‰ï¼š // optional string foo = 1; // ^ ^^ ^^ ^ ^^^ // a bc de f ghi // æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™å‡ ä¸ªLocationï¼š // span path represents // [a,i) [ 4, 0, 2, 0 ] The whole field definition. // [a,b) [ 4, 0, 2, 0, 4 ] The label (optional). // [c,d) [ 4, 0, 2, 0, 5 ] The type (string). // [e,f) [ 4, 0, 2, 0, 1 ] The name (foo). // [g,h) [ 4, 0, 2, 0, 3 ] The number (1). // // æ¯ä¸ªprotoæ–‡ä»¶è§£æä¹‹åç”¨ä¸€ä¸ªFileDescriptorProtoæ¥è¡¨ç¤ºï¼Œæ‰€ä»¥Lcoationè·¯å¾„ä½ // ç½®ä»FileDescriptorProtoå¼€å§‹ã€‚ // - å› ä¸ºmessage Fooæ˜¯ä¸€ä¸ªmessageï¼Œprotoä¸­æ‰€æœ‰é¡¶å±‚messageç±»å‹å®šä¹‰éƒ½åœ¨ // FileDescriptorProtoä¸­message_typeå­—æ®µå­˜å‚¨ï¼Œè¿™ä¸ªå­—æ®µçš„tagæ˜¯4ï¼Œæ‰€ä»¥Locationä¸º[4]ï¼› // - åˆå› ä¸ºmessage_typeæ˜¯repeated DescriptorProtoç±»å‹ï¼Œå› ä¸ºå½“å‰protoç¤ºä¾‹ä¸­ // Fooä¸ºç¬¬ä¸€ä¸ªmessageï¼Œæ‰€ä»¥å…¶åœ¨message_typeåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼ä¸º0ï¼Œæ‰€ä»¥Locationä¸º[4,0]ï¼› // - å› ä¸ºæˆ‘ä»¬ç°åœ¨çœ‹çš„â€œæºä»£ç â€æ˜¯â€œoptional string foo = 1;â€ï¼Œæˆ‘ä»¬éœ€è¦å®šä½åˆ° // messageä¸­çš„å­—æ®µä½ç½®ï¼Œmessage Fooä¸­çš„æ‰€æœ‰å­—æ®µéƒ½åœ¨DescriptorProtoä¸­çš„fieldå­— // æ®µä¸­è®°å½•ï¼Œè¿™ä¸ªå­—æ®µçš„tag=2ï¼Œæ‰€ä»¥Locationå˜ä¸º[4,0,2]ï¼› // - åˆå› ä¸ºè¿™ä¸ªDescriptorProtoä¸­çš„fieldä¸ºrepeated FieldDescriptorProto fieldï¼Œ // å› ä¸ºè¿™ä¸ªmessageä¸­åªæœ‰ä¸€ä¸ªå­—æ®µfooï¼Œæ‰€ä»¥fooåœ¨fieldåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼ä¸º0ï¼ŒLocationå˜ä¸º[4,0,2,0]; // ä¸Šé¢è§£é‡Šäº†å®šä½åˆ°å®Œæ•´çš„â€œoptional string foo = 1â€å®šä¹‰è¿™ä¸ªfieldçš„Locationå˜ // åŒ–è¿‡ç¨‹ï¼Œä¸‹é¢å†è¯´ä¸€ä¸‹labelã€typeã€nameã€numberçš„Locationå¦‚ä½•è¿›ä¸€æ­¥ç¡®å®šã€‚ // FieldDescriptorProtoä¸­labelçš„tagä½4ï¼Œtypeçš„tagä¸º5ï¼Œnameçš„tagä¸º1ï¼Œnumberçš„ // tagä¸º3ï¼ŒLocationå¯¹åº”çš„è¿½åŠ ç´¢å¼•4ã€5ã€1ã€3ã€‚gg! // // protoæ–‡ä»¶ä¸­çš„æºä»£ç ä¿¡æ¯å°±æ˜¯ç”±ä¸€ç³»åˆ—çš„Locationæ¥å¯»å€çš„ã€‚ repeated Location location = 1; message Location { // å‰é¢å·²ç»æè¿°äº†Locationçš„ç¡®å®šè¿‡ç¨‹ï¼Œä¸€ä¸ªLocationå¦‚[4,0,2,0]å…¶ä¸­çš„æ•°å­—è¦ä¹ˆ // æ˜¯å­—æ®µçš„tagç¼–å·è¦ä¹ˆæ˜¯repeatedåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼ï¼Œè¿™é‡Œçš„æ•°å­—æ„æˆçš„æ•°ç»„ä¿å­˜åœ¨ // pathä¸­ã€‚ repeated int32 path = 1 [packed=true]; // è¯¥å­—æ®µspanæ€»æ˜¯åŒ…æ‹¬3ä¸ªæˆ–è€…4ä¸ªå…ƒç´ ï¼Œä¾æ¬¡è¡¨ç¤ºstartlineã€startcolumnã€endlineã€endcolumn repeated int32 span = 2 [packed=true]; // å¦‚æœè¿™ä¸ªSourceCodeInfoä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„å£°æ˜çš„è¯ï¼Œå¯èƒ½åœ¨è¿™ä¸ªå£°æ˜çš„å‰é¢æˆ–è€… // åé¢å¯èƒ½æœ‰ä¸€äº›attachedçš„æ³¨é‡Šã€‚ // // è¿ç»­çš„å¤šä¸ªè¡Œæ³¨é‡Šçœ‹åšæ˜¯ä¸€ä¸ªå•ç‹¬çš„æ³¨é‡Šã€‚ // // è¿™ä¸ªå­—æ®µåªè®°å½•äº†æ³¨é‡Šå†…å®¹ï¼Œä¸åŒ…æ‹¬æ³¨é‡Šå†…å®¹å¼€å¤´çš„æ³¨é‡Šç¬¦å·//ã€‚å¯¹äºå—æ³¨é‡Šï¼Œ // æ³¨é‡Šå‰é¢çš„ç©ºç™½å­—ç¬¦ã€*è¿™å‡ ç§ç¬¦å·ä¹Ÿä¼šè¢«æ¸…ç†æ‰ã€‚ä½†æ˜¯ä¼šåŒ…æ‹¬æ¢è¡Œç¬¦ã€‚ // // Examples: // // optional int32 foo = 1; // Comment attached to foo. // // Comment attached to bar. // optional int32 bar = 2; // // optional string baz = 3; // // Comment attached to baz. // // Another line attached to baz. // // // Comment attached to qux. // // // // Another line attached to qux. // optional double qux = 4; // // optional string corge = 5; // /* Block comment attached // * to corge. Leading asterisks // * will be removed. */ // /* Block comment attached to // * grault. */ // optional int32 grault = 6; // Locationå‰é¢çš„æ³¨é‡Šä¿¡æ¯ optional string leading_comments = 3; // Locationåé¢çš„æ³¨é‡Šä¿¡æ¯ optional string trailing_comments = 4; } }  2.3. å¯ä»¥æå–protoæ–‡ä»¶ä¸­çš„å“ªäº›ä¿¡æ¯ \u0026amp; å¦‚ä½•æå– # å‰ä¸€èŠ‚2.2ä¸­å¯¹descriptor.protoè¿›è¡Œäº†è¯¦ç»†åœ°æè¿°ï¼Œå¯ä»¥è¯´åœ¨protoæ–‡ä»¶ä¸­å†™çš„æ¯ä¸€è¡Œå†…å®¹éƒ½å¯ä»¥é€šè¿‡è§£æFileDescriptorProtoæ¥è®¿é—®åˆ°ã€‚protoæ–‡ä»¶åªæ˜¯ä¸€ç§è‡ªæè¿°çš„æ¶ˆæ¯æ ¼å¼ï¼ŒåŸºäºè¿™ç§æ ¼å¼ç”Ÿæˆé¢å‘ç‰¹å®šç¼–ç¨‹è¯­è¨€çš„æºä»£ç æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬æƒ³è·å–çš„ä¿¡æ¯ä¸å¤–ä¹å¦‚ä¸‹å‡ ä¸ªï¼š\n å¾…ç”Ÿæˆçš„æºæ–‡ä»¶çš„åŒ…åï¼› å¾…ç”Ÿæˆçš„æºæ–‡ä»¶çš„wrapper classç±»åï¼› protoæ–‡ä»¶ä¸­å®šä¹‰çš„å„ä¸ªç±»å‹ï¼ŒåŒ…æ‹¬æšä¸¾enumã€æ¶ˆæ¯messageã€æœåŠ¡serviceï¼› å¯¹äºæšä¸¾enuméœ€è¦çŸ¥é“æšä¸¾ç±»å‹åã€åˆ—å‡ºçš„æšä¸¾å€¼ï¼ˆåŒ…æ‹¬å­—æ®µã€å€¼ã€æ³¨é‡Šä¿¡æ¯ï¼‰ã€æ³¨é‡Šä¿¡æ¯ï¼› å¯¹äºæ¶ˆæ¯messageéœ€è¦çŸ¥é“ç±»å‹åã€ç±»æˆå‘˜ï¼ˆåŒ…æ‹¬æˆå‘˜ç±»å‹ã€æˆå‘˜åç§°ã€å®šä¹‰é¡ºåºã€é»˜è®¤å€¼ã€æ³¨é‡Šä¿¡æ¯ï¼‰ã€æ³¨é‡Šä¿¡æ¯ï¼› å¯¹äºæœåŠ¡serviceéœ€è¦çŸ¥é“æœåŠ¡åç§°ã€æœåŠ¡rpcæ¥å£ï¼ˆrpcæ¥å£çš„è¯·æ±‚å‚æ•°ã€è¿”å›å€¼ç±»å‹ã€æ³¨é‡Šä¿¡æ¯ï¼‰ã€æ³¨é‡Šä¿¡æ¯ï¼› protoä¸­å¯ä»¥æ·»åŠ æ³¨è§£å—ï¼Ÿæ³¨è§£å¯ä»¥æå–å‡ºæ¥å—ï¼Ÿ  å¦‚ä½•æå–ä¸Šè¿°ä¿¡æ¯å‘¢ï¼Ÿå¯ä»¥è‚¯å®šåœ°æ˜¯ï¼Œåªè¦èƒ½æ‹¿åˆ°å½“å‰protoæ–‡ä»¶å¯¹åº”çš„FileDescriptorProtoï¼Œä¸Šè¿°å†…å®¹å‡ ä¹éƒ½å¯ä»¥è·å–åˆ°ã€‚ä½†æ˜¯å¦‚ä½•è·å–åˆ°å¯¹åº”çš„protoæ–‡ä»¶å¯¹åº”çš„è¿™ä¸ªFileDescriptorProtoå¯¹è±¡å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªprotoc-gen-goè¿™ä¸ªæ’ä»¶çš„ç¤ºä¾‹ä»£ç å§ï¼Œçœ‹å®Œä¹‹åï¼Œå¤§å®¶ä¹Ÿå°±äº†è§£äº†å¦‚ä½•è·å–protoå¯¹åº”çš„FileDescriptorProtoä»¥åŠå¦‚ä½•ä»ä¸­æå–æƒ³è¦çš„ä¸Šè¿°1~7éƒ¨åˆ†çš„ä¿¡æ¯ï¼Œç”Ÿæˆæºä»£ç æ–‡ä»¶ä¹Ÿå°±ç®€å•äº†ã€‚\n2.4. proto-gen-goæºä»£ç åˆ†æ # 2.4.1. protoc-gen-goå…¥å£å‡½æ•° # file: protobuf/protoc-gen-go/main.go\npackage main import ( \u0026quot;io/ioutil\u0026quot; \u0026quot;os\u0026quot; \u0026quot;github.com/c4pt0r/proto\u0026quot; \u0026quot;github.com/c4pt0r/protoc-gen-go/generator\u0026quot; ) func main() { // é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»£ç ç”Ÿæˆå™¨generatorï¼ŒCodeGeneratorRequestã€CodeGeneratorResponse // ç»“æ„ä½“éƒ½è¢«ä¿å­˜åœ¨generatorä¸­ï¼ŒCodeGenerateResponseä¸­ä¿å­˜ç€ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­ // çš„é”™è¯¯çŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç»“æ„ä½“æå–é”™è¯¯çŠ¶æ€å¹¶è¿›è¡Œé”™è¯¯å¤„ç† g := generator.New() // ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–CodeGeneratorRequestä¿¡æ¯ï¼ˆæ ‡å‡†è¾“å…¥å·²ç»è¢«é‡å®šå‘åˆ°äº†çˆ¶è¿›ç¨‹ // protocè¿›ç¨‹åˆ›å»ºçš„ç®¡é“stdout_pipeçš„è¯»ç«¯ï¼Œçˆ¶è¿›ç¨‹ä¼šä»ç®¡é“çš„å†™ç«¯å†™å…¥è¯¥è¯·æ±‚ä¿¡æ¯ï¼‰ data, err := ioutil.ReadAll(os.Stdin) if err != nil { g.Error(err, \u0026quot;reading input\u0026quot;) } // è¯»å–åˆ°çš„æ•°æ®æ—¶ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGeneratorRequestï¼Œå°†å…¶åä¸²è¡ŒåŒ–æˆCodeGeneratorRequest if err := proto.Unmarshal(data, g.Request); err != nil { g.Error(err, \u0026quot;parsing input proto\u0026quot;) } // æ£€æŸ¥CodeGeneratorRequestä¸­å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶æ•°é‡ï¼Œæ•°é‡ä¸º0åˆ™æ— éœ€ç”Ÿæˆ if len(g.Request.FileToGenerate) == 0 { g.Fail(\u0026quot;no files to generate\u0026quot;) } // å°†CodeGeneratorRequestä¸­ä¼ é€’ç»™ä»£ç ç”Ÿæˆå™¨çš„å‚æ•°è®¾ç½®åˆ°protocæ’ä»¶çš„ä»£ç ç”Ÿæˆå™¨ä¸­ g.CommandLineParameters(g.Request.GetParameter()) // å‰é¢çš„proto.Unmarshal(...)æ“ä½œå°†stdinä¸­çš„è¯·æ±‚åä¸²è¡ŒåŒ–æˆäº†CodeGeneratorRequestï¼Œ // è¿™é‡Œçš„g.WrapTypes()å°†è¯·æ±‚ä¸­çš„ä¸€äº›descriptorsè¿›è¡Œè¿›ä¸€æ­¥å°è£…ï¼Œæ–¹ä¾¿åé¢å¼•ç”¨ g.WrapTypes() g.SetPackageNames() g.BuildTypeNameMap() // ç”Ÿæˆæ‰€æœ‰çš„æºä»£ç æ–‡ä»¶ g.GenerateAllFiles() // å°†CodeGeneratorResponseå¯¹è±¡è¿›è¡Œä¸²è¡ŒåŒ–å¤„ç† data, err = proto.Marshal(g.Response) if err != nil { g.Error(err, \u0026quot;failed to marshal output proto\u0026quot;) } // å°†ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGenerateResponseå¯¹è±¡æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ ‡å‡†è¾“å‡ºå·²ç»è¢« // é‡å®šå‘åˆ°äº†çˆ¶è¿›ç¨‹protocè¿›ç¨‹åˆ›å»ºçš„ç®¡é“stdin_pipeçš„å†™ç«¯ï¼Œçˆ¶è¿›ç¨‹ä»ç®¡é“çš„è¯» // ç«¯è¯»å–è¿™é‡Œçš„å“åº”ï¼‰ _, err = os.Stdout.Write(data) if err != nil { g.Error(err, \u0026quot;failed to write output proto\u0026quot;) } }  2.4.2. å›é¡¾ä¸€ä¸‹CodeGeneratorRequest \u0026amp; CodeGeneratorResponseçš„å®šä¹‰ # ä¸‹é¢çœ‹ä¸‹CodeGeneratorRequestå’ŒCodeGeneratorResponseçš„å®šä¹‰ã€‚\nfile: ${protobuf}/src/google/protobuf/compiler/plugin.go\n// ä¸²è¡ŒåŒ–åçš„CodeGeneratorRequestä¿¡æ¯ä¼šè¢«å†™å…¥åˆ°æ’ä»¶ç¨‹åºçš„stdin message CodeGeneratorRequest { // protocå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­åˆ—å‡ºäº†éœ€è¦è¿›è¡Œå¤„ç†çš„.protoæ–‡ä»¶çš„åç§°ï¼Œä»£ // ç ç”Ÿæˆå™¨åº”è¯¥åªä¸ºè¿™äº›.protoæ–‡ä»¶ç”Ÿæˆæºä»£ç æ–‡ä»¶ã€‚æ¯ä¸€ä¸ª.protoæ–‡ä»¶æˆåŠŸè§£æä¹‹ // åä¼šç”Ÿæˆä¸€ä¸ªFileDescriptorProtoå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«åŠ å…¥åˆ°å­—æ®µproto_fileä¸­ repeated string file_to_generate = 1; // protocå‘½ä»¤è¡Œç¨‹åºä¸­ä¼ é€’ç»™æ’ä»¶ç¨‹åºä»£ç ç”Ÿæˆå™¨çš„å‚æ•°ä¿¡æ¯ optional string parameter = 2; // protocå‘½ä»¤è¡Œä¸­åˆ—å‡ºçš„æ‰€æœ‰çš„.protoæ–‡ä»¶è¢«æ·»åŠ åˆ°äº†å­—æ®µfile_to_generateä¸­ï¼Œè¿™ // äº›.protoæ–‡ä»¶ä¸­é€šè¿‡importå¼•å…¥è¿›æ¥çš„æ–‡ä»¶ï¼Œè¿™ä¸¤éƒ¨åˆ†æ–‡ä»¶è§£ææˆåŠŸåå¯¹åº”çš„ // FileDescriptorProtoå¯¹è±¡éƒ½ä¼šè¢«åŠ å…¥åˆ°è¿™é‡Œçš„proto_fileä¸­ï¼Œæ·»åŠ åçš„é¡ºåºæ˜¯æŒ‰ç…§ // æ‹“æ‰‘é¡ºåºæ’åºçš„ï¼Œæ€ä¹ˆè®²ï¼Ÿå°±æ˜¯è¢«importçš„protoæ–‡ä»¶ä¼šå‡ºç°åœ¨importå®ƒä»¬çš„ proto // æ–‡ä»¶å‰é¢ã€‚ repeated FileDescriptorProto proto_file = 15; } // ä¸²è¡ŒåŒ–åçš„CodeGeneratorResponseä¿¡æ¯ä¼šè¢«å†™å…¥åˆ°æ’ä»¶çš„stdout message CodeGeneratorResponse { // å¦‚æœé”™è¯¯ä¿¡æ¯éç©ºï¼Œè¡¨ç¤ºä»£ç ç”Ÿæˆå¤±è´¥ã€‚è¿™ç§æƒ…å†µä¸‹å°½ç®¡ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œæ’ä»¶è¿›ç¨‹ // ä»ç„¶åº”è¯¥è¿”å›ä¸€ä¸ªçŠ¶æ€0ã€‚ // // è¿™ä¸ªå­—æ®µç”¨äºæŒ‡ç¤º.protoæ–‡ä»¶é”™è¯¯ï¼Œ.protoæ–‡ä»¶ä¸­çš„é”™è¯¯å°†ä½¿å¾—ä»£ç ç”Ÿæˆå™¨æ— æ³•ç”Ÿ // æˆæ­£ç¡®çš„ä»£ç ã€‚æŒ‡ç¤ºprotocæœ¬èº«çš„é”™è¯¯ï¼Œä¾‹å¦‚CodeGeneratorRequestæ•°æ®æ— æ³•è¢«æ­£ // ç¡®åœ°åä¸²è¡ŒåŒ–ï¼Œè¿™ç§æƒ…å†µåº”è¯¥è¢«æŠ¥å‘Šï¼Œé”™è¯¯ä¿¡æ¯åº”è¯¥å†™åˆ°stderrå¹¶ä¸”æ’ä»¶è¿›ç¨‹åº”è¯¥ // è¿”å›ä¸€ä¸ªé0çŠ¶æ€ç  optional string error = 1; // æè¿°ä¸€ä¸ªå¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶ message File { // å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶ç›¸å¯¹äºè¾“å‡ºç›®å½•çš„æ–‡ä»¶å optional string name = 1; // å†™å…¥åˆ°æºä»£ç æ–‡ä»¶ä¸­çš„æ’å…¥ç‚¹ä¿¡æ¯ï¼Œæ–¹ä¾¿åé¢çš„æ’ä»¶åœ¨æ’å…¥ç‚¹å¤„è¿›è¡Œæ‰©å±•å…¶ä»–å†…å®¹ optional string insertion_point = 2; // å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ–‡ä»¶æ’å…¥ç‚¹ä½ç½®çš„å†…å®¹ optional string content = 15; } // æ‰€æœ‰çš„å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶åˆ—è¡¨ repeated File file = 15; }  2.4.3. proto-gen-go generatorå®ç°åˆ†æ # main.goä¸­è°ƒç”¨äº†generatorçš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™å‡ ä¸ªæ–¹æ³•éƒ½åšäº†äº›ä»€ä¹ˆï¼Œç„¶ åå†è·Ÿè¿›ä¸€æ­¥çœ‹çœ‹generatorçš„è¯¦ç»†å®ç°è¿‡ç¨‹ã€‚\n2.4.3.1. generator.New() # file: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// Generatorç±»å‹çš„æ–¹æ³•èƒ½å¤Ÿè¾“å‡ºæºä»£ç ï¼Œè¿™äº›è¾“å‡ºçš„æºä»£ç ä¿¡æ¯å­˜å‚¨åœ¨Responseæˆå‘˜ä¸­ type Generator struct { *bytes.Buffer Request *plugin.CodeGeneratorRequest // The input. Response *plugin.CodeGeneratorResponse // The output. Param map[string]string // Command-line parameters. PackageImportPath string // Go import path of the package we're generating code for ImportPrefix string // String to prefix to imported package file names. ImportMap map[string]string // Mapping from .proto file name to import path Pkg map[string]string // The names under which we import support packages packageName string // What we're calling ourselves. allFiles []*FileDescriptor // All files in the tree allFilesByName map[string]*FileDescriptor // All files by filename. genFiles []*FileDescriptor // Those files we will generate output for. file *FileDescriptor // The file we are compiling now. usedPackages map[string]bool // Names of packages used in current file. typeNameToObject map[string]Object // Key is a fully-qualified name in input syntax. init []string // Lines to emit in the init function. indent string writeOutput bool } // åˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç ç”Ÿæˆå™¨ï¼Œå¹¶åˆ›å»ºè¯·æ±‚ã€å“åº”å¯¹è±¡ func New() *Generator { g := new(Generator) g.Buffer = new(bytes.Buffer) g.Request = new(plugin.CodeGeneratorRequest) g.Response = new(plugin.CodeGeneratorResponse) return g }  2.4.3.2. generator.CommandLineParameters(\u0026hellip;) # è¿™ä¸ªå‡½æ•°æ˜¯è´Ÿè´£è§£æprotocä¼ é€’è¿‡æ¥çš„å‘½ä»¤è¡Œå‚æ•°ä¿¡æ¯çš„ã€‚\nfile: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// å°†éƒ½å¥½åˆ†éš”çš„key=valueåˆ—è¡¨è§£ææˆ\u0026lt;key,value\u0026gt; map func (g *Generator) CommandLineParameters(parameter string) { g.Param = make(map[string]string) for _, p := range strings.Split(parameter, \u0026quot;,\u0026quot;) { if i := strings.Index(p, \u0026quot;=\u0026quot;); i \u0026lt; 0 { g.Param[p] = \u0026quot;\u0026quot; } else { g.Param[p[0:i]] = p[i+1:] } } g.ImportMap = make(map[string]string) pluginList := \u0026quot;none\u0026quot; // Default list of plugin names to enable (empty means all). for k, v := range g.Param { switch k { case \u0026quot;import_prefix\u0026quot;: g.ImportPrefix = v case \u0026quot;import_path\u0026quot;: g.PackageImportPath = v // --go_out=plugins=grpc:.ï¼Œè§£æè¿™é‡Œçš„å‚æ•°plugins=grpc case \u0026quot;plugins\u0026quot;: pluginList = v default: if len(k) \u0026gt; 0 \u0026amp;\u0026amp; k[0] == 'M' { g.ImportMap[k[1:]] = v } } } // åœ¨protoc-gen-goçš„æŸä¸ªåœ°æ–¹å·²ç»å°†grpcæ’ä»¶æ³¨å†Œåˆ°äº†å½“å‰generatorï¼ˆä¹Ÿå°±æ˜¯æ·» // åŠ åˆ°plugins []Pluginä¸­ï¼‰ï¼Œä½†æ˜¯åˆ°åº•æ˜¯åœ¨å“ªé‡Œæ³¨å†Œçš„å‘¢ï¼Ÿåªæœ‰æ³¨å†Œå¹¶æ¿€æ´»ï¼ˆå‚ // æ•°ä¸­é€šè¿‡--go_out=plugins=grpc:.)grpcå­æ’ä»¶ï¼Œè¯¥å­æ’ä»¶æ‰èƒ½è¢«ä½¿ç”¨äºåç»­çš„ // ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼ˆç”Ÿæˆrpcç›¸å…³çš„goæºä»£ç ï¼‰ã€‚ // // å…¶å®è¿™é‡Œçš„grpcå­æ’ä»¶æ³¨å†Œæ˜¯åˆ©ç”¨äº†link_grpc.goé‡Œé¢çš„import _æ“ä½œæ¥éšå¼åœ° // è°ƒç”¨äº†grpc.init()æ–¹æ³•ï¼Œè¯¥åˆå§‹åŒ–æ–¹æ³•ä¸­è´Ÿè´£å®Œæˆå‘generatorçš„æ³¨å†Œæ“ä½œï¼Œå³ // generator.RegisterPlugin(new(grpc))ï¼Œè¿™é‡Œçš„RegisterPluginå…¶å®å°±æ˜¯å°†æŒ‡å®š // çš„å­æ’ä»¶åŠ å…¥åˆ°plugins []Plugin sliceä¸­ã€‚ // ä¸ºäº†èƒ½å¤Ÿåœ¨protoc-gen-goä¸­æ­£ç¡®åœ°å°†grpc linkè¿›å»ï¼Œåœ¨æ„å»ºprotoc-gen-goçš„æ—¶ // å€™éœ€è¦æ‰§è¡Œå‘½ä»¤ï¼š // cd protoc-gen-go \u0026amp; go build main.go link_grpc.go // go buildçš„æ—¶å€™å¦‚æœæ²¡æœ‰åˆ—å‡ºlink_grpc.goï¼Œé‚£ä¹ˆgrpcæ˜¯ä¸ä¼šè¢«linkè¿› // protoc-gen-goè¿™ä¸ªæ’ä»¶çš„ï¼Œè¿™æ ·å¤„ç†.protoæ–‡ä»¶ä¸­çš„serviceæ—¶æ’ä»¶æ˜¯ä¸ä¼šç”Ÿæˆ // serviceç›¸å…³çš„goæºä»£ç çš„ã€‚ // æ ¹æ®--go_out=plugins=?+?+?:.ï¼Œæ›´æ–°æ¿€æ´»çš„æ’ä»¶åˆ—è¡¨ if pluginList != \u0026quot;\u0026quot; { // Amend the set of plugins. enabled := make(map[string]bool) for _, name := range strings.Split(pluginList, \u0026quot;+\u0026quot;) { enabled[name] = true } var nplugins []Plugin for _, p := range plugins { if enabled[p.Name()] { nplugins = append(nplugins, p) } } plugins = nplugins } }  2.4.3.3. generator.WrapTypes() # file: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// WrapTypes walks the incoming data, wrapping DescriptorProtos, EnumDescriptorProtos // and FileDescriptorProtos into file-referenced objects within the Generator. // It also creates the list of files to generate and so should be called before GenerateAllFiles. func (g *Generator) WrapTypes() { g.allFiles = make([]*FileDescriptor, 0, len(g.Request.ProtoFile)) g.allFilesByName = make(map[string]*FileDescriptor, len(g.allFiles)) for _, f := range g.Request.ProtoFile { // We must wrap the descriptors before we wrap the enums descs := wrapDescriptors(f) g.buildNestedDescriptors(descs) enums := wrapEnumDescriptors(f, descs) g.buildNestedEnums(descs, enums) exts := wrapExtensions(f) fd := \u0026amp;FileDescriptor{ FileDescriptorProto: f, desc: descs, enum: enums, ext: exts, exported: make(map[Object][]symbol), proto3: fileIsProto3(f), } extractComments(fd) g.allFiles = append(g.allFiles, fd) g.allFilesByName[f.GetName()] = fd } for _, fd := range g.allFiles { fd.imp = wrapImported(fd.FileDescriptorProto, g) } g.genFiles = make([]*FileDescriptor, 0, len(g.Request.FileToGenerate)) for _, fileName := range g.Request.FileToGenerate { fd := g.allFilesByName[fileName] if fd == nil { g.Fail(\u0026quot;could not find file named\u0026quot;, fileName) } fd.index = len(g.genFiles) g.genFiles = append(g.genFiles, fd) } }  2.4.3.4. generator.GenerateAllFiles() # è°ƒç”¨generatoré’ˆå¯¹æ‰€æœ‰è§£ææˆåŠŸçš„protoæ–‡ä»¶ç”Ÿæˆæ‰€æœ‰çš„goæºä»£ç \nfile: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// ç”Ÿæˆæ‰€æœ‰.protoæ–‡ä»¶å¯¹åº”çš„goæºä»£ç ï¼Œè¿™é‡Œåªæ˜¯å°†æºä»£ç å†…å®¹å­˜å‚¨åˆ°g.Responseä¸­ï¼Œ // å¹¶æ²¡æœ‰ç›´æ¥åˆ›å»ºæºä»£ç æ–‡ä»¶ï¼Œæ’ä»¶å°†Responseä¼ é€’ç»™protocè¿›ç¨‹åç”±protocè¿›ç¨‹æ¥è´Ÿ // è´£åˆ›å»ºæºä»£ç æ–‡ä»¶ func (g *Generator) GenerateAllFiles() { // Initialize the plugins for _, p := range plugins { p.Init(g) } // Generate the output. The generator runs for every file, even the files // that we don't generate output for, so that we can collate the full list // of exported symbols to support public imports. genFileMap := make(map[*FileDescriptor]bool, len(g.genFiles)) for _, file := range g.genFiles { genFileMap[file] = true } for _, file := range g.allFiles { g.Reset() g.writeOutput = genFileMap[file] // è°ƒç”¨generatorçš„generate(...)æ–¹æ³•æ¥ç”Ÿæˆè¯¥protoæ–‡ä»¶çš„ // FileDescriptorProtoæè¿°å¯¹åº”çš„goæºä»£ç  g.generate(file) if !g.writeOutput { continue } g.Response.File = append(g.Response.File, \u0026amp;plugin.CodeGeneratorResponse_File{ Name: proto.String(file.goFileName()), Content: proto.String(g.String()), }) } }  å†çœ‹ä¸‹generator.generate(\u0026hellip;)æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚\n// é’ˆå¯¹.protoæ–‡ä»¶ï¼ˆç”±FileDescriptorè¡¨ç¤ºï¼‰ç”Ÿæˆå¯¹åº”çš„goæºä»£ç  func (g *Generator) generate(file *FileDescriptor) { g.file = g.FileOf(file.FileDescriptorProto) g.usedPackages = make(map[string]bool) // è¦ç”Ÿæˆæºä»£ç çš„é¦–ä¸ªprotoæ–‡ä»¶å¯¹åº”çš„goæºä»£ç ï¼Œè¿™éƒ¨åˆ†ä»£ç é¡¶éƒ¨æ’å…¥ç‰ˆæƒä¿¡æ¯ if g.file.index == 0 { // For one file in the package, assert version compatibility. g.P(\u0026quot;// This is a compile-time assertion to ensure that this generated file\u0026quot;) g.P(\u0026quot;// is compatible with the proto package it is being compiled against.\u0026quot;) g.P(\u0026quot;// A compilation error at this line likely means your copy of the\u0026quot;) g.P(\u0026quot;// proto package needs to be updated.\u0026quot;) g.P(\u0026quot;const _ = \u0026quot;, g.Pkg[\u0026quot;proto\u0026quot;], \u0026quot;.ProtoPackageIsVersion\u0026quot;, generatedCodeVersion, \u0026quot; // please upgrade the proto package\u0026quot;) g.P() } // ç”Ÿæˆimportè¯­å¥ for _, td := range g.file.imp { g.generateImported(td) } // ç”Ÿæˆenumç±»å‹å®šä¹‰è¯­å¥ for _, enum := range g.file.enum { g.generateEnum(enum) } // ç”Ÿæˆmessageç±»å‹å®šä¹‰è¯­å¥ for _, desc := range g.file.desc { // Don't generate virtual messages for maps. if desc.GetOptions().GetMapEntry() { continue } g.generateMessage(desc) } // ç”Ÿæˆextensionç±»å‹å®šä¹‰è¯­å¥ for _, ext := range g.file.ext { g.generateExtension(ext) } // ç”Ÿæˆåˆå§‹åŒ–å‡½æ•°è¯­å¥ g.generateInitFunction() // å‰é¢ç”Ÿæˆenumã€messageã€extensionç­‰çš„æ–¹å¼éƒ½åŸºæœ¬ç±»ä¼¼ï¼Œåé¢æˆ‘ä»¬åªç»™å‡ºä¸€ä¸ª // ç”Ÿæˆæšä¸¾ç±»å‹æ–¹æ³•çš„è¯´æ˜ï¼Œç”Ÿæˆmessageã€extensionçš„å®ç°æ–¹æ³•å¯ä»¥æ‰§è¡ŒæŸ¥çœ‹ // generator.goä¸­çš„å®ç°ã€‚ // // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰é¢çš„å„ä¸ªç”Ÿæˆæºä»£ç çš„æ–¹æ³•ä¸èƒ½å¤„ç†serviceæœåŠ¡å®šä¹‰çš„rpcæ¥ // å£ä»£ç ï¼Œè¿™éƒ¨åˆ†rpcä»£ç çš„ç”Ÿæˆéœ€è¦å€ŸåŠ©äºgrpcå­æ’ä»¶æ¥å®Œæˆï¼Œå³ä¸‹é¢çš„g.runPlugins(...) g.runPlugins(file) g.generateFileDescriptor(file) // å¾…è¾“å‡ºçš„æºä»£ç éœ€è¦çŸ¥é“å“ªäº›packageæ˜¯éœ€è¦importçš„ï¼Œå“ªäº›ä¸éœ€è¦ï¼Œå› æ­¤å…ˆè¿è¡Œ // æ’ä»¶ç”Ÿæˆgoä»£ç ä¸­é™¤importä¹‹å¤–çš„å…¶ä»–éƒ¨åˆ†ä»£ç ï¼Œç„¶åçŸ¥é“äº†å“ªäº›packageéœ€è¦ // importï¼Œå†æ’å…¥å…·ä½“çš„importè¯­å¥ã€‚ // // æœ€ååœ¨goæºä»£ç ä¸­æ’å…¥headerã€import rem := g.Buffer g.Buffer = new(bytes.Buffer) g.generateHeader() g.generateImports() if !g.writeOutput { return } g.Write(rem.Bytes()) // é‡æ–°æ ¼å¼åŒ–ç”Ÿæˆçš„goæºä»£ç ï¼ˆgofmtï¼‰ fset := token.NewFileSet() raw := g.Bytes() ast, err := parser.ParseFile(fset, \u0026quot;\u0026quot;, g, parser.ParseComments) if err != nil { // Print out the bad code with line numbers. // This should never happen in practice, but it can while changing generated code, // so consider this a debugging aid. var src bytes.Buffer s := bufio.NewScanner(bytes.NewReader(raw)) for line := 1; s.Scan(); line++ { fmt.Fprintf(\u0026amp;src, \u0026quot;%5d\\t%s\\n\u0026quot;, line, s.Bytes()) } g.Fail(\u0026quot;bad Go source code was generated:\u0026quot;, err.Error(), \u0026quot;\\n\u0026quot;+src.String()) } g.Reset() err = (\u0026amp;printer.Config{Mode: printer.TabIndent | printer.UseSpaces, Tabwidth: 8}).Fprint(g, fset, ast) if err != nil { g.Fail(\u0026quot;generated Go source code could not be reformatted:\u0026quot;, err.Error()) } }  ä¸Šé¢generate.generate(\u0026hellip;)æ–¹æ³•ä¸­generateEnum()ã€generateMessage()æ–¹æ³•ä¸å…¶ä»–å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯éå¸¸ç±»ä¼¼çš„ï¼Œç”±äºå¤§å®¶ä½¿ç”¨protobufè¿‡ç¨‹ä¸­ä½¿ç”¨enumã€messageæ¯”è¾ƒå¤šï¼Œå¹¶ä¸”generateEnum()ã€generateMessage()æ–¹æ³•æ‰§è¡Œé€»è¾‘éå¸¸ç›¸ä¼¼ï¼Œè€ƒè™‘åˆ°ç¯‡å¹…æ–¹é¢generateEnum()æ¯”generateMessage()ç®€çŸ­ï¼Œè¿™é‡Œæˆ‘ä»¬å°±åªä»¥generateEnum()çš„æºä»£ç ä½œä¸ºç¤ºä¾‹è¿›è¡Œåˆ†æã€‚ç›¸ä¿¡å¦‚æœçœ‹æ‡‚äº†generateEnumçš„å®ç°æ€è·¯ï¼ŒgenerateMessageçš„å®ç°æ€è·¯ä¹Ÿå¾ˆå®¹æ˜“ææ˜ç™½ï¼Œè¯»è€…ä¹Ÿå…·å¤‡äº†è‡ªå·±å®ç°å­æ’ä»¶çš„èƒ½åŠ›ã€‚\n// ç”ŸæˆæŒ‡å®šenumç±»å‹çš„goæºä»£ç  func (g *Generator) generateEnum(enum *EnumDescriptor) { // enumç±»å‹çš„å®Œæ•´ç±»å‹å typeName := enum.TypeName() // CamelCasedä¹‹åçš„å®Œæ•´ç±»å‹å ccTypeName := CamelCaseSlice(typeName) ccPrefix := enum.prefix() // æ‰“å°enumç±»å‹å®šä¹‰ä¹‹å‰çš„leading comments // - æå–æºä»£ç ä¿¡æ¯SourceCodeInfoéƒ½æ˜¯é€šè¿‡Location pathæ¥è·å–çš„ï¼› // - æå–æ³¨é‡Šä¿¡æ¯ä¹Ÿä¸ä¾‹å¤–ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šä»‹ç»PrintComments(path)å¦‚ä½•é€šè¿‡ // Location pathæ¥ç”Ÿæˆæ³¨é‡Šä¿¡æ¯ï¼› g.PrintComments(enum.path) // ç”Ÿæˆæšä¸¾ç±»å‹çš„å®šä¹‰èµ·å§‹éƒ¨åˆ†ï¼štype æšä¸¾ç±»å‹å int32 g.P(\u0026quot;type \u0026quot;, ccTypeName, \u0026quot; int32\u0026quot;) g.file.addExport(enum, enumSymbol{ccTypeName, enum.proto3()}) // æšä¸¾ç±»å‹é‡Œé¢çš„å„ä¸ªæšä¸¾å€¼éƒ½ä½œä¸ºconst int32å¸¸é‡æ¥å®šä¹‰ g.P(\u0026quot;const (\u0026quot;) // æšä¸¾å€¼å®šä¹‰ä¹‹å‰ç¼©è¿›ä¸€ä¸‹ g.In() // é’ˆå¯¹æšä¸¾ç±»å‹é‡Œé¢çš„æ‰€æœ‰æšä¸¾å€¼è¿›è¡Œæºä»£ç ç”Ÿæˆ for i, e := range enum.Value { // ç”Ÿæˆæšä¸¾å€¼å‰é¢çš„leading comments g.PrintComments(fmt.Sprintf(\u0026quot;%s,%d,%d\u0026quot;, enum.path, enumValuePath, i)) // ç”Ÿæˆæšä¸¾å€¼çš„name = valueå½¢å¼çš„goæºä»£ç  name := ccPrefix + *e.Name g.P(name, \u0026quot; \u0026quot;, ccTypeName, \u0026quot; = \u0026quot;, e.Number) g.file.addExport(enum, constOrVarSymbol{name, \u0026quot;const\u0026quot;, ccTypeName}) } // æšä¸¾å€¼å®šä¹‰å®Œä¹‹åå–æ¶ˆç¼©è¿› g.Out() // æ‰“å°æœ€åçš„ç»“æŸä¿¡æ¯ g.P(\u0026quot;)\u0026quot;) // ç”Ÿæˆæšä¸¾ç±»å‹ç›¸å…³çš„ä¸¤ä¸ªmap // - å…¶ä¸­ä¸€ä¸ªæ˜¯æšä¸¾å€¼åˆ°æšä¸¾åçš„æ˜ å°„ï¼› // - å¦ä¸€ä¸ªæ˜¯æšä¸¾ååˆ°æšä¸¾å€¼çš„æ˜ å°„ï¼› g.P(\u0026quot;var \u0026quot;, ccTypeName, \u0026quot;_name = map[int32]string{\u0026quot;) g.In() // ç¬¬ä¸€ä¸ªmap generated := make(map[int32]bool) // avoid duplicate values for _, e := range enum.Value { duplicate := \u0026quot;\u0026quot; if _, present := generated[*e.Number]; present { duplicate = \u0026quot;// Duplicate value: \u0026quot; } g.P(duplicate, e.Number, \u0026quot;: \u0026quot;, strconv.Quote(*e.Name), \u0026quot;,\u0026quot;) generated[*e.Number] = true } g.Out() g.P(\u0026quot;}\u0026quot;) // ç¬¬äºŒä¸ªmap g.P(\u0026quot;var \u0026quot;, ccTypeName, \u0026quot;_value = map[string]int32{\u0026quot;) g.In() for _, e := range enum.Value { g.P(strconv.Quote(*e.Name), \u0026quot;: \u0026quot;, e.Number, \u0026quot;,\u0026quot;) } g.Out() g.P(\u0026quot;}\u0026quot;) // å…¶ä»–å¤„ç†åŠ¨ä½œï¼Œä¹Ÿä¼šç”Ÿæˆéƒ¨åˆ†æºä»£ç ï¼Œè¿™é‡Œå¯ä»¥å¿½ç•¥ä¸è®¡äº† // ... }  ä¸‹é¢çœ‹ä¸€ä¸‹PrintCommentså¦‚ä½•é€šè¿‡Location pathæ¥æå–å¹¶æ‰“å°å…³è”çš„æ³¨é‡Šä¿¡æ¯ã€‚\n// æ‰“å°.protoæ–‡ä»¶ä¸­å¯¹è¯¥location pathå…³è”çš„leading commentsæ³¨é‡Šä¿¡æ¯ func (g *Generator) PrintComments(path string) bool { if !g.writeOutput { return false } // åœ¨protocè¿›ç¨‹è§£æ.protoæ–‡ä»¶çš„æ—¶å€™å°±å·²ç»å°†å„ä¸ªç±»å‹ã€å­—æ®µçš„commentsä¿¡æ¯ç»´ // æŠ¤èµ·æ¥äº†ï¼Œkå°±æ˜¯locationçš„pathï¼Œé€šè¿‡pathå°±èƒ½è·å–åˆ°å¯¹åº”çš„locationï¼Œæ¯ä¸ª // locationä¸­ä¿å­˜äº†è¿™ä¸ªä½ç½®çš„æºä»£ç çš„leading commentsã€trailing commentsä¿¡ // æ¯ï¼Œè¿™é‡Œåªæ‰“å°leading comments if loc, ok := g.file.comments[path]; ok { text := strings.TrimSuffix(loc.GetLeadingComments(), \u0026quot;\\n\u0026quot;) for _, line := range strings.Split(text, \u0026quot;\\n\u0026quot;) { g.P(\u0026quot;// \u0026quot;, strings.TrimPrefix(line, \u0026quot; \u0026quot;)) } return true } return false }  çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å¯¹äºåŸºæœ¬çš„enumã€messageç±»å‹å®šä¹‰ç­‰éƒ½åŸºæœ¬æ¸…æ¥šäº†ï¼Œä¸‹é¢æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹grpcå­æ’ä»¶æ˜¯å¦‚ä½•ç”ŸæˆserviceæœåŠ¡çš„rpcæ¥å£æºä»£ç çš„ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¾—å†æ¥çœ‹ä¸€ä¸‹g.runPlugins(file)æ˜¯å¦‚ä½•å®ç°çš„ã€‚\n// Run all the plugins associated with the file. func (g *Generator) runPlugins(file *FileDescriptor) { // åœ¨ä¸Šè¿°generatorå¤„ç†çš„åŸºç¡€ä¸Šï¼Œç»§ç»­è¿è¡Œgeneratorä¸­æ³¨å†Œçš„æ’ä»¶ï¼Œä¾æ¬¡è¿è¡Œæ’ä»¶ for _, p := range plugins { p.Generate(file) } }  2.4.4. protoc-gen-go grpcå­æ’ä»¶å®ç° # å› ä¸ºä¸Šè¿°2.4.3.4èŠ‚ä¸­runPlugins(\u0026hellip;)çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œpluginsè¿™ä¸ªsliceå†…åªæœ‰ä¸€ä¸ªæœ‰æ•ˆçš„ã€æ¿€æ´»çš„å­æ’ä»¶grpcï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬æƒ³äº†è§£serviceæœåŠ¡å¯¹åº”çš„rpcæ¥å£æºä»£ç æ˜¯å¦‚ä½•ç”Ÿæˆçš„è¯ï¼ŒæŸ¥çœ‹ä¸€ä¸‹grpcè¿™ä¸ªæ’ä»¶çš„Generate(file)æ–¹æ³•å°±å¯ä»¥äº†ã€‚\n// ç”Ÿæˆ.protoæ–‡ä»¶ä¸­serviceå®šä¹‰çš„rpcæ¥å£çš„goæºä»£ç  func (g *grpc) Generate(file *generator.FileDescriptor) { // å¦‚æœæ²¡æœ‰å®šä¹‰serviceæœåŠ¡ç›´æ¥è¿”å› if len(file.FileDescriptorProto.Service) == 0 { return } // ç›¸å…³å˜é‡å®šä¹‰ g.P(\u0026quot;// Reference imports to suppress errors if they are not otherwise used.\u0026quot;) g.P(\u0026quot;var _ \u0026quot;, contextPkg, \u0026quot;.Context\u0026quot;) g.P(\u0026quot;var _ \u0026quot;, grpcPkg, \u0026quot;.ClientConn\u0026quot;) g.P() // æ–­è¨€ï¼Œæ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§ g.P(\u0026quot;// This is a compile-time assertion to ensure that this generated file\u0026quot;) g.P(\u0026quot;// is compatible with the grpc package it is being compiled against.\u0026quot;) g.P(\u0026quot;const _ = \u0026quot;, grpcPkg, \u0026quot;.SupportPackageIsVersion\u0026quot;, generatedCodeVersion) g.P() // é’ˆå¯¹æ‰€æœ‰çš„serviceå®šä¹‰ç”Ÿæˆç›¸å…³çš„serviceçš„goæºä»£ç  for i, service := range file.FileDescriptorProto.Service { g.generateService(file, service, i) } } // grpcä¸­å¯¹generateServiceçš„å®ç°ï¼Œç”Ÿæˆserviceç›¸å…³çš„goæºä»£ç  // @param .protoè§£æåçš„å„ç§DescriptorProtoçš„wrappingç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥æ–¹ä¾¿åœ°è®¿é—®.protoä¸­å®šä¹‰çš„ä¸œè¥¿ // @param .protoä¸­çš„æŸä¸ªserviceè§£æåå¯¹åº”çš„ServiceDescriptorProto // @param .protoä¸­å¯èƒ½å®šä¹‰äº†å¤šä¸ªserviceï¼Œå½“å‰è¿™ä¸ªserviceå¯¹åº”çš„ç´¢å¼•å€¼ func (g *grpc) generateService(file *generator.FileDescriptor, service *pb.ServiceDescriptorProto, index int) { // æ„å»ºå½“å‰serviceå¯¹åº”çš„path! path := fmt.Sprintf(\u0026quot;6,%d\u0026quot;, index) // 6 means service. // è·å–serviceåç§° origServName := service.GetName() fullServName := origServName if pkg := file.GetPackage(); pkg != \u0026quot;\u0026quot; { fullServName = pkg + \u0026quot;.\u0026quot; + fullServName } servName := generator.CamelCase(origServName) // å‡†å¤‡ç”Ÿæˆclientç›¸å…³çš„goæºä»£ç  g.P() g.P(\u0026quot;// Client API for \u0026quot;, servName, \u0026quot; service\u0026quot;) g.P() // æœåŠ¡ç”¨æˆ·ç«¯goæºä»£ç ç”Ÿæˆ // - type æœåŠ¡å+Client interface g.P(\u0026quot;type \u0026quot;, servName, \u0026quot;Client interface {\u0026quot;) // - æœåŠ¡ç”¨æˆ·ç«¯å®šä¹‰çš„å„ä¸ªæ¥å£æ–¹æ³• for i, method := range service.Method { // æ‰“å°æ¥å£çš„leading comments g.gen.PrintComments(fmt.Sprintf(\u0026quot;%s,2,%d\u0026quot;, path, i)) // 2 means method in a service. // ç”Ÿæˆæ¥å£çš„ç­¾å g.P(g.generateClientSignature(servName, method)) } g.P(\u0026quot;}\u0026quot;) g.P() // æœåŠ¡çš„ç”¨æˆ·ç«¯structï¼Œå…¶ä¸­åŒ…æ‹¬äº†ä¸€ä¸ªcc *grpc.ClientConnï¼Œåé¢ä¼šåœ¨è¯¥struct // ä¸Šå®ç°ä¸Šè¿°æœåŠ¡æ¥å£ g.P(\u0026quot;type \u0026quot;, unexport(servName), \u0026quot;Client struct {\u0026quot;) g.P(\u0026quot;cc *\u0026quot;, grpcPkg, \u0026quot;.ClientConn\u0026quot;) g.P(\u0026quot;}\u0026quot;) g.P() // NewClientå·¥å‚ g.P(\u0026quot;func New\u0026quot;, servName, \u0026quot;Client (cc *\u0026quot;, grpcPkg, \u0026quot;.ClientConn) \u0026quot;, servName, \u0026quot;Client {\u0026quot;) g.P(\u0026quot;return \u0026amp;\u0026quot;, unexport(servName), \u0026quot;Client{cc}\u0026quot;) g.P(\u0026quot;}\u0026quot;) g.P() var methodIndex, streamIndex int serviceDescVar := \u0026quot;_\u0026quot; + servName + \u0026quot;_serviceDesc\u0026quot; // æœåŠ¡ç”¨æˆ·ç«¯çš„æ¥å£æ–¹æ³•å®ç° for _, method := range service.Method { var descExpr string if !method.GetServerStreaming() \u0026amp;\u0026amp; !method.GetClientStreaming() { // Unary RPC method descExpr = fmt.Sprintf(\u0026quot;\u0026amp;%s.Methods[%d]\u0026quot;, serviceDescVar, methodIndex) methodIndex++ } else { // Streaming RPC method descExpr = fmt.Sprintf(\u0026quot;\u0026amp;%s.Streams[%d]\u0026quot;, serviceDescVar, streamIndex) streamIndex++ } g.generateClientMethod(servName, fullServName, serviceDescVar, method, descExpr) } g.P(\u0026quot;// Server API for \u0026quot;, servName, \u0026quot; service\u0026quot;) g.P() // æœåŠ¡ç«¯æ¥å£goæºä»£ç ç”Ÿæˆ ... }  åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå·²ç»æè¿°äº†protoc-gen-goä¸­çš„generatoråšäº†å“ªäº›å·¥ä½œï¼Œä¸ä¹‹åä½œçš„grpcåˆåšäº†ä»€ä¹ˆï¼Œä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯ï¼šgeneratorè´Ÿè´£ç”Ÿæˆé™¤serviceä¹‹å¤–çš„å…¶ä»–goä»£ç ï¼Œgrpcè´Ÿè´£ç”Ÿæˆserviceç›¸å…³çš„goä»£ç ã€‚åœ¨æè¿°protoc-gen-goå®ç°çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ä¹Ÿæè¿°äº†å“ªäº›ä¿¡æ¯è¯¥ä»å“ªé‡Œæå–ï¼Œæ¯”å¦‚å®šä¹‰çš„messageç±»å‹ã€enumç±»å‹ã€serviceåŠå…¶æ³¨é‡Šç­‰ä¿¡æ¯ã€‚ç›¸ä¿¡çœ‹åˆ°è¿™é‡Œï¼Œè¯»è€…åº”è¯¥å¯ä»¥ç‹¬ç«‹å¼€å‘ä¸€ä¸ªprotocæ’ä»¶äº†å§ã€‚\n3. æ€»ç»“ # æœ¬æ–‡ç»“åˆprotocæºä»£ç ã€protoc-gen-goæºä»£ç ï¼Œå¯¹protocã€protocæ’ä»¶å·¥ä½œåŸç†è¿›è¡Œäº†è¾ƒä¸ºè¯¦ç»†çš„åˆ†æã€æ€»ç»“ï¼Œå¸Œæœ›èƒ½å¯¹æƒ³äº†è§£è¿™æ–¹é¢å†…å®¹æˆ–è€…æœ‰æ„å‘å¼€å‘protocæ’ä»¶æ‰©å±•protocåŠŸèƒ½çš„è¯»è€…æœ‰å¸®åŠ©ã€‚\nç”±äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œå¯èƒ½æœ‰ç†è§£ä¸åˆ°ä½ç”šè‡³é”™è¯¯çš„åœ°æ–¹ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶æŒ‡å‡ºæ¥ã€‚\n"}),a.add({id:365,href:"/blog/2017-05-16-protoc%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/",title:"Protocå·¥ä½œåŸç†åˆ†æ",description:"å›¢é˜Ÿç»å¸¸ä½¿ç”¨protobufä½œä¸ºæ¶ˆæ¯äº¤æ¢æ ¼å¼ï¼Œç”±äºprotobufå…·æœ‰å¾ˆå¼ºçš„è‡ªæè¿°æ€§ï¼Œéå¸¸é€‚åˆå¯¹ä¸€ä¸ªæœåŠ¡è¿›è¡Œå»ºæ¨¡ã€‚ç»“åˆé…å¥—çš„ç¼–è¯‘å™¨protocï¼Œå¯ä»¥è½»æ¾ç†è§£æœåŠ¡ä¿¡æ¯ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¯ä»¥å¼€å‘ä¸€äº›è„šæ‰‹æ¶å·¥å…·ï¼ˆå¦‚protoc-gen-goï¼‰æ¥å®Œæˆä»£ç ç”Ÿæˆã€æ¥å£è‡ªåŠ¨æµ‹è¯•ã€ç”Ÿæˆapiæ–‡æ¡£ç­‰ç­‰å·¥ä½œã€‚æœ¬æ–‡å°±æ¥ä»‹ç»ä¸‹protocåŠå…¶æ’ä»¶çš„å·¥ä½œåŸç†ï¼Œè¯»å®Œåè¯»è€…å°†å…·å¤‡å®šåˆ¶åŒ–protocæ’ä»¶å¼€å‘çš„èƒ½åŠ›ã€‚",content:"åœ¨è¿›è¡Œprotocæ’ä»¶å¼€å‘ä¹‹å‰ï¼Œé¦–å…ˆè¦äº†è§£protocçš„å·¥ä½œåŸç†ã€‚åœ¨protobufçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œprotocä½œä¸ºprotoæ–‡ä»¶çš„ç¼–è¯‘å™¨ï¼Œå¾ˆå¤šå¼€å‘äººå‘˜åªä¼šç”¨ä½†æ˜¯ä¸äº†è§£å…¶å·¥ä½œåŸç†ï¼Œæ›´ä¸äº†è§£å¦‚ä½•æ‰©å±•å…¶åŠŸèƒ½ã€‚protobufä½œä¸ºç›®å‰å¸¸ç”¨çš„æ•°æ®äº¤æ¢æ ¼å¼åœ¨åè®®å¼€å‘ä¸­è¢«å¹¿æ³›é‡‡ç”¨ï¼Œæ­¤å¤–ï¼Œprotocå¯¹protoæ–‡ä»¶çš„å¼ºå¤§è§£æèƒ½åŠ›ä½¿æˆ‘ä»¬å¯ä»¥å¼€å‘ä¸€äº›æ’ä»¶ï¼Œé€šè¿‡æ’ä»¶å¿«é€Ÿç”Ÿæˆç‰¹å®šäºprotoæ–‡ä»¶çš„å·¥å…·ç±»ã€é…ç½®æ–‡ä»¶ç­‰ï¼Œä»è€Œæé«˜å¼€å‘æ•ˆç‡ã€‚\næœ¬æ–‡é¦–å…ˆä¼šä»‹ç»ä¸€ä¸‹protocçš„æ•´ä½“å·¥ä½œæœºåˆ¶ï¼Œç„¶åè§£é‡Šä¸€ä¸‹protocå¯¹protoæ–‡ä»¶çš„è§£æè¿‡ç¨‹ï¼Œæœ€åç»™å‡ºç¼–å†™protocæ’ä»¶æ‰©å±•protocåŠŸèƒ½çš„ä¸€ä¸ªç¤ºä¾‹æ•™ç¨‹ã€‚\n1. protocæºä»£ç å‡†å¤‡ # è¦æƒ³äº†è§£protocçš„å·¥ä½œæœºåˆ¶ï¼ŒæŸ¥çœ‹å…¶æºä»£ç äº†è§£å…¶æ ¸å¿ƒæµç¨‹æ˜¯æœ€é è°±çš„æ–¹æ³•ã€‚\nè·å–ç¨‹åºæºä»£ç çš„æ–¹å¼å¦‚ä¸‹ï¼š\ngit co https://github.com/google/protobuf  ç”±äºæˆ‘ä»¬å·¥ç¨‹ä¸­å¸¸ç”¨çš„protocç‰ˆæœ¬æ˜¯v2.5.0ï¼Œæ‰€ä»¥è¿™é‡Œæ£€å‡ºå¯¹åº”ç‰ˆæœ¬çš„tagã€‚\ngit ck v2.5.0  è€ƒè™‘åˆ°å¯èƒ½ä¼šè¿›è¡Œæµ‹è¯•ã€ä¿®æ”¹ã€æ³¨é‡Šç­‰å­¦ä¹ è¿‡ç¨‹ï¼Œè¿™é‡Œæœ€å¥½åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æ”¯æ¥æ“ä½œã€‚\ngit branch ${new-branch-name} git ck ${new-branch-name}  ç°åœ¨æºä»£ç å‡†å¤‡å¥½äº†ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢ä½¿ç”¨vimã€ctagsã€cscopeæ¥é˜…è¯»æºç ï¼Œæ ¹æ®ä¸ªäººä¹ æƒ¯å§ï¼Œä¸‹é¢å¯ä»¥é˜…è¯»protocçš„æºç æ¢³ç†ä»¥ä¸‹å·¥ä½œæœºåˆ¶ã€‚\n2. protocæºç åˆ†æ # ä¸Šè¿°gitæ£€å‡ºåçš„protobufè·¯å¾„ï¼Œè®°ä¸º${protobuf}ï¼Œåé¢å¦‚æœå‡ºç°${protobuf}è¯·çŸ¥æ™“å…¶å«ä¹‰ã€‚å¦‚æœåœ¨æè¿°æºä»£ç æ—¶æ²¡æœ‰æåŠèµ·å§‹è·¯å¾„${protobuf}ï¼Œé‚£ä¹ˆèµ·å§‹è·¯å¾„å‡ä¸º${protobuf}ã€‚\n2.1. protocç¨‹åºå…¥å£ # src/google/protobuf/compiler/main.ccä¸­çš„mainå‡½æ•°ï¼Œä¸ºprotocçš„å…¥å£å‡½æ•°ã€‚\nfile: src/google/protobuf/compiler/main.cc\n// Author: kenton@google.com (Kenton Varda) // è¿™ä¸ªå¤´æ–‡ä»¶å®šä¹‰äº†protocçš„å‘½ä»¤è¡Œæ¥å£ #include \u0026lt;google/protobuf/compiler/command_line_interface.h\u0026gt; // protocä¸­å†…ç½®äº†å¯¹cppã€pythonã€javaè¯­è¨€çš„æ”¯æŒï¼Œå¯¹å…¶ä»–è¯­è¨€çš„æ”¯æŒéœ€è¦ä»¥pluginçš„æ–¹å¼æ¥æ”¯æŒ #include \u0026lt;google/protobuf/compiler/cpp/cpp_generator.h\u0026gt; #include \u0026lt;google/protobuf/compiler/python/python_generator.h\u0026gt; #include \u0026lt;google/protobuf/compiler/java/java_generator.h\u0026gt; int main(int argc, char* argv[]) { // åˆå§‹åŒ–protocå‘½ä»¤è¡Œæ¥å£å¹¶å¼€å¯æ’ä»¶ // - æ’ä»¶åªæ˜¯æ™®é€šçš„å¯æ‰§è¡Œç¨‹åºï¼Œå…¶æ–‡ä»¶åä»¥AllowPluginså‚æ•°protoc-å¼€å¤´ // - å‡å®šprotoc --foo_outï¼Œé‚£ä¹ˆå®é™…è°ƒç”¨çš„æ’ä»¶æ˜¯protoc-foo google::protobuf::compiler::CommandLineInterface cli; cli.AllowPlugins(\u0026quot;protoc-\u0026quot;); // Proto2 C++ (æŒ‡å®šäº†--cpp_outå°†è°ƒç”¨cpp::Generator) google::protobuf::compiler::cpp::CppGenerator cpp_generator; cli.RegisterGenerator(\u0026quot;--cpp_out\u0026quot;, \u0026quot;--cpp_opt\u0026quot;, \u0026amp;cpp_generator, \u0026quot;Generate C++ header and source.\u0026quot;); // Proto2 Java (æŒ‡å®šäº†--java_outå°†è°ƒç”¨java::Generator) google::protobuf::compiler::java::JavaGenerator java_generator; cli.RegisterGenerator(\u0026quot;--java_out\u0026quot;, \u0026amp;java_generator, \u0026quot;Generate Java source file.\u0026quot;); // Proto2 Python (æŒ‡å®šäº†python_outå°†è°ƒç”¨python::Generator) google::protobuf::compiler::python::Generator py_generator; cli.RegisterGenerator(\u0026quot;--python_out\u0026quot;, \u0026amp;py_generator, \u0026quot;Generate Python source file.\u0026quot;); // è§£æprotoã€ç”Ÿæˆæºä»£ç (å€ŸåŠ©å†…ç½®çš„generatoræˆ–è€…plugins)ã€åˆ›å»ºæºä»£ç æ–‡ä»¶ return cli.Run(argc, argv); }  2.2. protocå‘½ä»¤è¡Œæ¥å£å®šä¹‰ # ä¸‹é¢çœ‹ä¸€ä¸‹protocçš„å‘½ä»¤è¡Œæ¥å£å®šä¹‰ï¼Œä»¥äº†è§£å…¶å¯¹å‘½ä»¤è¡Œflagsã€optionsçš„è§£é‡Šè¿‡ç¨‹ä»¥åŠå¯¹åç»­ç¨‹åºæ‰§è¡Œé€»è¾‘çš„å½±å“ã€‚\nfile: src/google/protobuf/compiler/command_line_interface.h\n// Author: kenton@google.com (Kenton Varda) // Based on original Protocol Buffers design by // Sanjay Ghemawat, Jeff Dean, and others. // // Implements the Protocol Compiler front-end such that it may be reused by // custom compilers written to support other languages. #ifndef GOOGLE_PROTOBUF_COMPILER_COMMAND_LINE_INTERFACE_H__ #define GOOGLE_PROTOBUF_COMPILER_COMMAND_LINE_INTERFACE_H__ #include \u0026lt;google/protobuf/stubs/common.h\u0026gt; #include \u0026lt;string\u0026gt; #include \u0026lt;vector\u0026gt; #include \u0026lt;map\u0026gt; #include \u0026lt;set\u0026gt; #include \u0026lt;utility\u0026gt; namespace google { namespace protobuf { //protoæ–‡ä»¶ä¸­å®šä¹‰çš„æ•°æ®ç±»å‹å¯é€šè¿‡FileDescriptoræ¥éå†ã€æŸ¥çœ‹ class FileDescriptor; // descriptor.h class DescriptorPool; // descriptor.h class FileDescriptorProto; // descriptor.pb.h template\u0026lt;typename T\u0026gt; class RepeatedPtrField; // repeated_field.h namespace compiler { class CodeGenerator; // code_generator.h class GeneratorContext; // code_generator.h class DiskSourceTree; // importer.h // è¿™ä¸ªç±»å®ç°äº†protocçš„å‘½ä»¤è¡Œæ¥å£ï¼Œä½¿å¾—protocå¾ˆå®¹æ˜“æ‰©å±•ã€‚ // ä¾‹å¦‚æˆ‘ä»¬æƒ³è®©protocæ—¢æ”¯æŒcppåˆæ”¯æŒå¦ä¸€ç§è¯­è¨€fooï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå®ç°äº† // CodeGeneratoræ¥å£çš„FooGeneratorï¼Œç„¶ååœ¨protocçš„mainæ–¹æ³•ä¸­å¯¹è¿™ä¸¤ç§è¯­è¨€cppã€Foo // åŠå…¶å¯¹åº”çš„CodeGeneratorè¿›è¡Œæ³¨å†Œã€‚ // // int main(int argc, char* argv[]) { // google::protobuf::compiler::CommandLineInterface cli; // // // æ”¯æŒcpp // google::protobuf::compiler::cpp::CppGenerator cpp_generator; // cli.RegisterGenerator(\u0026quot;--cpp_out\u0026quot;, \u0026amp;cpp_generator, \u0026quot;Generate C++ source and header.\u0026quot;); // // // æ”¯æŒfoo // FooGenerator foo_generator; // cli.RegisterGenerator(\u0026quot;--foo_out\u0026quot;, \u0026amp;foo_generator, \u0026quot;Generate Foo file.\u0026quot;); // // return cli.Run(argc, argv); // } // // The compiler is invoked with syntax like: // protoc --cpp_out=outdir --foo_out=outdir --proto_path=src src/foo.proto // // For a full description of the command-line syntax, invoke it with --help. class LIBPROTOC_EXPORT CommandLineInterface { public: CommandLineInterface(); ~CommandLineInterface(); // ä¸ºæŸç§ç¼–ç¨‹è¯­è¨€æ³¨å†Œä¸€ä¸ªå¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼ˆå…¶å®è¿™é‡Œä¹Ÿä¸ä¸€å®šéå¾—æ˜¯è¯­è¨€ï¼‰ // // å‘½ä»¤è¡Œæ¥å£çš„å‚æ•°: // @param flag_name æŒ‡å®šè¾“å‡ºæ–‡ä»¶ç±»å‹çš„å‘½ä»¤ï¼Œä¾‹å¦‚--cpp_outï¼Œå‚æ•°åå­—å¿…é¡»ä»¥â€œ-â€å¼€å¤´ï¼Œ å¦‚æœåå­—å¤§äºä¸¤ä¸ªå­—ç¬¦ï¼Œåˆ™å¿…é¡»ä»¥â€œ--â€å¼€å¤´ã€‚ // @param generator ä¸flag_nameå¯¹åº”çš„CodeGeneratoræ¥å£å®ç° // @param help_text æ‰§è¡Œprotoc --helpçš„æ—¶å€™å¯¹è¿™é‡Œçš„flag_nameçš„è¯´æ˜æ€§ä¿¡æ¯ // // æŸäº›ä»£ç ç”Ÿæˆå™¨å¯æ¥å—é¢å¤–å‚æ•°ï¼Œè¿™äº›å‚æ•°åœ¨è¾“å‡ºè·¯å¾„ä¹‹å‰ç»™å‡ºï¼Œä¸è¾“å‡ºè·¯å¾„ä¹‹é—´ç”¨â€œ:â€åˆ†éš”ã€‚ // protoc --foo_out=enable_bar:outdir // è¿™é‡Œçš„:outdirä¹‹å‰çš„enable_barè¢«ä½œä¸ºå‚æ•°ä¼ é€’ç»™CodeGenerator::Generate()çš„å‚æ•°ã€‚ void RegisterGenerator(const string\u0026amp; flag_name, CodeGenerator* generator, const string\u0026amp; help_text); // ä¸ºæŸç§ç¼–ç¨‹è¯­è¨€æ³¨å†Œä¸€ä¸ªå¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ // ... // @param option_flag_name æŒ‡å®šé¢å¤–çš„é€‰é¡¹ // ... // // ä¸å‰é¢ä¸€ä¸ªå‡½æ•°RegisterGeneratoræ‰€ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªé‡è½½å‡½æ•°å¤šä¸ªå‚æ•° // option_flag_nameï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°æ³¨å†Œçš„è¯­è¨€å’Œä»£ç ç”Ÿæˆå™¨å¯ä»¥æ¥å—é¢å¤–çš„å‚æ•°ã€‚ä¾‹ // å¦‚é€šè¿‡command_line_interface.RegisterGenerator(\u0026quot;--foo_out\u0026quot;, \u0026quot;--foo_opt\u0026quot;, ...) // æ³¨å†Œäº†fooä»¥åŠå¯¹åº”ä»£ç ç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œprotoc çš„æ—¶å€™æŒ‡å®šé¢å¤–çš„å‚æ•° // --foo_optï¼šprotoc --foo_out=enable_bar:outdir --foo_opt=enable_bazï¼Œæ­¤æ—¶ä¼  // é€’ç»™ä»£ç ç”Ÿæˆå™¨çš„å‚æ•°å°†ä¼šåŒ…æ‹¬enable_barå’Œenable_bazã€‚ void RegisterGenerator(const string\u0026amp; flag_name, const string\u0026amp; option_flag_name, CodeGenerator* generator, const string\u0026amp; help_text); // RegisterGeneratoræ–¹æ³•æ˜¯åœ¨protocçš„mainæ–¹æ³•ä¸­è¿›è¡Œè¯­è¨€ã€ä»£ç ç”Ÿæˆå™¨çš„æ³¨å†Œï¼Œåœ¨ // ç”Ÿäº§ç¯å¢ƒä¸­ä¸å¯èƒ½å…è®¸å¼€å‘äººå‘˜è‚†æ„ä¿®æ”¹å…¬ç”¨ç¨‹åºåº“ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¦‚æœè¦åœ¨ç¨³å®šåœ° // protoc v2.5.0åŸºç¡€ä¸Šè¿›è¡Œæºç çš„ä¿®æ”¹è¿™æ¡è·¯æ˜¯è¡Œä¸é€šçš„ï¼Œé‚£ä¹ˆå¦‚ä½•è‡ªç”±åœ°æ‰©å±•å…¶åŠŸ // èƒ½å‘¢ï¼Ÿprotocæä¾›äº†â€œpluginâ€æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æ’ä»¶æ¥å®ç°å¯¹å…¶ä»–è¯­è¨€ //ï¼ˆç”šè‡³ä¸æ˜¯è¯­è¨€ï¼‰çš„æ”¯æŒã€‚ // å¼€å¯protocå¯¹æ’ä»¶çš„æ”¯æŒï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼Œå¦‚æœä¸€ä¸ªå‘½ä»¤è¡Œé€‰é¡¹ä»¥_outç»“å°¾ï¼Œä¾‹å¦‚ // --xxx_outï¼Œä½†æ˜¯åœ¨protocå·²ç»æ³¨å†Œçš„è¯­è¨€æ”¯æŒä¸­æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è¯­è¨€åŠä»£ç ç”Ÿæˆå™¨ï¼Œ // è¿™ä¸ªæ—¶å€™protocå°±ä¼šå»æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…çš„æ’ä»¶æ”¯æŒè¿™ç§è¯­è¨€ï¼Œå°†è¿™ä¸ªæ’ä»¶æ¥ä½œä¸ºä»£ // ç ç”Ÿæˆå™¨ä½¿ç”¨ã€‚è¿™é‡Œçš„çš„protocæ’ä»¶æ˜¯ä¸€ä¸ª$PATHä¸­å¯æœç´¢åˆ°çš„å¯æ‰§è¡Œç¨‹åºï¼Œå½“ç„¶ // è¿™ä¸ªå¯æ‰§è¡Œç¨‹åºç¨å¾®æœ‰ç‚¹ç‰¹æ®Šã€‚ // è¿™é‡Œæ’ä»¶åç§°ï¼ˆå¯æ‰§è¡Œç¨‹åºåç§°ï¼‰æ˜¯å¦‚ä½•ç¡®å®šçš„å‘¢ï¼Ÿé€‰é¡¹--xxx_outä¸­ï¼Œæˆªå–â€œxxxâ€ï¼Œ // ç„¶åæ ¹æ®${exe_name_prefix}ä»¥åŠxxxæ¥æ‹¼æ¥å‡ºä¸€ä¸ªæ’ä»¶çš„åå­—ï¼Œå‡å¦‚${exe_name_prefix} // æ˜¯protoc-ï¼Œé‚£ä¹ˆæ’ä»¶çš„åå­—å°±æ˜¯protoc-xxxï¼Œprotocå°†å°è¯•æ‰§è¡Œè¿™ä¸ªç¨‹åºæ¥å®Œæˆä»£ // ç ç”Ÿæˆçš„å·¥ä½œã€‚ // å‡å®šæ’ä»¶çš„åå­—æ˜¯pluginï¼Œprotocæ˜¯è¿™æ ·è°ƒç”¨è¿™ä¸ªæ’ä»¶çš„ï¼š // plugin [--out=OUTDIR] [--parameter=PARAMETER] PROTO_FILES \u0026lt; DESCRIPTORS // é€‰é¡¹è¯´æ˜ï¼š // --outï¼šæŒ‡æ˜äº†æ’ä»¶ä»£ç ç”Ÿæˆæ—¶çš„è¾“å‡ºç›®å½•ï¼ˆè·Ÿé€šè¿‡--foo_outä¼ é€’ç»™protocçš„ä¸€æ ·ï¼‰, // å¦‚æœçœç•¥è¿™ä¸ªå‚æ•°ï¼Œè¾“å‡ºç›®å½•å°±æ˜¯å½“å‰ç›®å½•ã€‚ // --parameterï¼šæŒ‡æ˜äº†ä¼ é€’ç»™ä»£ç ç”Ÿæˆå™¨çš„å‚æ•°ã€‚ // PROTO_FILESï¼šæŒ‡æ˜äº†protocè°ƒç”¨æ—¶ä¼ é€’ç»™protocçš„å¾…å¤„ç†çš„.protoæ–‡ä»¶åˆ—è¡¨ã€‚ // DESCRIPTORS: ç¼–ç åçš„FileDescriptorSetï¼ˆè¿™ä¸ªåœ¨descriptor.protoä¸­å®šä¹‰ï¼‰ï¼Œ // è¿™é‡Œç¼–ç åçš„æ•°æ®é€šè¿‡ç®¡é“é‡å®šå‘åˆ°æ’ä»¶çš„æ ‡å‡†è¾“å…¥ï¼Œè¿™é‡Œçš„FileDescriptorSetåŒ…æ‹¬ // PROTO_FILESä¸­åˆ—å‡ºçš„æ‰€æœ‰protoæ–‡ä»¶çš„descriptorsï¼Œä¹ŸåŒ…æ‹¬è¿™äº›PROTO_FILESä¸­ // protoæ–‡ä»¶importè¿›æ¥çš„å…¶ä»–protoæ–‡ä»¶ã€‚æ’ä»¶ä¸åº”è¯¥ç›´æ¥è¯»å–PROTO_FILESä¸­çš„ // protoæ–‡ä»¶ï¼Œè€Œåº”è¯¥ä½¿ç”¨è¿™é‡Œçš„DESCRIPTORSã€‚ // // æ’ä»¶è·Ÿprotoc mainå‡½æ•°ä¸­æ³¨å†Œçš„ä»£ç ç”Ÿæˆå™¨ä¸€æ ·ï¼Œå®ƒä¹Ÿéœ€è¦ç”Ÿæˆæ‰€æœ‰å¿…é¡»çš„æ–‡ä»¶ã€‚ // æ’ä»¶ä¼šå°†æ‰€æœ‰è¦ç”Ÿæˆçš„æ–‡ä»¶çš„åå­—å†™åˆ°stdoutï¼Œæ’ä»¶åå­—æ˜¯ç›¸å¯¹äºå½“å‰è¾“å‡ºç›®å½•çš„ã€‚å¦‚ // æœæ’ä»¶å·¥ä½œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼Œéœ€è¦å°†é”™è¯¯ä¿¡æ¯å†™åˆ°stderrï¼Œå¦‚æœå‘ç”Ÿäº†ä¸¥é‡é”™è¯¯ï¼Œ // æ’ä»¶åº”è¯¥é€€å‡ºå¹¶è¿”å›ä¸€ä¸ªé0çš„è¿”å›ç ã€‚æ’ä»¶å†™å‡ºçš„æ•°æ®ä¼šè¢«protocè¯»å–å¹¶æ‰§è¡Œåç»­ // å¤„ç†é€»è¾‘ã€‚ void AllowPlugins(const string\u0026amp; exe_name_prefix); // æ ¹æ®æŒ‡å®šçš„å‘½ä»¤è¡Œå‚æ•°æ¥æ‰§è¡Œprotocol compilerï¼Œè¿”å›å€¼å°†ç”±mainè¿”å›ã€‚ // // Run()æ–¹æ³•æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºå…¶ä¸­è°ƒç”¨äº†strerror()ï¼Œä¸è¦åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚ int Run(int argc, const char* const argv[]); // protoè·¯å¾„è§£æçš„æ§åˆ¶è¯´æ˜ï¼Œfixme // Call SetInputsAreCwdRelative(true) if the input files given on the command // line should be interpreted relative to the proto import path specified // using --proto_path or -I flags. Otherwise, input file names will be // interpreted relative to the current working directory (or as absolute // paths if they start with '/'), though they must still reside inside // a directory given by --proto_path or the compiler will fail. The latter // mode is generally more intuitive and easier to use, especially e.g. when // defining implicit rules in Makefiles. void SetInputsAreProtoPathRelative(bool enable) { inputs_are_proto_path_relative_ = enable; } // è®¾ç½®æ‰§è¡Œprotoc --versionæ—¶æ‰“å°çš„ç‰ˆæœ¬ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™è¡Œç‰ˆæœ¬ä¿¡æ¯çš„ä¸‹ä¸€è¡Œä¹Ÿä¼šæ‰“å°libprotocçš„ç‰ˆæœ¬ã€‚ void SetVersionInfo(const string\u0026amp; text) { version_info_ = text; } private: // ----------------------------------------------------------------- // è¿™ä¸ªç±»çš„åç»­éƒ¨åˆ†ä»£ç ï¼Œè™½ç„¶ä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œä½†æ˜¯å³ä¾¿åœ¨è¿™é‡Œå…ˆä¸è§£é‡Šï¼Œä¹Ÿä¸ä¼šç»™æˆ‘ // ä»¬çš„ç†è§£é€ æˆå¤ªå¤šå¹²æ‰°ï¼Œä¸ºäº†ç®€åŒ–ç¯‡å¹…å¹¶ä¸”é¿å…è¿‡æ—©åœ°é™·å…¥ç»†èŠ‚è€Œåç¦»å¯¹æ•´ä½“çš„æŠŠ // æ¡ï¼Œè¿™é‡Œæˆ‘å…ˆæŠŠè¿™ä¸ªç±»çš„åç»­éƒ¨åˆ†ä»£ç è¿›è¡Œåˆ å‡â€¦â€¦åªä¿ç•™ç›¸å¯¹æ¯”è¾ƒé‡è¦çš„ã€‚ class GeneratorContextImpl; class MemoryOutputStream; // æ¸…æ¥šä¸Šæ¬¡Run()è¿è¡Œæ—¶è®¾ç½®çš„çŠ¶æ€ void Clear(); // æ˜ å°„input_files_ä¸­çš„æ¯ä¸ªæ–‡ä»¶ï¼Œä½¿å…¶å˜æˆç›¸å¯¹äºproto_path_ä¸­å¯¹åº”ç›®å½•çš„ç›¸å¯¹è·¯å¾„ // - å½“inputs_are_proto_path_relative_ä¸ºfalseçš„æ—¶å€™æ‰ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼› // - å‡ºé”™è¿”å›falseï¼Œåä¹‹è¿”å›trueï¼› bool MakeInputsBeProtoPathRelative(DiskSourceTree* source_tree); // ParseArguments() \u0026amp; InterpretArgument()è¿”å›çš„çŠ¶æ€ enum ParseArgumentStatus { PARSE_ARGUMENT_DONE_AND_CONTINUE, PARSE_ARGUMENT_DONE_AND_EXIT, PARSE_ARGUMENT_FAIL }; // è§£ææ‰€æœ‰çš„å‘½ä»¤è¡Œå‚æ•° ParseArgumentStatus ParseArguments(int argc, const char* const argv[]); // è§£ææŸä¸ªå‘½ä»¤è¡Œå‚æ•° // - å‚æ•°åæ”¾nameï¼Œå‚æ•°å€¼æ”¾value // - å¦‚æœargvä¸­çš„ä¸‹ä¸€ä¸ªå‚æ•°åº”è¯¥è¢«å½“åšvalueåˆ™è¿”å›trueï¼Œåä¹‹è¿”å›false bool ParseArgument(const char* arg, string* name, string* value); // è§£ææŸä¸ªå‘½ä»¤è¡Œå‚æ•°çš„çŠ¶æ€ ParseArgumentStatus InterpretArgument(const string\u0026amp; name, const string\u0026amp; value); // ä»è¾“å…¥çš„protoæ–‡ä»¶ç”ŸæˆæŒ‡å®šçš„æºä»£ç æ–‡ä»¶ struct OutputDirective; // å¯¹è§£ææˆåŠŸçš„æ¯ä¸ªprotoæ–‡ä»¶ï¼Œç”Ÿæˆå¯¹åº”çš„æºä»£ç æ–‡ä»¶ // @param parsed_files è§£ææˆåŠŸçš„protoæ–‡ä»¶vector // @param output_directive è¾“å‡ºæŒ‡ç¤ºï¼ŒåŒ…æ‹¬äº†æ–‡ä»¶åã€è¯­è¨€ã€ä»£ç ç”Ÿæˆå™¨ã€è¾“å‡ºç›®å½• // @param generator_context ä»£ç ç”Ÿæˆå™¨ä¸Šä¸‹æ–‡ï¼Œå¯è®°å½•å¾…è¾“å‡ºæ–‡ä»¶åã€æ–‡ä»¶å†…å®¹ã€å°ºå¯¸ç­‰ä¿¡æ¯ bool GenerateOutput(const vector\u0026lt;const FileDescriptor*\u0026gt;\u0026amp; parsed_files, const OutputDirective\u0026amp; output_directive, GeneratorContext* generator_context); // å¯¹è§£ææˆåŠŸçš„æ¯ä¸ªprotoæ–‡ä»¶ï¼Œè°ƒç”¨protocæ’ä»¶ç”Ÿæˆå¯¹åº”çš„æºä»£ç  // @param parsed_files è§£ææˆåŠŸçš„protoæ–‡ä»¶vector // @param plugin_name æ’ä»¶çš„åç§°ï¼Œå‘½åæ–¹å¼ä¸€èˆ¬æ˜¯protoc-gen-${lang} // @param parameter ä¼ é€’ç»™protocæ’ä»¶çš„å‚æ•° // @param generator_context ä»£ç ç”Ÿæˆå™¨ä¸Šä¸‹æ–‡ï¼Œå¯è®°å½•å¾…è¾“å‡ºæ–‡ä»¶åã€æ–‡ä»¶å†…å®¹ã€å°ºå¯¸ç­‰ä¿¡æ¯ // @param error é”™è¯¯ä¿¡æ¯ bool GeneratePluginOutput(const vector\u0026lt;const FileDescriptor*\u0026gt;\u0026amp; parsed_files, const string\u0026amp; plugin_name, const string\u0026amp; parameter, GeneratorContext* generator_context, string* error); // ç¼–ç ã€è§£ç ï¼Œå®ç°å‘½ä»¤è¡Œä¸­çš„--encodeå’Œ--decodeé€‰é¡¹ bool EncodeOrDecode(const DescriptorPool* pool); // å®ç°å‘½ä»¤è¡Œä¸­çš„--descriptor_set_outé€‰é¡¹ bool WriteDescriptorSet(const vector\u0026lt;const FileDescriptor*\u0026gt; parsed_files); // è·å–æŒ‡å®šprotoæ–‡ä»¶ä¾èµ–çš„protoæ–‡ä»¶åˆ—è¡¨ï¼ˆåˆ—è¡¨ä¸­åŒ…æ‹¬è¯¥protoæ–‡ä»¶æœ¬èº«ï¼‰ // - protoæ–‡ä»¶é€šè¿‡FileDescriptorProtoè¡¨ç¤ºï¼› // - è¿™äº›ä¾èµ–çš„protoæ–‡ä»¶åˆ—è¡¨ä¼šè¢«é‡æ–°æ’åºï¼Œè¢«ä¾èµ–çš„protoä¼šè¢«æ’åœ¨ä¾å®ƒçš„protoå‰é¢, // è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨DescriptorPool::BuildFile()æ¥å»ºç«‹æœ€ç»ˆçš„æºä»£ç æ–‡ä»¶ï¼› // - already_seenä¸­å·²ç»åˆ—å‡ºçš„protoæ–‡ä»¶ä¸ä¼šè¢«é‡å¤æ·»åŠ ï¼Œæ¯ä¸€ä¸ªè¢«æ·»åŠ çš„protoæ–‡ä»¶éƒ½è¢«åŠ å…¥åˆ°already_seenä¸­ï¼› // - å¦‚æœinclude_source_code_infoä¸ºtrueï¼Œåˆ™åŒ…æ‹¬æºä»£ç ä¿¡æ¯åˆ°FileDescriptorProtosä¸­ï¼› static void GetTransitiveDependencies(const FileDescriptor* file, bool include_source_code_info, set\u0026lt;const FileDescriptor*\u0026gt;* already_seen, RepeatedPtrField\u0026lt;FileDescriptorProto\u0026gt;* output); // ----------------------------------------------------------------- // å½“å‰è¢«è°ƒç”¨çš„ç¨‹åºçš„åç§°ï¼Œargv[0] string executable_name_; // é€šè¿‡SetVersionInfo()è®¾ç½®çš„ç‰ˆæœ¬ä¿¡æ¯ string version_info_; // æ³¨å†Œçš„ä»£ç ç”Ÿæˆå™¨ struct GeneratorInfo { string flag_name; // --foo_out string option_flag_name; // --foo_opt CodeGenerator* generator; // å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ string help_text; // protoc --helpæ—¶è¾“å‡ºçš„--foo_outçš„å¸®åŠ©ä¿¡æ¯ }; typedef map\u0026lt;string, GeneratorInfo\u0026gt; GeneratorMap; // flag_nameã€ä»£ç ç”Ÿæˆå™¨map GeneratorMap generators_by_flag_name_; // option_nameã€ä»£ç ç”Ÿæˆå™¨map GeneratorMap generators_by_option_name_; // flag_nameã€option map // - å¦‚æœè°ƒç”¨protoc --foo_out=outputdir --foo_opt=enable_bar ...ï¼Œ // mapä¸­å°†åŒ…æ‹¬ä¸€ä¸ª\u0026lt;--foo_out,enable_bar\u0026gt; entry. map\u0026lt;string, string\u0026gt; generator_parameters_; // protocæ’ä»¶å‰ç¼€ï¼Œå¦‚æœè¯¥å˜é‡ä¸ºç©ºï¼Œé‚£ä¹ˆä¸å…è®¸ä½¿ç”¨æ’ä»¶ // @see AllowPlugins() string plugin_prefix_; // å°†protocæ’ä»¶åç§°æ˜ å°„ä¸ºå…·ä½“çš„æ’ä»¶å¯æ‰§è¡Œæ–‡ä»¶ // - æ‰§è¡Œä¸€ä¸ªæ’ä»¶å¯æ‰§è¡Œç¨‹åºæ—¶ï¼Œé¦–å…ˆæœç´¢è¿™ä¸ªmapï¼Œå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥æ‰§è¡Œï¼› // - å¦‚æœè¿™ä¸ªmapä¸­æ‰¾ä¸åˆ°åŒ¹é…çš„æ’ä»¶å¯æ‰§è¡Œç¨‹åºï¼Œåˆ™æœç´¢PATHå¯»æ‰¾å¯æ‰§è¡Œç¨‹åºæ‰§è¡Œï¼› map\u0026lt;string, string\u0026gt; plugins_; // protocå‘½ä»¤è¡Œä¸­æŒ‡å®šçš„å·¥ä½œæ¨¡å¼ enum Mode { MODE_COMPILE, // Normal mode: parse .proto files and compile them. MODE_ENCODE, // --encode: read text from stdin, write binary to stdout. MODE_DECODE // --decode: read binary from stdin, write text to stdout. }; Mode mode_; vector\u0026lt;pair\u0026lt;string, string\u0026gt; \u0026gt; proto_path_; // Search path for proto files. vector\u0026lt;string\u0026gt; input_files_; // Names of the input proto files. // protocè°ƒç”¨æ—¶æ¯ä¸ª--${lang}_outéƒ½å¯¹åº”ç€ä¸€ä¸ªOutputDirective struct OutputDirective { string name; // flag_nameï¼ŒE.g. \u0026quot;--foo_out\u0026quot; CodeGenerator* generator; // ä¸ºNULLåˆ™è¡¨ç¤ºä½¿ç”¨protocæ’ä»¶è€Œéå†…ç½®çš„ä»£ç ç”Ÿæˆå™¨ string parameter; // ä¼ é€’ç»™ä»£ç ç”Ÿæˆå™¨æˆ–è€…protocæ’ä»¶çš„å‚æ•° string output_location; // æºä»£ç æ–‡ä»¶è¾“å‡ºç›®å½• }; // ä¸€æ¬¡protocè°ƒç”¨å¯èƒ½ä¼šåŒæ—¶åˆ¶å®šå¤šä¸ª--${lang}_outé€‰é¡¹ vector\u0026lt;OutputDirective\u0026gt; output_directives_; // å½“ä½¿ç”¨--encodeæˆ–è€…--decodeçš„æ—¶å€™ï¼Œcodec_type_æŒ‡æ˜äº†encodeæˆ–è€…decodeçš„ç±»å‹ // - å¦‚æœcodec_type_ä¸ºç©ºåˆ™è¡¨ç¤º--decode_rawç±»å‹; string codec_type_; // å¦‚æœæŒ‡å®šäº†--descriptor_set_outé€‰é¡¹ï¼ŒFileDescriptorSetå°†è¢«è¾“å‡ºåˆ°æŒ‡å®šçš„æ–‡ä»¶ string descriptor_set_name_; // å¦‚æœæŒ‡å®šäº†--include-importsé‚£ä¹ˆæ‰€æœ‰çš„ä¾èµ–protoéƒ½è¦å†™åˆ°DescriptorSetï¼› // å¦‚æœæœªæŒ‡å®šï¼Œåˆ™åªæŠŠå‘½ä»¤è¡Œä¸­åˆ—å‡ºçš„protoæ–‡ä»¶å†™å…¥ï¼› bool imports_in_descriptor_set_; // å¦‚æœæŒ‡å®š--include_source_infoä¸ºtrueï¼Œåˆ™ä¸èƒ½ä»DescriptorSetä¸­åˆ é™¤SourceCodeInfo bool source_info_in_descriptor_set_; // --disallow_services_è¿™ä¸ªé€‰é¡¹æœ‰è¢«ä½¿ç”¨å—ï¼Ÿ bool disallow_services_; // See SetInputsAreProtoPathRelative(). bool inputs_are_proto_path_relative_; GOOGLE_DISALLOW_EVIL_CONSTRUCTORS(CommandLineInterface); }; } // namespace compiler } // namespace protobuf } // namespace google #endif // GOOGLE_PROTOBUF_COMPILER_COMMAND_LINE_INTERFACE_H__  2.3. protocæ‰§è¡Œæµç¨‹è¯´æ˜ # protocæ‰§è¡Œæµç¨‹çš„ç›¸å…³æºç ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ã€‚\n2.3.1. protocå®ŒæˆåŸºæœ¬çš„åˆå§‹åŒ–å·¥ä½œåè°ƒç”¨cli.Run(argc,argv)å¼€å§‹ç”Ÿæˆä»£ç  # è¿™éƒ¨åˆ†å†…å®¹åœ¨å‰é¢å·²ç»æœ‰è¿‡è¾ƒä¸ºè¯¦ç»†çš„è§£é‡Šï¼Œè¿™é‡Œä¸å†è¯¦ç»†å±•å¼€ï¼Œåªç»™å‡ºç›¸åº”çš„ä»£ç ã€æ³¨é‡Šã€‚\nfile: src/google/protobuf/compiler/main.cc\n// Author: kenton@google.com (Kenton Varda) // è¿™ä¸ªå¤´æ–‡ä»¶å®šä¹‰äº†protocçš„å‘½ä»¤è¡Œæ¥å£ #include \u0026lt;google/protobuf/compiler/command_line_interface.h\u0026gt; // protocä¸­å†…ç½®äº†å¯¹cppã€pythonã€javaè¯­è¨€çš„æ”¯æŒï¼Œå¯¹å…¶ä»–è¯­è¨€çš„æ”¯æŒéœ€è¦ä»¥pluginçš„æ–¹å¼æ¥æ”¯æŒ #include \u0026lt;google/protobuf/compiler/cpp/cpp_generator.h\u0026gt; #include \u0026lt;google/protobuf/compiler/python/python_generator.h\u0026gt; #include \u0026lt;google/protobuf/compiler/java/java_generator.h\u0026gt; int main(int argc, char* argv[]) { // åˆå§‹åŒ–protocå‘½ä»¤è¡Œæ¥å£å¹¶å¼€å¯æ’ä»¶ // - æ’ä»¶åªæ˜¯æ™®é€šçš„å¯æ‰§è¡Œç¨‹åºï¼Œå…¶æ–‡ä»¶åä»¥AllowPluginså‚æ•°protoc-å¼€å¤´ // - å‡å®šprotoc --foo_outï¼Œé‚£ä¹ˆå®é™…è°ƒç”¨çš„æ’ä»¶æ˜¯protoc-foo google::protobuf::compiler::CommandLineInterface cli; cli.AllowPlugins(\u0026quot;protoc-\u0026quot;); // Proto2 C++ (æŒ‡å®šäº†--cpp_outå°†è°ƒç”¨cpp::Generator) google::protobuf::compiler::cpp::CppGenerator cpp_generator; cli.RegisterGenerator(\u0026quot;--cpp_out\u0026quot;, \u0026quot;--cpp_opt\u0026quot;, \u0026amp;cpp_generator, \u0026quot;Generate C++ header and source.\u0026quot;); // Proto2 Java (æŒ‡å®šäº†--java_outå°†è°ƒç”¨java::Generator) google::protobuf::compiler::java::JavaGenerator java_generator; cli.RegisterGenerator(\u0026quot;--java_out\u0026quot;, \u0026amp;java_generator, \u0026quot;Generate Java source file.\u0026quot;); // Proto2 Python (æŒ‡å®šäº†python_outå°†è°ƒç”¨python::Generator) google::protobuf::compiler::python::Generator py_generator; cli.RegisterGenerator(\u0026quot;--python_out\u0026quot;, \u0026amp;py_generator, \u0026quot;Generate Python source file.\u0026quot;); return cli.Run(argc, argv); }  2.3.2. protocå‘½ä»¤æ¥å£cli.Run(argc,argv)è¯¦ç»†å¤„ç†æµç¨‹ # è¿™éƒ¨åˆ†ä»£ç æ˜¯protocå¯¹protoæ–‡ä»¶è¿›è¡Œè¯»å–ã€è§£æã€é€šè¿‡æ³¨å†Œçš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…protocæ’ä»¶ç”Ÿæˆæºä»£ç ã€ä¿å­˜æºä»£ç åˆ°æºæ–‡ä»¶çš„æ‰§è¡Œæµç¨‹ã€‚\nint CommandLineInterface::Run(int argc, const char* const argv[]) { Clear(); switch (ParseArguments(argc, argv)) { case PARSE_ARGUMENT_DONE_AND_EXIT: return 0; case PARSE_ARGUMENT_FAIL: return 1; case PARSE_ARGUMENT_DONE_AND_CONTINUE: break; } // Set up the source tree. DiskSourceTree source_tree; for (int i = 0; i \u0026lt; proto_path_.size(); i++) { source_tree.MapPath(proto_path_[i].first, proto_path_[i].second); } // Map input files to virtual paths if necessary. if (!inputs_are_proto_path_relative_) { if (!MakeInputsBeProtoPathRelative(\u0026amp;source_tree)) { return 1; } } // Allocate the Importer. ErrorPrinter error_collector(error_format_, \u0026amp;source_tree); Importer importer(\u0026amp;source_tree, \u0026amp;error_collector); vector\u0026lt;const FileDescriptor*\u0026gt; parsed_files; // Parse each file. for (int i = 0; i \u0026lt; input_files_.size(); i++) { // Import the file. const FileDescriptor* parsed_file = importer.Import(input_files_[i]); if (parsed_file == NULL) return 1; parsed_files.push_back(parsed_file); // Enforce --disallow_services. if (disallow_services_ \u0026amp;\u0026amp; parsed_file-\u0026gt;service_count() \u0026gt; 0) { cerr \u0026lt;\u0026lt; parsed_file-\u0026gt;name() \u0026lt;\u0026lt; \u0026quot;: This file contains services, but \u0026quot; \u0026quot;--disallow_services was used.\u0026quot; \u0026lt;\u0026lt; endl; return 1; } } // We construct a separate GeneratorContext for each output location. Note // that two code generators may output to the same location, in which case // they should share a single GeneratorContext so that OpenForInsert() works. typedef hash_map\u0026lt;string, GeneratorContextImpl*\u0026gt; GeneratorContextMap; GeneratorContextMap output_directories; // Generate output. if (mode_ == MODE_COMPILE) { for (int i = 0; i \u0026lt; output_directives_.size(); i++) { string output_location = output_directives_[i].output_location; if (!HasSuffixString(output_location, \u0026quot;.zip\u0026quot;) \u0026amp;\u0026amp; !HasSuffixString(output_location, \u0026quot;.jar\u0026quot;)) { AddTrailingSlash(\u0026amp;output_location); } GeneratorContextImpl** map_slot = \u0026amp;output_directories[output_location]; if (*map_slot == NULL) { // First time we've seen this output location. *map_slot = new GeneratorContextImpl(parsed_files); } if (!GenerateOutput(parsed_files, output_directives_[i], *map_slot)) { STLDeleteValues(\u0026amp;output_directories); return 1; } } } // Write all output to disk. for (GeneratorContextMap::iterator iter = output_directories.begin(); iter != output_directories.end(); ++iter) { const string\u0026amp; location = iter-\u0026gt;first; GeneratorContextImpl* directory = iter-\u0026gt;second; if (HasSuffixString(location, \u0026quot;/\u0026quot;)) { if (!directory-\u0026gt;WriteAllToDisk(location)) { STLDeleteValues(\u0026amp;output_directories); return 1; } } else { if (HasSuffixString(location, \u0026quot;.jar\u0026quot;)) { directory-\u0026gt;AddJarManifest(); } if (!directory-\u0026gt;WriteAllToZip(location)) { STLDeleteValues(\u0026amp;output_directories); return 1; } } } STLDeleteValues(\u0026amp;output_directories); if (!descriptor_set_name_.empty()) { if (!WriteDescriptorSet(parsed_files)) { return 1; } } if (mode_ == MODE_ENCODE || mode_ == MODE_DECODE) { if (codec_type_.empty()) { // HACK: Define an EmptyMessage type to use for decoding. DescriptorPool pool; FileDescriptorProto file; file.set_name(\u0026quot;empty_message.proto\u0026quot;); file.add_message_type()-\u0026gt;set_name(\u0026quot;EmptyMessage\u0026quot;); GOOGLE_CHECK(pool.BuildFile(file) != NULL); codec_type_ = \u0026quot;EmptyMessage\u0026quot;; if (!EncodeOrDecode(\u0026amp;pool)) { return 1; } } else { if (!EncodeOrDecode(importer.pool())) { return 1; } } } return 0; }  2.3.3. protocæ‰§è¡Œé€»è¾‘æ€»ç»“ # é€šè¿‡æŸ¥çœ‹ä¸Šé¢ä¸¤éƒ¨åˆ†ä»£ç åŠå…¶ä»–å…³é”®ä»£ç ï¼Œå¯ä»¥å¯¹protocçš„æ‰§è¡Œæµç¨‹è¿›è¡Œä¸€ä¸ªç®€å•çš„æ€»ç»“äº†ï¼š\n  protoc mainä¸­åˆå§‹åŒ–å‘½ä»¤è¡Œå‚æ•°æ¥å£cli;\n  protoc ä¸­å¼€å¯protoc-å‰ç¼€çš„æ’ä»¶ä½œä¸ºç¬¬ä¸‰æ–¹ä»£ç ç”Ÿæˆå™¨ä½¿ç”¨cli.AllowPlugins(\u0026ldquo;protoc-\u0026quot;)ï¼›\n  protoc mainä¸­æ³¨å†Œç¼–ç¨‹è¯­è¨€cppã€javaã€pythonåŠå¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼Œcli.RegisterGenerator(\u0026hellip;)ï¼ŒåŸç”Ÿæ”¯æŒcppã€javaã€pythonï¼›\n  protoc mainä¸­cli.Run(argc, argv)ï¼Œè¿è¡Œæ³¨å†Œçš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…protocæ’ä»¶;\n Clear()æ¸…ç©ºæ‰€æœ‰çš„æ•°æ®å¤‡ç”¨ï¼› ParseArguments(argc,argv)è§£æå‚æ•°ï¼Œå¯¹äºprotocçš„æŸäº›å†…ç½®å‚æ•°çš„æ£€æŸ¥ï¼Œå¯¹æŸäº›æ’ä»¶ç›¸å…³çš„\u0026ndash;${lang}_outå‚æ•°çš„æ£€æŸ¥ç­‰ï¼Œå°†\u0026ndash;${lang}_outä½œä¸ºè¾“å‡ºæŒ‡ä»¤ä¿å­˜èµ·æ¥ï¼› struct OutputDirective { string name; // E.g. \u0026quot;--foo_out\u0026quot; CodeGenerator* generator; // NULL for plugins string parameter; string output_location; };   å‚æ•°è§£ææˆåŠŸä¹‹åï¼Œç»§ç»­æ‰§è¡Œå¤„ç†ï¼Œè®¾ç½®æºä»£ç æ ‘ã€æ˜ å°„è¾“å…¥æ–‡ä»¶åˆ°è™šæ‹Ÿè·¯å¾„ã€åˆ†é…importerï¼› é’ˆå¯¹æ¯ä¸ªè¾“å…¥çš„protoæ–‡ä»¶è¿›è¡Œè§£æï¼Œconst FileDescriptor* parsed_file = importer.Import(input_files_[i])ï¼Œè§£ææˆåŠŸåçš„æ–‡ä»¶ä¼šè¢«åŠ å…¥åˆ°vector\u0026lt;FileDescriptor*\u0026gt; parsed_filesä¸­è®°å½•ï¼Œæ¯ä¸€ä¸ªprotoæ–‡ä»¶è§£æåéƒ½å¯ä»¥ç”¨ä¸€ä¸ªFileDescriptorç»“æ„ä½“æ¥è¡¨ç¤ºï¼›   å¤‡æ³¨ï¼š\nè¿™é‡Œè§£æprotoæ–‡ä»¶çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆå°†protoæ–‡ä»¶ä¸­çš„å†…å®¹åˆ†å‰²æˆä¸€ä¸ªä¸ªçš„tokenï¼Œå°†å†…å®¹æ‹†åˆ†æˆä¸€ä¸ªä¸ªè¯ç´ å¹¶æ£€æŸ¥æœ‰æ•ˆæ€§ï¼Œä¹Ÿå°±æ˜¯è¯æ³•åˆ†æã€‚å¦‚æœè¯æ³•åˆ†ææ£€æŸ¥æ— è¯¯åˆ™è¿›å…¥åç»­çš„è¯­æ³•åˆ†æè¿‡ç¨‹ï¼Œparserå¯¹è¾“å…¥tokenä¸²è¿›è¡Œæ–‡æ³•ç›¸å…³çš„åˆ†ææ£€æŸ¥æ˜¯å¦å¯ä»¥æ„æˆä¸€æ£µæœ‰æ•ˆçš„è¯­æ³•åˆ†ææ ‘ï¼Œå¦‚æœå¯ä»¥åˆ™è¡¨ç¤ºè¯­æ³•æ­£ç¡®ã€‚\n // Tokenå®šä¹‰å¦‚ä¸‹ struct Token { TokenType type; string text; // The exact text of the token as it appeared in // the input. e.g. tokens of TYPE_STRING will still // be escaped and in quotes. // \u0026quot;line\u0026quot; and \u0026quot;column\u0026quot; specify the position of the first character of // the token within the input stream. They are zero-based. int line; int column; int end_column; }; // Tokenç±»å‹å®šä¹‰å¦‚ä¸‹ enum TokenType { TYPE_START, // Next() has not yet been called. TYPE_END, // End of input reached. \u0026quot;text\u0026quot; is empty. TYPE_IDENTIFIER, // A sequence of letters, digits, and underscores, not // starting with a digit. It is an error for a number // to be followed by an identifier with no space in // between. TYPE_INTEGER, // A sequence of digits representing an integer. Normally // the digits are decimal, but a prefix of \u0026quot;0x\u0026quot; indicates // a hex number and a leading zero indicates octal, just // like with C numeric literals. A leading negative sign // is NOT included in the token; it's up to the parser to // interpret the unary minus operator on its own. TYPE_FLOAT, // A floating point literal, with a fractional part and/or // an exponent. Always in decimal. Again, never // negative. TYPE_STRING, // A quoted sequence of escaped characters. Either single // or double quotes can be used, but they must match. // A string literal cannot cross a line break. TYPE_SYMBOL, // Any other printable character, like '!' or '+'. // Symbols are always a single character, so \u0026quot;!+$%\u0026quot; is // four tokens. };  è¯­æ³•åˆ†æçš„è¿‡ç¨‹è¿™é‡Œå°±ä¸è§£é‡Šäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹protobufä¸­grammarçš„å®šä¹‰ï¼Œæ— éä¹Ÿå°±æ˜¯äº›è§„çº¦çš„äº‹æƒ…ï¼Œåªè¦èƒ½å¤ŸæŒ‰ç…§grammarå°†è¯æ³•åˆ†æè¾“å‡ºçš„tokenä¸²æ„å»ºå‡ºä¸€æ£µå®Œæ•´çš„è¯­æ³•åˆ†ææ ‘protoæ–‡ä»¶å°±æ˜¯åˆæ³•çš„ï¼Œå¦åˆ™å°±æ˜¯ä¸åˆæ³•çš„ï¼Œè‡³äºè¯­æ³•åˆ†æè¿‡ç¨‹ä¸­ä¼´éšçš„è¯­ä¹‰åˆ†æè¿‡ç¨‹ï¼Œè¯­ä¹‰åˆ†æè¿‡ç¨‹ä¸­æ‰§è¡Œå“ªäº›è¯­ä¹‰åŠ¨ä½œï¼Œä¸è¯´ä¹ŸçŸ¥é“ï¼Œè‚¯å®šæ˜¯ç”ŸæˆæŸäº›â€œä¸­é—´ä»£ç â€ä¹‹ç±»çš„é¬¼ä¸œè¥¿ã€‚å­¦è¿‡ç¼–è¯‘åŸç†çš„è¿™äº›å¤„ç†è¿‡ç¨‹åº”è¯¥éƒ½æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚è¯­æ³•åˆ†ææˆåŠŸä¹‹åå°±å¾—åˆ°äº†protoå¯¹åº”çš„FileDescriptorå¯¹è±¡ï¼Œå› ä¸ºå¯èƒ½è¾“å…¥çš„æ˜¯å¤šä¸ªprotoï¼Œæ‰€ä»¥å¤šä¸ªFileDescriptorå°±ç”¨vectoræ¥å­˜å‚¨äº†ã€‚\n éå†ä¹‹å‰è®°å½•ä¸‹æ¥çš„è¾“å‡ºæŒ‡ä»¤OutputDirective output_directives[]ï¼Œoutput_directives[i].output_locationæŒ‡æ˜äº†è¾“å‡ºç›®å½•ï¼Œé’ˆå¯¹è¾“å‡ºç›®å½•åˆ›å»ºGeneratorContextImplï¼Œå¹¶è®°å½•åˆ°hash_map\u0026lt;string, GeneratorContextImpl*\u0026gt; output_directoriesè¿™ä¸ªmapä¸­ï¼Œkeyä¸ºflag_out,å¦‚\u0026ndash;foo_outï¼Œvalueä¸ºGeneratorContextImplã€‚ç”±äºå¯èƒ½å¤šä¸ª\u0026ndash;${lang}_outéƒ½æŒ‡å‘ç›¸åŒçš„è¾“å‡ºç›®å½•ï¼Œæ‰€ä»¥åŒä¸€ä¸ªGeneratorContextImplä¹Ÿå­˜åœ¨å¤ç”¨çš„æƒ…å†µã€‚æ¯ä¸ªGeneratorContextImplè®°å½•äº†ä¸€ä¸ªè¾“å‡ºç›®å½•ã€æ‰€æœ‰è¯¥ç›®å½•ä¸‹çš„å¾…åˆ›å»ºçš„æºä»£ç æ–‡ä»¶çš„ä¿¡æ¯ï¼Œå¾…åˆ›å»ºçš„æºä»£ç æ–‡ä»¶ä¿¡æ¯è®°å½•åœ¨map\u0026lt;string,string*\u0026gt; files_é‡Œé¢ï¼Œkeyä¸ºæºä»£ç æ–‡ä»¶åï¼Œvalä¸ºæºä»£ç æ–‡ä»¶çš„å†…å®¹ï¼Œå¦å¤–è¿˜åŒ…æ‹¬äº†ä¸€ä¸ªvector\u0026lt;FileDescriptor*\u0026gt; parsed_filesè®°å½•äº†æ‰€æœ‰è§£ææˆåŠŸçš„protoæ–‡ä»¶ä¿¡æ¯ã€‚\néå†output_directivesçš„åŒæ—¶ï¼Œå› ä¸ºåŒä¸€ä¸ªoutput_directives[i]å¯¹åº”çš„è¾“å‡ºç›®å½•ä¸‹å¯èƒ½æœ‰å¤šä¸ªæºä»£ç æ–‡ä»¶è¦è¾“å‡ºï¼Œå¹¶ä¸”ä¸ç®¡flag_nameæ˜¯ä»€ä¹ˆï¼Œè¦å¤„ç†çš„protoæ–‡ä»¶éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æ¯ä¸ªoutput_directives[i]éƒ½ä¼šå¯¹å…¶è°ƒç”¨GenerateOutput(parsed_files, output_directives[i], *map_slot)ï¼Œoutput_directives[i].pluginæŒ‡æ˜äº†è¯­è¨€çš„ä»£ç ç”Ÿæˆå™¨(ä¸ºNULLåˆ™ä½¿ç”¨æ’ä»¶)ï¼Œå¯¹æ‰€æœ‰çš„è§£ææˆåŠŸçš„protoæ–‡ä»¶parsed_files[i]ç”Ÿæˆæºä»£ç ï¼Œæºä»£ç å…¨éƒ¨è¾“å‡ºåˆ°output_directive[i].output_locationä¸‹ï¼Œæºä»£ç çš„æ–‡ä»¶åéƒ½è®°å½•åœ¨parsed_files[i].name()é‡Œé¢ï¼Œè€Œæœ€ç»ˆç”Ÿæˆçš„æºä»£ç ä¿¡æ¯éƒ½å­˜å‚¨åœ¨è¿™é‡Œçš„CodeGeneratorImpl **map_slotä¸­ï¼Œä¹Ÿå°±ç›¸å½“äºå­˜å‚¨åœ¨äº†output_directories[]ä¸­ã€‚ æœ€åéå†output_directories[]ï¼Œå°†æ¯ä¸ªè¾“å‡ºç›®å½•ä¸‹è¦å†™çš„æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®å…¨éƒ¨å†™å‡ºåˆ°ç£ç›˜ï¼Œå³output_directories[i]-\u0026gt;WriteAllToDisk()ã€‚ doneï¼    äº†è§£ä»protoåˆ°æºä»£ç ç”Ÿæˆçš„å…³é”®ä¹‹å¤„å°±æ˜¯è¿™é‡Œçš„GenerateOutputæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæ¥ç€çœ‹ã€‚\n2.3.3.1 protoc CommandLineInterface::GenerateOutput(\u0026hellip;)å®ç° # ä¸‹é¢çœ‹ä¸‹GenerateOutputæ–¹æ³•åˆ°åº•æ‰§è¡Œäº†å“ªäº›æ“ä½œã€‚\n// æ ¹æ®è¾“å‡ºæŒ‡ç¤º, ä¸ºè§£ææˆåŠŸçš„protoæ–‡ä»¶è°ƒç”¨ä»£ç ç”Ÿæˆå™¨ç”Ÿæˆå¯¹åº”çš„ä»£ç å¹¶å­˜å‚¨åˆ°generator_context //@param parsed_files æ‰€æœ‰è§£ææˆåŠŸçš„protoæ–‡ä»¶ï¼Œæ¯ä¸ªè§£ææˆåŠŸçš„protoæ–‡ä»¶éƒ½ç”¨ä¸€ä¸ªFileDescriptoræ¥è¡¨ç¤º //@param output_directive è¾“å‡ºæŒ‡ç¤ºï¼Œå…¶æŒ‡æ˜äº†ç›®æ ‡è¯­è¨€ã€è¯­è¨€å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ã€è¾“å‡ºç›®å½•ç­‰ //@param generator_context ä»£ç ç”Ÿæˆå™¨ä¸Šä¸‹æ–‡ï¼Œå¯è®°å½•ç”Ÿæˆçš„ä»£ç  bool CommandLineInterface::GenerateOutput(const vector\u0026lt;const FileDescriptor*\u0026gt;\u0026amp; parsed_files, const OutputDirective\u0026amp; output_directive, GeneratorContext* generator_context) { // Call the generator. string error; // å¦‚æœè¾“å‡ºæŒ‡ç¤ºä¸­æ²¡æœ‰è®¾ç½®å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼Œè¡¨æ˜æ²¡æœ‰åœ¨protoc mainä¸­æ³¨å†Œè¯­è¨€å¯¹åº”çš„ä»£ç ç”Ÿæˆå™¨ï¼Œ // è¿™ç§éœ€è¦protocé€šè¿‡æ’ä»¶æœºåˆ¶ï¼Œé€šè¿‡è°ƒç”¨å¯¹åº”çš„æ’ä»¶æ¥å……å½“ä»£ç ç”Ÿæˆå™¨çš„åŠŸèƒ½ã€‚ if (output_directive.generator == NULL) { // This is a plugin. GOOGLE_CHECK(HasPrefixString(output_directive.name, \u0026quot;--\u0026quot;) \u0026amp;\u0026amp; HasSuffixString(output_directive.name, \u0026quot;_out\u0026quot;)) \u0026lt;\u0026lt; \u0026quot;Bad name for plugin generator: \u0026quot; \u0026lt;\u0026lt; output_directive.name; // å®é™…ä¸Šprotocæœç´¢æ’ä»¶å¯¹åº”çš„å¯æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œæœç´¢çš„åç§°æ˜¯â€œprotoc-gen-â€+â€œè¯­è¨€â€ï¼Œ // å¦‚æœæˆ‘ä»¬è°ƒç”¨çš„æ˜¯protoc --xxx_outï¼Œé‚£ä¹ˆå®é™…æœç´¢çš„å°±æ˜¯protoc-gen-xxxã€‚ string plugin_name = plugin_prefix_ + \u0026quot;gen-\u0026quot; + output_directive.name.substr(2, output_directive.name.size() - 6); // è°ƒç”¨protocæ’ä»¶æ¥ç”Ÿæˆä»£ç ï¼Œè¿™æ˜¯æˆ‘ä»¬è¦é‡ç‚¹çœ‹çš„ï¼Œæˆ‘ä»¬å°±æ˜¯è¦å®ç°è‡ªå·±çš„protocæ’ä»¶ if (!GeneratePluginOutput(parsed_files, plugin_name, output_directive.parameter, generator_context, \u0026amp;error)) { cerr \u0026lt;\u0026lt; output_directive.name \u0026lt;\u0026lt; \u0026quot;: \u0026quot; \u0026lt;\u0026lt; error \u0026lt;\u0026lt; endl; return false; } } else { // è¿™ç§æ˜¯protoc mainå‡½æ•°ä¸­æ­£å¸¸æ³¨å†Œçš„è¯­è¨€å’Œä»£ç ç”Ÿæˆå™¨ // Regular generator. string parameters = output_directive.parameter; if (!generator_parameters_[output_directive.name].empty()) { if (!parameters.empty()) { parameters.append(\u0026quot;,\u0026quot;); } parameters.append(generator_parameters_[output_directive.name]); } // ä¸ºæ¯ä¸ªè§£ææˆåŠŸçš„protoæ–‡ä»¶ç”Ÿæˆä»£ç  for (int i = 0; i \u0026lt; parsed_files.size(); i++) { if (!output_directive.generator-\u0026gt;Generate(parsed_files[i], parameters, generator_context, \u0026amp;error)) { // Generator returned an error. cerr \u0026lt;\u0026lt; output_directive.name \u0026lt;\u0026lt; \u0026quot;: \u0026quot; \u0026lt;\u0026lt; parsed_files[i]-\u0026gt;name() \u0026lt;\u0026lt; \u0026quot;: \u0026quot; \u0026lt;\u0026lt; error \u0026lt;\u0026lt; endl; return false; } } } return true; }  2.3.3.2. protocè°ƒç”¨æ’ä»¶ç”Ÿæˆä»£ç çš„æ‰§è¡Œé€»è¾‘ # ä¸‹é¢å†æ¥çœ‹ä¸€ä¸‹GeneratePluginOutputæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\n// è°ƒç”¨protocæ’ä»¶ä¸ºè§£ææˆåŠŸçš„protoæ–‡ä»¶ç”Ÿæˆä»£ç  // //@param parsed_files è§£ææˆåŠŸçš„æ–‡ä»¶ //@param plugin_name protocæ’ä»¶åç§°ï¼ˆè¿™ä¸ªæ˜¯æ‹¼æ¥å‡ºæ¥çš„protoc-gen-${lang}ï¼‰ //@param parameter ä¼ ç»™æ’ä»¶çš„å‚æ•° //@param generator_context ä»£ç ç”Ÿæˆå™¨ä¸Šä¸‹æ–‡ï¼Œå¯è®°å½•ç”Ÿæˆçš„ä»£ç  //@param error ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯ bool CommandLineInterface::GeneratePluginOutput(const vector\u0026lt;const FileDescriptor*\u0026gt;\u0026amp; parsed_files, const string\u0026amp; plugin_name, const string\u0026amp; parameter, GeneratorContext* generator_context, string* error) { // protocç”Ÿæˆä¸€ä¸ªä»£ç ç”Ÿæˆè¯·æ±‚ï¼Œå¹¶å‘é€ç»™æ’ä»¶ CodeGeneratorRequest request; // protocæ’ä»¶æ ¹æ®æ¥æ”¶åˆ°çš„ä»£ç ç”Ÿæˆè¯·æ±‚ç”Ÿæˆä»£ç ï¼Œå¹¶å‘é€å“åº”ç»™protoc CodeGeneratorResponse response; // Build the request. if (!parameter.empty()) { request.set_parameter(parameter); } set\u0026lt;const FileDescriptor*\u0026gt; already_seen; for (int i = 0; i \u0026lt; parsed_files.size(); i++) { request.add_file_to_generate(parsed_files[i]-\u0026gt;name()); GetTransitiveDependencies(parsed_files[i], true, // Include source code info. \u0026amp;already_seen, request.mutable_proto_file()); } // forkå‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æ¥æ‰§è¡Œæ’ä»¶å®Œæˆä»£ç ç”Ÿæˆå·¥ä½œï¼Œ // çˆ¶å­è¿›ç¨‹ä¹‹é—´æ˜¯é€šè¿‡ç®¡é“é€šä¿¡å®Œæˆè¯·æ±‚ã€å“åº”è¿‡ç¨‹ï¼Œå¦‚ä½•æ§åˆ¶å­è¿›ç¨‹çš„stdinã€stdoutï¼Œ // è¿™ä¸ªå¯ä»¥é€šè¿‡dup2æˆ–è€…dup3æ¥æ§åˆ¶é—´fd 0ã€1åˆ†åˆ«è®¾ç½®åˆ°ç®¡é“çš„è¯»ç«¯ã€å†™ç«¯ã€‚ // äº‹å®ä¸Šprotobufçš„å¼€å‘äººå‘˜ä¹Ÿæ˜¯è¿™ä¹ˆæ¥å®ç°çš„ã€‚ // Invoke the plugin. Subprocess subprocess; if (plugins_.count(plugin_name) \u0026gt; 0) { subprocess.Start(plugins_[plugin_name], Subprocess::EXACT_NAME); } else { subprocess.Start(plugin_name, Subprocess::SEARCH_PATH); } string communicate_error; // è¯·æ±‚æ’ä»¶ç”Ÿæˆä»£ç  if (!subprocess.Communicate(request, \u0026amp;response, \u0026amp;communicate_error)) { *error = strings::Substitute(\u0026quot;$0: $1\u0026quot;, plugin_name, communicate_error); return false; } // Write the files. We do this even if there was a generator error in order // to match the behavior of a compiled-in generator. scoped_ptr\u0026lt;io::ZeroCopyOutputStream\u0026gt; current_output; for (int i = 0; i \u0026lt; response.file_size(); i++) { const CodeGeneratorResponse::File\u0026amp; output_file = response.file(i); if (!output_file.insertion_point().empty()) { // é¦–å…ˆå…³é—­å½“å‰æ­£åœ¨å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼ˆç”¨CodeGeneratorResponseè¡¨ç¤ºï¼‰ // æ‰“å¼€å¾…å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼Œè¿™ä¸ªæ–‡ä»¶æ•°æ®å·²ç»å­˜åœ¨ï¼Œå®šä½åˆ°å‡†ç¡®çš„æ’å…¥ç‚¹ä½ç½®æ‰§è¡Œå†™å…¥ï¼Œç„¶åå…³é—­æ–‡ä»¶ // - è¿™é‡Œçš„æ’å…¥ç‚¹å¦‚ä½•å®šä¹‰ï¼Œæˆ‘ä»¬åœ¨åé¢å†è¿›è¡Œè¯´æ˜ã€‚å…·ä½“å¯å‚è€ƒplugin.protoå’Œplugin.pb.hã€‚ current_output.reset(); // OpenForInsertè¿”å›ä¸€ä¸ªè¾“å‡ºæµï¼Œä»¥æ–¹ä¾¿åé¢å†™å…¥ç¼–ç åæ•°æ® current_output.reset(generator_context-\u0026gt;OpenForInsert(output_file.name(), output_file.insertion_point())); } else if (!output_file.name().empty()) { // é¦–å…ˆå…³é—­å½“å‰æ­£åœ¨å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼ˆç”¨CodeGeneratorResponseè¡¨ç¤ºï¼‰ // æ‰“å¼€å¾…å†™å…¥çš„æ–‡ä»¶æ•°æ®ï¼Œè¿™ä¸ªæ–‡ä»¶æ•°æ®ä¸å­˜åœ¨ï¼Œä¸å­˜åœ¨æ’å…¥ç‚¹ä¿¡æ¯ï¼Œä»å¼€å§‹å¤„æ‰§è¡Œå†™å…¥ current_output.reset(); // OpenForInsertè¿”å›ä¸€ä¸ªè¾“å‡ºæµï¼Œä»¥æ–¹ä¾¿åé¢å†™å…¥ç¼–ç åæ•°æ® current_output.reset(generator_context-\u0026gt;Open(output_file.name())); } else if (current_output == NULL) { *error = strings::Substitute( \u0026quot;$0: First file chunk returned by plugin did not specify a file name.\u0026quot;, plugin_name); return false; } // ä»CodeGeneratorResponseä¸­è·å–è¾“å‡ºæµï¼Œå†™å‡ºï¼Œè¿™é‡Œè¾“å‡ºæµä¸­çš„æ•°æ®æ—¶å­˜å‚¨åœ¨GeneratorContextImplä¸­çš„ï¼Œ // GenerateOutputè°ƒç”¨æˆåŠŸä¹‹ååé¢ä¼šéå†æ¯ä¸€ä¸ªGenerateContextImplå®ŒæˆWriteAllToDisk()çš„æ“ä½œã€‚ // Use CodedOutputStream for convenience; otherwise we'd need to provide // our own buffer-copying loop. io::CodedOutputStream writer(current_output.get()); writer.WriteString(output_file.content()); } // Check for errors. if (!response.error().empty()) { // Generator returned an error. *error = response.error(); return false; } return true; }  2.3.3.3. protoc \u0026amp; protocæ’ä»¶æ•°æ®äº¤äº’çš„æ‰§è¡Œé€»è¾‘ # æ•´ä½“æ‰§è¡Œé€»è¾‘å·®ä¸å¤šç†æ¸…æ¥šäº†ï¼Œç„¶åè¿™é‡Œæˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹çˆ¶è¿›ç¨‹ç»™å­è¿›ç¨‹å‘é€çš„ä»£ç ç”Ÿæˆè¯·æ±‚æ˜¯ä»€ä¹ˆï¼Œæ”¶åˆ°çš„ä»£ç ç”Ÿæˆçš„å“åº”åˆæ˜¯ä»€ä¹ˆï¼Œä»¥åŠçˆ¶å­è¿›ç¨‹é€šä¿¡çš„ç»†èŠ‚ã€å­è¿›ç¨‹å¯¹è¯·æ±‚çš„å¤„ç†è¿‡ç¨‹ç­‰ã€‚\nå…ˆæ¥çœ‹ä¸‹plugin.protoçš„å®šä¹‰ï¼Œprotocå†…ç½®çš„æ”¯æŒè¯­è¨€é‡Œé¢å¹¶ä¸åŒ…å«goï¼Œæˆ‘ä»¬åé¢éœ€è¦ç”¨goæ¥ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„æ’ä»¶ï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨protocçš„goæ’ä»¶æ¥ç”Ÿæˆgoå¯¹åº”çš„plugin.goä»£ç ï¼Œç„¶åæˆ‘ä»¬è‡ªå·±å†™ä¸€äº›ä¸šåŠ¡ç±»æ’ä»¶ï¼ˆéè¯­è¨€æ’ä»¶ï¼‰çš„æ—¶å€™æ‰èƒ½ç”¨ä¸Šplugin.goã€‚æ‰¯è¿™ä¹ˆå¤šæ˜¯ä¸ºäº†è®©å¤§å®¶æ˜ç™½è¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦çœ‹ä¸‹plugin.protoï¼Œè€Œä¸æ˜¯è¯¯è§£ä¸ºåªæ˜¯åœ¨å †ç Œå†…å®¹ã€‚çœ‹äº†è¿™é‡Œçš„plugin.protoä¹‹åæ‰èƒ½ç†è§£åˆ°protocä¸­çš„æ’ä»¶æœºåˆ¶çš„è¾¹ç•Œæ—¶ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥æ˜ç™½åˆ©ç”¨protocçš„æ’ä»¶æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åšåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Œå“ªäº›åŠŸèƒ½èƒ½å®ç°ï¼Œå“ªäº›å®ç°ä¸äº†ï¼Œè¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ã€‚\nfile: src/google/protobuf/compiler/plugin.proto\n// protoc (aka the Protocol Compiler) can be extended via plugins. A plugin is // just a program that reads a CodeGeneratorRequest from stdin and writes a // CodeGeneratorResponse to stdout. // // Plugins written using C++ can use google/protobuf/compiler/plugin.h instead // of dealing with the raw protocol defined here. // // A plugin executable needs only to be placed somewhere in the path. The // plugin should be named \u0026quot;protoc-gen-$NAME\u0026quot;, and will then be used when the // flag \u0026quot;--${NAME}_out\u0026quot; is passed to protoc. package google.protobuf.compiler; option java_package = \u0026quot;com.google.protobuf.compiler\u0026quot;; option java_outer_classname = \u0026quot;PluginProtos\u0026quot;; import \u0026quot;google/protobuf/descriptor.proto\u0026quot;; // å‘é€ç»™æ’ä»¶çš„ä»£ç ç”Ÿæˆè¯·æ±‚ // An encoded CodeGeneratorRequest is written to the plugin's stdin. message CodeGeneratorRequest { // The .proto files that were explicitly listed on the command-line. The // code generator should generate code only for these files. Each file's // descriptor will be included in proto_file, below. //protoæ–‡ä»¶åˆ—è¡¨å¯¹åº”çš„è¦ç”Ÿæˆçš„æ–‡ä»¶çš„æºä»£ç æ–‡ä»¶çš„åå­— repeated string file_to_generate = 1; // The generator parameter passed on the command-line. //ä¼ é€’ç»™æ’ä»¶ä»£ç ç”Ÿæˆå™¨çš„å‚æ•° optional string parameter = 2; // FileDescriptorProtos for all files in files_to_generate and everything // they import. The files will appear in topological order, so each file // appears before any file that imports it. // // protoc guarantees that all proto_files will be written after // the fields above, even though this is not technically guaranteed by the // protobuf wire format. This theoretically could allow a plugin to stream // in the FileDescriptorProtos and handle them one by one rather than read // the entire set into memory at once. However, as of this writing, this // is not similarly optimized on protoc's end -- it will store all fields in // memory at once before sending them to the plugin. // æ¯ä¸€ä¸ªæ­£ç¡®è§£æçš„protoæ–‡ä»¶éƒ½ç”¨ä¸€ä¸ªFileDescriptorProtoæ¥è¡¨ç¤ºï¼› // è¿™é‡Œçš„FileDescriptorProtoä¸FileDescriptorå…¶å®æ˜¯å¯¹åº”çš„ï¼Œåœ¨è¯·æ±‚æ’ä»¶è¿›è¡Œä»£ç  // ç”Ÿæˆçš„æ—¶å€™ç›´æ¥å°±æœ‰è¿™æ ·çš„ä»£ç FileDescriptor::CopyTo(FileDescriptorProto\u0026amp;) // çš„ç”¨æ³•ã€‚è€Œåœ¨descriptor.hå’Œdescriptor.protoä¸­æŸ¥çœ‹äºŒè€…çš„æè¿°æ—¶ï¼Œå…¶æ³¨é‡Šæ¸…æ¸… // æ¥šæ¥šåœ°å†™ç€éƒ½æ˜¯æè¿°çš„ä¸€ä¸ªå®Œæ•´çš„protoæ–‡ä»¶ã€‚ repeated FileDescriptorProto proto_file = 15; } // æ’ä»¶è¿”å›çš„ä»£ç ç”Ÿæˆå“åº” // The plugin writes an encoded CodeGeneratorResponse to stdout. message CodeGeneratorResponse { // Error message. If non-empty, code generation failed. The plugin process // should exit with status code zero even if it reports an error in this way. // // This should be used to indicate errors in .proto files which prevent the // code generator from generating correct code. Errors which indicate a // problem in protoc itself -- such as the input CodeGeneratorRequest being // unparseable -- should be reported by writing a message to stderr and // exiting with a non-zero status code. // é”™è¯¯ä¿¡æ¯ optional string error = 1; // Represents a single generated file. // ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶æ¶ˆæ¯ç±»å‹ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªå†…éƒ¨ç±»å‹ message File { // å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶åï¼ˆç›¸å¯¹äºè¾“å‡ºç›®å½•ï¼‰ï¼Œæ–‡ä»¶åä¸­ä¸èƒ½åŒ…æ‹¬.æˆ–è€…..ï¼Œè·¯å¾„æ˜¯ // ç›¸å¯¹è¾“å‡ºç›®å½•çš„è·¯å¾„ï¼Œä¸èƒ½ç”¨ç»å¯¹è·¯å¾„ï¼Œå¦åˆ†éš”ç¬¦å¿…é¡»ç”¨/ã€‚ // å¦‚æœnameæ²¡æœ‰æŒ‡å®šï¼Œé‚£ä¹ˆè¾“å‡ºçš„å†…å®¹å°†è¿½åŠ åˆ°å‰ä¸€ä¸ªè¾“å‡ºçš„æºä»£ç æ–‡ä»¶ä¸­ï¼Œè¿™ç§ // æ–¹å¼ä½¿å¾—ä»£ç ç”Ÿæˆå™¨èƒ½å¤Ÿå°†ä¸€ä¸ªå¤§æ–‡ä»¶çš„ç”Ÿæˆåˆ†å¤šæ¬¡å†™å…¥æ¥å®Œæˆï¼Œä¸ç”¨ä¸€æ¬¡æ€§å°†å¾ˆ // å¤§æ•°æ®é‡çš„æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ã€‚è¿™é‡Œéœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œprotocä¸­å¹¶æ²¡æœ‰é’ˆå¯¹è¿™ç§æƒ…å†µ // è¿›è¡Œç‰¹æ®Šçš„ä¼˜åŒ–ï¼Œå®ƒç­‰å¾…è¯»å–å®Œæ•´çš„CodeGeneratorResponseå†å†™å‡ºåˆ°ç£ç›˜ã€‚ optional string name = 1; // å¦‚æœinsertion_pointä¸ç©ºçš„è¯ï¼Œnameå­—æ®µä¹Ÿä¸èƒ½ä¸ºç©ºï¼Œå¹¶ä¸”å‡å®šnameå­—æ®µæŒ‡å®šçš„ // æ–‡ä»¶å·²ç»å­˜åœ¨äº†ã€‚è¿™é‡Œçš„å†…å®¹å°†è¢«æ’å…¥åˆ°nameæŒ‡å®šçš„æ–‡ä»¶ä¸­çš„ç‰¹å®šæ’å…¥ç‚¹ï¼ˆæ³¨è§£ï¼‰çš„ // ä¸Šä¸€è¡Œã€‚è¿™æœ‰åŠ©äºæ‰©å±•ä»£ç ç”Ÿæˆå™¨è¾“å‡ºçš„å†…å®¹ã€‚åœ¨ä¸€æ¬¡protocè°ƒç”¨ä¸­ï¼Œå¯èƒ½ä¼šåŒ // æ—¶æŒ‡å®šå¤šä¸ªprotocæ’ä»¶ï¼Œå‰é¢çš„æ’ä»¶å¯èƒ½ä¼šåœ¨è¾“å‡ºçš„å†…å®¹ä¸­æŒ‡å®šæ’å…¥ç‚¹ï¼Œåé¢çš„ // æ’ä»¶å¯èƒ½ä¼šåœ¨è¿™äº›æŒ‡å®šçš„æ’å…¥ç‚¹çš„ä½ç½®ç»§ç»­æ‰©å±•ä»£ç å†…å®¹ã€‚ // ä¾‹å¦‚ï¼Œå‰é¢çš„ä¸€ä¸ªæ’ä»¶åœ¨è¾“å‡ºçš„ä»£ç å†…å®¹ä¸­å¢åŠ äº†è¿™æ ·ä¸€è¡Œæ³¨è§£ï¼š // @@protoc_insertion_point(NAME) // è¿™æ ·å°±å®šä¹‰äº†ä¸€ä¸ªæ’å…¥ç‚¹ï¼Œæ’å…¥ç‚¹å‰é¢ã€åé¢å¯ä»¥åŒ…å«ä»»æ„çš„æ–‡æœ¬å†…å®¹ï¼Œå³ä½¿åœ¨ // æ³¨é‡Šé‡Œé¢ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚è¿™é‡Œçš„æ’å…¥ç‚¹å®šä¹‰ä¸­çš„NAMEåº”è¯¥å¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ’å…¥ç‚¹ // æ‰å¯ä»¥ï¼Œç±»ä¼¼äºæ ‡è¯†ç¬¦ï¼Œä»¥ä¾›å…¶ä»–çš„æ’ä»¶ä½¿ç”¨ï¼Œæ’ä»¶æ’å…¥ä»£ç çš„æ—¶å€™å°†ä»æ’å…¥ç‚¹ // çš„ä¸Šä¸€è¡Œå¼€å§‹è‡ªè¡Œæ’å…¥ã€‚å¦‚æœåŒ…å«å¤šä¸ªæ’å…¥ç‚¹çš„è¯ï¼Œæ’å…¥ç‚¹çš„å†…å®¹å°†è¢«æ’ä»¶ä¾æ¬¡ // æ‰©å±•ã€‚ // // ä¸€å¼€å§‹åˆ›å»ºè¿™ä¸ªæºä»£ç æ–‡ä»¶çš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…æ’ä»¶ä¸åé¢çš„ç»§ç»­æ‰©å±•æºä»£ç æ’å…¥ // ç‚¹ä½ç½®å†…å®¹çš„ä»£ç ç”Ÿæˆå™¨æˆ–è€…æ’ä»¶ï¼Œå¿…é¡»åœ¨protocçš„åŒä¸€æ¬¡è°ƒç”¨ä¸­ï¼Œä»£ç ç”Ÿæˆå™¨ // æˆ–è€…æ’ä»¶æŒ‰ç…§protocå‘½ä»¤è¡Œè°ƒç”¨è¿‡ç¨‹ä¸­æŒ‡å®šçš„é¡ºåºä¾æ¬¡è°ƒç”¨ã€‚ optional string insertion_point = 2; // å¾…å†™å…¥åˆ°æºä»£ç ä¸­çš„å†…å®¹ optional string content = 15; } // ä¸€æ¬¡è¦å¤„ç†çš„ protoæ–‡ä»¶å¯èƒ½æœ‰å¤šä¸ªï¼Œæ‰€ä»¥æ’ä»¶å¤„ç†åè¿™é‡Œçš„fileæ˜¯ä¸€ä¸ªlist repeated File file = 15; }  ä¸‹é¢çœ‹ä¸€ä¸‹protocä¸protocæ’ä»¶è¿™å¯¹çˆ¶å­è¿›ç¨‹ä¹‹é—´æ˜¯æ€ä¹ˆé€šä¿¡çš„ã€‚\nfile: src/google/protobuf/compiler/subprocess.h\nclass LIBPROTOC_EXPORT Subprocess { public: Subprocess(); ~Subprocess(); enum SearchMode { SEARCH_PATH, // Use PATH environment variable. EXACT_NAME // Program is an exact file name; don't use the PATH. }; // Start the subprocess. Currently we don't provide a way to specify // arguments as protoc plugins don't have any. void Start(const string\u0026amp; program, SearchMode search_mode); // Serialize the input message and pipe it to the subprocess's stdin, then // close the pipe. Meanwhile, read from the subprocess's stdout and parse // the data into *output. All this is done carefully to avoid deadlocks. // Returns true if successful. On any sort of error, returns false and sets // *error to a description of the problem. bool Communicate(const Message\u0026amp; input, Message* output, string* error); // win32 relevant ... neglect private: #ifdef _WIN32 // ... #else // !_WIN32 pid_t child_pid_; // The file descriptors for our end of the child's pipes. We close each and // set it to -1 when no longer needed. int child_stdin_; int child_stdout_; #endif };  ä¸‹é¢æ˜¯Linuxå¹³å°ä¸‹çš„å­è¿›ç¨‹å¯åŠ¨å¤„ç†é€»è¾‘ã€‚\nfile: src/google/protobuf/compiler/subprocess.cc\nvoid Subprocess::Start(const string\u0026amp; program, SearchMode search_mode) { // Note that we assume that there are no other threads, thus we don't have to // do crazy stuff like using socket pairs or avoiding libc locks. // [0] is read end, [1] is write end. int stdin_pipe[2]; int stdout_pipe[2]; GOOGLE_CHECK(pipe(stdin_pipe) != -1); GOOGLE_CHECK(pipe(stdout_pipe) != -1); char* argv[2] = { strdup(program.c_str()), NULL }; child_pid_ = fork(); if (child_pid_ == -1) { GOOGLE_LOG(FATAL) \u0026lt;\u0026lt; \u0026quot;fork: \u0026quot; \u0026lt;\u0026lt; strerror(errno); } else if (child_pid_ == 0) { // We are the child. // å°†å­è¿›ç¨‹çš„stdiné‡å®šå‘åˆ°stdin_pipeçš„è¯»ç«¯ dup2(stdin_pipe[0], STDIN_FILENO); // å°†å­è¿›ç¨‹çš„stdouté‡å®šå‘åˆ°stdout_pipeçš„å†™ç«¯ dup2(stdout_pipe[1], STDOUT_FILENO); // å­è¿›ç¨‹é€šè¿‡0ã€1å¯¹ç®¡é“è¿›è¡Œæ“ä½œå°±å¤Ÿäº†ï¼Œé‡Šæ”¾å¤šä½™çš„fd close(stdin_pipe[0]); close(stdin_pipe[1]); close(stdout_pipe[0]); close(stdout_pipe[1]); // æ ¹æ®ç¨‹åºæœç´¢æ¨¡å¼è°ƒç”¨execæ—å‡½æ•°æ¥è°ƒç”¨æ’ä»¶æ‰§è¡Œï¼Œexecæ—å‡½æ•°é€šè¿‡æ›¿æ¢å½“å‰è¿› // ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µç­‰å†…å­˜æ•°æ®ä¿¡æ¯ï¼Œç„¶åè°ƒæ•´å¯„å­˜å™¨ä¿¡æ¯ï¼Œä½¿å¾—è¿›ç¨‹è½¬è€Œå»æ‰§ // è¡Œæ’ä»¶çš„ä»£ç ã€‚æ’ä»¶ä»£ç æ‰§è¡Œä¹‹å‰è¿›ç¨‹å°±å·²ç»å°†fd 0ã€1é‡å®šå‘åˆ°çˆ¶è¿›ç¨‹cloneè¿‡ // æ¥çš„ç®¡é“äº†ï¼Œå› æ­¤æ’ä»¶ç¨‹åºçš„è¾“å‡ºå°†ç›´æ¥è¢«è¾“å‡ºåˆ°çˆ¶è¿›ç¨‹åˆ›å»ºçš„ç®¡é“ä¸­ã€‚ // æ­£å¸¸æƒ…å†µä¸‹ï¼Œexecä¸€æ—¦æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆä¹…ç»ä¸å¯¹æ‰§è¡Œswitchåç»­çš„ä»£ç äº†ï¼Œåªæœ‰ // å‡ºé”™æ‰å¯èƒ½ä¼šæ‰§è¡Œåˆ°åç»­çš„ä»£ç ã€‚ switch (search_mode) { case SEARCH_PATH: execvp(argv[0], argv); break; case EXACT_NAME: execv(argv[0], argv); break; } // åªæœ‰å‡ºé”™æ‰å¯èƒ½ä¼šæ‰§è¡Œåˆ°è¿™é‡Œçš„ä»£ç ã€‚ // Write directly to STDERR_FILENO to avoid stdio code paths that may do // stuff that is unsafe here. int ignored; ignored = write(STDERR_FILENO, argv[0], strlen(argv[0])); const char* message = \u0026quot;: program not found or is not executable\\n\u0026quot;; ignored = write(STDERR_FILENO, message, strlen(message)); (void) ignored; // Must use _exit() rather than exit() to avoid flushing output buffers // that will also be flushed by the parent. _exit(1); } else { free(argv[0]); // çˆ¶è¿›ç¨‹é‡Šæ”¾æ— ç”¨çš„fd close(stdin_pipe[0]); close(stdout_pipe[1]); // å­è¿›ç¨‹çš„stdinï¼Œå¯¹çˆ¶è¿›ç¨‹æ¥è¯´ä¹Ÿå°±æ˜¯ç®¡é“stdin_pipeçš„å†™ç«¯ï¼ŒCodeGeneratorRequestå°†é€šè¿‡è¿™ä¸ªfdå†™ç»™å­è¿›ç¨‹ child_stdin_ = stdin_pipe[1]; // å­è¿›ç¨‹çš„stdoutï¼Œå¯¹çˆ¶è¿›ç¨‹æ¥è¯´ä¹Ÿå°±æ˜¯ç®¡é“stdout_pipeçš„è¯»ç«¯ï¼ŒCodeGeneratorResponseå°†é€šè¿‡è¿™ä¸ªfdä»å­è¿›ç¨‹è¯»å– child_stdout_ = stdout_pipe[0]; } }  ä¸‹é¢æ¥ç€çœ‹çˆ¶è¿›ç¨‹è¯»å–å­è¿›ç¨‹è¿”å›çš„CodeGeneratorResponseçš„æ‰§è¡Œé€»è¾‘ã€‚\nbool Subprocess::Communicate(const Message\u0026amp; input, Message* output, string* error) { GOOGLE_CHECK_NE(child_stdin_, -1) \u0026lt;\u0026lt; \u0026quot;Must call Start() first.\u0026quot;; // The \u0026quot;sighandler_t\u0026quot; typedef is GNU-specific, so define our own. typedef void SignalHandler(int); // Make sure SIGPIPE is disabled so that if the child dies it doesn't kill us. SignalHandler* old_pipe_handler = signal(SIGPIPE, SIG_IGN); string input_data = input.SerializeAsString(); string output_data; int input_pos = 0; int max_fd = max(child_stdin_, child_stdout_); // child_stdout==-1çš„æ—¶å€™è¡¨ç¤ºå­è¿›ç¨‹è¿”å›çš„æ•°æ®å·²ç»è¯»å–å®Œæ¯•äº†ï¼Œå¯ä»¥ggäº† while (child_stdout_ != -1) { fd_set read_fds; fd_set write_fds; FD_ZERO(\u0026amp;read_fds); FD_ZERO(\u0026amp;write_fds); if (child_stdout_ != -1) { FD_SET(child_stdout_, \u0026amp;read_fds); } if (child_stdin_ != -1) { FD_SET(child_stdin_, \u0026amp;write_fds); } // è¿™ç§æƒ…æ™¯ä¸‹ä¹Ÿç”¨selectï¼Œæœç„¶å¾ˆgoogleï¼ if (select(max_fd + 1, \u0026amp;read_fds, \u0026amp;write_fds, NULL, NULL) \u0026lt; 0) { if (errno == EINTR) { // Interrupted by signal. Try again. continue; } else { GOOGLE_LOG(FATAL) \u0026lt;\u0026lt; \u0026quot;select: \u0026quot; \u0026lt;\u0026lt; strerror(errno); } } // stdout_pipeå†™äº‹ä»¶å°±ç»ªï¼Œå†™è¯·æ±‚CodeGeneratorRequestç»™å­è¿›ç¨‹ if (child_stdin_ != -1 \u0026amp;\u0026amp; FD_ISSET(child_stdin_, \u0026amp;write_fds)) { int n = write(child_stdin_, input_data.data() + input_pos, input_data.size() - input_pos); if (n \u0026lt; 0) { // Child closed pipe. Presumably it will report an error later. // Pretend we're done for now. input_pos = input_data.size(); } else { input_pos += n; } // ä»£ç ç”Ÿæˆè¯·æ±‚å·²ç»æˆåŠŸå†™ç»™å­è¿›ç¨‹äº†ï¼Œå…³é—­ç›¸å…³çš„fd if (input_pos == input_data.size()) { // We're done writing. Close. close(child_stdin_); child_stdin_ = -1; } } // stdin_pipeè¯»äº‹ä»¶å°±ç»ªï¼Œè¯»å–å­è¿›ç¨‹è¿”å›çš„CodeGeneratorResponse if (child_stdout_ != -1 \u0026amp;\u0026amp; FD_ISSET(child_stdout_, \u0026amp;read_fds)) { char buffer[4096]; int n = read(child_stdout_, buffer, sizeof(buffer)); if (n \u0026gt; 0) { output_data.append(buffer, n); } else { // å­è¿›ç¨‹è¿”å›çš„CodeGeneratorResponseå·²ç»è¯»å–å®Œæ¯•ï¼Œå…³é—­ç›¸å…³çš„fd close(child_stdout_); child_stdout_ = -1; } } } // å­è¿›ç¨‹è¿˜æ²¡æœ‰è¯»å–CodeGeneratorRequestå®Œæ¯•ï¼Œå°±å…³é—­äº†è¾“å‡ºï¼Œè¿™ç§æƒ…å†µä¸‹ä¹Ÿä¸å¯ // èƒ½è¯»å–åˆ°è¿”å›çš„CodeGeneratorResponseäº†ï¼Œè¿™ç§æƒ…å†µå¾ˆå¯èƒ½æ˜¯å‡ºç°äº†å¼‚å¸¸ã€‚ if (child_stdin_ != -1) { // Child did not finish reading input before it closed the output. // Presumably it exited with an error. close(child_stdin_); child_stdin_ = -1; } // ç­‰å¾…å­è¿›ç¨‹ç»“æŸï¼Œå­è¿›ç¨‹é€€å‡ºä¹‹åï¼Œéœ€è¦çˆ¶è¿›ç¨‹æ¥æ¸…ç†å­è¿›ç¨‹å ç”¨çš„éƒ¨åˆ†èµ„æºã€‚ // å¦‚æœå½“å‰çˆ¶è¿›ç¨‹ä¸waitpidçš„è¯ï¼Œå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ä¼šå˜ä¸ºinitæˆ–è€…systemdè¿›ç¨‹ï¼ŒåŒæ ·ä¹Ÿä¼šè¢«æ¸…ç†çš„ã€‚ int status; while (waitpid(child_pid_, \u0026amp;status, 0) == -1) { if (errno != EINTR) { GOOGLE_LOG(FATAL) \u0026lt;\u0026lt; \u0026quot;waitpid: \u0026quot; \u0026lt;\u0026lt; strerror(errno); } } // åˆšæ‰ä¸ºäº†é˜»æ­¢SIGPIPEä¿¡å·åˆ°è¾¾æ—¶å¯¼è‡´è¿›ç¨‹ç»ˆæ­¢ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†SIGPIPEçš„ä¿¡å·å¤„ç†å‡½ // æ•°ï¼Œè¿™é‡Œå¯ä»¥æ¢å¤ä¹‹å‰çš„SIGPIPEçš„ä¿¡å·å¤„ç†å‡½æ•°ã€‚ signal(SIGPIPE, old_pipe_handler); // æ ¹æ®å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€æ‰§è¡Œåç»­çš„å¤„ç†é€»è¾‘ // - å¼‚å¸¸å¤„ç† if (WIFEXITED(status)) { if (WEXITSTATUS(status) != 0) { int error_code = WEXITSTATUS(status); *error = strings::Substitute( \u0026quot;Plugin failed with status code $0.\u0026quot;, error_code); return false; } } else if (WIFSIGNALED(status)) { int signal = WTERMSIG(status); *error = strings::Substitute( \u0026quot;Plugin killed by signal $0.\u0026quot;, signal); return false; } else { *error = \u0026quot;Neither WEXITSTATUS nor WTERMSIG is true?\u0026quot;; return false; } // å°†å­è¿›ç¨‹è¿”å›çš„ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGeneratorResponseæ•°æ®è¿›è¡Œåä¸²è¡ŒåŒ–ï¼Œåä¸²è¡ŒåŒ– // æˆMessageå¯¹è±¡ï¼Œå®é™…ä¸Šè¿™é‡Œçš„Message::ParseFromString(const string\u0026amp;)æ˜¯ä¸ªè™š // å‡½æ•°ï¼Œæ˜¯è¢«CodeGeneratorResponseè¿™ä¸ªç±»é‡å†™äº†çš„ï¼Œåä¸²è¡ŒåŒ–è¿‡ç¨‹ä¸å…·ä½“çš„ç±»å¯†åˆ‡ // ç›¸å…³ï¼Œä¹Ÿå¿…é¡»åœ¨æ´¾ç”Ÿç±»ä¸­äºˆä»¥å®ç°ã€‚ if (!output-\u0026gt;ParseFromString(output_data)) { *error = \u0026quot;Plugin output is unparseable.\u0026quot;; return false; } return true; }  åˆ°è¿™é‡Œä¸ºæ­¢protocè¿›ç¨‹çš„å…·ä½“æ‰§è¡Œé€»è¾‘æˆ‘ä»¬å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œçœ‹åˆ°è¿™é‡Œæƒ³å¿…è¯»è€…ä¹Ÿçœ‹æ¸…æ¥šäº†å§ï¼Ÿä¸‹é¢å†çœ‹ä¸‹æ’ä»¶çš„æ‰§è¡Œé€»è¾‘ã€‚\næ’ä»¶çš„æ‰§è¡Œé€»è¾‘ä¸€å®šä¹Ÿæ˜¯éå¸¸ç®€å•çš„ï¼Œæ’ä»¶å°±åªæ˜¯ä»stdinè¯»å–ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGeneratorRequestè¯·æ±‚ï¼Œç„¶åæ‰§è¡Œåä¸²è¡ŒåŒ–å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„CodeGeneratorRequestå¯¹è±¡ï¼Œç„¶åæ ¹æ®è¯·æ±‚è¿›è¡Œå¿…è¦çš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼Œç¡®å®šè¦ç”Ÿæˆçš„æºä»£ç ä¿¡æ¯ï¼Œå¹¶å°†å…¶è®¾ç½®åˆ°CodeGeneratorResponseä¸­å¹¶ä¸²è¡ŒåŒ–åå†™å…¥åˆ°stdoutï¼Œæ’ä»¶çš„æ‰§è¡Œé€»è¾‘å°±è¿™ä¹ˆç®€å•ã€‚\nä¸‹é¢æˆ‘ä»¬å°†è¿›å…¥æ’ä»¶çš„ç¼–å†™è¿‡ç¨‹äº†ã€‚\n2.4. protocæ’ä»¶å¼€å‘ # 2.4.1. protocä¸­çš„descriptorå®šä¹‰ # protoæ–‡ä»¶ä¸­çš„æ•°æ®ç±»å‹éƒ½æ˜¯åœ¨descriptor.protoä¸­å®šä¹‰å¥½çš„ï¼Œä¸ºäº†æ›´å¥½åœ°å¸®åŠ©æˆ‘ä»¬å¯¹protoæ–‡ä»¶ä¸­çš„æ•°æ®ç±»å‹è¿›è¡Œè§£æï¼Œä¸ºäº†åœ¨æ’ä»¶å¼€å‘è¿‡ç¨‹ä¸­æ›´åŠ æ–¹ä¾¿å¿«é€Ÿåœ°è·å¾—ä¸æ•°æ®ç±»å‹ã€å˜é‡ã€rpcç­‰ç›¸å…³çš„è¿™ç§å†…å®¹ã€é‚£ç§å†…å®¹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦æ·±å…¥åœ°ç†è§£descriptor.protoä¸­çš„ç›¸å…³å®šä¹‰ä»¥åŠä»å®ƒå»¶ä¼¸å‡ºæ¥çš„ä¸€äº›æ¦‚å¿µã€ç®—æ³•ç­‰ã€‚\nè¿™éƒ¨åˆ†çš„å†…å®¹è¿˜ä¸å°‘ï¼Œåœ¨ä¸å½±å“ç†è§£çš„å¤§å‰æä¸‹ï¼Œæˆ‘è¿˜æ˜¯ç¨å¾®åˆ å‡å†™äº›ä»£ç ï¼Œé¿å…å¯¹å¤§å®¶ç†è§£é€ æˆä¸å¿…è¦çš„å¹²æ‰°ã€‚\nfile: src/google/protobuf/descriptor.proto\n// Author: kenton@google.com (Kenton Varda) // Based on original Protocol Buffers design by // Sanjay Ghemawat, Jeff Dean, and others. // descriptor.protoæ–‡ä»¶ä¸­çš„messageså®šä¹‰äº†protoæ–‡ä»¶ä¸­æ‰€èƒ½è§åˆ°çš„æ‰€æœ‰çš„å®šä¹‰ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„.protoæ–‡ä»¶åœ¨ä¸æä¾›å…¶ä»–ä¿¡æ¯ï¼ˆç”šè‡³ä¸éœ€è¦è¯»å–å®ƒçš„importsï¼‰èƒ½å¤Ÿç›´æ¥è¢«è½¬æ¢æˆä¸€ä¸ªFileDescriptorProtoå¯¹è±¡ã€‚ package google.protobuf; option java_package = \u0026quot;com.google.protobuf\u0026quot;; option java_outer_classname = \u0026quot;DescriptorProtos\u0026quot;; // descriptor.protoå¿…é¡»åœ¨é€Ÿåº¦æ–¹é¢ä¼˜åŒ–ï¼Œå› ä¸ºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åŸºäºåå°„çš„ç®—æ³•ä¸èµ·ä½œç”¨ option optimize_for = SPEED; // protocå¯ä»¥å°†è§£æçš„protoæ–‡ä»¶ä¸­çš„descriptoræ·»åŠ åˆ°FileDescriptorSetå¹¶è¾“å‡ºåˆ°æ–‡ä»¶ message FileDescriptorSet { repeated FileDescriptorProto file = 1; } // ä¸‹é¢çš„message FileDescriptorProtoå¯ä»¥ç”¨äºæè¿°ä¸€ä¸ªå®Œæ•´çš„protoæ–‡ä»¶ message FileDescriptorProto { optional string name = 1; // protoæ–‡ä»¶åï¼Œfile nameï¼Œç›¸å¯¹äºæºä»£ç æ ¹ç›®å½• optional string package = 2; // protoåŒ…åï¼Œä¾‹å¦‚ \u0026quot;foo\u0026quot;ã€\u0026quot;foo.bar\u0026quot; repeated string dependency = 3; // protoæ–‡ä»¶ä¸­importè¿›æ¥çš„å…¶ä»–protoæ–‡ä»¶åˆ—è¡¨ repeated int32 public_dependency = 10; // ä¸Šé¢public importçš„protoæ–‡ä»¶åœ¨protoæ–‡ä»¶åˆ—è¡¨ä¸­çš„ç´¢å¼• // Indexes of the weak imported files in the dependency list. repeated int32 weak_dependency = 11; // ä¸Šé¢weak importçš„protoæ–‡ä»¶åœ¨protoæ–‡ä»¶åˆ—è¡¨ä¸­çš„ç´¢å¼• // ä¸è¦ä½¿ç”¨ï¼Œåªç”¨äºgoogleå†…éƒ¨çš„è¿ç§» // protoæ–‡ä»¶ä¸­çš„æ‰€æœ‰é¡¶å±‚å®šä¹‰ä¿¡æ¯ repeated DescriptorProto message_type = 4; // æ‰€æœ‰çš„æ¶ˆæ¯(message)ç±»å‹å®šä¹‰ repeated EnumDescriptorProto enum_type = 5; // æ‰€æœ‰çš„æšä¸¾(enum)ç±»å‹å®šä¹‰ repeated ServiceDescriptorProto service = 6; // æ‰€æœ‰çš„æœåŠ¡(service)ç±»å‹å®šä¹‰ repeated FieldDescriptorProto extension = 7; // æ‰€æœ‰çš„æ‰©å±•å­—æ®µå®šä¹‰ optional FileOptions options = 8; // æ–‡ä»¶é€‰é¡¹ // è¿™ä¸ªå­—æ®µåŒ…æ‹¬äº†æºä»£ç çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿™é‡Œçš„ä¿¡æ¯å¯ä»¥ç»™å¼€å‘å·¥å…·ä½¿ç”¨ï¼Œä¹Ÿä»…åº”è¯¥æä¾›ç»™å¼€å‘å·¥å…·ä½¿ç”¨ï¼› // å¯ä»¥é€‰æ‹©å°†è¿™ä¸ªå­—æ®µä¸­çš„ä¿¡æ¯åˆ é™¤ï¼Œåœ¨ç¨‹åºè¿è¡ŒæœŸé—´å¹¶ä¸ä¼šé€ æˆç ´åã€‚ optional SourceCodeInfo source_code_info = 9; } // æè¿°æ¶ˆæ¯ç±»å‹Message message DescriptorProto { optional string name = 1; // Messageçš„ç±»å‹åç§° repeated FieldDescriptorProto field = 2; // Messageä¸­åŒ…æ‹¬çš„å­—æ®µåˆ—è¡¨ repeated FieldDescriptorProto extension = 6; // Messageä¸­åŒ…æ‹¬çš„æ‰©å±•åˆ—è¡¨ repeated DescriptorProto nested_type = 3; // Messageä¸­åµŒå¥—çš„Messageç±»å‹åˆ—è¡¨ repeated EnumDescriptorProto enum_type = 4; // Messageä¸­åµŒå¥—çš„æšä¸¾ç±»å‹åˆ—è¡¨ message ExtensionRange { optional int32 start = 1; optional int32 end = 2; } repeated ExtensionRange extension_range = 5; optional MessageOptions options = 7; } // æè¿°ä¸€ä¸ªå­—æ®µï¼ˆå­—æ®µå¯ä»¥æ˜¯Messageä¸­çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æŸäº›æ‰©å±•å­—æ®µï¼‰ message FieldDescriptorProto { // å­—æ®µæ•°æ®ç±»å‹ enum Type { // 0 is reserved for errors. // ç”±äºå†å²æ–¹é¢çš„åŸå› ï¼Œè¿™é‡Œçš„æšä¸¾å€¼çš„é¡ºåºæœ‰ç‚¹å¥‡æ€ª TYPE_DOUBLE = 1; TYPE_FLOAT = 2; // Not ZigZag encoded. Negative numbers take 10 bytes. Use TYPE_SINT64 if // negative values are likely. TYPE_INT64 = 3; TYPE_UINT64 = 4; // Not ZigZag encoded. Negative numbers take 10 bytes. Use TYPE_SINT32 if // negative values are likely. TYPE_INT32 = 5; TYPE_FIXED64 = 6; TYPE_FIXED32 = 7; TYPE_BOOL = 8; TYPE_STRING = 9; TYPE_GROUP = 10; // Tag-delimited aggregate. TYPE_MESSAGE = 11; // Length-delimited aggregate. // New in version 2. TYPE_BYTES = 12; TYPE_UINT32 = 13; TYPE_ENUM = 14; TYPE_SFIXED32 = 15; TYPE_SFIXED64 = 16; TYPE_SINT32 = 17; // Uses ZigZag encoding. TYPE_SINT64 = 18; // Uses ZigZag encoding. }; // å­—æ®µä¿®é¥°ç¬¦optionalã€requiredã€repeated enum Label { // 0 is reserved for errors LABEL_OPTIONAL = 1; LABEL_REQUIRED = 2; LABEL_REPEATED = 3; // TODO(sanjay): Should we add LABEL_MAP? }; optional string name = 1; // å­—æ®µåç§° optional int32 number = 3; // å­—æ®µtagç¼–å· optional Label label = 4; // å­—æ®µä¿®é¥°ç¬¦ // å¦‚æœtype_nameå·²è®¾ç½®ï¼Œè¿™ä¸ªå­—æ®µæ— é¡»è®¾ç½®ï¼› // å¦‚æœè¿™ä¸¤ä¸ªå­—æ®µéƒ½è®¾ç½®äº†ï¼Œè¿™é‡Œçš„typeå­—æ®µå¿…é¡»æ˜¯TYPE_ENUMç±»å‹æˆ–è€…TYPE_MESSAGEç±»å‹ optional Type type = 5; // å¯¹äºTYPE_ENUMæˆ–è€…TYPE_MESSAGEç±»å‹ï¼Œtype_nameå°±æ˜¯typeçš„åå­—ã€‚ // å¦‚æœnameä»¥â€œ.â€å¼€å¤´é‚£ä¹ˆå®ƒæ˜¯å®Œå…¨ä¿ç•™çš„ã€‚å¯¹äºC++æ¥è¯´ï¼Œå…¶ä½œç”¨åŸŸè§„åˆ™è¦æ±‚é¦–å…ˆæœ // ç´¢å½“å‰Messageç±»å‹çš„åµŒå¥—ç±»å‹ï¼Œç„¶åæ‰æ˜¯parent namespaceä¸­çš„ç±»å‹ï¼Œä¸€ç›´åˆ°root // namespaceã€‚ optional string type_name = 6; // å¯¹äºæ‰©å±•ï¼Œå®ƒå°±æ˜¯è¢«æ‰©å±•çš„ç±»å‹çš„åå­—ï¼Œå¯¹å®ƒçš„è§£æä¸å¯¹type_nameçš„è§£ææ—¶ä¸€æ ·çš„ optional string extendee = 2; // å¯¹äºæ•°å€¼ç±»å‹ï¼Œå­˜å‚¨äº†æ•°å€¼çš„æ–‡æœ¬è¡¨ç¤ºå½¢å¼ï¼› // å¯¹äºå¸ƒå°”ç±»å‹ï¼Œå­˜å‚¨å­—ç¬¦ä¸²\u0026quot;true\u0026quot;æˆ–\u0026quot;false\u0026quot;ï¼› // å¯¹äºå­—ç¬¦ä¸²ç±»å‹ï¼Œå­˜å‚¨åŸå§‹çš„æ–‡æœ¬å†…å®¹ï¼ˆæœªè½¬ä¹‰çš„ï¼‰ // å¯¹äºå­—èŠ‚ï¼Œå­˜å‚¨äº†cè½¬ä¹‰åçš„å€¼ï¼ˆæ‰€æœ‰\u0026gt;=128çš„å­—èŠ‚éƒ½ä¼šè¢«è½¬ä¹‰ï¼‰ // TODO(kenton)ï¼ŒåŸºäºbase64ç¼–ç çš„? optional string default_value = 7; optional FieldOptions options = 8; // å­—æ®µé€‰é¡¹ } // æè¿°ä¸€ä¸ªæšä¸¾ç±»å‹enum message EnumDescriptorProto { optional string name = 1; // æšä¸¾ç±»å‹åç§° repeated EnumValueDescriptorProto value = 2; // æšä¸¾ç±»å‹ä¸­åŒ…æ‹¬çš„æšä¸¾å€¼åˆ—è¡¨ optional EnumOptions options = 3; // æšä¸¾ç±»å‹é€‰é¡¹ } // æè¿°ä¸€ä¸ªæšä¸¾ç±»å‹ä¸­çš„ä¸€ä¸ªæšä¸¾å€¼ message EnumValueDescriptorProto { optional string name = 1; // æšä¸¾å€¼å¯¹åº”çš„name optional int32 number = 2; // æšä¸¾å€¼å¯¹åº”çš„numberï¼ˆé»˜è®¤ä¸º0ï¼Œä¾æ¬¡é€’å¢ï¼‰ optional EnumValueOptions options = 3; // æšä¸¾å€¼é€‰é¡¹ } // æè¿°ä¸€ä¸ªrpc service. message ServiceDescriptorProto { optional string name = 1; // æœåŠ¡åç§° repeated MethodDescriptorProto method = 2; // æœåŠ¡å¯¹åº”çš„æ–¹æ³•åˆ—è¡¨ optional ServiceOptions options = 3; // æœåŠ¡é€‰é¡¹ } // æè¿°ä¸€ä¸ªæœåŠ¡çš„æ–¹æ³• message MethodDescriptorProto { optional string name = 1; // æ–¹æ³•åç§° optional string input_type = 2; // æ–¹æ³•å…¥å‚ç±»å‹ optional string output_type = 3; // æ–¹æ³•å‡ºå‚ç±»å‹ optional MethodOptions options = 4; // æ–¹æ³•é€‰é¡¹ } // =================================================================== // Options // ä¸Šé¢çš„æ¯ä¸€ä¸ªå®šä¹‰åŸºæœ¬ä¸Šéƒ½åŒ…æ‹¬äº†é€‰é¡¹optionç›¸å…³çš„å­—æ®µï¼Œè¿™äº›é€‰é¡¹å­—æ®µä»…ä»…æ˜¯ä¸€äº› // æ³¨è§£ï¼Œè¿™äº›æ³¨è§£ä¼šå½±å“ä»£ç çš„ç”Ÿæˆï¼Œä½¿å¾—ç”Ÿæˆçš„ä»£ç ç¨æœ‰ä¸åŒï¼Œæ³¨è§£ä¹Ÿå¯èƒ½åŒ…å«äº†æ“ä½œ // messageçš„ä»£ç çš„ä¸€äº›æç¤ºä¿¡æ¯ã€è¯´æ˜ä¿¡æ¯ã€‚ // // clientså¯èƒ½ä¼šå®šä¹‰ä¸€äº›è‡ªå®šä¹‰çš„é€‰é¡¹æ¥ä½œä¸º*Options messageçš„extensionsï¼Œè¿™äº› // extensionsåœ¨parsingé˜¶æ®µå¯èƒ½è¿˜æ— æ³•ç¡®å®šä¸‹æ¥ï¼Œæ‰€ä»¥parserä¸èƒ½å­˜å‚¨ä»–ä»¬çš„å€¼ï¼Œè€Œæ˜¯ // å°†è¿™äº›è‡ªå®šä¹‰çš„é€‰é¡¹å…ˆå­˜å‚¨åˆ°ä¸€ä¸ª*Options messageé‡Œé¢ï¼Œç§°ä¹‹ä¸º // uinterpreted_optionã€‚è¿™ä¸ªå­—æ®µçš„åå­—åœ¨æ‰€æœ‰çš„*Options messageé‡Œé¢éƒ½å¿…é¡»ä¿è¯æ˜¯ // ç›¸åŒçš„ã€‚ä¹‹ååœ¨æˆ‘ä»¬æ„å»ºdescriptorçš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™æ‰€æœ‰çš„protoæ–‡ä»¶ä¹Ÿéƒ½è§£æå®Œäº†ã€ // æ‰€æœ‰çš„extensionsä¹Ÿéƒ½çŸ¥é“äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†ç”¨è¿™é‡Œçš„uinterpreted_optionå­—æ®µå» // å¡«å……é‚£äº›extensionsã€‚ // // ç”¨äºè‡ªå®šä¹‰é€‰é¡¹çš„extensionsç¼–å·çš„é€‰æ‹©ä¸€èˆ¬éµå¾ªä¸‹é¢çš„æ–¹æ³•ï¼š // * å¯¹äºåªåœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºæˆ–è€…ç»„ç»‡å†…ä½¿ç”¨çš„é€‰é¡¹ï¼Œæˆ–è€…ç”¨äºå®éªŒç›®çš„çš„é€‰é¡¹ï¼Œä½¿ç”¨å­— // æ®µç¼–å·50000~99999èŒƒå›´å†…çš„ã€‚å¯¹äºå¤šä¸ªé€‰é¡¹ï¼Œç”¨æˆ·éœ€è¦ç¡®ä¿ä¸ä½¿ç”¨ç›¸åŒçš„ç¼–å·ã€‚ // * å¯¹äºå¯èƒ½è¢«å¤šä¸ªäº’ä¸ä¾èµ–çš„å®ä½“æ‰€å…±åŒä½¿ç”¨çš„é€‰é¡¹ï¼Œéœ€è¦ç»™ // protobuf-global-extension-registry@google.comå‘é‚®ä»¶æ¥ç”³è¯·é¢„ç•™æ‰©å±•ç¼–å·ã€‚éœ€ // è¦æä¾›å·¥ç¨‹åç§°ã€å·¥ç¨‹ç«™ç‚¹ï¼Œæ²¡å¿…è¦è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ç”³è¯·é¢„ç•™æŸä¸ªç‰¹å®šçš„ç¼–å·ã€‚é€š // å¸¸åªéœ€è¦ä¸€ä¸ªæ‰©å±•ç¼–å·ï¼Œå¯ä»¥å£°æ˜å¤šä¸ªé€‰é¡¹ä½†æ˜¯åªä½¿ç”¨è¿™ä¸€ä¸ªç›¸åŒçš„æ‰©å±•ç¼–å·ã€‚å¦‚ // æœç”³è¯·å…¬å…±çš„æ‰©å±•ç¼–å·æ˜¯ä¸ªåˆšéœ€ï¼Œgoogleå¯èƒ½ä¼šå‘å¸ƒä¸€ä¸ªweb serviceæ¥å£æ¥è‡ªåŠ¨åˆ† // é…é€‰é¡¹ç¼–å·ã€‚ message FileOptions { // javaåŒ…åï¼Œå½“å‰protoæ–‡ä»¶ä¸­ç”Ÿæˆçš„javaç±»å°†ä½äºè¿™ä¸ªpackageä¸‹ optional string java_package = 1; // æŒ‡å®šä¸€ä¸ªå¤–éƒ¨ç±»åç§°ï¼Œå½“å‰protoæ–‡ä»¶ä¸­ç”Ÿæˆçš„æ‰€æœ‰çš„ç±»å°†è¢«å°è£…åœ¨è¿™ä¸ªå¤–éƒ¨ç±»å½“ä¸­ optional string java_outer_classname = 8; // å¦‚æœè®¾ç½®ä¸ºtrueï¼Œjavaä»£ç ç”Ÿæˆå™¨å°†ä¸ºæ¯ä¸ªé¡¶å±‚messageã€enumã€serviceå®šä¹‰ç”Ÿæˆ // å•ç‹¬çš„javaæ–‡ä»¶ï¼Œé»˜è®¤ä¸ºfalse optional bool java_multiple_files = 10 [default=false]; // å¦‚æœè®¾ç½®ä¸ºtrueï¼Œjavaä»£ç ç”Ÿæˆå™¨å°†æœªæ¯ä¸ªmessageå®šä¹‰ç”Ÿæˆequals()ã€hashCode() // æ–¹æ³•ï¼Œé»˜è®¤ä¸ºfalseã€‚æœ¬æ¥AbstractMessageåŸºç±»ç»åŒ…æ‹¬äº†ä¸€ä¸ªåŸºäºåå°„çš„equals()ã€ // hashCode()æ–¹æ³•å®ç°ï¼Œè¿™é‡Œçš„è¿™ä¸ªè®¾ç½®é¡¹æ˜¯ä¸€ä¸ªæ€§èƒ½æ–¹é¢çš„ä¼˜åŒ– optional bool java_generate_equals_and_hash = 20 [default=false]; // ä¼˜åŒ–ç±»å‹ï¼Œç”Ÿæˆçš„ç±»å¯ä»¥è¿›è¡Œé€Ÿåº¦ä¼˜åŒ–ã€ä»£ç å°ºå¯¸ä¼˜åŒ– enum OptimizeMode { SPEED = 1; // Generate complete code for parsing, serialization, // etc. CODE_SIZE = 2; // Use ReflectionOps to implement these methods. LITE_RUNTIME = 3; // Generate code using MessageLite and the lite runtime. } optional OptimizeMode optimize_for = 9 [default=SPEED]; // è®¾ç½®goä»£ç çš„åŒ…å optional string go_package = 11; // æ˜¯å¦åº”è¯¥é’ˆå¯¹æ¯ä¸€é—¨è¯­è¨€éƒ½ç”Ÿæˆgenerice servicesï¼ŸgenericæœåŠ¡å¹¶ä¸ç‰¹å®šäºä»»ä½• // çš„rpcç³»ç»Ÿï¼Œå®ƒæ˜¯ç”±æ¯ä¸ªè¯­è¨€çš„æ³¨ä»£ç ç”Ÿæˆå™¨æ¥ç”Ÿæˆçš„ï¼Œä¸å€ŸåŠ©äºé¢å¤–çš„æ’ä»¶ã€‚ // generic servicesæ˜¯æ—©æœŸprotoo2è¿™ä¸ªç‰ˆæœ¬è¯´æ”¯æŒçš„å”¯ä¸€ä¸€ç§æœåŠ¡ç±»å‹ã€‚ // // ç”±äºç°åœ¨æ¨å´‡ä½¿ç”¨pluginsï¼Œpluginså¯ä»¥ç”Ÿæˆé’ˆå¯¹ç‰¹å®šrpcç³»ç»Ÿçš„ä»£ç ï¼Œgeneric // servicesç°åœ¨å¯ä»¥çœ‹åšæ˜¯è¢«åºŸå¼ƒäº†ã€‚å› æ­¤ï¼Œä»¥å‰proto2æ€»çš„generice servicesçš„é»˜ // è®¤è®¾ç½®é»˜è®¤ä¸ºfalseï¼Œæ—©æœŸçš„ä¾èµ–äºgeneric servicesçš„ä»£ç éœ€è¦æ˜¾ç¤ºè®¾ç½®è¿™äº›é€‰é¡¹ // ä¸ºtrueã€‚ optional bool cc_generic_services = 16 [default=false]; optional bool java_generic_services = 17 [default=false]; optional bool py_generic_services = 18 [default=false]; // parserå°†ä¸è¯†åˆ«çš„é€‰é¡¹å­˜å‚¨åœ¨è¿™é‡Œçš„uinterpreted_option repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message extensions 1000 to max; } message MessageOptions { // è®¾ä¸ºtrueåˆ™ä½¿ç”¨è€çš„proto1 MessageSet wire formatâ€¦â€¦å…¼å®¹æ€§ç›®çš„ï¼Œæ²¡å¿…è¦ä½¿ç”¨ optional bool message_set_wire_format = 1 [default=false]; // ç¦ç”¨æ ‡å‡†çš„descriptor()æ–¹æ³•çš„ç”Ÿæˆï¼Œå› ä¸ºå¦‚æœæœ‰ä¸ªå­—æ®µåæ˜¯descriptorçš„è¯ä¼šç”Ÿ // æˆä¸€ä¸ªåŒåçš„å‡½æ•°ï¼Œä¼šå†²çªã€‚è¿™ä½¿å¾—ä»proto1è¿ç§»åˆ°åç»­ç‰ˆæœ¬æ›´ç®€å•ï¼Œä½†æ˜¯æ–°ç‰ˆæœ¬ // ä¸­è¿˜æ˜¯åº”è¯¥é¿å…ä½¿ç”¨å­—æ®µdescriptorã€‚ optional bool no_standard_descriptor_accessor = 2 [default=false]; // parserå°†ä¸è¯†åˆ«çš„é€‰é¡¹å­˜å‚¨åœ¨è¿™ä¸ªå­—æ®µé‡Œ repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message extensions 1000 to max; } message FieldOptions { // å¼€å¯packedé€‰é¡¹ä¹‹åï¼Œå¯¹äºrepeatedåŸºæœ¬æ•°æ®ç±»å‹å­—æ®µçš„è¡¨ç¤ºä¼šæ›´åŠ é«˜æ•ˆã€‚ä¸å†é’ˆ // å¯¹repeatedå­—æ®µä¸­çš„å„ä¸ªå…ƒç´ æ‰§è¡Œå†™tagã€ç±»å‹æ“ä½œï¼Œè€Œæ˜¯å°†æ•´ä¸ªæ•°ç»„ä½œä¸ºä¸€ä¸ªå›ºå®š // é•¿åº¦çš„blobæ¥å­˜å‚¨ã€‚ optional bool packed = 2; // å½“å‰å­—æ®µæ˜¯å¦éœ€è¦lazy parsingï¼Ÿåªæ˜¯å»ºè®®ï¼Œlazyä¸ºtrueï¼Œprotocä¸ä¸€å®šlazy parsing optional bool lazy = 5 [default=false]; // å½“å‰å­—æ®µæ˜¯å¦å·²ç»è¢«åºŸå¼ƒï¼Œè·Ÿç›®æ ‡å¹³å°ç›¸å…³ï¼Œè¿™ä¸ªå­—æ®µå¯ä»¥ä¸ºç”Ÿæˆçš„accessoræ–¹æ³• // ç”ŸæˆDeprecatedæ³¨è§£ï¼Œå¦‚æœç›®æ ‡å¹³å°ä¸æ”¯æŒå°±ä¼šå¿½ç•¥è¿™ä¸ªé€‰é¡¹ã€‚ä¸ç®¡ç›®æ ‡å¹³å°æ˜¯å¦ // æ”¯æŒï¼Œprotoé‡Œé¢è¦æƒ³åºŸå¼ƒä¸€ä¸ªå­—æ®µåŠ deprecatedé€‰é¡¹è¿˜æ˜¯éå¸¸æ­£ç¡®çš„åšæ³•ã€‚ optional bool deprecated = 3 [default=false]; // mapå­—æ®µï¼Œç›®å‰è¿˜æœªå®Œå…¨å®ç°ï¼Œåº”é¿å…ä½¿ç”¨ optional string experimental_map_key = 9; // googleå†…éƒ¨è¿ç§»ä½¿ç”¨ï¼Œå› é¿å…ä½¿ç”¨ optional bool weak = 10 [default=false]; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message EnumOptions { // ä¸å…è®¸å°†å¤šä¸ªä¸åŒçš„tag namesæ˜ å°„åˆ°ä¸€ä¸ªç›¸åŒçš„å€¼ // - æ„æ€æ˜¯è¯´ä¸å…è®¸å¤šä¸ªå­—æ®µçš„ç¼–å·ç›¸åŒ optional bool allow_alias = 2 [default=true]; // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message EnumValueOptions { // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message ServiceOptions { // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } message MethodOptions { // æ³¨æ„ï¼šå­—æ®µç¼–å·1~32è¢«ä¿ç•™ç»™googleå†…éƒ¨rpcæ¡†æ¶ä½¿ç”¨ï¼Œgoogleçš„è§£é‡Šæ˜¯ï¼Œåœ¨ // protobufè¢«å…¬å¼€ç»™å¤–éƒ¨ä½¿ç”¨ä¹‹å‰å†…éƒ¨å°±å·²ç»å¤§é‡ä½¿ç”¨äº†ï¼Œä¸”1~32å€ä½¿ç”¨çš„å¾ˆå¤šï¼Œä¹Ÿ // æ˜¯ä¸å¾—å·²çš„äº‹æƒ…ï¼Œæ€»ä¸èƒ½ä¸ºäº†å¼€æºã€æ¨å¹¿ä¸€ä¸ªå†…éƒ¨ç»„ä»¶å°±æŠŠè‡ªå·±çš„ç”Ÿæ„ç ¸äº†å§ã€‚ // ç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•å½“å‰Message repeated UninterpretedOption uninterpreted_option = 999; // ç”¨æˆ·è‡ªå®šä¹‰é€‰é¡¹æ¥æ‰©å±•message extensions 1000 to max; } // æè¿°ä¸€ä¸ªparserä¸è®¤è¯†çš„option message // - UninterpretedOptionåªä¼šå‡ºç°åœ¨compiler::Parserç±»åˆ›å»ºçš„options protosä¸­ï¼› // - æ„å»ºDescriptorå¯¹è±¡çš„æ—¶å€™DescriptorPoolä¼šè§£æUninterpretedOptionsï¼› // å› æ­¤ï¼Œdescriptorå¯¹è±¡ä¸­çš„options protosï¼ˆé€šè¿‡Descriptor::options()è¿”å›ï¼Œæˆ–è€… // é€šè¿‡Descriptor::CopyTo()ç”Ÿæˆï¼‰æ˜¯ä¸ä¼šåŒ…æ‹¬UinterpretedOptionsçš„ã€‚ message UninterpretedOption { // uinterpretedé€‰é¡¹çš„åå­—ï¼Œnameä¸­æ¯ä¸ªå…ƒç´ çš„name_partå­—æ®µéƒ½è¡¨ç¤ºnameä¸­çš„ç‚¹åˆ†å­— // ç¬¦ä¸²çš„ä¸€æ®µï¼Œå¦‚æœname_partæ˜¯ä¸€ä¸ªæ‰©å±•ï¼ˆé€šè¿‡åœ¨å­—ç¬¦ä¸²ä¸¤ç«¯ç”¨æ‹¬å·æ‹¬èµ·æ¥è¡¨ç¤ºï¼‰ï¼Œ // is_extensionå­—æ®µä¸ºtrueã€‚ // ä¾‹å¦‚ï¼Œ{[\u0026quot;foo\u0026quot;, false], [\u0026quot;bar.baz\u0026quot;,true], [\u0026quot;qux\u0026quot;,false]}è¡¨ç¤º\u0026quot;foo.(bar.baz).qux\u0026quot;ã€‚ message NamePart { required string name_part = 1; required bool is_extension = 2; } repeated NamePart name = 2; // uinterpretedé€‰é¡¹çš„å€¼ï¼Œä¼šè®¾ç½®ä¸‹é¢å­—æ®µä¸­å…¶ä¸­ä¸€ä¸ªçš„å€¼ optional string identifier_value = 3; optional uint64 positive_int_value = 4; optional int64 negative_int_value = 5; optional double double_value = 6; optional bytes string_value = 7; optional string aggregate_value = 8; } // =================================================================== // Optional source code info // FileDescriptorProtoæ˜¯ä»ä¹‹å‰çš„source fileä¸­ç”Ÿæˆçš„ï¼ˆsource fileæŒ‡çš„æ˜¯protoæ–‡ // ä»¶ï¼‰ï¼Œè¿™é‡Œçš„SourceCodeInfoæŒ‡çš„æ˜¯protoä¸­çš„â€œæºä»£ç â€ä¿¡æ¯ã€‚ message SourceCodeInfo { // Locationç”¨äºè¯†åˆ«protoæ–‡ä»¶ä¸­çš„æºä»£ç ç‰‡æ®µï¼Œå¾€å¾€å¯¹åº”ç€ä¸€ä¸ªç‰¹å®šçš„å®šä¹‰ã€‚è¿™äº› // Locationä¿¡æ¯å¯¹äºIDEã€ä»£ç ç´¢å¼•å·¥å…·ã€æ–‡æ¡£ç”Ÿæˆå·¥å…·ç­‰æ˜¯éå¸¸é‡è¦çš„ã€‚ // // ä¸‹é¢è¯´æ˜ä¸€ä¸‹Locationçš„æ¦‚å¿µå’Œä½œç”¨ï¼Œä»¥ä¸‹é¢è¿™ä¸ªmessageä¸ºä¾‹ï¼š // message Foo { // optional string foo = 1; // } // æˆ‘ä»¬å…ˆåªçœ‹ä¸Šé¢è¿™ä¸ªmessageä¸­çš„å­—æ®µå®šä¹‰ï¼š // optional string foo = 1; // ^ ^^ ^^ ^ ^^^ // a bc de f ghi // æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™å‡ ä¸ªLocationï¼š // span path represents // [a,i) [ 4, 0, 2, 0 ] The whole field definition. // [a,b) [ 4, 0, 2, 0, 4 ] The label (optional). // [c,d) [ 4, 0, 2, 0, 5 ] The type (string). // [e,f) [ 4, 0, 2, 0, 1 ] The name (foo). // [g,h) [ 4, 0, 2, 0, 3 ] The number (1). // // æ¯ä¸ªprotoæ–‡ä»¶è§£æä¹‹åç”¨ä¸€ä¸ªFileDescriptorProtoæ¥è¡¨ç¤ºï¼Œæ‰€ä»¥Lcoationè·¯å¾„ä½ // ç½®ä»FileDescriptorProtoå¼€å§‹ã€‚ // - å› ä¸ºmessage Fooæ˜¯ä¸€ä¸ªmessageï¼Œprotoä¸­æ‰€æœ‰é¡¶å±‚messageç±»å‹å®šä¹‰éƒ½åœ¨ // FileDescriptorProtoä¸­message_typeå­—æ®µå­˜å‚¨ï¼Œè¿™ä¸ªå­—æ®µçš„tagæ˜¯4ï¼Œæ‰€ä»¥Locationä¸º[4]ï¼› // - åˆå› ä¸ºmessage_typeæ˜¯repeated DescriptorProtoç±»å‹ï¼Œå› ä¸ºå½“å‰protoç¤ºä¾‹ä¸­ // Fooä¸ºç¬¬ä¸€ä¸ªmessageï¼Œæ‰€ä»¥å…¶åœ¨message_typeåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼ä¸º0ï¼Œæ‰€ä»¥Locationä¸º[4,0]ï¼› // - å› ä¸ºæˆ‘ä»¬ç°åœ¨çœ‹çš„â€œæºä»£ç â€æ˜¯â€œoptional string foo = 1;â€ï¼Œæˆ‘ä»¬éœ€è¦å®šä½åˆ° // messageä¸­çš„å­—æ®µä½ç½®ï¼Œmessage Fooä¸­çš„æ‰€æœ‰å­—æ®µéƒ½åœ¨DescriptorProtoä¸­çš„fieldå­— // æ®µä¸­è®°å½•ï¼Œè¿™ä¸ªå­—æ®µçš„tag=2ï¼Œæ‰€ä»¥Locationå˜ä¸º[4,0,2]ï¼› // - åˆå› ä¸ºè¿™ä¸ªDescriptorProtoä¸­çš„fieldä¸ºrepeated FieldDescriptorProto fieldï¼Œ // å› ä¸ºè¿™ä¸ªmessageä¸­åªæœ‰ä¸€ä¸ªå­—æ®µfooï¼Œæ‰€ä»¥fooåœ¨fieldåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼ä¸º0ï¼ŒLocationå˜ä¸º[4,0,2,0]; // ä¸Šé¢è§£é‡Šäº†å®šä½åˆ°å®Œæ•´çš„â€œoptional string foo = 1â€å®šä¹‰è¿™ä¸ªfieldçš„Locationå˜ // åŒ–è¿‡ç¨‹ï¼Œä¸‹é¢å†è¯´ä¸€ä¸‹labelã€typeã€nameã€numberçš„Locationå¦‚ä½•è¿›ä¸€æ­¥ç¡®å®šã€‚ // FieldDescriptorProtoä¸­labelçš„tagä½4ï¼Œtypeçš„tagä¸º5ï¼Œnameçš„tagä¸º1ï¼Œnumberçš„ // tagä¸º3ï¼ŒLocationå¯¹åº”çš„è¿½åŠ ç´¢å¼•4ã€5ã€1ã€3ã€‚gg! // // protoæ–‡ä»¶ä¸­çš„æºä»£ç ä¿¡æ¯å°±æ˜¯ç”±ä¸€ç³»åˆ—çš„Locationæ¥å¯»å€çš„ã€‚ repeated Location location = 1; message Location { // å‰é¢å·²ç»æè¿°äº†Locationçš„ç¡®å®šè¿‡ç¨‹ï¼Œä¸€ä¸ªLocationå¦‚[4,0,2,0]å…¶ä¸­çš„æ•°å­—è¦ä¹ˆ // æ˜¯å­—æ®µçš„tagç¼–å·è¦ä¹ˆæ˜¯repeatedåˆ—è¡¨ä¸­çš„ç´¢å¼•å€¼ï¼Œè¿™é‡Œçš„æ•°å­—æ„æˆçš„æ•°ç»„ä¿å­˜åœ¨ // pathä¸­ã€‚ repeated int32 path = 1 [packed=true]; // è¯¥å­—æ®µspanæ€»æ˜¯åŒ…æ‹¬3ä¸ªæˆ–è€…4ä¸ªå…ƒç´ ï¼Œä¾æ¬¡è¡¨ç¤ºstartlineã€startcolumnã€endlineã€endcolumn repeated int32 span = 2 [packed=true]; // å¦‚æœè¿™ä¸ªSourceCodeInfoä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„å£°æ˜çš„è¯ï¼Œå¯èƒ½åœ¨è¿™ä¸ªå£°æ˜çš„å‰é¢æˆ–è€… // åé¢å¯èƒ½æœ‰ä¸€äº›attachedçš„æ³¨é‡Šã€‚ // // è¿ç»­çš„å¤šä¸ªè¡Œæ³¨é‡Šçœ‹åšæ˜¯ä¸€ä¸ªå•ç‹¬çš„æ³¨é‡Šã€‚ // // è¿™ä¸ªå­—æ®µåªè®°å½•äº†æ³¨é‡Šå†…å®¹ï¼Œä¸åŒ…æ‹¬æ³¨é‡Šå†…å®¹å¼€å¤´çš„æ³¨é‡Šç¬¦å·//ã€‚å¯¹äºå—æ³¨é‡Šï¼Œ // æ³¨é‡Šå‰é¢çš„ç©ºç™½å­—ç¬¦ã€*è¿™å‡ ç§ç¬¦å·ä¹Ÿä¼šè¢«æ¸…ç†æ‰ã€‚ä½†æ˜¯ä¼šåŒ…æ‹¬æ¢è¡Œç¬¦ã€‚ // // Examples: // // optional int32 foo = 1; // Comment attached to foo. // // Comment attached to bar. // optional int32 bar = 2; // // optional string baz = 3; // // Comment attached to baz. // // Another line attached to baz. // // // Comment attached to qux. // // // // Another line attached to qux. // optional double qux = 4; // // optional string corge = 5; // /* Block comment attached // * to corge. Leading asterisks // * will be removed. */ // /* Block comment attached to // * grault. */ // optional int32 grault = 6; // Locationå‰é¢çš„æ³¨é‡Šä¿¡æ¯ optional string leading_comments = 3; // Locationåé¢çš„æ³¨é‡Šä¿¡æ¯ optional string trailing_comments = 4; } }  2.4.2. å¯ä»¥æå–protoæ–‡ä»¶ä¸­çš„å“ªäº›ä¿¡æ¯ \u0026amp; å¦‚ä½•æå– # å‰ä¸€èŠ‚2.4.1ä¸­å¯¹descriptor.protoè¿›è¡Œäº†è¯¦ç»†åœ°æè¿°ï¼Œå¯ä»¥è¯´åœ¨protoæ–‡ä»¶ä¸­å†™çš„æ¯ä¸€è¡Œå†…å®¹éƒ½å¯ä»¥é€šè¿‡è§£æFileDescriptorProtoæ¥è®¿é—®åˆ°ã€‚protoæ–‡ä»¶åªæ˜¯ä¸€ç§è‡ªæè¿°çš„æ¶ˆæ¯æ ¼å¼ï¼ŒåŸºäºè¿™ç§æ ¼å¼ç”Ÿæˆé¢å‘ç‰¹å®šç¼–ç¨‹è¯­è¨€çš„æºä»£ç æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬æƒ³è·å–çš„ä¿¡æ¯ä¸å¤–ä¹å¦‚ä¸‹å‡ ä¸ªï¼š\n å¾…ç”Ÿæˆçš„æºæ–‡ä»¶çš„åŒ…åï¼› å¾…ç”Ÿæˆçš„æºæ–‡ä»¶çš„wrapper classç±»åï¼› protoæ–‡ä»¶ä¸­å®šä¹‰çš„å„ä¸ªç±»å‹ï¼ŒåŒ…æ‹¬æšä¸¾enumã€æ¶ˆæ¯messageã€æœåŠ¡serviceï¼› å¯¹äºæšä¸¾enuméœ€è¦çŸ¥é“æšä¸¾ç±»å‹åã€åˆ—å‡ºçš„æšä¸¾å€¼ï¼ˆåŒ…æ‹¬å­—æ®µã€å€¼ã€æ³¨é‡Šä¿¡æ¯ï¼‰ã€æ³¨é‡Šä¿¡æ¯ï¼› å¯¹äºæ¶ˆæ¯messageéœ€è¦çŸ¥é“ç±»å‹åã€ç±»æˆå‘˜ï¼ˆåŒ…æ‹¬æˆå‘˜ç±»å‹ã€æˆå‘˜åç§°ã€å®šä¹‰é¡ºåºã€é»˜è®¤å€¼ã€æ³¨é‡Šä¿¡æ¯ï¼‰ã€æ³¨é‡Šä¿¡æ¯ï¼› å¯¹äºæœåŠ¡serviceéœ€è¦çŸ¥é“æœåŠ¡åç§°ã€æœåŠ¡rpcæ¥å£ï¼ˆrpcæ¥å£çš„è¯·æ±‚å‚æ•°ã€è¿”å›å€¼ç±»å‹ã€æ³¨é‡Šä¿¡æ¯ï¼‰ã€æ³¨é‡Šä¿¡æ¯ï¼› protoä¸­å¯ä»¥æ·»åŠ æ³¨è§£å—ï¼Ÿæ³¨è§£å¯ä»¥æå–å‡ºæ¥å—ï¼Ÿ  å¦‚ä½•æå–ä¸Šè¿°ä¿¡æ¯å‘¢ï¼Ÿå¯ä»¥è‚¯å®šåœ°æ˜¯ï¼Œåªè¦èƒ½æ‹¿åˆ°å½“å‰protoæ–‡ä»¶å¯¹åº”çš„FileDescriptorProtoï¼Œä¸Šè¿°å†…å®¹å‡ ä¹éƒ½å¯ä»¥è·å–åˆ°ã€‚ä½†æ˜¯å¦‚ä½•è·å–åˆ°å¯¹åº”çš„protoæ–‡ä»¶å¯¹åº”çš„è¿™ä¸ªFileDescriptorProtoå¯¹è±¡å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªprotocæ’ä»¶çš„ç¤ºä¾‹ä»£ç å§ï¼Œçœ‹å®Œä¹‹åï¼Œå¤§å®¶ä¹Ÿå°±äº†è§£äº†å¦‚ä½•è·å–protoå¯¹åº”çš„FileDescriptorProtoä»¥åŠå¦‚ä½•ä»ä¸­æå–æƒ³è¦çš„1~7ä¸Šè¿°ä¿¡æ¯ï¼Œç”Ÿæˆæºä»£ç æ–‡ä»¶ä¹Ÿå°±ç®€å•äº†ã€‚\n2.4.3. protoc goè¯­è¨€æ’ä»¶protoc-gen-go # protoc-gen-goçš„æºä»£ç å¯ä»¥é€šè¿‡é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–ï¼š\ngit co https://github.com/golang/protobuf git branch -b ${new-branch}  2.4.3.1. protoc-gen-goå…¥å£å‡½æ•°åˆ†æ # file: protobuf/protoc-gen-go/main.go\npackage main import ( \u0026quot;io/ioutil\u0026quot; \u0026quot;os\u0026quot; \u0026quot;github.com/c4pt0r/proto\u0026quot; \u0026quot;github.com/c4pt0r/protoc-gen-go/generator\u0026quot; ) func main() { // é¦–å…ˆåˆ›å»ºä¸€ä¸ªä»£ç ç”Ÿæˆå™¨generatorï¼ŒCodeGeneratorRequestã€CodeGeneratorResponse // ç»“æ„ä½“éƒ½è¢«ä¿å­˜åœ¨generatorä¸­ï¼ŒCodeGenerateResponseä¸­ä¿å­˜ç€ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­ // çš„é”™è¯¯çŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç»“æ„ä½“æå–é”™è¯¯çŠ¶æ€å¹¶è¿›è¡Œé”™è¯¯å¤„ç† g := generator.New() // ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–CodeGeneratorRequestä¿¡æ¯ï¼ˆæ ‡å‡†è¾“å…¥å·²ç»è¢«é‡å®šå‘åˆ°äº†çˆ¶è¿›ç¨‹ // protocè¿›ç¨‹åˆ›å»ºçš„ç®¡é“stdout_pipeçš„è¯»ç«¯ï¼Œçˆ¶è¿›ç¨‹ä¼šä»ç®¡é“çš„å†™ç«¯å†™å…¥è¯¥è¯·æ±‚ä¿¡æ¯ï¼‰ data, err := ioutil.ReadAll(os.Stdin) if err != nil { g.Error(err, \u0026quot;reading input\u0026quot;) } // è¯»å–åˆ°çš„æ•°æ®æ—¶ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGeneratorRequestï¼Œå°†å…¶åä¸²è¡ŒåŒ–æˆCodeGeneratorRequest if err := proto.Unmarshal(data, g.Request); err != nil { g.Error(err, \u0026quot;parsing input proto\u0026quot;) } // æ£€æŸ¥CodeGeneratorRequestä¸­å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶æ•°é‡ï¼Œæ•°é‡ä¸º0åˆ™æ— éœ€ç”Ÿæˆ if len(g.Request.FileToGenerate) == 0 { g.Fail(\u0026quot;no files to generate\u0026quot;) } // å°†CodeGeneratorRequestä¸­ä¼ é€’ç»™ä»£ç ç”Ÿæˆå™¨çš„å‚æ•°è®¾ç½®åˆ°protocæ’ä»¶çš„ä»£ç ç”Ÿæˆå™¨ä¸­ g.CommandLineParameters(g.Request.GetParameter()) // å‰é¢çš„proto.Unmarshal(...)æ“ä½œå°†stdinä¸­çš„è¯·æ±‚åä¸²è¡ŒåŒ–æˆäº†CodeGeneratorRequestï¼Œ // è¿™é‡Œçš„g.WrapTypes()å°†è¯·æ±‚ä¸­çš„ä¸€äº›descriptorsè¿›è¡Œè¿›ä¸€æ­¥å°è£…ï¼Œæ–¹ä¾¿åé¢å¼•ç”¨ g.WrapTypes() g.SetPackageNames() g.BuildTypeNameMap() // ç”Ÿæˆæ‰€æœ‰çš„æºä»£ç æ–‡ä»¶ g.GenerateAllFiles() // å°†CodeGeneratorResponseå¯¹è±¡è¿›è¡Œä¸²è¡ŒåŒ–å¤„ç† data, err = proto.Marshal(g.Response) if err != nil { g.Error(err, \u0026quot;failed to marshal output proto\u0026quot;) } // å°†ä¸²è¡ŒåŒ–ä¹‹åçš„CodeGenerateResponseå¯¹è±¡æ•°æ®å†™å…¥æ ‡å‡†è¾“å‡ºï¼ˆæ ‡å‡†è¾“å‡ºå·²ç»è¢« // é‡å®šå‘åˆ°äº†çˆ¶è¿›ç¨‹protocè¿›ç¨‹åˆ›å»ºçš„ç®¡é“stdin_pipeçš„å†™ç«¯ï¼Œçˆ¶è¿›ç¨‹ä»ç®¡é“çš„è¯» // ç«¯è¯»å–è¿™é‡Œçš„å“åº”ï¼‰ _, err = os.Stdout.Write(data) if err != nil { g.Error(err, \u0026quot;failed to write output proto\u0026quot;) } }  2.4.3.2. å›é¡¾ä¸€ä¸‹CodeGeneratorRequest \u0026amp; CodeGeneratorResponseçš„å®šä¹‰ # ä¸‹é¢çœ‹ä¸‹CodeGeneratorRequestå’ŒCodeGeneratorResponseçš„å®šä¹‰ã€‚\nfile: ${protobuf}/src/google/protobuf/compiler/plugin.go\n// ä¸²è¡ŒåŒ–åçš„CodeGeneratorRequestä¿¡æ¯ä¼šè¢«å†™å…¥åˆ°æ’ä»¶ç¨‹åºçš„stdin message CodeGeneratorRequest { // protocå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­åˆ—å‡ºäº†éœ€è¦è¿›è¡Œå¤„ç†çš„.protoæ–‡ä»¶çš„åç§°ï¼Œä»£ // ç ç”Ÿæˆå™¨åº”è¯¥åªä¸ºè¿™äº›.protoæ–‡ä»¶ç”Ÿæˆæºä»£ç æ–‡ä»¶ã€‚æ¯ä¸€ä¸ª.protoæ–‡ä»¶æˆåŠŸè§£æä¹‹ // åä¼šç”Ÿæˆä¸€ä¸ªFileDescriptorProtoå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«åŠ å…¥åˆ°å­—æ®µproto_fileä¸­ repeated string file_to_generate = 1; // protocå‘½ä»¤è¡Œç¨‹åºä¸­ä¼ é€’ç»™æ’ä»¶ç¨‹åºä»£ç ç”Ÿæˆå™¨çš„å‚æ•°ä¿¡æ¯ optional string parameter = 2; // protocå‘½ä»¤è¡Œä¸­åˆ—å‡ºçš„æ‰€æœ‰çš„.protoæ–‡ä»¶è¢«æ·»åŠ åˆ°äº†å­—æ®µfile_to_generateä¸­ï¼Œè¿™ // äº›.protoæ–‡ä»¶ä¸­é€šè¿‡importå¼•å…¥è¿›æ¥çš„æ–‡ä»¶ï¼Œè¿™ä¸¤éƒ¨åˆ†æ–‡ä»¶è§£ææˆåŠŸåå¯¹åº”çš„ // FileDescriptorProtoå¯¹è±¡éƒ½ä¼šè¢«åŠ å…¥åˆ°è¿™é‡Œçš„proto_fileä¸­ï¼Œæ·»åŠ åçš„é¡ºåºæ˜¯æŒ‰ç…§ // æ‹“æ‰‘é¡ºåºæ’åºçš„ï¼Œæ€ä¹ˆè®²ï¼Ÿå°±æ˜¯è¢«importçš„protoæ–‡ä»¶ä¼šå‡ºç°åœ¨importå®ƒä»¬çš„ proto // æ–‡ä»¶å‰é¢ã€‚ repeated FileDescriptorProto proto_file = 15; } // ä¸²è¡ŒåŒ–åçš„CodeGeneratorResponseä¿¡æ¯ä¼šè¢«å†™å…¥åˆ°æ’ä»¶çš„stdout message CodeGeneratorResponse { // å¦‚æœé”™è¯¯ä¿¡æ¯éç©ºï¼Œè¡¨ç¤ºä»£ç ç”Ÿæˆå¤±è´¥ã€‚è¿™ç§æƒ…å†µä¸‹å°½ç®¡ä»£ç ç”Ÿæˆå¤±è´¥ï¼Œæ’ä»¶è¿›ç¨‹ // ä»ç„¶åº”è¯¥è¿”å›ä¸€ä¸ªçŠ¶æ€0ã€‚ // // è¿™ä¸ªå­—æ®µç”¨äºæŒ‡ç¤º.protoæ–‡ä»¶é”™è¯¯ï¼Œ.protoæ–‡ä»¶ä¸­çš„é”™è¯¯å°†ä½¿å¾—ä»£ç ç”Ÿæˆå™¨æ— æ³•ç”Ÿ // æˆæ­£ç¡®çš„ä»£ç ã€‚æŒ‡ç¤ºprotocæœ¬èº«çš„é”™è¯¯ï¼Œä¾‹å¦‚CodeGeneratorRequestæ•°æ®æ— æ³•è¢«æ­£ // ç¡®åœ°åä¸²è¡ŒåŒ–ï¼Œè¿™ç§æƒ…å†µåº”è¯¥è¢«æŠ¥å‘Šï¼Œé”™è¯¯ä¿¡æ¯åº”è¯¥å†™åˆ°stderrå¹¶ä¸”æ’ä»¶è¿›ç¨‹åº”è¯¥ // è¿”å›ä¸€ä¸ªé0çŠ¶æ€ç  optional string error = 1; // æè¿°ä¸€ä¸ªå¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶ message File { // å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶ç›¸å¯¹äºè¾“å‡ºç›®å½•çš„æ–‡ä»¶å optional string name = 1; // å†™å…¥åˆ°æºä»£ç æ–‡ä»¶ä¸­çš„æ’å…¥ç‚¹ä¿¡æ¯ï¼Œæ–¹ä¾¿åé¢çš„æ’ä»¶åœ¨æ’å…¥ç‚¹å¤„è¿›è¡Œæ‰©å±•å…¶ä»–å†…å®¹ optional string insertion_point = 2; // å†™å…¥åˆ°æ–‡ä»¶æˆ–è€…æ–‡ä»¶æ’å…¥ç‚¹ä½ç½®çš„å†…å®¹ optional string content = 15; } // æ‰€æœ‰çš„å¾…ç”Ÿæˆçš„æºä»£ç æ–‡ä»¶åˆ—è¡¨ repeated File file = 15; }  2.4.3.3. generatorå®ç°åˆ†æ # main.goä¸­è°ƒç”¨äº†generatorçš„å‡ ä¸ªå…³é”®æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™å‡ ä¸ªæ–¹æ³•éƒ½åšäº†äº›ä»€ä¹ˆï¼Œç„¶ åå†è·Ÿè¿›ä¸€æ­¥çœ‹çœ‹generatorçš„è¯¦ç»†å®ç°è¿‡ç¨‹ã€‚\n2.4.3.3.1. generator.New() # file: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// Generatorç±»å‹çš„æ–¹æ³•èƒ½å¤Ÿè¾“å‡ºæºä»£ç ï¼Œè¿™äº›è¾“å‡ºçš„æºä»£ç ä¿¡æ¯å­˜å‚¨åœ¨Responseæˆå‘˜ä¸­ type Generator struct { *bytes.Buffer Request *plugin.CodeGeneratorRequest // The input. Response *plugin.CodeGeneratorResponse // The output. Param map[string]string // Command-line parameters. PackageImportPath string // Go import path of the package we're generating code for ImportPrefix string // String to prefix to imported package file names. ImportMap map[string]string // Mapping from .proto file name to import path Pkg map[string]string // The names under which we import support packages packageName string // What we're calling ourselves. allFiles []*FileDescriptor // All files in the tree allFilesByName map[string]*FileDescriptor // All files by filename. genFiles []*FileDescriptor // Those files we will generate output for. file *FileDescriptor // The file we are compiling now. usedPackages map[string]bool // Names of packages used in current file. typeNameToObject map[string]Object // Key is a fully-qualified name in input syntax. init []string // Lines to emit in the init function. indent string writeOutput bool } // åˆ›å»ºä¸€ä¸ªæ–°çš„ä»£ç ç”Ÿæˆå™¨ï¼Œå¹¶åˆ›å»ºè¯·æ±‚ã€å“åº”å¯¹è±¡ func New() *Generator { g := new(Generator) g.Buffer = new(bytes.Buffer) g.Request = new(plugin.CodeGeneratorRequest) g.Response = new(plugin.CodeGeneratorResponse) return g }  2.4.3.3.2. generator.CommandLineParameters(\u0026hellip;) # è¿™ä¸ªå‡½æ•°æ˜¯è´Ÿè´£è§£æprotocä¼ é€’è¿‡æ¥çš„å‘½ä»¤è¡Œå‚æ•°ä¿¡æ¯çš„ã€‚\nfile: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// å°†éƒ½å¥½åˆ†éš”çš„key=valueåˆ—è¡¨è§£ææˆ\u0026lt;key,value\u0026gt; map func (g *Generator) CommandLineParameters(parameter string) { g.Param = make(map[string]string) for _, p := range strings.Split(parameter, \u0026quot;,\u0026quot;) { if i := strings.Index(p, \u0026quot;=\u0026quot;); i \u0026lt; 0 { g.Param[p] = \u0026quot;\u0026quot; } else { g.Param[p[0:i]] = p[i+1:] } } g.ImportMap = make(map[string]string) pluginList := \u0026quot;none\u0026quot; // Default list of plugin names to enable (empty means all). for k, v := range g.Param { switch k { case \u0026quot;import_prefix\u0026quot;: g.ImportPrefix = v case \u0026quot;import_path\u0026quot;: g.PackageImportPath = v // --go_out=plugins=grpc:.ï¼Œè§£æè¿™é‡Œçš„å‚æ•°plugins=grpc case \u0026quot;plugins\u0026quot;: pluginList = v default: if len(k) \u0026gt; 0 \u0026amp;\u0026amp; k[0] == 'M' { g.ImportMap[k[1:]] = v } } } // åœ¨protoc-gen-goçš„æŸä¸ªåœ°æ–¹å·²ç»å°†grpcæ’ä»¶æ³¨å†Œåˆ°äº†å½“å‰generatorï¼ˆä¹Ÿå°±æ˜¯æ·» // åŠ åˆ°plugins []Pluginä¸­ï¼‰ï¼Œä½†æ˜¯åˆ°åº•æ˜¯åœ¨å“ªé‡Œæ³¨å†Œçš„å‘¢ï¼Ÿåªæœ‰æ³¨å†Œå¹¶æ¿€æ´»ï¼ˆå‚ // æ•°ä¸­é€šè¿‡--go_out=plugins=grpc:.)grpcå­æ’ä»¶ï¼Œè¯¥å­æ’ä»¶æ‰èƒ½è¢«ä½¿ç”¨äºåç»­çš„ // ä»£ç ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼ˆç”Ÿæˆrpcç›¸å…³çš„goæºä»£ç ï¼‰ã€‚ // // å…¶å®è¿™é‡Œçš„grpcå­æ’ä»¶æ³¨å†Œæ˜¯åˆ©ç”¨äº†link_grpc.goé‡Œé¢çš„import _æ“ä½œæ¥éšå¼åœ° // è°ƒç”¨äº†grpc.init()æ–¹æ³•ï¼Œè¯¥åˆå§‹åŒ–æ–¹æ³•ä¸­è´Ÿè´£å®Œæˆå‘generatorçš„æ³¨å†Œæ“ä½œï¼Œå³ // generator.RegisterPlugin(new(grpc))ï¼Œè¿™é‡Œçš„RegisterPluginå…¶å®å°±æ˜¯å°†æŒ‡å®š // çš„å­æ’ä»¶åŠ å…¥åˆ°plugins []Plugin sliceä¸­ã€‚ // ä¸ºäº†èƒ½å¤Ÿåœ¨protoc-gen-goä¸­æ­£ç¡®åœ°å°†grpc linkè¿›å»ï¼Œåœ¨æ„å»ºprotoc-gen-goçš„æ—¶ // å€™éœ€è¦æ‰§è¡Œå‘½ä»¤ï¼š // cd protoc-gen-go \u0026amp; go build main.go link_grpc.go // go buildçš„æ—¶å€™å¦‚æœæ²¡æœ‰åˆ—å‡ºlink_grpc.goï¼Œé‚£ä¹ˆgrpcæ˜¯ä¸ä¼šè¢«linkè¿› // protoc-gen-goè¿™ä¸ªæ’ä»¶çš„ï¼Œè¿™æ ·å¤„ç†.protoæ–‡ä»¶ä¸­çš„serviceæ—¶æ’ä»¶æ˜¯ä¸ä¼šç”Ÿæˆ // serviceç›¸å…³çš„goæºä»£ç çš„ã€‚ // æ ¹æ®--go_out=plugins=?+?+?:.ï¼Œæ›´æ–°æ¿€æ´»çš„æ’ä»¶åˆ—è¡¨ if pluginList != \u0026quot;\u0026quot; { // Amend the set of plugins. enabled := make(map[string]bool) for _, name := range strings.Split(pluginList, \u0026quot;+\u0026quot;) { enabled[name] = true } var nplugins []Plugin for _, p := range plugins { if enabled[p.Name()] { nplugins = append(nplugins, p) } } plugins = nplugins } }  2.4.3.3.3. generator.WrapTypes() # file: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// WrapTypes walks the incoming data, wrapping DescriptorProtos, EnumDescriptorProtos // and FileDescriptorProtos into file-referenced objects within the Generator. // It also creates the list of files to generate and so should be called before GenerateAllFiles. func (g *Generator) WrapTypes() { g.allFiles = make([]*FileDescriptor, 0, len(g.Request.ProtoFile)) g.allFilesByName = make(map[string]*FileDescriptor, len(g.allFiles)) for _, f := range g.Request.ProtoFile { // We must wrap the descriptors before we wrap the enums descs := wrapDescriptors(f) g.buildNestedDescriptors(descs) enums := wrapEnumDescriptors(f, descs) g.buildNestedEnums(descs, enums) exts := wrapExtensions(f) fd := \u0026amp;FileDescriptor{ FileDescriptorProto: f, desc: descs, enum: enums, ext: exts, exported: make(map[Object][]symbol), proto3: fileIsProto3(f), } extractComments(fd) g.allFiles = append(g.allFiles, fd) g.allFilesByName[f.GetName()] = fd } for _, fd := range g.allFiles { fd.imp = wrapImported(fd.FileDescriptorProto, g) } g.genFiles = make([]*FileDescriptor, 0, len(g.Request.FileToGenerate)) for _, fileName := range g.Request.FileToGenerate { fd := g.allFilesByName[fileName] if fd == nil { g.Fail(\u0026quot;could not find file named\u0026quot;, fileName) } fd.index = len(g.genFiles) g.genFiles = append(g.genFiles, fd) } }  2.4.3.3.4. generator.GenerateAllFiles() # è°ƒç”¨generatoré’ˆå¯¹æ‰€æœ‰è§£ææˆåŠŸçš„protoæ–‡ä»¶ç”Ÿæˆæ‰€æœ‰çš„goæºä»£ç \nfile: ${golang-protobuf}/protoc-gen-go/generator/generator.go\n// ç”Ÿæˆæ‰€æœ‰.protoæ–‡ä»¶å¯¹åº”çš„goæºä»£ç ï¼Œè¿™é‡Œåªæ˜¯å°†æºä»£ç å†…å®¹å­˜å‚¨åˆ°g.Responseä¸­ï¼Œ // å¹¶æ²¡æœ‰ç›´æ¥åˆ›å»ºæºä»£ç æ–‡ä»¶ï¼Œæ’ä»¶å°†Responseä¼ é€’ç»™protocè¿›ç¨‹åç”±protocè¿›ç¨‹æ¥è´Ÿ // è´£åˆ›å»ºæºä»£ç æ–‡ä»¶ func (g *Generator) GenerateAllFiles() { // Initialize the plugins for _, p := range plugins { p.Init(g) } // Generate the output. The generator runs for every file, even the files // that we don't generate output for, so that we can collate the full list // of exported symbols to support public imports. genFileMap := make(map[*FileDescriptor]bool, len(g.genFiles)) for _, file := range g.genFiles { genFileMap[file] = true } for _, file := range g.allFiles { g.Reset() g.writeOutput = genFileMap[file] // è°ƒç”¨generatorçš„generate(...)æ–¹æ³•æ¥ç”Ÿæˆè¯¥protoæ–‡ä»¶çš„ // FileDescriptorProtoæè¿°å¯¹åº”çš„goæºä»£ç  g.generate(file) if !g.writeOutput { continue } g.Response.File = append(g.Response.File, \u0026amp;plugin.CodeGeneratorResponse_File{ Name: proto.String(file.goFileName()), Content: proto.String(g.String()), }) } }  å†çœ‹ä¸‹generator.generate(\u0026hellip;)æ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚\n// é’ˆå¯¹.protoæ–‡ä»¶ï¼ˆç”±FileDescriptorè¡¨ç¤ºï¼‰ç”Ÿæˆå¯¹åº”çš„goæºä»£ç  func (g *Generator) generate(file *FileDescriptor) { g.file = g.FileOf(file.FileDescriptorProto) g.usedPackages = make(map[string]bool) // è¦ç”Ÿæˆæºä»£ç çš„é¦–ä¸ªprotoæ–‡ä»¶å¯¹åº”çš„goæºä»£ç ï¼Œè¿™éƒ¨åˆ†ä»£ç é¡¶éƒ¨æ’å…¥ç‰ˆæƒä¿¡æ¯ if g.file.index == 0 { // For one file in the package, assert version compatibility. g.P(\u0026quot;// This is a compile-time assertion to ensure that this generated file\u0026quot;) g.P(\u0026quot;// is compatible with the proto package it is being compiled against.\u0026quot;) g.P(\u0026quot;// A compilation error at this line likely means your copy of the\u0026quot;) g.P(\u0026quot;// proto package needs to be updated.\u0026quot;) g.P(\u0026quot;const _ = \u0026quot;, g.Pkg[\u0026quot;proto\u0026quot;], \u0026quot;.ProtoPackageIsVersion\u0026quot;, generatedCodeVersion, \u0026quot; // please upgrade the proto package\u0026quot;) g.P() } // ç”Ÿæˆimportè¯­å¥ for _, td := range g.file.imp { g.generateImported(td) } // ç”Ÿæˆenumç±»å‹å®šä¹‰è¯­å¥ for _, enum := range g.file.enum { g.generateEnum(enum) } // ç”Ÿæˆmessageç±»å‹å®šä¹‰è¯­å¥ for _, desc := range g.file.desc { // Don't generate virtual messages for maps. if desc.GetOptions().GetMapEntry() { continue } g.generateMessage(desc) } // ç”Ÿæˆextensionç±»å‹å®šä¹‰è¯­å¥ for _, ext := range g.file.ext { g.generateExtension(ext) } // ç”Ÿæˆåˆå§‹åŒ–å‡½æ•°è¯­å¥ g.generateInitFunction() // å‰é¢ç”Ÿæˆenumã€messageã€extensionç­‰çš„æ–¹å¼éƒ½åŸºæœ¬ç±»ä¼¼ï¼Œåé¢æˆ‘ä»¬åªç»™å‡ºä¸€ä¸ª // ç”Ÿæˆæšä¸¾ç±»å‹æ–¹æ³•çš„è¯´æ˜ï¼Œç”Ÿæˆmessageã€extensionçš„å®ç°æ–¹æ³•å¯ä»¥æ‰§è¡ŒæŸ¥çœ‹ // generator.goä¸­çš„å®ç°ã€‚ // // éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‰é¢çš„å„ä¸ªç”Ÿæˆæºä»£ç çš„æ–¹æ³•ä¸èƒ½å¤„ç†serviceæœåŠ¡å®šä¹‰çš„rpcæ¥ // å£ä»£ç ï¼Œè¿™éƒ¨åˆ†rpcä»£ç çš„ç”Ÿæˆéœ€è¦å€ŸåŠ©äºgrpcå­æ’ä»¶æ¥å®Œæˆï¼Œå³ä¸‹é¢çš„g.runPlugins(...) g.runPlugins(file) g.generateFileDescriptor(file) // å¾…è¾“å‡ºçš„æºä»£ç éœ€è¦çŸ¥é“å“ªäº›packageæ˜¯éœ€è¦importçš„ï¼Œå“ªäº›ä¸éœ€è¦ï¼Œå› æ­¤å…ˆè¿è¡Œ // æ’ä»¶ç”Ÿæˆgoä»£ç ä¸­é™¤importä¹‹å¤–çš„å…¶ä»–éƒ¨åˆ†ä»£ç ï¼Œç„¶åçŸ¥é“äº†å“ªäº›packageéœ€è¦ // importï¼Œå†æ’å…¥å…·ä½“çš„importè¯­å¥ã€‚ // // æœ€ååœ¨goæºä»£ç ä¸­æ’å…¥headerã€import rem := g.Buffer g.Buffer = new(bytes.Buffer) g.generateHeader() g.generateImports() if !g.writeOutput { return } g.Write(rem.Bytes()) // é‡æ–°æ ¼å¼åŒ–ç”Ÿæˆçš„goæºä»£ç ï¼ˆgofmtï¼‰ fset := token.NewFileSet() raw := g.Bytes() ast, err := parser.ParseFile(fset, \u0026quot;\u0026quot;, g, parser.ParseComments) if err != nil { // Print out the bad code with line numbers. // This should never happen in practice, but it can while changing generated code, // so consider this a debugging aid. var src bytes.Buffer s := bufio.NewScanner(bytes.NewReader(raw)) for line := 1; s.Scan(); line++ { fmt.Fprintf(\u0026amp;src, \u0026quot;%5d\\t%s\\n\u0026quot;, line, s.Bytes()) } g.Fail(\u0026quot;bad Go source code was generated:\u0026quot;, err.Error(), \u0026quot;\\n\u0026quot;+src.String()) } g.Reset() err = (\u0026amp;printer.Config{Mode: printer.TabIndent | printer.UseSpaces, Tabwidth: 8}).Fprint(g, fset, ast) if err != nil { g.Fail(\u0026quot;generated Go source code could not be reformatted:\u0026quot;, err.Error()) } }  ä¸Šé¢generate.generate(\u0026hellip;)æ–¹æ³•ä¸­generateEnum()ã€generateMessage()æ–¹æ³•ä¸å…¶ä»–å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯éå¸¸ç±»ä¼¼çš„ï¼Œç”±äºå¤§å®¶ä½¿ç”¨protobufè¿‡ç¨‹ä¸­ä½¿ç”¨enumã€messageæ¯”è¾ƒå¤šï¼Œå¹¶ä¸”generateEnum()ã€generateMessage()æ–¹æ³•æ‰§è¡Œé€»è¾‘éå¸¸ç›¸ä¼¼ï¼Œè€ƒè™‘åˆ°ç¯‡å¹…æ–¹é¢generateEnum()æ¯”generateMessage()ç®€çŸ­ï¼Œè¿™é‡Œæˆ‘ä»¬å°±åªä»¥generateEnum()çš„æºä»£ç ä½œä¸ºç¤ºä¾‹è¿›è¡Œåˆ†æã€‚ç›¸ä¿¡å¦‚æœçœ‹æ‡‚äº†generateEnumçš„å®ç°æ€è·¯ï¼ŒgenerateMessageçš„å®ç°æ€è·¯ä¹Ÿå¾ˆå®¹æ˜“ææ˜ç™½ï¼Œè¯»è€…ä¹Ÿå…·å¤‡äº†è‡ªå·±å®ç°å­æ’ä»¶çš„èƒ½åŠ›ã€‚\n// ç”ŸæˆæŒ‡å®šenumç±»å‹çš„goæºä»£ç  func (g *Generator) generateEnum(enum *EnumDescriptor) { // enumç±»å‹çš„å®Œæ•´ç±»å‹å typeName := enum.TypeName() // CamelCasedä¹‹åçš„å®Œæ•´ç±»å‹å ccTypeName := CamelCaseSlice(typeName) ccPrefix := enum.prefix() // æ‰“å°enumç±»å‹å®šä¹‰ä¹‹å‰çš„leading comments // - æå–æºä»£ç ä¿¡æ¯SourceCodeInfoéƒ½æ˜¯é€šè¿‡Location pathæ¥è·å–çš„ï¼› // - æå–æ³¨é‡Šä¿¡æ¯ä¹Ÿä¸ä¾‹å¤–ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šä»‹ç»PrintComments(path)å¦‚ä½•é€šè¿‡ // Location pathæ¥ç”Ÿæˆæ³¨é‡Šä¿¡æ¯ï¼› g.PrintComments(enum.path) // ç”Ÿæˆæšä¸¾ç±»å‹çš„å®šä¹‰èµ·å§‹éƒ¨åˆ†ï¼štype æšä¸¾ç±»å‹å int32 g.P(\u0026quot;type \u0026quot;, ccTypeName, \u0026quot; int32\u0026quot;) g.file.addExport(enum, enumSymbol{ccTypeName, enum.proto3()}) // æšä¸¾ç±»å‹é‡Œé¢çš„å„ä¸ªæšä¸¾å€¼éƒ½ä½œä¸ºconst int32å¸¸é‡æ¥å®šä¹‰ g.P(\u0026quot;const (\u0026quot;) // æšä¸¾å€¼å®šä¹‰ä¹‹å‰ç¼©è¿›ä¸€ä¸‹ g.In() // é’ˆå¯¹æšä¸¾ç±»å‹é‡Œé¢çš„æ‰€æœ‰æšä¸¾å€¼è¿›è¡Œæºä»£ç ç”Ÿæˆ for i, e := range enum.Value { // ç”Ÿæˆæšä¸¾å€¼å‰é¢çš„leading comments g.PrintComments(fmt.Sprintf(\u0026quot;%s,%d,%d\u0026quot;, enum.path, enumValuePath, i)) // ç”Ÿæˆæšä¸¾å€¼çš„name = valueå½¢å¼çš„goæºä»£ç  name := ccPrefix + *e.Name g.P(name, \u0026quot; \u0026quot;, ccTypeName, \u0026quot; = \u0026quot;, e.Number) g.file.addExport(enum, constOrVarSymbol{name, \u0026quot;const\u0026quot;, ccTypeName}) } // æšä¸¾å€¼å®šä¹‰å®Œä¹‹åå–æ¶ˆç¼©è¿› g.Out() // æ‰“å°æœ€åçš„ç»“æŸä¿¡æ¯ g.P(\u0026quot;)\u0026quot;) // ç”Ÿæˆæšä¸¾ç±»å‹ç›¸å…³çš„ä¸¤ä¸ªmap // - å…¶ä¸­ä¸€ä¸ªæ˜¯æšä¸¾å€¼åˆ°æšä¸¾åçš„æ˜ å°„ï¼› // - å¦ä¸€ä¸ªæ˜¯æšä¸¾ååˆ°æšä¸¾å€¼çš„æ˜ å°„ï¼› g.P(\u0026quot;var \u0026quot;, ccTypeName, \u0026quot;_name = map[int32]string{\u0026quot;) g.In() // ç¬¬ä¸€ä¸ªmap generated := make(map[int32]bool) // avoid duplicate values for _, e := range enum.Value { duplicate := \u0026quot;\u0026quot; if _, present := generated[*e.Number]; present { duplicate = \u0026quot;// Duplicate value: \u0026quot; } g.P(duplicate, e.Number, \u0026quot;: \u0026quot;, strconv.Quote(*e.Name), \u0026quot;,\u0026quot;) generated[*e.Number] = true } g.Out() g.P(\u0026quot;}\u0026quot;) // ç¬¬äºŒä¸ªmap g.P(\u0026quot;var \u0026quot;, ccTypeName, \u0026quot;_value = map[string]int32{\u0026quot;) g.In() for _, e := range enum.Value { g.P(strconv.Quote(*e.Name), \u0026quot;: \u0026quot;, e.Number, \u0026quot;,\u0026quot;) } g.Out() g.P(\u0026quot;}\u0026quot;) // å…¶ä»–å¤„ç†åŠ¨ä½œï¼Œä¹Ÿä¼šç”Ÿæˆéƒ¨åˆ†æºä»£ç ï¼Œè¿™é‡Œå¯ä»¥å¿½ç•¥ä¸è®¡äº† // ... }  ä¸‹é¢çœ‹ä¸€ä¸‹PrintCommentså¦‚ä½•é€šè¿‡Location pathæ¥æå–å¹¶æ‰“å°å…³è”çš„æ³¨é‡Šä¿¡æ¯ã€‚\n// æ‰“å°.protoæ–‡ä»¶ä¸­å¯¹è¯¥location pathå…³è”çš„leading commentsæ³¨é‡Šä¿¡æ¯ func (g *Generator) PrintComments(path string) bool { if !g.writeOutput { return false } // åœ¨protocè¿›ç¨‹è§£æ.protoæ–‡ä»¶çš„æ—¶å€™å°±å·²ç»å°†å„ä¸ªç±»å‹ã€å­—æ®µçš„commentsä¿¡æ¯ç»´ // æŠ¤èµ·æ¥äº†ï¼Œkå°±æ˜¯locationçš„pathï¼Œé€šè¿‡pathå°±èƒ½è·å–åˆ°å¯¹åº”çš„locationï¼Œæ¯ä¸ª // locationä¸­ä¿å­˜äº†è¿™ä¸ªä½ç½®çš„æºä»£ç çš„leading commentsã€trailing commentsä¿¡ // æ¯ï¼Œè¿™é‡Œåªæ‰“å°leading comments if loc, ok := g.file.comments[path]; ok { text := strings.TrimSuffix(loc.GetLeadingComments(), \u0026quot;\\n\u0026quot;) for _, line := range strings.Split(text, \u0026quot;\\n\u0026quot;) { g.P(\u0026quot;// \u0026quot;, strings.TrimPrefix(line, \u0026quot; \u0026quot;)) } return true } return false }  çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬å¯¹äºåŸºæœ¬çš„enumã€messageç±»å‹å®šä¹‰ç­‰éƒ½åŸºæœ¬æ¸…æ¥šäº†ï¼Œä¸‹é¢æˆ‘ä»¬éœ€è¦çœ‹ä¸€ä¸‹grpcå­æ’ä»¶æ˜¯å¦‚ä½•ç”ŸæˆserviceæœåŠ¡çš„rpcæ¥å£æºä»£ç çš„ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¾—å†æ¥çœ‹ä¸€ä¸‹g.runPlugins(file)æ˜¯å¦‚ä½•å®ç°çš„ã€‚\n// Run all the plugins associated with the file. func (g *Generator) runPlugins(file *FileDescriptor) { // åœ¨ä¸Šè¿°generatorå¤„ç†çš„åŸºç¡€ä¸Šï¼Œç»§ç»­è¿è¡Œgeneratorä¸­æ³¨å†Œçš„æ’ä»¶ï¼Œä¾æ¬¡è¿è¡Œæ’ä»¶ for _, p := range plugins { p.Generate(file) } }  å› ä¸ºä¸Šè¿°runPlugins(\u0026hellip;)æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œpluginsè¿™ä¸ªsliceå†…åªæœ‰ä¸€ä¸ªæœ‰æ•ˆçš„ã€æ¿€æ´»çš„å­æ’ä»¶grpcï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬æƒ³äº†è§£serviceæœåŠ¡å¯¹åº”çš„rpcæ¥å£çš„å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦å°±åªéœ€è¦äº†è§£grpcè¿™ä¸ªæ’ä»¶çš„Generate(file)æ–¹æ³•å°±å¯ä»¥äº†ã€‚\n// ç”Ÿæˆ.protoæ–‡ä»¶ä¸­serviceå®šä¹‰çš„rpcæ¥å£çš„goæºä»£ç  func (g *grpc) Generate(file *generator.FileDescriptor) { // å¦‚æœæ²¡æœ‰å®šä¹‰serviceæœåŠ¡ç›´æ¥è¿”å› if len(file.FileDescriptorProto.Service) == 0 { return } // ç›¸å…³å˜é‡å®šä¹‰ g.P(\u0026quot;// Reference imports to suppress errors if they are not otherwise used.\u0026quot;) g.P(\u0026quot;var _ \u0026quot;, contextPkg, \u0026quot;.Context\u0026quot;) g.P(\u0026quot;var _ \u0026quot;, grpcPkg, \u0026quot;.ClientConn\u0026quot;) g.P() // æ–­è¨€ï¼Œæ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§ g.P(\u0026quot;// This is a compile-time assertion to ensure that this generated file\u0026quot;) g.P(\u0026quot;// is compatible with the grpc package it is being compiled against.\u0026quot;) g.P(\u0026quot;const _ = \u0026quot;, grpcPkg, \u0026quot;.SupportPackageIsVersion\u0026quot;, generatedCodeVersion) g.P() // é’ˆå¯¹æ‰€æœ‰çš„serviceå®šä¹‰ç”Ÿæˆç›¸å…³çš„serviceçš„goæºä»£ç  for i, service := range file.FileDescriptorProto.Service { g.generateService(file, service, i) } } // grpcä¸­å¯¹generateServiceçš„å®ç°ï¼Œç”Ÿæˆserviceç›¸å…³çš„goæºä»£ç  // @param .protoè§£æåçš„å„ç§DescriptorProtoçš„wrappingç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥æ–¹ä¾¿åœ°è®¿é—®.protoä¸­å®šä¹‰çš„ä¸œè¥¿ // @param .protoä¸­çš„æŸä¸ªserviceè§£æåå¯¹åº”çš„ServiceDescriptorProto // @param .protoä¸­å¯èƒ½å®šä¹‰äº†å¤šä¸ªserviceï¼Œå½“å‰è¿™ä¸ªserviceå¯¹åº”çš„ç´¢å¼•å€¼ func (g *grpc) generateService(file *generator.FileDescriptor, service *pb.ServiceDescriptorProto, index int) { // æ„å»ºå½“å‰serviceå¯¹åº”çš„path! path := fmt.Sprintf(\u0026quot;6,%d\u0026quot;, index) // 6 means service. // è·å–serviceåç§° origServName := service.GetName() fullServName := origServName if pkg := file.GetPackage(); pkg != \u0026quot;\u0026quot; { fullServName = pkg + \u0026quot;.\u0026quot; + fullServName } servName := generator.CamelCase(origServName) // å‡†å¤‡ç”Ÿæˆclientç›¸å…³çš„goæºä»£ç  g.P() g.P(\u0026quot;// Client API for \u0026quot;, servName, \u0026quot; service\u0026quot;) g.P() // æœåŠ¡ç”¨æˆ·ç«¯goæºä»£ç ç”Ÿæˆ // - type æœåŠ¡å+Client interface g.P(\u0026quot;type \u0026quot;, servName, \u0026quot;Client interface {\u0026quot;) // - æœåŠ¡ç”¨æˆ·ç«¯å®šä¹‰çš„å„ä¸ªæ¥å£æ–¹æ³• for i, method := range service.Method { // æ‰“å°æ¥å£çš„leading comments g.gen.PrintComments(fmt.Sprintf(\u0026quot;%s,2,%d\u0026quot;, path, i)) // 2 means method in a service. // ç”Ÿæˆæ¥å£çš„ç­¾å g.P(g.generateClientSignature(servName, method)) } g.P(\u0026quot;}\u0026quot;) g.P() // æœåŠ¡çš„ç”¨æˆ·ç«¯structï¼Œå…¶ä¸­åŒ…æ‹¬äº†ä¸€ä¸ªcc *grpc.ClientConnï¼Œåé¢ä¼šåœ¨è¯¥struct // ä¸Šå®ç°ä¸Šè¿°æœåŠ¡æ¥å£ g.P(\u0026quot;type \u0026quot;, unexport(servName), \u0026quot;Client struct {\u0026quot;) g.P(\u0026quot;cc *\u0026quot;, grpcPkg, \u0026quot;.ClientConn\u0026quot;) g.P(\u0026quot;}\u0026quot;) g.P() // NewClientå·¥å‚ g.P(\u0026quot;func New\u0026quot;, servName, \u0026quot;Client (cc *\u0026quot;, grpcPkg, \u0026quot;.ClientConn) \u0026quot;, servName, \u0026quot;Client {\u0026quot;) g.P(\u0026quot;return \u0026amp;\u0026quot;, unexport(servName), \u0026quot;Client{cc}\u0026quot;) g.P(\u0026quot;}\u0026quot;) g.P() var methodIndex, streamIndex int serviceDescVar := \u0026quot;_\u0026quot; + servName + \u0026quot;_serviceDesc\u0026quot; // æœåŠ¡ç”¨æˆ·ç«¯çš„æ¥å£æ–¹æ³•å®ç° for _, method := range service.Method { var descExpr string if !method.GetServerStreaming() \u0026amp;\u0026amp; !method.GetClientStreaming() { // Unary RPC method descExpr = fmt.Sprintf(\u0026quot;\u0026amp;%s.Methods[%d]\u0026quot;, serviceDescVar, methodIndex) methodIndex++ } else { // Streaming RPC method descExpr = fmt.Sprintf(\u0026quot;\u0026amp;%s.Streams[%d]\u0026quot;, serviceDescVar, streamIndex) streamIndex++ } g.generateClientMethod(servName, fullServName, serviceDescVar, method, descExpr) } g.P(\u0026quot;// Server API for \u0026quot;, servName, \u0026quot; service\u0026quot;) g.P() // æœåŠ¡ç«¯æ¥å£goæºä»£ç ç”Ÿæˆ ... }  çœ‹å®Œä¹‹åæˆ‘ä»¬å·²ç»æ¸…æ¥šäº†generatoråšäº†ä»€ä¹ˆã€grpcå­æ’ä»¶åˆåšäº†ä»€ä¹ˆï¼Œä»¥åŠå„è‡ªçš„ç»†èŠ‚æ˜¯ä»€ä¹ˆæ ·çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°†åœ¨æ­¤å­¦ä¹ ã€ç†è§£çš„åŸºç¡€ä¸Šå¼€å‘ä¸€ä¸ªè‡ªå·±çš„protocæ’ä»¶ã€‚\n"}),a.add({id:366,href:"/tags/aio/",title:"aio",description:"",content:""}),a.add({id:367,href:"/tags/io-multiplex/",title:"io-multiplex",description:"",content:""}),a.add({id:368,href:"/blog/2017-05-02-linux-common-io-model/",title:"Linuxå¸¸è§IOæ¨¡å‹",description:"é«˜æ€§èƒ½æœåŠ¡å™¨å¼€å‘ï¼Œç¦»ä¸å¼€å¯¹ç½‘ç»œIOçš„æ·±åˆ»è®¤è¯†ã€‚æœ¬æ–‡ç»“åˆLinuxå¹³å°ï¼Œè¯¦ç»†æ€»ç»“äº†é˜»å¡IOã€éé˜»å¡IOã€IOå¤šè·¯å¤ç”¨ã€å®æ—¶ä¿¡å·é©±åŠ¨ã€å¼‚æ­¥IOçš„åŸç†ã€ä½¿ç”¨ã€é€‚ç”¨åœºæ™¯ï¼ŒåŠ æ·±äº†å¯¹ç½‘ç»œIOçš„è®¤è¯†ã€‚",content:"ç›®å‰Linuxä¸‹å¯ç”¨çš„IOæ¨¡å‹æœ‰5ç§ï¼Œåˆ†åˆ«ä¸ºé˜»å¡IOã€éé˜»å¡IOã€IOå¤šè·¯å¤ç”¨ã€ä¿¡å·é©±åŠ¨IOã€å¼‚æ­¥IOï¼Œå…¶ä¸­è¾ƒä¸ºæˆç†Ÿä¸”é«˜æ•ˆã€ç¨³å®šçš„æ˜¯IOå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œå› æ­¤å½“å‰ä¼—å¤šç½‘ç»œæœåŠ¡ç¨‹åºå‡ ä¹éƒ½æ˜¯é‡‡ç”¨è¿™ç§IOæ“ä½œç­–ç•¥ã€‚\nå½“ä¸€ä¸ªåº”ç”¨ç¨‹åºè¯»å†™ï¼ˆä»¥è¯»ä¸ºä¾‹ï¼‰æŸç«¯å£æ•°æ®æ—¶ï¼Œé€‰æ‹©ä¸åŒIOæ¨¡å‹çš„åº”ç”¨ç¨‹åºï¼Œå…¶æ‰§è¡Œæµç¨‹ä¹Ÿå°†ä¸åŒã€‚ä¸‹é¢å°†å¯¹é€‰æ‹©è¿™5ç§ä¸åŒIOæ¨¡å‹æ—¶çš„ç¨‹åºçš„æ‰§è¡Œæƒ…å½¢è¿›è¡Œåˆ†æï¼Œä»¥ä¾¿äº†è§£ä½¿ç”¨IOå¤ç”¨æ¨¡å‹çš„è¿è¡Œæƒ…å†µå’Œæ€§èƒ½ä¼˜åŠ¿ã€‚\nä¸€ä¸ªå®Œæ•´ç»å…¸çš„åº”ç”¨ç¨‹åºçš„æ•°æ®è¯»å–æ“ä½œå¯ä»¥çœ‹åšä¸¤æ­¥ï¼š\n ç­‰å¾…æ•°æ®å‡†å¤‡å¥½ï¼› å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼›  1. é˜»å¡IOæ¨¡å‹ # æœ€æµè¡Œçš„IOæ¨¡å‹æ˜¯é˜»å¡IOï¼ˆBlocking IOï¼‰æ¨¡å‹ï¼Œå‡ ä¹æ‰€æœ‰åˆšå¼€å§‹å­¦ä¹ IOæ“ä½œçš„äººå‘˜éƒ½æ˜¯ä½¿ç”¨è¿™ä¸ªæ¨¡å‹ï¼Œè™½ç„¶å®ƒå­˜åœ¨ä¸€å®šçš„æ€§èƒ½ç¼ºé™·ï¼Œä½†æ˜¯å®ƒçš„ç¡®å¾ˆç®€å•ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯åˆ©ç”¨è¯¥æ¨¡å‹è¯»å–IOç«¯å£æ•°æ®çš„å…¸å‹æµç¨‹ã€‚åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå½“ç³»ç»Ÿè°ƒç”¨å‘ç°ç”¨æˆ·è¯·æ±‚çš„IOæ“ä½œä¸èƒ½ç«‹åˆ»å®Œæˆæ—¶ï¼ˆæ¯”å¦‚å¯¹IOå†™æ“ä½œï¼Œç¼“å†²åŒºæ²¡æœ‰ç©ºé—²ç©ºé—´æˆ–è€…ç©ºé—²ç©ºé—´å°‘äºå¾…å†™çš„æ•°æ®é‡ï¼›è€Œå¯¹äºè¯»æ“ä½œï¼Œç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®å¯è¯»æˆ–è€…å¯è¯»æ•°æ®å°‘äºç”¨æˆ·è¯·æ±‚çš„æ•°æ®é‡ï¼‰ï¼Œåˆ™å½“å‰çš„è¿›ç¨‹ä¼šè¿›å…¥ç¡çœ ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹è¢«IOè¯»å†™é˜»å¡ã€‚ä½†æ˜¯å½“æ•°æ®å¯ä»¥å†™å‡ºæˆ–è€…æœ‰æ•°æ®å¯ä¾›è¯»å…¥æ—¶ï¼ˆå…¶ä»–è¿›ç¨‹æˆ–çº¿ç¨‹ä»ç¼“å†²åŒºä¸­è¯»èµ°äº†æ•°æ®åæˆ–è€…å‘ç¼“å†²åŒºå†™å…¥äº†æ•°æ®ï¼‰ï¼Œç³»ç»Ÿå°†ä¼šäº§ç”Ÿä¸­æ–­ï¼Œå”¤é†’åœ¨ç¼“å†²åŒºä¸Šç­‰å¾…ç›¸åº”äº‹ä»¶çš„è¿›ç¨‹ç»§ç»­æ‰§è¡Œã€‚\n å¤‡æ³¨ï¼š\næœ‰å¿…è¦åœ¨è¿™é‡Œè¿›ä¸€æ­¥è§£é‡Šä¸€ä¸‹â€œé˜»å¡IOâ€çš„å«ä¹‰ã€‚é€šè¿‡é˜»å¡IOç³»ç»Ÿè°ƒç”¨è¿›è¡ŒIOæ“ä½œæ—¶ï¼Œä»¥readä¸ºä¾‹ï¼Œåœ¨å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¨‹åºå®Œæˆä¹‹å‰ï¼ŒLinuxå†…æ ¸ä¼šå¯¹å½“å‰readè¯·æ±‚æ“ä½œçš„ç¼“å†²åŒºï¼ˆå†…å­˜ä¸­çš„ç‰¹æ®ŠåŒºåŸŸï¼‰è¿›è¡ŒåŠ é”ï¼Œå¹¶ä¸”ä¼šå°†è°ƒç”¨readçš„è¿›ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸º â€œuninterruptible waitâ€çŠ¶æ€ï¼ˆä¸å¯ä¸­æ–­ç­‰å¾…çŠ¶æ€ï¼‰ï¼Œå¤„äºè¯¥çŠ¶æ€çš„è¿›ç¨‹å°†æ— æ³•å‚ä¸è¿›ç¨‹è°ƒåº¦ã€‚èƒ½å¤Ÿå‚ä¸è¿›ç¨‹è°ƒåº¦çš„è¿›ç¨‹çš„çŠ¶æ€å¿…é¡»æ˜¯å¤„äºrunningçŠ¶æ€çš„è¿›ç¨‹æˆ–è€…æœ‰ä¿¡å·åˆ°è¾¾çš„å¤„äºinterruptible waitçŠ¶æ€ï¼ˆå¯ä¸­æ–­ç­‰å¾…çŠ¶æ€ï¼‰çš„è¿›ç¨‹ã€‚å½“readæ“ä½œå®Œæˆæ—¶ï¼Œå†…æ ¸ä¼šå°†å¯¹åº”çš„ç¼“å†²å—è§£é”ï¼Œç„¶åå‘å‡ºä¸­æ–­è¯·æ±‚ï¼Œå†…æ ¸ä¸­çš„ä¸­æ–­æœåŠ¡ç¨‹åºä¼šå°†é˜»å¡åœ¨è¯¥ç¼“å†²å—ä¸Šçš„è¿›ç¨‹çš„çŠ¶æ€ä¿®æ”¹ä¸ºrunningçŠ¶æ€ä»¥ä½¿å…¶é‡æ–°å…·å¤‡å‚ä¸è¿›ç¨‹è°ƒåº¦çš„èƒ½åŠ›ã€‚\n 2. éé˜»å¡IOæ¨¡å‹ # åœ¨æœ‰äº›æ—¶å€™å¹¶ä¸å¸Œæœ›è¿›ç¨‹åœ¨IOæ“ä½œæœªå®Œæˆæ—¶ç¡çœ ï¼Œè€Œæ˜¯å¸Œæœ›ç³»ç»Ÿè°ƒç”¨èƒ½å¤Ÿç«‹åˆ»è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œä»¥æŠ¥å‘Šè¿™ä¸€æƒ…å†µï¼Œç„¶åè¿›ç¨‹å¯ä»¥æ ¹æ®éœ€è¦åœ¨é€‚å½“çš„æ—¶å€™å†é‡æ–°æ‰§è¡Œè¿™ä¸ªIOæ“ä½œã€‚è¿™å°±æ˜¯æ‰€è°“çš„éé˜»å¡IOæ¨¡å‹ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåº”ç”¨ç¨‹åºå‰å‡ æ¬¡readç³»ç»Ÿè°ƒç”¨æ—¶éƒ½æ²¡æœ‰æ•°æ®å¯ä¾›è¿”å›ï¼Œæ­¤æ—¶å†…æ ¸ç«‹å³è¿”å›ä¸€ä¸ªEAGAINé”™è¯¯ä»£ç ï¼Œç¨‹åºå¹¶ä¸ç¡çœ è€Œæ˜¯ç»§ç»­è°ƒç”¨readï¼Œå½“ç¬¬å››æ¬¡è°ƒç”¨readæ—¶æ•°æ®å‡†å¤‡å¥½äº†ï¼Œäºæ˜¯æ‰§è¡Œæ•°æ®ä»å†…æ ¸åˆ°ç”¨æˆ·ç©ºé—´çš„å¤åˆ¶æ“ä½œå¹¶æˆåŠŸè¿”å›ï¼Œåº”ç”¨ç¨‹åºæ¥ç€å¤„ç†æ•°æ®ã€‚è¿™ç§å¯¹ä¸€ä¸ªéé˜»å¡IOç«¯å£åå¤è°ƒç”¨readè¿›è¡Œæ•°æ®è¯»å–çš„åŠ¨ä½œç§°ä¸ºè½®è¯¢ï¼Œå³åº”ç”¨ç¨‹åºæŒç»­è½®è¯¢å†…æ ¸æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ã€‚è¿™é‡Œçš„æŒç»­è½®è¯¢æ“ä½œå°†å¯¼è‡´è€—è´¹å¤§é‡çš„CPUæ—¶é—´ï¼Œå› æ­¤è¯¥æ¨¡å‹å¹¶ä¸æ¨èä½¿ç”¨ã€‚\n3. IOå¤šè·¯å¤ç”¨æ¨¡å‹ # å‰é¢ä»‹ç»äº†éé˜»å¡IOæ¨¡å‹çš„é—®é¢˜åœ¨äºï¼Œå°½ç®¡åº”ç”¨ç¨‹åºå¯ä»¥åœ¨å½“å‰IOæ“ä½œä¸èƒ½å®Œæˆçš„æ—¶å€™è¿«ä½¿ç³»ç»Ÿè°ƒç”¨ç«‹åˆ»è¿”å›è€Œä¸è‡³äºç¡çœ ï¼Œä½†æ˜¯å´æ— æ³•çŸ¥é“ä»€ä¹ˆæ—¶å€™å†æ¬¡è¯·æ±‚IOæ“ä½œå¯ä»¥é¡ºåˆ©å®Œæˆï¼Œåªèƒ½å‘¨æœŸæ€§åœ°åšå¾ˆå¤šæ— è°“çš„è½®è¯¢ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±è¦é‡æ–°è¯·æ±‚ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ç§è½®è¯¢ç­–ç•¥æå¤§æµªè´¹äº†CPUæ—¶é—´ã€‚\nIOå¤šè·¯å¤ç”¨æ¨¡å‹å°±æ˜¯åœ¨æ­¤ä¹‹ä¸Šçš„æ”¹è¿›ï¼Œå®ƒçš„å¥½å¤„åœ¨äºä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥åŒæ—¶å¯¹å¤šä¸ªIOç«¯å£è¿›è¡Œç›‘æ§ä»¥åˆ¤æ–­å…¶ä¸Šçš„æ“ä½œæ˜¯å¦å¯ä»¥é¡ºåˆ©ï¼ˆæ— é˜»å¡åœ°ï¼‰å®Œæˆï¼Œè¾¾åˆ°æ—¶é—´å¤ç”¨çš„ç›®çš„ã€‚è¿›ç¨‹é˜»å¡åœ¨ç±»ä¼¼äºselectã€pollæˆ–epollè¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œè€Œä¸æ˜¯é˜»å¡åœ¨çœŸæ­£çš„IOç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œæ„æ€ä¹Ÿå°±æ˜¯è¯´åœ¨è¿™äº›selectã€pollæˆ–è€…epollå‡½æ•°å†…éƒ¨ä¼šä»£æ›¿æˆ‘ä»¬åšéé˜»å¡åœ°è½®è¯¢ï¼Œé‚£ä¹ˆå®ƒçš„è½®è¯¢ç­–ç•¥æ˜¯æ€æ ·åœ°å‘¢ï¼Ÿç¨åä¼šè¿›è¡Œä»‹ç»ã€‚\nselectã€pollæˆ–epollä½¿å¾—è¿›ç¨‹å¯ä»¥åœ¨å¤šä¸ªIOç«¯å£ä¸Šç­‰å¾…IOäº‹ä»¶ï¼ˆå¯è¯»ã€å¯å†™ã€ç½‘ç»œè¿æ¥è¯·æ±‚ç­‰ï¼‰çš„å‘ç”Ÿï¼Œå½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶å†æ ¹æ®å‘ç”Ÿäº‹ä»¶çš„ç±»å‹è¿›è¡Œé€‚å½“çš„IOå¤„ç†ã€‚ä¸è¿‡è¿›ç¨‹åœ¨ç­‰å¾…IOäº‹ä»¶å‘ç”Ÿæ—¶ä»ç„¶åœ¨ä»£ç æ‰§è¡Œåºä¸Šå¤„äºâ€œé˜»å¡â€çŠ¶æ€ï¼Œåº”ç”¨ç¨‹åºâ€œé˜»å¡â€åœ¨è¿™é‡Œç…§æ ·è¿˜æ˜¯æ— æ³•åšå…¶ä»–çš„å·¥ä½œï¼ˆå°½ç®¡å¯ä»¥æŒ‡å®šè½®è¯¢æ—¶ç­‰å¾…æ—¶é—´çš„é•¿çŸ­ï¼‰ã€‚å› æ­¤å¦‚æœå¸Œæœ›è¿›ç¨‹åœ¨æ²¡æœ‰IOäº‹ä»¶è¦å¤„ç†æ—¶è¿˜èƒ½åšå…¶ä»–çš„å·¥ä½œï¼Œè¿™ç§æ¨¡å‹æ˜¯ä¸å¯è¡Œçš„ã€‚\nä¸‹å›¾æ˜¯IOå¤šè·¯å¤ç”¨æ¨¡å‹çš„ç¤ºä¾‹ã€‚\nIOå¤šè·¯å¤ç”¨æ¨¡å‹ä¸»è¦æœ‰3ç§å®ç°å½¢å¼ï¼Œselectã€pollã€epollã€‚\n3.1. select # #include \u0026lt;sys/select.h\u0026gt; //è¿”å›å€¼ï¼šreadfdsã€writefdsã€exceptfdsä¸­äº‹ä»¶å°±ç»ªçš„fdçš„æ•°é‡ int select(int nfds, // æœ€å¤§æ–‡ä»¶æè¿°ç¬¦fd+1 fd_set *restrict readfds, // ç­‰å¾…è¯»å–çš„fds fd_set *restrict writefds, // ç­‰å¾…å†™å…¥çš„fds fd_set *restrict exceptfds, // å¼‚å¸¸fds struct timeval *restrict timeout); // è¶…æ—¶æ—¶é—´ //è¿”å›å€¼ï¼šreadfdsã€writefdsã€exceptfdsä¸­äº‹ä»¶å°±ç»ªçš„fdçš„æ•°é‡ int pselect(int nfds, // æœ€å¤§æ–‡ä»¶æè¿°ç¬¦fd+1 fd_set *restrict readfds, // ç­‰å¾…è¯»å–çš„fds fd_set *restrict writefds, // ç­‰å¾…å†™å…¥çš„fds fd_set *restrict exceptfds, // å¼‚å¸¸fds const struct timespec *restrict timeout, // è¶…æ—¶æ—¶é—´ const sigset_t *restrict sigmask); // ä¿¡å·æ©ç    å¤‡æ³¨ï¼š\nIOäº‹ä»¶å°±ç»ªçš„æ„æ€æ˜¯ï¼Œæ‰§è¡Œå¯¹åº”çš„IOæ“ä½œæ—¶å¯ä»¥æ— é˜»å¡åœ°å®Œæˆã€‚ä¾‹å¦‚è¯»äº‹ä»¶å°±ç»ªï¼Œè¡¨æ˜ä¸€å®šæœ‰æ•°æ®åˆ°è¾¾ï¼Œæˆ–è€…å·²ç»è¯»å–åˆ°äº†æ•°æ®çš„ç»“æŸä½ç½®EOFã€‚\n #define __FD_SETSIZE 1024 typedef struct { /* XPG4.2 requires this member name. Otherwise avoid the name from the global namespace. */ #ifdef __USE_XOPEN __fd_mask fds_bits[__FD_SETSIZE / __NFDBITS]; # define __FDS_BITS(set) ((set)-\u0026gt;fds_bits) #else __fd_mask __fds_bits[__FD_SETSIZE / __NFDBITS]; # define __FDS_BITS(set) ((set)-\u0026gt;__fds_bits) #endif } fd_set;  selectå’ŒpselectåŸºæœ¬æ˜¯ç›¸åŒçš„ï¼Œå®ƒä»¬ä¸»è¦æœ‰3ç‚¹ç»†å¾®çš„å·®åˆ«ï¼š\n selectä½¿ç”¨çš„è¶…æ—¶æ—¶é—´struct timevalæ˜¯å¾®ç§’çº§çš„ï¼Œè€Œpselectä½¿ç”¨çš„struct timespecå¯ä»¥ç²¾ç¡®åˆ°çº³ç§’çº§ï¼› selectä¼šæ›´æ–°timeoutçš„å€¼ï¼Œå°†å…¶ä¿®æ”¹ä¸ºå‰©ä½™è½®è¯¢æ—¶é—´ï¼Œè€Œpselectä¸ä¼šå¯¹timeoutåšä¿®æ”¹ï¼› selectæ— æ³•æŒ‡å®šè½®è¯¢æ—¶çš„ä¿¡å·æ©ç ï¼Œè€Œpselectå…è®¸æŒ‡å®šä¿¡å·æ©ç ï¼Œå¦‚æœpselectç¬¬6ä¸ªå‚æ•°ä¸ä¸ºNULLï¼Œåˆ™ç”¨å…¶å…ˆæ›¿æ¢å½“å‰çš„ä¿¡å·æ©ç ï¼Œç„¶åæ‰§è¡Œä¸selectç›¸åŒçš„æ“ä½œï¼Œè¿”å›æ—¶å†è¿˜åŸä¹‹å‰çš„ä¿¡å·æ©ç ï¼›  fd_setåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ç”¨äºè®°å½•å¾…ç›‘è§†çš„fdçš„ä½å›¾ï¼Œç”±äº__FD_SETSIZEç¡¬ç¼–ç ä¸º1024ï¼Œæ‰€ä»¥selectæœ€å¤šåªèƒ½ç›‘è§†1024ä¸ªfdã€‚\nå¯¹fd_setçš„æ“ä½œä¸»è¦é€šè¿‡å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ã€‚\n#include \u0026lt;sys/select.h\u0026gt; void FD_CLR(int fd, fd_set *fdset); // ä»fdsetä¸­åˆ é™¤fd void FD_ISSET(int fd, fd_set *fdset); // æµ‹è¯•fdæ˜¯å¦å·²æ·»åŠ åˆ°fdsetä¸­ void FD_SET(int fd, fd_set *fdset); // å‘fdsetä¸­æ·»åŠ fd void FD_ZERO(fd_set *fdset); // æ¸…ç©ºfdset  ä¸‹é¢å¯¹timeoutç›¸å…³çš„æ•°æ®ç»“æ„è¿›è¡Œä¸€ä¸‹è¯´æ˜ï¼š\n å¦‚æœtimeoutä¸­çš„ä¸¤ä¸ªå­—æ®µå‡ä¸º0ï¼Œåˆ™è¡¨ç¤ºselectç«‹å³è¿”å›ï¼› å¦‚æœtimeoutä¸­çš„ä»»æ„ä¸€ä¸ªå­—æ®µä¸ä¸º0ï¼Œåˆ™è¡¨ç¤ºselectè½®è¯¢æ—¶ç»è¿‡æŒ‡å®šçš„æ—¶é—´åä¼šè¿”å›ï¼› å¦‚æœtimeoutä¸ºNULLï¼Œåˆ™è¡¨ç¤ºselectä¼šé˜»å¡åˆ°æœ‰äº‹ä»¶å°±ç»ªæ‰è¿”å›ï¼›  struct timeval { long tv_sec; long tv_usec; }; struct timespec { long tv_sec; long tv_nsec; };  åœ¨å¾ªç¯ä½¿ç”¨selectå‡½æ•°æ—¶æœ‰ä¸‰ä¸ªåœ°æ–¹å€¼å¾—æ³¨æ„:\n ç¬¬ä¸€ï¼Œè™½ç„¶åœ¨æ™®éæƒ…å†µä¸‹ï¼Œå‚æ•°timeoutåœ¨selectå‡½æ•°è¿”å›æ—¶ä¸ä¼šè¢«ä¿®æ”¹ï¼Œä½†æ˜¯æœ‰çš„Linuxç‰ˆæœ¬å´ä¼šå°†è¿™ä¸ªå€¼ä¿®æ”¹æˆå‡½æ•°è¿”å›æ—¶å‰©ä½™çš„ç­‰å¾…ç§’æ•°ï¼Œå› æ­¤ä»å¯ç§»æ¤æ€§ä¸Šè€ƒè™‘ï¼Œåœ¨æ¯æ¬¡é‡æ–°è°ƒç”¨selectå‡½æ•°å‰éƒ½å¾—å†æ¬¡å¯¹å‚æ•°timeoutåˆå§‹åŒ–ã€‚ ç¬¬äºŒï¼Œselectå‡½æ•°ä¸­é—´çš„ä¸‰ä¸ªå‚æ•°ï¼ˆå³æ„Ÿå…´è¶£çš„æè¿°ç¬¦é›†ï¼‰åœ¨selectå‡½æ•°è¿”å›æ—¶ï¼Œå…¶ä¿å­˜æœ‰æŒ‡ç¤ºå“ªäº›æè¿°ç¬¦å·²ç»è¿›å…¥å°±ç»ªçŠ¶æ€ï¼ˆæ­¤æ—¶å…¶å¯¹åº”bitè¢«è®¾ç½®ä¸º1ï¼Œå…¶ä»–æœªå°±ç»ªæè¿°ç¬¦å¯¹åº”bitè®¾ç½®ä¸º0ï¼‰ï¼Œä»è€Œç¨‹åºå¯ä»¥ä½¿ç”¨å®FD_ISSETæ¥æµ‹è¯•æè¿°ç¬¦é›†ä¸­çš„å°±ç»ªæè¿°ç¬¦ã€‚å› æ­¤ï¼Œåœ¨æ¯æ¬¡é‡æ–°è°ƒç”¨selectå‡½æ•°å‰éƒ½å¾—å†æ¬¡æŠŠæ‰€æœ‰æè¿°ç¬¦é›†ä¸­å…³æ³¨çš„fdå¯¹åº”çš„bitè®¾ç½®ä¸º1ã€‚ ç¬¬ä¸‰ï¼Œåº”æ³¨æ„åˆ°åˆ©ç”¨selectå‡½æ•°ç›‘æ§çš„æœ€å¤§æè¿°ç¬¦æ”¶åˆ°ç³»ç»ŸFD_SETSIZEå®çš„é™åˆ¶ï¼Œæœ€å¤šèƒ½å¤Ÿç›‘è§†1024ä¸ªæè¿°ç¬¦ï¼Œåœ¨é«˜å¹¶å‘æƒ…æ™¯ä¸­ï¼Œselectæ˜¯éš¾ä»¥èƒœä»»çš„ã€‚  ä¸‹é¢æ˜¯selectçš„ç¼–ç¨‹æ¨¡æ¿ï¼Œå¯åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ã€‚\n// å¯è¯»ã€å¯å†™ã€å¼‚å¸¸3ç§æ–‡ä»¶æè¿°ç¬¦é›†çš„å£°æ˜å’Œåˆå§‹åŒ– fd_set readfds, writefds, exceptfds; FD_ZERO(\u0026amp;readfds); FD_ZERO(\u0026amp;writefds); FD_ZERO(\u0026amp;exceptfds); int max_fd; // socketé…ç½®å’Œç›‘å¬ int sock = socket(...); bind(sock, ...); listen(sock, ...); // å¯¹socketæè¿°ç¬¦ä¸Šå…³å¿ƒçš„äº‹ä»¶è¿›è¡Œæ³¨å†Œï¼Œselectä¸è¦æ±‚fdéé˜»å¡ FD_SET(sock, \u0026amp;readfds); max_fd = sock; while(1) { int i; fd_set r, w, e; // ä¸ºäº†é‡å¤ä½¿ç”¨readfdsã€writefdsã€exceptionfdsï¼Œå°†ä»–ä»¬å¤åˆ¶åˆ°ä¸´æ—¶å˜é‡å†… memcpy(\u0026amp;r, \u0026amp;readfds, sizeof(fd_set)); memcpy(\u0026amp;w, \u0026amp;writefds, sizeof(fd_set)); memcpy(\u0026amp;e, \u0026amp;exceptfds, sizeof(fd_set)); // åˆ©ç”¨ä¸´æ—¶å˜é‡è°ƒç”¨selecté˜»å¡ç­‰å¾…ï¼Œç­‰å¾…æ—¶é—´ä¸ºæ°¸è¿œç­‰å¾…ç›´åˆ°äº‹ä»¶å‘ç”Ÿ select(max_fd+1, \u0026amp;r, \u0026amp;w, \u0026amp;e, NULL); // æµ‹è¯•æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œå¦‚æœæœ‰åˆ™æ¥å—å¹¶æŠŠæ–°å»ºçš„æè¿°ç¬¦åŠ å…¥ç›‘æ§ if(FD_ISSET(sock, \u0026amp;r)) { new_sock = accept(sock, ...); FD_SET(new_sock, \u0026amp;readfds); FD_SET(new_sock, \u0026amp;writefds); max_fd = MAX(max_fd, new_sock); } // å¯¹å…¶ä»–æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„äº‹ä»¶è¿›è¡Œé€‚å½“å¤„ç† // æè¿°ç¬¦ä¾æ¬¡é€’å¢ï¼Œå„ç³»ç»Ÿçš„æœ€å¤§å€¼å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡ulimit -nè¿›è¡Œè®¾ç½® for(i=sock+1; i\u0026lt;max_fd+1; ++i) { if(FD_ISSET(i, \u0026amp;r)) { doReadAction(i); } if(FD_ISSET(i, \u0026amp;w)) { doWriteAction(i); } } }   å¤‡æ³¨ï¼š ä¸Šè¿°åªæ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„selectä½¿ç”¨ç¤ºä¾‹ï¼Œåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘ä¸€äº›å…¶ä»–çš„å› ç´ ï¼Œä¾‹å¦‚å¯¹ç«¯çš„tcpè¿æ¥socketå…³é—­æ—¶åº”è¯¥æ€æ ·å¤„ç†ï¼Œå…³é—­åˆå¯ä»¥ç»†åˆ†ä¸ºå…³é—­è¯»å’Œå†™ä¸¤ç§æƒ…å†µã€‚\n ä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹åŸºäºselectå®ç°çš„tcp serverï¼Œ[click to see select-based-tcp-server]ã€‚\n3.2. poll # #include \u0026lt;poll.h\u0026gt; int poll(struct pollfd *fds, // å¾…ç›‘è§†çš„fdæ„æˆçš„struct pollfdæ•°ç»„ nfds_t nfds, // æ•°ç»„fds[]ä¸­å…ƒç´ æ•°é‡ int timeout); // è½®è¯¢æ—¶ç­‰å¾…çš„æœ€å¤§è¶…æ—¶æ—¶é—´ struct pollfd { int fd; // å¾…ç›‘è§†çš„fd short events; // è¯·æ±‚ç›‘è§†çš„äº‹ä»¶ short revents; // å®é™…æ”¶åˆ°çš„äº‹ä»¶ };  pollfdä¸­å¯æŒ‡å®šçš„eventç±»å‹åŒ…æ‹¬ï¼š\n POLLINï¼Œæ™®é€šæ•°æ®è¯»å–ï¼› POLLPRIï¼Œç´§æ€¥æ•°æ®è¯»å–ï¼› POLLOUTï¼Œæ™®é€šæ•°æ®å¯å†™ï¼› POLLRDHUPï¼Œé¢å‘æµçš„socketï¼Œå¯¹ç«¯socketå…³é—­è¿æ¥æˆ–è€…å…³é—­äº†å†™åŠè¿æ¥ï¼› POLLERRï¼Œé”™è¯¯ï¼› POLLHUPï¼ŒæŒ‚èµ·ï¼› POLLNVALï¼Œæ— æ•ˆè¯·æ±‚ï¼Œfdæ²¡æœ‰æ‰“å¼€ï¼›  å½“å¦‚æœé€šè¿‡å®_XOPEN_SOURCEè¿›è¡Œæ¡ä»¶ç¼–è¯‘æ—¶ï¼Œè¿˜å¯æŒ‡å®šå¦‚ä¸‹eventç±»å‹ï¼š\n POLLRDNORMï¼Œä¸POLLINç­‰æ•ˆï¼› POLLRDBANDï¼Œä¼˜å…ˆçº§å¸¦æ•°æ®å¯è¯»ï¼Œåœ¨Linuxä¸Šé€šå¸¸æ˜¯æ— ç”¨çš„ï¼› POLLWRNORMï¼Œä¸POLLOUTç­‰æ•ˆï¼› POLLWRBANDï¼Œä¼˜å…ˆçº§æ•°æ®å¯å†™ï¼›  pollç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸‰ä¸ªå‚æ•°timeoutæŒ‡å®šäº†è½®è¯¢æ—¶çš„ç­‰å¾…äº‹ä»¶ï¼Œå½“timeout\u0026lt;0æ—¶æ°¸è¿œç­‰å¾…ç›´åˆ°ç›‘è§†çš„fdsä¸Šæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå½“timeout=0æ—¶ç«‹å³è¿”å›ï¼Œå•timeout\u0026gt;0æ—¶ç­‰å¾…åˆ°æŒ‡å®šçš„è¶…æ—¶æ—¶é—´åè¿”å›ã€‚pollä¸è¦æ±‚ç›‘è§†çš„fdä¸ºéé˜»å¡ã€‚\npollä¸selectç›¸æ¯”å…·æœ‰å¦‚ä¸‹ä¼˜åŠ¿ï¼š\n pollç³»ç»Ÿè°ƒç”¨ä¸­é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°nfdsæ¥é™å®šè¦ç›‘è§†çš„æè¿°ç¬¦çš„æ•°é‡ï¼Œä¸selectç›¸æ¯”ï¼Œpollå»æ‰äº†ç¡¬ç¼–ç çš„FD_SETSIZEå®çš„ç›‘æ§fdæ•°é‡ä¸Šé™ï¼› å¦å¤–pollé€šè¿‡pollfdä¸­çš„reventsæ¥æ¥æ”¶fdä¸Šåˆ°è¾¾çš„äº‹ä»¶ï¼Œeventsä¸ä¼šè¢«ä¿®æ”¹ï¼Œæ¯æ¬¡è°ƒç”¨pollæ—¶ä¸ç”¨åƒselectä¸€æ ·æ¯æ¬¡éƒ½éœ€è¦é‡æ–°è®¾ç½®rã€wã€eæ–‡ä»¶æè¿°ç¬¦é›†ï¼Œæ–¹ä¾¿ä½¿ç”¨ä¹Ÿå‡å°‘æ•°æ®å‘å†…æ ¸æ‹·è´çš„å¼€é”€ã€‚  // æ–°å»ºå¹¶åˆå§‹åŒ–æ–‡ä»¶æè¿°ç¬¦é›† struct pollfd fds[MAX_NUM_FDS]; int max_fd; // socketé…ç½®å’Œç›‘å¬ sock = socket(...); bind(sock, ...); listen(sock, ...); // å¯¹socketæè¿°ç¬¦ä¸Šå…³å¿ƒçš„äº‹ä»¶è¿›è¡Œæ³¨å†Œ fds[0].fd = sock; fds[0].events = POLLIN; max_fd = 1; while(1) { int i; // è°ƒç”¨pollé˜»å¡ç­‰å¾…ï¼Œç­‰å¾…æ—¶é—´ä¸ºæ°¸è¿œç­‰å¾…ç›´åˆ°äº‹ä»¶å‘ç”Ÿ pollï¼ˆfds, max_fd, -1); // æµ‹è¯•æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œå¦‚æœæœ‰åˆ™æ¥å—å¹¶æŠŠæ–°å»ºçš„æè¿°ç¬¦åŠ å…¥ç›‘æ§ if(fds[0].revents \u0026amp; POLLIN) { new_sock = accept(sock, ...); fds[max_fd].fd = new_sock; fds[max_fd].events = POLLIN | POLLOUT; ++ max_fd; } // å¯¹å…¶ä»–æè¿°ç¬¦å‘ç”Ÿçš„äº‹ä»¶è¿›è¡Œé€‚å½“å¤„ç† for(i=1; i\u0026lt;max_fd+1; ++i) { if(fds[i].revents \u0026amp; POLLIN) { doReadAction(i); } if(fds[i].revents \u0026amp; POLLOUT) { doWriteAction(i); } } }   å¤‡æ³¨ï¼š\nä¸Šé¢çš„ä»£ç ä¹Ÿæ˜¯åªç»™å‡ºäº†ä¸€ä¸ªæœ€ç®€å•çš„ç¼–ç¨‹ç¤ºä¾‹ï¼Œå¯¹äºå¯¹ç«¯tcpè¿æ¥å…³é—­çš„æƒ…å†µä¹Ÿéœ€è¦äºˆä»¥è€ƒè™‘ï¼Œé¿å…æœç”¨ç«¯å ç”¨å¤§é‡çš„fdã€‚\nä»ä¸Šé¢åŸºäºselect/pollå¤šè·¯å¤ç”¨IOæ¨¡å‹å¯ä»¥çœ‹å‡ºï¼Œåœ¨å¤§é‡çš„å¹¶å‘è¿æ¥ä¸­ï¼Œå¦‚æœç©ºé—²è¿æ¥ï¼ˆå³æ— äº‹ä»¶å‘ç”Ÿçš„è¿æ¥ï¼‰è¾ƒå¤šï¼Œselect/pollçš„æ€§èƒ½ä¼šå› ä¸ºå¹¶å‘æ•°çš„çº¿æ€§ä¸Šå‡è€Œæˆçº¿å‹é€Ÿåº¦ä¸‹é™ï¼Œå®é™…ä¸Šæ€§èƒ½å¯èƒ½æ¯”çº¿å‹ä¸‹é™æ›´å·®ã€‚å½“è¿æ¥æ•°å¾ˆå¤§æ—¶ï¼Œç³»ç»Ÿå¼€é”€ä¼šå¼‚å¸¸å¤§ã€‚\nå¦å¤–selectã€pollæ¯æ¬¡è¿”å›æ—¶éƒ½éœ€è¦ä»å†…æ ¸å‘ç”¨æˆ·ç©ºé—´å¤åˆ¶å¤§é‡çš„æ•°æ®ï¼Œæ•°æ®å¤åˆ¶çš„å¼€é”€ä¹Ÿä¼šå¾ˆå¤§ï¼Œselectä¸»è¦æ˜¯ä»å†…æ ¸å‘ç”¨æˆ·ç©ºé—´å¤åˆ¶readfdsã€writefdsã€exceptfdså¼€é”€å¤§ï¼Œpollä¸»è¦æ˜¯ä»å†…æ ¸å¤åˆ¶pollfd[]å¼€é”€å¤§ã€‚\nä½¿ç”¨select/pollå®ç°çš„å¤šè·¯å¤ç”¨IOæ¨¡å‹æ˜¯æœ€ç¨³å®šä¹Ÿæ˜¯ä½¿ç”¨æœ€ä¸ºå¹¿æ³›çš„äº‹ä»¶é©±åŠ¨IOæ¨¡å‹ï¼Œä½†æ˜¯å…¶å›ºæœ‰çš„ä¸€äº›ç¼ºç‚¹ï¼ˆå¦‚æ€§èƒ½ä½ä¸‹ã€ä¼¸ç¼©æ€§ä¸å¼ºï¼‰ä½¿å¾—å„ç§æ›´ä¸ºå…ˆè¿›çš„æ›¿ä»£æ–¹æ¡ˆå‡ºç°åœ¨å„ç§å¹³å°ä¸‹ã€‚\n ä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹åŸºäºpollå®ç°çš„tcp serverï¼Œ[click to see poll-based-tcp-server]ã€‚\n3.3. epoll # epollä½œä¸ºpollçš„å˜ä½“åœ¨Linuxå†…æ ¸2.5ä¸­è¢«å¼•å…¥ï¼Œç›¸æ¯”äºselectå®ç°çš„å¤šè·¯å¤ç”¨IOæ¨¡å‹ï¼Œepollçš„æœ€å¤§å¥½å¤„åœ¨äºå®ƒä¸ä¼šéšç€ç›‘æ§æè¿°ç¬¦æ•°ç›®çš„å¢é•¿è€Œä½¿æ•ˆç‡æ€¥å‰§ä¸‹é™ã€‚åœ¨å†…æ ¸ä¸­çš„selectå®ç°æ˜¯é‡‡ç”¨è½®è¯¢å¤„ç†çš„ï¼Œè½®è¯¢çš„æè¿°ç¬¦æ•°ç›®è¶Šå¤šï¼Œè‡ªç„¶è€—æ—¶è¶Šå¤šï¼Œè€Œä¸”åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œselectæœ€å¤šèƒ½åŒæ—¶ç›‘å¬çš„æè¿°ç¬¦æ•°ç›®ä¸º1024ä¸ªã€‚\nepollæä¾›äº†ä¸‰ç§ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚\n#include \u0026lt;sys/poll.h\u0026gt; // åˆ›å»ºä¸€ä¸ªepfdï¼Œæœ€å¤šç›‘è§†${size}ä¸ªæ–‡ä»¶æè¿°ç¬¦ int epoll_create(int size); int epoll_ctl(int epfd, // epfd int op, // æ“ä½œç±»å‹ï¼ˆæ³¨å†Œã€å–æ¶ˆæ³¨å†Œï¼‰ int fd, // å¾…ç›‘è§†çš„fd struct epoll_event *event); // å¾…ç›‘è§†çš„fdä¸Šçš„ioäº‹ä»¶ int epoll_wait(int epfd, // epfd struct epoll_event *events, // æœ€ç»ˆè¿”å›çš„å°±ç»ªäº‹ä»¶ int maxevents, // æœŸæœ›çš„å°±ç»ªäº‹ä»¶æ•°é‡ int timeout); // è¶…æ—¶æ—¶é—´ int epoll_wait(int epfd, // epfd struct epoll_event *events, // æ¥æ”¶è¿”å›çš„å°±ç»ªäº‹ä»¶ int maxevents, // æœŸæœ›çš„å°±ç»ªäº‹ä»¶æ•°é‡ int timeout, // è¶…æ—¶æ—¶é—´ const sigset_t *sigmask); // ä¿¡å·æ©ç  typedef union epoll_data { void *ptr; int fd; __uint32_t u32; __uint64_t u64; } epoll_data_t; struct epoll_event { __uint32_t events; // epoll events epoll_data_t data; // user data variable };  epollä¸­å¯ä»¥å…³æ³¨çš„äº‹ä»¶ä¸»è¦æœ‰ï¼š\n EPOLLINï¼Œæ•°æ®å¯è¯»äº‹ä»¶ï¼› EPOLLOUTï¼Œæ•°æ®å¯å†™äº‹ä»¶ï¼› EPOLLRDHUPï¼Œæµsocketå¯¹ç«¯å…³é—­è¿æ¥æˆ–è€…å…³é—­äº†å†™åŠè¿æ¥ï¼› EPOLLPRIï¼Œç´§æ€¥æ•°æ®è¯»å–äº‹ä»¶ï¼› EPOLLERRï¼Œé”™è¯¯äº‹ä»¶ï¼› EPOLLHUPï¼ŒæŒ‚èµ·äº‹ä»¶ï¼Œepollæ€»æ˜¯ä¼šç­‰å¾…è¯¥äº‹ä»¶ï¼Œä¸éœ€è¦æ˜¾ç¤ºè®¾ç½®ï¼› EPOLLETï¼Œè®¾ç½®epollä»¥è¾¹ç¼˜è§¦å‘æ¨¡å¼å·¥ä½œï¼ˆä¸æŒ‡å®šè¯¥é€‰é¡¹åˆ™ä½¿ç”¨çº§åˆ«è§¦å‘Level Triggeræ¨¡å¼ï¼‰ï¼› EPOLLONESHOTï¼Œè®¾ç½®epollé’ˆå¯¹æŸä¸ªfdä¸Šçš„äº‹ä»¶åªé€šçŸ¥ä¸€æ¬¡ï¼Œä¸€æ—¦epollé€šçŸ¥äº†æŸä¸ªäº‹ä»¶ï¼Œè¯¥fdä¸Šåç»­åˆ°è¾¾çš„äº‹ä»¶å°†ä¸ä¼šå†å‘é€é€šçŸ¥ï¼Œé™¤éé‡æ–°é€šè¿‡epoll_ctl EPOLL_CTL_MODæ›´æ–°å…¶å…³æ³¨çš„äº‹ä»¶ã€‚  epolläº‹ä»¶çš„ä¸¤ç§æ¨¡å‹ï¼š\n LTï¼ŒLevel Triggeredï¼Œè¯‘ä¸ºæ°´å¹³è§¦å‘æˆ–è€…çº§åˆ«è§¦å‘ï¼Œæˆ‘æ›´åå‘äºä½¿ç”¨çº§åˆ«è§¦å‘ã€‚çº§åˆ«è§¦å‘æ˜¯é»˜è®¤çš„å·¥ä½œæ–¹å¼ï¼ŒåŒæ—¶æ”¯æŒé˜»å¡å’Œéé˜»å¡socketã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰è¿›ç¨‹è¯¥æè¿°ç¬¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¹‹åå¦‚æœè¿›ç¨‹ä¸€ç›´ä¸å¯¹è¿™ä¸ªå°±ç»ªçŠ¶æ€åšå‡ºä»»ä½•æ“ä½œï¼Œåˆ™å†…æ ¸ä¼šç»§ç»­é€šçŸ¥ï¼Œç›´åˆ°äº‹ä»¶å¤„ç†å®Œæˆã€‚ä»¥LTæ–¹å¼è°ƒç”¨çš„epollæ¥å£å°±ç›¸å½“äºä¸€ä¸ªé€Ÿåº¦æ¯”è¾ƒå¿«çš„pollæ¨¡å‹ã€‚ ETï¼ŒEdge Triggeredï¼Œè¯‘ä¸ºè¾¹ç¼˜è§¦å‘ã€‚è¾¹ç¼˜è§¦å‘æ–¹å¼æ˜¯é«˜é€Ÿå·¥ä½œæ–¹å¼ï¼Œåªæ”¯æŒéé˜»å¡socketã€‚åœ¨è¿™ç§å·¥ä½œæ–¹å¼ä¸‹ï¼Œå½“æè¿°ç¬¦ä»æœªå°±ç»ªå˜ä¸ºå°±ç»ªæ—¶ï¼Œå†…æ ¸é€šè¿‡epollå‘Šè¯‰è¿›ç¨‹è¯¥æè¿°ç¬¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œä¹‹åå°±ç®—è¿›ç¨‹ä¸€ç›´ä¸å¯¹è¿™ä¸ªå°±ç»ªçŠ¶æ€åšå‡ºä»»ä½•æ“ä½œï¼Œå†…æ ¸ä¹Ÿä¸ä¼šå†å‘é€æ›´å¤šåœ°é€šçŸ¥ï¼Œä¹Ÿå°±æ˜¯è¯´å†…æ ¸ä»…åœ¨è¯¥æè¿°ç¬¦äº‹ä»¶åˆ°è¾¾çš„é‚£ä¸ªçªå˜è¾¹ç¼˜å¯¹è¿›ç¨‹åšå‡ºä¸€æ¬¡é€šçŸ¥ã€‚\næ ¹æ®ETæ–¹å¼çš„ç‰¹æ€§ï¼Œepollå·¥ä½œåœ¨æ­¤æ¨¡å¼æ—¶å¿…é¡»ä½¿ç”¨éé˜»å¡æ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥é¿å…ç”±äºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„é˜»å¡è¯»ã€é˜»å¡å†™æ“ä½œæŠŠå¤„ç†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„ä»»åŠ¡â€œé¥¿æ­»â€ã€‚\nè°ƒç”¨ETæ¨¡å¼epollæ¥å£çš„æ¨èæ­¥éª¤å¦‚ä¸‹ï¼š\n1ï¼‰åŸºäºéé˜»å¡æ–‡ä»¶æè¿°ç¬¦ï¼›\n2ï¼‰åªæœ‰å½“readæˆ–writeè¿”å›EAGAINï¼ˆå¯¹äºé¢å‘åŒ…/ä»¤ç‰Œçš„æ–‡ä»¶ï¼Œæ¯”å¦‚æ•°æ®æŠ¥å¥—æ¥å£ã€è§„èŒƒæ¨¡å¼çš„ç»ˆç«¯ï¼‰æ—¶ï¼Œæˆ–æ˜¯read/writeè¯»åˆ°/å†™å‡ºçš„æ•°æ®é•¿åº¦å°äºè¯·æ±‚çš„æ•°æ®é•¿åº¦ï¼ˆå¯¹äºé¢å‘æµçš„æ–‡ä»¶ï¼Œæ¯”å¦‚pipeã€fifoã€æµå¥—æ¥å£ï¼‰æ—¶æ‰éœ€è¦æŒ‚èµ·ç­‰å¾…ä¸‹ä¸€ä¸ªäº‹ä»¶ã€‚\næ€»çš„æ¥è¯´ï¼Œåœ¨å¤§å¹¶å‘çš„ç³»ç»Ÿä¸­ï¼Œè¾¹ç¼˜è§¦å‘æ¨¡å¼æ¯”çº§åˆ«è§¦å‘æ¨¡å¼æ›´å…·æœ‰ä¼˜åŠ¿ï¼Œä½†æ˜¯å¯¹äºç¨‹åºå‘˜çš„è¦æ±‚ä¹Ÿæ›´é«˜ã€‚å¦‚æœå¯¹äºè¿™ä¸¤ç§æ¨¡å¼æƒ³è¦äº†è§£å¾—æ›´åŠ æ·±å…¥ï¼Œé‚£ä¹ˆå»ºè®®è¯»è€…é˜…è¯»epollç›¸å…³çš„æºä»£ç ã€‚  ä¸‹é¢æ˜¯epollå¤šè·¯å¤ç”¨IOæ¨¡å‹çš„ä¸€ä¸ªç¼–ç¨‹æ¨¡æ¿ï¼Œå¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ã€‚\n// åˆ›å»ºå¹¶åˆå§‹åŒ–æ–‡ä»¶æè¿°ç¬¦é›† struct epoll_event ev; struct epoll_event events[MAX_EVENTS]; // åˆ›å»ºepollå¥æŸ„epfd int epfd = epoll_create(MAX_EVENTS); // ç›‘å¬socketé…ç½® sock = socket(...); bind(sock, ...); listen(sock, ...); // å¯¹socketæè¿°ç¬¦ä¸Šå…³å¿ƒçš„äº‹ä»¶è¿›è¡Œæ³¨å†Œ ev.events = EPOLLIN; ev.data.fd = sock; epoll_ctl(epfd, EPOLL_CTL_ADD, sock, \u0026amp;ev); while(1) { int i; // è°ƒç”¨epoll_waité˜»å¡ç­‰å¾…ï¼Œç­‰å¾…äº‹ä»¶æœªæ°¸è¿œç­‰å¾…ç›´åˆ°å‘ç”Ÿäº‹ä»¶ int n = epoll_wait(epfd, events, MAX_EVENTS, -1); for(i=0; i\u0026lt;n; ++i) { // æµ‹è¯•æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ï¼Œå¦‚æœæœ‰åˆ™æ¥å—å¹¶æŠŠæ–°å»ºçš„æè¿°ç¬¦åŠ å…¥ç›‘æ§ if(events[i].data.fd == sock) { if(events[i].events \u0026amp; EPOLLIN) { new_sock = accept(sock, ...); ev.events = EPOLLIN | EPOLLOUT; ev.data.fd = new_sock; epoll_ctl(epfd, EPOLL_CTL_ADD, new_sock, \u0026amp;ev); } } else { // å¯¹äºå…¶ä»–æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„äº‹ä»¶è¿›è¡Œé€‚å½“å¤„ç† if(events[i].events \u0026amp; EPOLLIN) { doReadAction(i); } if(events[i].events \u0026amp; EPOLLOUT) { doWriteAction(i); } } } }   å¤‡æ³¨ï¼š æ³¨æ„ä¸Šé¢çš„ä»£ç ä¹Ÿæ˜¯ä»…ä»…ç»™å‡ºäº†ä¸€ä¸ªç¼–ç¨‹ç¤ºä¾‹ï¼Œå®é™…åº”ç”¨è¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦è€ƒè™‘å¯¹ç«¯tcpè¿æ¥å…³é—­æ—¶å¯¹serverç«¯å¥—æ¥å­—çš„å¤„ç†ï¼Œæ¯”å¦‚é€šè¿‡epoll_ctl(epfd, EPOLL_CTL_DEL, fd, NULL)å–æ¶ˆå¯¹fdä¸Šäº‹ä»¶çš„è½®è¯¢ï¼Œå¹¶close(fd)_ã€‚æœåŠ¡ç«¯å¦‚æœä¸æ³¨æ„å¯¹åˆ†é…çš„å¥—æ¥å­—fdè¿›è¡Œå›æ”¶ï¼Œå¾ˆæœ‰å¯èƒ½è¾¾åˆ°ç³»ç»Ÿå…è®¸çš„fdä¸Šé™ï¼Œé‚£æ—¶å€™å°±ä¼šå‡ºç°æœåŠ¡ç˜«ç—ªï¼Œåº”æ³¨æ„é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚\n å¤‡æ³¨ï¼š\néœ€è¦æ³¨æ„çº§åˆ«è§¦å‘ã€è¾¹ç¼˜è§¦å‘ç¼–ç æ–¹å¼ä¸Šçš„å·®åˆ«ï¼Œè¿™é‡Œé¦–å…ˆè¦é“­è®°ä¸€ç‚¹ï¼Œçº§åˆ«è§¦å‘åªåœ¨äº‹ä»¶çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶é€šçŸ¥ä¸€æ¬¡ï¼Œè€Œè¾¹ç¼˜è§¦å‘åªè¦äº‹ä»¶å¤„äºå°±ç»ªçŠ¶æ€é‚£ä¹ˆå°±ä¼šåœ¨å¤„ç†ä¹‹å‰ä¸€ç›´å‘é€ç»Ÿæ²»ã€‚\nä½¿ç”¨è¾¹ç¼˜è§¦å‘æ–¹å¼è¿›è¡Œç¼–ç¨‹æ¯”ä½¿ç”¨çº§åˆ«è§¦å‘ç¼–ç¨‹è¦ç¨å¾®å¤æ‚ä¸€äº›ï¼Œéœ€è¦æ—¶åˆ»è°¨è®°ä¸Šè¿°å·®å¼‚ï¼Œè¿™é‡Œè¯´ä¸¤ä¸ªç›´è§‚çš„æƒ…æ™¯ä¾¿äºå¤§å®¶ç†è§£ã€‚\n å½“é€šè¿‡epfdç›‘å¬æ¥è‡ªå¤šä¸ªå®¢æˆ·ç«¯çš„å…¥è¿æ¥è¯·æ±‚æ—¶ï¼Œå¯èƒ½ä¸€æ¬¡ä¼šæœ‰å¤§é‡å®¢æˆ·ç«¯çš„å…¥è¿æ¥è¯·æ±‚åˆ°è¾¾ï¼Œä¸€æ¬¡epoll_waitï¼Œå¦‚æœå·¥ä½œåœ¨è¾¹ç¼˜è§¦å‘æ¨¡å¼ï¼Œå°±åªä¼šé€šçŸ¥ä¸€æ¬¡epfdå¯è¯»äº‹ä»¶å°±ç»ªï¼Œå› æ­¤åœ¨å¯¹epfdä¸Šçš„EPOLLINè¿›è¡Œäº‹ä»¶å¤„ç†æ—¶ï¼Œéœ€è¦é€šè¿‡ä¸€ä¸ªwhileå¾ªç¯ä¸åœåœ°è°ƒç”¨acceptæ¥å®Œæˆæ‰€æœ‰å…¥è¿æ¥è¯·æ±‚çš„å¤„ç†ï¼Œè€Œä¸æ˜¯åƒä¸Šè¿°ç¼–ç¨‹ç¤ºä¾‹ï¼ˆä¸Šä¾‹ä¸ºLTè§¦å‘æ¨¡å¼ï¼‰ä¸­ä¸€æ ·ä¸€æ¬¡EPOLLINåªè°ƒç”¨ä¸€æ¬¡acceptï¼Œåˆ™çº§åˆ«è§¦å‘æ¨¡å¼ä¸‹ä¸Šè¿°æ–¹å¼æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯è¾¹ç¼˜è§¦å‘æ¨¡å¼ä¸‹ä¼šé€ æˆä¸¥é‡çš„bugã€‚ å½“é€šè¿‡sock_connå¯¹è¿æ¥socketä¸Šåˆ°è¾¾çš„æ•°æ®è¿›è¡Œè¯»å–æ—¶ï¼Œå¯¹äºæ¯ä¸€ä¸ªsocket_connä¸Šçš„æ•°æ®éƒ½è¦é€šè¿‡ä¸€ä¸ªwhileå¾ªç¯ä¸åœè¯»å–çŸ¥é“å†æ¬¡readè¿”å›EAGAINç¡®ä¿æ‰€æœ‰æ•°æ®å·²è¯»å–å®Œï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™ä¸è¯»å–ï¼Œä»¥åå°±ä¸ä¼šæ”¶åˆ°epoll_waitçš„å†æ¬¡é€šçŸ¥ï¼Œå¦‚æœæƒ³è¯»å–åŸºæœ¬ä¸Šå°±é€€åŒ–ä¸ºä¸€ä¸ªpolläº†ï¼Œéœ€è¦è‡ªå·±è½®è¯¢æˆ–è€…æµ‹è¯•æ˜¯å¦å¯è¯»ï¼Œå½±å“æ€§èƒ½ã€‚ å¯¹äºsock_connä¸Šæ•°æ®å†™æ“ä½œçš„å¤„ç†ï¼Œä¸sock_connä¸Šæ•°æ®è¯»çš„å¤„ç†æ˜¯ç›¸ä¼¼çš„ã€‚  ä¸selectã€pollç›¸æ¯”ï¼Œepollå…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹ï¼š\n epollæ¯æ¬¡åªè¿”å›æœ‰äº‹ä»¶å‘ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦ä¿¡æ¯ï¼Œè¿™æ ·è°ƒç”¨è€…ä¸ç”¨éå†æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é˜Ÿåˆ—ï¼› ä½¿ç”¨epollä½¿å¾—ç³»ç»Ÿä¸ç”¨ä»å†…æ ¸å‘ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ®ï¼Œå› ä¸ºå®ƒæ˜¯åˆ©ç”¨mmapä½¿å†…æ ¸å’Œç”¨æˆ·ç©ºé—´è´¡çŒ®ä¸€å—å†…å­˜ï¼› å¦å¤–epollå¯ä»¥è®¾ç½®ä¸åŒçš„äº‹ä»¶è§¦å‘æ–¹å¼ï¼ŒåŒ…æ‹¬è¾¹ç¼˜è§¦å‘å’Œçº§åˆ«è§¦å‘ä¸¤ç§ï¼Œä¸ºç”¨æˆ·ä½¿ç”¨epollæä¾›äº†çµæ´»æ€§ã€‚  ä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹åŸºäºepollå®ç°çš„tcp serverï¼Œ[click to see epoll-based-tcp-server]ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ä»£ç å®ç°ä¸­åŒ…æ‹¬äº†ä¸¤ä¸ªtcp serverå®ç°ï¼Œä¸€ä¸ªæ˜¯åŸºäºè¾¹ç¼˜è§¦å‘æ¨¡å¼(ET)ï¼Œä¸€ä¸ªæ˜¯åŸºäºçº§åˆ«è§¦å‘æ¨¡å¼(LT)ã€‚\n4. å®æ—¶ä¿¡å·é©±åŠ¨IOæ¨¡å‹ # å®æ—¶ä¿¡å·é©±åŠ¨(rtsig)IOæ¨¡å‹ä½¿å¾—åº”ç”¨ç¨‹åºä¸éœ€è¦é˜»å¡åœ¨æŸä¸€ä¸ªæˆ–å¤šä¸ªIOç«¯å£ä¸Šï¼Œå®ƒå…ˆåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨sigactionæ¥å®‰è£…æŸä¸ªç«¯å£çš„äº‹ä»¶ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥ç³»ç»Ÿè°ƒç”¨sigactionæ‰§è¡ŒæˆåŠŸåç«‹å³è¿”å›ï¼Œè¿›ç¨‹ç»§ç»­å¾€ä¸‹å·¥ä½œè€Œä¸è¢«é˜»å¡ï¼Œå½“æŸä¸ªIOç«¯å£ä¸Šå¯è¿›è¡Œæ•°æ®æ“ä½œæ—¶ï¼Œå†…æ ¸å°±ä¸ºè¯¥è¿›ç¨‹äº§ç”Ÿä¸€ä¸ªSIGIOä¿¡å·ï¼Œè¿›ç¨‹æ”¶åˆ°è¯¥ä¿¡å·åç›¸åº”åœ°åœ¨ä¿¡å·å¤„ç†å‡½æ•°é‡Œè¿›è¡ŒIOæ“ä½œï¼Œå› æ­¤ï¼Œè¿™ç§æœºåˆ¶ä½¿å¾—ç¨‹åºèƒ½å¤Ÿåœ¨ä¸€ä¸ªæ›´åˆé€‚çš„æ—¶é—´ç‚¹è¢«é€šçŸ¥åˆ°ï¼Œè¢«é€šçŸ¥å»æ‰§è¡ŒIOäº‹ä»¶å¤„ç†ï¼Œä¹‹æ‰€ä»¥è¯´æ˜¯é€šçŸ¥çš„æ—¶é—´ç‚¹æ›´å¥½ï¼Œæ˜¯å› ä¸ºæ­¤æ—¶è¿›è¡ŒIOéœ€è¦çš„æ•°æ®å·²å°±ç»ªï¼ŒIOå¤„ç†å¯ä»¥ä¿è¯æ— é˜»å¡åœ°å®Œæˆã€‚\nå®æ—¶ä¿¡å·é©±åŠ¨IOå®Œå…¨ä¸æ˜¯åœ¨select/pollåŸºç¡€ä¸Šçš„ä¿®æ”¹ï¼Œè€Œæ˜¯å¯¹ä¼ ç»Ÿä¿¡å·é©±åŠ¨IOçš„å®Œå–„ï¼Œå› æ­¤å®ƒæ˜¯å®Œå…¨ä¸åŒäºå‰é¢ä»‹ç»çš„å‡ ç§è§£å†³æ–¹æ¡ˆçš„äº‹ä»¶é©±åŠ¨IOæœºåˆ¶ã€‚\nè¦ä½¿ç”¨å®æ—¶ä¿¡å·é©±åŠ¨IOæ¨¡å‹ç›¸å¯¹äºå¤„ç†æ™®é€šçš„ä¿¡å·è¦ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œé™¤äº†è¦ä¸ºSIGIOä¿¡å·å»ºç«‹ä¿¡å·å¤„ç†å‡½æ•°ï¼ˆåœ¨è¯¥å¤„ç†å‡½æ•°å†…å½“ç„¶è¦åŒ…å«å¯¹å®é™…IOæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨ï¼‰ä»¥å¤–ï¼Œè¿˜éœ€è¦é¢å¤–çš„æ­¥éª¤ï¼Œå¦‚å¯¹IOç«¯å£åšä¸€äº›è®¾ç½®ä»¥ä¾¿å¯ç”¨ä¿¡å·é©±åŠ¨IOåŠŸèƒ½ã€‚é¦–å…ˆè¦è®¾ç½®æè¿°ç¬¦çš„æ‰€æœ‰è€…ï¼Œè¿™å¯ä»¥é€šè¿‡fcntlçš„F_SETOWNæ“ä½œæ¥å®Œæˆï¼Œfcntl(fd, F_SETOWN, (int)pid)ï¼Œæ¥ç€è¦å¯ç”¨æè¿°ç¬¦çš„ä¿¡å·é©±åŠ¨IOæ¨¡å¼ï¼Œè¿™ä¸ªæ­¥éª¤ä¸€èˆ¬æ˜¯é€šè¿‡fcntlçš„F_SETFLæ¥è®¾ç½®O_ASYNCæ ‡è¯†æ¥å®Œæˆçš„ï¼Œfcntl(fd, F_SETFL, O_ASYNC|O_NONBLOCK|O_RDWR)ã€‚å¦å¤–ï¼Œå¦‚æœæœ‰å¿…è¦è¿˜å¯ä»¥é‡æ–°è®¾ç½®æè¿°ç¬¦å¯è¯»å†™æ—¶è¦å‘é€çš„ä¿¡å·å€¼ï¼Œè¿™å¯ä»¥é€šè¿‡fcntlçš„F_SETSIGæŒ‡å®šï¼Œfcntl(fd, F_SETSIG, ev-\u0026gt;signum)ã€‚\n å¤‡æ³¨ï¼š\nè¦ä½¿ç”¨F_SETSIGå¸¸é‡å€¼å¿…é¡»åœ¨å…¶æºæ–‡ä»¶å¼€å¤´åŒ…å«å®å®šä¹‰â€œ#define __USE_GNUâ€æˆ–è€…â€œ#define _GNU_SOURCEâ€ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡GCC -Dæ¥æŒ‡å®šå®ã€‚ä¸è¿‡æ¨èä½¿ç”¨å®_GNU_SOURCEè€Œä¸æ˜¯__USE_GNUå®ã€‚åŸå› æ˜¯ï¼ŒåŒåˆ’çº¿å¼€å¤´çš„å®ä¸€èˆ¬æ˜¯ç”±ç³»ç»Ÿä¸­çš„å¤´æ–‡ä»¶å¯¹å…¶è¿›è¡Œå®šä¹‰ã€æ‰©å±•ï¼Œè€Œä¸æ˜¯åœ¨æ™®é€šåº”ç”¨ç¨‹åºä¸­ã€‚\n å¯ä»¥çœ‹åˆ°æ‰€è°“çš„å®æ—¶ä¿¡å·é©±åŠ¨IOæ¨¡å‹å°±æ˜¯åˆ©ç”¨äº†O_ASYNCæ¥ä½¿å¾—å½“æè¿°ç¬¦å¯è¯»ã€å†™æ—¶å‘é€é€šçŸ¥ä¿¡å·ï¼ˆé‡‡ç”¨éå¸¸è§„å¯æ’é˜Ÿçš„POSIXå®æ—¶ä¿¡å·ï¼‰ä»è€Œä½¿å¾—è¿›ç¨‹å¯ä»¥å¼‚æ­¥æ‰§è¡Œã€‚\nè¯¥æ¨¡å‹æœ‰ä¸€äº›ç¼ºç‚¹ï¼š\n O_ASYNCä»…èƒ½å·¥ä½œäºsocketæè¿°ç¬¦ä¸Šï¼Œè€Œä¸èƒ½å·¥ä½œäºç®¡é“ï¼ˆpipeï¼‰æˆ–ä¸­æ–­ï¼ˆttyï¼‰ä¸Šï¼› O_ASYNCä¸ºè¾¹ç¼˜è§¦å‘æ–¹å¼ï¼Œå› æ­¤äº‹ä»¶å¤„ç†å‡½æ•°å¿…é¡»å®Œæ•´çš„å®ŒæˆæŸä¸ªäº‹ä»¶å¤„ç†åŠ¨ä½œï¼ˆæ¯”å¦‚è¯»å–æ•°æ®åˆ™å¿…é¡»è¯»å–å®Œï¼‰ï¼Œå¦åˆ™ä¸èƒ½ä¿è¯è¿›ç¨‹å¯é çš„å†æ¬¡æ¥æ”¶åˆ°ä¿¡å·é€šçŸ¥ï¼›   å¤‡æ³¨ï¼š\nRTSIGçš„å®ç°ä¸è¿›ç¨‹æ€æ ·åˆ†æ´¾ä¿¡å·å¯†åˆ‡ç›¸å…³ï¼Œå¯¹æ¯ä¸€ä¸ªå‘ç”Ÿçš„äº‹ä»¶å°±é€’äº¤ä¸€ä¸ªä¿¡å·é€šçŸ¥å°†æ˜¯ååˆ†æµªè´¹çš„ï¼Œå› æ­¤ä¸€èˆ¬è€ƒè™‘ä½¿ç”¨sigtimedwait()å‡½æ•°æ¥é˜»å¡ç­‰å¾…è¿›ç¨‹å…³å¿ƒçš„ä¿¡å·ï¼Œå¹¶ä¸”ç»“åˆåˆ©ç”¨poll()å‡½æ•°å®ç°å¯¹æè¿°ç¬¦äº‹ä»¶çš„æ°´å¹³è§¦å‘æ•ˆæœã€‚\n æ®æŸäº›å¼€å‘äººå‘˜æµ‹è¯•ï¼Œåœ¨ä¸€å®šæ¡ä»¶ä¸‹çš„å®æ—¶ä¿¡å·é©±åŠ¨IOæ¨¡å‹è¡¨ç°æ€§èƒ½æ¯”å…¶ä»–åŸºäºpollçš„IOæ¨¡å‹éƒ½è¦å¥½ï¼Œä½†æ˜¯è¿™ç§æ–¹æ¡ˆä¼¼ä¹å¹¶ä¸å¯é ï¼Œå¾ˆå¤šå¼€å‘äººå‘˜ç»™å‡ºçš„å»ºè®®å°±æ˜¯ä¸è¦ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚\nä¸‹é¢ç»™å‡ºäº†ä¸€ä¸ªåˆ©ç”¨RTSIG IOçš„ç¼–ç¨‹èŒƒä¾‹ã€‚\n// å±è”½ä¸å…³å¿ƒçš„ä¿¡å· sigset_t all; sigfillset(\u0026amp;all); sigdelset(\u0026amp;all, SIGINT); sigprocmask(SIG_SETMASK, \u0026amp;all, NULL); // æ–°å»ºå¹¶åˆå§‹åŒ–å…³å¿ƒçš„ä¿¡å· sigset_t sigset; siginfo_t siginfo; // sigwaitinfoè°ƒç”¨æ—¶ä¼šé˜»å¡ï¼Œé™¤éæ”¶åˆ°waitçš„ä¿¡å·é›†ä¸­çš„æŸä¸ªä¿¡å· sigemptyset(\u0026amp;sigset); sigaddset(\u0026amp;sigset, SIGRTMIN + 1); // socketé…ç½®å’Œç›‘å¬ sock = socket(...); bind(sock, ...); listen(sock, ...); // é‡æ–°è®¾ç½®æè¿°ç¬¦å¯è¯»å†™æ—¶è¦å‘é€çš„ä¿¡å·å€¼ fcntl(sock, F_SETSIG, SIGRTMIN + 1); // å¯¹socketæè¿°ç¬¦è®¾ç½®æ‰€æœ‰è€… fcntl(sock, F_SETOWN, getpid()); // å¯ç”¨æè¿°ç¬¦çš„ä¿¡å·é©±åŠ¨IOæ¨¡å¼ int flags = fcntl(sock, F_GETFL); fcntl(sock, F_SETFL, flags|O_ASYNC|O_NONBLOCK); while(1) { struct timespec ts; ts.tv_sec = 1; ts.tv_nsec = 0; // è°ƒç”¨sigtimedwaité˜»å¡ç­‰å¾…ï¼Œç­‰å¾…äº‹ä»¶1s \u0026amp; sigwaitinfoä¼šä¸€ç›´é˜»å¡ // - é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥è¾¾åˆ°ä¸€ç§ç±»ä¼¼çº§åˆ«è§¦å‘çš„æ•ˆæœï¼Œä¸å†æ˜¯è¾¹ç¼˜è§¦å‘ï¼› // - è¾¹ç¼˜è§¦å‘æ•ˆæœï¼Œåº”è¯¥é€šè¿‡åŒä¸€ä¸ªsighandlerè¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯å¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼š // - å‡å¦‚ä¸åŒçš„è¿æ¥socketä½¿ç”¨ç›¸åŒçš„ä¿¡å·ï¼Œé‚£ä¹ˆsighandleré‡Œæ— æ³•åŒºåˆ†äº‹ä»¶å°±ç»ªçš„fdï¼› // - å‡å¦‚ä¸åŒçš„è¿æ¥socketä½¿ç”¨ä¸åŒçš„ä¿¡å·ï¼Œå®æ—¶ä¿¡å·æ•°é‡æœ‰é™SIGRTMIN~SIGRTMAXå¤§çº¦æ‰32ä¸ªï¼ //sigtimedwait(\u0026amp;sigset, \u0026amp;siginfo, \u0026amp;ts); sigwaitinfo(\u0026amp;sigset, \u0026amp;siginfo); // æµ‹è¯•æ˜¯å¦æœ‰å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚ if(siginfo.si_fd == sock) { new_sock = accept(sock, ...); fcntl(new_sock, F_SETSIG, SIGRTMIN + 1); fcntl(new_sock, F_SETOWN, getpid() + 1); fcntl(new_sock, F_SETFL, O_ASYNC|O_NONBLOCK|O_RDWR); } // å¯¹å…¶ä»–æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„è¯»å†™äº‹ä»¶è¿›è¡Œå¤„ç† else { doReadAction(i); doWriteAction(i); } }  ä¸Šé¢çš„ä»£ç çœ‹èµ·æ¥ä¼¼ä¹æŒºç®€å•ï¼Œå¾ˆå¤šäººçœ‹äº†ä¹‹åå¯èƒ½è¿˜å¾ˆæƒ³å°è¯•å¹¶åœ¨å®è·µä¸­åº”ç”¨ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œrtsig driven ioå¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ã€æœ‰æ•ˆï¼ä¸”å¬æˆ‘ç»†ç»†é“æ¥ï¼\n4.1 rtsigåœ¨udpä¸­åº”ç”¨ # rtsig driven ioåœ¨udp serverä¸­è¾ƒä¸ºç®€å•ï¼Œå› ä¸ºudpä¸­åªæœ‰ä¸¤ç§æƒ…å†µä¼šä¸ºfd raiseä¸€ä¸ªrtsigï¼š\n fdä¸Šæœ‰æ•°æ®åˆ°è¾¾ï¼› fdä¸Šioæ“ä½œæœ‰é”™è¯¯ï¼›  æˆ‘çš„repoé‡Œé¢æœ‰ä¸€ä¸ªåŸºäºrtsigå®ç°çš„udp serverï¼Œå®ç°èµ·æ¥å¾ˆç®€å•ï¼Œä¸éœ€è¦åšä»€ä¹ˆç‰¹æ®Šå¤„ç†é€»è¾‘å°±å¯ä»¥è½»æ¾å®ç°ï¼Œè™½ç„¶è¯´rtsigä¸æ€ä¹ˆè¢«çœ‹å¥½å§ï¼Œä½†æ˜¯è‡³å°‘æœ‰ä¸ªæœåŠ¡ntpè¿˜æ˜¯ä½¿ç”¨çš„rtsig \u0026amp; udpæ¥å®ç°çš„ï¼Œå¯æ˜¯tcpå°±ä¸åŒäº†ï¼Œå¥½åƒè¿˜æ²¡æœ‰ä¸€ä¸ªtcp serveræ˜¯åŸºäºrtsigå®ç°çš„ï¼Œå¾ˆå¤šäººéƒ½åå¯¹åœ¨tcpä¸­åº”ç”¨rtsigï¼Œå› ä¸ºå¤ªå•°å—¦è€Œä¸”å¾ˆâ€œæ²¡ç”¨â€ï¼Œæ¯ä¸ªioäº‹ä»¶éƒ½raiseä¸€ä¸ªä¿¡å·ä¹Ÿæ˜¯ä¸ªç´¯èµ˜ï¼Œè¦åˆ¤æ–­çš„å¯èƒ½çš„ioçŠ¶æ€å¤ªå¤šã€‚\nä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»æŸ¥çœ‹åŸºäºrtsigå®ç°çš„udp serverç¤ºä¾‹ï¼š[click to see rtsig-udp-server]ã€‚\n4.2 rtsigåœ¨tcpä¸­åº”ç”¨ # rtsig drive ioåœ¨tcp serverä¸­å®ç°å°±å¤æ‚å¤šäº†ï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªfdæœ‰7ç§å¯èƒ½çš„æƒ…æ™¯ä¼šä¸ºå…¶raiseä¸€ä¸ªrtsigï¼š\n fdä¸Šå®Œæˆäº†ä¸€ä¸ªå»ºç«‹è¿æ¥çš„è¯·æ±‚ï¼› fdä¸Šå‘èµ·äº†ä¸€ä¸ªæ–­å¼€è¿æ¥çš„è¯·æ±‚ï¼› fdä¸Šå®Œæˆäº†ä¸€ä¸ªæ–­å¼€è¿æ¥çš„è¯·æ±‚ï¼› fdä¸Šæœ‰æ•°æ®åˆ°è¾¾ï¼› fdä¸Šæœ‰æ•°æ®å†™å‡ºï¼› fdä¸ŠåŠè¿æ¥å…³é—­ï¼› fdä¸Šæœ‰é”™è¯¯å‘ç”Ÿï¼›  è¿™ä¹ˆå¤šçš„æƒ…æ™¯éœ€è¦ä½œå¾ˆå¤šé¢å¤–çš„åˆ¤æ–­æ‰èƒ½åŠ ä»¥åŒºåˆ†ï¼Œæ‰€ä»¥å¾ˆå¤šå¼€å‘äººå‘˜å»ºè®®åœ¨tcpä¸­åªå°†rtsigåº”ç”¨åœ¨ç›‘å¬å¥—æ¥å­—sock_listenä¸Šï¼Œå¯¹äºè¿æ¥å¥—æ¥å­—è¿˜æ˜¯åŸºäºselectã€pollã€epollæ¥æ“ä½œï¼Œå…¶å®å³ä¾¿è¿™æ ·ä¹Ÿæ˜¯è´¹åŠ›ä¸è®¨å¥½ï¼Œå› ä¸ºrtsigä¹Ÿå­˜åœ¨å¯èƒ½ä¸¢å¤±çš„é—®é¢˜ï¼è€Œä¸”å®ƒæ˜¯è¾¹ç¼˜è§¦å‘ï¼Œå¯¹ç¨‹åºå‘˜è¦æ±‚ä¹Ÿæ¯”è¾ƒé«˜ã€‚å»ºè®®è¿˜æ˜¯ç”¨epollå§ï¼\nè¿™é‡Œçš„tcp serverä¸­é‡‡ç”¨çš„æ˜¯é€šè¿‡sigtimedwait/sigwaitinfo \u0026amp; siginfo_t.si_fdæ¥åŒºåˆ†æ”¶åˆ°rtsigçš„è¿æ¥å¥—æ¥å­—ã€ç›‘å¬å¥—æ¥å­—çš„ï¼Œç„¶åå†é’ˆå¯¹æ€§åœ°è¿›è¡Œioå¤„ç†ï¼åœ¨æˆ‘ä»¬çš„å¦ä¸€ä¸ªåŸºäºrtsigçš„tcpserverå®ç°ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åŒä¸€ä¸ªsighandleræ”¶åˆ°SIGIOä¿¡å·æ—¶å»ºç«‹tcpè¿æ¥å¹¶éšå³é€‰æ‹©ä¸€ä¸ªè¿æ¥è¿›è¡Œå¤„ç†ï¼Œè™½ç„¶æˆ‘ä»¬å®ç°äº†ï¼Œä¸è¿‡ä¹Ÿä¸æ˜¯ä¸€ä¸ªç‰¹åˆ«cleançš„æ–¹æ³•ï¼Œä¸å»ºè®®ä½¿ç”¨rtsig driven ioï¼Œè¿˜æ˜¯ç”¨IOå¤šè·¯å¤ç”¨æ¥çš„æ¸…çˆ½ï¼\nä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»æŸ¥çœ‹åŸºäºrtsigå®ç°çš„tcp serverç¤ºä¾‹ï¼š\n ç¤ºä¾‹1ï¼ŒåŸºäºsigtimedwait/sigwaitinfo \u0026amp; siginfo_t.si_fdæ¥åŒºåˆ†è¿æ¥fdï¼Œ[click to see rtsig-tcp-server-1]ï¼› ç¤ºä¾‹2ï¼ŒåŸºäºsighandlerä»¥åŠä¸€ç‚¹å°æŠ€å·§å®ç°çš„å¯¹å¤šä¸ªè¿æ¥fdè¿›è¡Œå¤„ç†ï¼Œ[click to see rtsig-tcp-server-2]ï¼›  5. å¼‚æ­¥IOæ¨¡å‹ # å¼‚æ­¥IOä¹Ÿæ˜¯å±äºPOSIXè§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼Œç±»ä¼¼å®æ—¶ä¿¡å·é©±åŠ¨IOçš„å¼‚æ­¥é€šçŸ¥æœºåˆ¶ï¼Œè¿™ä¹Ÿä½¿å¾—å¼‚æ­¥IOæ¨¡å‹å¸¸å¸¸ä¸åè€…ç›¸æ··æ·†ã€‚ä¸åè€…çš„åŒºåˆ«åœ¨äºï¼Œå¯ç”¨å¼‚æ­¥IOæ„å‘³ç€å‘ŠçŸ¥å†…æ ¸å¯åŠ¨æŸä¸ªIOæ“ä½œï¼Œå¹¶è®©å†…æ ¸åœ¨æ•´ä¸ªæ“ä½œï¼ˆåŒ…æ‹¬å°†æ•°æ®ä»å†…æ ¸å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼‰å®Œæˆæ—¶é€šçŸ¥æˆ‘ä»¬ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®æ—¶ä¿¡å·é©±åŠ¨IOæ˜¯ç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬ä½•æ—¶å¯ä»¥å¯åŠ¨ä¸€ä¸ªIOæ“ä½œï¼Œè€Œåœ¨å¼‚æ­¥IOæ¨¡å‹ä¸­ï¼Œæ˜¯ç”±å†…æ ¸é€šçŸ¥æˆ‘ä»¬IOæ“ä½œä½•æ—¶å®Œæˆï¼Œå³å®é™…çš„IOæ“ä½œæ˜¯å¼‚æ­¥çš„ã€‚\n5.1. AIO APIè¯´æ˜ # ä¸‹é¢çš„å†…å®¹æ‘˜è‡ªLinux manæ‰‹å†Œï¼Œå…¶å¯¹POSIXä¸‹çš„AIOæ¥å£ã€å®ç°åšäº†ä¸€ä¸ªåŸºç¡€çš„ä»‹ç»ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å°†æŠŠAIOåº”ç”¨äºåå°æœåŠ¡ä¸­ã€‚\nPOSIX AIOæ¥å£å…è®¸åº”ç”¨ç¨‹åºå‘èµ·ä¸€ä¸ªæˆ–è€…å¤šä¸ªIOæ“ä½œï¼Œè¿™äº›IOæ“ä½œæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå³ç›¸æ¯”äºå½“å‰å‘èµ·IOæ“ä½œçš„çº¿ç¨‹æ¥è¯´è¿™äº›å®é™…çš„IOæ“ä½œæ˜¯åœ¨â€œåå°â€è¿è¡Œçš„ã€‚IOæ“ä½œå®Œæˆæ—¶ï¼Œå¯ä»¥é€‰æ‹©å¤šç§æ–¹å¼æ¥é€šçŸ¥åº”ç”¨ç¨‹åºå®Œæˆè¿™ä¸€äº‹ä»¶ï¼Œä¾‹å¦‚ï¼š\n ä¼ é€’ä¸€ä¸ªä¿¡å·ç»™åº”ç”¨ç¨‹åºé€šçŸ¥å…¶IOæ“ä½œå®Œæˆï¼› åœ¨åº”ç”¨ç¨‹åºä¸­é¢å¤–å®ä¾‹åŒ–ä¸€ä¸ªçº¿ç¨‹æ¥å¯¹IOå®Œæˆæ“ä½œè¿›è¡Œåå¤„ç†ï¼› ä¹Ÿå¯èƒ½æ ¹æœ¬ä¸ä¼šé€šçŸ¥åº”ç”¨ç¨‹åºï¼›  å‰é¢ç¬¬4èŠ‚è®²è¿‡çš„rtsig driven ioä¹Ÿå¯ä»¥ç®—æ˜¯å¼‚æ­¥çš„ï¼Œä»å…¶å½“æ—¶ä½¿ç”¨çš„é€‰é¡¹O_ASYNCå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œä¹Ÿå¯ä»¥ç§°å…¶ä¸ºAIOï¼ˆAsynchronous IOï¼‰ï¼Œä½†æ˜¯å‘¢ï¼Œè¿™é‡Œæœ¬èŠ‚æ‰€æåˆ°çš„AIOä¸»è¦æŒ‡çš„æ˜¯POSIXè§„èŒƒé‡Œé¢å®šä¹‰çš„AIO APIã€‚\n5.1.1. POSIX AIO API # POSIX AIOæ¥å£åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªå‡½æ•°ï¼š\n aio_read(3)ï¼šå…¥é˜Ÿä¸€ä¸ªreadè¯·æ±‚ï¼Œå®ƒæ˜¯readçš„å¼‚æ­¥æ“ä½œç‰ˆæœ¬ï¼› aio_write(3)ï¼šå…¥é˜Ÿä¸€ä¸ªwriteè¯·æ±‚ï¼Œå®ƒæ˜¯writeçš„å¼‚æ­¥æ“ä½œç‰ˆæœ¬ï¼› aio_fsync(3)ï¼šå…¥é˜Ÿä¸€ä¸ªsyncè¯·æ±‚ï¼ˆé’ˆå¯¹æŸä¸ªfdä¸Šçš„IOæ“ä½œï¼‰ï¼Œå®ƒæ˜¯fsyncå’Œfdatasyncçš„å¼‚æ­¥ç‰ˆæœ¬ï¼› aio_error(3)ï¼šè·å–ä¸€ä¸ªå·²å…¥é˜Ÿçš„IOè¯·æ±‚çš„é”™è¯¯çŠ¶æ€ä¿¡æ¯ï¼› aio_return(3)ï¼šè·å–ä¸€ä¸ªå·²å®Œæˆçš„IOè¯·æ±‚çš„è¿”å›çŠ¶æ€ä¿¡æ¯ï¼› aio_suspend(3)ï¼šæŒ‚èµ·IOè¯·æ±‚çš„å‘èµ·è€…ï¼Œç›´åˆ°æŒ‡å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ªIOäº‹ä»¶å®Œæˆï¼› aio_cancel(3)ï¼šå°è¯•å–æ¶ˆå·²ç»å‘èµ·çš„æŸä¸ªç‰¹å®šfdä¸Šçš„æœªå®Œæˆçš„IOè¯·æ±‚ï¼› lio_listio(3)ï¼šä½¿ç”¨è¿™ä¸€ä¸ªå‡½æ•°å¯ä»¥ä¸€æ¬¡æ€§å…¥é˜Ÿå¤šä¸ªIOè¯·æ±‚ï¼›  5.1.2. Linux AIO SysCall # é€šè¿‡ä¸Šé¢å‡ ä¸ªå‡½æ•°åé¢çš„â€œ(3)â€å¯ä»¥çŸ¥é“ï¼Œä¸Šè¿°å‡ ä¸ªå‡½æ•°éƒ½æ˜¯æ™®é€šçš„libcåº“å‡½æ•°ï¼Œè€Œä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œå®é™…ä¸Šä¸Šè¿°è¿™äº›çº¯ç”¨æˆ·æ€çš„åº“å‡½æ•°æ˜¯åŸºäº5ä¸ªç³»ç»Ÿè°ƒç”¨æ¥å®ç°çš„ï¼Œå®ƒä»¬æ˜¯ï¼š\n io_setup(2) - int io_setup(unsigned nr_events, aio_context_t *ctx_idp)\nè¯¥å‡½æ•°åœ¨å†…æ ¸ä¸­ä¸ºè¿›ç¨‹åˆ›å»ºä¸€ä¸ªAIO Contextï¼ŒAIO Contextæ˜¯å¤šä¸ªæ•°æ®ç»“æ„çš„é›†åˆï¼Œç”¨äºæ”¯æŒå†…æ ¸çš„AIOæ“ä½œã€‚æ¯ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªAIO Contextï¼Œæ¯ä¸€ä¸ªAIO Contextéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ŒAIO Contextç±»å‹aio_context_tå˜é‡ä½œä¸ºio_setupçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå†…æ ¸ä¼šè®¾ç½®å…¶å¯¹åº”çš„å€¼ï¼Œå®é™…ä¸Šè¿™ä¸ªaio_context_tç±»å‹ä»…ä»…æ˜¯ä¸€ä¸ªunsigned longç±»å‹(typedef unsigned long aio_context_tï¼‰ï¼Œio_setupçš„ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºaio_context_tå˜é‡è¦æ”¯æŒçš„åŒæ—¶å‘èµ·çš„IOè¯·æ±‚çš„æ•°é‡ã€‚ io_destroy(2) - int io_destroy(aio_context_t ctx_id)\nè¯¥å‡½æ•°ç”¨äºé”€æ¯AIO Contextå˜é‡ï¼Œé”€æ¯ä¹‹å‰æœ‰ä¸¤ä¸ªæ“ä½œï¼Œé¦–å…ˆå–æ¶ˆåŸºäºè¯¥aio_context_tå‘èµ·çš„æœªå®Œæˆçš„AIOè¯·æ±‚ï¼Œç„¶åå¯¹äºæ— æ³•å–æ¶ˆçš„AIOè¯·æ±‚å°±é˜»å¡å½“å‰è¿›ç¨‹ç­‰å¾…å…¶æ‰§è¡Œå®Œæˆï¼Œæœ€åé”€æ¯AIO Contextã€‚ io_submit(2) - int io_submit(aio_context_t ctx_id, long nr, struct iocb **iocbpp)\nè¯¥å‡½æ•°å°†å‘aio_context_t ctx_idä¸Šæäº¤nrä¸ªIOè¯·æ±‚ï¼Œæ¯ä¸ªIOè¯·æ±‚æ˜¯ç”±ä¸€ä¸ªaio control blockæ¥æŒ‡ç¤ºçš„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°struct iocb **iocbppæ˜¯ä¸€ä¸ªaioæ§åˆ¶å—çš„æŒ‡é’ˆæ•°ç»„ã€‚ io_getevents(2) - int io_getevents(aio_context_t ctx_id, long min_nr, long nr, struct io_event *events, struct timespec *timeout)\nç­‰å¾…aio_context_t ctx_idå…³è”çš„aioè¯·æ±‚å·²å®Œæˆé˜Ÿåˆ—ä¸­è¿”å›æœ€å°‘min_nrä¸ªäº‹ä»¶ï¼Œæœ€å¤šnrä¸ªäº‹ä»¶ï¼Œå¦‚æœæŒ‡å®šäº†timeoutåˆ™æœ€å¤šç­‰å¾…è¯¥æŒ‡å®šçš„æ—¶é—´ï¼Œå¦‚æœtimeoutä¸ºNULLåˆ™è‡³å°‘ç­‰å¾…min_nrä¸ªäº‹ä»¶è¿”å›ã€‚ io_cancel(2) - int io_cancel(aio_context_t ctx_id, struct iocb *iocb, struct io_event *result)\nè¯¥å‡½æ•°å–æ¶ˆä¹‹å‰æäº¤åˆ°aio_context_t ctx_idçš„ä¸€ä¸ªAIOè¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚ç”±struct iocb *iocbæ ‡è¯†ï¼Œå¦‚æœè¿™ä¸ªAIOè¯·æ±‚æˆåŠŸå–æ¶ˆäº†ï¼Œå¯¹åº”çš„äº‹ä»¶å°†è¢«æ‹·è´åˆ°ç¬¬ä¸‰ä¸ªå‚æ•°struct io_event *resultæŒ‡å‘çš„å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯å°†å…¶æ”¾åœ¨å·²å®Œæˆé˜Ÿåˆ—ä¸­ã€‚   å¤‡æ³¨ï¼š\nä¸Šè¿°å‡ ä¸ªå†…æ ¸ä¸­çš„å‡½æ•°io_setupã€io_destroyã€io_submitã€io_geteventsã€io_cancelï¼Œlibcä¸­å¹¶æ²¡æœ‰æä¾›å¯¹åº”çš„wrapperå‡½æ•°ä¾›æˆ‘ä»¬è°ƒç”¨ï¼Œå¦‚æœè¦ä½¿ç”¨è¿™äº›å‡½æ•°çš„è¯ï¼Œå¯ä»¥é€šè¿‡syscall(2)æ¥è°ƒç”¨ï¼Œä»¥è°ƒç”¨io_setupä¸ºä¾‹ï¼šsyscall(__NR_io_setup, hr, ctxp)ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å‘èµ·ç³»ç»Ÿè°ƒç”¨çš„å¸¸è§æ–¹å¼ã€‚\nä½†æ˜¯å‘¢ï¼Œlibaioåº“é‡Œé¢æä¾›äº†å¯¹åº”çš„wrapperå‡½æ•°ï¼Œä½†æ˜¯å…¶å‚æ•°ç±»å‹ä¸è¿™é‡Œæœ‰ç‚¹å·®å¼‚ï¼Œè€Œä¸”è¿”å›å€¼çš„å«ä¹‰ä¹Ÿå­˜åœ¨ä¸€äº›å·®å¼‚ï¼Œä¸æ˜¯å¾ˆå»ºè®®ä½¿ç”¨ã€‚\n 5.2. AIOæ“ä½œç¤ºä¾‹ # 5.2.1. Kernel AIO SysCall # ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºäºå†…æ ¸AIOç³»ç»Ÿè°ƒç”¨çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œç¨‹åºæ‰“å¼€ä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ï¼Œå¹¶å°†ä¸€æ®µç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ã€‚\n#define _GNU_SOURCE /* syscall() is not POSIX */ #include \u0026lt;stdio.h\u0026gt; /* for perror() */ #include \u0026lt;unistd.h\u0026gt; /* for syscall() */ #include \u0026lt;sys/syscall.h\u0026gt; /* for __NR_* definitions */ #include \u0026lt;linux/aio_abi.h\u0026gt; /* for AIO types and constants */ #include \u0026lt;fcntl.h\u0026gt; /* O_RDWR */ #include \u0026lt;string.h\u0026gt; /* memset() */ #include \u0026lt;inttypes.h\u0026gt; /* uint64_t */ inline int io_setup(unsigned nr, aio_context_t * ctxp) { return syscall(__NR_io_setup, nr, ctxp); } inline int io_destroy(aio_context_t ctx) { return syscall(__NR_io_destroy, ctx); } inline int io_submit(aio_context_t ctx, long nr, struct iocb **iocbpp) { return syscall(__NR_io_submit, ctx, nr, iocbpp); } inline int io_getevents(aio_context_t ctx, long min_nr, long max_nr, struct io_event *events, struct timespec *timeout) { return syscall(__NR_io_getevents, ctx, min_nr, max_nr, events, timeout); } int main() { int fd = open(\u0026quot;./testfile\u0026quot;, O_RDWR|O_CREAT, S_IRUSR|S_IWUSR); if (fd \u0026lt; 0) { perror(\u0026quot;open error\u0026quot;); return -1; } // init aio context aio_context_t ctx = 0; int ret = io_setup(128, \u0026amp;ctx); if (ret \u0026lt; 0) { perror(\u0026quot;io_setup error\u0026quot;); return -1; } // setup I/O control block struct iocb cb; memset(\u0026amp;cb, 0, sizeof(cb)); cb.aio_fildes = fd; cb.aio_lio_opcode = IOCB_CMD_PWRITE; // command-specific options char data[4096] = \u0026quot;i love you, dad!\\n\u0026quot;; cb.aio_buf = (uint64_t) data; cb.aio_offset = 0; cb.aio_nbytes = strlen(data); struct iocb *cbs[1]; cbs[0] = \u0026amp;cb; ret = io_submit(ctx, 1, cbs); if (ret != 1) { if (ret \u0026lt; 0) perror(\u0026quot;io_submit error\u0026quot;); else fprintf(stderr, \u0026quot;could not sumbit IOs\u0026quot;); return -1; } // get the reply struct io_event events[1]; ret = io_getevents(ctx, 1, 1, events, NULL); printf(\u0026quot;%d io ops completed\\n\u0026quot;, ret); ret = io_destroy(ctx); if (ret \u0026lt; 0) { perror(\u0026quot;io_destroy error\u0026quot;); return -1; } return 0; }  ä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹åŸºäºaioçš„fileioç¤ºä¾‹1ï¼Œ[click to see aio-based-fileio]ã€‚\n5.2.2. POSIX AIO API # POSIX AIO APIå®ç°åŸºäºä¸Šè¿°5ä¸ªAIOç³»ç»Ÿè°ƒç”¨ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹åŸºäºPOSIX AIO APIçš„ç¤ºä¾‹ã€‚ç¨‹åºè¯»å–å‘½ä»¤è¡Œå‚æ•°ä¸­æŒ‡å®šçš„æ–‡ä»¶ï¼Œå¹¶è¯»å–æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œç¨‹åºè¿˜ä¼šåœ¨å¼‚æ­¥IOè¿‡ç¨‹ä¸­æ£€æŸ¥IOæ“ä½œçš„é”™è¯¯ä¿¡æ¯ã€çŠ¶æ€ä¿¡æ¯ã€‚\nåœ¨5.1.1èŠ‚ä¸­åˆ—å‡ºäº†POSIX AIO APIå¯¹åº”çš„å‡½æ•°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°ç±»å‹â€œAIOè¯·æ±‚æ§åˆ¶å—â€ç±»å‹ï¼Œå³struct aiocbï¼Œä¸‹é¢æ˜¯è¯¥ç»“æ„ä½“çš„å®šä¹‰ï¼š\n// å¼‚æ­¥ioè¯·æ±‚æ§åˆ¶å— struct aiocb { int aio_fildes; // ioæ“ä½œå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ off_t aio_offset; // æ–‡ä»¶è¯»å†™æ“ä½œä½ç½®çš„åç§»é‡ volatile void *aio_buf; // å¼‚æ­¥ioæ“ä½œå¯¹åº”çš„æ•°æ®ç¼“å†²åŒº size_t aio_nbytes; // aio_bufçš„å®¹é‡ int aio_reqprio; // aioæ“ä½œçš„ä¼˜å…ˆçº§ï¼ˆä¸€èˆ¬ç»§æ‰¿è‡ªå‘èµ·aioæ“ä½œçš„çº¿ç¨‹ï¼‰ struct sigevent aio_sigevent; // aioæ“ä½œå®Œæˆæ—¶å¦‚ä½•é€šçŸ¥åº”ç”¨ç¨‹åº int aio_lio_opcode; // aioæ“ä½œå‘½ä»¤ };  å…¶ä¸­aio_sigeventå®šä¹‰å¦‚ä¸‹ï¼š\n// Data passed with notification union sigval { int sival_int; // Integer value void *sival_ptr; // Pointer value }; struct sigevent { int sigev_notify; // Notification method // - SIGEV_NONEï¼Œä¸ä½œå¤„ç† // - SIGEV_SIGNALï¼Œå‘é€ä¿¡å· // - SIGEV_THREADï¼Œå®ä¾‹åŒ–ä¸€ä¸ªçº¿ç¨‹ int sigev_signo; // Notification signal union sigval sigev_value; // Data passed with notification // Function used for thread notification (SIGEV_THREAD) void (*sigev_notify_function) (union sigval); // Attributes for notification thread (SIGEV_THREAD) void *sigev_notify_attributes; // ID of thread to signal (SIGEV_THREAD_ID) pid_t sigev_notify_thread_id; };  ä¸‹é¢æ˜¯ç¤ºä¾‹ç¨‹åºçš„æºä»£ç ï¼š\n#include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;aio.h\u0026gt; #include \u0026lt;signal.h\u0026gt; // Size of buffers for read operations #define BUF_SIZE 20 #define errExit(msg) do { perror(msg); exit(EXIT_FAILURE); } while (0) #define errMsg(msg) do { perror(msg); } while (0) /* Application-defined structure for tracking I/O requests */ struct ioRequest { int reqNum; int status; struct aiocb *aiocbp; }; // On delivery of SIGQUIT, we attempt to cancel all outstanding I/O requests static volatile sig_atomic_t gotSIGQUIT = 0; // Handler for SIGQUIT static void quitHandler(int sig) { gotSIGQUIT = 1; } // Signal used to notify I/O completion #define IO_SIGNAL SIGUSR1 // Handler for I/O completion signal static void aioSigHandler(int sig, siginfo_t *si, void *ucontext) { if (si-\u0026gt;si_code == SI_ASYNCIO) { write(STDOUT_FILENO, \u0026quot;I/O completion signal received\\n\u0026quot;, 31); // The corresponding ioRequest structure would be available as: // struct ioRequest *ioReq = si-\u0026gt;si_value.sival_ptr; // // and the file descriptor would then be available via: // int fd = ioReq-\u0026gt;aiocbp-\u0026gt;aio_fildes; } } int main(int argc, char *argv[]) { if (argc \u0026lt; 2) { fprintf(stderr, \u0026quot;Usage: %s \u0026lt;pathname\u0026gt; \u0026lt;pathname\u0026gt;...\\n\u0026quot;, argv[0]); exit(EXIT_FAILURE); } int numReqs = argc - 1; // Total number of queued I/O requests, i.e, num of files listed on cmdline /* Allocate our arrays */ struct ioRequest *ioList = calloc(numReqs, sizeof(struct ioRequest)); if (ioList == NULL) errExit(\u0026quot;calloc\u0026quot;); struct aiocb *aiocbList = calloc(numReqs, sizeof(struct aiocb)); if (aiocbList == NULL) errExit(\u0026quot;calloc\u0026quot;); // Establish handlers for SIGQUIT and the I/O completion signal // - SIGQUIT struct sigaction sa; sa.sa_flags = SA_RESTART; sigemptyset(\u0026amp;sa.sa_mask); sa.sa_handler = quitHandler; if (sigaction(SIGQUIT, \u0026amp;sa, NULL) == -1) errExit(\u0026quot;sigaction\u0026quot;); // - IO_SIGNAL, actually it's SIGUSR1 sa.sa_flags = SA_RESTART | SA_SIGINFO; sa.sa_sigaction = aioSigHandler; if (sigaction(IO_SIGNAL, \u0026amp;sa, NULL) == -1) errExit(\u0026quot;sigaction\u0026quot;); // Open each file specified on the command line, and queue a read request // on the resulting file descriptor int j; for (j = 0; j \u0026lt; numReqs; j++) { ioList[j].reqNum = j; ioList[j].status = EINPROGRESS; ioList[j].aiocbp = \u0026amp;aiocbList[j]; ioList[j].aiocbp-\u0026gt;aio_fildes = open(argv[j + 1], O_RDONLY); if (ioList[j].aiocbp-\u0026gt;aio_fildes == -1) errExit(\u0026quot;open\u0026quot;); printf(\u0026quot;opened %s on descriptor %d\\n\u0026quot;, argv[j + 1], ioList[j].aiocbp-\u0026gt;aio_fildes); ioList[j].aiocbp-\u0026gt;aio_buf = malloc(BUF_SIZE); if (ioList[j].aiocbp-\u0026gt;aio_buf == NULL) errExit(\u0026quot;malloc\u0026quot;); ioList[j].aiocbp-\u0026gt;aio_nbytes = BUF_SIZE; ioList[j].aiocbp-\u0026gt;aio_reqprio = 0; ioList[j].aiocbp-\u0026gt;aio_offset = 0; ioList[j].aiocbp-\u0026gt;aio_sigevent.sigev_notify = SIGEV_SIGNAL; ioList[j].aiocbp-\u0026gt;aio_sigevent.sigev_signo = IO_SIGNAL; ioList[j].aiocbp-\u0026gt;aio_sigevent.sigev_value.sival_ptr = \u0026amp;ioList[j]; int s = aio_read(ioList[j].aiocbp); if (s == -1) errExit(\u0026quot;aio_read\u0026quot;); } // Number of requests still in progress int openReqs = numReqs; // Loop, monitoring status of I/O requests while (openReqs \u0026gt; 0) { sleep(3); /* Delay between each monitoring step */ if (gotSIGQUIT) { // On receipt of SIGQUIT, attempt to cancel each of the // outstanding I/O requests, and display status returned from the // cancellation requests printf(\u0026quot;got SIGQUIT; canceling I/O requests: \\n\u0026quot;); for (j = 0; j \u0026lt; numReqs; j++) { if (ioList[j].status == EINPROGRESS) { printf(\u0026quot;Request %d on descriptor %d:\u0026quot;, j, ioList[j].aiocbp-\u0026gt;aio_fildes); int s = aio_cancel(ioList[j].aiocbp-\u0026gt;aio_fildes, ioList[j].aiocbp); if (s == AIO_CANCELED) printf(\u0026quot;I/O canceled\\n\u0026quot;); else if (s == AIO_NOTCANCELED) printf(\u0026quot;I/O not canceled\\n\u0026quot;); else if (s == AIO_ALLDONE) printf(\u0026quot;I/O all done\\n\u0026quot;); else errMsg(\u0026quot;aio_cancel\u0026quot;); } } gotSIGQUIT = 0; } // Check the status of each I/O request that is still in progress printf(\u0026quot;aio_error():\\n\u0026quot;); for (j = 0; j \u0026lt; numReqs; j++) { if (ioList[j].status == EINPROGRESS) { printf(\u0026quot;for request %d (descriptor %d): \u0026quot;, j, ioList[j].aiocbp-\u0026gt;aio_fildes); ioList[j].status = aio_error(ioList[j].aiocbp); switch (ioList[j].status) { case 0: printf(\u0026quot;I/O succeeded\\n\u0026quot;); break; case EINPROGRESS: printf(\u0026quot;In progress\\n\u0026quot;); break; case ECANCELED: printf(\u0026quot;Canceled\\n\u0026quot;); break; default: errMsg(\u0026quot;aio_error\u0026quot;); break; } if (ioList[j].status != EINPROGRESS) openReqs--; } } } printf(\u0026quot;All I/O requests completed\\n\u0026quot;); // Check status return of all I/O requests printf(\u0026quot;aio_return():\\n\u0026quot;); for (j = 0; j \u0026lt; numReqs; j++) { ssize_t s = aio_return(ioList[j].aiocbp); printf(\u0026quot;for request %d (descriptor %d): %zd\\n\u0026quot;, j, ioList[j].aiocbp-\u0026gt;aio_fildes, s); } exit(EXIT_SUCCESS); }  ä»£ç ç¤ºä¾‹ï¼š\nç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹åŸºäºaioçš„fileioç¤ºä¾‹2ï¼Œ[click to see aio-based-fileio2]ã€‚\nä¸‹é¢æ˜¯ç¨‹åºçš„æ‰§è¡Œæ•ˆæœï¼š\n// run: ./a.out f1 f2 // result: I/O completion signal received I/O completion signal received opened f1 on descriptor 3 opened f2 on descriptor 4 aio_error(): for request 0 (descriptor 3): I/O succeeded for request 1 (descriptor 4): I/O succeeded All I/O requests completed aio_return(): for request 0 (descriptor 3): 20 for request 1 (descriptor 4): 20  5.3 AIOåœ¨æœåŠ¡ç«¯å¼€å‘ä¸­çš„åº”ç”¨ # Linuxä¸‹çš„AIOï¼ŒKernel AIOæ˜¯çœŸæ­£çš„å¼‚æ­¥IOï¼Œä½†æ˜¯glibcä¸­çš„AIOæ˜¯åœ¨ç”¨æˆ·æ€ä¸­å®ç°çš„ï¼Œåˆ©ç”¨å¤šå¼€çš„çº¿ç¨‹æ¥æ¨¡æ‹Ÿå¼‚æ­¥é€šçŸ¥ï¼Œä½†æ˜¯è¿™ä¸ªçº¿ç¨‹é‡Œé¢çš„ioæ“ä½œå¹¶ä¸æ˜¯çœŸæ­£çš„å¼‚æ­¥ã€‚AIOæ›´å¤šçš„è¢«åº”ç”¨äºfile ioï¼Œè€Œä¸æ˜¯socket ioï¼Œstack overflowä¸Šæ›¾æœ‰äººæåˆ°ï¼ŒAIOåº”ç”¨åˆ°socketä¸Šå¹¶ä¸ä¼šè¿”å›æ˜æ˜¾çš„é”™è¯¯ï¼Œåªæ˜¯socketä¸Šçš„ioæ“ä½œä»ç„¶æ˜¯æŒ‰ç…§é»˜è®¤çš„â€œé˜»å¡åŒæ­¥â€å·¥ä½œæ–¹å¼æ‰§è¡Œï¼Œå¹¶ä¸æ˜¯å¼‚æ­¥, è¿™ä¸€ç‚¹åœ¨githubä¸Šçš„ä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿè¢«é‡ç‚¹æåˆ°ã€‚\n æ‘˜è‡ªgithub linux-aio\nBlocking during io_submit on ext4, on buffered operations, network access, pipes, etc. Some operations are not well-represented by the AIO interface. With completely unsupported operations like buffered reads, operations on a socket or pipes \u0026hellip;\n Asynchronous IOæ¨¡å‹ï¼ˆAIOï¼‰æ¯”äº‹ä»¶é©±åŠ¨çš„IOæ¨¡å‹è¦æ™šï¼Œè€Œä¸”äº‹ä»¶é©±åŠ¨çš„IOæ¨¡å‹å·²ç»éå¸¸æˆç†Ÿã€ç¨³å®šï¼Œå› æ­¤å¦‚æœè¦åŸºäºsocketå¼€å‘é«˜æ€§èƒ½serverï¼Œåº”è¯¥é¦–å…ˆäº‹ä»¶é©±åŠ¨çš„IOæ¨¡å‹ï¼Œå¦‚Linuxä¸‹çš„epollï¼ŒMac OS Xä¸‹çš„kqueueï¼ŒSolarisä¸‹çš„/dev/pollã€‚\né‚£ä¹ˆæ—¢ç„¶äº‹ä»¶é©±åŠ¨çš„IOæ¨¡å‹å·²ç»è¿™ä¹ˆæˆç†Ÿäº†ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦è®¾è®¡AIOå‘¢ï¼Ÿè®¾è®¡å®ƒçš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œæˆ‘åœ¨stack overflowä¸Šæ‰¾åˆ°äº†ä¸¤ä¸ªæœ€å…·æœ‰ä¿¡æœåŠ›çš„å›ç­”ï¼Œæ•´ç†åœ¨æ­¤ä»¥ä¾›å¤§å®¶å‚è€ƒã€‚\næ‘˜è‡ªstack overflow, ç‚¹å‡»æŸ¥çœ‹åŸæ–‡ï¼š\nåŸæ–‡å‡ºå¤„ï¼šanswer-1ï¼Œè¯‘æ–‡ï¼š\n ç½‘ç»œIOå¹¶ä¸æ˜¯AIOä¼˜å…ˆè€ƒè™‘çš„å¯¹è±¡ï¼Œç°åœ¨å‡ ä¹æ‰€æœ‰äººç¼–å†™ç½‘ç»œæœåŠ¡å™¨éƒ½æ˜¯åŸºäºPOSIXäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œäº‹ä»¶é©±åŠ¨æ¨¡å‹å·²ç»éå¸¸æˆç†Ÿã€ç¨³å®šäº†ã€‚ç£ç›˜å†™ä¸€èˆ¬ä¼šè¢«ç¼“å†²ã€ç£ç›˜è¯»ä¸€èˆ¬ä¼šé¢„å–ï¼Œè¿˜æœ‰ä»€ä¹ˆä¸å¤Ÿå®Œç¾çš„å‘¢ï¼Ÿè¦è¯´æœ‰ï¼Œé‚£å°±åªæœ‰Disk Direct IOè¿™ç§ä¸å¸¦ç¼“å†²å½¢å¼çš„æ“ä½œäº†ï¼Œè¿™æ˜¯AIOæœ€é€‚ç”¨çš„åœ°æ–¹ï¼Œè€ŒDisk Direct IOä»…ä»…è¢«ç”¨äºäº‹åŠ¡æ•°æ®åº“æˆ–æ˜¯é‚£äº›è¶‹å‘äºè‡ªå·±ç¼–å†™çº¿ç¨‹æˆ–è€…è¿›ç¨‹æ¥ç®¡ç†disk ioçš„æƒ…æ™¯ã€‚æ‰€ä»¥ï¼ŒPOSIX AIOå…¶å®æ²¡æœ‰ä»€ä¹ˆå¤šå¤§çš„ç”¨é€”ï¼Œä¸è¦ç”¨ï¼\n åŸæ–‡å‡ºå¤„ï¼šanswer-2ï¼Œè¯‘æ–‡ï¼š\n ç°åœ¨å€ŸåŠ©äºkqueueã€epollã€/dev/pollç­‰å·²ç»å¯ä»¥å®ç°éå¸¸é«˜æ•ˆçš„socket ioæ“ä½œã€‚å¼‚æ­¥çš„æ–‡ä»¶IOè‰èµ°æ˜¯ä¸€ä¸ªå‡ºç°æ¯”è¾ƒæ™šçš„ä¸œè¥¿ï¼ˆWindowsçš„overlapped ioå’ŒSolarisæ—©æœŸçš„POSIX AIOé™¤å¤–ï¼‰ã€‚å¦‚æœæƒ³å®ç°é«˜æ•ˆçš„socket ioæ“ä½œï¼Œæœ€å¥½æ˜¯åŸºäºä¸Šè¿°çš„äº‹ä»¶é©±åŠ¨æœºåˆ¶æ¥å®ç°ã€‚ AIOçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³å¼‚æ­¥çš„ç£ç›˜IOé—®é¢˜ï¼Œä»¥Mac OS Xä¸ºä¾‹ï¼Œå®ƒæä¾›çš„AIOå°±åªèƒ½ä½œç”¨åœ¨æ™®é€šæ–‡ä»¶ä¸Šè€Œä¸èƒ½ä½œç”¨åœ¨socketä¸Šï¼Œå› ä¸ºå·²ç»æœ‰kqueueå¯ä»¥å¾ˆå¥½åœ°å®Œæˆè¿™ä¸ªå·¥ä½œï¼Œæ²¡å¿…è¦é‡å¤é€ è½®å­ã€‚ ç£ç›˜å†™æ“ä½œé€šå¸¸éƒ½ä¼šè¢«kernelè¿›è¡Œç¼“å†²ï¼ˆå°†å†™çš„æ•°æ®å­˜åœ¨ç¼“å†²å—ä¸­ï¼‰ï¼Œç„¶ååœ¨åé¢é€‚å½“çš„äº‹ä»¶å°†ç¼“å†²çš„å†™æ“ä½œå…¨éƒ¨flushåˆ°ç£ç›˜ï¼ˆé€šå¸¸ç”±ä¸€ä¸ªé¢å¤–çš„è¿›ç¨‹æ¥å®Œæˆï¼Œlinux 0.11ä¸­æ˜¯ç”±pid=2çš„updateè¿›ç¨‹æ¥è´Ÿè´£åŒæ­¥ç¼“å†²å—æ•°æ®åˆ°ç£ç›˜ï¼‰ã€‚åé¢é€‚å½“çš„æ—¶åˆ»å¯ä»¥ç”±å†…æ ¸è¿›è¡Œé€‰æ‹©ä»¥è·å¾—æœ€ä¼˜çš„æ•ˆç‡ã€æœ€å°‘çš„ä»£ä»·ï¼Œä¾‹å¦‚å½“ç£ç›˜çš„è¯»å†™å¤´ç»è¿‡æŸä¸€ä¸ªç£ç›˜å†™è¯·æ±‚å¯¹åº”çš„ç£ç›˜å—æ—¶ï¼Œå†…æ ¸å¯èƒ½å°±ä¼šå°†è¿™ä¸ªå—å¯¹åº”çš„ç¼“å†²å—çš„æ•°æ®åŒæ­¥å›ç£ç›˜ã€‚\nä½†æ˜¯ï¼Œå¯¹äºè¯»æ“ä½œï¼Œå¦‚æœæˆ‘ä»¬å‘è®©å†…æ ¸å¯¹å¤šä¸ªç£ç›˜è¯»è¯·æ±‚æ ¹æ®è¯·æ±‚ä¼˜å…ˆçº§è¿›è¡Œæ’åºï¼ŒAIOæ˜¯å”¯ä¸€å¯ä¾›é€‰æ‹©çš„æ–¹å¼ã€‚ä¸‹é¢æ˜¯ä¸ºä»€ä¹ˆè®©å†…æ ¸æ¥ä½œè¿™ä¸ªå·¥ä½œæ¯”åœ¨ç”¨æˆ·æ€ç¨‹åºä¸­åšè¿™ä¸ªå·¥ä½œæ›´æœ‰ä¼˜åŠ¿çš„åŸå› ï¼š\n  å†…æ ¸å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ç£ç›˜ioè¯·æ±‚ï¼ˆä¸æ­¢æ˜¯å½“å‰æŸä¸ªç¨‹åºçš„ç£ç›˜ioè¯·æ±‚ï¼‰å¹¶ä¸”èƒ½å¤Ÿæ’åºï¼› å†…æ ¸çŸ¥é“ç£ç›˜è¯»å†™å¤´çš„ä½ç½®ï¼Œå¹¶èƒ½æ ¹æ®å½“å‰è¯»å†™å¤´çš„ä½ç½®æŒ‘é€‰è·ç¦»å½“å‰ä½ç½®æœ€è¿‘çš„ç£ç›˜ioè¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå°½é‡å°‘çš„ç§»åŠ¨è¯»å†™å¤´ï¼› å†…æ ¸èƒ½å¤Ÿåˆ©ç”¨native command queuingæŠ€æœ¯æ¥è¿›ä¸€æ­¥ä¼˜åŒ–ç£ç›˜çš„è¯»æ“ä½œï¼› å¯ä»¥å€ŸåŠ©äºlio_listioé€šè¿‡ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å‘èµ·å¤šä¸ªç£ç›˜readæ“ä½œï¼Œæ¯”readvæ–¹ä¾¿ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæˆ‘ä»¬çš„ç£ç›˜readæ“ä½œä¸æ˜¯é€»è¾‘ä¸Šè¿ç»­çš„æ—¶å€™è¿˜å¯ä»¥èŠ‚çœä¸€ç‚¹ç³»ç»Ÿçš„è´Ÿè½½ï¼› å€ŸåŠ©äºAIOç¨‹åºå®ç°å¯èƒ½æ›´è§ç®€å•äº›ï¼Œå› ä¸ºä¸éœ€è¦åˆ›å»ºé¢å¤–çš„ä¸€ä¸ªçº¿ç¨‹é˜»å¡åœ¨readã€writeç³»ç»Ÿè°ƒç”¨ä¸Šï¼Œå®Œæˆåè¿˜è¦å†é€šçŸ¥å…¶ä»–å‘èµ·ioçš„çº¿ç¨‹ioæ“ä½œå®Œæˆï¼› å¦å¤–ï¼ŒPOSIX AIOè®¾è®¡çš„æ¥å£æœ‰ç‚¹å°´å°¬ï¼Œä¸¾å‡ ä¸ªä¾‹å­ï¼š å”¯ä¸€é«˜æ•ˆçš„ã€æ”¯æŒçš„æ¯”è¾ƒå¥½çš„äº‹ä»¶å›è°ƒæœºåˆ¶å°±æ˜¯é€šè¿‡ä¿¡å·ï¼Œä½†æ˜¯è¿™åœ¨åº“é‡Œé¢åº”ç”¨èµ·æ¥ä¸æ–¹ä¾¿ï¼Œå› ä¸ºè¿™æ„å‘³ç€è¦ä½¿ç”¨è¿›ç¨‹çš„å…¨å±€ä¿¡å·åå­—ç©ºé—´ã€‚å¦‚æœæ“ä½œç³»ç»Ÿä¸æ”¯æŒå®æ—¶ä¿¡å·ï¼Œè¿˜æ„å‘³ç€ä¸å¾—ä¸ä¾¿åˆ©æ‰€æœ‰çš„è¯·æ±‚æ¥åˆ¤æ–­åˆ°åº•å“ªä¸€ä¸ªè¯·æ±‚å®Œæˆäº†ï¼ˆMac OS Xæ˜¯è¿™æ ·çš„ï¼ŒLinuxä¸‹ä¸æ˜¯ï¼‰ã€‚æ­¤å¤–ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ•è·ä¿¡å·ä¹Ÿæ˜¯ä¸€é¡¹æ¯”è¾ƒæœ‰æŒ‘æˆ˜æ€§çš„å·¥ä½œï¼Œè¿˜ä¸èƒ½ç›´æ¥åœ¨ä¿¡å·å¤„ç†æ±‰ä¹¦é‡Œé¢å¯¹äº‹ä»¶ä½œå‡ºå“åº”ï¼Œä¸å¾—ä¸é‡æ–°raiseä¸€ä¸ªä¿¡å·å¹¶å°†å®ƒå†™åˆ°ç®¡é“é‡Œé¢æˆ–è€…ä½¿ç”¨signalfdï¼ˆon Linuxï¼‰ç„¶åå†ç”±å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹è¿›è¡Œå¤„ç†ï¼Œå¦‚æœåœ¨ä¿¡å·å¤„ç†å‡½æ•°é‡Œé¢å“åº”ä¿¡å·å¯èƒ½è€—æ—¶è¾ƒé•¿å¯¼è‡´åç»­ä¿¡å·ä¸¢å¤±ï¼› lio_suspendè·Ÿselectå­˜åœ¨ç›¸åŒçš„é—®é¢˜ï¼Œéƒ½å…·æœ‰æœ€å¤§æ•°é‡é™åˆ¶ï¼Œä¼¸ç¼©æ€§å·®ï¼ lio_listioï¼Œå› ä¸ºå®ç°çš„åŸå› ä¹Ÿå­˜åœ¨æäº¤ioæ“ä½œæ•°é‡çš„é™åˆ¶ï¼Œä¸ºäº†å…¼å®¹æ€§è¯•å›¾è·å–è¿™ä¸ªé™åˆ¶çš„æ“ä½œæ˜¯æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰çš„ï¼Œåªèƒ½é€šè¿‡è°ƒç”¨sysconf(_SC_AIO_LISTIO_MAX)æ¥è·å–ï¼Œè¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¯èƒ½ä¼šå¤±è´¥ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨AIO_LISTIO_MAXå®æ¥ä»£æ›¿ã€‚\nå¯¹äºPosix AIOçš„çœŸå®åº”ç”¨æƒ…å†µï¼Œå¯ä»¥çœ‹ä¸€ä¸‹lighttpdï¼Œè¿™é‡Œé¢æœ‰é‡‡ç”¨åŸºäºAIOæ¥å®ç°serverçš„éƒ¨åˆ†å®ç°ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ã€‚\nç°åœ¨å¤§å¤šæ•°POSIXå¹³å°éƒ½æ”¯æŒPOSIX AIOäº†ï¼Œä¾‹å¦‚Linuxã€BSDã€Solarisã€AIXç­‰ã€‚Windwosé€šè¿‡å®ƒçš„overlapped file ioæ¥æ”¯æŒaioã€‚æˆ‘çš„ç†è§£æ˜¯åªæœ‰Solarisã€Windowsã€Linuxæ˜¯çœŸæ­£çš„æ”¯æŒå¼‚æ­¥ï¼Œå¼‚æ­¥æ–‡ä»¶ioä¼šè½åˆ°ç£ç›˜é©±åŠ¨ä¸Šï¼Œå…¶ä»–çš„æ“ä½œç³»ç»Ÿéƒ½æ˜¯åœ¨é€šè¿‡æŸç§æœºåˆ¶æ¥æ¨¡æ‹Ÿå¼‚æ­¥ioï¼Œå¦‚å€ŸåŠ©é¢å¤–çš„å†…æ ¸çº¿ç¨‹ï¼Œè¿™é‡ŒLinuxæ˜¯ä¸ªä¾‹å¤–ï¼Œå®ƒçš„glibcä¸­çš„POSIX AIOå®ç°æ˜¯å€ŸåŠ©çš„ä¸€ä¸ªç”¨æˆ·æ€çº¿ç¨‹æ¥è¾…åŠ©æ¨¡æ‹Ÿaioçš„è¡Œä¸ºï¼Œä½†æ˜¯Linux Kernelæä¾›çš„AIOæ˜¯çœŸæ­£çš„å¼‚æ­¥å®ç°ï¼Œæ‰€æœ‰çš„æ“ä½œç›´æ¥è½åˆ°é©±åŠ¨ï¼Œåªè¦é©±åŠ¨æ”¯æŒå¼‚æ­¥é‚£å°±æ˜¯çœŸæ­£çš„å¼‚æ­¥ï¼\næˆ‘ç›¸ä¿¡åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿé‡Œé¢ï¼ŒPOSIX AIOå®ç°å¾€å¾€åªæ”¯æŒæ™®é€šæ–‡ä»¶fdç±»å‹è€Œä¸æ”¯æŒsocket fdï¼Œè¿™ç§æƒ…å†µæ˜¯å¾ˆå¸¸è§çš„ï¼Œä¹Ÿæ˜¯å¾ˆæ­£å¸¸çš„ï¼  5.4 å…³äºAIOçš„ç»“è®º # å¦‚æœæ˜¯æƒ³åŸºäºsocket ioå®ç°é«˜æ€§èƒ½serverï¼Œè¿˜æ˜¯é‡‡ç”¨åŸºäºäº‹ä»¶é©±åŠ¨IOæ¨¡å‹å§ï¼åˆ«å†æƒ³ä¿¡å·é©±åŠ¨çš„IOå’ŒAIOäº†ï¼\næ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è¿›ä¸€æ­¥äº†è§£AIOçš„ç›¸å…³ä½¿ç”¨å’Œå®ç°ç»†èŠ‚ã€‚\n6 æœ¬æ–‡æ€»ç»“ # ä»¥ä¸Šå¯¹é˜»å¡IOã€éé˜»å¡IOã€IOå¤šè·¯å¤ç”¨ã€å®æ—¶ä¿¡å·é©±åŠ¨IOã€å¼‚æ­¥IOè¿™5ç§æ¨¡å‹çš„æ‰§è¡Œæµç¨‹ã€ä½¿ç”¨æ–¹å¼åšäº†æœ€åŸºæœ¬çš„ä»‹ç»ã€‚å¦‚æœæ—¶é—´å……è¶³ï¼Œåé¢ä¼šå‚è€ƒLinuxå†…æ ¸ä¸­çš„ç›¸åº”å®ç°è¿›ä¸€æ­¥ä»‹ç»ä»¥ä¸ŠIOæ¨¡å‹çš„å®ç°ç»†èŠ‚ã€‚\né™„å½•A. é”™è¯¯ç å®šä¹‰ # è¿™é‡Œåªåˆ—å‡ºäº†å¸¸è§çš„é”™è¯¯ç ï¼ŒLinuxä¸­å®šä¹‰çš„é”™è¯¯ç å¯ä»¥é€šè¿‡man errnoè¿›è¡ŒæŸ¥çœ‹ã€‚\n   é”™è¯¯ç Macro é”™è¯¯ç è¯´æ˜     EAGAIN Resource temporarily unavailable    é™„å½•B. æ’å›¾ä¿¡æ¯ # "}),a.add({id:369,href:"/tags/rtsig/",title:"rtsig",description:"",content:""}),a.add({id:370,href:"/tags/coroutine/",title:"coroutine",description:"",content:""}),a.add({id:371,href:"/blog/2017-09-23-%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%8E%86%E5%8F%B2%E7%8E%B0%E5%9C%A8%E5%92%8C%E6%9C%AA%E6%9D%A5/",title:"åç¨‹çš„å†å²ã€ç°åœ¨å’Œæœªæ¥!",description:"è¿›ç¨‹ã€çº¿ç¨‹å¤§å®¶å¹¶ä¸é™Œç”Ÿï¼Œåç¨‹å‘¢ï¼Ÿè¿‘äº›å¹´åç¨‹å¾—åˆ°å¤§é‡è¿ç”¨ï¼Œå¦‚Javaå­—èŠ‚ç å¢å¼ºå®ç°åç¨‹çš„Kilimã€Quasarï¼ŒC++ boost coroutineï¼Œå¾®ä¿¡libcoã€libtaskï¼Œå½“ç„¶è¿˜æœ‰åå£°åœ¨å¤–çš„Goè¯­è¨€ã€‚å…¶å®åç¨‹æ€æƒ³ç”±æ¥å·²ä¹…ï¼Œå¹¶éè¿‘å‡ å¹´æ‰è¯ç”Ÿï¼Œä¸å¦¨æ¥äº†è§£ä¸‹è¿™æ®µå†å²ã€‚",content:"è®¡ç®—æœºç§‘å­¦æ˜¯ä¸€é—¨åº”ç”¨ç§‘å­¦ï¼Œå‡ ä¹æ‰€æœ‰æ¦‚å¿µéƒ½æ˜¯ä¸ºäº†ç†è§£æˆ–è§£å†³å®é™…é—®é¢˜è€Œç”Ÿçš„ã€‚åç¨‹ (Coroutine) çš„å‡ºç°ä¹Ÿä¸ä¾‹å¤–ã€‚åç¨‹çš„æ¦‚å¿µï¼Œæœ€æ—©å¯ä»¥è¿½æº¯åˆ°å†™ä½œ COBOL è¯­è¨€ç¼–è¯‘å™¨ä¸­çš„æŠ€æœ¯éš¾é¢˜ã€‚\n1.ä»ç£å¸¦åˆ°åç¨‹ # COBOL æ˜¯æœ€æ—©çš„é«˜çº§è¯­è¨€ä¹‹ä¸€ã€‚ç¼–è¯‘å™¨åˆ™æ˜¯é«˜çº§è¯­è¨€å¿…ä¸å¯å°‘çš„ä¸€éƒ¨åˆ†ã€‚ç°å¦‚ä»Šï¼Œæˆ‘ä»¬å¯¹ç¼–è¯‘å™¨äº†è§£ï¼Œå·²ç»åˆ°äº†å¯ä»¥æŠŠæ ¸å¿ƒå†…å®¹æµ“ç¼©æˆä¸€æœ¬æ•™ç§‘ä¹¦çš„ç¨‹åº¦ã€‚ç„¶è€Œåœ¨å…­åå¹´ä»£ï¼Œå¦‚ä½•å†™ä½œé«˜æ•ˆçš„è¯­è¨€ç¼–è¯‘å™¨æ˜¯é‚£ä¸ªæ—¶ä»£ç»•ä¸è¿‡çš„ç°å®é—®é¢˜ã€‚æ¯”å¦‚ï¼Œ1960 å¹´å¤å¤©ï¼ŒD. E. Knuth å°±æ˜¯åˆ©ç”¨å¼€è½¦æ¨ªç©¿ç¾å›½å»åŠ å·ç†å·¥è¯»ç ”ç©¶ç”Ÿçš„æ—¶é—´ï¼Œå¯¹ç€ Burroughs 205 æœºå™¨æŒ‡ä»¤é›†æ‰‹å†™ COBOL ç¼–è¯‘å™¨ã€‚æœ€æ—©æå‡ºâ€œåç¨‹â€æ¦‚å¿µçš„ Melvin Conway çš„å‡ºå‘ç‚¹ï¼Œä¹Ÿæ˜¯å¦‚ä½•å†™ä¸€ä¸ªåªæ‰«æä¸€éç¨‹åº (one-pass) çš„ COBOL ç¼–è¯‘å™¨ã€‚ä¼—å¤šçš„â€œé«˜æ‰‹â€çº·çº·æŠ•å…¥ç¼–è¯‘å™¨ä¹¦å†™ï¼Œå¯è§ä¸€é—¨æ–°ç§‘å­¦å‘å±•ä¹‹åˆä¹Ÿæ˜¯ç­šè·¯è“ç¼•\nä»¥ç°ä»£çœ¼å…‰æ¥çœ‹ï¼Œé«˜çº§è¯­è¨€ç¼–è¯‘å™¨å®é™…ä¸Šæ˜¯å¤šä¸ªæ­¥éª¤ç»„åˆè€Œæˆï¼šè¯æ³•è§£æï¼Œè¯­æ³•è§£æï¼Œè¯­æ³•æ ‘æ„å»ºï¼Œä»¥åŠä¼˜åŒ–å’Œç›®æ ‡ä»£ç ç”Ÿæˆç­‰ç­‰ã€‚ç¼–è¯‘å®è´¨ä¸Šå°±æ˜¯ä»æºç¨‹åºå‡ºå‘ï¼Œä¾æ¬¡å°†è¿™äº›æ­¥éª¤çš„è¾“å‡ºä½œä¸ºä¸‹ä¸€æ­¥çš„è¾“å…¥ï¼Œæœ€ç»ˆè¾“å‡ºç›®æ ‡ä»£ç ã€‚åœ¨ç°ä»£è®¡ç®—æœºä¸Šå®ç°è¿™ç§ç®¡é“å¼çš„æ¶æ„æ¯«æ— å›°éš¾ï¼šåªéœ€è¦ä¾æ¬¡è¿è¡Œï¼Œä¸­é—´ç»“æœå­˜ä¸ºä¸­é—´æ–‡ä»¶æˆ–æ”¾å…¥å†…å­˜å³å¯ã€‚GCC å’Œ Clang ç¼–è¯‘å™¨ï¼Œä»¥åŠ ANTLR æ„å»ºçš„ç¼–è¯‘å™¨ï¼Œéƒ½éµå¾ªè¿™æ ·çš„è®¾è®¡ã€‚\nåœ¨ Conway çš„è®¾è®¡é‡Œï¼Œè¯æ³•å’Œè¯­æ³•è§£æä¸å†æ˜¯ä¸¤ä¸ªç‹¬ç«‹è¿è¡Œçš„æ­¥éª¤ï¼Œè€Œæ˜¯äº¤ç»‡åœ¨ä¸€èµ·ã€‚ç¼–è¯‘å™¨çš„æ§åˆ¶æµåœ¨è¯æ³•å’Œè¯­æ³•è§£æä¹‹é—´æ¥å›åˆ‡æ¢ï¼šå½“è¯æ³•æ¨¡å—è¯»å…¥è¶³å¤Ÿå¤šçš„ token æ—¶ï¼Œæ§åˆ¶æµäº¤ç»™è¯­æ³•åˆ†æï¼›å½“è¯­æ³•åˆ†ææ¶ˆåŒ–å®Œæ‰€æœ‰ token åï¼Œæ§åˆ¶æµäº¤ç»™è¯æ³•åˆ†æã€‚è¯æ³•å’Œè¯­æ³•åˆ†åˆ«ç‹¬ç«‹ç»´æŠ¤è‡ªèº«çš„è¿è¡ŒçŠ¶æ€ã€‚Conway æ„å»ºçš„è¿™ç§ååŒå·¥ä½œæœºåˆ¶ï¼Œéœ€è¦å‚ä¸è€…â€œè®©å‡º (yield)â€æ§åˆ¶æµæ—¶ï¼Œè®°ä½è‡ªèº«çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨æ§åˆ¶æµè¿”å›æ—¶èƒ½å¤Ÿä»ä¸Šæ¬¡è®©å‡ºçš„ä½ç½®æ¢å¤(resume)æ‰§è¡Œã€‚ç®€è¨€ä¹‹ï¼Œåç¨‹çš„å…¨éƒ¨ç²¾ç¥å°±åœ¨äºæ§åˆ¶æµçš„ä¸»åŠ¨è®©å‡ºå’Œæ¢å¤ã€‚æˆ‘ä»¬ç†Ÿæ‚‰çš„å­è¿‡ç¨‹è°ƒç”¨å¯ä»¥çœ‹ä½œåœ¨è¿”å›æ—¶è®©å‡ºæ§åˆ¶æµçš„ä¸€ç§ç‰¹æ®Šçš„åç¨‹ï¼Œå…¶å†…éƒ¨çŠ¶æ€åœ¨è¿”å›æ—¶è¢«ä¸¢å¼ƒäº†ï¼Œå› æ­¤ä¸å­˜åœ¨â€œæ¢å¤â€è¿™ä¸ªæ“ä½œã€‚\nä»¥ç°åœ¨çœ¼å…‰æ¥çœ‹ï¼Œç¼–è¯‘å™¨çš„å®ç°å¹¶ä¸å¿…ç„¶éœ€è¦åç¨‹ã€‚ç„¶è€Œï¼ŒConway ç”¨åç¨‹å®ç° COBOL ç¼–è¯‘å™¨åœ¨å½“æ—¶ç»ä¸æ˜¯èˆè¿‘æ±‚è¿œã€‚\n2.è‡ªé¡¶å‘ä¸‹ï¼Œæ— éœ€ååŒ # è™½ç„¶åç¨‹æ˜¯ä¼´éšç€é«˜çº§è¯­è¨€è¯ç”Ÿçš„ï¼Œå®ƒå´æ²¡æœ‰èƒ½åƒå­è¿‡ç¨‹ä¸€æ ·æˆä¸ºé€šç”¨ç¼–ç¨‹è¯­è¨€çš„åŸºæœ¬å…ƒç´ ã€‚\nä» 1963 å¹´é¦–æ¬¡æå‡ºåˆ°ä¸Šä¸ªä¸–çºªä¹åå¹´ä»£ï¼Œæˆ‘ä»¬åœ¨ ALOGL, Pascal, C, FORTRAN ç­‰ä¸»æµçš„å‘½ä»¤å¼ç¼–ç¨‹è¯­è¨€ä¸­éƒ½æ²¡æœ‰çœ‹åˆ°åŸç”Ÿçš„åç¨‹æ”¯æŒã€‚åç¨‹åªç¨€ç–åœ°å‡ºç°åœ¨ Simulaï¼ŒModular-2 (Pascal å‡çº§ç‰ˆ) å’Œ Smalltalk ç­‰ç›¸å¯¹å°ä¼—çš„è¯­è¨€ä¸­ã€‚åç¨‹ä½œä¸ºä¸€ä¸ªæ¯”å­è¿›ç¨‹æ›´åŠ é€šç”¨çš„æ¦‚å¿µï¼Œåœ¨å®é™…ç¼–ç¨‹å´æ²¡æœ‰å–ä»£å­è¿›ç¨‹ï¼Œè¿™ä¸€ç‚¹ä¸å¾—ä¸è¯´æ˜¯å‡ºä¹æ„å¤–çš„ã€‚å¦‚æœæˆ‘ä»¬ç»“åˆå½“æ—¶çš„ç¨‹åºè®¾è®¡æ€æƒ³çœ‹ï¼Œè¿™ä¸€ç‚¹åˆæ˜¯æ„æ–™ä¹‹ä¸­çš„ï¼šåç¨‹æ˜¯ä¸ç¬¦åˆé‚£ä¸ªæ—¶ä»£æ‰€å´‡å°šçš„â€œè‡ªé¡¶å‘ä¸‹â€çš„ç¨‹åºè®¾è®¡æ€æƒ³çš„ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸ä¼šæˆä¸ºå½“æ—¶ä¸»æµçš„å‘½ä»¤å¼ç¼–ç¨‹è¯­è¨€ (imperative programming) çš„ä¸€éƒ¨åˆ†ã€‚\næ­£å¦‚é¢å‘å¯¹è±¡çš„è¯­è¨€æ˜¯å›´ç»•é¢å‘å¯¹è±¡çš„å¼€å‘ç†å¿µè®¾è®¡ä¸€æ ·ï¼Œå‘½ä»¤å¼ç¼–ç¨‹è¯­è¨€æ˜¯å›´ç»•è‡ªé¡¶å‘ä¸‹(top-down)çš„å¼€å‘ç†å¿µè®¾è®¡çš„ã€‚åœ¨è‡ªé¡¶å‘ä¸‹çš„ç†å¿µæŒ‡å¯¼ä¸‹ï¼Œç¨‹åºè¢«åˆ‡åˆ†ä¸ºä¸€ä¸ªä¸»ç¨‹åºå’Œå¤§å¤§å°å°çš„å­æ¨¡å—ï¼Œæ¯ä¸€ä¸ªå­æ¨¡å—åˆå¯èƒ½è°ƒç”¨æ›´å¤šå­æ¨¡å—ç­‰ç­‰ã€‚C å®¶æ—è¯­è¨€çš„ main() å‡½æ•°å°±æ˜¯è¿™ç§è‡ªé¡¶è€Œä¸‹æ€æƒ³çš„ä½“ç°ã€‚åœ¨è¿™ç§ç†å¿µæŒ‡å¯¼ä¸‹ï¼Œå„æ¨¡å—å½¢æˆå±‚æ¬¡è°ƒç”¨å…³ç³»ï¼Œè€Œç¨‹åºè®¾è®¡å°±æ˜¯åˆ¶ä½œè¿™äº›å­è¿‡ç¨‹ã€‚åœ¨â€œè‡ªé¡¶å‘ä¸‹â€è¿™ç§å±‚æ¬¡åŒ–çš„ç†å¿µä¸‹ï¼Œå…·æœ‰é²œæ˜å±‚æ¬¡çš„å­è¿‡ç¨‹è°ƒç”¨æˆä¸ºè½¯ä»¶ç³»ç»Ÿæœ€è‡ªç„¶çš„ç»„ç»‡æ–¹å¼ï¼Œä¹Ÿæ˜¯ç†æ‰€å½“ç„¶ã€‚ç›¸è¾ƒä¹‹ä¸‹ï¼Œå…·æœ‰æ‰§è¡Œä¸­è®©å‡ºå’Œæ¢å¤åŠŸèƒ½çš„åç¨‹åœ¨è¿™ç§æ¶æ„ä¸‹æ— ç”¨æ­¦ä¹‹åœ°ã€‚å¯ä»¥è¯´ï¼Œè‡ªä¸Šè€Œä¸‹çš„è®¾è®¡æ€æƒ³ä»ä¸€å¼€å§‹å°±æ’é™¤äº†å¯¹åç¨‹çš„éœ€æ±‚ã€‚å…¶åçš„ç»“æ„åŒ–ç¼–ç¨‹(Structural Programming) æ€æƒ³ï¼Œæ›´æ˜¯è¿›ä¸€æ­¥å¼ºåŒ–äº†â€œå­è¿‡ç¨‹è°ƒç”¨ä½œä¸ºå”¯ä¸€æ§åˆ¶ç»“æ„â€çš„åŸºæœ¬å‡è®¾ã€‚åœ¨è¿™æ ·çš„æŒ‡å¯¼æ€æƒ³ä¸‹ï¼Œåç¨‹ä¸€ç›´æ²¡æœ‰æˆä¸ºå½“æ—¶ç¼–ç¨‹è¯­è¨€çš„ä¸€ç­‰å…¬æ°‘ã€‚\nå°½ç®¡ä»æå‡ºåˆ°ä¸Šä¸–çºª 90 å¹´ä»£ï¼Œåç¨‹åœ¨ç¼–ç¨‹è¯­è¨€ä¸­æ²¡æœ‰æ™®éæˆä¸ºä¸€ç­‰å…¬æ°‘ï¼Œä½†ä½œä¸ºä¸€ç§æ˜“äºç†è§£çš„æ§åˆ¶ç»“æ„ï¼Œåç¨‹çš„æ¦‚å¿µæ¸—å…¥åˆ°äº†è½¯ä»¶è®¾è®¡çš„è®¸å¤šæ–¹é¢ã€‚åœ¨ç»“æ„åŒ–ç¼–ç¨‹æ€æƒ³ä¸€ç»Ÿå¤©ä¸‹ä¹‹æ—¶ï¼Œ D. Knuth æ›¾ç»ä¸“é—¨å†™è¿‡ä¸€ç¯‡ â€œStructured Programming with GOTOâ€ æ¥ä¸º GOTO è¯­å¥è¾©æŠ¤ã€‚åœ¨ä»–åˆ—å‡ºçš„å‡ æ¡ GOTO å¯ä»¥æ–¹ä¾¿ç¼–ç¨‹ä¸”ä¸ç ´åç¨‹åºç»“æ„çš„ä¾‹å­ä¸­ï¼Œæœ‰ä¸€ä¸ªï¼ˆä¾‹å­7bï¼‰å°±æ˜¯ç”¨ GOTO å®ç°åç¨‹æ§åˆ¶ç»“æ„ã€‚ç›¸æ¯”è¾ƒä¹‹ä¸‹ï¼Œä¸ç”¨ GOTO çš„â€œç»“æ„åŒ–â€ä»£ç åè€Œå¤±å»äº†è‰¯å¥½çš„ç»“æ„ã€‚å½“ç„¶ï¼Œè¿½æ±‚å®é™…ç»“æœçš„å·¥ä¸šç•Œå¯¹äºå­¦ç•Œçš„è¿™åœºè¦ä¸è¦å‰”é™¤ GOTO çš„äº‰è®ºå¹¶ä¸æ„Ÿå†’ã€‚å½“æ—¶è®¸å¤šè¯­è¨€éƒ½é™„å¸¦äº†ä¸å»ºè®®ä½¿ç”¨çš„ GOTO è¯­å¥ï¼Œæ˜¾å¾—å·¦å³é€¢æºã€‚è¿™æ–¹é¢ä¸€ä¸ªæœ€æ˜æ˜¾çš„ä¾‹å­å°±æ˜¯ Javaï¼šå…¶è¯­è¨€æœ¬èº«é¢„ç•™äº† goto å…³é”®å­—ï¼Œå…¶ç¼–è¯‘å™¨å´æ²¡æœ‰æä¾›ä»»ä½•çš„æ”¯æŒï¼Œå¯ä»¥è¯´åœ¨ goto è¿™åœºäº‰è®ºä¸­åšè¶³äº†ä¸­é—´æ´¾ã€‚\n3.åç¨‹çš„æ—©æœŸåº”ç”¨ # å®è·µä¸­ï¼Œåç¨‹çš„æ€æƒ³é¢‘ç¹åº”ç”¨äºä»»åŠ¡è°ƒåº¦å’Œæµå¤„ç†ä¸Šã€‚æ¯”å¦‚ï¼ŒUNIX ç®¡é“å°±å¯ä»¥çœ‹æˆæ˜¯ä¼—å¤šå‘½ä»¤é—´çš„ååŒæ“ä½œã€‚å½“ç„¶ï¼Œç®¡é“çš„ç°ä»£å®ç°éƒ½æ˜¯ä»¥ pipe() ç³»ç»Ÿè°ƒç”¨å’Œè¿›ç¨‹é—´çš„é€šä¿¡ä¸ºåŸºç¡€ï¼Œè€Œéç®€å•éµå¾ªåç¨‹çš„ yield/resume è¯­æ³•ã€‚\nè®¸å¤šååŒå¼å¤šä»»åŠ¡æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥çœ‹æˆåç¨‹è¿è¡Œç³»ç»Ÿã€‚è¯´åˆ°ååŒå¼å¤šä»»åŠ¡ç³»ç»Ÿï¼Œä¸€ä¸ªå¸¸è§çš„è¯¯åŒºæ˜¯è®¤ä¸ºååŒå¼è°ƒåº¦æ¯”æŠ¢å å¼è°ƒåº¦â€œä½çº§â€ï¼Œå› ä¸ºæˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„æ¡Œé¢æ“ä½œç³»ç»Ÿï¼Œéƒ½æ˜¯ä»ååŒå¼è°ƒåº¦ï¼ˆå¦‚ Windows 3.2ï¼Œ Mac OS 9 ç­‰ï¼‰è¿‡æ¸¡åˆ°æŠ¢å å¼å¤šä»»åŠ¡ç³»ç»Ÿçš„ã€‚å®é™…ä¸Šï¼Œè°ƒåº¦æ–¹å¼å¹¶æ— é«˜ä¸‹ï¼Œå®Œå…¨å–å†³äºåº”ç”¨åœºæ™¯ã€‚æŠ¢å å¼ç³»ç»Ÿå…è®¸æ“ä½œç³»ç»Ÿå‰¥å¤ºè¿›ç¨‹æ‰§è¡Œæƒé™ï¼ŒæŠ¢å æ§åˆ¶æµï¼Œå› è€Œå¤©ç„¶é€‚åˆæœåŠ¡å™¨å’Œå›¾å½¢æ“ä½œç³»ç»Ÿï¼Œå› ä¸ºè°ƒåº¦å™¨å¯ä»¥ä¼˜å…ˆä¿è¯å¯¹ç”¨æˆ·äº¤äº’å’Œç½‘ç»œäº‹ä»¶çš„å¿«é€Ÿå“åº”ã€‚å½“å¹´ Windows 95 åˆšåˆšæ¨å‡ºçš„æ—¶å€™ï¼ŒæŠ¢å å¼å¤šä»»åŠ¡å°±è¢«ä½œä¸ºä¸€å¤§ä¹°ç‚¹å¤§åŠ å®£ä¼ ã€‚ååŒå¼è°ƒåº¦åˆ™ç­‰åˆ°è¿›ç¨‹æ—¶é—´ç‰‡ç”¨å®Œæˆ–ç³»ç»Ÿè°ƒç”¨æ—¶è½¬ç§»æ‰§è¡Œæƒé™ï¼Œå› æ­¤é€‚åˆå®æ—¶æˆ–åˆ†æ—¶ç­‰ç­‰å¯¹è¿è¡Œæ—¶é—´æœ‰ä¿éšœçš„ç³»ç»Ÿã€‚\nå¦å¤–ï¼ŒæŠ¢å å¼ç³»ç»Ÿä¾èµ–äº CPU çš„ç¡¬ä»¶æ”¯æŒã€‚ å› ä¸ºè°ƒåº¦å™¨éœ€è¦â€œå‰¥å¤ºâ€è¿›ç¨‹çš„æ‰§è¡Œæƒï¼Œå°±æ„å‘³ç€è°ƒåº¦å™¨éœ€è¦è¿è¡Œåœ¨æ¯”æ™®é€šè¿›ç¨‹é«˜çš„æƒé™ä¸Šï¼Œå¦åˆ™ä»»ä½•â€œæµæ°“ï¼ˆrogueï¼‰â€è¿›ç¨‹éƒ½å¯ä»¥å»å‰¥å¤ºå…¶ä»–è¿›ç¨‹äº†ã€‚åªæœ‰ CPU æ”¯æŒäº†æ‰§è¡Œæƒé™åï¼ŒæŠ¢å å¼è°ƒåº¦æ‰æˆä¸ºå¯èƒ½ã€‚x86 ç³»ç»Ÿä» 80386 å¤„ç†å™¨å¼€å§‹å¼•å…¥ Ring æœºåˆ¶æ”¯æŒæ‰§è¡Œæƒé™ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä½• Windows 95 å’Œ Linux å…¶å®åªèƒ½è¿è¡Œåœ¨ 80386 ä¹‹åçš„ x86 å¤„ç†å™¨ä¸Šçš„åŸå› ã€‚è€ŒååŒå¼å¤šä»»åŠ¡é€‚ç”¨äºé‚£äº›æ²¡æœ‰å¤„ç†å™¨æƒé™æ”¯æŒçš„åœºæ™¯ï¼Œè¿™äº›åœºæ™¯åŒ…å«èµ„æºå—é™çš„åµŒå…¥å¼ç³»ç»Ÿå’Œå®æ—¶ç³»ç»Ÿã€‚åœ¨è¿™äº›ç³»ç»Ÿä¸­ï¼Œç¨‹åºå‡ä»¥åç¨‹çš„æ–¹å¼è¿è¡Œã€‚è°ƒåº¦å™¨è´Ÿè´£æ§åˆ¶æµçš„è®©å‡ºå’Œæ¢å¤ã€‚é€šè¿‡åç¨‹çš„æ¨¡å‹ï¼Œæ— éœ€ç¡¬ä»¶æ”¯æŒï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸€ä¸ªâ€œç®€é™‹â€çš„å¤„ç†å™¨ä¸Šå®ç°ä¸€ä¸ªå¤šä»»åŠ¡çš„ç³»ç»Ÿã€‚æˆ‘ä»¬è§åˆ°çš„è®¸å¤šæ™ºèƒ½è®¾å¤‡ï¼Œå¦‚è¿åŠ¨æ‰‹ç¯ï¼ŒåŸºäºç¡¬ä»¶é™åˆ¶ï¼Œéƒ½æ˜¯é‡‡ç”¨ååŒè°ƒåº¦çš„æ¶æ„ã€‚\n4.åç¨‹çš„å¤å…´å’Œç°ä»£å½¢å¼ # ç¼–ç¨‹æ€æƒ³èƒ½å¦æ™®åŠå¼€æ¥ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šåœ¨äºåº”ç”¨åœºæ™¯ã€‚åç¨‹æ²¡æœ‰èƒ½åœ¨è‡ªé¡¶å‘ä¸‹çš„ä¸–ç•Œé‡Œç«‹è¶³ï¼Œå´åœ¨åŠ¨æ€è¯­è¨€ä¸–ç•Œé‡Œå¤§æ”¾å…‰å½©ï¼Œè¿™é‡Œæœ€æ˜¾è‘—çš„ä¾‹å­è«è¿‡äº Python çš„è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ã€‚\nå›æƒ³ä¸€ä¸‹åœ¨ C çš„ä¸–ç•Œé‡Œï¼Œå¾ªç¯çš„æ ‡å‡†å†™æ³•æ˜¯:\nfor (i = 0; i \u0026lt; n; ++i) { â€¦ }  è¿™è¡Œä»£ç åŒ…å«ä¸¤ä¸ªç‹¬ç«‹çš„é€»è¾‘, for å¾ªç¯æ§åˆ¶äº† i çš„è¾¹ç•Œæ¡ä»¶ï¼Œ ++i æ§åˆ¶äº† i çš„è‡ªå¢é€»è¾‘ã€‚è¿™è¡Œä»£ç é€‚ç”¨äº C ä¸–ç•Œé‡Œçš„æ•°ç»„å³å†…å­˜ä½ç§»çš„èŒƒå¼ï¼Œå› æ­¤é€‚åˆå¤§å¤šæ•°è®¿é—®åœºæ™¯ã€‚åˆ°äº† STL å’Œå¤æ‚æ•°æ®ç»“æ„çš„ä¸–ç•Œï¼Œå› ä¸ºè®¸å¤šæ•°æ®ç»“æ„åªæ”¯æŒé¡ºåºè®¿é—®ï¼Œå¾ªç¯å¾€å¾€å†™æˆ:\nfor (i = A.first(); i.hasNext();i = i.next()) { â€¦ }  è¿™ç§è®¾è®¡æŠ½è±¡å‡ºäº†ä¸€ä¸ªç‹¬ç«‹äºæ•°æ®ç»“æ„çš„è¿­ä»£å™¨ï¼Œä¸“é—¨è´Ÿè´£æ•°æ®ç»“æ„ä¸Šå…ƒç´ è®¿é—®é¡ºåºã€‚è¿­ä»£å™¨æŠŠè®¿é—®é€»è¾‘ä»æ•°æ®ç»“æ„ä¸Šåˆ†ç¦»å‡ºæ¥, æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ ï¼ˆGoF 23ä¸ªè®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼‰.æˆ‘ä»¬åœ¨ STL å’Œ Java Collection ä¸­ä¹Ÿå¸¸å¸¸çœ‹åˆ°è¿­ä»£å™¨çš„èº«å½±ã€‚\nåœ¨é€‚å½“çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥å¼•å…¥ä¸€ä¸ªè¯­æ³•ç³–ï¼ˆè„šæ³¨ï¼šè¿™é‡Œç‰µæ¶‰åˆ°ä¸€ä¸ªå¤–éƒ¨è¿­ä»£å™¨å’Œå†…éƒ¨è¿­ä»£å™¨çš„é—®é¢˜ã€‚é™äºç¯‡å¹…ä¸åœ¨æ­¤è®¨è®ºï¼‰å°†å¾ªç¯å†™æˆ:\nfor i in A.Iterator() {func(i)}ã€‚  äº‹å®ä¸Šï¼Œè®¸å¤šç°ä»£è¯­è¨€éƒ½æ”¯æŒç±»ä¼¼çš„è¯­æ³•ã€‚è¿™ç§è¯­æ³•æŠ›å¼ƒäº†ä»¥ i å˜é‡ä½œä¸ºè¿­ä»£æŒ‡é’ˆçš„åŠŸèƒ½ï¼Œè¦æ±‚è¿­ä»£å™¨è‡ªèº«èƒ½å¤Ÿè®°ä½å½“å‰è¿­ä»£ä½ç½®ï¼Œè°ƒç”¨æ—¶è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚è¯»è€…ä¸éš¾çœ‹åˆ°ï¼Œè¿™ç§æ¶æ„å°±æ˜¯æˆ‘ä»¬åœ¨æ–‡ç« å¼€å§‹æåˆ°çš„è¯­æ³•åˆ†æå™¨çš„æ¶æ„ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä»åç¨‹çš„è§’åº¦æ¥ç†è§£è¿­ä»£å™¨ï¼šå½“æ§åˆ¶æµè½¬æ¢åˆ°è¿­ä»£å™¨ä¸Šæ—¶ï¼Œè¿­ä»£å™¨è´Ÿè´£ç”Ÿæˆå’Œè¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ä¸€æ—¦ä¸‹ä¸€ä¸ªå…ƒç´ å‡†å¤‡å°±ç»ªï¼Œè¿­ä»£å™¨å°±è®©å‡ºæ§åˆ¶æµã€‚è¿™ç§ç‰¹æ®Šçš„è¿­ä»£å™¨å®ç°åœ¨ Python ä¸­åˆè¢«æˆä¸ºç”Ÿæˆå™¨ã€‚ä»¥åç¨‹çš„è§’åº¦åˆ‡å…¥çš„çš„å¥½å¤„æ˜¯è®¾è®¡å¤§å¤§ç²¾ç®€ã€‚å®é™…ä¸Šï¼Œåœ¨ Python ä¸­ï¼Œç”Ÿæˆå™¨æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œå’Œæ™®é€šå‡½æ•°çš„å”¯ä¸€ä¸åŒæ˜¯å®ƒçš„è¿”å›è¯­å¥æ˜¯åç¨‹é£æ ¼çš„ yieldã€‚è¿™é‡Œï¼Œyield ä¸€è¯­åŒå…³ï¼Œæ—¢æ˜¯è®©å‡ºæ§åˆ¶æµï¼Œä¹Ÿæ˜¯ç”Ÿæˆè¿­ä»£å™¨çš„è¿”å›å€¼ã€‚\nä»¥ä¸Šæˆ‘ä»¬ä»…ä»…è®¨è®ºäº†ç”Ÿæˆå™¨çš„æœ€åŸºæœ¬çš„ç‰¹æ€§ã€‚å®é™…ä¸Šï¼Œç”Ÿæˆå™¨çš„å¼ºå¤§ä¹‹å¤„åœ¨äºæˆ‘ä»¬å¯ä»¥åƒ UNIX ç®¡é“ä¸€æ ·ä¸²è”èµ·æ¥ï¼Œç»„æˆæ‰€è°“çš„ç”Ÿæˆå™¨è¡¨è¾¾å¼ã€‚å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¯ä»¥ç”Ÿæˆ 1ï¼Œ2ï¼Œ3 â€¦ çš„ç”Ÿæˆå™¨ Nï¼Œåˆ™ square = (i **2 for i in N) å°±æ˜¯ä¸€ä¸ªç”Ÿæˆå¹³æ–¹æ•°çš„ç”Ÿæˆå™¨è¡¨è¾¾å¼ã€‚æœ€ç»ˆçš„æ§åˆ¶æµä¼šåœ¨è¿™äº›ä¸²è”çš„éƒ¨åˆ†é—´è½¬æ¢ï¼Œæ— éœ€æˆ‘ä»¬å†™ä½œå¤æ‚çš„åµŒå¥—è°ƒç”¨ã€‚å½“ç„¶ï¼Œyield åªæ˜¯å†°å±±çš„ä¸€è§’ï¼Œç°ä»£çš„ Python è¯­è¨€è¿˜å……åˆ†åˆ©ç”¨äº† yield å…³é”®å­—æ„å»ºäº† yield from è¯­å¥ï¼Œ(yield) è¯­æ³•ç­‰ç­‰ï¼Œä½¿å¾—æˆ‘ä»¬æ— å›°éš¾çš„å°†åç¨‹çš„æ€æƒ³èå…¥åˆ° Python ç¼–ç¨‹ä¸­å»ã€‚é™äºç¯‡å¹…è¿™é‡Œä¸å†å±•å¼€ã€‚\n5.åç¨‹çš„å®ç°å½¢å¼ # æˆ‘ä»¬å‰é¢è¯´è¿‡ï¼Œåç¨‹çš„æ€æƒ³æœ¬è´¨ä¸Šå°±æ˜¯æ§åˆ¶æµçš„ä¸»åŠ¨è®©å‡ºå’Œæ¢å¤æœºåˆ¶ã€‚åœ¨ç°ä»£è¯­è¨€é‡Œï¼Œå¯ä»¥å®ç°åç¨‹æ€æƒ³çš„æ–¹æ³•å¾ˆå¤šï¼Œè¿™äº›å®ç°é—´å¹¶æ— é«˜ä¸‹ä¹‹åˆ†ï¼Œæ‰€åŒºåˆ«çš„å°±æ˜¯æ˜¯å¦é€‚åˆåº”ç”¨åœºæ™¯ã€‚ç†è§£è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯¹äºå„ç§åç¨‹çš„åˆ†ç±»ï¼Œå¦‚åŠå¯¹ç§°/å¯¹ç§°åç¨‹ï¼Œæœ‰æ ˆä¸æ— æ ˆåç¨‹ç­‰å…·ä½“å®ç°å°±èƒ½æçº²æŒˆé¢†ï¼Œæ— éœ€åœ¨å®ç°ç»†èŠ‚ä¸Šçº ç»“ã€‚\nåç¨‹åœ¨å®è·µä¸­çš„å®ç°æ–¹å¼åƒå·®ä¸‡åˆ«ï¼Œä¸€ä¸ªç®€å•çš„åŸå› ï¼Œæ˜¯åç¨‹æœ¬èº«å¯ä»¥é€šè¿‡è®¸å¤šåŸºæœ¬å…ƒç´ æ„å»ºã€‚åŸºæœ¬å…ƒç´ çš„é€‰å–æ–¹å¼ä¸ä¸€æ ·ï¼Œæ„å»ºå‡ºæ¥çš„åç¨‹æŠ½è±¡ä¹Ÿå°±æœ‰å·®åˆ«ã€‚æ¯”å¦‚, Lua è¯­è¨€é€‰å–äº† create, resume å’Œ yield ä½œä¸ºåŸºæœ¬æ„å»ºå…ƒç´ , ä»è°ƒåº¦å™¨å±‚é¢æ„å»ºå‡ºæ‰€è°“çš„â€œéå¯¹ç¨‹â€åç¨‹ç³»ç»Ÿã€‚è€Œ Julia è¯­è¨€ç»•è¿‡è°ƒåº¦å™¨ï¼Œé€šè¿‡åœ¨åç¨‹å†…è°ƒç”¨ yieldto å‡½æ•°å®Œæˆäº†åŒæ ·çš„åŠŸèƒ½ï¼Œæ„å»ºå‡ºäº†ä¸€ä¸ªæ‰€è°“çš„å¯¹ç§°åç¨‹ç³»ç»Ÿã€‚å°½ç®¡è¿™ä¸¤ä¸ªè¯­è¨€ä½¿ç”¨äº†åŒæ ·çš„ setjmp åº“ï¼Œæ„é€ å‡ºæ¥çš„åŸè¯­å´ä¸ä¸€æ ·ã€‚åˆæ¯”å¦‚ï¼Œè®¸å¤š C è¯­è¨€çš„åç¨‹åº“éƒ½ä½¿ç”¨äº† ucontext åº“å®ç°ï¼Œè¿™æ˜¯å› ä¸º POSIX æœ¬èº«æä¾›äº† ucontext åº“ï¼Œä¸å°‘åç¨‹å®ç°æ˜¯ä»¥ ucontext ä¸ºè“æœ¬å®ç°çš„ã€‚è¿™äº›å®ç°ï¼Œéƒ½ä¸å¯é¿å…åœ°å¸¦ä¸Šäº† ucontext ç³»ç»Ÿçš„ä¸€äº›åŸºæœ¬å‡è®¾ï¼Œæ¯”å¦‚åç¨‹é—´æ˜¯å¹³ç­‰çš„ï¼Œä¸€èˆ¬å¸¦æœ‰è°ƒåº¦å™¨æ¥åè°ƒåç¨‹ç­‰ç­‰ï¼ˆæ¯”å¦‚ libtask å®ç°ï¼Œä»¥åŠäº‘é£çš„ coroutine åº“ï¼‰ã€‚Go è¯­è¨€çš„ä¸€ä¸ªé²œæ˜ç‰¹è‰²å°±æ˜¯é€šé“ï¼ˆchannelï¼‰ä½œä¸ºä¸€çº§å¯¹è±¡ã€‚å› æ­¤ï¼Œresume å’Œ yield ç­‰åœ¨å…¶ä»–è¯­è¨€é‡Œçš„åŸè¯­åœ¨ go é‡Œéƒ½ä»¥é€šé“æ–¹å¼æ„å»ºã€‚æˆ‘ä»¬è¿˜å¯ä»¥ä¸¾å‡ºè®¸å¤šåŒæ ·çš„ä¾‹å­ã€‚è¿™äº›é£æ ¼çš„å·®å¼‚å¾€å¾€å’Œè¯­è¨€çš„å†å²ï¼Œæ¼”åŒ–è·¯å¾„ï¼Œå’Œè¦è§£å†³çš„é—®é¢˜ç›¸å…³ï¼Œæˆ‘ä»¬ä¸å¿…è‹›æ±‚ä»–ä»¬çš„åç¨‹æ¨¡å‹ä¸€å®šè¦å¦‚æ­¤è¿™èˆ¬ã€‚\n6.æ€»ç»“ # æ€»çš„æ¥è¯´ï¼Œåç¨‹ä¸ºååŒä»»åŠ¡æä¾›äº†ä¸€ç§è¿è¡Œæ—¶æŠ½è±¡ã€‚è¿™ç§æŠ½è±¡éå¸¸é€‚åˆäºååŒå¤šä»»åŠ¡è°ƒåº¦å’Œæ•°æ®æµå¤„ç†ã€‚åœ¨ç°ä»£æ“ä½œç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå› ä¸ºç”¨æˆ·æ€çº¿ç¨‹åˆ‡æ¢ä»£ä»·æ¯”å†…æ ¸æ€çº¿ç¨‹å°ï¼Œåç¨‹æˆä¸ºäº†ä¸€ç§è½»é‡çº§çš„å¤šä»»åŠ¡æ¨¡å‹ã€‚æˆ‘ä»¬æ— æ³•é¢„æµ‹æœªæ¥ï¼Œä½†æ˜¯å¯ä»¥çœ‹åˆ°ï¼Œåç¨‹å·²ç»æˆä¸ºè®¸å¤šæ“…é•¿æ•°æ®å¤„ç†çš„è¯­è¨€çš„ä¸€çº§å¯¹è±¡ã€‚éšç€è®¡ç®—æœºå¹¶è¡Œæ€§èƒ½çš„æå‡ï¼Œç”¨æˆ·æ€ä»»åŠ¡è°ƒåº¦å·²ç»æˆä¸ºä¸€ç§æ ‡å‡†çš„å¤šä»»åŠ¡æ¨¡å‹ã€‚åœ¨è¿™æ ·çš„å¤§è¶‹åŠ¿ä¸‹ï¼Œåç¨‹è¿™ä¸ªç®€å•ä¸”æœ‰æ•ˆçš„æ¨¡å‹å°±æ˜¾å¾—æ›´åŠ å¼•äººæ³¨ç›®ã€‚\nå‚è€ƒæ–‡çŒ®ï¼š\n[1] å¾å®¥ï¼Œ\u0026ldquo;åç¨‹çš„å†å²ï¼Œç°åœ¨å’Œæœªæ¥\u0026rdquo;, https://blog.youxu.info/\n"}),a.add({id:372,href:"/blog/2017-04-26-coroutine-switching/",title:"Coroutine-Switching",description:"å¦‚ä»Šåç¨‹å¾—åˆ°å¤§é‡åº”ç”¨ï¼Œå¤§å®¶å¯¹æ­¤å¹¶ä¸é™Œç”Ÿã€‚æœ¬æ–‡å¯¹åç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢åšäº†ä¸€ä¸ªç®€å•çš„å®éªŒï¼Œä»¥æ›´å¥½åœ°è®¤è¯†åç¨‹åˆ‡æ¢åŠå…¶å¼€é”€ã€‚",content:"1. åç¨‹Coroutine # 1.1. åç¨‹coroutineå£°æ˜ # file: coroutine.h\n#include \u0026lt;stdint.h\u0026gt; typedef int64_t (*EntryCallback)(void*); //ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ struct stRegister { uint64_t rax; uint64_t rbx; uint64_t rcx; uint64_t rdx; uint64_t rsi; uint64_t rdi; uint64_t r8; uint64_t r9; uint64_t r10; uint64_t r11; uint64_t r12; uint64_t r13; uint64_t r14; uint64_t r15; uint64_t rbp; uint64_t rsp; uint64_t rip; }; //åç¨‹ä¸Šä¸‹æ–‡ struct stContext { struct stRegister cpu_register; void *arg; uint8_t *stack; }; typedef struct stContext Coroutine; //åˆ›å»ºåç¨‹ Coroutine* CreateCoroutine(EntryCallback entry, void *arg); //åˆ é™¤åç¨‹ void DeleteCoroutine(Coroutine *ptr); //è®¾ç½®åç¨‹æ ˆå°ºå¯¸ void SetStackSize(uint32_t size); //åç¨‹åˆ‡æ¢ void __SwitchCoroutine__(Coroutine *cur, const Coroutine *next);  1.2. åç¨‹Coroutineå®ç° # file: coroutine.c\n#include \u0026quot;coroutine.h\u0026quot; #include \u0026lt;stdlib.h\u0026gt; #define OFFSET(t, m) (\u0026amp;(((t*)0)-\u0026gt;m)) uint32_t g_stack_size = 100 * 1024; Coroutine* CreateCoroutine(EntryCallback entry, void *arg) { int size = g_stack_size + sizeof(Coroutine); Coroutine *c = (Coroutine *)calloc(size, 1); if (NULL == c) { return NULL; } uint8_t *start = (uint8_t*)c; c-\u0026gt;arg = arg; //å‡½æ•°å…¥å£ c-\u0026gt;cpu_register.rip = (uint64_t)entry; //ç¬¬ä¸€ä¸ªå‚æ•° c-\u0026gt;cpu_register.rdi = (uint64_t)arg; //rbp æ ˆåº• c-\u0026gt;cpu_register.rbp = (uint64_t)(start + size); //rsp å½“å‰æ ˆé¡¶ c-\u0026gt;cpu_register.rsp = c-\u0026gt;cpu_register.rbp; return c; } void DeleteCoroutine(Coroutine *ptr) { free(ptr); } void SetStackSize(uint32_t size) { g_stack_size = size; }  2. åç¨‹Coroutineä¸Šä¸‹æ–‡åˆ‡æ¢ # file: switch.s\n//è¿™é‡Œåç¨‹åº“æ˜¯åŸºäºæœ‰æ ˆåç¨‹çš„è®¾è®¡æ¥å®ç°ï¼Œåç¨‹ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯éœ€é€šè¿‡%rspæ¥è®¡ç®—è®¿é—®åœ°å€ //__SwitchCoroutine__(current_coroutine, next_coroutine) //- rdi, current_coroutine //- rsi, next_coroutine .globl __SwitchCoroutine__ __SwitchCoroutine__: //save rsp of calling function, here %rsp equals to return address mov %rsp, %rax //set rsp to end of coroutine.stRegister, to push rip, //when rdi coroutine return, it will return the rip to continue exec mov %rdi, %rsp add $136, %rsp push (%rax) //+8 to skip return address to get end address of calling function's %rsp add $8, %rax push %rax //store the current_coroutine's state(stRegister) push %rbp push %r15 push %r14 push %r13 push %r12 push %r11 push %r10 push %r9 push %r8 push %rdi push %rsi push %rdx push %rcx push %rbx push %rax //ready switch to next_coroutine mov %rsi, %rsp //restore the next_coroutine's stRegister to cpu pop %rax pop %rbx pop %rcx pop %rdx pop %rsi pop %rdi pop %r8 pop %r9 pop %r10 pop %r11 pop %r12 pop %r13 pop %r14 pop %r15 pop %rbp //move return address to %rax mov 8(%rsp), %rax pop %rsp //jmp to next_coroutine, ram indirect access to fetch the target address jmp *%rax  3. Coroutineä½¿ç”¨ \u0026amp; æµ‹è¯• # 3.1. æµ‹è¯•ç¨‹åº # file: main.c\n#include \u0026lt;unistd.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026quot;coroutine.h\u0026quot; Coroutine *coroutines[3]; int64_t callback(void *arg) { while(1) { if(strcmp((char *)arg, \u0026quot;coroutine-a\u0026quot;)==0) { printf(\u0026quot;[%s] ready to switch to coroutine-b\\n\u0026quot;, (char *)arg); __SwitchCoroutine__(coroutines[0], coroutines[1]); } else if(strcmp((char *)arg, \u0026quot;coroutine-b\u0026quot;)==0) { printf(\u0026quot;[%s] ready to switch to coroutine-c\\n\u0026quot;, (char *)arg); __SwitchCoroutine__(coroutines[1], coroutines[2]); } else if(strcmp((char *)arg, \u0026quot;coroutine-c\u0026quot;)==0) { printf(\u0026quot;[%s] ready to switch to coroutine-a\\n\u0026quot;, (char *)arg); __SwitchCoroutine__(coroutines[2], coroutines[0]); } sleep(1); } return 0; } int main() { printf(\u0026quot;initialize coroutine's callback\\n\u0026quot;); EntryCallback cb = callback; printf(\u0026quot;create 3 coroutines\\n\u0026quot;); Coroutine *coo = CreateCoroutine(cb, (void *)\u0026quot;coroutine-o\u0026quot;); Coroutine *coa = CreateCoroutine(cb, (void *)\u0026quot;coroutine-a\u0026quot;); Coroutine *cob = CreateCoroutine(cb, (void *)\u0026quot;coroutine-b\u0026quot;); Coroutine *coc = CreateCoroutine(cb, (void *)\u0026quot;coroutine-c\u0026quot;); coroutines[0] = coa; coroutines[1] = cob; coroutines[2] = coc; printf(\u0026quot;ready to start coroutine switching\\n\u0026quot;); __SwitchCoroutine__(coo, coa); printf(\u0026quot;ready to exit\\n\u0026quot;); return 0; }  3.2. æµ‹è¯•ç¨‹åºbuild # file: Makefile\nall: *.c *.h *.s @echo \u0026quot;==\u0026gt; build the coroutine test module\u0026quot; gcc -g -o main *.c *.h *.s @echo \u0026quot;==\u0026gt; build successful\u0026quot; test: all @echo \u0026quot;==\u0026gt; run the coroutine test module\u0026quot; ./main clean: @echo \u0026quot;==\u0026gt; delete the build file 'main'\u0026quot; rm main  3.3. æµ‹è¯•ç»“æœ # make make test ==\u0026gt; build the coroutine test module gcc -g -o main *.c *.h *.s ==\u0026gt; build successful ==\u0026gt; run the coroutine test module ./main initialize coroutine's callback create 3 coroutines ready to start coroutine switching [coroutine-a] ready to switch to coroutine-b [coroutine-b] ready to switch to coroutine-c [coroutine-c] ready to switch to coroutine-a [coroutine-a] ready to switch to coroutine-b [coroutine-b] ready to switch to coroutine-c [coroutine-c] ready to switch to coroutine-a [coroutine-a] ready to switch to coroutine-b  "}),a.add({id:373,href:"/tags/libtask/",title:"libtask",description:"",content:""}),a.add({id:374,href:"/tags/ucontext/",title:"ucontext",description:"",content:""}),a.add({id:375,href:"/tags/java/",title:"java",description:"",content:""}),a.add({id:376,href:"/blog/2017-04-20-%E5%AD%A6%E4%B9%A0java-nio/",title:"Java NIO Tutorials",description:"Javaç½‘ç»œç¼–ç¨‹ä¸­ç¦»ä¸å¼€å¯¹NIOçš„ç†Ÿç»ƒè¿ç”¨ï¼Œæœ¬æ–‡æ€»ç»“äº†NIOçš„å®ç°åŸç†ã€ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠå¹¶å‘ç¼–ç¨‹ä¸­éœ€è¦å…³æ³¨çš„ä¸€äº›æ ¸å¿ƒé—®é¢˜ã€‚",content:"1 å‰è¨€ # Java NIOï¼Œæ„ä¸ºJava New IOï¼Œæ˜¯ä¸€ç§ç›¸å¯¹äºJavaæ ‡å‡†IOã€ç½‘ç»œAPIçš„æ›¿ä»£æ–¹æ¡ˆã€‚ä»JDK 1.4å¼€å§‹NIOå°±è¢«å¼•å…¥äº†è¿›æ¥ï¼Œå®ƒæä¾›äº†å¦ä¸€ç§IOå¤„ç†çš„æ–¹å¼ï¼Œè¿™ä½¿å¾—Javaåœ¨IOå¤„ç†æ–¹é¢å‘å‰è¿ˆè¿›äº†ä¸€å¤§æ­¥ã€‚\nNIO Channel \u0026amp; Buffer # åœ¨Javaæ ‡å‡†IOé‡Œé¢ï¼ŒIOå¤„ç†çš„å¯¹è±¡æ˜¯å­—èŠ‚æµæˆ–å­—ç¬¦æµï¼Œåœ¨NIOé‡Œé¢æˆ‘ä»¬å¤„ç†çš„å¯¹è±¡æ˜¯channelå’Œbufferï¼Œæ•°æ®è¯»æ€»æ˜¯ä»channelä¸­è¯»å…¥åˆ°bufferï¼Œè¾“å…¥å†™æ€»æ˜¯ä»bufferå†™å…¥åˆ°channelã€‚\nNIO Non-Blocking IO # Java NIOä½¿å¾—æˆ‘ä»¬å¯ä»¥é€šè¿‡éé˜»å¡çš„æ–¹å¼æ‰§è¡ŒIOå¤„ç†ï¼Œä¾‹å¦‚ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚ä»channelä¸­è¯»å–æ•°æ®åˆ°bufferçš„æ—¶å€™ï¼Œåœ¨channelæ‰§è¡Œæ•°æ®è¯»å–æ“ä½œåˆ°bufferçš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ä»ç„¶å¯ä»¥æ‰§è¡Œå…¶ä»–çš„å¤„ç†å·¥ä½œï¼Œå½“æ•°æ®è¢«è¯»å–åˆ°bufferä¸­ä¹‹åï¼Œçº¿ç¨‹å†å»å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚æ•°æ®å†™çš„è¿‡ç¨‹ä¹Ÿæ˜¯ä¸æ­¤ç±»ä¼¼ã€‚\n å¤‡æ³¨ï¼š\nå…¶å®å‚è€ƒglibcä¸­çš„pthreadç”¨æˆ·çº§çº¿ç¨‹åº“å®ç°ï¼Œå¯ä»¥å¤§è‡´æƒ³åˆ°è¿™ç§channelã€bufferå·¥ä½œæ¨¡å¼çš„ä¸€ç§å¤§è‡´å®ç°ï¼Œå¤§ä¸äº†æˆ‘å¤šå¼€ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹è®©å…¶æ‰§è¡Œchannelå’Œbufferä¹‹é—´çš„æ•°æ®ä¼ è¾“å·¥ä½œï¼Œå¤„ç†å®Œä¹‹åç»™åŸæœ¬è¯·æ±‚channelè¯»å†™æ•°æ®çš„ç”¨æˆ·çº¿ç¨‹å‘ä¸ªä¿¡å·è®©å…¶è¿›è¡Œæ•°æ®å¤„ç†ã€‚Linuxä¸­çš„AIOå°±æ˜¯è¿™ä¹ˆæçš„ï¼Œå¯ä»¥å‚è€ƒã€ŠLinuxè®¾å¤‡é©±åŠ¨å¼€å‘ã€‹ã€‚\nå¤§å®¶æ‰€æè¿°çš„æ²¡æœ‰åº•å±‚ç¡¬ä»¶æ”¯æŒçš„å¼‚æ­¥ï¼Œå¾ˆå¤šéƒ½æ˜¯æŒ‡çš„è½¯ä»¶ä»£ç æ‰§è¡Œåºä¸Šçš„å¼‚æ­¥ï¼Œæœ¬è´¨ä¸Šä»£ç è¿˜æ˜¯åœ¨ä»¥åŒæ­¥çš„æ–¹å¼æ‰§è¡Œï¼Œåªä¸è¿‡åœ¨è¿™äº›åŒæ­¥æŠ€æœ¯ä¹‹ä¸Šç»“åˆä¸€äº›å°ä½æ–™èµ·åˆ°äº†ç±»ä¼¼çš„å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœã€‚\n NIO Selector # Java NIOä¸­æœ‰Selectorï¼ˆé€‰æ‹©å™¨ï¼‰çš„æ¦‚å¿µï¼Œä¸€ä¸ªselectorå¯ä»¥å¯¹å¤šä¸ªchannelä¸Šçš„äº‹ä»¶è¿›è¡Œç›‘å¬ï¼Œä¾‹å¦‚å¯¹å¤šä¸ªchannelä¸Šçš„è¿æ¥æ‰“å¼€ã€æ•°æ®åˆ°è¾¾äº‹ä»¶è¿›è¡Œç›‘å¬ï¼Œå› æ­¤ä¸€ä¸ªselectorå¯ä»¥ç”¨äºå¯¹å¤šä¸ªchannelä¸Šçš„è¿æ¥æ‰“å¼€ã€å…³é—­ä»¥åŠè¯»å†™äº‹ä»¶è¿›è¡Œç›‘å¬ã€å¤„ç†ã€‚\n å¤‡æ³¨ï¼š\nLinuxä¸­çš„selectoræœ¬è´¨ä¸Šæ˜¯åŸºäºepollå®ç°çš„ï¼Œå› æ­¤å¯ä»¥ç»“åˆepollæ¥ç†è§£selectorã€‚\nchannelä¸è¿‡æ˜¯å¯¹ç½‘ç»œå¥—æ¥å­—çš„å°è£…ï¼Œbufferä¸è¿‡æ˜¯å¯¹æ¥æ”¶ç¼“å†²ã€å‘é€ç¼“å†²çš„å°è£…ï¼Œselectorä¸è¿‡æ˜¯å¯¹epollfdçš„å°è£…ï¼Œselectorå¯¹å¤šä¸ªchannelçš„ç›‘å¬ï¼Œä¸è¿‡æ˜¯epollåœ¨epollfdä¸ŠEPOLL_CTL_ADDäº†å¤šä¸ªchannelå¯¹åº”çš„fdï¼Œå¹¶å¯¹å…¶ä¸Šçš„äº‹ä»¶è¿›è¡Œå¿…è¦çš„ç›‘å¬ã€‚selectorè½®è¯¢äº‹ä»¶æ˜¯å¦å‘ç”Ÿï¼Œæœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯epoll_waitè½®è¯¢æ³¨å†Œçš„å¤šä¸ªfdä¸Šæ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚\n ä¸‹é¢å°†å±•å¼€ä»‹ç»Java NIOæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚\n2 æ¦‚è¦ # Java NIOåŒ…æ‹¬3ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œå³channelã€bufferã€selectorã€‚Java NIOé‡Œé¢åŒ…æ‹¬çš„ç±»ä¸æ­¢è¿™å‡ ä¸ªï¼Œä½†æ˜¯æˆ‘ä¸ªäººè®¤ä¸ºJava NIO APIçš„æ ¸å¿ƒç±»å°±è¿™å‡ ä¸ªï¼Œå…¶ä»–çš„ä¾‹å¦‚Pipeã€FileLockå­ç±»çš„éƒ½æ˜¯é…åˆè¿™3ä¸ªæ ¸å¿ƒç»„ä»¶ä½¿ç”¨çš„å·¥å…·ç±»ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆé‡ç‚¹ä»‹ç»channelã€bufferã€selectorï¼Œåé¢ä¼šåœ¨ç‹¬ç«‹ç« èŠ‚ä¸­å¯¹å…¶ä»–ç±»è¿›è¡Œä»‹ç»ã€‚\nNIO Channel \u0026amp; Buffer # Java NIOä¸­çš„æ‰€æœ‰IOæ“ä½œå‡ ä¹éƒ½æ˜¯ä»ä¸€ä¸ªchannelå¼€å§‹çš„ï¼Œchannelå¯ä»¥çœ‹åšæ˜¯å¯¹ä¸€å¯¹å¥—æ¥å­—çš„å°è£…ï¼Œä¾‹å¦‚ä¸€ä¸ªtcpè¿æ¥ã€‚å¯ä»¥ä»channelä¸­è¯»å–æ•°æ®åˆ°bufferï¼ŒåŒæ ·ä¹Ÿå¯ä»¥å°†bufferä¸­çš„æ•°æ®å†™å…¥åˆ°channelä¸­ï¼Œä¸‹å›¾å±•ç¤ºäº†channelå’Œbufferçš„è¿™ä¸€å…³ç³»ã€‚\nChannelå¤§è‡´æœ‰å¦‚ä¸‹å‡ ç§å®ç°ï¼š\n FileChannel DatagramChannel SocketChannel ServerSocketChannel  å…¶ä¸­FileChannelä¸»è¦ç”¨äºæ–‡ä»¶ioï¼ŒDatagramChannelä¸»è¦ç”¨äºudpç½‘ç»œé€šä¿¡ï¼ŒSocketChannelç”¨äºtcpç½‘ç»œé€šä¿¡ï¼Œè€ŒServerSocketChannelç”¨äºå»ºç«‹tcpè¿æ¥ã€‚\nBufferå¤§è‡´æœ‰å¦‚ä¸‹å‡ ç§å®ç°ï¼š\n ByteBuffer CharBuffer DoubleBuffer FloatBuffer IntBuffer LongBuffer ShortBuffer  ä¸Šè¿°å¤šç§Bufferçš„ä¸åŒä¹‹å¤„åœ¨äºå…¶ä¸­å­˜å‚¨çš„æ•°æ®ç±»å‹çš„å·®å¼‚ï¼Œä¾‹å¦‚ByteBufferå°±æ˜¯æŒ‰ç…§ç›´æ¥è¿›è¡Œè¯»å†™ï¼ŒCharBufferå°±æ˜¯æŒ‰ç…§å­—ç¬¦è¿›è¡Œè¯»å†™ã€‚\nJava NIOä¸­æµ·æ²¹ä¸€ç§Bufferå®ç°MappedByteBufferï¼Œè¿™ç§Bufferéœ€è¦ä¸å†…å­˜æ˜ å°„æ–‡ä»¶æ¥é…åˆä½¿ç”¨ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶å…ˆä¸äºˆä»‹ç»ã€‚\nNIO Selector # ä¸€ä¸ªselectorå…è®¸ä¸€ä¸ªå•ä¸€çº¿ç¨‹å¯¹å¤šä¸ªchannelä¸Šçš„äº‹ä»¶è¿›è¡Œå¤„ç†ï¼ˆLinuxå¹³å°ä¸‹çš„selectorå®ç°å°±æ˜¯åŸºäºepollï¼‰ï¼Œä¸€ä¸ªå•ä¸€çº¿ç¨‹ä¹Ÿå¯ä»¥å¯¹å¤šä¸ªchannelè¿›è¡Œé«˜æ•ˆçš„ioå¤„ç†ï¼Œä¾‹å¦‚ä¸€ä¸ªå¯èƒ½ä¼šåˆ›å»ºå¾ˆå¤štcpè¿æ¥æ¯ä¸ªtcpè¿æ¥æµé‡ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚æ„å»ºä¸€ä¸ªèŠå¤©æœåŠ¡ã€‚\nä¸‹å›¾æ˜¯ä¸€ä¸ªå•çº¿ç¨‹å€ŸåŠ©selectoræ¥å¯¹3ä¸ªchannelè¿›è¡Œioå¤„ç†çš„ç¤ºæ„å›¾ã€‚\nä½¿ç”¨selectorå¯¹å¤šä¸ªchannelè¿›è¡Œäº‹ä»¶å¤„ç†ï¼Œç±»ä¼¼äºepollä¸­é¦–å…ˆè¦å°†æŸäº›fdä¸Šçš„ç‰¹å®šäº‹ä»¶åœ¨epollfdæ³¨å†Œä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿéœ€è¦å…ˆå°†æˆ‘ä»¬å…³å¿ƒçš„channelä¸Šçš„ç‰¹å®šäº‹ä»¶åœ¨selectorä¸­æ³¨å†Œï¼Œç„¶åå°±åƒepollä¸­è°ƒç”¨epoll_wait()æ¥ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿä¸€æ ·ï¼Œè¿™é‡Œéœ€è¦è°ƒç”¨selector.select(æ–¹æ³•æ¥ç­‰å¾…äº‹ä»¶å‘ç”Ÿï¼Œç­‰æŸä¸ªäº‹ä»¶å‘ç”Ÿåå†è¿›å…¥åç»­çš„äº‹ä»¶å¤„ç†è¿‡ç¨‹ï¼Œæ¯”å¦‚æ”¶åˆ°tcpå…¥è¿æ¥è¯·æ±‚ã€æ•°æ®åˆ°è¾¾äº‹ä»¶ç­‰ã€‚\n3 NIO Channel # Java NIOä¸ Channelä¸æ ‡å‡†IOä¸­çš„streamï¼ˆæµï¼‰æœ‰æŸäº›ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¾ˆå¤§ä¸åŒã€‚\n åŒä¸€ä¸ªchannelæ—¢å¯è¯»åˆå¯å†™ï¼Œè€ŒåŒä¸€ä¸ªstreamè¦ä¹ˆåªå¯è¯»è¦ä¹ˆåªå¯å†™ï¼Œä»å‘½åXXInputStreamä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ˜æ˜¾çš„ä¸åŒï¼› channelä¸­çš„è¯»å†™æ“ä½œå¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œæ ‡å‡†ioä¸­çš„è¯»å†™æ“ä½œéƒ½æ˜¯åŒæ­¥çš„ï¼ˆåŒ…æ‹¬é˜»å¡ã€éé˜»å¡ï¼‰ï¼› channelä¸­è¯»å†™æ“ä½œæ€»æ˜¯å€ŸåŠ©äºbufferæ¥å®Œæˆçš„ï¼Œè€Œæµå¯ä»¥ç›´æ¥è¯»å†™ï¼›  è¿™é‡Œé¦–å…ˆç»™å‡ºä¸€ä¸ªç®€å•çš„FileChannelçš„ç¤ºä¾‹ç¨‹åºï¼Œè®©å¤§å®¶å¯¹channelã€bufferçš„ä½¿ç”¨æœ‰ä¸ªå¤§è‡´çš„äº†è§£ã€‚\n// æ‰“å¼€æ–‡ä»¶å¹¶è·å–FileChannel RandomAccessFile aFile = new RandomAccessFile(\u0026quot;data/nio-data.txt\u0026quot;, \u0026quot;rw\u0026quot;); FileChannel inChannel = aFile.getChannel(); // åˆ›å»ºä¸€ä¸ªå­—èŠ‚buffer ByteBuffer buf = ByteBuffer.allocate(48); // è¯»å–æ–‡ä»¶å†…å®¹åˆ°buffer int bytesRead = inChannel.read(buf); while (bytesRead != -1) { System.out.println(\u0026quot;Read \u0026quot; + bytesRead); // åˆ‡æ¢bufferè¯»å†™æ¨¡å¼ï¼Œä»å†™åˆ°è¯» buf.flip(); // æ‰“å°bufferä¸­çš„å†…å®¹ while(buf.hasRemaining()){ System.out.print((char) buf.get()); } // æ¸…ç©ºbufferç»§ç»­è¯»æ–‡ä»¶ buf.clear(); bytesRead = inChannel.read(buf); } // å…³é—­æ–‡ä»¶ aFile.close();  ä¸Šé¢è¿™ä¸ªç¤ºä¾‹ç¨‹åºç®€å•ä»‹ç»äº†FileChannel \u0026amp; ByteBufferçš„ä½¿ç”¨æ–¹å¼ï¼Œå…¶ä»–çš„å‡ ä¸ªChannel \u0026amp; Bufferå®ç°çš„ä½¿ç”¨æ–¹å¼ä¸æ­¤æœ‰äº›ç±»ä¼¼ï¼Œæˆ‘ä»¬åé¢å†å±•å¼€ã€‚\nè¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹æ˜¯Bufferçš„è¯»å†™æ¨¡å¼åˆ‡æ¢ï¼Œä¾‹å­ç¨‹åºä¸­bufferä¸€å¼€å§‹å¤„äºå†™æ¨¡å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰èƒ½ä»channelä¸­è¯»å–æ•°æ®å­˜å‚¨åˆ°bufferä¸­ï¼Œè€Œåæˆ‘ä»¬æƒ³æŸ¥çœ‹bufferä¸­çš„å†…å®¹ï¼Œè¿™ä¸ªæ—¶å€™é¦–å…ˆéœ€è¦å°†bufferä»å†™æ¨¡å¼åˆ‡æ¢ä¸ºè¯»æ¨¡å¼ï¼Œç„¶åæ‰èƒ½å°†å…¶ä¸­çš„å†…å®¹è¯»å–å¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚\nè¯»è€…å¯èƒ½è¦é—®ä¸ºä»€ä¹ˆbufferè¦åˆ‡æ¢è¯»å†™æ¨¡å¼ï¼Œè¿™é‡Œå…ˆç®€å•è¯´ä¸€ä¸‹ï¼Œbufferçš„åº•å±‚æ˜¯å€ŸåŠ©ä¸€ä¸ªæ•°ç»„æ¥å®ç°çš„ï¼Œå…¶é€šè¿‡å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„ä½ç½®ç´¢å¼•å˜é‡æ¥è·Ÿè¸ªå½“å‰è¯»å†™ä½ç½®ç´¢å¼•positionã€æœ€å¤§å¯è¯»å†™ä½ç½®ç´¢å¼•limitã€æœ€å¤§å®¹é‡capacityï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªæ•°ç»„ï¼Œè¦æƒ³æ”¯æŒè¯»å†™ä¸¤ç§æ¨¡å¼çš„åŒæ—¶ä¸è‡´å‡ºç°æ··ä¹±ï¼Œè¯»å†™æ“ä½œä¹‹å‰å°±éœ€è¦æ”¹å˜ä¸Šè¿°posã€maxã€capacityè¿™3ä¸ªä½ç½®ç´¢å¼•å˜é‡çš„è¯­ä¹‰å’Œå€¼ï¼Œå› æ­¤è¦è°ƒç”¨buffer.flip()æ–¹æ³•ã€‚\nå½“æˆ‘ä»¬è¯»å–äº†bufferä¸­çš„æ•°æ®æ—¶ï¼Œéœ€è¦è°ƒç”¨buffer.clear()æ¥æ¸…ç©ºæ‰€æœ‰çš„bufferä¸­æ•°æ®ï¼Œæˆ–è€…è°ƒç”¨buffer.compact()æ¥æ¸…ç©ºå·²ç»è¯»å–çš„æ•°æ®ï¼Œæ²¡æœ‰è¯»å–çš„æ•°æ®åˆ™ç»§ç»­ç•™åœ¨bufferä¸­ï¼Œå¹¶ä¸”æ•°æ®ä¼šè¢«ç§»åŠ¨åˆ°bufferä¸­æ•°ç»„çš„èµ·å§‹ä½ç½®ï¼Œå½“æˆ‘ä»¬ç»§ç»­å‘bufferä¸­å†™æ•°æ®æ—¶æ•°æ®ä¼šè¿½åŠ åœ¨æœªè¯»å–æ•°æ®çš„åé¢ã€‚\næ€»ç»“ä¸€ä¸‹bufferçš„ä½¿ç”¨è¿‡ç¨‹ï¼Œä¸»è¦åŒ…æ‹¬å¦‚ä¸‹4æ­¥ï¼š\n å†™æ•°æ®åˆ°bufferä¸­ï¼› è°ƒç”¨buffer.flip()å°†bufferä»å†™æ¨¡å¼åˆ‡æ¢ä¸ºè¯»æ¨¡å¼ï¼› ä»bufferä¸­è¯»å–å‡ºæ•°æ®ï¼› è°ƒç”¨buffer.clear()æ¸…ç©ºæ•°æ®æˆ–è€…buffer.compact()æ¸…ç©ºä»¥è¯»å–æ•°æ®ï¼›   å¤‡æ³¨ï¼š\nè¿™é‡Œçš„flipæ–¹æ³•æ˜¯ä¸ºäº†èƒ½å¤Ÿæ­£ç¡®è¯»å–å†™å…¥æ¨¡å¼ä¸‹å†™å…¥çš„æ•°æ®ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¿®æ”¹positionã€limitå˜é‡åå¯ä»¥ä¿è¯è¿™ä¸€ç‚¹ã€‚æˆ‘ä»¬ä¸è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥è¯»å–æ•°æ®ï¼Œä½†æ˜¯ä¼šè¯»å–åˆ°é”™è¯¯çš„æ•°æ®ï¼Œåˆ‡è®°ï¼ŒJavaå¹¶ä¸ä¼šåœ¨æˆ‘ä»¬â€œå¿˜è®°â€è°ƒç”¨flipæ–¹æ³•æ—¶ç»™å‡ºè­¦å‘Šæˆ–è€…é”™è¯¯ï¼Œéœ€è¦ç¨‹åºå¼€å‘äººå‘˜è‡ªå·±æ¥æŒæ§ã€‚\nå¯¹äºå†™æ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè°ƒç”¨clearæˆ–compactæ–¹æ³•å¯ä»¥ä¿è¯æœ‰å¯ç”¨ç©ºé—´æ¥å­˜å‚¨å³å°†è¦å†™å…¥çš„æ•°æ®ï¼Œå½“â€œå¿˜è®°â€è°ƒç”¨è¯¥æ–¹æ³•æ—¶ä¹Ÿå¯ä»¥å†™å…¥(bufferæœªæ»¡)ï¼Œä½†æ˜¯æµªè´¹äº†bufferå­˜å‚¨ç©ºé—´ï¼Œåªèƒ½å†™å…¥å°‘é‡æ•°æ®ã€‚\nflipã€clearã€compactï¼Œä»¥åŠåé¢è§è¦è§åˆ°çš„markã€resetæ–¹æ³•ï¼Œéƒ½åªæ˜¯ä¿®æ”¹å½±å“è¯»å†™ä½ç½®çš„positionã€limitçš„å€¼è€Œå·²ï¼Œæ²¡æœ‰ä»€ä¹ˆç¥ç§˜çš„ã€‚\n è¿™ä¹ˆè®²å¯èƒ½ä»ç„¶æœ‰ç‚¹æŠ½è±¡ï¼Œåé¢ä¼šç»“åˆç¤ºæ„å›¾è¿›è¡Œè¿›ä¸€æ­¥æè¿°ã€‚\n4 NIO Buffer # NIOåº•å±‚æ˜¯å€ŸåŠ©ä¸€ä¸ªæ•°ç»„æ¥å®ç°çš„ï¼Œä½¿ç”¨åŒä¸€ä¸ªæ•°ç»„å®ç°äº†è¯»ã€å†™ä¸¤ç§ä¸åŒçš„æ“ä½œæ¨¡å¼ã€‚ä¸ºäº†æ”¯æŒè¯»å†™æ“ä½œï¼ŒBufferå®ç°ä¸­æä¾›äº†3ä¸ªéå¸¸é‡è¦çš„å˜é‡positionã€limitã€capacityæ¥è·Ÿè¸ªæ•°ç»„çš„è¯»å†™æŒ‡é’ˆï¼ˆå®é™…ä¸Šæ˜¯ä½ç½®ç´¢å¼•ï¼‰ã€‚\nåœ¨ä¸åŒçš„æ“ä½œæ¨¡å¼ï¼ˆè¯»ã€å†™æ¨¡å¼ï¼‰ä¸‹ï¼Œè¿™é‡Œçš„positionã€limitã€capacityæ‹¥æœ‰ä¸åŒçš„è¯­ä¹‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n å†™æ¨¡å¼ä¸‹ï¼š  positionï¼Œä»£è¡¨å½“å‰å¯ç»§ç»­å†™å…¥çš„ä½ç½®ç´¢å¼•ï¼Œ[0,position)ä¸ºå·²å†™å…¥æ•°æ®èŒƒå›´ï¼› limitï¼Œä»£è¡¨å½“å‰å¯å†™å…¥çš„æœ€å¤§ä½ç½®ç´¢å¼•ï¼Œlimit=capacityï¼Œ[position,limit)ä¸ºå¯å†™æ•°æ®èŒƒå›´ï¼› capacityï¼Œä»£è¡¨å½“å‰bufferæœ€å¤§å®¹é‡ï¼Œï¼›   è¯»æ¨¡å¼ä¸‹ï¼š  positionï¼Œä»£è¡¨å½“å‰å¯ç»§ç»­è¯»å–çš„ä½ç½®ç´¢å¼•ï¼› limitï¼Œä»£è¡¨å½“å‰å¯è¯»å–çš„æœ€å¤§ä½ç½®ç´¢å¼•ï¼Œ[position,limit)ä¸ºå¯è¯»å–æ•°æ®èŒƒå›´ï¼› capacityï¼Œä»£è¡¨å½“å‰bufferæœ€å¤§å®¹é‡ï¼Œ[limit,capacity)ä¸ºæœªå†™å…¥æ•°æ®èŒƒå›´ï¼›    4.1 capacity # capacityä»£è¡¨äº†bufferçš„æœ€å¤§å®¹é‡ï¼Œå…¶å€¼ä¸ºæœ€å¤šå¯å­˜å‚¨çš„å…ƒç´ æ•°é‡è€Œéå ç”¨çš„å­—èŠ‚æ•°é‡ï¼Œè¿™ä¸ªä¸éš¾ç†è§£ï¼Œæ¯ä¸€ç§æ•°æ®ç±»å‹éƒ½ä½¿ç”¨ä¸ä¹‹å¯¹åº”çš„æ•°ç»„æ¥ä½œä¸ºå­˜å‚¨ç”¨çš„åŸºç¡€è®¾æ–½ã€‚\n4.2 position # å†™æ¨¡å¼ä¸‹ï¼Œpositionåˆå§‹å€¼ä¸º0ï¼Œç„¶åæ¯å†™å…¥ä¸€ä¸ªå…ƒç´ åˆ°bufferä¸­ä¹‹åpositionä¼š+1æŒ‡å‘åº•å±‚æ•°ç»„çš„ä¸‹ä¸€ä¸ªå­˜å‚¨ä½ç½®ã€‚å†™æ¨¡å¼ä¸‹positionæœ€å¤§å€¼ä¸ºcapacity-1ã€‚\nå½“ä»å†™æ¨¡å¼åˆ‡æ¢åˆ°è¯»æ¨¡å¼çš„æ—¶å€™ï¼Œpositionä¼šè¢«é‡ç½®ä¸º0ï¼Œlimitä¼šè¢«é‡ç½®ä¸ºå†™æ¨¡å¼ä¸‹positionçš„å€¼ï¼Œè¿™æ ·å°±æ„å‘³ç€åªå¯ä»¥è¯»å–åˆ°å†™æ¨¡å¼ä¸‹å†™å…¥åˆ°æ•°ç»„ä¸­çš„æ•°æ®è€Œä¸ä¼šè®¿é—®è¶Šç•Œã€‚å½“è¯»å–æ•°æ®æ—¶å…ˆè¯»å–positionä½ç½®å¤„çš„å…ƒç´ ï¼Œç„¶åposition+1æŒ‡å‘åº•å±‚æ•°ç»„çš„ä¸‹ä¸€ä¸ªå­˜å‚¨ä½ç½®ã€‚\n4.3 limit # å†™æ¨¡å¼ä¸‹ï¼Œlimitè¡¨ç¤ºæœ€å¤šå¯ä»¥å†™å…¥å¤šå°‘ä¸ªå…ƒç´ ï¼Œlimit=capacityï¼›è€Œåœ¨è¯»æ¨¡å¼ä¸‹ï¼Œlimitè¡¨ç¤ºæœ€å¤šå¯ä»¥è¯»å–å¤šå°‘ä¸ªå…ƒç´ ï¼Œlimit=buffer.flip()å‰å†™æ¨¡å¼ä¸‹çš„positionã€‚\n4.4 å¸¸ç”¨æ–¹æ³• # ä¸‹é¢å¯¹Bufferä¸­å¸¸ç”¨çš„æ–¹æ³•è¿›è¡Œä¸€ä¸‹ç®€è¦æ€»ç»“ã€‚\n4.4.1 åˆ›å»ºbuffer # allocateæ–¹æ³•ç”¨äºåˆ›å»ºä¸€ä¸ªæŒ‡å®šå®¹é‡çš„bufferå¯¹è±¡ï¼Œä¸‹é¢åˆ†åˆ«åˆ›å»ºä¸€ä¸ª48å­—èŠ‚å®¹é‡çš„ByteBufferå’Œä¸€ä¸ª1024å­—ç¬¦å®¹é‡çš„CharBufferã€‚\nByteBuffer buf = ByteBuffer.allocate(48); CharBuffer buf = CharBuffer.allocate(1024);  4.4.2 å†™æ•°æ®åˆ°buffer # å‘bufferä¸­å†™å…¥æ•°æ®ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯é€šè¿‡channel.read(buffer)æ¥å°†channelä¸­çš„æ•°æ®å†™å…¥åˆ°bufferä¸­ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡buffer.put(el)æ–¹æ³•åŠå…¶å„ç§å˜ä½“æ¥å°†å¯¹åº”ç±»å‹çš„å…ƒç´ elå†™å…¥åˆ°bufferä¸­ã€‚\nint bytesRead = inChannel.read(buf); // read from channel into buffer. buf.put(127); // ...  4.4.3 åˆ‡æ¢bufferä¸ºè¯»æ¨¡å¼ # buffer.flip()æ–¹æ³•å°†bufferä»å†™æ¨¡å¼åˆ‡æ¢ä¸ºè¯»æ¨¡å¼ï¼Œè°ƒç”¨flipä¹‹åå°†æŠŠlimitè®¾ç½®ä¸ºpositionçš„å€¼ï¼Œç„¶åå†è§positionè®¾ç½®ä¸º0ï¼Œä½¿å¾—å¯ä»¥è¯»å–[0,limit)èŒƒå›´ä¸‹çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å†™æ¨¡å¼ä¸‹å†™å…¥çš„æ•°æ®ï¼Œé€šè¿‡limitçš„æ§åˆ¶é¿å…æ•°ç»„è®¿é—®è¶Šç•Œçš„å¯èƒ½ã€‚\n4.4.4 ä»bufferä¸­è¯»å–æ•°æ® # ä»bufferä¸­è¯»å–æ•°æ®ï¼Œä¹Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡channel.write(buffer)å°†bufferä¸­çš„æ•°æ®è¯»å–å‡ºæ¥å†™å…¥åˆ°channelä¸­ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡buffer.get()æ–¹æ³•åŠå…¶å„ç§å˜ä½“æ¥å°†å¯¹åº”ç±»å‹çš„å…ƒç´ è¯»å–å‡ºæ¥ã€‚\nint bytesWritten = inChannel.write(buf); // read from buffer into channel buf.get(); // ...  4.4.5 rewindè¯»å–ç´¢å¼• # buffer.rewind()æ–¹æ³•ä¼šå°†è¯»ç´¢å¼•å˜é‡positioné‡è®¾ä¸º0ï¼Œä½†æ˜¯limitä¿æŒä¸å˜ï¼Œè¿™æ ·å¯ä»¥é‡æ–°ä»å¤´å¼€å§‹è¯»å–bufferä¸­çš„æ•°æ®ã€‚\n4.4.6 æ¸…ç©ºbufferå¤‡ç”¨ # å½“bufferä¸­çš„æ•°æ®è¯»å–å‡ºæ¥ä¹‹åï¼Œéœ€è¦æ¸…ç©ºbufferä¸­çš„æ•°æ®ç”¨äºåç»­çš„æ•°æ®å†™å…¥æ“ä½œã€‚\nå¦‚æœç¡®å®šæ•°æ®å·²ç»è¯»å–å®Œæ¯•ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è°ƒç”¨buffer.clear()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°†æŠŠpositionè®¾ä¸º0ï¼Œå°†limitè®¾ç½®ä¸ºcapacityï¼Œè¿™æ„å‘³ç€è°ƒç”¨äº†clearæ–¹æ³•ä¹‹åbufferä¸­çš„æ‰€æœ‰å·²å­˜å‚¨æ•°æ®éƒ½ä¸åœ¨å¯è¯»ï¼Œå› ä¸ºå·²ç»æ²¡æœ‰ä½ç½®å˜é‡å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¯»å–å®ƒä»¬äº†ã€‚\nå¦‚æœæ•°æ®æ²¡æœ‰è¯»å–å®Œæ¯•ï¼Œå‰©ä¸‹çš„æ•°æ®è¿˜æ˜¯å¸Œæœ›ç»§ç»­è¯»ï¼Œä½†æ˜¯ç°åœ¨è¦å…ˆå†™å…¥æŸäº›æ•°æ®ï¼Œæ­¤æ—¶å¯ä»¥æ‰§è¡Œbuffer.compact()æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†æŠŠbufferä¸­æœªè¯»å–çš„æ•°æ®æ‹·è´åˆ°åº•å±‚æ•°ç»„çš„å‰é¢ï¼Œå¹¶å°†positionè®¾ä¸º0ï¼Œå°†limitè®¾ç½®ä¸ºæœªè¯»å–æ•°æ®çš„å…ƒç´ æ•°é‡ã€‚\n4.4.7 mark \u0026amp; reset # buffer.mark()å¯ä»¥æ ‡è®°å½“å‰çš„positionä½ç½®ï¼Œåé¢å½“positionæ”¹å˜ä¹‹åå¯ä»¥é€šè¿‡buffer.reset()å°†positioné‡ç½®ä¸ºè°ƒç”¨markæ–¹æ³•æ—¶æ ‡è®°çš„ä½ç½®ã€‚\nè¿™é‡Œmark()ã€reset()åœ¨è¯»å†™æ¨¡å¼ä¸‹éƒ½å¯ä»¥ä½¿ç”¨ï¼Œmarkçš„å®ç°æ–¹å¼å°±æ˜¯é€šè¿‡ä¸€ä¸ªmarkå˜é‡è®°å½•ä¸‹å½“å‰çš„positionä½ç½®ï¼Œresetæ–¹æ³•å°±æ˜¯å°†positionè®¾ç½®ä¸ºmarkè®°å½•çš„å€¼ã€‚\nä¸ºäº†é¿å…è¯»å†™æ¨¡å¼åˆ‡æ¢æ—¶mark()ã€reset()è¢«ä¹±ç”¨ï¼Œè¿™é‡Œbuffer.reset()çš„æ—¶å€™ä¼šé¦–å…ˆæ£€æŸ¥å½“å‰çš„markå€¼æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœmarkå€¼å°äº0åˆ™è®¤ä¸ºæ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹markå€¼ä¼šä¸ºè´Ÿå€¼å‘¢ï¼Ÿå½“æ‰§è¡Œbuffer.flip()æ“ä½œçš„æ—¶å€™ä¼šå°†markå€¼é‡ç½®ä¸º-1ï¼Œè¿™æ ·å°±é¿å…äº†è¯»å†™æ¨¡å¼åˆ‡æ¢åä¹‹å‰çš„markå¯èƒ½è¢«é”™è¯¯resetçš„æƒ…å†µï¼Œé¿å…äº†å¯èƒ½çš„è®¿é—®è¶Šç•Œé—®é¢˜ã€‚\n4.4.8 bufferå†…å®¹æ¯”è¾ƒ # bufferå†…å®¹æ¯”è¾ƒä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯æ¯”è¾ƒä¸¤ä¸ªbufferæ˜¯å¦ç›¸ç­‰buf1.equals(buf2)ï¼Œå¦‚æœä¸¤ä¸ªbufçš„ç±»å‹ç›¸åŒï¼Œå¹¶ä¸”ä¸¤ä¸ªbufä¸­å‰©ä½™å…ƒç´ æ•°é‡ç›¸åŒï¼Œå¹¶ä¸”ä¸¤ä¸ªbufä¸­å‰©ä½™çš„å…ƒç´ åœ¨å¯¹åº”positionå¤„éƒ½equalséƒ½è¿”å›trueï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªbuf1.equals(buf2)æ‰ä¼šè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚\nbufferå†…å®¹æ¯”è¾ƒçš„å¦ä¸€ä¸ªæ–¹æ³•æ˜¯é€šè¿‡buf1.compareTo(buf2)ï¼Œå½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œè®¤ä¸ºbuf1\u0026lt;buf2ï¼Œå¦‚æœä¸¤ä¸ªbufç±»å‹ç›¸åŒï¼Œå¹¶ä¸”buf1ä¸­çš„å‰i-1ä¸ªå…ƒç´ ä¸buf2ä¸­çš„å‰i-1ä¸ªå…ƒç´ å¯¹åº”ä½ç½®éƒ½å®Œå…¨ç›¸ç­‰ï¼Œä½†æ˜¯buf1ä¸­çš„ç¬¬iä¸ªå…ƒç´ æ¯”buf2ä¸­çš„ç¬¬iä¸ªå…ƒç´ å°ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºbuf1\u0026lt;buf2æˆç«‹ï¼›æˆ–è€…buf1ä¸­çš„æ‰€æœ‰å…ƒç´ ä¸buf2ä¸­å¯¹åº”ä½ç½®çš„å…ƒç´ éƒ½å®Œå…¨ç›¸ç­‰ï¼Œä½†æ˜¯buf2è¿˜æœ‰æ›´å¤šçš„å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿè®¤ä¸ºbuf1\u0026lt;buf2ã€‚buf1\u0026gt;buf2çš„é€»è¾‘ä¸ä¹‹æ°å¥½ç›¸åï¼Œbuf1.equals(buf2)çš„é€»è¾‘å‰é¢å·²ç»æè¿‡ã€‚\n å¤‡æ³¨ï¼š\nå½“buf1\u0026lt;buf2æ—¶ï¼Œbuf1.compareTo(buf2)ä¼šè¿”å›ä¸€ä¸ªè´Ÿæ•°ï¼›\nå½“buf1==buf2æ—¶ï¼Œbuf1.compareTo(buf2)ä¼šè¿”å›0ï¼›\nå½“buf1\u0026gt;buf2æ—¶ï¼Œbuf1.compareTo(buf2)ä¼šè¿”å›ä¸€ä¸ªæ­£æ•°ï¼›\n 5 NIO Scatter \u0026amp; Gather # NIOä¸­æ”¯æŒåˆ†æ•£è¯»ã€èšé›†å†™ï¼Œglibcä¸­ä¹Ÿæä¾›äº†ç±»ä¼¼çš„åº“å‡½æ•°ï¼ŒNIOä¸­çš„åˆ†æ•£è¯»æŒ‡çš„æ˜¯ä»ä¸€ä¸ªchannelä¸­è¯»å–æ•°æ®åˆ°å¤šä¸ªbufferä¸­ï¼Œèšé›†å†™æŒ‡çš„æ˜¯å°†å¤šä¸ªbufferä¸­çš„æ•°æ®å†™å…¥channelä¸­ã€‚\nå½“æˆ‘ä»¬éœ€è¦ä¼ è¾“çš„æ•°æ®å¯ä»¥åˆ†å¼€å‡ ä¸ªå›ºå®šéƒ¨åˆ†æ¥å¤„ç†çš„æ—¶å€™ï¼Œåˆ†æ•£è¯»ã€èšé›†å†™æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬ä¼ è¾“åè®®æ•°æ®åŒ…çš„æ—¶å€™ï¼Œå¸Œæœ›å°†åè®®åŒ…å¤´ã€åè®®åŒ…ä½“åˆ†å¼€ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨åˆ†æ•£è¯»ã€èšé›†å†™å°±æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå› ä¸ºåŒ…å¤´å¾€å¾€éƒ½æ˜¯å›ºå®šå°ºå¯¸çš„ï¼Œä»channelä¸­å…ˆè¯»å–å›ºå®šæ•°é‡çš„å­—èŠ‚å¡«æ»¡åŒ…å¤´å¯¹åº”çš„bufferï¼Œå†è§å‰©ä¸‹çš„æ•°æ®è¯»åˆ°åŒ…ä½“å¯¹åº”çš„bufferä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆè‡ªç„¶çš„è¿‡ç¨‹ã€‚ç»„åŒ…æ—¶èšé›†å†™ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚\n5.1 Scatter # ä¸‹é¢æ˜¯åˆ†æ•£è¯»çš„ä¸€ä¸ªç¤ºæ„å›¾ï¼Œå›¾ä¸­å±•ç¤ºäº†ä»ä¸€ä¸ªchannelä¸­è¯»å–æ•°æ®å†™å…¥å¤šä¸ªbufferçš„è¿‡ç¨‹ã€‚\nå¯¹åº”çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\nByteBuffer header = ByteBuffer.allocate(128); ByteBuffer body = ByteBuffer.allocate(1024); ByteBuffer[] bufferArray = { header, body }; channel.read(bufferArray);  é¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ªbufferï¼Œå‡å®šåŒ…å¤´æ˜¯å›ºå®š128å­—èŠ‚ï¼ŒåŒ…ä½“æœ€å¤§1024å­—èŠ‚ï¼Œç„¶ååˆåˆ›å»ºäº†ä¸€ä¸ªByteBufferæ•°ç»„ï¼Œå¹¶å°†å…¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™channel.read()æ–¹æ³•ï¼Œreadæ–¹æ³•ä¼šæŒ‰ç…§bufferArrayä¸­çš„å…ƒç´ é¡ºåºä¾æ¬¡è¿›è¡Œæ•°æ®å†™æ“ä½œï¼Œå½“å¡«å……æ»¡ç¬¬ä¸€ä¸ªbufferåå°±ç»§ç»­å†™ç¬¬äºŒä¸ªbufferï¼Œä»¥æ­¤ç±»æ¨ã€‚\n æ³¨æ„å¦‚æœåŒ…å¤´å°ºå¯¸ä¸å›ºå®šï¼Œé‚£ä¹ˆåˆ†æ•£è¯»å°±ä¸æ˜¯å¾ˆé€‚ç”¨äº†ã€‚\n 5.2 Gather # ä¸‹é¢æ˜¯èšé›†å†™çš„ä¸€ä¸ªç¤ºæ„å›¾ï¼Œå›¾ä¸­å±•ç¤ºäº†ä»å¤šä¸ªbufferä¸­è¯»å–æ•°æ®å¹¶å†™å…¥åŒä¸€ä¸ªchannelçš„è¿‡ç¨‹ã€‚\nå¯¹åº”çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\nByteBuffer header = ByteBuffer.allocate(128); ByteBuffer body = ByteBuffer.allocate(1024); ByteBuffer[] bufferArray = { header, body }; channel.write(bufferArray);  é¦–å…ˆä¹Ÿæ˜¯åˆ›å»ºä¸¤ä¸ªbufferï¼Œå‡å®šåŒ…å¤´æ˜¯å›ºå®š128å­—èŠ‚ï¼ŒåŒ…ä½“æœ€å¤§1024å­—èŠ‚ï¼Œç„¶åç”¨è¿™ä¸¤ä¸ªbufferåˆ›å»ºä¸€ä¸ªbufferæ•°ç»„ï¼Œå¹¶ä½œä¸ºchannel.write()çš„å‚æ•°ï¼Œwriteæ–¹æ³•æŒ‰ç…§bufferArrayä¸­bufferå‡ºç°é¡ºåºä¾æ¬¡å°†å…¶å†…å®¹å†™å…¥channelï¼Œå…ˆå°†ç¬¬ä¸€ä¸ªbufferçš„å†…å®¹å†™å…¥åˆ°channelï¼Œå†è§ç¬¬äºŒä¸ªbufferå†…å®¹å†™å…¥åˆ°channelï¼Œä»¥æ­¤ç±»æ¨ã€‚\n6 NIO Channelé—´æ•°æ®ä¼ è¾“ # åœ¨Java NIOä¸­ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªchannelå‘å¦ä¸€ä¸ªchannelè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„channelå®ç°éƒ½æ”¯æŒï¼Œè¿™é‡Œé‡ç‚¹è¯´ä¸€ä¸‹FileChannelï¼Œè¿™ä¸ªç±»æœ‰ä¸¤ä¸ªé‡è¦æ–¹æ³•transferFrom(\u0026hellip;)å’ŒtransferTo(\u0026hellip;)ï¼Œå‰è€…å¯ä»¥ä»å¦ä¸€ä¸ªchannelè¯»å–æ•°æ®ï¼Œåè€…å¯ä»¥å°†å½“å‰channelä¸­çš„æ•°æ®å†™å…¥åˆ°å¦ä¸€ä¸ªchannelã€‚\nä¸‹é¢çœ‹ä¸€ä¸ªFileChannel.transferFrom(\u0026hellip;)çš„åº”ç”¨ç¤ºä¾‹ã€‚\nRandomAccessFile fromFile = new RandomAccessFile(\u0026quot;fromFile.txt\u0026quot;, \u0026quot;rw\u0026quot;); FileChannel fromChannel = fromFile.getChannel(); RandomAccessFile toFile = new RandomAccessFile(\u0026quot;toFile.txt\u0026quot;, \u0026quot;rw\u0026quot;); FileChannel toChannel = toFile.getChannel(); long position = 0; long count = fromChannel.size(); toChannel.transferFrom(fromChannel, position, count);  ä¸‹é¢å†çœ‹ä¸€ä¸ªFileChannel.transferTo(\u0026hellip;)çš„åº”ç”¨ç¤ºä¾‹ã€‚\nRandomAccessFile fromFile = new RandomAccessFile(\u0026quot;fromFile.txt\u0026quot;, \u0026quot;rw\u0026quot;); FileChannel fromChannel = fromFile.getChannel(); RandomAccessFile toFile = new RandomAccessFile(\u0026quot;toFile.txt\u0026quot;, \u0026quot;rw\u0026quot;); FileChannel toChannel = toFile.getChannel(); long position = 0; long count = fromChannel.size(); fromChannel.transferTo(position, count, toChannel);  FileChannel.transferFrom(\u0026hellip;)æ–¹æ³•ä¹Ÿå¯ä»¥è¯»å–å…¶ä»–ç±»å‹channelä¸­çš„æ•°æ®ï¼ŒFileChannel.transferTo(\u0026hellip;)æ–¹æ³•ä¹Ÿå¯ä»¥å°†FileChannelä¸­çš„æ•°æ®å†™å…¥åˆ°å…¶ä»–ç±»å‹çš„channelä¸­ã€‚\n7 NIO Selector # NIOä¸­çš„selectoræ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„ç»„ä»¶ï¼Œå¯ä»¥ç”¨å®ƒæ¥ç›‘è§†å¤šä¸ªå¤šä¸ªchannelä¸Šçš„ioäº‹ä»¶ï¼Œä¾‹å¦‚å…¥è¿æ¥è¯·æ±‚ã€æ•°æ®å¯è¯»ã€æ•°æ®å¯å†™ç­‰ï¼Œè¿™æ„å‘³ç€å¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªchannelï¼Œå¯ä»¥è·å¾—ä¸é”™çš„å¹¶å‘å¤„ç†æ€§èƒ½ã€‚\n7.1 ä¸ºä»€ä¹ˆä½¿ç”¨Selectorï¼Ÿ # ä½¿ç”¨selectorå¯ä»¥åªç”¨ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªchannelä¸Šçš„ioäº‹ä»¶ï¼Œæ— é¡»åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥å¤„ç†å¤šä¸ªchannelï¼Œå‡å°‘åˆ›å»ºçº¿ç¨‹çš„æ•°é‡å¯ä»¥é¿å…æ“ä½œç³»ç»Ÿåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢æ‰€å¼•å…¥çš„è´Ÿè½½ã€‚\næ—¢ç„¶æåˆ°äº†çº¿ç¨‹åˆ‡æ¢æ‰€å¼•å…¥çš„è´Ÿè½½ï¼Œè¿™é‡Œå°±å¯¹Javaçº¿ç¨‹è°ƒåº¦çš„å†…å®¹å±•å¼€æè¿°ä¸€ä¸‹ï¼Œä»‹ç»ä¸€ä¸‹Javaçº¿ç¨‹ã€LWPè¿›ç¨‹ã€KLTçº¿ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œä¹Ÿæè¿°ä¸€ä¸‹åˆ›å»ºã€åˆ‡æ¢è¿‡ç¨‹ä¸­çš„ä»£ä»·ï¼Œå¸®åŠ©æ›´å¥½åœ°ç†è§£ã€‚ç„¶åæˆ‘ä»¬å†ä»‹ç»ä¸€ä¸‹é¢å¯¹ä¸åŒçš„ä»»åŠ¡ï¼Œå¯¹äºå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹è¯¥å¦‚ä½•é€‰æ‹©ã€‚æœ€åæˆ‘ä»¬å†ç»§ç»­ä»‹ç»è¿™é‡Œçš„selectorã€‚\n7.1.1 Javaçº¿ç¨‹ã€LWPè¿›ç¨‹ã€KLTçº¿ç¨‹ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿ # Linuxä¸‹Hotspot JVMé‡‡ç”¨çš„çº¿ç¨‹æ¨¡å‹æ˜¯åŸºäºâ€œç”¨æˆ·çº§çº¿ç¨‹+KLTçº¿ç¨‹â€å®ç°çš„ï¼Œå¹¶ä¸”æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œå³ä¸€ä¸ªJava Threadéƒ½ä¼šæ˜ å°„åˆ°ä¸€ä¸ªLinuxå†…æ ¸çº¿ç¨‹ï¼Œçº¿ç¨‹è°ƒåº¦åˆ©ç”¨äº†Linuxçš„çº¿ç¨‹è°ƒåº¦èƒ½åŠ›ã€‚\nè¿™é‡Œæœ‰å¿…è¦æä¸€ä¸‹Linuxå†…æ ¸å¯¹çº¿ç¨‹æä¾›çš„æ”¯æŒï¼ŒLinuxå†…æ ¸æœ¬èº«æ˜¯æ²¡æœ‰ä»€ä¹ˆçº¿ç¨‹çš„ï¼Œå…¶åœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯é¢å‘è¿›ç¨‹çš„ï¼Œæœ€å¼€å§‹è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œä¹Ÿæ˜¯ä»»åŠ¡è°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚ä½†æ˜¯åé¢å‘ç°è¿›ç¨‹åˆ›å»ºã€é”€æ¯ã€åˆ‡æ¢çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œå¦‚æœäº†è§£è¿‡å†…æ ¸åˆ›å»ºè¿›ç¨‹çš„å®ç°çš„è¯å°±ä¼šæ˜ç™½è¿™é‡Œçš„å¼€é”€æŒ‡çš„éƒ½æ˜¯ä»€ä¹ˆã€‚\nå½“çº¿ç¨‹æ€æƒ³å¼€å§‹å‡ºç°ä¹‹åï¼ŒLinuxå½“ç„¶ä¹Ÿä¸ä¼šæ±²å–ç²¾åï¼Œä¸ºäº†æ”¯æŒçº¿ç¨‹æœºåˆ¶ï¼ŒLinuxå†…æ ¸ä¸­å¼•å…¥äº†è½»é‡çº§è¿›ç¨‹(LWPï¼ŒLight Weight Process)çš„æ¦‚å¿µï¼Œè¿™é‡Œçš„â€œè½»é‡çº§â€ä½“ç°åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿå¦‚æœäº†è§£è¿‡å†…æ ¸åˆ›å»ºè¿›ç¨‹è¿‡ç¨‹ä¸­cloneåŠå…¶æŸäº›ç‰¹æ®Šé€‰é¡¹çš„è¯ï¼Œå°±ä¼šæ˜ç™½åˆ›å»ºè½»é‡çº§è¿›ç¨‹æ¯”åˆ›å»ºä¸€ä¸ªæ™®é€šçš„è¿›ç¨‹è½»é‡åœ¨ä»€ä¹ˆåœ°æ–¹äº†ï¼Œç®€è¨€ä¹‹å°±æ˜¯è½»é‡çº§è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™å…±äº«çˆ¶è¿›ç¨‹æ‰€æœ‰çš„èµ„æºï¼Œåªæ˜¯å¢åŠ èµ„æºå¯¹åº”çš„å¼•ç”¨è®¡æ•°ï¼Œä½†æ˜¯ä¸ä¼šé‡æ–°åˆ†é…ï¼Œä¸åŒäºforkã€‚\nè½»é‡çº§è¿›ç¨‹ä¹Ÿæ˜¯è¿›ç¨‹ï¼Œé‚£ä¹ˆçº¿ç¨‹ç›¸å¯¹äºè¿›ç¨‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿçº¿ç¨‹ä¸æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œåªæ˜¯ä»»åŠ¡è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œå¯¹æ¯”ä¸€ä¸‹linux 0.11ä»¥åŠ2.0.40ä¸­struct task_structç»“æ„ä½“çš„å®šä¹‰å°±å¯ä»¥æ„Ÿå—åˆ°ä»»åŠ¡è°ƒåº¦çš„åŸºæœ¬å•ä½ä»è¿›ç¨‹å˜ä¸ºçº¿ç¨‹è¿™ä¸€è¿‡ç¨‹ã€‚åœ¨0.11é‡Œé¢task_structç»“æ„ä½“ä¸­çš„tssï¼ˆä»»åŠ¡çŠ¶æ€æ®µï¼Œä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼‰ä¸ºstruct tss_structç±»å‹ï¼Œè¿™ä¸€ç±»å‹æ˜¯é¢å‘è¿›ç¨‹çš„ï¼Œè€Œ0.2.40é‡Œé¢tssæ˜¯struct thread_structç±»å‹ï¼Œè¿™ä¸€ç±»å‹æ˜¯é¢å‘çº¿ç¨‹çš„ã€‚è€Œä¸ç®¡æ˜¯æ™®é€šè¿›ç¨‹è¿˜æ˜¯è½»é‡çº§è¿›ç¨‹ï¼Œå®ƒä»¬çš„task_structå®šä¹‰ä¸­éƒ½åŒ…æ‹¬ä¸€ä¸ªstruct thread_struct tssï¼Œç”¨äºä»»åŠ¡è°ƒåº¦è¿‡ç¨‹ã€‚\nLinuxä¸‹çš„KLTçº¿ç¨‹å…¶å®å¹¶ä¸æ˜¯ä»€ä¹ˆçœŸæ­£çš„çº¿ç¨‹ï¼Œå…¶å¼ºè°ƒçš„æ˜¯ä¸€ç§é¢å‘çº¿ç¨‹çš„ä»»åŠ¡åˆ‡æ¢èƒ½åŠ›ã€‚Javaä¸­çš„çº¿ç¨‹é€»è¾‘ä¸Šæ˜¯ä»å±äºjavaè¿›ç¨‹çš„ï¼Œåœ¨Linuxå¹³å°ä¸‹å®ç°æ—¶Javaä¸»çº¿ç¨‹è¢«æ˜ å°„ä¸ºä¸€ä¸ªæ™®é€šçš„è¿›ç¨‹ï¼Œè€Œå…¶ä»–Javaçº¿ç¨‹è¢«æ˜ å°„ä¸ºç³»ç»Ÿè¿›ç¨‹cloneå‡ºæ¥çš„è½»é‡çº§è¿›ç¨‹LWPï¼Œè¿™é‡Œcloneå‡ºæ¥çš„LWPçš„tgidï¼ˆçº¿ç¨‹ç»„idï¼‰ä¸æ™®é€šè¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰æ˜¯ç›¸åŒçš„ï¼Œå› ä¸ºé€»è¾‘ä¸Šå®ƒä»¬ä»å±äºåŒä¸€ä¸ªçº¿ç¨‹ç»„ã€‚æ™®é€šè¿›ç¨‹è·Ÿè½»é‡çº§è¿›ç¨‹åœ¨ä»»åŠ¡åˆ‡æ¢æ—¶æ‰€éœ€è¦æ‰§è¡Œçš„é™¤tssä¿å­˜ã€è¿˜åŸä¹‹å¤–çš„é™„åŠ å·¥ä½œæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿›ç¨‹çš„é™„åŠ å·¥ä½œæ›´é‡ï¼ˆå¯èƒ½ä¼šæ¶‰åŠåˆ°è™šæ‹Ÿå†…å­˜ç­‰çš„å¤„ç†ï¼‰ï¼Œåˆ‡æ¢æ•ˆç‡æ›´ä½ã€‚\nä»»åŠ¡åˆ‡æ¢è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°çš„å†…å®¹è¯´èµ·æ¥å¯èƒ½å°±å‡ ä¸ªå…³é”®ç‚¹ï¼Œä½†æ˜¯å¦‚æœæƒ³æŠŠç»†èŠ‚è®²æ¸…æ¥šï¼Œéœ€è¦ç»“åˆè½¯ç¡¬ä»¶å˜è¿çš„å†å²ã€å„ç§å¯èƒ½çš„æƒ…æ™¯æ¥æè¿°ï¼Œè¯·åŸè°…æˆ‘è¿˜æŒæ¡çš„è¿˜ä¸å¤Ÿï¼Œè¿™é‡Œå°±å…ˆç‚¹åˆ°ä¸ºæ­¢ã€‚\nè®²äº†è¿™ä¹ˆå¤šï¼Œçœ‹ä¸Šå»å¥½åƒæ˜¯è¦å¤§è‚†å®£æ‰¬ä½¿ç”¨Javaå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œè¿™é‡Œä¸æ˜¯ï¼Œåªæ˜¯æƒ³åˆ°äº†å®ç°è¿›ç¨‹ã€çº¿ç¨‹æ‰€éœ€è¦ä»˜å‡ºçš„ä»£ä»·ï¼Œå¤šçº¿ç¨‹ç¡®å®æ¯”å¤šè¿›ç¨‹æ›´åŠ è½»é‡ï¼Œä½†ä¹Ÿå¹¶éå¤šçº¿ç¨‹ä¸€å®šæ¯”å¤šè¿›ç¨‹å¥½ï¼Œè¦çœ‹å®é™…çš„åº”ç”¨åœºæ™¯ã€‚\n7.1.2 é¢å¯¹ä¸åŒä»»åŠ¡ï¼Œå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹çš„é€‰æ‹©ï¼Ÿ # æˆ‘ä»¬å¼€å‘çš„ç¨‹åºå¾€å¾€å¯ä»¥å½’ä¸º3ç±»ï¼š\n è®¡ç®—å¯†é›†å‹ï¼ˆCPUæ•æ„Ÿå‹ï¼‰ IOå¯†é›†å‹ï¼ˆè®¡ç®—è´Ÿè½½å°ï¼Œç½‘ç»œIOå¤šï¼‰ ç”¨æˆ·äº¤äº’å‹ï¼ˆä»£ç é€»è¾‘åœ¨è®¡ç®—ã€ç½‘ç»œIOä¹‹é—´åˆ‡æ¢ï¼Œéå›ºå®šåå‘æŸä¸€ç§ï¼‰  å¯¹äºè®¡ç®—å¯†é›†å‹çš„ä»»åŠ¡ï¼Œå³ä¾¿å¼€å¤šä¸ªJavaçº¿ç¨‹ä¹Ÿä¸ä¼šå¾—åˆ°å¾ˆå¥½çš„å¹¶å‘æ•ˆæœï¼Œç®€è¨€ä¹‹è¿™ä¸ªJavaçº¿ç¨‹ä¸ä¼šè®©åº¦CPUï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿä»¥å•CPUå•æ ¸ä¸ºä¾‹ï¼Œä¸€ä¸ªæ—¶åˆ»åªä¼šè°ƒåº¦ä¸€ä¸ªJavaçº¿ç¨‹æ‰§è¡Œï¼Œå› ä¸ºè¿™ä¸ªçº¿ç¨‹å¿™äºè®¡ç®—ï¼Œä¸ä¼šå› ä¸ºé˜»å¡è®©åº¦CPUï¼ˆé˜»å¡æ—¶å†…æ ¸é€šå¸¸ä¼šå°†å¯¹åº”çš„LWPè®¾ä¸ºä¸å¯ä¸­æ–­ç­‰å¾…ç›´åˆ°IOå®Œæˆæ‰ä¼šå°†å…¶è®¾ä¸ºå°±ç»ªé‡æ–°å‚ä¸è¿›ç¨‹è°ƒåº¦ï¼‰ï¼Œè¿™æ ·å…¶ä»–çš„Javaçº¿ç¨‹åŸºæœ¬å¾—ä¸åˆ°è°ƒåº¦çš„æœºä¼šï¼Œé™¤éè¯¥çº¿ç¨‹å¯¹åº”çš„LWPæ—¶é—´ç‰‡åˆ°åˆ‡æ¢åˆ°æ‰§è¡Œå…¶ä»–Javaçº¿ç¨‹çš„LWPæ‰å¯ä»¥ã€‚å‡å¦‚æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯è®¡ç®—å¯†é›†å‹ï¼Œè¿™æ ·çš„å¤šçº¿ç¨‹è®¡ç®—æ•ˆç‡è¦è¿œä½äºå¤šè¿›ç¨‹è®¡ç®—ï¼å¤šCPUæˆ–è€…å¤šæ ¸æƒ…å†µä¸‹ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡åœ¨å…¶ä»–CPUæˆ–è€…æ ¸å¿ƒè°ƒåº¦å¤šä¸ªJavaçº¿ç¨‹ï¼Œä½†ä¹Ÿæ— æµäºäº‹ï¼\nå¯¹äºIOå¯†é›†å‹çš„ä»»åŠ¡ï¼Œåº”è¯¥å¼€å¤šä¸ªJavaçº¿ç¨‹æ¥ä»£æ›¿å¤šä¸ªè¿›ç¨‹ï¼ŒIOä¸€èˆ¬å¤šæŒ‡ç½‘ç»œIOï¼ŒIOå®Œæˆéœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œä¸å¯èƒ½IOä¸€å‘èµ·å°±ç«‹å³æˆåŠŸç»“æŸï¼Œæ‰€ä»¥ä½¿ç”¨é˜»å¡å‹IOè¿›ç¨‹ä¸€å®šä¼šç»å†é˜»å¡ã€å”¤é†’çš„è¿‡ç¨‹ã€‚å¯¹äºé˜»å¡å‹IOï¼Œæ˜ å°„åˆ°LWPä¹‹åï¼Œè¿›å…¥é˜»å¡å‹ç³»ç»Ÿè°ƒç”¨ï¼ŒLinuxå†…æ ¸ä¼šå°†LWPçŠ¶æ€è®¾ç½®ä¸ºä¸å¯ä¸­æ–­ç­‰å¾…çŠ¶æ€ï¼Œåœ¨IOå®Œæˆå†…æ ¸é‡æ–°ä¿®æ”¹LWPçŠ¶æ€ä¸ºå°±ç»ªæ€ä¹‹å‰ï¼ŒLWPæ— æ³•å‚ä¸è¿›ç¨‹è°ƒåº¦ï¼Œå¯¹åº”çš„Javaçº¿ç¨‹ä¹Ÿæ— æ³•æ‰§è¡Œï¼Œè¿™æœŸé—´CPUå°±ä¼šè¢«è®©å‡ºæ¥ä¾›å…¶ä»–LWPé€‰æ‹©æ‰§è¡Œå‰©ä½™çš„Javaçº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µä¸‹å¤šä¸ªJavaçº¿ç¨‹å¯ä»¥æé«˜å¹¶å‘æ•ˆç‡ã€‚\nè¿™é‡Œå¯èƒ½æœ‰äººé—®ä¸ºä»€ä¹ˆä¸€ä¸ªJavaçº¿ç¨‹é˜»å¡äº†ï¼Œå¯¹åº”çš„Javaè¿›ç¨‹å´æ²¡æœ‰é˜»å¡ï¼ŸJVMä¸­Javaçº¿ç¨‹åªæ˜¯ç»´æŠ¤äº†çº¿ç¨‹åº”æœ‰çš„æŸäº›å±æ€§ä¿¡æ¯ï¼Œå¹¶éçœŸæ­£çš„çº¿ç¨‹å®ä½“ï¼Œä¸€ä¸ªJavaè¿›ç¨‹å‡†ç¡®åœ°è¯´æ˜¯ä¸€ä¸ªJVMå®ä¾‹ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªé€šä¿—æ„ä¹‰ä¸Šçš„è¿›ç¨‹ã€‚ä¸€ä¸ªJVMå®ä¾‹å®é™…ä¸ŠåŒ…æ‹¬ä¸€ä¸ªJavaä¸»çº¿ç¨‹å¯¹åº”çš„æ™®é€šè¿›ç¨‹ï¼ŒåŒæ—¶è¿˜åŒ…æ‹¬äº†å¾ˆå¤šçš„è°ƒåº¦Javaçº¿ç¨‹ç”¨çš„LWPä»¥åŠç”¨äºæ‰§è¡ŒJVMç‰¹æ®Šä»»åŠ¡ï¼ˆå¦‚GCï¼‰çš„LWPã€‚ä¸€ä¸ªJavaçº¿ç¨‹çš„é˜»å¡ï¼Œåªæ˜¯é˜»å¡é€‰æ‹©å¹¶æ‰§è¡Œè¯¥çº¿ç¨‹çš„LWPï¼Œå¯¹äºå…¶ä»–Javaçº¿ç¨‹ä¸ä¼šæ„æˆå½±å“ã€‚è¿™é‡Œé€‰æ‹©Javaå¤šçº¿ç¨‹æ¨¡å‹æ¯”å¤šJavaè¿›ç¨‹æ¨¡å‹è¦å¥½å¤šäº†ï¼Œåè€…æ›´æ¶ˆè€—èµ„æºï¼Œä»»åŠ¡è°ƒåº¦ä¸Šä¹Ÿè·å¾—ä¸äº†ä»€ä¹ˆä¼˜åŠ¿ã€‚\n å¤‡æ³¨ï¼š\nå…³äºJavaçº¿ç¨‹åˆ›å»ºã€è°ƒåº¦ä»¥åŠå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹å¦‚ä½•é€‰æ‹©çš„å†…å®¹å°±å…ˆä»‹ç»åˆ°è¿™é‡Œï¼Œä¸‹é¢å›åˆ°æœ¬ç« selectorä¸Šæ¥ã€‚\n å‰é¢æˆ‘ä»¬æåˆ°äº†åœ¨ä¸åŒçš„ä»»åŠ¡ä¸‹å¯¹å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹çš„é€‰æ‹©ï¼Œå¯¹äºIOå¯†é›†å‹çš„ä»»åŠ¡ï¼Œå…¶å®å› ä¸ºè®¡ç®—æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´æ˜¯åœ¨æ‰§è¡ŒIOå¤„ç†ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé‡‡ç”¨IOäº‹ä»¶é©±åŠ¨çš„æ–¹å¼æ¥å¯¹IOè¿›è¡Œå¤„ç†çš„è¯ï¼ˆæ¯”å¦‚å¤„ç†è¿æ¥å»ºç«‹ã€è¯»å†™æ•°æ®ï¼‰ï¼Œä½¿ç”¨å•ä¸€çº¿ç¨‹ä¹Ÿå¯ä»¥è·å¾—ä¸é”™çš„ç³»ç»Ÿååé‡ï¼Œä¹Ÿèƒ½å‡è½»å¤šçº¿ç¨‹åˆ‡æ¢çš„è´Ÿè½½ã€‚\nä¸‹å›¾æ˜¯ä¸€ä¸ªå•çº¿ç¨‹å€ŸåŠ©selectorå¯¹3ä¸ªchannelè¿›è¡Œç®¡ç†çš„ç¤ºæ„å›¾ã€‚\n7.2 åˆ›å»ºSelector # é€šè¿‡ä¸€ä¸ªç®€å•çš„æ–¹æ³•è°ƒç”¨ï¼Œå°±å¯ä»¥åˆ›å»ºä¸€ä¸ªselectorå¯¹è±¡ã€‚\nSelector selector = Selector.open();  7.3 å‘Selectorä¸­æ³¨å†ŒChannel # è¦æƒ³é€šè¿‡selectoræ¥è®¿é—®channelï¼Œé¦–å…ˆè¦å°†å…³å¿ƒçš„channelåŠå…¶äº‹ä»¶å‘selectorè¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œçš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚\n// é€šè¿‡selectorè®¿é—®channelï¼Œchannelå¿…é¡»æ˜¯éé˜»å¡æ¨¡å¼ channel.configureBlocking(false); // param1, channelå¿…é¡»æ˜¯å¯ä»¥è®¾ç½®ä¸ºnon-blocking // param2ï¼Œå…³å¿ƒçš„äº‹ä»¶æœ‰4é’Ÿï¼ŒConnectã€Acceptã€Readã€Write SelectionKey key = channel.register(selector, SelectionKey.OP_READ);  FileChannelå› ä¸ºæ— æ³•åˆ‡æ¢ä¸ºéé˜»å¡æ¨¡å¼ï¼Œæ‰€ä»¥æ— æ³•å°†å…¶æ³¨å†Œåˆ°selectorï¼Œä¹Ÿå°±æ— æ³•é€šè¿‡selectorå¯¹FileChannelè¿›è¡Œè®¿é—®ã€‚SocketChannelå¯ä»¥æ³¨å†Œåˆ°selectorï¼Œå®é™…ä¸Šä¸€èˆ¬å¤šæ˜¯ç”¨selectoræ¥å¤„ç†SocketChannelä¸Šçš„IOäº‹ä»¶ã€‚\nå¯¹äºchannel.registeræ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ˜¯è¦æ³¨å†Œçš„æ„Ÿå…´è¶£çš„äº‹ä»¶ç±»å‹ï¼Œä¸»è¦æœ‰4ç§ï¼š\n Connectï¼Œè¡¨ç¤ºä¸€ä¸ªSocketChannelè¿æ¥åˆ°å¦ä¸€ä¸ªserveræˆåŠŸï¼› Acceptï¼Œè¡¨ç¤ºä¸€ä¸ªServerSocketChannelæ¥æ”¶ä¸€ä¸ªå…¥è¿æ¥è¯·æ±‚æˆåŠŸï¼› Readï¼Œè¡¨ç¤ºchannelä¸­æœ‰æ•°æ®åˆ°è¾¾ï¼Œå¯ä»¥è¿›è¡Œè¯»å–ï¼› Writeï¼Œè¡¨ç¤ºchannelä¸­æœ‰ç©ºé—²ä½ç½®ï¼Œå¯ä»¥å†™å…¥æ•°æ®ï¼›  å½“channelä¸­å‘ç”Ÿäº†ä¸Šè¿°äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬ç§°è¯¥channelä¸Šçš„å¯¹åº”äº‹ä»¶å°±ç»ªï¼Œä¾‹å¦‚Readäº‹ä»¶å°±ç»ªï¼Œæˆ–è€…è¯´æ˜¯Read Readyã€‚\n7.4 SelectionKey # å½“æˆ‘ä»¬è°ƒç”¨channel.register()æ—¶ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªSelectionKeyå¯¹è±¡ï¼Œé€šå¸¸è¿™ä¸ªå¯¹è±¡å¯ä»¥è·å–åˆ°æ³¨å†Œæ—¶çš„channelã€selectorã€æ„Ÿå…´è¶£çš„äº‹ä»¶é›†åˆinterestingSetã€å°±ç»ªäº‹ä»¶é›†åˆreadySetï¼Œä»¥åŠä¸€ä¸ªå¯é€‰çš„attachå¯¹è±¡ã€‚\n7.4.1 æ„Ÿå…´è¶£äº‹ä»¶é›†åˆinteresting set # ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡selectionkeyæ¥è·å–æ³¨å†Œæ—¶æä¾›çš„interesting setçš„ä»£ç ç¤ºä¾‹ã€‚\nint interestSet = selectionKey.interestOps(); boolean isInterestedInAccept = interestSet \u0026amp; SelectionKey.OP_ACCEPT; boolean isInterestedInConnect = interestSet \u0026amp; SelectionKey.OP_CONNECT; boolean isInterestedInRead = interestSet \u0026amp; SelectionKey.OP_READ; boolean isInterestedInWrite = interestSet \u0026amp; SelectionKey.OP_WRITE;  7.4.2 å°±ç»ªäº‹ä»¶é›†åˆready set # ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡selectionkeyæ¥è·å–ready setçš„ä»£ç ç¤ºä¾‹ã€‚\nint readySet = selectionKey.readyOps();  ä¸ºäº†æµ‹è¯•åˆ°åº•æœ‰å“ªäº›äº‹ä»¶å°±ç»ªï¼Œæ˜¯connectã€acceptï¼Ÿè¿˜æ˜¯readã€writeï¼Ÿè¿˜æ˜¯æ²¡æœ‰ï¼Ÿå¯ä»¥é‡‡ç”¨ä¸8.4.1æ€»ç›¸åŒçš„â€œANDâ€æ“ä½œæ¥å¯¹å¯¹åº”çš„äº‹ä»¶bitè¿›è¡Œæµ‹è¯•ï¼Œä»¥å‘ç°åˆ°åº•æœ‰å“ªäº›äº‹ä»¶å°±ç»ªã€‚å¦å¤–selectionkeyæä¾›äº†4ä¸ªæ–¹æ³•å¯ä»¥ç”¨äºæµ‹è¯•æŸä¸ªäº‹ä»¶æ˜¯å¦å°±ç»ªï¼Œè¿™4ä¸ªæ–¹æ³•æ˜¯ï¼š\nselectionKey.isAcceptable(); selectionKey.isConnectable(); selectionKey.isReadable(); selectionKey.isWritable();  7.4.3 channel + selector # é€šè¿‡selectionkeyè·å–channelã€selectoræ˜¯é€šè¿‡å¯¹åº”çš„getteræ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nChannel channel = selectionKey.channel(); Selector selector = selectionKey.selector();  7.4.4 attach object # å¯ä»¥é€šè¿‡selectionkeyæ¥è®¾ç½®ä¸€ä¸ªattachå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥ç”¨æ¥è¯†åˆ«ä¸€ä¸ªchannelï¼Œä¹Ÿå¯ä»¥ç”¨äºå‘channelæä¾›é™„åŠ ä¿¡æ¯ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥å°†channelå¯¹åº”çš„bufferä½œä¸ºè¿™é‡Œçš„attachå¯¹è±¡ã€‚è®¾ç½®attachå¯¹è±¡ã€è·å–attachå¯¹è±¡çš„æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚\nselectionKey.attach(theObject); Object attachedObj = selectionKey.attachment();  æ³¨å†Œchannelåˆ°selectoræ—¶ï¼Œå¦‚æœattachå¯¹è±¡å·²å­˜åœ¨ï¼Œä¹Ÿå¯åœ¨æ³¨å†Œçš„æ—¶å€™æŒ‡å®šattachå¯¹è±¡ã€‚\nSelectionKey key = channel.register(selector, SelectionKey.OP_READ, theObject);  7.4.5 selectoré€‰æ‹©äº‹ä»¶å°±ç»ªçš„Channel # å°†channelæ³¨å†Œåˆ°selectorä¹‹åï¼Œå¯ä»¥é€šè¿‡selectorä¸­çš„selectæ–¹æ³•æ¥é€‰æ‹©å‡ºæœ‰æ„Ÿå…´è¶£äº‹ä»¶å°±ç»ªçš„channelï¼Œä»¥ä¾¿å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚\nè¿™é‡Œçš„selectæ–¹æ³•æœ‰3ä¸ªä¸åŒçš„å˜ä½“ï¼š\nint select(); // é˜»å¡åœ¨æ­¤å¤„ç›´åˆ°æœ‰æ„Ÿå…´è¶£çš„channelå°±ç»ª int select(long timeout); // é˜»å¡åœ¨æ­¤å¤„æœ€å¤štimeoutç§’ int selectNow(); // ä¸é˜»å¡åœ¨è°ƒç”¨å¤„ï¼Œæ²¡æœ‰å°±ç»ªchannelç«‹å³è¿”å›  è¿™å‡ ä¸ªselectæ–¹æ³•çš„è¿”å›å€¼è¡¨ç¤ºä¸Šä¸€æ¬¡è°ƒç”¨selectæ–¹æ³•ä¹‹ååˆæœ‰æ–°äº‹ä»¶å°±ç»ªçš„channelçš„æ•°é‡ï¼ˆç±»ä¼¼äºepollçš„ET_TRIGGERæ–¹å¼ï¼‰ã€‚ä¾‹å¦‚å‘selectoræ³¨å†Œäº†ä¸¤ä¸ªchannelï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨selectæ—¶å‡å¦‚æœ‰ä¸€ä¸ªchannelå°±ç»ªï¼Œé‚£ä¹ˆselectè¿”å›å€¼ä¸º1ã€‚å‡å¦‚ä¸‹æ¬¡è°ƒç”¨selectæ—¶åˆæœ‰ä¸€ä¸ªchannelæœ‰æ—¶é—´å°±ç»ªï¼Œé‚£ä¹ˆselectè¿”å›å€¼ä¸º1ã€‚å‡å¦‚ç¬¬ä¸€æ¬¡è°ƒç”¨selectåçš„channelå°±ç»ªäº‹ä»¶æ²¡æœ‰è¿›è¡Œå¤„ç†çš„è¯ï¼Œé‚£ä¹ˆç°åœ¨å°±æœ‰ä¸¤ä¸ªäº‹ä»¶å°±ç»ªçš„channelç­‰å¾…å¤„ç†ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡selectçš„æ—¶å€™åªè¿”å›1è€Œä¸æ˜¯2ã€‚å¦‚æœç†è§£epollçš„ET_TRIGGERæ–¹å¼çš„è¯ï¼Œè¿™é‡Œåº”è¯¥ä¸éš¾ç†è§£ã€‚\n7.4.6 selectedKeys() # ä¸€æ—¦selectè¿”å›ï¼Œå¹¶ä¸”ç¡®å®å­˜åœ¨äº‹ä»¶å°±ç»ªçš„channelçš„è¯ï¼Œå¯ä»¥é€šè¿‡selectedKeys()æ–¹æ³•æ¥è®¿é—®è¿™äº›å°±ç»ªçš„channelå¹¶æ‰§è¡Œç›¸åº”çš„å¤„ç†åŠ¨ä½œã€‚selectedKeys()è¿”å›ä¸€ä¸ªé›†åˆï¼Œé›†åˆä¸­çš„SelectionKeyå…³è”çš„channelå‡å­˜åœ¨å°±ç»ªäº‹ä»¶ã€‚ä¸‹é¢æ˜¯æ–¹æ³•selectedKeys()çš„æ–¹æ³•å£°æ˜ã€‚\nSet\u0026lt;SelectionKey\u0026gt; selectedKeys = selector.selectedKeys();  ç”±äºå¯èƒ½ä¸ºä¸åŒçš„channelä¸Šå…³è”äº†ä¸åŒçš„selectionkeyç±»å‹ï¼ˆconnectã€acceptã€readã€writeï¼‰ï¼Œå½“æˆ‘ä»¬éå†æ‰€æœ‰çš„selectionkeyæ—¶éœ€è¦æ£€æŸ¥å¯¹åº”çš„selectionkeyçš„ç±»å‹ï¼Œä»¥ä¾¿æ‰§è¡Œä¸connectã€acceptã€readã€writeç›¸å¯¹åº”çš„å¤„ç†åŠ¨ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ“ä½œç¤ºä¾‹ã€‚\nSet\u0026lt;SelectionKey\u0026gt; selectedKeys = selector.selectedKeys(); Iterator\u0026lt;SelectionKey\u0026gt; keyIterator = selectedKeys.iterator(); while(keyIterator.hasNext()) { SelectionKey key = keyIterator.next(); // æ³¨æ„æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œå¯¹key.channel()è¿›è¡Œé€‚å½“çš„ç±»å‹è½¬æ¢ if(key.isAcceptable()) { ServerSocketChannel chl = (ServerSocketChannel)key.channel(); ... } else if (key.isConnectable()) { SocketChannel chl = (SocketChannel)key.channel(); ... } else if (key.isReadable()) { SocketChannel chl = (SocketChannel)key.channel(); ... } else if (key.isWritable()) { SocketChannel chl = (SocketChannel)key.channel(); ... } // - éœ€è¦ä»selectedKeysé›†åˆä¸­æ‰‹åŠ¨ç§»é™¤å¤„ç†å®Œæ¯•çš„SelectionKey // - ä¸‹æ¬¡è°ƒç”¨selectedKeys()æ—¶è‹¥äº‹ä»¶å°±ç»ªï¼Œä¼šé‡æ–°å°†å…¶åŠ å…¥selectedKeysé›†åˆä¸­ keyIterator.remove(); }  7.4.7 wakeup # å¦‚æœä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†selector.select()æ–¹æ³•å¹¶ä¸”é˜»å¡åœ¨è¿™ä¸ªæ–¹æ³•è°ƒç”¨å¤„çš„è¯ï¼Œå¯ä»¥é€šè¿‡åœ¨å¦ä¸€ä¸ªçº¿ç¨‹å°†å…¶â€œå”¤é†’â€ï¼Œå”¤é†’çš„æ–¹å¼å°±æ˜¯åœ¨è¿™ä¸ªä¸åŒçš„çº¿ç¨‹ä¸­è°ƒç”¨selector.wakeup()æ–¹æ³•ã€‚\nå‡å¦‚ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†wakeupæ–¹æ³•ï¼Œå¹¶ä¸”å½“å‰æ²¡æœ‰çº¿ç¨‹å› ä¸ºè°ƒç”¨selectæ–¹æ³•è€Œé˜»å¡åœ¨æ–¹æ³•è°ƒç”¨å¤„çš„è¯ï¼Œé‚£ä¹ˆä¸‹æ¬¡æŸä¸ªçº¿ç¨‹è°ƒç”¨selectæ–¹æ³•æ—¶å‡å¦‚æ²¡æœ‰äº‹ä»¶å°±ç»ªçš„channelï¼Œè¿™ä¸ªçº¿ç¨‹å°†ç«‹å³è¢«â€œå”¤é†’â€ï¼Œå³ä¸ä¼šé˜»å¡åœ¨æ–¹æ³•è°ƒç”¨å¤„ã€‚è¿™ä¸selectorçš„å®ç°ç»†èŠ‚æœ‰å…³ç³»ï¼Œè¿™é‡Œä¸è¿‡å¤šå±•å¼€ã€‚\n7.4.8 close # å½“æˆ‘ä»¬ä¸å†éœ€è¦ä½¿ç”¨selectorå¯¹channelè¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡selector.close()æ–¹æ³•æ¥å…³é—­selectorï¼Œè¯¥selectorå°†åŒæ—¶ä½¿æ³¨å†Œçš„æ‰€æœ‰çš„selectionKeyå®ä¾‹å¤±æ•ˆï¼Œä½†æ˜¯å‘¢ï¼Œè¿™é‡Œçš„closeæ–¹æ³•å¹¶ä¸ä¼šå…³é—­æ³¨å†Œæ—¶çš„channelå¯¹è±¡ï¼Œå¦‚æœä¸éœ€è¦å¯¹channelè¿›è¡Œå¤„ç†äº†ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†channelçš„å…³é—­æ“ä½œã€‚\n8 FileChannel # FileChannelæ˜¯è¿æ¥åˆ°æ–‡ä»¶çš„channelï¼Œå¯ä»¥é€šè¿‡FileChannelå¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œå®ƒæ˜¯æ ‡å‡†IOè¯»å†™æ–‡ä»¶çš„å¦ä¸€ç§æ›¿ä»£æ–¹æ¡ˆã€‚\nFileChannelä¸èƒ½è®¾ç½®ä¸ºnon-blockingæ¨¡å¼ï¼Œåªèƒ½å·¥ä½œåœ¨blockingæ¨¡å¼ä¸‹ã€‚\n8.1 æ‰“å¼€ä¸€ä¸ªFileChannel # åªèƒ½é€šè¿‡æ–‡ä»¶è¾“å…¥è¾“å‡ºæµæˆ–è€…RandomAccessFileæ¥æ‰“å¼€FileChannelï¼Œä¸èƒ½ç›´æ¥æ‰“å¼€ï¼Œä¸‹é¢æ˜¯é€šè¿‡RandomAccessFileæ‰“å¼€FileChannelçš„ç¤ºä¾‹ã€‚\nRandomAccessFile aFile = new RandomAccessFile(\u0026quot;data/nio-data.txt\u0026quot;, \u0026quot;rw\u0026quot;); FileChannel inChannel = aFile.getChannel();  8.2 é€šè¿‡FileChannelè¯»å–æ•°æ® # é€šè¿‡FileChannelè¯»å–æ•°æ®ä¸»è¦åˆ†ä¸ºä¸¤æ­¥ï¼Œé¦–å…ˆåˆ†é…ä¸€ä¸ªbufferï¼Œç„¶åå°†channelä¸­çš„æ•°æ®è¯»å–åˆ°å¹¶å­˜å‚¨åˆ°bufferä¸­ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªè¯»å–FileChannelçš„ç¤ºä¾‹ã€‚\nByteBuffer buf = ByteBuffer.allocate(48); int bytesRead = inChannel.read(buf);  å¦‚æœreadè¿”å›-1ï¼Œè¡¨ç¤ºEOFï¼ŒEnd Of Fileï¼Œå³åˆ°è¾¾äº†æ–‡ä»¶æœ«å°¾ã€‚\n8.3 å‘FileChannelå†™å…¥æ•°æ® # å‘FileChannelä¸­å†™æ•°æ®ä¸»è¦åŒ…æ‹¬ä¸‹é¢å‡ æ­¥ï¼Œé¦–å…ˆè¦æœ‰ä¸€ä¸ªå¾…å†™å…¥çš„æ•°æ®ï¼Œç„¶ååˆ†é…ä¸€ä¸ªbufferå¹¶å°†æ•°æ®å†™å…¥bufferä¸­ï¼Œæœ€åå†è°ƒç”¨channel.write(buffer)æ–¹æ³•å°†bufferä¸­æ•°æ®å†™å…¥channelã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ“ä½œç¤ºä¾‹ã€‚\nString newData = \u0026quot;New String to write to file...\u0026quot; + System.currentTimeMillis(); ByteBuffer buf = ByteBuffer.allocate(48); buf.clear(); buf.put(newData.getBytes()); // bufferä¸€å¼€å§‹ä¸ºwriteæ¨¡å¼ï¼Œè°ƒç”¨channel.write()ä¹‹å‰éœ€è¦flipåˆ‡æ¢ä¸ºè¯»æ¨¡å¼ buf.flip(); // ä¸èƒ½ä¿è¯channel.write()æ–¹æ³•ä¸€æ¬¡ä¼šè¯»å–bufferä¸­å¤šå°‘æ•°æ®ï¼Œå› æ­¤è¦å¾ªç¯å¤„ç† while(buf.hasRemaining()) { channel.write(buf); }  8.4 å…³é—­FileChannel # å½“FileChannelä½¿ç”¨å®Œæ¯•ä¹‹åï¼Œå¿…é¡»å…³é—­ï¼Œé¿å…å¥æŸ„æ³„éœ²çš„é—®é¢˜ã€‚\nchannel.close();  8.5 FileChannelä¸­æ–‡ä»¶ä½ç½® # ç±»ä¼¼äºfseekç±»çš„ç›¸å…³æ“ä½œï¼ŒFileChannelä¹Ÿæä¾›äº†åœ¨æ–‡ä»¶ä¸­è¿›è¡Œä½ç½®å®šä½çš„èƒ½åŠ›ï¼Œä¸»è¦æ˜¯é€šè¿‡positionè¿™å‡ ä¸ªæ–¹æ³•ã€‚\nlong pos = channel.position(); // è·å–å½“å‰åœ¨channelä¸­çš„ä½ç½® channel.position(pos+123); // åœ¨channelä¸­å®šä½åˆ°å½“å‰ä½ç½®ä¹‹å123åç§»é‡å¤„  å¦‚æœpos+123è¶…è¿‡äº†channelçš„å®é™…å°ºå¯¸çš„è¯ï¼Œchannel.read(\u0026hellip;)çš„æ—¶å€™å°†è¿”å›-1ã€‚\n8.6 FileChannel Size # è·å–FileChannelå…³è”çš„æ–‡ä»¶çš„å°ºå¯¸ï¼Œå¯ä»¥é€šè¿‡channel.size()æ–¹æ³•ã€‚\nlong fileSize = channel.size();  8.7 FileChannel Truncate # å¦‚æœå°†æ–‡ä»¶æˆªæ–­ä¸ºæŒ‡å®šçš„å°ºå¯¸ï¼Œå¹¶ä¸¢å¼ƒè¶…å‡ºéƒ¨åˆ†çš„å†…å®¹ï¼Œå¯ä»¥é€šè¿‡channel.truncate(\u0026hellip;)æ–¹æ³•ã€‚\nchannel.truncate(1024);  8.8 FileChannel Force # ç±»ä¼¼äºsyncæ“ä½œï¼ŒFileChannelä¹Ÿæä¾›äº†å°†æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ•°æ®åŒæ­¥åˆ°ç£ç›˜çš„æ“ä½œï¼Œå³é€šè¿‡channel.force()æ–¹æ³•ï¼Œå¦å¤–å‘¢ï¼Œchannel.force(true)è¿˜å¯ä»¥å°†æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯åŒæ­¥åˆ°ç£ç›˜ï¼Œæ¯”å¦‚å°†æ–‡ä»¶æƒé™ä¿¡æ¯ç­‰åŒæ­¥åˆ°ç£ç›˜ã€‚\n å¤‡æ³¨ï¼š\næ“ä½œç³»ç»Ÿä¸€èˆ¬éƒ½æ˜¯å°†æ–‡ä»¶å†…å®¹è¯»å–åˆ°æŒ‡å®šçš„ç¼“å†²å—ä¸­ï¼Œæ–‡ä»¶å…ƒæ•°æ®ä¿¡æ¯ä¹Ÿæ˜¯ä¼šè¢«åŠ è½½åˆ°ièŠ‚ç‚¹å¯¹åº”çš„ç¼“å†²å—ä¸­ï¼Œå½“è¿›ç¨‹å¯¹æ–‡ä»¶æœ¬èº«è¿›è¡Œæ“ä½œæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œæ“ä½œç³»ç»Ÿä¸€èˆ¬ä¸ä¼šç«‹å³å°†æ–‡ä»¶å†…å®¹ã€å…ƒæ•°æ®ä¿¡æ¯çš„ä¿®æ”¹åŒæ­¥åˆ°ç£ç›˜ï¼Œè€Œæ˜¯å°†æ”¹å†™åçš„æ•°æ®å­˜å‚¨åœ¨è¿™é‡Œçš„ç¼“å†²å—ä¸­ï¼ˆç¼“å†²å—å…¶å®æ˜¯å†…æ ¸ä¸­çš„ä¸€æ®µç‰¹æ®Šå†…å­˜åŒºåŸŸï¼‰ï¼Œè¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå†…æ ¸ä¼šè‡ªåŠ¨å°†è¿™é‡Œçš„æ•°æ®åŒæ­¥åˆ°ç£ç›˜ï¼ˆLinux 0.11ä¸­æ˜¯é€šè¿‡updateè¿›ç¨‹æ¥è´Ÿè´£å®Œæˆç¼“å†²å—å†™å›ç£ç›˜çš„å·¥ä½œï¼‰ã€‚\nå½“æ—¶æŸäº›æƒ…æ™¯ä¸‹ï¼Œè¿›ç¨‹å¸Œæœ›ç«‹å³å°†æŸäº›ä¿¡æ¯å†™å›ç£ç›˜ï¼Œå°±å¯ä»¥é€šè¿‡è¿™é‡Œçš„forceæ–¹æ³•æ¥å®Œæˆã€‚\n 9 NIO SocketChannel # SocketChannelæ˜¯å¯¹Tcpç½‘ç»œå¥—æ¥å­—çš„ä¸€ç§æŠ½è±¡ï¼Œæœ‰ä¸¤ç§åˆ›å»ºSocketChannelçš„æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡è¿æ¥åˆ°è¿œç¨‹çš„æŸä¸ªTcp Serveræ¥åˆ›å»ºä¸€ä¸ªSocketChannelï¼Œä¸€ç§æ˜¯é€šè¿‡ServerSocketChannelç›‘å¬åˆ°å…¥è¿æ¥è¯·æ±‚æ—¶åˆ›å»ºä¸€ä¸ªSocketChannelã€‚\n9.1 åˆ›å»ºSocketChannel # ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡è¿æ¥åˆ°Tcp Serveræ¥åˆ›å»ºSocketChannelçš„ç¤ºä¾‹ï¼š\nSocketChannel socketChannel = SocketChannel.open(); socketChannel.connect(new InetSocketAddress(\u0026quot;http://jenkov.com\u0026quot;, 80));  9.2 å…³é—­SocketChannel # å…³é—­socketchannelçš„æ–¹å¼å°±æ˜¯è°ƒç”¨closeæ–¹æ³•ã€‚\nsocketChannel.close();   å¤‡æ³¨ï¼š\nèµ„æºçš„é‡Šæ”¾æ˜¯éå¸¸é‡è¦çš„ï¼Œæˆ‘ç»å†è¿‡ä¸€æ¬¡å› ä¸ºæ²¡æœ‰å…³é—­tcpè¿æ¥å¯¼è‡´è¿›ç¨‹æ‰“å¼€çš„fdè¾¾åˆ°ç³»ç»Ÿä¸Šé™ï¼Œè¿›è€Œå¯¼è‡´tcp serveræ‹’ç»æœåŠ¡çš„ä¸€æ¬¡äº‹æ•…ï¼Œç›´æ¥æ‹–å®äº†ç°ç½‘\n 9.3 ä»SocketChannelè¯»å–æ•°æ® # ä»socketchannelè¯»å–æ•°æ®å¯ä»¥é€šè¿‡channel.read()æ–¹æ³•åŠå…¶å˜ä½“æ¥æ“ä½œã€‚\nByteBuffer buf = ByteBuffer.allocate(48); int bytesRead = socketChannel.read(buf);  9.4 å†™æ•°æ®åˆ°SocketChannel # å†™æ•°æ®åˆ°socketchannelå¯ä»¥é€šè¿‡channel.write()æ–¹æ³•åŠå…¶å˜ä½“æ¥æ“ä½œã€‚\nString newData = \u0026quot;New String to write to file...\u0026quot; + System.currentTimeMillis(); ByteBuffer buf = ByteBuffer.allocate(48); buf.clear(); buf.put(newData.getBytes()); buf.flip(); while(buf.hasRemaining()) { channel.write(buf); }  9.5 Non-blockingæ¨¡å¼ # å¯ä»¥å°†socketchannelè®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œç„¶åä»¥éé˜»å¡çš„æ–¹å¼æ¥è¿›è¡Œconnectã€readã€writeæ“ä½œï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡selectoråŸºäºäº‹ä»¶é©±åŠ¨çš„æ–¹å¼æ¥å¯¹channelè¿›è¡Œæ›´å¥½åœ°å¤„ç†ã€‚è¿™é‡Œå…ˆçœ‹ä¸‹éé˜»å¡æ–¹å¼ä¸‹çš„connectã€readã€writeã€‚\n9.5.1 connect # éé˜»å¡æ¨¡å¼ä¸‹connectè°ƒç”¨å¯èƒ½åœ¨è¿æ¥æˆåŠŸå»ºç«‹ä¹‹å‰å°±è¿”å›äº†ï¼Œä¸ºäº†åˆ¤æ–­è¿æ¥æ˜¯å¦å»ºç«‹æˆåŠŸï¼Œéœ€è¦é€šè¿‡finishConnectæ–¹æ³•æ¥åˆ¤æ–­è¿æ¥æ˜¯å¦æˆåŠŸå»ºç«‹ã€‚\nsocketChannel.configureBlocking(false); socketChannel.connect(new InetSocketAddress(\u0026quot;http://jenkov.com\u0026quot;, 80)); while(! socketChannel.finishConnect() ){ //wait, or do something else... }  9.5.2 read # åœ¨éé˜»å¡æ¨¡å¼ä¸‹readï¼Œå¯èƒ½ä¸ä¼šè¿”å›ä»»ä½•æ•°æ®ï¼Œéœ€è¦å¯¹è¿”å›å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿”å›å€¼\u0026gt;=0éƒ½æ˜¯æœ‰æ•ˆçš„è¯»çŠ¶æ€ï¼Œåº”è¯¥åœ¨å¾ªç¯ä¸­ç»§ç»­è¿›è¡Œreadæ“ä½œã€‚å¦‚æœè¿”å›å€¼ä¸º-1ï¼ˆEOFï¼‰ï¼Œè¡¨ç¤ºå¯¹ç«¯Tcpè¿æ¥å…³é—­ï¼Œæ­¤æ—¶åº”è¯¥å…³é—­channelã€‚è¿™é‡Œå°±ä¸ç»™å‡ºä»£ç ç¤ºä¾‹äº†ã€‚\n9.5.3 write # åœ¨éé˜»å¡æ¨¡å¼ä¸‹writeï¼Œå¯èƒ½ä¸ä¼šç«‹åˆ»å†™å…¥ä»»ä½•æ•°æ®ï¼Œä¹Ÿéœ€è¦åœ¨å¾ªç¯ä¸­è¿›è¡Œwriteæ“ä½œï¼Œç›´åˆ°æ•°æ®å…¨éƒ¨å†™å…¥æˆåŠŸã€‚å‰é¢å·²ç»ç»™å‡ºäº†ç±»ä¼¼çš„writeç¤ºä¾‹ä»£ç ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤ç»™å‡ºä»£ç ç¤ºä¾‹äº†ã€‚\n å¤‡æ³¨ï¼š\nä¹Ÿå¯ä»¥é€šè¿‡selectoræ³¨å†Œå¤šä¸ªéé˜»å¡çš„socketchannelï¼Œç„¶åé€šè¿‡selectoråŸºäºäº‹ä»¶é©±åŠ¨çš„æ–¹å¼æ¥å¯¹socketchannelä¸Šçš„ioäº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œåé¢ä¼šç»§ç»­å¯¹æ­¤è¿›è¡Œæè¿°ã€‚\n 10 NIO ServerSocketChannel # serversocketchannelå¯ä»¥ç”¨äºç›‘å¬å…¥tcpè¿æ¥è¯·æ±‚ï¼Œå¹¶è¿”å›å»ºç«‹çš„tcpè¿æ¥å¯¹åº”çš„socketchannelã€‚\nä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¤ºä¾‹ã€‚\n// åˆ›å»ºä¸€ä¸ªserversocketchannel ServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); // ç»‘å®šç›‘å¬ç«¯å£ serverSocketChannel.socket().bind(new InetSocketAddress(9999)); while(true){ // ç›‘å¬tcpå…¥è¿æ¥è¯·æ±‚ SocketChannel socketChannel = serverSocketChannel.accept(); //do something with socketChannel... } // å…³é—­serversocketchannel serverSocketChannel.close();  æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨éé˜»å¡çš„æ–¹å¼æ¥ä½¿ç”¨serversocketchannelï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚\nServerSocketChannel serverSocketChannel = ServerSocketChannel.open(); serverSocketChannel.socket().bind(new InetSocketAddress(9999)); // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ serverSocketChannel.configureBlocking(false); while(true){ SocketChannel socketChannel = serverSocketChannel.accept(); // acceptåœ¨è¿æ¥å»ºç«‹ä¹‹å‰è¿”å›ï¼Œè¿”å›null if(socketChannel != null) { //do something with socketChannel... } } serverSocketChannel.close();  å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†serversocketchannelçš„acceptäº‹ä»¶æ³¨å†Œåˆ°selectorï¼Œç„¶åç”¨selectorä½¿ç”¨åŸºäºäº‹ä»¶é©±åŠ¨çš„æ–¹å¼æ¥å¯¹tcpå…¥è¿æ¥è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚åé¢ä¼šè¿›ä¸€æ­¥è¿›è¡Œä»‹ç»ã€‚\n11 NIO Non-blocking Server # æˆªæ­¢åˆ°ç°åœ¨ï¼Œå°½ç®¡å·²ç»å¯¹NIOä¸­çš„selectorã€channelã€bufferè¿›è¡Œäº†ä»‹ç»ï¼Œæˆ‘ä»¬ä¹Ÿäº†è§£äº†å®ƒä»¬çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œä½†æ˜¯è¦æƒ³è®¾è®¡ä¸€ä¸ªnon-blocking ioçš„serverè¿˜æ˜¯æœ‰è¾ƒå¤§çš„éš¾åº¦çš„ã€‚non-blocking ioå®ç°çš„serverç›¸æ¯”äºblocking ioå®ç°çš„serverå­˜åœ¨ä¸€äº›å¾ˆæœ‰æŒ‘æˆ˜æ€§çš„åœ°æ–¹ï¼Œè¿™é‡Œå°†é’ˆå¯¹è¿™äº›æŒ‘æˆ˜æå‡ºä¸€äº›è§£å†³æ–¹æ³•ã€‚\nä»ç½‘ä¸Šæ‰¾ä¸€äº›å…³äºnon-blocking ioå®ç°serverçš„æ–¹å¼ä¹Ÿæ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œç›¸å…³çš„æè¿°ä¹Ÿå¹¶ä¸æ˜¯å¾ˆç»†è‡´ï¼Œå› æ­¤è¿™é‡Œçš„è§£å†³æ–¹æ³•æ˜¯æ ¹æ®ä½œè€…ä¸ªäººçš„ä¸€äº›å·¥ä½œç»éªŒå’Œæƒ³æ³•æå‡ºçš„ã€‚å¦‚æœä½ æœ‰å¥½çš„å»ºè®®ï¼Œä¹Ÿå¯ä»¥è‡ªå·±è¿›è¡Œå®ç°ã€æµ‹è¯•ã€‚\nè¿™é‡Œçš„è®¾è®¡æ€è·¯æ˜¯å›´ç»•ç€Java NIOæ¥è¿›è¡Œçš„ï¼Œå…¶å®è¿™é‡Œçš„è®¾è®¡æ€è·¯åŒæ ·å¯ä»¥ç”¨äºå…¶ä»–çš„ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œåªè¦å¯¹åº”çš„è¯­è¨€æä¾›äº†ç±»ä¼¼selectorè¿™æ ·çš„äº‹ä»¶é©±åŠ¨IOå¤„ç†çš„APIå³å¯ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨cã€c++è¯­è¨€æ¥åŸºäºepollå®ç°ã€‚\n11.1 NON-Blocking Server - Github Repo # è¿™é‡Œæ ¹æ®æœ¬æ–‡æä¾›çš„éé˜»å¡io serverçš„è®¾è®¡æ€è·¯ï¼Œä½œè€…å¯¹å…¶è¿›è¡Œäº†ä¸€ä¸ªå®ç°ï¼Œé¡¹ç›®çš„æºä»£ç ä¹Ÿå·²ç»æ‰˜ç®¡åœ¨äº†githubä¸Šï¼Œå¯ä»¥ä»è¿™é‡Œä¸‹è½½åˆ°ï¼šNon-Blocking IO Serverã€‚\n11.2 NON-Blocking IO Pipelines # éé˜»å¡ioæµæ°´çº¿æ¨¡å‹æ˜¯é€šè¿‡å¤šä¸ªæ¨¡å—æ„æˆçš„èŒè´£é“¾æ¥å¤„ç†éé˜»å¡ioï¼ŒåŒ…æ‹¬éé˜»å¡çš„readã€writeæ“ä½œï¼Œä¸‹å›¾æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆï¼ˆåªæœ‰ä¸€ä¸ªcomponentï¼‰çš„éé˜»å¡ioæµæ°´çº¿çš„ç¤ºæ„å›¾ã€‚\nè¿™é‡Œçš„componenté€šè¿‡ä½¿ç”¨ä¸€ä¸ªselectoræ¥æ£€æŸ¥ä»€ä¹ˆæ—¶å€™å¯ä»¥ä»channelè¯»å–æ•°æ®ï¼Œç„¶åè¯»å–æ•°æ®ä¹‹åæ‰§è¡Œå¤„ç†ç”ŸæˆæŸäº›ç»“æœä¿¡æ¯ï¼Œå¹¶å°†ç»“æœä¿¡æ¯è¾“å‡ºåˆ°channelã€‚\nä¸€ä¸ªæµæ°´çº¿æ¨¡å‹å¹¶ä¸æ€»æ˜¯æ—¢è¯»å–æ•°æ®åˆå†™æ•°æ®ï¼ŒæŸäº›æƒ…å†µä¸‹å¯èƒ½åªä¼šè¯»å–æ•°æ®ï¼ŒæŸäº›æƒ…å†µä¸‹å¯èƒ½åªä¼šå†™å…¥æ•°æ®ã€‚ä¸Šå›¾ä¸­è¿™ä¸ªç®€åŒ–ç‰ˆçš„æµæ°´çº¿æ¨¡å‹ç¤ºæ„å›¾åªæœ‰ä¸€ä¸ªcomponentï¼Œé€šå¸¸ä¸€ä¸ªæµæ°´çº¿æœ‰å¤šé•¿å–å†³äºè¿™ä¸ªæµæ°´çº¿è¦æ‰§è¡Œä»€ä¹ˆæ ·çš„ä»»åŠ¡å¤„ç†ã€‚ä¸€ä¸ªéé˜»å¡ioæµæ°´çº¿ä¹Ÿå¯èƒ½ä¼šåŒæ—¶è¯»å–å¤šä¸ªchannelä¸­çš„æ•°æ®ï¼Œå¹¶ä¸ä¸€å®šæ˜¯åªè¯»ä¸€ä¸ªchannelï¼Œæ¯”å¦‚å¯èƒ½è¯»å–å¤šä¸ªSocketChannelä¸­çš„æ•°æ®ã€‚å¯¹äºæµæ°´çº¿çš„è¾“å‡ºæ“ä½œä¹Ÿæ˜¯ä¸€æ ·çš„æƒ…å†µã€‚ä¸Šå›¾ä¸­çš„æ§åˆ¶æµä¹Ÿæ˜¯ç®€åŒ–çš„ï¼Œæ•°æ®è¯»å–æ“ä½œæ˜¯ç”±componentå‘èµ·çš„ï¼Œè€Œä¸æ˜¯ç”±channel pushæ¶ˆæ¯åˆ°selectorå†å‘é€åˆ°componentâ€¦â€¦\n11.2 NON-Blocking vs Blocking IO Pipelines # è¿™é‡Œå¯¹éé˜»å¡ioæµæ°´çº¿æ¨¡å‹å’Œé˜»å¡ioæµæ°´çº¿æ¨¡å‹è¿›è¡Œä¸€ä¸‹åˆ†æã€å¯¹æ¯”ã€‚è¿™ä¸¤ç§æµæ°´çº¿æ¨¡å‹çš„æœ€å¤§åŒºåˆ«åœ¨äºå¯¹channelä¸­æ•°æ®çš„è¯»å–æ–¹å¼ï¼Œè¿™é‡Œçš„channelæ— éä¹Ÿå°±æ˜¯è¯»å†™socketæˆ–è€…fileã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œioæµæ°´çº¿ä¸­å¾€å¾€æ˜¯é€šè¿‡ä¸€ä¸ªMessage Readeræ¥è¯»å–Streamä¸­çš„æ•°æ®ï¼Œå¹¶å°†æ•°æ®è§£æä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªMessageï¼Œç„¶åè¿›è¡Œå†äº¤ç»™å…¶ä»–componentè¿›è¡Œå¤„ç†ã€‚\nå¯¹äºé˜»å¡å‹ioï¼Œè¿™é‡Œçš„Streamå¯ä»¥é€šè¿‡InputStreamç­‰ç±»ä¼¼æ¥å£è¿›è¡Œæ•°æ®readæ“ä½œï¼Œreadæ“ä½œå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®åˆ°è¾¾readæ‰è¿”å›ã€‚é˜»å¡å‹ioåœºæ™¯ä¸‹MessageReaderçš„å®ç°æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå› ä¸ºInputStreamçš„readæ“ä½œç›´åˆ°è¯»å–äº†æŒ‡å®šæ•°æ®é‡çš„æ•°æ®åæ‰ä¼šè¿”å›ï¼ŒMessageReaderä¸éœ€è¦å¤„ç†æ²¡æœ‰æ•°æ®åˆ°è¾¾æˆ–è€…åªæœ‰éƒ¨åˆ†æ•°æ®ï¼ˆreadè¯»å–çš„æ•°æ®å°äºä¸€ä¸ªå®Œæ•´çš„Messageï¼‰åˆ°è¾¾çš„ç‰¹æ®Šæƒ…å†µã€‚\nç±»ä¼¼åœ°ï¼Œé˜»å¡å‹ioï¼Œè¿™é‡Œçš„MessageWriterå®ç°ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå› ä¸ºwriteæ“ä½œæ€»æ˜¯å°†æŒ‡å®šæ•°æ®é‡çš„æ•°æ®å†™å…¥åˆ°OutputStreamæ‰ä¼šè¿”å›ï¼Œä¸éœ€è¦å¤„ç†æ²¡æœ‰è¾“å…¥å†™å…¥æˆ–è€…åªå†™äº†éƒ¨åˆ†æ•°æ®çš„ç‰¹æ®Šæƒ…å†µã€‚\n å¤‡æ³¨ï¼š\néé˜»å¡å‹ioéœ€è¦é’ˆå¯¹MessageReaderå¯èƒ½è¯»å–ä¸åˆ°æ•°æ®ã€è¯»å–åˆ°éƒ¨åˆ†æ•°æ®çš„æƒ…å†µè¿›è¡Œå¤„ç†ï¼Œä¹Ÿéœ€è¦å¯¹MessageWriteræ²¡æœ‰å†™æ•°æ®æˆ–è€…åªå†™äº†éƒ¨åˆ†æ•°æ®çš„ç‰¹æ®Šæƒ…å†µè¿›è¡Œå¤„ç†ï¼Œè¿™æ¶‰åŠåˆ°å¾ˆå¤šç»†èŠ‚ä¸Šçš„å¤„ç†ï¼Œå¢åŠ äº†MessageReaderã€MessageWriterçš„å®ç°éš¾åº¦ã€‚\n 11.3 Blocking IO Pipelines Drawbacks # è™½ç„¶å‰é¢æåˆ°é˜»å¡å‹ioæµæ°´çº¿ä¾¿äºç®€åŒ–MessageReaderã€MessageWriterçš„å®ç°éš¾åº¦ï¼Œä½†æ˜¯é˜»å¡å‹ioæµæ°´çº¿ä¹Ÿå­˜åœ¨æ¯”è¾ƒæ˜æ˜¾çš„åŠ£åŠ¿ï¼Œè¿™é‡Œå°±å¯¹å…¶å­˜åœ¨çš„é—®é¢˜è¿›è¡Œç®€è¦æè¿°ã€‚\né˜»å¡å‹ioæµæ°´çº¿ä¸­ï¼Œå¯¹äºä¸€ä¸ªç‰¹å®šçš„InputStreamçš„æ•°æ®è¯»å–æ“ä½œï¼Œä¸€èˆ¬è¦å¼€ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹è¿›è¡Œæ•°æ®è¯»å–æ“ä½œï¼Œå› ä¸ºå¦‚æœä½¿ç”¨å½“å‰çº¿ç¨‹è¿›è¡Œæ•°æ®è¯»å–æ“ä½œçš„è¯å°†ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œçº¿ç¨‹å°†æ— æ³•ç»§ç»­æ‰§è¡Œå…¶ä»–å¤„ç†ã€‚\nå¦‚æœä¸€ä¸ªserveræ˜¯åŸºäºé˜»å¡å‹ioæµæ°´çº¿å®ç°ï¼Œé‚£ä¹ˆæ¯å½“ä¸€ä¸ªtcpå…¥è¿æ¥è¯·æ±‚åˆ°è¾¾ï¼Œserverå°±å»ºä¸€ä¸ªå¯¹åº”çš„tcpè¿æ¥ï¼Œå¯¹äºè¿æ¥ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®éœ€è¦æ‰§è¡Œreadæ“ä½œï¼Œé‚£ä¹ˆéœ€è¦ä¸ºæ¯ä¸ªtcpè¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä¸“é—¨ç”¨äºè¯»å–å…¶InputStreamä¸Šçš„æ•°æ®ã€‚å¦‚æœserverè¦å¤„ç†çš„å¹¶å‘é‡åªæ˜¯å‡ åä¸Šç™¾çš„è¯ï¼Œé‚£ä¹ˆè¿™ç§è®¾è®¡æ–¹å¼ä¹Ÿä¸ä¼šé€ æˆä»€ä¹ˆå±å®³ã€‚ä½†æ˜¯å‡å¦‚serveré¢å¯¹çš„æ˜¯æˆç™¾ä¸‡ä¸Šåƒä¸‡çš„å¹¶å‘é‡çš„è¯ï¼Œè¿™ç§è®¾è®¡æ˜¯éš¾ä»¥å¹³è¡Œæ‰©å±•çš„ã€‚åœ¨32ä½ç³»ç»Ÿä¸Šï¼Œä¸€ä¸ªJava Threadçš„çº¿ç¨‹æ ˆå¤§çº¦å 320KBå†…å­˜ï¼Œåœ¨64ä½ç³»ç»Ÿä¸Šï¼Œå¤§çº¦è¦å ç”¨1MBå†…å­˜ï¼Œè®¡ç®—ä¸€ä¸‹100wä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ ˆæ€»å®¹é‡ï¼Œå¤§çº¦ä¸º1TBå†…å­˜ï¼è¿™è¿˜åªæ˜¯çº¿ç¨‹æ ˆçš„å¤§å°ï¼Œè¿˜æ²¡æœ‰è®¡ç®—çº¿ç¨‹éœ€è¦å¤„ç†è¯·æ±‚æ‰€éœ€è¦çš„å †ç©ºé—´ç­‰çš„å†…å­˜ç©ºé—´ã€‚\nä¸ºäº†å‡å°‘åˆ›å»ºçº¿ç¨‹çš„æ•°é‡ï¼Œæœ‰äº›è§£å†³æ–¹æ¡ˆæ˜¯å€ŸåŠ©äºçº¿ç¨‹æ± çš„æ–¹å¼æ¥é¿å…æ— é™åˆ¶åœ°åˆ›å»ºçº¿ç¨‹ã€‚çº¿ç¨‹æ± æŒ‡å®šå…è®¸åˆ›å»ºçº¿ç¨‹çš„æœ€å°ã€æœ€å¤§æ•°é‡ã€‚æ¯å½“æœ‰tcpå…¥è¿æ¥è¯·æ±‚åˆ°è¾¾çš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹åˆ›å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶å°†è¿™ä¸ªè¿æ¥ä¸¢åˆ°ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç„¶åçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ¥ä»è¿™ä¸ªé˜»å¡é˜Ÿåˆ—ä¸­å–å‡ºè¦å¤„ç†çš„tcpè¿æ¥ï¼Œå¹¶è·å–è¿æ¥å¯¹åº”çš„InputStreamç„¶åè¿›è¡Œæ•°æ®è¯»å–æ“ä½œã€‚è¿™é‡Œçš„è®¾è®¡å¯ä»¥ç”¨ä¸‹é¢çš„ç¤ºæ„å›¾æ¥è¡¨ç¤ºï¼Œå›¾ä¸­æœ€å·¦è¾¹çš„å¤šä¸ªStreamä»£è¡¨å¤šä¸ªtcpè¿æ¥ä¸Šçš„InputStreamï¼Œå°†å¤šä¸ªStreamç»„åˆåœ¨ä¸€èµ·çš„æ–¹æ¡†åˆ™ä»£è¡¨ä¿å­˜tcpè¿æ¥çš„é˜»å¡é˜Ÿåˆ—ã€‚\nä½†æ˜¯è¿™ç§åŸºäºçº¿ç¨‹æ± æ¥å¸Œæœ›é¿å…æ— é™åˆ¶åˆ›å»ºçº¿ç¨‹çš„æƒ³æ³•ä¹Ÿæ˜¯ç«™ä¸ä½è„šçš„ï¼Œå› ä¸ºå‡å¦‚æœ‰å¤ªå¤šè¯·æ±‚æ¯”è¾ƒè€—æ—¶ï¼Œé•¿æ—¶é—´å ç”¨çº¿ç¨‹æˆ–è€…æ•°æ®readã€writeé˜»å¡çº¿ç¨‹ï¼Œæ›´æç«¯ä¸€ç‚¹ï¼Œå¾ˆå¯èƒ½çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½è¢«é˜»å¡äº†ï¼Œé‚£ä¹ˆserverä¸ºäº†ä¸å‡ºç°DoSï¼ˆDenial of Serviceï¼‰é‚£å®ƒå¯èƒ½ä¼šæ‰§è¡Œåœ¨çº¿ç¨‹æ± ç»§ç»­åˆ›å»ºçº¿ç¨‹çš„åŠ¨ä½œä»¥å¯¹æ–°çš„è¯·æ±‚è¿›è¡Œå“åº”ï¼Œè¿™ä¸€è¿‡ç¨‹å°†æŒç»­åˆ°çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡è¾¾åˆ°æœ€å¤§é˜ˆå€¼ï¼Œå‡å¦‚æœ€å¤§å€¼ä¸º100wï¼Œé‚£ä¹ˆå ç”¨å†…å­˜è¿˜æ˜¯ä¼šè¶…è¿‡1TBï¼è€Œå¦‚æœä¸ç»§ç»­åˆ›å»ºçº¿ç¨‹ï¼Œå› ä¸ºçº¿ç¨‹éƒ½é˜»å¡äº†ï¼Œä¹Ÿæ— æ³•ç»§ç»­å“åº”æ–°çš„è¯·æ±‚ã€‚\næ‰€ä»¥ï¼ŒåŸºäºé˜»å¡å‹ioæµæ°´çº¿çš„æ¶æ„å¯èƒ½å®ç°MessageReaderã€MessageWriteræ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯çœŸçš„ä¸åˆ©äºserverçš„å¹³è¡Œæ‰©å®¹ï¼Œéš¾ä»¥æœ‰æ•ˆåº”å¯¹é«˜å¹¶å‘çš„åœºæ™¯ï¼Œå¦‚æœäº‹åŠ¡å¤„ç†æ—¶é—´æœ‰æ¯”è¾ƒé•¿çš„è¯ï¼Œç³»ç»Ÿååé‡å°†ä¼šä¸¥é‡ä¸‹é™ï¼Œç”šè‡³äºå¯èƒ½ä¼šå‡ºç°æ‹’ç»æœåŠ¡ã€‚\n11.4 Basic Non-blocking IO Pipeline Design # å‰é¢æåˆ°äº†é˜»å¡å‹ioæµæ°´çº¿çš„ä¼˜ç¼ºç‚¹ï¼Œä¸ºäº†è§£å†³é˜»å¡æ€§ioæµæ°´çº¿çš„å¼Šç«¯ï¼Œå¯ä»¥é‡‡ç”¨éé˜»å¡å‹ioæµæ°´çº¿æŠ€æœ¯æä¾›å¦ä¸€ç§è¯»å–æ•°æ®çš„å®ç°æ–¹æ³•ã€‚\néé˜»å¡å‹ioä¸­å¯ä»¥é€šè¿‡ä¸€ä¸ªMessageReaderæ¥è¯»å–æºè‡ªå¤šä¸ªstreamçš„æ•°æ®ï¼Œå‰ææ˜¯è¦å°†streamå¯¹åº”çš„channelè®¾ç½®ä¸ºéé˜»å¡å·¥ä½œæ¨¡å¼ã€‚éé˜»å¡ioæµæ°´çº¿ä¸‹ï¼ŒMessageReaderè¯»å–æ•°æ®æ“ä½œå¯èƒ½è¿”å›0æˆ–è€…æ­£æ•°ï¼Œå¦‚æœè¿”å›0è¡¨ç¤ºæ²¡æœ‰è¯»å–åˆ°æ•°æ®ï¼Œå¦‚æœè¿”å›æ­£å€¼ï¼Œåˆ™è¡¨ç¤ºæˆåŠŸè¯»å–çš„æ•°æ®æ•°é‡ã€‚\næŸä¸ªtcpè¿æ¥ä¸Šå¦‚æœæ²¡æœ‰æ•°æ®åˆ°è¾¾ï¼Œé‚£ä¹ˆå‰å°±ä¸åº”è¯¥åˆ†é…çº¿ç¨‹å¯¹è¿æ¥ä¸Šçš„æ•°æ®æ‰§è¡Œå¤„ç†ã€‚NIO Channelé‡Œé¢å¯¹äºè¿™äº›éioäº‹ä»¶å°±ç»ªçš„è¿æ¥æ˜¯ä¸ä¼šè¿”å›çš„ï¼Œåªè¿”å›æˆ‘ä»¬å…³å¿ƒçš„å‘ç”Ÿäº†æŸäº›ç‰¹å®šäº‹ä»¶çš„channelï¼Œç„¶åå¯¹channelè¿›è¡Œreadæ“ä½œï¼Œè¿™æ ·æ•ˆç‡è¿˜æ˜¯æ¯”è¾ƒé«˜çš„ã€‚\nè¿™ç§åŸºäºéé˜»å¡ioæµæ°´çº¿æ¨¡å‹çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚\n11.5 Reading Partial Messages # å½“ä»ä¸€ä¸ªSeletableChannelä¸­è¯»å–æ•°æ®æ—¶å¹¶ä¸æ¸…æ¥šè¯»å–åˆ°çš„æ•°æ®æ˜¯å¦æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯ï¼Œè¿™é‡Œè¯»å–åˆ°çš„æ•°æ®Data Blockå¯èƒ½ä¸è¶³ä¸€ä¸ªå®Œæ•´çš„Messageï¼Œå¯èƒ½åˆšå¥½æ˜¯ä¸€ä¸ªå®Œæ•´çš„Messageï¼Œå½“ç„¶ä¹Ÿå¯èƒ½åŒ…æ‹¬äº†ä¸€ä¸ªå®Œæ•´çš„Messageå’Œå¦ä¸€éƒ¨åˆ†æˆ–å®Œæ•´æˆ–ä¸å®Œæ•´çš„Messageæ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nåœ¨å¤„ç†ä¸å®Œæ•´æ¶ˆæ¯æ•°æ®çš„æ—¶å€™é¢ä¸´ç€ä¸¤ä¸ªæŒ‘æˆ˜ï¼š\n å¦‚ä½•æ£€æµ‹åœ¨æ•°æ®å—é‡Œé¢æ˜¯å¦åŒ…æ‹¬äº†ä¸€ä¸ªå®Œæ•´çš„Messageï¼› åœ¨å®Œæ•´çš„Messageæ•°æ®åˆ°è¾¾ä¹‹å‰ï¼Œå¯¹éƒ¨åˆ†åˆ°è¾¾çš„æ•°æ®åº”è¯¥åšå¦‚ä½•å¤„ç†ï¼›  ä¸ºäº†æ£€æµ‹æ¶ˆæ¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œéœ€è¦æä¾›ä¸€ä¸ªMessage Readeræ¥æ£€æŸ¥æ•°æ®å—ä¸­æ˜¯å¦è‡³å°‘åŒ…æ‹¬ä¸€ä¸ªå®Œæ•´çš„Messageå¯¹åº”çš„æ•°æ®ã€‚å¦‚æœè¿™ä¸ªæ•°æ®å—ä¸­åŒ…æ‹¬äº†ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®Œæ•´çš„Messageï¼Œè¿™äº›å®Œæ•´çš„Messageå¯ä»¥å‘é€åˆ°æµæ°´çº¿ä¸­è¿›è¡Œåç»­å¤„ç†ä»»åŠ¡ã€‚ä»æ•°æ®å—ä¸­æ£€æŸ¥Messageå®Œæ•´æ€§çš„å·¥ä½œè¦ä¸åœåœ°é‡å¤ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å¤„ç†è¦å°½å¯èƒ½é«˜æ•ˆã€‚\nå½“æ•°æ®å—ä¸­å‡ºç°äº†ä¸€ä¸ªMessageçš„ä¸å®Œæ•´æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®å¯èƒ½å‡ºç°åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªå®Œæ•´Messageæ•°æ®ä¹‹åï¼Œä¹Ÿå¯èƒ½å•ç‹¬å‡ºç°ï¼Œåœ¨Messageçš„å‰©ä½™æ•°æ®åˆ°è¾¾ä¹‹å‰éœ€è¦å°†è¿™éƒ¨åˆ†æ•°æ®å…ˆä¸´æ—¶ä¿å­˜èµ·æ¥ï¼Œä»¥ä¾¿åç»­æ•°æ®åˆ°è¾¾ä¹‹åå°†å…¶æ‹¼æ¥ä¸ºä¸€ä¸ªå®Œæ•´çš„Messageã€‚\næ£€æµ‹Messageæ•°æ®å®Œæ•´æ€§å’Œå­˜å‚¨Messageçš„ä¸å®Œæ•´æ•°æ®çš„å·¥ä½œï¼Œéƒ½æ˜¯ç”±Message Readeræ¥å®Œæˆçš„ï¼Œä¸ºäº†é¿å…ä¸åŒçš„channelä¸Šåˆ°è¾¾çš„Messageæ•°æ®æ··æ·†åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªchannelåˆ†é…ä¸€ä¸ªå•ç‹¬çš„Message Readerã€‚Message Readerç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚\nä¸€æ—¦ä»selectorè·å–åˆ°ä¸€ä¸ªå¯ä»¥è¿›è¡Œè¯»æ“ä½œçš„channelå®ä¾‹ï¼Œä¸ä¹‹å…³è”çš„Message Readerå°±å¼€å§‹å·¥ä½œï¼Œä»channelä¸­è¯»å–æ•°æ®å¹¶å°†å…¶ç»„è£…æˆä¸€ä¸ªä¸ªå®Œæ•´çš„Messageï¼Œå®Œæ•´çš„Messageå°†è¢«ä¸¢åˆ°æµæ°´çº¿æ‰§è¡Œåç»­å¤„ç†å·¥ä½œã€‚\nå½“ç„¶äº†ï¼ŒMessage Readerå°†è¯»å–åˆ°çš„æ•°æ®å¦‚ä½•ç»„è£…æˆä¸€ä¸ªä¸ªå®Œæ•´çš„Messageï¼Œè¿™ä¸ªæ˜¯ä¸å®šä¹‰çš„åº”ç”¨å±‚åè®®ç›¸å…³çš„ï¼ŒMessage Readerå¿…é¡»è¦çŸ¥é“Messageçš„æ ¼å¼ã€‚å¦‚æœè¦å°†serverå®ç°åšæˆä¸€ä¸ªæ”¯æŒå¤šç§åè®®çš„ï¼Œæœ€å¥½èƒ½å€ŸåŠ©Message Readeræ’ä»¶çš„å½¢å¼æ¥å®Œæˆï¼Œå¯ä»¥é€šå¸¸Message Readerå·¥å‚æ¨¡å¼ï¼Œé€šè¿‡æŒ‡å®šå…·ä½“çš„é…ç½®å‚æ•°æ¥è·å–åè®®å¯¹åº”çš„Message Readerã€‚\n11.6 Storing Partial Messages # å‰é¢å·²ç»æŒ‡å‡ºäº†å­˜å‚¨ä¸å®Œæ•´çš„Messageæ•°æ®ä¹Ÿæ˜¯Message Readerçš„å·¥ä½œï¼Œè¿™é‡Œæˆ‘ä»¬è¯´æ˜ä¸€ä¸‹å¦‚ä½•å®ç°Message Readerå­˜å‚¨ä¸å®Œæ•´Messageæ•°æ®ã€‚\nåœ¨è®¾è®¡å®ç°æ–¹æ¡ˆæ—¶æœ‰è¿™ä¹ˆä¸¤ä¸ªç‚¹éœ€è¦å…³æ³¨ï¼š\n å¸Œæœ›èƒ½å¤Ÿå°½å¯èƒ½å°‘åœ°æ‹·è´æ¶ˆæ¯ï¼Œæ‹·è´æ¬¡æ•°ã€æ‹·è´æ•°æ®è¶Šå¤šï¼Œæ•ˆç‡è¶Šå·®ï¼› å¸Œæœ›èƒ½å¤Ÿå°†å±äºåŒä¸€ä¸ªMessageçš„æ•°æ®åœ¨å†…å­˜ä¸­è¿ç»­å­˜å‚¨ï¼Œæ–¹ä¾¿è§£æï¼›  ä¸ºæ¯ä¸ªMessage Readeråˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„Buffer # å¾ˆæ˜æ˜¾ï¼Œåˆ°è¾¾çš„ä¸å®Œæ•´çš„Messageæ•°æ®éœ€è¦è¢«ä¸´æ—¶å­˜å‚¨åœ¨æŸç§å½¢å¼çš„bufferä¸­ï¼Œæœ€ç›´æ¥çš„å°±æ˜¯æ¯ä¸ªMessage Readeré‡Œé¢å¼€ä¸€ä¸ªbufferæ¥å­˜å‚¨ã€‚ä½†æ˜¯è¿™é‡Œçš„bufferå¤šå¤§åˆé€‚å‘¢ï¼Ÿå®ƒéœ€è¦èƒ½å¤Ÿå­˜å‚¨ä¸‹æœ€å¤§å°ºå¯¸çš„Messageï¼Œå‡å¦‚è¿™ä¸ªæœ€å¤§çš„Messageæ˜¯1MBçš„è¯ï¼Œå‡å¦‚æœ‰100wå¹¶å‘è®¿é—®ï¼Œä¸€ä¸ªtcpè¿æ¥å¯¹åº”ä¸€ä¸ªchannelï¼Œä¸€ä¸ªchannelå¯¹åº”ä¸€ä¸ªMessage Readerï¼Œä¸€ä¸ªReaderå¯¹åº”ä¸€ä¸ªbufferï¼Œå‡å¦‚å°†bufferå¼€åˆ°æœ€å¤§Messageçš„å°ºå¯¸1MBï¼Œè¿™ä¸ªæ—¶å€™å¤§çº¦éœ€è¦100w*1MB=1TBçš„å†…å­˜ï¼Œè€Œå¦‚æœMessageå°ºå¯¸ç»§ç»­å¢å¤§å‘¢ï¼Ÿ16MBæˆ–è€…128MBå‘¢ï¼Ÿ\nè¿™ç§è®¾è®¡æ–¹æ¡ˆå­˜åœ¨ä¸ªå·¨å¤§çš„ç¼ºé™·ï¼Œç°å®ä¸­çš„å†…å­˜å¾ˆéš¾è¾¾åˆ°è¿™ä¸ªå®¹é‡ã€‚\nå®¹é‡å¯è°ƒæ•´çš„Buffers # å†æƒ³ä¸€ç§æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ªå®¹é‡å¯è°ƒæ•´çš„bufferåœ¨Message Readerä¸­ä½¿ç”¨ï¼Œè¿™ä¸ªbufferå‘¢ä¸€å¼€å§‹å®¹é‡æ¯”è¾ƒå°ï¼Œç­‰åˆ°æœ‰è¾ƒå¤§çš„Messageåˆ°è¾¾çš„æ—¶å€™è‡ªåŠ¨æ‰©å±•bufferçš„å®¹é‡ã€‚è¿™æ ·çš„è¯æ¯ä¸ªtcpè¿æ¥å°±ä¸ä¼šå›ºå®šå ç”¨1MBçš„bufferäº†ï¼Œæ¯ä¸ªè¿æ¥ä»…å ç”¨è·å–ä¸‹ä¸€ä¸ªå®Œæ•´Messageæ‰€éœ€è¦çš„bufferç©ºé—´ã€‚\nå®ç°å®¹é‡å¯è°ƒæ•´çš„buffersçš„å®ç°æ–¹æ³•æœ‰å¤šç§ï¼Œå„æœ‰ä¼˜åŠ£ï¼Œè¿™é‡Œå°±ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„å®ç°æ–¹æ³•ã€‚\né€šè¿‡â€œæ‹·è´â€æ“ä½œå®ç°Bufferå®¹é‡è°ƒæ•´ # è¿™é‡Œçš„æ€è·¯æ˜¯å¼€å§‹çš„æ—¶å€™è®¾ç½®bufferä¸ºä¸€ä¸ªè¾ƒå°çš„å®¹é‡ï¼Œä¾‹å¦‚4KBï¼Œå½“ä¸€ä¸ªæ­£åœ¨æ¥æ”¶çš„Messageå¤§å°è¶…è¿‡äº†è¿™ä¸ªbufferæ—¶ï¼Œå‡è®¾Messageå¤§å°ä¸º4.1KBï¼Œè¿™ä¸ªæ—¶å€™å°±ç”³è¯·ä¸€ä¸ªæ›´å¤§çš„bufferï¼Œä¾‹å¦‚8KBï¼Œç„¶åå°†å·²ç»æ¥æ”¶çš„æ•°æ®ä»4KBçš„bufferæ‹·è´åˆ°8KBçš„bufferã€‚\nè¿™ç§æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥ä¿è¯åŒä¸€ä¸ªMessageçš„æ•°æ®åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­çš„ï¼Œè¿™æ ·è§£æè¿™ä¸ªMessageçš„æ—¶å€™å°±ä¼šå˜å¾—å¾ˆç®€å•ï¼ˆå„ä¸ªåè®®å­—æ®µæ˜¯æŒ¨ç€çš„ï¼Œè®¿é—®å„ä¸ªåè®®å­—æ®µæ—¶é€»è¾‘æ›´ç®€å•ï¼‰ã€‚\nè¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯ï¼Œå°ºå¯¸è¾ƒå¤§çš„Messageä¼šå¯¼è‡´å¾ˆå¤šçš„æ•°æ®æ‹·è´åŠ¨ä½œã€‚\nä¸ºäº†å‡å°‘æ•°æ®æ‹·è´çš„æ¬¡æ•°ï¼Œå¯ä»¥å¯¹serverè¯·æ±‚è¿›è¡ŒæŠ“åŒ…åˆ†æï¼Œå¦‚æœå¤§å¤šæ•°çš„è¯·æ±‚Messageéƒ½å°äº4KBï¼Œé‚£ä¹ˆbufferçš„èµ·å§‹å®¹é‡å¯ä»¥è®¾ç½®ä¸º4KBã€‚å†å»¶ä¼¸ä¸€ä¸‹ï¼Œå‡å¦‚åç»­æŠ“åŒ…åˆ†æåˆ°æœ‰äº›è¯·æ±‚Messageå°ºå¯¸ä¼šè¶…è¿‡4KBï¼Œåˆ†æåå‘ç°è¿™äº›éƒ½æ˜¯ä¼ è¾“çš„æ–‡ä»¶ï¼Œè¿›ä¸€æ­¥åˆ†æå‘ç°è¿™äº›æ–‡ä»¶å¤§éƒ¨åˆ†éƒ½æ˜¯å°äº128KBçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘å°†128KBè®¾ä¸ºbufferçš„è°ƒæ•´åå°ºå¯¸ã€‚å†å»¶ä¼¸ä¸€ä¸‹ï¼Œå‡å¦‚åç»­å‘ç°ä¹Ÿæœ‰äº›è¯·æ±‚Messageæ˜¯è¶…è¿‡128KBçš„ï¼Œä½†æ˜¯è¿™äº›è¯·æ±‚å¹¶æ²¡æœ‰æ˜æ˜¾çš„æ¨¡å¼è¡¨æ˜å…¶æœ€å¤§å°ºå¯¸ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æŒ‡å®šä¸€ä¸ªæœ€å¤§é˜ˆå€¼ï¼Œä¾‹å¦‚256KBï¼Œæ¥ä½œä¸ºbufferçš„æœ€å¤§è°ƒæ•´å°ºå¯¸ã€‚\né€šè¿‡å¯¹serverä¸­è¯·æ±‚Messageçš„åˆ†æåï¼Œæˆ‘ä»¬å¾—å‡ºäº†3ä¸ªä¸åŒå®¹é‡çš„bufferæ¥å®ç°è°ƒæ•´bufferå®¹é‡çš„ç›®çš„ï¼Œä¸€å®šç¨‹åº¦ä¸Šå‡å°‘äº†æ•°æ®æ‹·è´çš„æ¬¡æ•°ã€‚\n å¯¹äºå°äº4KBçš„Messageä¸éœ€è¦æ‰§è¡Œæ‹·è´åŠ¨ä½œï¼Œå‡å¦‚Messageéƒ½å°äº4KBï¼Œ100wè¿æ¥åªéœ€è¦å¤§çº¦4GBçš„å†…å­˜ï¼Œè¿™ä¸ªå®¹é‡è¿˜æ˜¯å¯æ¥å—çš„ï¼ˆ2015å¹´æ•°æ®ï¼‰ï¼› å¯¹äºå¤§äº4KBå°äº128KBçš„Messageï¼Œä¹‹å‰å­˜å‚¨åœ¨4KB bufferä¸­çš„æ•°æ®éœ€è¦è¢«æ‹·è´åˆ°128KBçš„bufferä¸­ï¼Œç„¶ååç»­åˆ°è¾¾çš„æ•°æ®ç›´æ¥å­˜å‚¨åˆ°128KBçš„bufferä¸­å³å¯ï¼Œå› æ­¤æ•°æ®æ‹·è´æ¬¡æ•°ä¸º1ï¼› å¯¹äºå¤§äº128KBçš„Messageï¼Œå…¶æœ€åˆæ˜¯è¢«å­˜å‚¨åˆ°4KB bufferä¸­çš„ï¼Œåé¢è¯»å–çš„æ—¶å€™å‘ç°æ•°æ®å­˜ä¸ä¸‹äº†ï¼Œå°±å°†å…¶æ‹·è´åˆ°128KBçš„bufferä¸­ï¼ˆæ‹·è´äº†ä¸€æ¬¡ï¼‰ï¼Œç„¶ååç»­è¯»å–çš„æ—¶å€™å‘ç°128KBçš„bufferä¹Ÿä¸å¤Ÿç”¨äº†ï¼Œå°±éœ€è¦å†å°†å…¶æ‹·è´åˆ°MaxKB bufferä¸­ï¼ˆæ‹·è´äº†ä¸€æ¬¡ï¼‰ï¼Œåç»­å†åˆ°è¾¾çš„æ•°æ®ç›´æ¥å†™å…¥MaxKB bufferä¸­ï¼Œå…±æ‰§è¡Œäº†ä¸¤æ¬¡æ‹·è´åŠ¨ä½œã€‚  è€ƒè™‘åˆ°å¤§äº4KBçš„Messageæ˜¯å°‘é‡çš„ï¼Œå› æ­¤å†…å­˜å ç”¨åº”è¯¥ä¸æ˜¯å¤ªå¤§çš„é—®é¢˜ï¼Œæ•°æ®æ‹·è´æ¬¡æ•°ä¹Ÿåº”è¯¥æ˜¯å¯ä»¥æ¥å—çš„ã€‚\nå½“ä¸€ä¸ªMessageè¢«æ„å»ºæˆåŠŸä¹‹åï¼Œä¸ºæ¥æ”¶Messageæ•°æ®æ‰€åˆ†é…çš„å¤§å®¹é‡çš„bufferåº”è¯¥äºˆä»¥é‡Šæ”¾ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¯¹åº”çš„channelä¸Šçš„Message Readerä¸­çš„bufferåˆä»æœ€å°çš„4KB bufferå¼€å§‹ã€‚è¿™ç§æ–¹å¼ä¿è¯äº†å„ä¸ªè¿æ¥åªå ç”¨å¿…è¦å®¹é‡çš„å†…å­˜ï¼Œä½¿å¾—å¯ä»¥æœ‰æ›´å¤šè¿æ¥åŒæ—¶æ‰§è¡Œæ¶ˆæ¯å¤„ç†ä»»åŠ¡ã€‚\nä½œè€…æ›¾ç»å®ç°äº†ä¸€ä¸ªå®¹é‡å¯è°ƒæ•´çš„Arrayï¼Œé‡‡ç”¨çš„å®ç°æ–¹å¼ä¸è¿™é‡Œçš„ç›¸åŒï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ï¼Œé“¾æ¥åœ°å€ä¸ºResizable Arraysã€‚æ•™ç¨‹é‡Œé¢ç»™å‡ºäº†githubä¸Šæ‰˜ç®¡çš„repoåœ°å€ã€‚\né€šè¿‡â€œè¿½åŠ â€æ“ä½œå®ç°Bufferå®¹é‡è°ƒæ•´ # å¦ä¸€ç§è°ƒæ•´bufferå®¹é‡çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºè¿™æ ·ä¸€ä¸ªbufferï¼Œè®©å®ƒåŒ…æ‹¬å¤šä¸ªæ•°ç»„ï¼ˆæ™®é€šbufferéƒ½æ˜¯åªåŒ…æ‹¬ä¸€ä¸ªæ•°ç»„ï¼‰ï¼Œå½“æˆ‘ä»¬éœ€è¦è°ƒæ•´bufferå®¹é‡çš„æ—¶å€™å°±å†é¢å¤–ç”³è¯·ä¸€ä¸ªæ•°ç»„å¹¶å°†å…¶åŠ å…¥åˆ°è¿™ä¸ªbufferä¸­ï¼Œå‘bufferä¸­å†™æ›´å¤šæ•°æ®æ—¶å°±å¯ä»¥å†™å…¥åˆ°æ–°åŠ å…¥çš„æ•°ç»„ä¸­ã€‚\nè¿™é‡Œä¹Ÿå¯ä»¥ç»†åˆ†ä¸ºä¸¤ç§æ–¹å¼ã€‚ä¸€ç§æ˜¯åœ¨bufferå†…éƒ¨å¢åŠ ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ç»´æŒä¸€ç³»åˆ—æ•°ç»„çš„å¼•ç”¨ï¼Œå½“bufferéœ€è¦æ‰©å¤§å®¹é‡æ—¶ï¼Œå°±åˆ†é…æ–°æ•°ç»„åŠ åˆ°è¿™ä¸ªæ•°ç»„åˆ—è¡¨é‡Œé¢ï¼›å¦ä¸€ç§æ˜¯åˆ†é…ä¸€ç³»åˆ—çš„å…±äº«åŒä¸€æ•°ç»„çš„slicesï¼Œç„¶åbufferä¸­ç»´æŒä¸€ä¸ªåˆ—è¡¨æ¥è®°å½•è¿™äº›slicesã€‚è¿™ä¸¤ç§æ–¹å¼ç±»ä¼¼ï¼Œä½†æ˜¯ä¹Ÿç¡®å®æœ‰ç‚¹åŒºåˆ«ï¼Œå…¶ä¸­ç¬¬äºŒç§æ–¹å¼çœ‹ä¸Šå»è¦æ›´å¥½ä¸€ç‚¹ã€‚\né€šè¿‡è¿½åŠ çš„æ–¹å¼æ¥æ‰©å®¹bufferï¼Œè¿™ç§æ–¹å¼çš„ç¼ºç‚¹æ˜¯æ•°æ®ä¸æ˜¯å­˜å‚¨åœ¨åŒä¸€ä¸ªè¿ç»­çš„åœ°å€ç©ºé—´ä¸­ï¼Œè¿™ä½¿å¾—Messageçš„è§£æå·¥ä½œæ›´åŠ å›°éš¾ï¼Œè§£æå™¨å¿…é¡»å¯¹å¤šä¸ªæ•°ç»„å†…çš„æ•°æ®è¿›è¡Œæ£€æŸ¥æ‰èƒ½ç¡®å®šMessageæ‰€åŒ…å«çš„æ‰€æœ‰æ•°æ®ã€‚è¿™ç§æ–¹å¼æ¯”è¾ƒéš¾å¤„ç†ã€‚\nTLVç¼–ç çš„Message # ä¸€äº›åè®®æ¶ˆæ¯Messageé‡‡ç”¨çš„æ˜¯TLVæ ¼å¼ï¼ŒTLVå³Typeã€Lengthã€Valueã€‚æ„æ€æ˜¯è¯´è¿™æ ·çš„Messageæ•°æ®é¦–å…ˆä¼šå­˜å‚¨æ¶ˆæ¯çš„æ€»é•¿åº¦ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç«‹å³çŸ¥é“éœ€è¦åˆ†é…å¤šå°‘å†…å­˜ç©ºé—´æ‰èƒ½å®¹çº³Messageçš„æ•°æ®ã€‚\nTLVç¼–ç æ ¼å¼ä½¿å¾—å†…å­˜ç®¡ç†æ›´ç®€å•äº†ï¼Œå¾ˆå®¹æ˜“å°±çŸ¥é“éœ€è¦å¤šå°‘å†…å­˜ç©ºé—´æ¥å®¹çº³Messageæ•°æ®ï¼Œä¸ä¼šå‘å‰é¢è¯´çš„resize bufferæ—¶å­˜åœ¨çš„å†…å­˜ç©ºé—´æµªè´¹çš„æƒ…å†µã€‚\nTLVç¼–ç æ ¼å¼çš„ç¼ºç‚¹æ˜¯ï¼Œæˆ‘ä»¬åœ¨Messageæ•°æ®å®Œæ•´åˆ°è¾¾ä¹‹å‰å°±çŸ¥é“äº†æ¶ˆæ¯çš„æ€»é•¿åº¦ï¼Œå¹¶ä¸”ä¸ºå…¶ä¸€æ¬¡æ€§åˆ†é…äº†å†…å­˜ç©ºé—´ï¼Œè¿™å…¶å®åˆæµªè´¹äº†å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ã€‚å¦‚æœæœ‰å¾ˆå¤šçš„æ…¢é€Ÿtcpè¿æ¥ï¼Œå¹¶ä¸”å®ƒä»¬å‘é€çš„éƒ½æ˜¯æ¯”è¾ƒå¤§çš„Messageï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´Messageå¤„ç†ä¹‹å‰å°±å¤§é‡å æ®äº†å†…å­˜ï¼Œå¾ˆå¯èƒ½å¯¼è‡´æœåŠ¡æ²¡æœ‰è¶³å¤Ÿå†…å­˜æ¥å¤„ç†å…¶ä»–äº‹åŠ¡æœ€åæ‹’ç»æœåŠ¡ã€‚\nè§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥å¯¹Messageçš„æ¶ˆæ¯æ ¼å¼è¿›è¡Œä¸€ä¸‹æ”¹è¿›ï¼Œå³è®©è¿™ä¸ªMessageä¸­çš„æ¯ä¸ªå­—æ®µéƒ½ç¼–ç æˆTLVæ ¼å¼çš„ï¼Œç„¶åä¸€ä¸ªå­—æ®µä¸€ä¸ªå­—æ®µåœ°æ¥è¯»å–ï¼Œæ£€æµ‹é•¿åº¦ã€åˆ†é…å†…å­˜ã€è§£æï¼Œæœ€åå†æ„å»ºå‡ºå®Œæ•´çš„Messageï¼Œè¿™æ ·å¯ä»¥é¿å…å› ä¸ºä¸€æ¬¡æ€§åˆ†é…å…¨éƒ¨å†…å­˜å¸¦æ¥çš„å¼Šç«¯ã€‚ä½†æ˜¯å¦‚æœå­—æ®µå€¼ç¡®å®æ¯”è¾ƒå¤§ï¼Œä»ç„¶ä¼šå­˜åœ¨ç±»ä¼¼çš„å†…å­˜åˆ†é…çš„é—®é¢˜ã€‚\nå†ä¸€ç§è§£å†³æ€è·¯æ˜¯ç»™å¾…æ¥æ”¶çš„Messageè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œä¾‹å¦‚æ¯ä¸ªMessageçš„æ¥æ”¶æ—¶é—´è®¾ç½®ä¸º10~15sã€‚å½“ä¸€ä¸ªMessageæ•°æ®éƒ¨åˆ†åˆ°è¾¾ï¼Œå‰©ä½™æ•°æ®æ²¡æœ‰åœ¨å®šæ—¶å™¨è®¾ç½®çš„æ—¶é—´é˜ˆå€¼ä¹‹å†…åˆ°è¾¾ï¼Œé‚£ä¹ˆåˆ™å½“åšè¶…æ—¶äº‹ä»¶å¤„ç†ï¼ŒMessage Readerå¯ä»¥æ”¾å¼ƒå¯¹è¿™ä¸ªMessageçš„å¤„ç†ï¼Œæˆ–è€…ç›´æ¥å…³é—­è¿™ä¸ªMessage Readerå¯¹åº”çš„channelï¼ŒæœåŠ¡å°±å¯ä»¥è…¾å‡ºèµ„æºå»å¤„ç†å…¶ä»–äº‹åŠ¡ã€‚è¿™ç§æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥é¿å…å¶ç„¶åˆ°è¾¾çš„å¾ˆå¤šæ¯”è¾ƒå¤§çš„Messageï¼Œä½†æ˜¯ä»ç„¶ä¼šå‡ºç°æœåŠ¡æ— å“åº”çš„æƒ…å†µã€‚æ¶æ„çš„DoSæ”»å‡»å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨çš„å†…å­˜è¢«å®Œå…¨è€—å°½ã€‚\nTLVç¼–ç å­˜åœ¨å¤šç§ä¸åŒçš„å˜ä½“ï¼ŒæŒ‰ç…§TLVçš„å®šä¹‰å®ƒåº”è¯¥é¦–å…ˆæŒ‡å®šç±»å‹ï¼Œç„¶åæ˜¯é•¿åº¦ï¼Œå†ç„¶åæ˜¯æ•°æ®æœ¬èº«ã€‚ä¹Ÿæœ‰çš„TLVç¼–ç ä¸è¿™æ ·ï¼Œæ¯”å¦‚å…ˆæŒ‡å®šé•¿åº¦ï¼Œç„¶åå†æŒ‡å®šç±»å‹ï¼Œæœ€åæ˜¯æ•°æ®æœ¬èº«ï¼Œè¿™ç§ä¹Ÿç§°ä¸ºLTVç¼–ç ï¼Œä¹Ÿå°±æ˜¯Lengthã€Typeã€Valueï¼Œè¿™ä»ç„¶æ˜¯LTVçš„ä¸€ç§å˜ä½“ã€‚LTVæ¯”TLVæ›´æœ‰ä¼˜åŠ¿ï¼Œä»¥ä¸ºå®ƒå°†é•¿åº¦æ”¾åœ¨æœ€å‰é¢ï¼Œæ›´åˆ©äºç¨‹åºæ„ŸçŸ¥åˆ°Messageæ•°æ®çš„é•¿åº¦ã€‚\nTLVç¼–ç èƒ½è®©ç¨‹åºå°½å¿«æ„ŸçŸ¥åˆ°Messageçš„é•¿åº¦ä¾¿äºç¨‹åºä¸ºå…¶åˆ†é…å†…å­˜ï¼ŒHTTP 1.1ä¹‹æ‰€ä»¥é‡‡ç”¨TLVç¼–ç æ ¼å¼ä¹Ÿæ˜¯æœ‰è¿™æ ·çš„è€ƒè™‘ã€‚HTTP 2.0é‡Œé¢é‡‡ç”¨LTVç¼–ç æ ¼å¼ï¼Œå®Œå–„äº†HTTP 1.1é‡‡ç”¨TLVç¼–ç æ‰€å¸¦æ¥çš„ä¸€äº›é—®é¢˜ã€‚ä½œè€…åœ¨è®¾è®¡å®ç°è‡ªå·±çš„é¡¹ç›®VStack.co projectçš„æ—¶å€™ä¹Ÿæ˜¯å‡ºäºåŒæ ·çš„è€ƒè™‘è€Œé‡‡ç”¨äº†LTVç¼–ç ã€‚\n11.7 Writing Partial Messages # åœ¨éé˜»å¡IOæµæ°´çº¿ä¸­å†™æ•°æ®ä¹Ÿæ˜¯ä¸€ä¸ªä¸å°çš„æŒ‘æˆ˜ï¼Œå½“æˆ‘ä»¬è°ƒç”¨channel.write(buffer)çš„æ—¶å€™ï¼Œå¦‚æœchannelæ˜¯ä»¥éé˜»å¡æ–¹å¼å·¥ä½œçš„ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬æ²¡åŠæ³•ä¿è¯bufferä¸­çš„æ•°æ®æ˜¯å¦å…¨éƒ¨å†™å…¥åˆ°channeläº†ï¼Œwriteæ–¹æ³•ä¼šè¿”å›å†™å…¥çš„å­—èŠ‚æ•°é‡ï¼Œé€šè¿‡è¿™ä¸ªå­—èŠ‚æ•°é‡æ¥è·Ÿè¸ªæ•°æ®åˆ°åº•æœ‰æ²¡æœ‰å†™ã€æœ‰æ²¡æœ‰å†™å®Œã€‚\nä¸ºäº†å¯¹å¯èƒ½çš„å†™å‡ºéƒ¨åˆ†Messageæ•°æ®çš„æƒ…å†µè¿›è¡Œæ›´å¥½åœ°ç®¡ç†ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªchanneléƒ½åˆ†é…ä¸€ä¸ªMessage Writerså®ä¾‹ï¼Œåœ¨æ¯ä¸ªMessage Writerå®ä¾‹å†…éƒ¨æ¥è·Ÿè¸ªå½“å‰æ­£åœ¨å†™çš„Messageå·²ç»å†™å‡ºäº†å¤šå°‘å­—èŠ‚ï¼Œä»è€Œåˆ¤æ–­Messageçš„æ•°æ®æ˜¯å¦å·²ç»å†™å®Œã€‚\næŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½æœ‰å¤šä¸ªMessageç­‰å¾…è¢«å†™å…¥åˆ°channelä¸­ï¼Œä½†æ˜¯Message Writerä¸èƒ½ä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„Messageæ•°æ®å…¨éƒ¨å†™å…¥ï¼Œå› æ­¤è¿™é‡Œç­‰å¾…è¢«å†™å…¥åˆ°channelä¸­çš„Messageå¿…é¡»â€œæ’é˜Ÿâ€ï¼Œå³æˆ‘ä»¬éœ€è¦ç»´æŠ¤ä¸€ä¸ªMessageé˜Ÿåˆ—ï¼Œç„¶åå°†Message WriteræŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºæ¥å°†é˜Ÿåˆ—ä¸­çš„Messageå†™å…¥åˆ°channelä¸­ã€‚\nMessage Writerçš„å·¥ä½œç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚\nMessage Writerä¹‹å‰å¯èƒ½å°†éƒ¨åˆ†Messageçš„æ•°æ®å†™å…¥åˆ°äº†channelä¸­ï¼Œè¿™ç§æƒ…å†µä¸‹Message Writeréœ€è¦è¢«å®šæ—¶æˆ–è€…æ—¶ä¸æ—¶åœ°å¤šè°ƒç”¨å‡ æ¬¡ä»¥å°†åŒä¸€ä¸ªMessageçš„å‰©ä½™æ•°æ®å†™å…¥åˆ°channelä¸­ã€‚\nå¦‚æœæœ‰å¾ˆå¤šçš„tcpè¿æ¥ï¼Œä¹Ÿå°±æ„å‘³ç€å¾ˆå¤šçš„channelï¼Œä¹Ÿå°±æ„å‘³ç€éœ€è¦åˆ†é…å¾ˆå¤šä¸ªMessage Writerå®ä¾‹ã€‚å‡è®¾æˆ‘ä»¬è¦æ”¯æŒ100wå¹¶å‘è¿æ¥è¯·æ±‚ï¼Œæ„å‘³ç€è¦åˆ†é…100wä¸ªMessage Writerï¼Œæ£€æŸ¥100wä¸ªMessage Writeræ˜¯å¦å¯ä»¥æ‰§è¡Œå†™æ“ä½œï¼ˆæ£€æŸ¥channelæ˜¯å¦å¯å†™ã€æ˜¯å¦æœ‰Messageç­‰å¾…å†™å…¥channelï¼‰æ˜¯éå¸¸è€—æ—¶çš„ã€‚é¦–å…ˆå¯èƒ½æœ‰å¾ˆå¤šä¸ªMessage Writeræ²¡æœ‰éœ€è¦å†™å…¥çš„Messageï¼›å¦ä¸€ä¸ªï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„channeléƒ½å¤„äºæ•°æ®å¯å†™çš„çŠ¶æ€ã€‚æˆ‘ä»¬ä¸åº”è¯¥æµªè´¹è¿‡å¤šæ—¶é—´åœ¨æ— ç”¨çš„æ“ä½œä¸Šé¢ï¼Œä¾‹å¦‚å°è¯•å‘ä¸€ä¸ªä¸å¤ªå¯èƒ½å¤„äºå¯å†™çŠ¶æ€çš„channelå†™å…¥æ•°æ®ã€‚\nå‰é¢æˆ‘ä»¬æåˆ°ï¼Œå¯ä»¥é€šè¿‡selectoræ¥è½®è¯¢å¤šä¸ªchannelæ˜¯å¦äº‹ä»¶å°±ç»ªï¼Œè¿™é‡Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ã€‚ä½†æ˜¯å‘¢ï¼Œå°†æ‰€æœ‰çš„100wä¸ªchannelæ³¨å†Œåˆ°ä¸€ä¸ªselectorè½®è¯¢ä¹Ÿæ˜¯ä»£ä»·æ¯”è¾ƒé«˜çš„ï¼Œè¿™æ ·åšä¸ä»…æ²¡å¿…è¦ï¼Œä¹Ÿä¸åº”è¯¥ã€‚å‡å¦‚å¤§å¤šæ•°è¿æ¥éƒ½å¤„äºç©ºé—²çŠ¶æ€ï¼Œç°åœ¨æœ‰100wè¿æ¥ï¼Œå‡è®¾æˆ‘ä»¬å°†è¿™ä¸ª100wä¸ªchannelå…¨éƒ¨æ³¨å†Œåˆ°äº†selectorç„¶åä½¿ç”¨select()æ¥è½®è¯¢äº‹ä»¶ï¼Œé‚£ä¹ˆselectè¿”å›çš„å†™æ“ä½œå°±ç»ªçŠ¶æ€çš„channelå°†ä¼šéå¸¸å¤šï¼ˆå‰é¢å·²å‡è®¾äº†å¤§å¤šæ•°è¿æ¥å¤„äºç©ºé—²ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é€ä¸ªæ£€æŸ¥å„ä¸ªchannelä¸Šçš„Message Writeræ˜¯å¦æœ‰Messageç­‰å¾…è¢«å†™å…¥ã€‚\n å¤‡æ³¨ï¼š\nselectè¿”å›å¾ˆå¤šäº‹ä»¶å°±ç»ªçš„channelç»å¯¹ä¸æ˜¯ä¸€ä¸ªå¥½äº‹æƒ…ï¼Œæ˜¯å¦IOäº‹ä»¶å°±ç»ªçš„æƒ…æ™¯æ²¡æœ‰è¿›è¡Œæ›´ç»†ç²’åº¦åœ°åˆ’åˆ†ï¼Ÿ\n è¿™é‡Œå¯¹IOæƒ…æ™¯åšä¸€ä¸ªå°çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬è‚¯å®šæ˜¯è¦è½®è¯¢channelæ˜¯å¦å†™å°±ç»ªï¼Œä½†æ˜¯ä»€ä¹ˆæ—¶å€™æ‰éœ€è¦åˆ¤æ–­channelçš„çŠ¶æ€å‘¢ï¼Ÿåªæœ‰Message Writeræœ‰Messageè¦å†™å…¥çš„æ—¶å€™æ‰ä¼šåˆ¤æ–­ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è½®è¯¢Message Writeræ˜¯å¦æœ‰Messageè¦å†™å…¥channelï¼Œå¦‚æœæœ‰çš„è¯ï¼Œæˆ‘ä»¬å†å°†å¯¹åº”çš„channelæ³¨å†Œåˆ°selectorï¼Œç„¶åé€šè¿‡selectoræ£€æŸ¥channelæ˜¯å¦å†™å°±ç»ªã€‚ä¸€æ—¦Message Writerå°†ä¸€ä¸ªMessagçš„æ•°æ®å…¨éƒ¨å†™å…¥åˆ°äº†channelï¼Œé‚£ä¹ˆå½“å‰ä¸€æ¬¡å†™æ“ä½œå°±å®Œæˆäº†ï¼Œè¿™ä¸ªæ—¶å€™åº”è¯¥å°†channelä»selectorä¸­å–æ¶ˆæ³¨å†Œï¼Œç­‰åˆ°æœ‰Messageè¦å†™çš„æ—¶å€™å†æ³¨å†Œåˆ°selectorï¼Œè¿™æ ·å¯ä»¥é¿å…selectorè½®è¯¢å¤ªå¤šæ²¡Messageè¦å†™å…¥çš„channelæ‰€å¼•å‘çš„æ€§èƒ½ä¸‹é™é—®é¢˜ã€‚\næ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯å¯ä»¥æ¦‚æ‹¬ä¸ºä¸¤æ­¥ï¼š\n å½“ä¸€ä¸ªMessageè¢«å†™å…¥åˆ°çš„Message Writerçš„Messageé˜Ÿåˆ—çš„æ—¶å€™ï¼Œå°†Message Writerå¯¹åº”çš„channelæ³¨å†Œåˆ°selectorï¼ˆå¦‚æœè¿˜æ²¡æœ‰æ³¨å†Œçš„è¯ï¼‰ï¼› æœåŠ¡ç©ºé—²çš„æ—¶å€™é€šè¿‡selector.select()æ¥ç­›é€‰å‡ºå†™å°±ç»ªçš„channelï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„Message Writerå°†å½“å‰éœ€è¦å†™å…¥çš„Messageæ•°æ®å†™å…¥channelã€‚å¦‚æœMessageæ•°æ®è¢«å…¨éƒ¨å†™å…¥ï¼Œåˆ™å°†channelä»selectorå–æ¶ˆæ³¨å†Œã€‚  11.8 Putting it All Together # ä¸€ä¸ªéé˜»å¡æ¨¡å¼çš„æœåŠ¡å¯èƒ½éœ€è¦å¤šæ¬¡æ£€æŸ¥æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯å¦æ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚Messageï¼Œè¿›è€Œæ£€æŸ¥æ˜¯å¦æ”¶åˆ°äº†å¤šä¸ªå®Œæ•´çš„è¯·æ±‚Messageï¼Œåªè¯»å–ä¸€æ¬¡æ•°æ®ã€æ£€æŸ¥ä¸€æ¬¡æ•°æ®æ˜¯ä¸å¤Ÿçš„ã€‚\nç±»ä¼¼åœ°ï¼Œéé˜»å¡æ¨¡å¼çš„æœåŠ¡ä¹Ÿéœ€è¦å¤šæ¬¡æ£€æŸ¥åŒä¸€ä¸ªMessageçš„å…¨éƒ¨æ•°æ®æ˜¯å¦å…¨éƒ¨å†™å‡ºäº†ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–Messageè¦å†™å‡ºã€‚å¦‚æœæ£€æµ‹åˆ°æœ‰Messageæ•°æ®è¦å†™å‡ºï¼Œé‚£ä¹ˆæœåŠ¡éœ€è¦æ£€æŸ¥ç›¸å…³çš„channelæ˜¯å¦å†™å°±ç»ªã€‚åªåœ¨Messgeå…¥Message Writerçš„å†™é˜Ÿåˆ—æ—¶æ£€æŸ¥ä¸€æ¬¡æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºMessageå¯èƒ½ä¼šè¢«éƒ¨åˆ†å†™å‡ºï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦å¤šæ¬¡å†™æ“ä½œã€‚\næœ€åç¨å¾®æ¦‚æ‹¬ä¸€ä¸‹ï¼Œä¸€ä¸ªéé˜»å¡æ¨¡å¼çš„æœåŠ¡å¤§è‡´éœ€è¦3ä¸ªæµæ°´çº¿æ¥åä½œè¿è¡Œï¼š\n æ•°æ®è¯»å–æµæ°´çº¿ï¼Œå¯¹å»ºç«‹èµ·çš„tcpè¿æ¥ä¸Šçš„è¯·æ±‚æ•°æ®è¿›è¡Œè¯»å–ï¼› äº‹åŠ¡å¤„ç†æµæ°´çº¿ï¼Œå¯¹å·²ç»æ¥æ”¶åˆ°çš„å®Œæ•´Messageè¿›è¡Œäº‹åŠ¡å¤„ç†ï¼› æ•°æ®è¾“å‡ºæµæ°´çº¿ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰Messageæ•°æ®è¦å†™å‡ºåˆ°å»ºç«‹èµ·çš„è¿æ¥ï¼›  è¿™3ä¸ªæµæ°´çº¿åœ¨ä¸€ä¸ªå¾ªç¯ä½“ä¸­é‡å¤æ‰§è¡Œï¼Œå¯èƒ½æœ‰å¿…è¦å¯¹å…¶æ‰§è¡Œè¿‡ç¨‹è¿›è¡Œä¼˜åŒ–ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ²¡æœ‰Messgeç­‰å¾…å†™å‡ºå¯ä»¥é€‰æ‹©è·³è¿‡æ•°æ®è¾“å‡ºæµæ°´çº¿çš„é€»è¾‘ã€‚æˆ–è€…ï¼Œå¦‚æœæ²¡æœ‰æ¥æ”¶åˆ°æ–°çš„å®Œæ•´çš„Messageï¼Œä¹Ÿå¯ä»¥è·³è¿‡äº‹åŠ¡å¤„ç†æµæ°´çº¿çš„éƒ¨åˆ†é€»è¾‘ã€‚\nä¸‹å›¾æ˜¯è¯¥æ•™ç¨‹æ‰€é˜è¿°çš„ä¸€ä¸ªéé˜»å¡æ¨¡å¼ä¸‹æœåŠ¡çš„å·¥ä½œè¿‡ç¨‹ç¤ºæ„å›¾ã€‚\nå¦‚æœçœ‹äº†è¿™é‡Œçš„æ•™ç¨‹ä¹‹åä¾ç„¶è§‰å¾—æœ‰äº›å›°æƒ‘æˆ–è€…æ„Ÿè§‰æœ‰ç‚¹å¤æ‚çš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹ä½œè€…çš„ä¸€ä¸ªnio serverçš„å®ç°ï¼Œgithub java-nio-serverã€‚é˜…è¯»è¿™é‡Œçš„ä»£ç å°†æœ‰åŠ©äºåŠ æ·±è‡ªå·±å¯¹java nio serverçš„ç†è§£ã€‚\nè¿™é‡Œçš„java-nio-serverçš„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚\nè¿™é‡Œçš„serverå®ç°ä¸­ä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªçº¿ç¨‹ï¼š\n çº¿ç¨‹Accepter Threadç”¨æ¥ä»ServerSocketChannelä¸­å»ºç«‹è¿æ¥è·å–SocketChannelï¼› çº¿ç¨‹Processor Threadè´Ÿè´£ä»SocketChannelä¸­è¯»å–è¯·æ±‚å¹¶å¤„ç†ï¼Œç„¶åå°†å¤„ç†ç»“æœè¾“å‡ºåˆ°SocketChannelå®Œæˆå“åº”è¿‡ç¨‹ã€‚Processor Threadçº¿ç¨‹æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­æ‰§è¡Œ3æ¡æµæ°´çº¿ï¼ˆå‰é¢æˆ‘ä»¬æåˆ°è¿‡æœ‰3æ¡æµæ°´çº¿ï¼‰ï¼Œå®Œæˆè¯·æ±‚è¯»å–æ„å»ºè¯·æ±‚Messageï¼Œå¹¶å¯¹è¯·æ±‚Messageè¿›è¡Œå¤„ç†å¾—åˆ°å“åº”Messageï¼Œæœ€åå°†å“åº”Messageè¿”å›ç»™è¯·æ±‚æ–¹ï¼›  12 NIO DatagramChannel # DatagramChannelæ˜¯å¯¹Udpç½‘ç»œå¥—æ¥å­—çš„ä¸€ç§æŠ½è±¡ã€‚å› ä¸ºUDPæ˜¯æ— è¿æ¥åè®®ï¼Œä¸èƒ½åƒè¯»å†™SocketChannelä¸€æ ·æ¥æ“ä½œDatagramChannelï¼Œåœ¨SocketChannelä¸­æˆ‘ä»¬è¯»å–çš„æ˜¯è¯·æ±‚æ¶ˆæ¯çš„é¢å‘æ•°æ®å—çš„æ•°æ®ï¼Œè€Œåœ¨DatagramChannelä¸­æˆ‘ä»¬è¯»å–çš„æ˜¯ç”¨æˆ·æ•°æ®æŠ¥ã€‚è¯´çš„æ›´å‡†ç¡®ä¸€ç‚¹æ˜¯tcpã€udpä¹‹é—´çš„å·®å¼‚ã€‚\n12.1 æ‰“å¼€ä¸€ä¸ªDatagramChannel # ä¸‹é¢æ˜¯å¦‚ä½•æ‰“å¼€ä¸€ä¸ªDatagramChannelçš„ç¤ºä¾‹ä»£ç ã€‚\nDatagramChannel channel = DatagramChannel.open(); channel.socket().bind(new InetSocketAddress(9999));  ç¤ºä¾‹ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç›‘å¬æœ¬åœ°9999/udpç«¯å£çš„DatagramChannelã€‚\n12.2 æ¥æ”¶æ•°æ® # ä¸‹é¢æ˜¯å¦‚ä½•ä»ä¸€ä¸ªDatagramChannelæ¥æ”¶æ•°æ®çš„ç¤ºä¾‹ä»£ç ã€‚\nByteBuffer buf = ByteBuffer.allocate(48); buf.clear(); channel.receive(buf);  DatagramChannel.receive()æ–¹æ³•å°†æ¥æ”¶åˆ°çš„ç”¨æˆ·æ•°æ®æŠ¥å†™å…¥æŒ‡å®šçš„bufferã€‚å¦‚æœæ¥æ”¶åˆ°çš„ç”¨æˆ·æ•°æ®æŠ¥æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸”å·²ç»è¶…è¿‡äº†æ¥æ”¶ç¼“å­˜bufferçš„å¤§å°ï¼Œé‚£ä¹ˆè¿™é‡Œçš„receiveæ–¹æ³•ä¼šç›´æ¥ä¸¢å¼ƒè¶…å‡ºçš„éƒ¨åˆ†ï¼Œè¿™æ ·bufferä¸­çš„æ•°æ®å®é™…ä¸Šå°±æ˜¯ä¸å®Œæ•´çš„äº†ã€‚\n12.3 å‘é€æ•°æ® # ä¸‹é¢æ˜¯å¦‚ä½•å‘ä¸€ä¸ªDatagramChannelå‘é€æ•°æ®çš„ç¤ºä¾‹ä»£ç ã€‚\nString newData = \u0026quot;New String to write to file...\u0026quot; + System.currentTimeMillis(); ByteBuffer buf = ByteBuffer.allocate(48); buf.clear(); buf.put(newData.getBytes()); buf.flip(); int bytesSent = channel.send(buf, new InetSocketAddress(\u0026quot;jenkov.com\u0026quot;, 80));  ç¤ºä¾‹ä»£ç ä¸­å°†å‘ç«™ç‚¹â€œjenkov.comâ€çš„80/udpç«¯å£å‘é€ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç”±äºç›®çš„ä¸»æœºä¸Šä¸å­˜åœ¨ç›‘å¬è¿™ä¸ªç«¯å£çš„æœåŠ¡ï¼Œæ‰€ä»¥ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿã€‚ç¤ºä¾‹ä»£ç åœ¨å‘é€æ•°æ®ä¹‹åä¹Ÿä¸ä¼šæ”¶åˆ°ä»»ä½•å…³äºç”¨æˆ·æ•°æ®æŠ¥å‘é€æ˜¯å¦æˆåŠŸçš„é€šçŸ¥ï¼Œå› ä¸ºUDPæœ¬èº«å°±æ˜¯ä¸å¯é æ•°æ®ä¼ è¾“åè®®ã€‚\n12.4 è¿æ¥åˆ°ç‰¹å®šåœ°å€ # æˆ‘ä»¬ä½¿ç”¨DatagramChannelçš„æ—¶å€™ä¹Ÿå¯ä»¥å°†æœ¬åœ°çš„socketè¿æ¥åˆ°è¿œç¨‹æŸä¸ªä¸»æœºç›‘å¬çš„udp socketä¸Šã€‚å› ä¸ºUDPæ˜¯æ— è¿æ¥åè®®ï¼Œæ‰€ä»¥è¿™é‡Œçš„connectæ“ä½œå¹¶ä¸ä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼äºTCPä¸­çš„è¿æ¥ï¼Œè¿™é‡Œçš„connectæ“ä½œåªæ˜¯å°†DatagramChannelçš„å¯¹ç«¯åœ°å€è®¾ç½®ä¸ºå¾…connectåˆ°çš„åœ°å€ï¼Œä¹‹åè¿™ä¸ªDatagramChannelå°±åªèƒ½æ¥æ”¶è¿™ä¸ªå¯¹ç«¯peerå‘é€æ¥çš„ç”¨æˆ·æ•°æ®æŠ¥ï¼Œè€Œä¸èƒ½æ¥æ”¶å…¶å®ƒåœ°å€å‘é€è¿‡æ¥çš„ç”¨æˆ·æ•°æ®æŠ¥ã€‚\n å¤‡æ³¨ï¼š\nLinux Cç¼–ç¨‹æ—¶ä¹Ÿä¼šç¢°åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œâ€œudp socket connectä½œç”¨â€ç”šè‡³è¢«è®¾ç½®æˆé¢è¯•é¢˜ç›®ã€‚\nå…³äºunconnectedã€connected udp socketä¹‹é—´çš„å·®å¼‚æ€§ï¼Œæˆ‘ç‰¹åœ°åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ç¯‡æ–‡ç« ï¼Œè¿™ç¯‡æ–‡ç« æ¯”è¾ƒè¯¦ç»†åœ°ä»‹ç»äº†äºŒè€…ä¹‹é—´çš„å·®å¼‚æ€§ä»¥åŠå„è‡ªä¸åŒçš„é€‚ç”¨åœºæ™¯ï¼Œä¾‹å¦‚dnså®¢æˆ·ç«¯éœ€è¦connected udp socketçš„åœºæ™¯ï¼ˆdnså®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªåŸŸåè§£æä¸»æœºåœ°å€ï¼‰ï¼Œæˆ–è€…serverç«¯éœ€è¦connectçš„åœºæ™¯ï¼ˆTFTPï¼‰ï¼Œæˆ–è€…äºŒè€…éƒ½éœ€è¦connectçš„åœºæ™¯ã€‚å½“ç„¶ä¹Ÿå­˜åœ¨ä¸èƒ½ä½¿ç”¨connected udp socketçš„æƒ…æ™¯ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è¯´äº†ã€‚\nè¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒè¿™é‡Œçš„æ€»ç»“ï¼Œé“¾æ¥åœ°å€ä¸ºunconnected/connected-udp-socket diffã€‚\n å¥½äº†ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹è¿æ¥åˆ°ç‰¹å®šä¸»æœºåœ°å€ã€ç«¯å£çš„ç¤ºä¾‹ä»£ç ã€‚\nchannel.connect(new InetSocketAddress(\u0026quot;jenkov.com\u0026quot;, 80));  ä¸€æ—¦udp socket connectæˆåŠŸä¹‹åå°±å¯ä»¥é€šè¿‡readã€writeæ–¹æ³•æ¥è¿›è¡Œæ•°æ®çš„è¯»å–å’Œå†™å…¥æ“ä½œäº†ï¼Œæ­¤æ—¶readã€writeæ“ä½œå°±è·Ÿä»¥å‰åœ¨å…¶ä»–channelä¸‰çš„readã€writeæ“ä½œå¾ˆç›¸ä¼¼äº†ã€‚DatagramChannelä¸éœ€è¦ä¿è¯æ•°æ®çš„ä¼ è¾“ã€‚ä¸‹é¢æ˜¯æ•°æ®è¯»å†™çš„ç¤ºä¾‹ä»£ç ã€‚\nint bytesRead = channel.read(buf); int bytesWritten = channel.write(buf);  13 NIO Pipe # Java NIO Pipeæ˜¯ä¸€ç§ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´çš„å•å‘æ•°æ®ä¼ è¾“çš„é€šé“ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªsource channelå’Œä¸€ä¸ªsink channelã€‚è¯»å–æ•°æ®æ—¶éœ€è¦ä»source channelä¸­è¯»å–ï¼Œå†™å…¥æ•°æ®æ—¶éœ€è¦å‘sink channelä¸­å†™å…¥ã€‚\nä¸‹å›¾æ˜¯ä¸€ä¸ªPipeçš„å·¥ä½œç¤ºæ„å›¾ã€‚\n13.1 åˆ›å»ºä¸€ä¸ªPipe # å¯ä»¥é€šè¿‡Pipe.open()æ–¹æ³•æ¥æ‰“å¼€ä¸€ä¸ªPipeï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªPipeã€‚\nPipe pipe = Pipe.open();  13.2 å‘Pipeä¸­å†™å…¥æ•°æ® # å†™æ•°æ®åˆ°Pipeæ—¶ï¼Œéœ€è¦å°†æ•°æ®å†™å…¥åˆ°Pipeçš„sink channelã€‚\n// è·å–Pipeä¸­çš„sink channelç«¯ Pipe.SinkChannel sinkChannel = pipe.sink(); // å†™æ•°æ®åˆ°sink channel String newData = \u0026quot;New String to write to file...\u0026quot; + System.currentTimeMillis(); ByteBuffer buf = ByteBuffer.allocate(48); buf.clear(); buf.put(newData.getBytes()); buf.flip(); while(buf.hasRemaining()) { sinkChannel.write(buf); }  13.3 ä»Pipeä¸­è¯»å–æ•°æ® # ä»Pipeè¯»å–æ•°æ®æ—¶ï¼Œéœ€è¦ä»Pipeçš„source channelä¸­è¿›è¡Œè¯»å–ã€‚\n// è·å–Pipeä¸­çš„source channelç«¯ Pipe.SourceChannel sourceChannel = pipe.source(); // ä»source channelè¯»å–æ•°æ® ByteBuffer buf = ByteBuffer.allocate(48); int bytesRead = inChannel.read(buf);  14 NIO vs IO # å­¦ä¹ Java NIOå’ŒIOç›¸å…³APIæ—¶ï¼Œå…ˆè¦ææ˜ç™½ä»€ä¹ˆæ—¶å€™åº”è¯¥é€‰æ‹©Java NIOä»€ä¹ˆæ—¶å€™é€‰æ‹©Java IOã€‚è¿™é‡Œè®²æè¿°ä¸€ä¸‹Java NIOå’ŒIOçš„åŒºåˆ«ã€é€‚ç”¨åœºæ™¯ï¼Œä»¥åŠå®ƒä»¬å¯¹è½¯ä»¶è®¾è®¡ã€ç¼–ç å¸¦æ¥çš„å½±å“ã€‚\n14.1 NIOå’ŒIOä¹‹é—´çš„ä¸»è¦åŒºåˆ« # ä¸‹è¡¨ä¸­å¯¹NIOå’ŒIOä¹‹é—´çš„ä¸»è¦åŒºåˆ«è¿›è¡Œäº†æ€»ç»“ï¼Œæœ¬èŠ‚ä¼šè¯¦ç»†æè¿°æ¯ä¸€ä¸ªåŒºåˆ«ã€‚\n   IO NIO     é¢å‘æµï¼ˆstreamï¼‰ é¢å‘æ•°æ®å—ï¼ˆbufferï¼‰   é˜»å¡IO éé˜»å¡IO + selector    14.1 Stream Oriented vs Buffer Oriented # NIOå’ŒNIOç¬¬ä¸€ä¸ªè¾ƒå¤§ä¸åŒå°±æ˜¯IOæ˜¯é¢å‘æµï¼ˆstreamï¼‰çš„ï¼Œè€ŒNIOæ˜¯é¢å‘æ•°æ®å—ï¼ˆbufferï¼‰çš„ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\né¢å‘æµçš„IOï¼Œä»æµä¸­ä¸€æ¬¡åªå¯ä»¥è¯»å–ä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚ä½•å¯¹è¯»å–åˆ°çš„å­—èŠ‚è¿›è¡Œå¤„ç†æ˜¯ç”±ç¨‹åºå†³å®šï¼Œè¿™äº›è¯»å–åˆ°çš„å­—èŠ‚ä¸ä¼šè¢«cacheåˆ°æŸä¸ªåœ°æ–¹ã€‚è¿™æ„å‘³ç€ä¸èƒ½åœ¨æµä¸­å‰åç§»åŠ¨ï¼Œå¦‚æœéœ€è¦åœ¨æµä¸­å®ç°å‰åç§»åŠ¨çš„ç›®çš„çš„è¯ï¼Œéœ€è¦å°†æµä¸­çš„æ•°æ®å…ˆcacheèµ·æ¥ã€‚\né¢å‘æ•°æ®å—çš„NIOä¸IOæœ‰äº›ä¸åŒã€‚æ•°æ®é¦–å…ˆè¢«è¯»å–åˆ°æ•°æ®å—bufferä¸­ï¼Œç„¶åæˆ‘ä»¬å¯¹bufferä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚å› ä¸ºæ•°æ®å·²ç»è¢«cacheåˆ°bufferä¸­äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¾¾åˆ°å‰åç§»åŠ¨è¯»ä½ç½®çš„ç›®çš„ï¼Œæ­¤å¤–ä¹Ÿç»™æˆ‘ä»¬æ•°æ®å¤„ç†æ—¶æ›´å¥½çš„çµæ´»æ€§ã€‚å½“ç„¶äº†ï¼Œè¿™ç§æ–¹å¼è¿˜æ˜¯è¦æ±‚æˆ‘ä»¬æ•°æ®å¤„ç†å‰æ£€æŸ¥æ˜¯å¦ä¸€ä¸ªå®Œæ•´çš„Messageåˆ°è¾¾äº†æˆ–è€…è¢«å…¨éƒ¨å†™å‡ºäº†ã€‚\n14.2 é˜»å¡IOå’Œéé˜»å¡IO # Java IOçš„æµæ“ä½œæ˜¯é˜»å¡çš„ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œreadã€writeæ“ä½œæ—¶ï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼ŒçŸ¥é“readã€writeæ“ä½œå®Œæˆæ‰ä¼šè¢«å”¤é†’ï¼Œåœ¨å”¤é†’ä¹‹å‰çº¿ç¨‹æ— æ³•æ‰§è¡Œå…¶ä»–ä»»ä½•å¤„ç†ã€‚\nJava NIOçš„éé˜»å¡æ¨¡å¼ä½¿å¾—ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œioå¤„ç†çš„æ—¶å€™ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹åˆ°ioå®Œæˆï¼Œå¦‚æœioæ“ä½œæ²¡æœ‰å®Œæˆä¹Ÿä¼šç«‹å³è¿”å›ï¼Œä¾‹å¦‚readæ“ä½œæ—¶æ²¡æœ‰æ•°æ®å¯è¯»å°±è¿”å›è¯»å–äº†0ä¸ªæ•°æ®ï¼Œçº¿ç¨‹å¯ä»¥æ‰§è¡Œå…¶ä»–å¤„ç†ç„¶åè¿‡æ®µäº‹ä»¶ä¹‹åå†ç»§ç»­æ‰§è¡Œioä»»åŠ¡ã€‚ioç›¸å…³çš„apiä¸é˜»å¡çº¿ç¨‹æ„å‘³ç€çº¿ç¨‹å¯ä»¥åœ¨æŸä¸ªchannelæœªå°±ç»ªæ—¶å»å¤„ç†å…¶ä»–channelä¸Šçš„ioä»»åŠ¡ï¼Œå¯ä»¥æé«˜å¹¶å‘è®¿é—®æ€§èƒ½ã€‚\n14.3 Selectors # Java NIOä¸­çš„é€‰æ‹©å™¨selectorå…è®¸ä¸€ä¸ªçº¿ç¨‹å¯¹å¤šä¸ªchannelä¸Šçš„ioäº‹ä»¶å°±ç»ªçŠ¶æ€è¿›è¡Œç›‘è§†ï¼Œä¾‹å¦‚ç›‘è§†channelä¸Šæœ‰æ•°æ®å¯è¯»ã€channelä¸Šå¯ä»¥å†™å…¥æ•°æ®ç­‰ç­‰ã€‚\n14.3 é€‰æ‹©NIOæˆ–IOå¯¹ç¨‹åºè®¾è®¡çš„å½±å“ # ä¸ç®¡æ˜¯é€‰æ‹©NIOè¿˜æ˜¯é€‰æ‹©IOéƒ½ä¼šå½±å“åˆ°ç¨‹åºè®¾è®¡ï¼Œä¸»è¦åŒ…æ‹¬3ç‚¹ï¼š\n ä½¿ç”¨NIOæˆ–è€…IOçš„ç›¸å…³APIï¼› æ•°æ®å‡ºæ¥ï¼› å¤„ç†æ•°æ®çš„çº¿ç¨‹æ•°é‡ï¼›  14.3.1 API Calls # NIOã€IOäºŒè€…å¯¹åº”çš„APIæ˜¯ä¸åŒçš„ï¼ŒNIOå¤šæ˜¯ç»“åˆbufferã€channelã€selectorè¿›è¡Œæ“ä½œçš„ï¼Œè€ŒIOå¤šæ˜¯åŸºäºstreamè¿›è¡Œæ“ä½œçš„ã€‚\n14.3.2 æ•°æ®å¤„ç† # é€‰æ‹©NIOå’ŒIOï¼Œå¯¹æ•°æ®å¤„ç†çš„æ–¹å¼ä¹Ÿä¼šé€ æˆè¾ƒå¤§å½±å“ã€‚\nä»¥è¯»å–æ•°æ®ä¸ºä¾‹ï¼Œå½“é€‰æ‹©IO APIæ—¶æˆ‘ä»¬ä¸€èˆ¬æ˜¯ä»InputStreamä¸­æˆ–è€…ä¸€ä¸ªReaderä¸­è¯»å–æ•°æ®ã€‚å‡å¦‚æœ‰ç°åœ¨è¿™æ ·ä¸€ä¸ªæ–‡ä»¶ï¼š\nName: Anna Age: 25 Email: anna@mailserver.com Phone: 1234567890  æˆ‘ä»¬ä¸€èˆ¬ä¼šåƒä¸‹é¢è¿™æ ·æ¥å¤„ç†ä¸Šè¿°æ–‡ä»¶å†…å®¹ï¼š\nInputStream input = ... ; // get the InputStream from the client socket BufferedReader reader = new BufferedReader(new InputStreamReader(input)); String nameLine = reader.readLine(); String ageLine = reader.readLine(); String emailLine = reader.readLine(); String phoneLine = reader.readLine();  é€šè¿‡çœ‹ç¨‹åºæ‰§è¡Œåˆ°äº†å“ªè¡Œä»£ç æˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­å½“å‰æ–‡ä»¶å¤„ç†çš„è¿›åº¦ã€‚ä¾‹å¦‚ï¼Œå½“ç¬¬ä¸€ä¸ªreader.readLine()æ–¹æ³•æ‰§è¡Œç»“æŸåï¼Œå°±æ„å‘³ç€ç¨‹åºä¸€å®šæ˜¯å®Œæ•´åœ°è¯»å–å®Œäº†â€œName: Anneâ€è¿™è¡Œï¼Œå¹¶ä¸”è¿™ä¸ªè°ƒç”¨ä¼šåœ¨å®Œæ•´è¯»å–è¿™è¡Œæ•°æ®ä¹‹åæ‰ä¼šè¿”å›ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å¯ä»¥æ ¹æ®ç¨‹åºæ‰§è¡Œçš„ä½ç½®æ¥æ¨æµ‹æ–‡ä»¶å¤„ç†è¿›åº¦çš„æ ¹æœ¬åŸå› ã€‚å¯¹åé¢å„è¡Œæ•°æ®çš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å¤„ç†é€»è¾‘å‚è€ƒä¸‹å›¾ã€‚\nä¸€ä¸ªé‡‡ç”¨äº†NIOçš„ç¨‹åºï¼Œå…¶æ•°æ®å¤„ç†æ–¹å¼å­˜åœ¨ä¸€äº›ä¸åŒã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ç¤ºä¾‹ã€‚\nByteBuffer buffer = ByteBuffer.allocate(48); int bytesRead = inChannel.read(buffer);  ä¸Šé¢ç¬¬äºŒè¡Œä»£ç æ˜¯ä»inChannelä¸­è¯»å–æ•°æ®åˆ°bufferï¼Œä½†æ˜¯å½“è¿™ä¸ªinChannelè¿”å›æ—¶ä½ å¹¶ä¸çŸ¥é“è¿™ä¸ªbufferä¸­åˆ°åº•è¢«å†™å…¥äº†å¤šå°‘æ•°æ®ï¼Œè¿™ä½¿å¾—æ•°æ®å¤„ç†å˜å¾—å›°éš¾ã€‚\nè®¾æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚inChannel.read(buffer)è¿”å›æ—¶bufferä¸­åªè¢«å†™å…¥äº†åŠè¡Œçš„æ•°æ®ï¼Œä¾‹å¦‚åªå†™å…¥äº†â€œName: Anâ€ï¼Œè¿˜æœ‰å‡ ä¸ªå­—ç¬¦æ²¡æœ‰å†™å…¥ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯å¦è¦å¤„ç†è¿™ç§ä¸å®Œæ•´çš„æ•°æ®å‘¢ï¼Ÿå½“ç„¶ä¸å¤„ç†äº†ï¼Œæˆ‘ä»¬éœ€è¦ç­‰åˆ°è‡³å°‘è¿™ä¸€è¡Œæ•°æ®å®Œæ•´åˆ°è¾¾ä¹‹åæ‰åº”è¯¥å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œä¸ç„¶è§£æä¸€ä¸ªä¸å®Œæ•´çš„ã€æ— æ•ˆçš„æ•°æ®ä¹Ÿæ²¡ä»€ä¹ˆç”¨å¤„ã€‚\né‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“bufferä¸­æ°å¥½åŒ…æ‹¬äº†å®Œæ•´çš„ä¸€è¡Œæ•°æ®å‘¢ï¼Ÿæ— æ³•å¾—çŸ¥ã€‚æˆ‘ä»¬åªèƒ½é€šè¿‡é‡å¤åœ°æ£€æŸ¥æ¥å‘ç°bufferä¸­æ˜¯å¦åŒ…æ‹¬äº†è‡³å°‘ä¸€è¡Œå®Œæ•´çš„æ•°æ®ï¼ˆå¯èƒ½æ˜¯åŠè¡Œã€ä¸€è¡Œã€ä¸åˆ°ä¸¤è¡Œâ€¦â€¦ï¼‰ã€‚è¿™ä½¿å¾—æ•°æ®å¤„ç†é€»è¾‘å˜å¾—æœ‰äº›å¤æ‚ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚\nByteBuffer buffer = ByteBuffer.allocate(48); int bytesRead = inChannel.read(buffer); // ç®€åŒ–ç‰ˆï¼Œè®¤ä¸ºbufferæ»¡ä¸ºæ•°æ®å¤„ç†å¯ä»¥å¼€å§‹çš„æ ‡è¯† while(! bufferFull(bytesRead) ) { bytesRead = inChannel.read(buffer); } // å¤„ç†æ•°æ® processData(buffer);  ä¸Šè¿°ç®€åŒ–ç‰ˆç¤ºä¾‹ä»£ç ä¸­åˆ¤æ–­æ˜¯å¦æ»¡çš„while(\u0026hellip;)æ‰§è¡Œé€»è¾‘ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚\n14.3.3 æ€»ç»“ # NIOä½¿å¾—æˆ‘ä»¬å¯ä»¥å€ŸåŠ©selectorå¯¹å¾ˆå¤šçš„channelï¼ˆç½‘ç»œè¿æ¥æˆ–è€…æ–‡ä»¶ï¼‰è¿›è¡Œç®¡ç†ï¼Œä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ä¹Ÿå°‘ï¼Œä¸è¶³ä¹‹å¤„åœ¨äºå¢åŠ äº†æ•°æ®å¤„ç†çš„éš¾åº¦ï¼Œè‡³å°‘æ¯”æ ‡å‡†IOæ¨¡å¼ä¸‹çš„æ•°æ®å¤„ç†è¦å¤æ‚å¤šäº†ï¼Œä¸»è¦æ˜¯éº»çƒ¦åœ¨read partial messageã€write partial messageã€buffer resizeè¿™å‡ ä¸ªç‚¹ä¸Šã€‚\nå¦‚æœéœ€è¦åŒæ—¶å¤„ç†æˆåƒä¸Šä¸‡çš„è¿æ¥ï¼Œè¿™äº›è¿æ¥ä¸Šåªæ˜¯å‘é€å¾ˆå°‘é‡çš„æ•°æ®ï¼Œä¾‹å¦‚ä¸€ä¸ªèŠå¤©æœåŠ¡å™¨ï¼Œè¿™ç§æƒ…å¢ƒä¸‹ä½¿ç”¨NIOæ¥å®ç°åº”è¯¥èƒ½è·å¾—æ›´é«˜çš„æ€§èƒ½ï¼Œå› ä¸ºè¿æ¥ä¸Šæ”¶å‘çš„æ•°æ®é‡éƒ½æ¯”è¾ƒå°ï¼ŒåŸºäºNIOæ¥å®ç°çš„è¯å¯ä»¥å°½é‡å‡å°‘rå¤„ç†ead partial messageã€write partial messageçš„ä»£ä»·ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹ç®¡ç†å¤šä¸ªè¿æ¥çš„è®¾è®¡æ€è·¯ï¼Œè¿™ä¸ªçº¿ç¨‹é€šè¿‡selectorç›‘è§†å¹¶å¤„ç†å¤šä¸ªè¿æ¥ä¸Šçš„ioäº‹ä»¶ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nä½†æ˜¯å‡å¦‚æœåŠ¡ä¸­æœ‰ä¸å°‘è¿æ¥ä¸Šçš„æµé‡æ¯”è¾ƒå¤§ï¼Œæ¯”å¦‚å¯èƒ½æ˜¯åœ¨ä¼ è¾“æ–‡ä»¶ï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½ä½¿ç”¨Java IOæ¥å®ç°ä¼šæ›´å¥½ä¸€ç‚¹ï¼Œå› ä¸ºå¦‚æœé‡‡ç”¨NIOçš„è¯ï¼Œè¿™é‡Œçš„å¤§æµé‡è¿æ¥ä¸Šçš„æ•°æ®å¤„ç†å°±ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºæœåŠ¡è¦ä¸åœåœ°å¤„ç†read partial messageã€write partial messageçš„æƒ…å†µã€‚è¿™ç§æƒ…å†µä¸‹é‡‡ç”¨ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£å»ºç«‹å…¥è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†å»ºç«‹çš„è¿æ¥ä¸¢ç»™çº¿ç¨‹æ± å¤„ç†çš„æ€è·¯æ¯”è¾ƒé è°±ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n15 NIO Path # Java NIO 2ä¸­å¢åŠ äº†ä¸€ç§æ–°çš„æ¥å£ï¼Œjava.nio.file.Pathï¼Œé€šè¿‡å®ƒå¯ä»¥æ¥å®šä¹‰ä¸€ä¸ªç»å¯¹è·¯å¾„æˆ–è€…ç›¸å¯¹è·¯å¾„ï¼Œè¿™é‡Œçš„è·¯å¾„æŒ‡çš„æ˜¯æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ä¿¡æ¯ã€‚\nè¿™éƒ¨åˆ†å†…å®¹ï¼Œæœ¬äººè®¤ä¸ºå¹¶ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œæ‰€ä»¥åœ¨æ­¤ä¸è¯¦ç»†å±•å¼€ï¼Œåªç»™å‡ºç®€çŸ­çš„ç¤ºä¾‹ä»£ç ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥æ‰§è¡Œgoogleã€‚\nåˆ›å»ºä¸€ä¸ªPathç¤ºä¾‹ã€‚\nimport java.nio.file.Path; import java.nio.file.Paths; public class PathExample { public static void main(String[] args) { Path path = Paths.get(\u0026quot;/home/jakobjenkov/myfile.txt\u0026quot;); } }  åˆ›å»ºä¸€ä¸ªç»å¯¹è·¯å¾„ç¤ºä¾‹ã€‚\nPath path = Paths.get(\u0026quot;/home/jakobjenkov/myfile.txt\u0026quot;);  åˆ›å»ºä¸€ä¸ªç›¸å¯¹è·¯å¾„ç¤ºä¾‹ã€‚\nPath projects = Paths.get(\u0026quot;d:\\\\data\u0026quot;, \u0026quot;projects\u0026quot;); Path file = Paths.get(\u0026quot;d:\\\\data\u0026quot;, \u0026quot;projects\\\\a-project\\\\myfile.txt\u0026quot;);  normalizeä¸€ä¸ªPathï¼ŒæŒ‡çš„æ˜¯ä»è·¯å¾„ä¸­ç§»é™¤â€œ.â€ã€â€œ..â€è¿™æ ·çš„ç¬¦å·ã€‚\nString originalPath = \u0026quot;d:\\\\data\\\\projects\\\\a-project\\\\..\\\\another-project\u0026quot;; Path path1 = Paths.get(originalPath); System.out.println(\u0026quot;path1 = \u0026quot; + path1); Path path2 = path1.normalize(); System.out.println(\u0026quot;path2 = \u0026quot; + path2);  16 NIO Files # Java NIOä¸­å¼•å…¥äº†ä¸€ä¸ªjava.nio.file.Filesç±»ï¼Œå®ƒæä¾›äº†å¾ˆå¤šçš„ç”¨äºæ–‡ä»¶æ“ä½œçš„æ–¹æ³•ï¼Œè¿™é‡Œè®²å¯¹æŸäº›å¸¸ç”¨æ–¹æ³•è¿›è¡Œä»‹ç»ï¼Œè¯»è€…æœ‹å‹å¦‚æœå‘ç°æœ‰äº›æƒ³è¦çš„åŠŸèƒ½æˆ–è€…æ–¹æ³•è¿™é‡Œæ²¡æœ‰æåˆ°ï¼Œå»ºè®®æŸ¥é˜…ä¸€ä¸‹JavaDocç¡®è®¤æ˜¯å¦æ”¯æŒã€‚\nè¿™é‡Œçš„Filesç±»ä¸€èˆ¬æ˜¯é…åˆjava.nio.file.Pathæ¥ä½¿ç”¨çš„ï¼ŒPathå‰é¢å› ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚\n16.1 æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ # é€šè¿‡Files.exist(Path path, new LinkOption[]{\u0026hellip;})æ¥æ£€æŸ¥æŒ‡å®šçš„pathæ˜¯å¦å­˜åœ¨ï¼Œpathå¯ä»¥æ˜¯æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç»å¯¹è·¯å¾„æˆ–è€…ç›¸å¯¹è·¯å¾„ï¼Œå› æ­¤å¯ä»¥èµ·åˆ°æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨çš„ç›®çš„ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath path = Paths.get(\u0026quot;data/logging.properties\u0026quot;); boolean pathExists = Files.exists(path, new LinkOption[]{ LinkOption.NOFOLLOW_LINKS});  16.2 åˆ›å»ºç›®å½• # åˆ›å»ºç›®å½•å¯ä»¥é€šè¿‡Files.createDirectory(Path path)æ¥å®Œæˆï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath path = Paths.get(\u0026quot;data/subdir\u0026quot;); try { Path newDir = Files.createDirectory(path); } catch(FileAlreadyExistsException e){ // the directory already exists. } catch (IOException e) { //something else went wrong e.printStackTrace(); }  16.3 æ–‡ä»¶æ‹·è´ # æ–‡ä»¶æ‹·è´å¯ä»¥é€šè¿‡Files.copy(Path sourcePath, Path destPath)æ¥å®Œæˆï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath sourcePath = Paths.get(\u0026quot;data/logging.properties\u0026quot;); Path destinationPath = Paths.get(\u0026quot;data/logging-copy.properties\u0026quot;); try { Files.copy(sourcePath, destinationPath); } catch(FileAlreadyExistsException e) { //destination file already exists } catch (IOException e) { //something else went wrong e.printStackTrace(); }  16.4 è¦†ç›–æ–‡ä»¶ # é€šè¿‡æ–‡ä»¶æ‹·è´æ“ä½œï¼Œå…¶å®ä¹Ÿå¯ä»¥èµ·åˆ°è¦†ç›–æ–‡ä»¶çš„ä½œç”¨ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\n// logging.propertieså’Œlogging-copy.propertieså‡ä¸ºå·²ç»å­˜åœ¨çš„æ–‡ä»¶ Path sourcePath = Paths.get(\u0026quot;data/logging.properties\u0026quot;); Path destinationPath = Paths.get(\u0026quot;data/logging-copy.properties\u0026quot;); try { Files.copy(sourcePath, destinationPath, StandardCopyOption.REPLACE_EXISTING); } catch(FileAlreadyExistsException e) { //destination file already exists } catch (IOException e) { //something else went wrong e.printStackTrace(); }  16.5 æ–‡ä»¶ç§»åŠ¨ # æ–‡ä»¶ç§»åŠ¨é€šè¿‡Files.move(Path sourcePath, Path destPath)æ¥å®ç°ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath sourcePath = Paths.get(\u0026quot;data/logging-copy.properties\u0026quot;); Path destinationPath = Paths.get(\u0026quot;data/subdir/logging-moved.properties\u0026quot;); try { Files.move(sourcePath, destinationPath, StandardCopyOption.REPLACE_EXISTING); } catch (IOException e) { //moving file failed. e.printStackTrace(); }  16.6 æ–‡ä»¶åˆ é™¤ # æ–‡ä»¶åˆ é™¤å¯ä»¥é€šè¿‡Files.delete(Path path)æ¥å®ç°ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath path = Paths.get(\u0026quot;data/subdir/logging-moved.properties\u0026quot;); try { Files.delete(path); } catch (IOException e) { //deleting file failed e.printStackTrace(); }  16.7 é€’å½’éå†ç›®å½• # é€’å½’éå†ç›®å½•å¯ä»¥é€šè¿‡Files.walkFileTree(Path dirPath, FileVisitor vistor)æ¥å®ç°ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\n// FileVistorå£°æ˜äº†éå†æ—¶çš„å‡ ä¸ªå…³é”®å‡½æ•° public interface FileVisitor { public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException; public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException; public FileVisitResult visitFileFailed(Path file, IOException exc) throws IOException; public FileVisitResult postVisitDirectory(Path dir, IOException exc) throws IOException; } // è°ƒç”¨walkFileTreeæ—¶éœ€è¦ä¼ å…¥ä¸€ä¸ªå®ç°äº†ä¸Šè¿°æ¥å£æ–¹æ³•çš„å®ä¾‹å¯¹è±¡ï¼Œä½†æ˜¯æœ‰æ—¶å€™æ²¡æœ‰ // å¿…è¦å…¨éƒ¨è‡ªå·±å®ç°ä¸€éï¼Œå…¶å®SimpleFileVisitorä¸­å·²ç»å®ç°äº†ä¸Šè¿°çš„å…¨éƒ¨æ¥å£ï¼Œä½†æ˜¯ // åœ¨æŸç§æƒ…å†µä¸‹å¯èƒ½éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªFileVisitorã€‚ // é€’å½’éå†ç›®å½• Files.walkFileTree(path, new FileVisitor\u0026lt;Path\u0026gt;() { @Override public FileVisitResult preVisitDirectory(Path dir, BasicFileAttributes attrs) throws IOException { System.out.println(\u0026quot;pre visit dir:\u0026quot; + dir); return FileVisitResult.CONTINUE; } @Override public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException { System.out.println(\u0026quot;visit file: \u0026quot; + file); return FileVisitResult.CONTINUE; } @Override public FileVisitResult visitFileFailed(Path file, IOException exc) throws IOException { System.out.println(\u0026quot;visit file failed: \u0026quot; + file); return FileVisitResult.CONTINUE; } @Override public FileVisitResult postVisitDirectory(Path dir, IOException exc) throws IOException { System.out.println(\u0026quot;post visit directory: \u0026quot; + dir); return FileVisitResult.CONTINUE; } });  ä¸Šè¿°ä»£ç ä¸éš¾çœ‹æ‡‚ï¼Œè¿™é‡Œå¯¹FileVisitResultä¸­çš„æšä¸¾å˜é‡è¿›è¡Œä¸€ä¸‹è¯´æ˜ï¼š\n CONTINUEï¼Œç»§ç»­éå†ï¼› TERMINATEï¼Œåœæ­¢éå†ï¼› SKIP_SIBLINGSï¼Œç»§ç»­éå†ï¼Œéå†çš„æ—¶å€™è·³è¿‡å½“å‰æ–‡ä»¶çš„siblingsï¼ˆå…„å¼Ÿï¼‰ï¼› SKIP__SUBTREEï¼Œç»§ç»­éå†ï¼Œéå†çš„æ—¶å€™è·³è¿‡å½“å‰æ–‡ä»¶çš„subtreeï¼ˆå­æ ‘ï¼‰ï¼›  16.8 æ–‡ä»¶æœç´¢ # ç»“åˆFiles.walkFileTree()å’Œæ–‡ä»¶ä¿¡æ¯æ¯”è¾ƒå¯ä»¥å®ç°æ–‡ä»¶æœç´¢ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath rootPath = Paths.get(\u0026quot;data\u0026quot;); String fileToFind = File.separator + \u0026quot;README.txt\u0026quot;; try { Files.walkFileTree(rootPath, new SimpleFileVisitor\u0026lt;Path\u0026gt;() { @Override public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException { String fileString = file.toAbsolutePath().toString(); //System.out.println(\u0026quot;pathString = \u0026quot; + fileString); if(fileString.endsWith(fileToFind)){ System.out.println(\u0026quot;file found at path: \u0026quot; + file.toAbsolutePath()); return FileVisitResult.TERMINATE; } return FileVisitResult.CONTINUE; } }); } catch(IOException e){ e.printStackTrace(); }  16.9 é€’å½’åˆ é™¤ç›®å½•ä¸‹æ–‡ä»¶ # ç»“åˆwalkFileTree()å’Œdeleteå¯ä»¥å®ç°é€’å½’åˆ é™¤ç›®å½•ä¸‹æ–‡ä»¶ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath rootPath = Paths.get(\u0026quot;data/to-delete\u0026quot;); try { Files.walkFileTree(rootPath, new SimpleFileVisitor\u0026lt;Path\u0026gt;() { @Override public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException { System.out.println(\u0026quot;delete file: \u0026quot; + file.toString()); Files.delete(file); return FileVisitResult.CONTINUE; } @Override public FileVisitResult postVisitDirectory(Path dir, IOException exc) throws IOException { Files.delete(dir); System.out.println(\u0026quot;delete dir: \u0026quot; + dir.toString()); return FileVisitResult.CONTINUE; } }); } catch(IOException e){ e.printStackTrace(); }  16.10 å…¶ä»–æ–¹æ³• # java.nio.file.Filesä¸­è¿˜åŒ…æ‹¬äº†å¾ˆå¤šçš„éå¸¸æœ‰ç”¨çš„æ–¹æ³•ï¼Œè¿™é‡Œæ— æ³•ä¸€ä¸€åˆ—ä¸¾å‡ºæ¥ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥æŸ¥çœ‹JavaDocè¿›è¡Œäº†è§£ã€‚\n17 NIO AsynchronousFileChannel # Java7ä¸­å¢åŠ äº†AsynchronousFileChannelï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å¼‚æ­¥åœ°è¯»å†™æ–‡ä»¶ã€‚\n17.1 åˆ›å»ºä¸€ä¸ªAsynchronousFileChannel # åˆ›å»ºå¼‚æ­¥filechannelçš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚\nPath path = Paths.get(\u0026quot;data/test.xml\u0026quot;); AsynchronousFileChannel fileChannel = AsynchronousFileChannel.open(path, StandardOpenOption.READ);  17.2 é€šè¿‡Futureå¯¹è±¡æ¥å¼‚æ­¥è¯»å–æ•°æ® # ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚\n// åˆ›å»ºä¸€ä¸ªå¼‚æ­¥filechannel AsynchronousFileChannel fileChannel = AsynchronousFileChannel.open(path, StandardOpenOption.READ); ByteBuffer buffer = ByteBuffer.allocate(1024); long position = 0; // é¦–å…ˆé€šè¿‡å¼‚æ­¥filechannelè·å–ä¸€ä¸ªFutureå¯¹è±¡å¤‡ç”¨ Future\u0026lt;Integer\u0026gt; operation = fileChannel.read(buffer, position); // ç­‰æ•°æ®è¯»å–å®Œæˆ(é˜»å¡åœ¨è¿™é‡Œçš„è°ƒç”¨ç‚¹ï¼Œä½†æ˜¯LWPè¿›ç¨‹ä¸ä¼šé˜»å¡) while(!operation.isDone()); buffer.flip(); byte[] data = new byte[buffer.limit()]; buffer.get(data); System.out.println(new String(data)); buffer.clear();  17.3 å¼‚æ­¥æ•°æ®è¯»å®Œæˆåæ‰§è¡ŒCompletionHandler # ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚\nfileChannel.read(buffer, position, buffer, new CompletionHandler\u0026lt;Integer, ByteBuffer\u0026gt;() { // æ•°æ®è¯»å–å®Œæˆåä¼šæ‰§è¡Œè¿™ä¸ªå›è°ƒå‡½æ•° @Override public void completed(Integer result, ByteBuffer attachment) { System.out.println(\u0026quot;result = \u0026quot; + result); attachment.flip(); byte[] data = new byte[attachment.limit()]; attachment.get(data); System.out.println(new String(data)); attachment.clear(); } @Override public void failed(Throwable exc, ByteBuffer attachment) { } });  17.4 é€šè¿‡Futureå¯¹è±¡æ¥å¼‚æ­¥å†™å…¥æ•°æ® # ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚\nPath path = Paths.get(\u0026quot;data/test-write.txt\u0026quot;); // åˆ›å»ºå¼‚æ­¥filechannel AsynchronousFileChannel fileChannel = AsynchronousFileChannel.open(path, StandardOpenOption.WRITE); ByteBuffer buffer = ByteBuffer.allocate(1024); long position = 0; buffer.put(\u0026quot;test data\u0026quot;.getBytes()); buffer.flip(); // è·å¾—Futureå¯¹è±¡å¤‡ç”¨ Future\u0026lt;Integer\u0026gt; operation = fileChannel.write(buffer, position); buffer.clear(); // é˜»å¡åœ¨è°ƒç”¨ç‚¹è€Œéé˜»å¡çº¿ç¨‹ï¼ˆæˆ–LWPè¿›ç¨‹ï¼‰ while(!operation.isDone()); System.out.println(\u0026quot;Write done\u0026quot;);  17.5 å¼‚æ­¥å†™å…¥æ•°æ®å®Œæˆåæ‰§è¡ŒCompletionHandler # ç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚\nPath path = Paths.get(\u0026quot;data/test-write.txt\u0026quot;); if(!Files.exists(path)){ Files.createFile(path); } // åˆ›å»ºä¸€ä¸ªå¼‚æ­¥filechannel AsynchronousFileChannel fileChannel = AsynchronousFileChannel.open(path, StandardOpenOption.WRITE); ByteBuffer buffer = ByteBuffer.allocate(1024); long position = 0; buffer.put(\u0026quot;test data\u0026quot;.getBytes()); buffer.flip(); fileChannel.write(buffer, position, buffer, new CompletionHandler\u0026lt;Integer, ByteBuffer\u0026gt;() { // æ•°æ®å†™å…¥å®Œæˆåæ‰§è¡Œè¿™é‡Œçš„å›è°ƒå‡½æ•° @Override public void completed(Integer result, ByteBuffer attachment) { System.out.println(\u0026quot;bytes written: \u0026quot; + result); } // æ•°æ®å†™å…¥å¤±è´¥åæ‰§è¡Œè¿™é‡Œçš„å›è°ƒå‡½æ•° @Override public void failed(Throwable exc, ByteBuffer attachment) { System.out.println(\u0026quot;Write failed\u0026quot;); exc.printStackTrace(); } });  å‚è€ƒå†…å®¹ # 1 http://tutorials.jenkov.com/java-nio/index.html\n2 https://github.com/jjenkov/java-nio-server\n"}),a.add({id:377,href:"/tags/nio/",title:"nio",description:"",content:""}),a.add({id:378,href:"/tags/ant/",title:"ant",description:"",content:""}),a.add({id:379,href:"/blog/2017-04-01-%E5%AD%A6%E4%B9%A0apache-ant/",title:"å­¦ä¹ Apache Ant",description:"Apache Antæ˜¯Javaå·¥ç¨‹ä¸­æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªä¾èµ–ç®¡ç†ã€æ„å»ºå·¥å…·ï¼Œæœ¬æ–‡æ€»ç»“äº†Antç›¸å…³çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚",content:"Apache Antæ˜¯ç”±Apacheå¼€å‘çš„åŸºäºJavaçš„æ„å»ºå·¥å…·ï¼Œæœ¬æ–‡å¯¹tutorialspointä¸Šé¢çš„Apache Antæ•™ç¨‹è¿›è¡Œç®€è¦æ€»ç»“ã€‚\n1 ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·ä¸€ä¸ªæ„å»ºå·¥å…·ï¼Ÿ # Antæ˜¯Another Neat Toolçš„ç¼©å†™å½¢å¼ï¼Œä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·ä¸€ä¸ªå·¥å…·å‘¢ï¼Ÿè·Ÿå®ƒçš„åå­—ä¸€æ ·ï¼Œå°±æ˜¯å¸Œæœ›æˆ‘ä»¬å¼€å‘äººå‘˜çš„å·¥ä½œèƒ½å¤Ÿæ›´åŠ neatï¼\nå¼€å‘äººå‘˜æœ‰äº›çç¢çš„ã€é‡å¤æ€§çš„å·¥ä½œï¼ŒåŒ…æ‹¬ï¼šç¼–è¯‘ä»£ç ã€æ‰“åŒ…å¯æ‰§è¡Œç¨‹åºã€éƒ¨ç½²ç¨‹åºåˆ°æµ‹è¯•æœåŠ¡å™¨ã€æµ‹è¯•æ”¹å˜ã€æ‹·è´ä»£ç åˆ°ä¸åŒçš„åœ°æ–¹ã€‚Antå¯ä»¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨åŒ–ä¸Šé¢åˆ—ä¸¾çš„è¿™å‡ ä¸ªæ­¥éª¤ï¼Œç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œã€‚\nAntæ˜¯tomcatçš„ä½œè€…å¼€å‘å‡ºæ¥çš„ï¼Œæœ€åˆé€‚ç”¨äºæ„å»ºtomcatçš„ï¼Œå¹¶ä¸”ä½œä¸ºtomcatçš„ä¸€éƒ¨åˆ†ï¼Œä¹‹æ‰€ä»¥å¼€å‘å®ƒæ˜¯ä¸ºäº†å¼¥è¡¥å½“åˆApache Makeå·¥å…·ï¼ˆæ²¡æœ‰åœ¨apacheé¡¹ç›®åˆ—è¡¨ä¸­æœç´¢åˆ°è¯¥é¡¹ç›®ï¼‰çš„ä¸è¶³ä¹‹å¤„ï¼Œ2000å¹´çš„æ—¶å€™Antä»tomcaté¡¹ç›®ä¸­ç‹¬ç«‹å‡ºæ¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„é¡¹ç›®å¼€å‘ã€‚\nè‡³äºApache Antçš„ä¼˜åŠ¿å…·ä½“åœ¨å“ªï¼Œè¿™ä¸ªæˆ‘ä»¬æœ€ååœ¨ç»™å‡ºæ¥ï¼Œç›®çš„æ˜¯è®©å¤§å®¶ç»“åˆè‡ªèº«å·¥ä½œç»å†ï¼Œæ ¹æ®Apache Antçš„åŠŸèƒ½è‡ªå·±ä¸»åŠ¨å»å‘ç°å®ƒçš„ä¼˜åŠ¿ã€‚\n2 Ant build.xml # Antçš„æ„å»ºè„šæœ¬é»˜è®¤æ˜¯build.xmlï¼Œä¹Ÿå¯ä»¥ç”¨å…¶ä»–çš„æ–‡ä»¶åã€‚build.xmlé‡Œé¢é€šå¸¸åŒ…æ‹¬tag ï¼Œè¿™é‡ŒnameæŒ‡å®šäº†å·¥ç¨‹çš„åå­—ï¼Œdefaultæ˜¯é»˜è®¤åå­—ï¼ŒbasediræŒ‡å®šäº†å·¥ç¨‹çš„æ ¹ç›®å½•ã€‚å¦å¤–è¿˜åŒ…æ‹¬å¤šä¸ªtag ï¼Œå…¶ä¸­nameæŒ‡å®šäº†ç›®æ ‡åŠ¨ä½œçš„åå­—ï¼Œä¾‹å¦‚compileã€packageã€cleanç­‰ç­‰ï¼Œå®ƒä»¬ä¹‹é—´å­˜åœ¨æŸç§ä¾èµ–å…³ç³»ï¼Œå¯ä»¥é€šè¿‡dependsæŒ‡å®šã€‚ä¾‹å¦‚packageä¾èµ–cleanã€compileï¼Œå°±å¯ä»¥æŒ‡å®šdepends=\u0026ldquo;clean,package\u0026rdquo;ï¼Œæ³¨æ„ä¾èµ–å…ˆåé¡ºåºï¼Œä¸è¦å†™æˆdepends=\u0026ldquo;package,clean\u0026rdquo;ã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name=\u0026quot;Hello World Project\u0026quot; default=\u0026quot;info\u0026quot;\u0026gt; \u0026lt;target name=\u0026quot;info\u0026quot;\u0026gt; \u0026lt;echo\u0026gt;Hello World - Welcome to Apache Ant!\u0026lt;/echo\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  ç¤ºä¾‹2ï¼š\n\u0026lt;target name=\u0026quot;deploy\u0026quot; depends=\u0026quot;package\u0026quot;\u0026gt; .... \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;package\u0026quot; depends=\u0026quot;clean,compile\u0026quot;\u0026gt; .... \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;clean\u0026quot; \u0026gt; .... \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;compile\u0026quot; \u0026gt; .... \u0026lt;/target\u0026gt;  build.xmlé‡Œé¢å¯ä»¥ä½¿ç”¨anté¢„å…ˆå®šä¹‰çš„ä¸€äº›å˜é‡ï¼Œä¾‹å¦‚ï¼š\n   property desc     ant.file The full location of the build file.   ant.version The version of the Apache Ant installation.   basedir The basedir of the build, as specified in the basedir attribute of the project element.   ant.java.version The version of the JDK that is used by Ant.   ant.project.name The name of the project, as specified in the name atrribute of the project element.   ant.project.default-target The default target of the current project.   ant.project.invoked-targets Comma separated list of the targets that were invoked in the current project.   ant.core.lib The full location of the Ant jar file.   ant.home The home directory of Ant installation.   ant.library.dir The home directory for Ant library files - typically ANT_HOME/lib folder.    ç¤ºä¾‹1ï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name=\u0026quot;Hello World Project\u0026quot; default=\u0026quot;info\u0026quot;\u0026gt; \u0026lt;property name=\u0026quot;sitename\u0026quot; value=\u0026quot;www.tutorialspoint.com\u0026quot;/\u0026gt; \u0026lt;target name=\u0026quot;info\u0026quot;\u0026gt; \u0026lt;echo\u0026gt;Apache Ant version is ${ant.version} - You are at ${sitename} \u0026lt;/echo\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  è¿™æ ·antæ„å»ºè¿‡ç¨‹ä¸­ä¼šè¾“å‡ºå½“å‰antä½¿ç”¨çš„ç‰ˆæœ¬ä»¥åŠç«™ç‚¹åç§°ï¼Œå…¶ä¸­ant.versionæ˜¯antçš„é¢„å®šä¹‰å˜é‡ï¼Œsitenameæ˜¯æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å˜é‡ã€‚\n3 Ant build.properties # åƒä¸Šçº¿è¿™æ ·åœ¨build.xmlé‡Œé¢åˆ›å»ºè‡ªå®šä¹‰å˜é‡çš„æ–¹å¼ï¼Œå¦‚æœè‡ªå®šä¹‰å˜é‡å°‘çš„è¯è¿˜å¯ä»¥ï¼Œå½“é¢å¯¹ä¸€ä¸ªå¤§å‹çš„å·¥ç¨‹æœ‰å¾ˆå¤šè‡ªå®šä¹‰å˜é‡çš„æ—¶å€™ï¼Œç›´æ¥åœ¨build.xmlé‡Œé¢å®šä¹‰å˜é‡å°±å›°éš¾äº†ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªå•ç‹¬çš„å±æ€§é…ç½®æ–‡ä»¶ä¸­å¯¹éœ€è¦ç”¨åˆ°çš„è‡ªå®šä¹‰å±æ€§è¿›è¡Œé…ç½®ï¼Œç„¶ååœ¨build.xmlé‡Œé¢è¿›è¡Œå¼•ç”¨ã€‚è¿™ä¸ªé»˜è®¤çš„å±æ€§é…ç½®æ–‡ä»¶æ˜¯build.propertiesã€‚\nç¤ºä¾‹1ï¼š\nbuild.xmlï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name=\u0026quot;Hello World Project\u0026quot; default=\u0026quot;info\u0026quot;\u0026gt; \u0026lt;property file=\u0026quot;build.properties\u0026quot;/\u0026gt; \u0026lt;target name=\u0026quot;info\u0026quot;\u0026gt; \u0026lt;echo\u0026gt;Apache Ant version is ${ant.version} - You are at ${sitename} \u0026lt;/echo\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  è¿™ä¸ªæ–‡ä»¶é‡Œé¢å¼•ç”¨äº†ä¸€ä¸ªè‡ªå®šä¹‰å˜é‡ï¼Œæˆ‘ä»¬å°†å…¶å®šä¹‰åœ¨build.propertiesé‡Œé¢ã€‚\nbuild.propertiesï¼š\n# The Site Name sitename=www.tutorialspoint.com buildversion=3.3.2  4 Ant Data Types # ä¸è¦å°†è¿™é‡Œçš„æ•°æ®ç±»å‹è·Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„æ•°æ®ç±»å‹æ··ä¸ºä¸€è°ˆï¼Œè¿™é‡Œè¯´è¦æè¿°çš„Antæä¾›çš„æ•°æ®ç±»å‹ä»£è¡¨äº†Antæä¾›çš„ä¸€ç§serviceã€‚\nfilesetç±»å‹ä»£è¡¨äº†ä¸€ç³»åˆ—æ–‡ä»¶é›†åˆï¼Œé€šè¿‡å®ƒå¯ä»¥åŒ…æ‹¬æŸäº›æ–‡ä»¶æˆ–è€…æ’é™¤æŸäº›æ–‡ä»¶ï¼ŒåŒ…æ‹¬ã€æ’é™¤æ–‡ä»¶æ˜¯é€šè¿‡æ¨¡å¼åŒ¹é…çš„æ–¹å¼æ¥å®ç°ã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;fileset dir=\u0026quot;${src}\u0026quot; casesensitive=\u0026quot;yes\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.java\u0026quot;/\u0026gt; \u0026lt;exclude name=\u0026quot;**/*Stub*\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt;  è¿™ä¸ªä¾‹å­ä¸­åˆ›å»ºäº†ä¸€ä¸ªfilesetï¼Œå®ƒæŒ‡å‘äº†æºä»£ç ç›®å½•${src}ï¼Œè¿™é‡ŒåŒ¹é…æ–‡ä»¶æ¨¡å¼çš„æ—¶å€™å¤§å°å†™æ•æ„Ÿï¼Œå¹¶ä¸”åŒ…æ‹¬srcç›®å½•ä¸‹ä»¥åŠä»»æ„å­ç›®å½•ä¸‹çš„javaæ–‡ä»¶ï¼Œå¹¶æ’é™¤Stubæ–‡ä»¶ã€‚\npatternsetç±»å‹ä»£è¡¨äº†ä¸€äº›åˆ—çš„patterné›†åˆï¼Œé€šè¿‡å®ƒå¯ä»¥æŒ‡å®šä¸€äº›includeç”¨çš„patternæˆ–è€…excludeç”¨çš„patternã€‚è¿™é‡Œæˆ‘ä»¬é˜Ÿå®ä¾‹1è¿›è¡Œä¸€ä¸‹æ”¹é€ ï¼Œå³ç¤ºä¾‹2ã€‚\nç¤ºä¾‹2ï¼š\n\u0026lt;patternset id=\u0026quot;java.files.without.stubs\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;src/**/*.java\u0026quot;/\u0026gt; \u0026lt;exclude name=\u0026quot;src/**/*Stub*\u0026quot;/\u0026gt; \u0026lt;/patternset\u0026gt; \u0026lt;fileset dir=\u0026quot;${src}\u0026quot; casesensitive=\u0026quot;yes\u0026quot;\u0026gt; \u0026lt;patternset refid=\u0026quot;java.files.without.stubs\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt;  é€šè¿‡patternsetæ¥æŒ‡å®špatternæ¨¡å¼çš„æ–¹å¼æœ‰ä¸ªå¥½å¤„ï¼Œä¸€ä¸ªæ˜¯æ›´åŠ ç›´è§‚ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ä¾¿äºè¢«å¤ç”¨ã€‚å¦å¤–è¿™é‡Œçš„patternä¸­å¯ä»¥ä½¿ç”¨çš„åŒ¹é…ç¬¦å·åŒ…æ‹¬ï¼š\n   character desc     ? å¯ä»¥åŒ¹é…ä»»æ„å½“ä¸ªå­—ç¬¦   * å¯ä»¥åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ªå­—ç¬¦   ** å¯ä»¥åŒ¹é…å½“å‰ç›®å½•æˆ–è€…ä»»æ„å¤šçº§å­ç›®å½•ï¼ˆé€’å½’åœ°å“¦ï¼‰    filelistç±»å‹ä¸filesetæœ‰ç‚¹ç±»ä¼¼ä½†æ˜¯åˆæœ‰ä¸åŒã€‚ç›¸åŒç‚¹æ˜¯éƒ½æ˜¯ç”¨äºæŒ‡å®šä¸€ä¸ªæ–‡ä»¶é›†åˆï¼Œä¸åŒç‚¹æ˜¯filesetæ˜¯é€šè¿‡patternåŒ¹é…çš„æ–¹å¼æ¥å®ŒæˆåŒ…æ‹¬ã€æ’é™¤ï¼Œè€Œfilelistæ˜¯å¿…é¡»é€šè¿‡æŒ‡å®šå…·ä½“çš„æ–‡ä»¶åå­—ï¼Œä¸èƒ½ä½¿ç”¨patternè¿›è¡ŒåŒ¹é…ã€‚\nç¤ºä¾‹3ï¼š\n\u0026lt;filelist id=\u0026quot;config.files\u0026quot; dir=\u0026quot;${webapp.src.folder}\u0026quot;\u0026gt; \u0026lt;file name=\u0026quot;applicationConfig.xml\u0026quot;/\u0026gt; \u0026lt;file name=\u0026quot;faces-config.xml\u0026quot;/\u0026gt; \u0026lt;file name=\u0026quot;web.xml\u0026quot;/\u0026gt; \u0026lt;file name=\u0026quot;portlet.xml\u0026quot;/\u0026gt; \u0026lt;/filelist\u0026gt;  ä¸Šé¢è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨ï¼ŒåŒ…æ‹¬äº†æ‰€æŒ‡å®šçš„è¿™äº›æ–‡ä»¶ã€‚\nfiltersetç±»å‹å¾€å¾€ç”¨äºç­›é€‰æ»¡è¶³æŒ‡å®šæ¡ä»¶çš„æ–‡ä»¶ï¼Œä¾‹å¦‚åœ¨copyä»»åŠ¡ä¸­ä¸filesetç›¸ç»“åˆæ‹·è´æŒ‡å®šç‰ˆæœ¬çš„æ–‡ä»¶ï¼Œçœ‹ä¸‹è¿™é‡Œçš„ç¤ºä¾‹å§ã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;copy todir=\u0026quot;${output.dir}\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;${releasenotes.dir}\u0026quot; includes=\u0026quot;**/*.txt\u0026quot;/\u0026gt; \u0026lt;filterset\u0026gt; \u0026lt;filter token=\u0026quot;VERSION\u0026quot; value=\u0026quot;${current.version}\u0026quot;/\u0026gt; \u0026lt;/filterset\u0026gt; \u0026lt;/copy\u0026gt;  ä¸Šé¢è¿™ä¸ªåŠ¨ä½œæ˜¯è¦filesetä¸­æŒ‡å®šçš„å‘è¡Œç¬”è®°æ–‡ä»¶æ‹·è´åˆ°è¾“å‡ºç›®å½•${output.dir}ä¸­ï¼Œä½†æ˜¯å‘¢ï¼Œè¿™é‡Œæ‹·è´çš„æ—¶å€™åªæ‹·è´ç‰¹å®šç‰ˆæœ¬çš„å‘è¡Œç¬”è®°ï¼Œåªæœ‰ä¸filterä¸­åŒ¹é…çš„ç‰ˆæœ¬æ‰ä¼šè¢«æ‹·è´ã€‚\npathæ•°æ®ç±»å‹ç”¨äºæŒ‡å®šclasspathï¼Œå®ƒæœ‰ä¸ªå¥½å¤„å°±æ˜¯å¯ä»¥å¯¹å¤šä¸ªå¯èƒ½çš„classpath entriesé€šè¿‡å…·ä½“çš„ç³»ç»ŸæŒ‡å®šçš„åˆ†éš”ç¬¦è¿›è¡Œè¿æ¥ï¼Œä¾‹å¦‚åœ¨windowsä¸‹é¢é€šè¿‡åˆ†å·è¿›è¡Œè¿æ¥ï¼Œä½†æ˜¯åœ¨linuxä¸‹é¢é€šè¿‡å†’å·è¿›è¡Œè¿æ¥ã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;path id=\u0026quot;build.classpath.jar\u0026quot;\u0026gt; \u0026lt;pathelement path=\u0026quot;${env.J2EE_HOME}/${j2ee.jar}\u0026quot;/\u0026gt; \u0026lt;fileset dir=\u0026quot;lib\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.jar\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/path\u0026gt;  ä¸Šé¢è¿™ä¸ªç¤ºä¾‹å°±æ˜¯å°†${J2EE_HOME}/${j2ee.jar}ä¸­çš„æ‰€æœ‰*.jaréƒ½çœ‹åšæ˜¯ä¸€ä¸ªclasspath entryï¼Œç„¶åç”¨ç³»ç»Ÿå¯¹åº”çš„classpathåˆ†éš”ç¬¦è¿›è¡Œè¿æ¥ï¼Œæœ€ç»ˆæ„æˆä¸€ä¸ªå®Œæ•´çš„classpathã€‚\n5 Antçš„ä¸€ä¸ªç®€å•æ„å»ºç¤ºä¾‹ # ä¸‹é¢çœ‹ä¸€ä¸ªAntæ„å»ºçš„å®Œæ•´ç¤ºä¾‹ï¼Œé¦–å…ˆè¦åˆ›å»ºä¸€ä¸ªå·¥ç¨‹ï¼Œå·¥ç¨‹ç»“æ„å¦‚ä¸‹ï¼š\n+---db // æ•°æ®åº“è„šæœ¬ç›®å½• +---src // æºä»£ç ç›®å½• . +---faxapp . +---dao . +---entity . +---util . +---web +---war // èµ„æºç›®å½• +---images // - å›¾ç‰‡ +---js // - js +---META-INF // - å…¶ä»– +---styles // - cssæ–‡ä»¶ +---WEB-INF +---classes // - ç¼–è¯‘è¾“å‡ºclassesæ–‡ä»¶ +---jsp // - ç¼–å†™çš„jspæ–‡ä»¶ +---lib // - åº”ç”¨çš„jaråŒ…  å¯¹åº”çš„build.xmlæ–‡ä»¶å¦‚ä¸‹ï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name=\u0026quot;fax\u0026quot; basedir=\u0026quot;.\u0026quot; default=\u0026quot;build\u0026quot;\u0026gt; \u0026lt;property name=\u0026quot;src.dir\u0026quot; value=\u0026quot;src\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;web.dir\u0026quot; value=\u0026quot;war\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;build.dir\u0026quot; value=\u0026quot;${web.dir}/WEB-INF/classes\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;name\u0026quot; value=\u0026quot;fax\u0026quot;/\u0026gt; \u0026lt;path id=\u0026quot;master-classpath\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;${web.dir}/WEB-INF/lib\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;*.jar\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;pathelement path=\u0026quot;${build.dir}\u0026quot;/\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;target name=\u0026quot;build\u0026quot; description=\u0026quot;Compile source tree java files\u0026quot;\u0026gt; \u0026lt;mkdir dir=\u0026quot;${build.dir}\u0026quot;/\u0026gt; \u0026lt;javac destdir=\u0026quot;${build.dir}\u0026quot; source=\u0026quot;1.5\u0026quot; target=\u0026quot;1.5\u0026quot;\u0026gt; \u0026lt;src path=\u0026quot;${src.dir}\u0026quot;/\u0026gt; \u0026lt;classpath refid=\u0026quot;master-classpath\u0026quot;/\u0026gt; \u0026lt;/javac\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;clean\u0026quot; description=\u0026quot;Clean output directories\u0026quot;\u0026gt; \u0026lt;delete\u0026gt; \u0026lt;fileset dir=\u0026quot;${build.dir}\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.class\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/delete\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  å¯¹äºä¸Šé¢build.xmlä¸­ç”¨åˆ°çš„è‡ªå®šä¹‰å±æ€§ï¼Œè¿˜éœ€è¦åˆ›å»ºå¯¹åº”çš„å±æ€§æ–‡ä»¶build.propertiesï¼š\n\u0026lt;property name=\u0026quot;src.dir\u0026quot; value=\u0026quot;src\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;web.dir\u0026quot; value=\u0026quot;war\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;build.dir\u0026quot; value=\u0026quot;${web.dir}/WEB-INF/classes\u0026quot;/\u0026gt;  6 Antæ„å»ºæ–‡æ¡£ # Antå¯ä»¥ä¸ºå·¥ç¨‹ç”Ÿæˆæ–‡æ¡£ï¼Œè¿™ä¸ªæ˜¯åˆ©ç”¨javadocå‘½ä»¤è¡Œå·¥å…·æ¥å¯¹æŸäº›åŒ…æŸäº›ç±»æŸäº›è®¿é—®ç±»å‹ä¿®é¥°ç¬¦å¯¹åº”çš„æˆå‘˜æˆ–è€…æ–¹æ³•æ ¹æ®æºä»£ç ä¸­æ·»åŠ çš„javadocæ³¨é‡Šæ¥ç”Ÿæˆé¡¹ç›®APIæ–‡æ¡£ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;target name = \u0026quot;generate-javadoc\u0026quot;\u0026gt; \u0026lt;javadoc packagenames=\u0026quot;faxapp.*\u0026quot; sourcepath=\u0026quot;${src.dir}\u0026quot; destdir = \u0026quot;doc\u0026quot; version = \u0026quot;true\u0026quot; windowtitle = \u0026quot;Fax Application\u0026quot;\u0026gt; \u0026lt;doctitle\u0026gt;\u0026lt;![CDATA[= Fax Application =]]\u0026gt;\u0026lt;/doctitle\u0026gt; \u0026lt;bottom\u0026gt; \u0026lt;![CDATA[Copyright Â© 2011. All Rights Reserved.]]\u0026gt; \u0026lt;/bottom\u0026gt; \u0026lt;group title = \u0026quot;util packages\u0026quot; packages = \u0026quot;faxapp.util.*\u0026quot;/\u0026gt; \u0026lt;group title = \u0026quot;web packages\u0026quot; packages = \u0026quot;faxapp.web.*\u0026quot;/\u0026gt; \u0026lt;group title = \u0026quot;data packages\u0026quot; packages = \u0026quot;faxapp.entity.*:faxapp.dao.*\u0026quot;/\u0026gt; \u0026lt;/javadoc\u0026gt; \u0026lt;echo message = \u0026quot;java doc has been generated!\u0026quot; /\u0026gt; \u0026lt;/target\u0026gt;  7 Antæ„å»ºjaråŒ… # Antå°†classesè¾¾æˆjaråŒ…ç¤ºä¾‹ï¼Œä¾‹å¦‚å°†faxapp/utilä¸‹é¢çš„é™¤Test.classä¹‹å¤–çš„æ‰€æœ‰æ–‡ä»¶è¾¾æˆä¸€ä¸ªjaråŒ…${web.dir}/lib/util.jarã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;jar destfile = \u0026quot;${web.dir}/lib/util.jar\u0026quot; basedir = \u0026quot;${build.dir}/classes\u0026quot; includes = \u0026quot;faxapp/util/**\u0026quot; excludes = \u0026quot;**/Test.class\u0026quot; /\u0026gt;  å¦‚æœæ˜¯å¸Œæœ›å°†util.jaræ‰“åŒ…æˆä¸€ä¸ªå¯ä»¥æ‰§è¡Œçš„jaræ–‡ä»¶çš„è¯ï¼Œéœ€è¦ä¸ºå…¶æŒ‡å®šmain-classï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡æ·»åŠ manifestæ¥å®Œæˆã€‚\nç¤ºä¾‹2ï¼š\n\u0026lt;jar destfile = \u0026quot;${web.dir}/lib/util.jar\u0026quot; basedir = \u0026quot;${build.dir}/classes\u0026quot; includes = \u0026quot;faxapp/util/**\u0026quot; excludes = \u0026quot;**/Test.class\u0026quot;\u0026gt; \u0026lt;manifest\u0026gt; \u0026lt;attribute name = \u0026quot;Main-Class\u0026quot; value = \u0026quot;com.tutorialspoint.util.FaxUtil\u0026quot;/\u0026gt; \u0026lt;/manifest\u0026gt; \u0026lt;/jar\u0026gt;  æœ€åå‘¢ï¼Œå°†ä¸Šè¿°jarç¿»åˆ°ä¸€ä¸ªtargeté‡Œé¢ï¼š\n\u0026lt;target name=\u0026quot;build-jar\u0026quot;\u0026gt; \u0026lt;jar destfile=\u0026quot;${web.dir}/lib/util.jar\u0026quot; basedir=\u0026quot;${build.dir}/classes\u0026quot; includes=\u0026quot;faxapp/util/**\u0026quot; excludes=\u0026quot;**/Test.class\u0026quot;\u0026gt; \u0026lt;manifest\u0026gt; \u0026lt;attribute name=\u0026quot;Main-Class\u0026quot; value=\u0026quot;com.tutorialspoint.util.FaxUtil\u0026quot;/\u0026gt; \u0026lt;/manifest\u0026gt; \u0026lt;/jar\u0026gt; \u0026lt;/target\u0026gt;  8 Antæ„å»ºwaråŒ… # é™¤äº†ä¸Šé¢æåˆ°çš„æ„å»ºjaråŒ…ä¹‹å¤–ï¼ŒAntä¹Ÿå¯ä»¥ç”¨æ¥æ„å»ºwaråŒ…ï¼Œæˆ‘ä»¬è¿™é‡Œåªç»™å‡ºä¸€ä¸ªè¯¦ç»†çš„waråŒ…æ„å»ºé…ç½®æ–‡ä»¶ï¼Œä¸å†è¯¦ç»†å±•å¼€ã€‚\nç¤ºä¾‹1ï¼š\n\u0026lt;target name=\u0026quot;build-war\u0026quot;\u0026gt; \u0026lt;war destfile=\u0026quot;fax.war\u0026quot; webxml=\u0026quot;${web.dir}/web.xml\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;${web.dir}/WebContent\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.*\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;lib dir=\u0026quot;thirdpartyjars\u0026quot;\u0026gt; \u0026lt;exclude name=\u0026quot;portlet.jar\u0026quot;/\u0026gt; \u0026lt;/lib\u0026gt; \u0026lt;classes dir=\u0026quot;${build.dir}/web\u0026quot;/\u0026gt; \u0026lt;/war\u0026gt; \u0026lt;/target\u0026gt;  9 Antçš„ä¸€ä¸ªå®Œæ•´build.xmlé…ç½® # è¿™é‡Œç»™å‡ºäº†ä¸€ä¸ªç»¼åˆé…ç½®ç¤ºä¾‹ï¼Œå¯¹å‰é¢è¯´æè¿°çš„å†…å®¹è¿›è¡Œäº†ä¸€ä¸‹ç»¼åˆã€‚\n\u0026lt;?xml version = \u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name = \u0026quot;fax\u0026quot; basedir = \u0026quot;.\u0026quot; default = \u0026quot;usage\u0026quot;\u0026gt; \u0026lt;property file = \u0026quot;build.properties\u0026quot;/\u0026gt; \u0026lt;property name = \u0026quot;src.dir\u0026quot; value = \u0026quot;src\u0026quot;/\u0026gt; \u0026lt;property name = \u0026quot;web.dir\u0026quot; value = \u0026quot;war\u0026quot;/\u0026gt; \u0026lt;property name = \u0026quot;javadoc.dir\u0026quot; value = \u0026quot;doc\u0026quot;/\u0026gt; \u0026lt;property name = \u0026quot;build.dir\u0026quot; value = \u0026quot;${web.dir}/WEB-INF/classes\u0026quot;/\u0026gt; \u0026lt;property name = \u0026quot;name\u0026quot; value = \u0026quot;fax\u0026quot;/\u0026gt; \u0026lt;path id = \u0026quot;master-classpath\u0026quot;\u0026gt; \u0026lt;fileset dir = \u0026quot;${web.dir}/WEB-INF/lib\u0026quot;\u0026gt; \u0026lt;include name = \u0026quot;*.jar\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;pathelement path = \u0026quot;${build.dir}\u0026quot;/\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;target name = \u0026quot;javadoc\u0026quot;\u0026gt; \u0026lt;javadoc packagenames = \u0026quot;faxapp.*\u0026quot; sourcepath = \u0026quot;${src.dir}\u0026quot; destdir = \u0026quot;doc\u0026quot; version = \u0026quot;true\u0026quot; windowtitle = \u0026quot;Fax Application\u0026quot;\u0026gt; \u0026lt;doctitle\u0026gt;\u0026lt;![CDATA[\u0026lt;h1\u0026gt; = Fax Application = \u0026lt;/h1\u0026gt;]]\u0026gt; \u0026lt;/doctitle\u0026gt; \u0026lt;bottom\u0026gt;\u0026lt;![CDATA[Copyright Â© 2011. All Rights Reserved.]]\u0026gt; \u0026lt;/bottom\u0026gt; \u0026lt;group title = \u0026quot;util packages\u0026quot; packages = \u0026quot;faxapp.util.*\u0026quot;/\u0026gt; \u0026lt;group title = \u0026quot;web packages\u0026quot; packages = \u0026quot;faxapp.web.*\u0026quot;/\u0026gt; \u0026lt;group title = \u0026quot;data packages\u0026quot; packages = \u0026quot;faxapp.entity.*:faxapp.dao.*\u0026quot;/\u0026gt; \u0026lt;/javadoc\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name = \u0026quot;usage\u0026quot;\u0026gt; \u0026lt;echo message = \u0026quot;\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;${name} build file\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;-----------------------------------\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;Available targets are:\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;deploy --\u0026gt; Deploy application as directory\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;deploywar --\u0026gt; Deploy application as a WAR file\u0026quot;/\u0026gt; \u0026lt;echo message = \u0026quot;\u0026quot;/\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name = \u0026quot;build\u0026quot; description = \u0026quot;Compile main source tree java files\u0026quot;\u0026gt; \u0026lt;mkdir dir = \u0026quot;${build.dir}\u0026quot;/\u0026gt; \u0026lt;javac destdir = \u0026quot;${build.dir}\u0026quot; source = \u0026quot;1.5\u0026quot; target = \u0026quot;1.5\u0026quot; debug = \u0026quot;true\u0026quot; deprecation = \u0026quot;false\u0026quot; optimize = \u0026quot;false\u0026quot; failonerror = \u0026quot;true\u0026quot;\u0026gt; \u0026lt;src path = \u0026quot;${src.dir}\u0026quot;/\u0026gt; \u0026lt;classpath refid = \u0026quot;master-classpath\u0026quot;/\u0026gt; \u0026lt;/javac\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name = \u0026quot;deploy\u0026quot; depends = \u0026quot;build\u0026quot; description = \u0026quot;Deploy application\u0026quot;\u0026gt; \u0026lt;copy todir = \u0026quot;${deploy.path}/${name}\u0026quot; preservelastmodified = \u0026quot;true\u0026quot;\u0026gt; \u0026lt;fileset dir = \u0026quot;${web.dir}\u0026quot;\u0026gt; \u0026lt;include name = \u0026quot;**/*.*\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/copy\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name = \u0026quot;deploywar\u0026quot; depends = \u0026quot;build\u0026quot; description = \u0026quot;Deploy application as a WAR file\u0026quot;\u0026gt; \u0026lt;war destfile = \u0026quot;${name}.war\u0026quot; webxml = \u0026quot;${web.dir}/WEB-INF/web.xml\u0026quot;\u0026gt; \u0026lt;fileset dir = \u0026quot;${web.dir}\u0026quot;\u0026gt; \u0026lt;include name = \u0026quot;**/*.*\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/war\u0026gt; \u0026lt;copy todir = \u0026quot;${deploy.path}\u0026quot; preservelastmodified = \u0026quot;true\u0026quot;\u0026gt; \u0026lt;fileset dir = \u0026quot;.\u0026quot;\u0026gt; \u0026lt;include name = \u0026quot;*.war\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/copy\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name = \u0026quot;clean\u0026quot; description = \u0026quot;Clean output directories\u0026quot;\u0026gt; \u0026lt;delete\u0026gt; \u0026lt;fileset dir = \u0026quot;${build.dir}\u0026quot;\u0026gt; \u0026lt;include name = \u0026quot;**/*.class\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/delete\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  10 Antçš„ä¸€ä¸ªæ›´å®Œæ•´é…ç½®ç¤ºä¾‹ # è¿™é‡Œé’ˆå¯¹waråŒ…ä¸tomcatçš„ç»“åˆç»™å‡ºä¸€ä¸ªé…ç½®ç¤ºä¾‹ã€‚\nbuild.propertiesï¼š\n# Ant properties for building the springapp appserver.home=c:\\\\install\\\\apache-tomcat-7.0.19 # for Tomcat 5 use $appserver.home}/server/lib # for Tomcat 6 use $appserver.home}/lib appserver.lib=${appserver.home}/lib deploy.path=${appserver.home}/webapps tomcat.manager.url=http://www.tutorialspoint.com:8080/manager tomcat.manager.username=tutorialspoint tomcat.manager.password=secret  build.xml:\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name=\u0026quot;fax\u0026quot; basedir=\u0026quot;.\u0026quot; default=\u0026quot;usage\u0026quot;\u0026gt; \u0026lt;property file=\u0026quot;build.properties\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;src.dir\u0026quot; value=\u0026quot;src\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;web.dir\u0026quot; value=\u0026quot;war\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;javadoc.dir\u0026quot; value=\u0026quot;doc\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;build.dir\u0026quot; value=\u0026quot;${web.dir}/WEB-INF/classes\u0026quot;/\u0026gt; \u0026lt;property name=\u0026quot;name\u0026quot; value=\u0026quot;fax\u0026quot;/\u0026gt; \u0026lt;path id=\u0026quot;master-classpath\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;${web.dir}/WEB-INF/lib\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;*.jar\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;pathelement path=\u0026quot;${build.dir}\u0026quot;/\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;target name=\u0026quot;javadoc\u0026quot;\u0026gt; \u0026lt;javadoc packagenames=\u0026quot;faxapp.*\u0026quot; sourcepath=\u0026quot;${src.dir}\u0026quot; destdir=\u0026quot;doc\u0026quot; version=\u0026quot;true\u0026quot; windowtitle=\u0026quot;Fax Application\u0026quot;\u0026gt; \u0026lt;doctitle\u0026gt;\u0026lt;![CDATA[\u0026lt;h1\u0026gt;= Fax Application = \u0026lt;/h1\u0026gt;]]\u0026gt;\u0026lt;/doctitle\u0026gt; \u0026lt;bottom\u0026gt;\u0026lt;![CDATA[Copyright Â© 2011. All Rights Reserved.]]\u0026gt;\u0026lt;/bottom\u0026gt; \u0026lt;group title=\u0026quot;util packages\u0026quot; packages=\u0026quot;faxapp.util.*\u0026quot;/\u0026gt; \u0026lt;group title=\u0026quot;web packages\u0026quot; packages=\u0026quot;faxapp.web.*\u0026quot;/\u0026gt; \u0026lt;group title=\u0026quot;data packages\u0026quot; packages=\u0026quot;faxapp.entity.*:faxapp.dao.*\u0026quot;/\u0026gt; \u0026lt;/javadoc\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;usage\u0026quot;\u0026gt; \u0026lt;echo message=\u0026quot;\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;${name} build file\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;-----------------------------------\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;Available targets are:\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;deploy --\u0026gt; Deploy application as directory\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;deploywar --\u0026gt; Deploy application as a WAR file\u0026quot;/\u0026gt; \u0026lt;echo message=\u0026quot;\u0026quot;/\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;build\u0026quot; description=\u0026quot;Compile main source tree java files\u0026quot;\u0026gt; \u0026lt;mkdir dir=\u0026quot;${build.dir}\u0026quot;/\u0026gt; \u0026lt;javac destdir=\u0026quot;${build.dir}\u0026quot; source=\u0026quot;1.5\u0026quot; target=\u0026quot;1.5\u0026quot; debug=\u0026quot;true\u0026quot; deprecation=\u0026quot;false\u0026quot; optimize=\u0026quot;false\u0026quot; failonerror=\u0026quot;true\u0026quot;\u0026gt; \u0026lt;src path=\u0026quot;${src.dir}\u0026quot;/\u0026gt; \u0026lt;classpath refid=\u0026quot;master-classpath\u0026quot;/\u0026gt; \u0026lt;/javac\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;deploy\u0026quot; depends=\u0026quot;build\u0026quot; description=\u0026quot;Deploy application\u0026quot;\u0026gt; \u0026lt;copy todir=\u0026quot;${deploy.path}/${name}\u0026quot; preservelastmodified=\u0026quot;true\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;${web.dir}\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.*\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/copy\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;deploywar\u0026quot; depends=\u0026quot;build\u0026quot; description=\u0026quot;Deploy application as a WAR file\u0026quot;\u0026gt; \u0026lt;war destfile=\u0026quot;${name}.war\u0026quot; webxml=\u0026quot;${web.dir}/WEB-INF/web.xml\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;${web.dir}\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.*\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/war\u0026gt; \u0026lt;copy todir=\u0026quot;${deploy.path}\u0026quot; preservelastmodified=\u0026quot;true\u0026quot;\u0026gt; \u0026lt;fileset dir=\u0026quot;.\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;*.war\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/copy\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;target name=\u0026quot;clean\u0026quot; description=\u0026quot;Clean output directories\u0026quot;\u0026gt; \u0026lt;delete\u0026gt; \u0026lt;fileset dir=\u0026quot;${build.dir}\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;**/*.class\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/delete\u0026gt; \u0026lt;/target\u0026gt;  waråŒ…ç›¸å…³çš„å®šä¹‰å·²ç»å…¨éƒ¨ç»™å‡ºäº†ï¼Œè¿™é‡Œè¿˜éœ€è¦ç»™å‡ºtomcatç›¸å…³çš„éƒ¨åˆ†å®šä¹‰ï¼Œè¿˜æ˜¯åœ¨build.xmlé‡Œé¢ã€‚\n\u0026lt;!-- ============================================================ --\u0026gt; \u0026lt;!-- Tomcat tasks --\u0026gt; \u0026lt;!-- ============================================================ --\u0026gt; \u0026lt;path id=\u0026quot;catalina-ant-classpath\u0026quot;\u0026gt; \u0026lt;!-- We need the Catalina jars for Tomcat --\u0026gt; \u0026lt;!-- * for other app servers - check the docs --\u0026gt; \u0026lt;fileset dir=\u0026quot;${appserver.lib}\u0026quot;\u0026gt; \u0026lt;include name=\u0026quot;catalina-ant.jar\u0026quot;/\u0026gt; \u0026lt;/fileset\u0026gt; \u0026lt;/path\u0026gt; \u0026lt;taskdef name=\u0026quot;install\u0026quot; classname=\u0026quot;org.apache.catalina.ant.InstallTask\u0026quot;\u0026gt; \u0026lt;classpath refid=\u0026quot;catalina-ant-classpath\u0026quot;/\u0026gt; \u0026lt;/taskdef\u0026gt; \u0026lt;taskdef name=\u0026quot;reload\u0026quot; classname=\u0026quot;org.apache.catalina.ant.ReloadTask\u0026quot;\u0026gt; \u0026lt;classpath refid=\u0026quot;catalina-ant-classpath\u0026quot;/\u0026gt; \u0026lt;/taskdef\u0026gt; \u0026lt;taskdef name=\u0026quot;list\u0026quot; classname=\u0026quot;org.apache.catalina.ant.ListTask\u0026quot;\u0026gt; \u0026lt;classpath refid=\u0026quot;catalina-ant-classpath\u0026quot;/\u0026gt; \u0026lt;/taskdef\u0026gt; \u0026lt;taskdef name=\u0026quot;start\u0026quot; classname=\u0026quot;org.apache.catalina.ant.StartTask\u0026quot;\u0026gt; \u0026lt;classpath refid=\u0026quot;catalina-ant-classpath\u0026quot;/\u0026gt; \u0026lt;/taskdef\u0026gt; \u0026lt;taskdef name=\u0026quot;stop\u0026quot; classname=\u0026quot;org.apache.catalina.ant.StopTask\u0026quot;\u0026gt; \u0026lt;classpath refid=\u0026quot;catalina-ant-classpath\u0026quot;/\u0026gt; \u0026lt;/taskdef\u0026gt; \u0026lt;target name=\u0026quot;reload\u0026quot; description=\u0026quot;Reload application in Tomcat\u0026quot;\u0026gt; \u0026lt;reload url=\u0026quot;${tomcat.manager.url}\u0026quot;username=\u0026quot;${tomcat.manager.username}\u0026quot; password=\u0026quot;${tomcat.manager.password}\u0026quot; path=\u0026quot;/${name}\u0026quot;/\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  ä¸‹é¢å¯¹tomcatç›¸å…³çš„å‡ ä¸ªtargeä»–è¿›è¡Œä¸€ä¸‹æè¿°ï¼š\n   task desc     InstallTask Installs a web application. Class Name: org.apache.catalina.ant.InstallTask   ReloadTask Reload a web application. Class Name: org.apache.catalina.ant.ReloadTask   ListTask Lists all web applications. Class Name: org.apache.catalina.ant.ListTask   StartTask Starts a web application. Class Name: org.apache.catalina.ant.StartTask   StopTask Stops a web application. Class Name: org.apache.catalina.ant.StopTask   ReloadTask Reloads a web application without stopping. Class Name: org.apache.catalina.ant.ReloadTask    11 Antæ‰§è¡Œç¨‹åº # ä¸‹é¢ç»™å‡ºä¸€ä¸ªAntä¼ é€’å‚æ•°å¹¶æ‰§è¡Œç¨‹åºçš„é…ç½®ç¤ºä¾‹ã€‚\njavaç±»ï¼š\npublic class NotifyAdministrator { public static void main(String[] args) { String email = args[0]; notifyAdministratorviaEmail(email); System.out.println(\u0026quot;Administrator \u0026quot;+email+\u0026quot; has been notified\u0026quot;); } public static void notifyAdministratorviaEmail(String email { //...... } }  build.xmlé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š\n\u0026lt;?xml version=\u0026quot;1.0\u0026quot;?\u0026gt; \u0026lt;project name=\u0026quot;sample\u0026quot; basedir=\u0026quot;.\u0026quot; default=\u0026quot;notify\u0026quot;\u0026gt; \u0026lt;target name=\u0026quot;notify\u0026quot;\u0026gt; \u0026lt;java fork=\u0026quot;true\u0026quot; failonerror=\u0026quot;yes\u0026quot; classname=\u0026quot;NotifyAdministrator\u0026quot;\u0026gt; \u0026lt;arg line=\u0026quot;admin@test.com\u0026quot;/\u0026gt; \u0026lt;/java\u0026gt; \u0026lt;/target\u0026gt; \u0026lt;/project\u0026gt;  12 æ‰©å±•Ant # Antä¸­æœ‰ä¸€äº›è‡ªå®šä¹‰çš„taskï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰taskå¹¶åœ¨targetä¸­ä½¿ç”¨ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚\njavaä»£ç ï¼š\npackage com.tutorialspoint.ant; import org.apache.tools.ant.Task; import org.apache.tools.ant.Project; import org.apache.tools.ant.BuildException; public class MyTask extends Task { String message; public void execute() throws BuildException { log(\u0026quot;Message: \u0026quot; + message, Project.MSG_INFO); } public void setMessage(String message) { this.message= message; } }  build.xmlï¼š\n\u0026lt;target name=\u0026quot;custom\u0026quot;\u0026gt; \u0026lt;taskdef name=\u0026quot;custom\u0026quot; classname=\u0026quot;com.tutorialspoint.ant.MyTask\u0026quot; /\u0026gt; \u0026lt;custom message=\u0026quot;Hello World!\u0026quot;/\u0026gt; \u0026lt;/target\u0026gt;  13 åœ¨IDEä¸­ä½¿ç”¨Ant # åœ¨IDEä¸­ä½¿ç”¨Antä¹Ÿæ˜¯ä¸€ç§ä¸é”™çš„é€‰æ‹©ï¼Œç›®å‰çš„ä¸»æµå¼€å‘å·¥å…·Eclipseå’ŒIdeaéƒ½ç»§æ‰¿äº†Antæ„å»ºæ’ä»¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µé€‰æ‹©ä½¿ç”¨ã€‚\nå‚è€ƒå†…å®¹ï¼š\n[1] TutorialsPoint: Learn Apache Ant\n"}),a.add({id:380,href:"/tags/context/",title:"context",description:"",content:""}),a.add({id:381,href:"/tags/jmp_buf/",title:"jmp_buf",description:"",content:""}),a.add({id:382,href:"/blog/2017-03-27-jmp_bufsetjmplongjmp/",title:"jmp_buf \u0026 setjmp \u0026 longjmp",description:"æœ€è¿‘åœ¨çœ‹spp \u0026 libcoæºç ï¼Œä»–ä»¬å®ç°åç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½æˆ–å¤šæˆ–å°‘å€Ÿé‰´äº†jmp_bufçš„è®¾è®¡ï¼Œç”¨ä»¥ä¿å­˜åç¨‹æ‰§è¡Œæ—¶çš„ç°åœºã€‚åç¨‹åˆ‡æ¢çš„æ—¶å€™ä¿å­˜å½“å‰åç¨‹çš„ç°åœºï¼Œç„¶åæ¢å¤å¾…è°ƒåº¦åç¨‹çš„ç°åœºã€‚ç†è§£æ˜¯å¾ˆå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯æ€»æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹æµ…å°è¾„æ­¢äº†ï¼Œäºæ˜¯å°±æŠ½ç‚¹æ—¶é—´çœ‹äº†ä¸‹jmp_bufã€setjmpã€longjmpç›¸å…³çš„ä»£ç ï¼Œå¤§ä½“ç†äº†ä¸‹æ€è·¯ã€‚",content:"æœ€è¿‘åœ¨çœ‹spp \u0026amp; libcoæºç ï¼Œä»–ä»¬å®ç°åç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½æˆ–å¤šæˆ–å°‘å€Ÿé‰´äº†jmp_bufçš„è®¾è®¡ï¼Œç”¨ä»¥ä¿å­˜åç¨‹æ‰§è¡Œæ—¶çš„ç°åœºã€‚åç¨‹åˆ‡æ¢çš„æ—¶å€™ä¿å­˜å½“å‰åç¨‹çš„ç°åœºï¼Œç„¶åæ¢å¤å¾…è°ƒåº¦åç¨‹çš„ç°åœºã€‚ç†è§£æ˜¯å¾ˆå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯æ€»æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹æµ…å°è¾„æ­¢äº†ï¼Œäºæ˜¯å°±æŠ½ç‚¹æ—¶é—´çœ‹äº†ä¸‹jmp_bufã€setjmpã€longjmpç›¸å…³çš„ä»£ç ï¼Œå¤§ä½“ç†äº†ä¸‹æ€è·¯ã€‚\nå­¦ä¹ æ•´ç†äº†ä¸€ä¸‹å…³äºjmp_buf \u0026amp; setjmp \u0026amp; longjmpçš„å†…å®¹ã€‚\nlinux 4.0å†…æ ¸ä¸­jmp_bufè¿™ä¸ªç»“æ„ä½“ç”¨äºè®°å½•ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯ä»¥ç”¨äºå‡½æ•°å†…ã€å‡½æ•°å¤–è·³è½¬ï¼Œgotoåªèƒ½å®ç°å‡½æ•°å†…è·³è½¬ã€‚å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªç»“æ„ä½“çš„å®šä¹‰å§ï¼Œi386æ¶æ„çš„å¤„ç†å™¨ä¸x86_64æ¶æ„çš„å¤„ç†å™¨ï¼Œå¯¹åº”çš„jmp_bufç»“æ„ä½“å®šä¹‰ç¨å¾®æœ‰äº›ä¸åŒï¼Œè¿™ä¸ªå¾ˆå®¹æ˜“ç†è§£ï¼Œå¯„å­˜å™¨ä½å®½ã€æ•°é‡ç­‰éƒ½æœ‰äº›ä¸åŒã€‚\ni386æ¶æ„ï¼š\n// å¤„ç†å™¨æ¶æ„ï¼ši386 // - Linux/arch/x86/um/shared/sysdep/archsetjmp_32.h struct __jmp_buf { unsigned int __ebx; // é€šç”¨æ•°æ®å¯„å­˜å™¨ä¹‹ä¸€ unsigned int __esp; // æ ˆæŒ‡é’ˆå¯„å­˜å™¨(è¿›ç¨‹æ ˆç©ºé—´ç”±é«˜åœ°å€å‘ä½åœ°å€æ–¹å‘å¢é•¿) unsigned int __ebp; // åŸºå€æŒ‡é’ˆå¯„å­˜å™¨(è®°å½•äº†å½“å‰æ ˆå¸§çš„èµ·å§‹åœ°å€(è¿›å…¥ä¸€ä¸ªå‡½æ•°åé¦–å…ˆæ‰§è¡Œçš„ä¾¿æ˜¯push %ebp; mov %esp, %ebp)) unsigned int __esi; // æºå˜å€å¯„å­˜å™¨ unsigned int __edi; // ç›®çš„ç¼–åˆ¶å¯„å­˜å™¨ unsigned int __eip; // æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨(ç¨‹åºè®¡æ•°å™¨PC=CS:IP,äºŒè€…ç»“åˆèµ·æ¥ç¡®å®šä¸‹ä¸€æ¡å¾…æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤åœ°å€) }; typedef struct __jmp_buf jmp_buf[1];  x86_64æ¶æ„ï¼š\n// å¤„ç†å™¨æ¶æ„ï¼šx86_64 // - Linux/arch/x86/um/shared/sysdep/archsetjmp_64.h struct __jmp_buf { unsigned long __rbx; // é€šç”¨æ•°æ®å¯„å­˜å™¨ä¹‹ä¸€ unsigned long __rsp; // æ ˆæŒ‡é’ˆå¯„å­˜å™¨ unsigned long __rbp; // åŸºå€æŒ‡é’ˆå¯„å­˜å™¨ unsigned long __r12; unsigned long __r13; unsigned long __r14; unsigned long __r15; unsigned long __rip; }; typedef struct __jmp_buf jmp_buf[1];  ä½†æ˜¯å‘¢ï¼Œglibcé‡Œé¢é‡æ–°å®šä¹‰äº†è¿™ä¸ªç±»å‹ï¼Œè¿™é‡Œé¢è¿˜å¯¹ä¿¡å·æ©ç è¿›è¡Œäº†è€ƒè™‘ã€‚\nstruct __jmp_buf_tag { /* NOTE: The machine-dependent definitions of `__sigsetjmp' assume that a `jmp_buf' begins with a `__jmp_buf' and that `__mask_was_saved' follows it. Do not move these members or add others before it. */ __jmp_buf __jmpbuf; /* Calling environment. */ int __mask_was_saved; /* Saved the signal mask? */ __sigset_t __saved_mask; /* Saved signal mask. */ }; typedef struct __jmp_buf_tag jmp_buf[1];  è¿™ä¸ª__jmp_buf_tagä¸»è¦å°±æ˜¯ç”¨äºè®°å½•ä¸‹å½“å‰çš„è¿›ç¨‹çš„ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ã€ä¿¡å·æ©ç ä¿¡æ¯ï¼Œä¿å­˜æ“ä½œæ˜¯é€šè¿‡setjmpæ¥å®Œæˆçš„ï¼Œè€Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­caller1-\u0026gt;\u0026hellip; -\u0026gt;caller${i}-\u0026gt; \u0026hellip; -\u0026gt;callerNä¸­å¦‚æœå¸Œæœ›è·³è½¬åˆ°åœ¨caller${i}ä¸­çš„æŸä¸ªä½ç½®æ—¶(è¯¥ä½ç½®å·²ç»é€šè¿‡__jmp_buf_tagè¿›è¡Œäº†ä¿å­˜)ï¼Œé€šè¿‡è°ƒç”¨longjmpæ¥å°†æŒ‡å®š__jmp_buf_tagå˜ä½“ä¸­ä¿å­˜çš„ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯è¿˜åŸåˆ°å¤„ç†å™¨çš„å„ä¸ªå¯„å­˜å™¨ä¸­ï¼Œå¹¶å°†è¿›ç¨‹ä¿¡å·æ©ç ä¿¡æ¯ä¹Ÿè¿›è¡Œè¿˜åŸï¼Œä¹‹åæœºå™¨ä¼šå›åˆ°caller${i}ä¸­è°ƒç”¨setjmpçš„ä¸‹ä¸€è¡Œä»£ç å¤„å¼€å§‹æ‰§è¡Œã€‚ glibcåœ¨æ­¤åŸºç¡€ä¸Šé’ˆå¯¹cå’Œc++åˆ†åˆ«å®ç°äº†setjmpå’Œlongjmpï¼Œcä¸‹åªä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œc++ä¸­é™¤æ­¤ä¹‹å¤–è¿˜ä¿å­˜ä¿¡å·æ©ç ä¿¡æ¯ï¼Œæ³¨æ„æ˜¯æœ‰åŒºåˆ«çš„ã€‚\nsetjmpï¼š\n// __BEGIN_NAMESPACE_STDæ˜¯ä¸€ä¸ªå®ï¼Œè¡¨ç¤ºnamespace std { __BEGIN_NAMESPACE_STD // STDè¿™ä¸ªå‘½åç©ºé—´å†…æ˜¯æ—¢ä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¹Ÿä¿å­˜ä¿¡å·æ©ç  typedef struct __jmp_buf_tag jmp_buf[1]; extern int _setjmp(struct __jmp_buf_tag __env[1]) __THROWNL; #define setjmp(env) _setjmp(env) __END_NAMESPACE_STD // __END_NAMESPACE_STDæ˜¯ä¸€ä¸ªå®ï¼Œè¡¨ç¤º} // cä¸‹è¿™ä¸ªä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¹¶ä¸”ä¿å­˜__savemaskæŒ‡å®šçš„ä¿¡å·æ©ç  extern int __sigsetjmp (struct __jmp_buf_tag __env[1], int __savemask) __THROWNL; // cä¸‹è¿™ä¸ªåªä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ extern int _setjmp (struct __jmp_buf_tag __env[1]) __THROWNL; // cä¸‹setjmpåªä¿å­˜ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ #define setjmp(env) _setjmp (env)`  longjmp:\ntypedef struct __jmp_buf_tag sigjmp_buf[1]; void __libc_siglongjmp (sigjmp_buf env, int val) { /* Perform any cleanups needed by the frames being unwound. */ _longjmp_unwind (env, val); if (env[0].__mask_was_saved) /* Restore the saved signal mask. */ (void) __sigprocmask (SIG_SETMASK, \u0026amp;env[0].__saved_mask, (sigset_t *) NULL); /* Call the machine-dependent function to restore machine state. */ __longjmp (env[0].__jmpbuf, val ?: 1); } // å¦‚æœæ²¡æœ‰å®šä¹‰è¿™ä¸ªå®__libc_siglongjmpåˆ™æ‰§è¡Œä¸‹é¢è¿™äº›åˆ«ååˆ›å»ºæ“ä½œ // ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå®šä¹‰è¿™ä¸ªå®å‘¢ï¼Ÿå…ˆä¸ç®¡ï¼Œä¸å½±å“æ•´ä½“çš„ç†è§£ï¼fixme!!! #ifndef __libc_siglongjmp strong_alias (__libc_siglongjmp, __libc_longjmp) libc_hidden_def (__libc_longjmp) weak_alias (__libc_siglongjmp, _longjmp) weak_alias (__libc_siglongjmp, longjmp) weak_alias (__libc_siglongjmp, siglongjmp) #endif  è¿™é‡Œå¯¹ä¸Šé¢å‡ ä¸ªç‰¹æ®Šçš„å®è¿›è¡Œä¸€ä¸‹è¯´æ˜(ä»¥weak_aliasä¸ºä¾‹ï¼Œå…¶ä»–å‡ ä¸ªç±»ä¼¼çš„å¤„ç†æ–¹å¼)ï¼š\n// weak_alias(a,b)å°±æ˜¯åˆ›å»ºä¸€ä¸ªä¸açš„åˆ«åb /* Define ALIASNAME as a weak alias for NAME. If weak aliases are not available, this defines a strong alias.*/ #define weak_alias(name, aliasname) _weak_alias (name, aliasname) #define _weak_alias(name, aliasname) \\ extern __typeof (name) aliasname __attribute__ ((weak, alias (#name)));  ç°åœ¨æ•´ä½“æµç¨‹å·²ç»å¤§ä½“æ¸…æ¥šäº†ï¼Œç°åœ¨æ¥çœ‹ä¸‹setjmpä»¥åŠlongjmpçš„å®ç°ï¼š\n setjmpå°±ä¸éœ€è¦è¯´äº†å§ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡gccæ‰©å±•çš„å†…è”æ±‡ç¼–å–å‡ºéœ€è¦çš„å¯„å­˜å™¨çš„å€¼ï¼Œç”šè‡³æ˜¯å–å‡ºå½“å‰è¿›ç¨‹çš„task_structä¸­çš„ä¿¡å·æ©ç ä¿¡æ¯ï¼Œç„¶åä¿å­˜åˆ°jmp_bufä¸­ï¼› longjmpå°±æ˜¯å°†å‚æ•°ä¸­æŒ‡å®šçš„jmp_bufå–å‡ºæ¥å¹¶è¿›è¡Œè¿˜åŸï¼Œè¿˜åŸå¤„ç†å™¨çš„ç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿˜åŸè¿›ç¨‹çš„ä¿¡å·æ©ç ä¿¡æ¯ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥è¯´ä¸€ä¸‹;  ä¸‹é¢çœ‹ä¸‹å‡ ä¸ªå…³é”®çš„å‡½æ•°ã€‚\n  ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œ_longjmp_unwindï¼Œè¿™ä¸ªæ˜¯åœ¨æ‰§è¡Œå®é™…çš„jmpä¹‹å‰å…ˆå¯¹unwindæ“ä½œæ‰€ç»è¿‡çš„ç°æœ‰æ ˆå¸§æ‰§è¡Œä¸€å®šçš„å¤„ç†åŠ¨ä½œï¼Œä¸è¿‡æˆ‘çœ‹é»˜è®¤çš„/gnu/glibc/setjmp/jmp-unwind.cä¸­æ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·è‡ªå·±hookä¸€ä¸‹ï¼Ÿä¸ºå•¥è¦å¤„ç†è¿™é‡Œçš„æ ˆå¸§å‘¢ï¼Œå¯èƒ½æœ‰å¿…è¦å¯èƒ½æ²¡å¿…è¦ï¼Œåªè¦jmpå›å»äº†ï¼Œä»æ ˆä½åœ°å€å›åˆ°äº†é«˜åœ°å€ä¹‹åï¼Œä¹‹å‰ä½åœ°å€çš„æ ˆä¹Ÿå°±å…¨éƒ¨ä½œåºŸäº†ï¼Œå› ä¸ºæ ˆåˆè¦ä»å½“å‰ä½ç½®å¼€å§‹å‘ä½åœ°å€å¢é•¿ï¼Œä¹‹å‰ç”Ÿæˆçš„ä½åœ°å€æ ˆç©ºé—´ä¼šè¢«è¦†ç›–ã€‚\n  ç¬¬äºŒä¸ªå‡½æ•°ï¼Œ_sigprocmaskï¼Œè¿™ä¸ªæ˜¯æ‰§è¡Œè¿˜åŸjmp_bufä¸­çš„ä¿¡å·æ©ç ä¿¡æ¯çš„ã€‚\n  static void __set_task_blocked(struct task_struct *tsk, const sigset_t *newset) { if (signal_pending(tsk) \u0026amp;\u0026amp; !thread_group_empty(tsk)) { sigset_t newblocked; /* A set of now blocked but previously unblocked signals. */ sigandnsets(\u0026amp;newblocked, newset, Â¤t-\u0026gt;blocked); retarget_shared_pending(tsk, \u0026amp;newblocked); } tsk-\u0026gt;blocked = *newset; recalc_sigpending(); }  æ–‡ä»¶/gnu/glibc/sysdeps/unix/sysv/linux/x86_64/sigprocmask.c\nè¿™ä¸ªæ˜¯glibcä¸­å®šä¹‰çš„ä¿¡å·æ©ç å¤„ç†å‡½æ•°ï¼Œæœ€ç»ˆä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¥å¤„ç†ï¼Œå› ä¸ºæ¯•ç«Ÿè¦ä¿®æ”¹è¿›ç¨‹pcbä¸­çš„æŸäº›çŠ¶æ€å­—æ®µï¼Œåªæœ‰å†…æ ¸æ‰å…·å¤‡æ­¤æƒé™ã€‚\n/* Get and/or change the set of blocked signals. */ int __sigprocmask (int how, const sigset_t *set, sigset_t *oset) { /* XXX The size argument hopefully will have to be changed to the real size of the user-level sigset_t. */ return INLINE_SYSCALL (rt_sigprocmask, 4, how, set, oset, _NSIG / 8); } weak_alias (__sigprocmask, sigprocmask)  å†…æ ¸ä¸­çš„ä¿¡å·æ©ç å¤„ç†å‡½æ•°ï¼ŒåŠæ ¹æ®æ“ä½œç±»å‹æ¥å†³å®šå¯¹è¿›ç¨‹ä¿¡å·æ©ç åšä½•ç§å¤„ç†ï¼Œè¿™é‡Œæ¯«æ— ç–‘é—®åº”è¯¥æ˜¯setæ“ä½œã€‚\nint sigprocmask(int how, sigset_t *set, sigset_t *oldset) { struct task_struct *tsk = current; sigset_t newset; /* Lockless, only current can change -\u0026gt;blocked, never from irq */ if (oldset) *oldset = tsk-\u0026gt;blocked; switch (how) { case SIG_BLOCK: sigorsets(\u0026amp;newset, \u0026amp;tsk-\u0026gt;blocked, set); break; case SIG_UNBLOCK: sigandnsets(\u0026amp;newset, \u0026amp;tsk-\u0026gt;blocked, set); break; case SIG_SETMASK: newset = *set; break; default: return -EINVAL; } __set_current_blocked(\u0026amp;newset); return 0; }  è·å–å½“å‰è¿›ç¨‹çš„ä»»åŠ¡ç»“æ„ä½“ï¼Œå¯¹å…¶ä¸­çš„sighandåŠ é”ç„¶åå¼€å§‹ä¿¡å·ç›¸å…³çš„è®¾ç½®æ“ä½œï¼Œä¹Ÿå°±æ˜¯å±è”½newsetä¸­æŒ‡å®šçš„ä¿¡å·ã€‚\nvoid __set_current_blocked(const sigset_t *newset) { struct task_struct *tsk = current; spin_lock_irq(\u0026amp;tsk-\u0026gt;sighand-\u0026gt;siglock); __set_task_blocked(tsk, newset); spin_unlock_irq(\u0026amp;tsk-\u0026gt;sighand-\u0026gt;siglock); }  æ›´æ–°å½“å‰è¿›ç¨‹ä»»åŠ¡ç»“æ„ä½“task_structä¸­çš„ä¿¡å·æ©ç ä¿¡æ¯ï¼Œè‡³äºæ›´æ–°çš„è¿‡ç¨‹ä¸­åšäº†ä½•ç§å¤„ç†ï¼Œè¿™é‡Œå…ˆæš‚æ—¶ä¸åšè¯¦ç»†ä»‹ç»äº†ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªå·±æŸ¥çœ‹ä¸‹æºç ã€‚\n ç¬¬ä¸‰ä¸ªå‡½æ•°æ‰§è¡Œå®é™…çš„jmpåŠ¨ä½œï¼Œä¹Ÿå°±æ˜¯è¿˜åŸç¡¬ä»¶ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š  /* Jump to the position specified by ENV, causing the setjmp call there to return VAL, or 1 if VAL is 0. void __longjmp (__jmp_buf env, int val). */ .text ENTRY(__longjmp) /* Restore registers. */ mov (JB_RSP*8)(%rdi),%R8_LP mov (JB_RBP*8)(%rdi),%R9_LP mov (JB_PC*8)(%rdi),%RDX_LP #ifdef PTR_DEMANGLE PTR_DEMANGLE (%R8_LP) PTR_DEMANGLE (%R9_LP) PTR_DEMANGLE (%RDX_LP) #ifdef __ILP32__ /* We ignored the high bits of the %rbp value because only the low bits are mangled. But we cannot presume that %rbp is being used as a pointer and truncate it, so recover the high bits. */ movl (JB_RBP*8 + 4)(%rdi), %eax shlq 2, %rax orq %rax, %r9 # endif #endif LIBC_PROBE (longjmp, 3, LP_SIZE@%RDI_LP, -4@%esi, LP_SIZE@%RDX_LP) /* We add unwind information for the target here. */ cfi_def_cfa(%rdi, 0) cfi_register(%rsp,%r8) cfi_register(%rbp,%r9) cfi_register(%rip,%rdx) cfi_offset(%rbx,JB_RBX*8) cfi_offset(%r12,JB_R12*8) cfi_offset(%r13,JB_R13*8) cfi_offset(%r14,JB_R14*8) cfi_offset(%r15,JB_R15*8) movq (JB_RBX*8)(%rdi),%rbx movq (JB_R12*8)(%rdi),%r12 movq (JB_R13*8)(%rdi),%r13 movq (JB_R14*8)(%rdi),%r14 movq (JB_R15*8)(%rdi),%r15 /* Set return value for setjmp. */ mov %esi, %eax mov %R8_LP,%RSP_LP movq %r9,%rbp LIBC_PROBE (longjmp_target, 3, LP_SIZE@%RDI_LP, -4@%eax, LP_SIZE@%RDX_LP) jmpq *%rdx END (__longjmp)  ä¸Šé¢çš„ä»£ç åœ¨æ–‡ä»¶/gnu/glibc/sysdeps/x86_64/__longjmp.Sä¸­ï¼Œé€šè¿‡.textä¸­çš„æ±‡ç¼–ä»£ç æ¥æ‰§è¡Œè¿˜åŸç¡¬ä»¶ä¸Šä¸‹æ–‡çš„æ“ä½œï¼Œä¸Šé¢çš„ä»£ç ä¸­è¿˜ç”¨åˆ°äº†ä¸¤ä¸ªå®ï¼š\n/* Define an entry point visible from C. */ #define ENTRY(name) \\ .globl C_SYMBOL_NAME(name); \\ .type C_SYMBOL_NAME(name),@function; \\ .align ALIGNARG(4); \\ C_LABEL(name) \\ cfi_startproc; \\ CALL_MCOUNT #undef END #define END(name) \\ cfi_endproc; \\ ASM_SIZE_DIRECTIVE(name)  è¿™ä¸¤ä¸ªå®å°±æ¯”è¾ƒå·§äº†ï¼ŒENTRYå…¶å®ç›´æ¥å®šä¹‰äº†ä¸€ä¸ªåœ¨cä¸­å…·æœ‰å¯è§æ€§çš„å‡½æ•°nameï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªæƒ…å¢ƒä¸‹å°±æ˜¯__longjmpï¼Œç„¶åå°±ç›´æ¥è¿½åŠ ä¸Šå‰é¢è¿˜åŸç¡¬ä»¶ä¸Šä¸‹æ–‡çš„æ±‡ç¼–ä»£ç ä½œä¸ºå‡½æ•°ä½“ï¼Œæœ€åé€šè¿‡ENDç»“æŸå‡½æ•°ä½“ã€‚\næ³¨æ„è¿™é‡Œçš„ä»£ç __longjmpå…¶å®æ˜¯ä¸ªç”¨æˆ·æ€ä¸­çš„å‡½æ•°ï¼Œå¹¶éæ˜¯å†…æ ¸æ¥å¤„ç†çš„ã€‚è¿™æ ·è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹åï¼Œä¸‹é¢å°±ä¼šè‡ªåŠ¨å›åˆ°setjmpè¯­å¥çš„ä¸‹ä¸€è¡Œè¯­å¥å¤„æ‰§è¡Œã€‚\nsetjmpã€longjmpçš„å¤§è‡´å®ç°è¿‡ç¨‹å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä»‹å¯èƒ½æœ‰äº›åœ°æ–¹æè¿°ä¸åˆ°ä½æˆ–è€…æœ‰é”™è¯¯ï¼Œä¹Ÿè¯·å¤§å®¶èƒ½ç»™æˆ‘æŒ‡å‡ºæ¥ã€‚\n"}),a.add({id:383,href:"/tags/longjmp/",title:"longjmp",description:"",content:""}),a.add({id:384,href:"/tags/setjmp/",title:"setjmp",description:"",content:""}),a.add({id:385,href:"/blog/2017-02-09-protobuf%E7%BC%96%E8%A7%A3%E7%A0%81/",title:"Protobufç¼–è§£ç ",description:"å¼€å‘è¿‡ç¨‹ä¸­å­¦ä¹ å­¦ä¹ çš„ä¸€ç‚¹protobufç¼–è§£ç çš„çŸ¥è¯†ï¼Œä»¥åŠå¯¹é‡åˆ°çš„ä¸€äº›ç¼–è§£ç ç›¸å…³é—®é¢˜çš„æ€»ç»“ã€‚",content:" img { width: 680px; padding-bottom: 1rem; }  å¼€å‘è¿‡ç¨‹ä¸­å­¦ä¹ å­¦ä¹ çš„ä¸€ç‚¹protobufç¼–è§£ç çš„çŸ¥è¯†ï¼Œä»¥åŠå¯¹é‡åˆ°çš„ä¸€äº›ç¼–è§£ç ç›¸å…³é—®é¢˜çš„æ€»ç»“ã€‚\n1.pbæ•°æ®ç±»å‹ # protobufå¯¹messageè¿›è¡Œç¼–ç æ—¶ï¼Œæ˜¯å°†messageä¸­çš„å„ä¸ªæˆå‘˜æŒ‰ç…§keyã€valueç»„åˆæˆä¸€ä¸ªå­—èŠ‚æµï¼Œè¿™é‡Œçš„keyå¹¶ä¸æ˜¯å±æ€§çš„åå­—ï¼Œè€Œæ˜¯varint(tag\u0026laquo;3 | datatype)ï¼Œå…¶ä½3ä½è¡¨ç¤ºå­—æ®µç±»å‹ï¼Œç±»å‹æè¿°è§ä¸‹å›¾ã€‚\nå½“protobufå¯¹ä¸€ä¸ªå­—èŠ‚æµè¿›è¡Œè§£ç çš„æ—¶å€™ï¼Œå¯¹äºé‚£äº›å®ƒä¸è®¤è¯†çš„å­—æ®µä¼šç›´æ¥è·³è¿‡ï¼Œå¯¹å­—èŠ‚æµåä¸²è¡ŒåŒ–æ“ä½œçš„ä»£ç ä¸»è¦æ˜¯ä¾èµ–äºå„ä¸ªMessageå­ç±»çš„MergePartialFromCodedStreamæ–¹æ³•å®ç°ï¼Œå¸¸ç”¨çš„ParseFromStringæˆ–è€…ParseFromArrayæ–¹æ³•æœ€ç»ˆéƒ½æ˜¯è°ƒç”¨è¯¥æ–¹æ³•æ¥å®Œæˆåä¸²è¡ŒåŒ–ä»»åŠ¡ã€‚MergePartialFromCodedStreamæ–¹æ³•ä¸­åŒ…æ‹¬äº†å¯¹unknown tagçš„å¤„ç†ï¼Œè¿™éƒ¨åˆ†ä»£ç éƒ½æ˜¯protocè‡ªåŠ¨æ’å…¥çš„ï¼Œæ‰€ä»¥æ¯ä¸ªMessageå­ç±»çš„å¯¹æœªçŸ¥tagçš„å¤„ç†æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„protoæ–‡ä»¶è¿›è¡Œè¯´æ˜ã€‚\næ–‡ä»¶åï¼šT.proto\npackage kn.feeds; enum FeedType { TYPE_RECORD_LIVE = 1; TYPE_RECORD_VIDEO = 2; //TYPE_RECORD_DAYMOMENT = 3; }; message Feed { optional string name = 1; optional int32 time = 2; optional FeedType type = 3; };  ä½¿ç”¨protobuf --cpp_out=. T.protoè¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆçš„T.pb.ccä¸­kn::feeds::Feed::MergePartialFromCodedStreamæ–¹æ³•çš„æºç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­å¯¹ä¸ç›¸å…³ä»£ç è¿›è¡Œäº†æŠ˜å ã€‚switch(....GetFieldNumber(tag))è·å–åˆ°äº†tagçš„ç¼–å·å¹¶è¿›è¡Œåˆ†åˆ«å¤„ç†ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªunknown tagåˆ™è¿›å…¥defaultå¤„ç†åˆ†æ”¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯æ‰§è¡ŒDO_(\u0026hellip;)å°†è¿™ä¸ªunknown tagä¿å­˜åˆ°ä¸€ä¸ªunknown_fields vectorä¸­ã€‚\næ–‡ä»¶åï¼šT.pb.ccï¼Œè§ä¸‹å›¾ï¼š\nå¦‚æœæ–°éœ€æ±‚ä¸­è¦æ±‚æ”¹é€ æ—§æœ‰çš„pbåè®®ï¼Œä¾‹å¦‚åœ¨messageä¸­æ–°è¿½åŠ äº†ä¸€äº›å­—æ®µï¼Œæ—§ä»£ç åœ¨è¿›è¡Œåä¸²è¡ŒåŒ–çš„æ—¶å€™å¹¶ä¸ä¼šè¯»å–åˆ°æ–°è¿½åŠ çš„å­—æ®µï¼Œåè®®æ”¹é€ å¯¹æ—§æœ‰æœåŠ¡æ˜¯ä¸ä¼šäº§ç”Ÿä¸è‰¯å½±å“çš„ã€‚\nå¦å¤–ï¼Œå¤§å®¶ä¸€èˆ¬ä¹ æƒ¯äºä½¿ç”¨optionalå¯¹å­—æ®µè¿›è¡Œä¿®é¥°ï¼Œè¿™é‡Œå°±optionalå­—æ®µå€¼æ˜¯å¦è®¾ç½®å¯¹æ•°æ®ä¼ è¾“çš„å½±å“ä¹Ÿè¿›è¡Œä¸€ä¸‹è¯´æ˜ï¼š\n å¯¹äºmessageä¸­å®šä¹‰çš„optionalç±»å‹çš„å­—æ®µfieldï¼ŒAç»™Bå‘æ¶ˆæ¯æ—¶ï¼Œå¦‚æœAæ²¡æœ‰æ˜¾ç¤ºè®¾ç½®fieldçš„å€¼ï¼Œé‚£ä¹ˆBæ”¶åˆ°çš„å­—èŠ‚æµé‡Œé¢ä¸ä¼šåŒ…æ‹¬fieldå­—æ®µçš„ä¿¡æ¯ï¼ŒBä¼šè‡ªåŠ¨ä½¿ç”¨protoæ–‡ä»¶ä¸­å®šä¹‰çš„è¯¥å­—æ®µçš„é»˜è®¤å€¼ã€‚ è€Œå½“Aæ˜¾ç¤ºè®¾ç½®å­—æ®µfieldçš„å€¼ä¸é»˜è®¤å€¼ç›¸åŒæ—¶ï¼Œä¼ è¾“ç»™Bçš„å­—èŠ‚æµé‡Œé¢ä¼šåŒ…æ‹¬fieldå­—æ®µçš„ä¿¡æ¯ã€‚è®¾ç½®å’Œä¸è®¾ç½®optionalå­—æ®µå¯¹äºä¸²è¡ŒåŒ–æ•°æ®çš„ç¼–ç ã€ä¼ è¾“æ˜¯ä¸åŒçš„ã€‚   PSï¼šå¯¹äºpb2è€Œè¨€ï¼Œä¸Šè¿°æè¿°æ˜¯æ­£ç¡®çš„ã€‚å¯¹äºpb3çš„æƒ…å†µï¼Œå¯¹ç¼–ç åŠç½‘ç»œä¼ è¾“æ•°æ®é‡åˆè¿›è¡Œäº†ä¼˜åŒ–ï¼Œæ‰€æœ‰çš„0å€¼éƒ½ä¸ä¼šåœ¨ç¼–ç æ—¶è¿›è¡Œç¼–ç ã€‚å¦‚æœç³»ç»Ÿä¸­æ¶‰åŠåˆ°pb2ã€pb3å…±ç”¨ï¼Œä¸”å­˜åœ¨ä½¿ç”¨pb2çš„ä»£ç ä¸­é€šè¿‡åˆ¤æ–­å­—æ®µå€¼æ˜¯å¦ä¸ºnilæ¥åšç‰¹æ®Šé€»è¾‘ï¼Œè¿™é‡Œå°±å®¹æ˜“å¼•å…¥é—®é¢˜ã€‚è€Œå¦‚æœå…¨éƒ¨æ˜¯pb3åè®®åˆ™ä¸éœ€è¦è€ƒè™‘è¿™ç§å…¼å®¹é—®é¢˜ã€‚\n 2.varint \u0026amp; zigzagç¼–è§£ç  # å‰é¢åˆ—å‡ºäº†protobufæ•°æ®ç±»å‹ç¼–ç è§„åˆ™ï¼Œå½“tagä½3ä½ä¸º0æ—¶è¡¨ç¤ºvarintç±»å‹ï¼Œå¯¹äºæœ‰ç¬¦å·ç±»å‹ã€æ— ç¬¦å·ç±»å‹å…¶å®å·®åˆ«è¿˜æ˜¯æŒºå¤§çš„ã€‚\n å¯¹äºæ— ç¬¦å·æ•´æ•°ç±»å‹æˆ‘ä»¬ä½¿ç”¨varintç¼–ç ï¼Œå¦‚æœç»™ä¸€ä¸ªæ— ç¬¦å·ç±»å‹èµ‹ä¸€ä¸ªè´Ÿå€¼ï¼Œé‚£ä¹ˆæœ€ç»ˆå¾—åˆ°çš„å€¼ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ— ç¬¦å·æ•°å€¼ï¼› å¯¹äºæœ‰ç¬¦å·æ•´æ•°ç±»å‹æˆ‘ä»¬ä½¿ç”¨zigzagç¼–ç ã€‚æ€ä¹ˆè¯´å‘¢ï¼Œæ„Ÿè§‰zigzagä¹Ÿå±äºvarintç¼–ç ï¼Œä½†æ˜¯æ¯”è¾ƒç‰¹æ®Šè€Œå·²ï¼Œä»…ç”¨æ¥å¯¹æœ‰ç¬¦å·æ•´æ•°è¿›è¡Œç¼–ç ã€‚  æ— ç¬¦å·æ•´æ•°varintç¼–è§£ç è§„åˆ™ # - æ¯ä¸ªå­—èŠ‚çš„æœ€é«˜æœ‰æ•ˆä½ï¼ˆmsbï¼‰è¡¨ç¤ºæ˜¯å¦è¿˜æœ‰å…¶ä»–å­—èŠ‚ï¼›\n- å°†å„ä¸ªå­—èŠ‚ä»åŸæ¥çš„é¡ºåºé€†åºæ’åˆ—ä¸€éï¼›\n- ä¸¢æ‰å„ä¸ªå­—èŠ‚çš„msbï¼Œå¹¶å°†å…¶è¿æ¥èµ·æ¥ï¼›\n- æŒ‰ç…§äºŒè¿›åˆ¶æ ¼å¼è§£ç æ•°æ®ï¼›\nè¿™é‡Œå…¶å®æè¿°çš„æ›´åƒæ˜¯å¦‚ä½•ç†è§£ä¸€ä¸ªvarintç¼–ç ï¼Œå±äºè§£ç ï¼Œä½†æ˜¯è¿™æ ·çœ‹äº†ä¹‹åä¹Ÿä¼šå¾ˆå®¹æ˜“ç†è§£varintç¼–ç è¿‡ç¨‹æ˜¯å¦‚ä½•è¿›è¡Œçš„ã€‚\næœ‰ç¬¦å·æ•´æ•°zigzagç¼–è§£ç è§„åˆ™ # 0è¢«ç¼–ç ä¸º0ï¼Œ-1è¢«ç¼–ç ä¸º1ï¼Œ1è¢«ç¼–ç ä¸º2ï¼Œ-2è¢«ç¼–ç ä¸º3ï¼Œ2è¢«ç¼–ç ä¸º4â€¦â€¦ä»¥æ­¤ç±»æ¨ã€‚\nä¼˜ç‚¹ï¼š\nè¿™ä¸¤ç§ç¼–ç æ–¹å¼çš„ä¼˜ç‚¹æ˜¯ç¼–è§£ç è§„åˆ™ç®€å•ï¼Œå®¹æ˜“å®ç°ï¼›å ç”¨å­—èŠ‚æ•°é‡å°‘ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“ä»£ä»·ï¼ˆç»å¯¹å€¼å°çš„æ•°å­—ä½¿ç”¨æ›´å°‘çš„å­—èŠ‚è¿›è¡Œç¼–ç ï¼Œç»å¯¹å€¼å¤§çš„æ•°å­—å¯ä»¥ä½¿ç”¨é€‚å½“å¤šçš„ç¼–ç ï¼Œè€Œå¹¶ä¸æ˜¯é™å®šä¸ºå®šé•¿çš„16ã€32ã€64ä½ï¼‰ã€‚\n3.non-varintç¼–è§£ç  # tagä½3ä½ä¸º1æ—¶è¡¨ç¤ºæ˜¯ä½¿ç”¨å›ºå®šçš„64ä½æ¥ç¼–ç ä¸€ä¸ªæ•°å­—ï¼Œè¿™é‡Œçš„æ•°å­—ç±»å‹ä»…é™äºdoubleå’Œfixed64ã€sfixed64ã€‚\n4.stringç¼–è§£ç  # stringåœ¨ç¼–ç çš„æ—¶å€™é¦–å…ˆæ˜¯ä¸€ä¸ªvarintç¼–ç çš„é•¿åº¦å€¼ï¼ˆå­—èŠ‚æ•°é‡ï¼‰ï¼Œç„¶ååé¢è·Ÿç€çš„æ˜¯å­—ç¬¦ä¸²å¯¹åº”çš„å„ä¸ªå­—èŠ‚ã€‚\nä¸‹å›¾æ˜¯ä¸€ä¸ªç¼–ç å­—ç¬¦ä¸²çš„ç¤ºä¾‹ï¼Œâ€œtestingâ€è¢«ç¼–ç æˆäº†å¦‚ä¸‹å­—èŠ‚æµã€‚\n5.åµŒå…¥å¼ç±»å‹ç¼–è§£ç  # ä¸å­—ç¬¦ä¸²ç¼–è§£ç æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œä¸€ä¸ªå¯¹è±¡Aè¢«åµŒåˆ°å¯¹è±¡Bä¸­ï¼Œä¹Ÿæ˜¯å…ˆå†™ä¸€ä¸ªvarintè¡¨ç¤ºAä¸²è¡ŒåŒ–åçš„å­—èŠ‚æµé•¿åº¦ï¼Œç„¶åå†å†™å­—èŠ‚æµã€‚\n6.optional \u0026amp; repeatedç±»å‹ç¼–è§£ç  # å¯¹äºrepeatedå…ƒç´ ç±»å‹ï¼Œproto2é‡Œé¢æ˜¯å¤škeyå­˜å‚¨çš„ï¼Œå³åˆ—è¡¨ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä½¿ç”¨çš„ç›¸åŒçš„keyï¼›åœ¨proto3é‡Œé¢ä¸æ­¤ä¸åŒï¼Œåˆ—è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ å…±ç”¨åŒä¸€ä¸ªkeyã€‚\nå…¶å®å‘¢ï¼Œproto2é‡Œé¢å¯¹äºrepeatedç±»å‹å¢åŠ äº†ä¸€ä¸ªé…ç½®é€‰é¡¹packed=trueä¹Ÿå¯ä»¥è¾¾åˆ°proto3ä¸­çš„ç¼–ç æ•ˆæœï¼Œproto2ä¸­packedå±æ€§é»˜è®¤ä¸ºfalseï¼›proto3ä¸­é»˜è®¤ä½¿ç”¨packed=trueã€‚é‚£ä¹ˆæ˜¯å¦‚ä½•å®ç°è¿™ç§packedæ•ˆæœçš„å‘¢ï¼Ÿé¦–å…ˆå†™å…¥listä¸­æ‰€æœ‰å…ƒç´ çš„ç›´æ¥æ•°é‡ï¼Œç„¶åå‘¢é€ä¸€å¯¹æ¯ä¸ªå…ƒç´ è¿›è¡Œç¼–ç ï¼Œvarintä¸­å¦‚æœmsbä¸º0è¡¨ç¤ºå½“å‰å­—èŠ‚æ˜¯å¯¹åº”å…ƒç´ çš„æœ€åä¸€ä¸ªå­—èŠ‚äº†ï¼Œä¸‹é¢çš„å­—èŠ‚å±äºä¸‹ä¸€ä¸ªå…ƒç´ ã€‚\n7.å­—æ®µé¡ºåº # å®˜æ–¹æ–‡æ¡£ä¸­çš„è¡¨è¿°æ˜¯ï¼Œå°½ç®¡åœ¨protoæ–‡ä»¶å®šä¹‰çš„æ—¶å€™å¯ä»¥ä»»æ„æŒ‡å®šå­—æ®µç¼–å·ï¼ˆä¸èƒ½é‡å¤ç¼–å·ï¼‰ï¼Œä½†è¿˜æ˜¯å»ºè®®æŒ‰é¡ºåºå¯¹å­—æ®µç¼–å·ï¼Œè¿™æœ‰åˆ©äºprotobufçš„parsersé‡‡ç”¨ä¸€äº›ä¾èµ–äºå­—æ®µæŒ‰åºç¼–å·æ—¶çš„ä¼˜åŒ–æ–¹æ³•ä»¥å¢åŠ ç¼–è§£ç é€Ÿåº¦ã€‚\næˆ‘ç¼–å†™äº†ä¸‹é¢ä¸¤ä¸ªprotoæ–‡ä»¶ï¼Œåˆ†åˆ«ä½¿ç”¨protocè¿›è¡Œå¤„ç†å¾—åˆ°è¾“å‡ºçš„å¤´æ–‡ä»¶ã€æºæ–‡ä»¶ã€‚ç¬¬ä¸€ç§å®šä¹‰æ–¹å¼ä¸æŒ‰å­—æ®µå‡ºç°é¡ºåºè¿›è¡Œç¼–å·ï¼Œè¿™ä¹ˆåšå¹¶éä¸å¯ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å®¹æ˜“å¼•å‘é”™è¯¯ï¼Œéå¸¸ä¸åˆ©äºåæœŸçš„æ‰©å±•ï¼Œå› ä¸ºä¸æŒ‰é¡ºåºå¯¹å­—æ®µç¼–å·ï¼Œå½“å­—æ®µæ•°é‡æ¯”è¾ƒå¤šå¹¶ä¸”å¸Œæœ›å¢åŠ ä¸€ä¸ªæ–°çš„å­—æ®µæ—¶å¯èƒ½éƒ½ä¸çŸ¥é“è¯¥ç”¨å“ªä¸ªæ•°å­—æ¥å¯¹å…¶ç¼–å·äº†ã€‚\nmessage man { optional int32 age = 3; // å­—æ®µä¸æŒ‰é¡ºåºç¼–å· optional int32 sex = 1; optional string name = 2; }; message man { // å­—æ®µæŒ‰é¡ºåºç¼–å· optional int32 age = 1; optional int32 sex = 2; optional string name = 3; };  protocåˆ†åˆ«å¯¹å…¶è¿›è¡Œå¤„ç†åå¾—åˆ°çš„**â€œå¤´æ–‡ä»¶â€**å¯¹æ¯”å¦‚ä¸‹ï¼Œå·¦ä¾§çš„æ˜¯â€œå­—æ®µä¸æŒ‰é¡ºåºç¼–å·â€çš„ï¼Œå³ä¾§çš„æ˜¯â€œå­—æ®µâ€æŒ‰é¡ºåºç¼–å·çš„ï¼š\nä»ä¸Šè¿°ç”Ÿæˆçš„ä»£ç æ¥çœ‹ï¼Œå­—æ®µå€¼æ˜¯å¦å·²ç»è®¾ç½®has_${field}æ–¹æ³•ä»¥åŠè®¾ç½®æœ‰å€¼set_has_${field}çš„æ–¹æ³•ï¼Œéƒ½æ˜¯ä½¿ç”¨å­—æ®µåœ¨messageä¸­å‡ºç°çš„é¡ºåºç¼–å·å¯¹ä½å›¾è¿›è¡Œä½ä¸è¿ç®—çš„ï¼Œè€Œä¸æ˜¯æŒ‰ç…§æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šçš„tagç¼–å·å»è¿›è¡Œä½æ“ä½œçš„ã€‚\n PS: å½“æ—¶æµ‹è¯•çš„æ—¶å€™åº”è¯¥æ˜¯protoc v2.5.0ï¼Œç°åœ¨protocå·²ç»åˆ°äº†v3.19.1ï¼Œå¯¹æ¯”ç”Ÿæˆçš„ä»£ç å‘ç°ï¼Œè¿™é‡Œhasbitsçš„è®¾ç½®ä¸ä¹‹å‰åˆä¸åŒäº†ï¼Œå³ä¸æ˜¯å£°æ˜é¡ºåºï¼Œä¹Ÿä¸æ˜¯tagç¼–å·ï¼Œå¯èƒ½æ˜¯é‡‡ç”¨äº†æ–°çš„è§„åˆ™ï¼Ÿè¿™é‡Œä¸ç¡®å®šï¼Œç®€å•æœç´¢äº†ä¸‹è¿™é‡Œhasbitsçš„è®¾ç½®ä¹Ÿæœ‰äº›ä¼˜åŒ–æ‰‹æ®µï¼Œå¯èƒ½æ˜¯å› ä¸ºé‡‡ç”¨è¿™äº›ä¼˜åŒ–æ‰‹æ®µå¼•èµ·çš„ã€‚\nTODO ä»¥åå†è¡¥å……hasbitsè®¾ç½®ç›¸å…³çš„å†…å®¹ã€‚\n ä¹‹ååˆå¯¹æ¯”äº†ä¸€ä¸‹ç”Ÿæˆçš„**â€œæºæ–‡ä»¶â€**çš„å·®å¼‚ï¼Œå‘ç°åœ¨ä¸²è¡ŒåŒ–messageä¿¡æ¯æ—¶ä½¿ç”¨çš„å­—æ®µå¯¹åº”çš„keyè¿˜æ˜¯æŒ‰ç…§æˆ‘ä»¬æŒ‡å®šçš„tagæ•°å€¼å»è®¾ç½®çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå·¦ä¾§æ˜¯ä¸æŒ‰åºç¼–å·æƒ…å†µä¸‹å¯¹å­—æ®µage=3è¿›è¡Œè®¾ç½®çš„æƒ…å†µï¼Œé€šè¿‡å­—ç¬¦ä¸²â€œage\\030\\003â€æˆ‘ä»¬çŸ¥é“ageå¯¹åº”çš„keyæ˜¯3ï¼›å³ä¾§æ˜¯æŒ‰åºç¼–å·æƒ…å†µä¸‹å¯¹å­—æ®µage=1è¿›è¡Œè®¾ç½®çš„æƒ…å†µï¼Œé€šè¿‡å­—ç¬¦ä¸²â€œage\\030\\001â€æˆ‘ä»¬çŸ¥é“ageå¯¹åº”çš„keyæ˜¯1ï¼ˆkeyå€¼å¯¹åº”ç€pbä¸­æŒ‡å®šçš„field tagç¼–å·ï¼‰ã€‚\nå½“ç„¶äº†åä¸²è¡ŒåŒ–çš„æ—¶å€™è‚¯å®šä¹Ÿæ˜¯æŒ‰ç…§è¿™æ ·çš„åŸåˆ™å»åšçš„ï¼Œè¿™æ ·å°±èƒ½ä¿è¯é€šä¿¡åŒæ–¹çš„æ•°æ®è§†è§’æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œè‡³äºå‰é¢hasbitsçš„é€»è¾‘éƒ½æ˜¯é€šä¿¡ä¸€æ–¹è‡ªå·±çš„äº‹æƒ…ï¼Œprotocå†…ç½®å®ç°å¦‚ä½•è°ƒæ•´å¯¹é€šä¿¡åŒæ–¹æ²¡æœ‰å½±å“ï¼Œå½±å“çš„åªæ˜¯è‡ªå·±æ ¹æ®è®¿é—®å¯¹åº”å­—æ®µçš„æ•ˆç‡é—®é¢˜ã€‚\næ€»ç»“ï¼šå°½é‡æŒ‰ç…§å­—æ®µåœ¨messageä¸­å‡ºç°é¡ºåºè¿›è¡Œç¼–å·ï¼Œå®¹æ˜“ç»´æŠ¤ã€æ‰©å±•ï¼Œåˆ«æ²¡äº‹è‡ªè®¨è‹¦åƒï¼Œå¦‚æœå­—æ®µæ•°é‡å¤šäº†åˆä¸æŒ‰åºç¼–å·ï¼Œé‚£ä¹ˆæ–°å¢ä¸€ä¸ªå­—æ®µçš„æ—¶å€™éƒ½ä¸çŸ¥é“è¯¥ç”¨å“ªä¸ªç¼–å·äº†ã€‚\nx.å…¶ä»–æ–¹é¢ # protobufçš„å…¶ä»–å†…å®¹è¿™é‡Œå°±æš‚æ—¶å…ˆä¸ä»‹ç»äº†ï¼Œæœ‰æè¿°ä¸æ¸…æˆ–è€…é”™è¯¯çš„åœ°æ–¹è¿˜è¯·æŒ‡æ­£ã€‚protobufè¿™ç§è‡ªæè¿°æ€§è¶…å¼ºçš„æ¶ˆæ¯æ ¼å¼è·å¾—äº†å¹¿æ³›çš„è¿ç”¨ï¼Œä¹Ÿè¢«è¯¸å¤šRPCæ¡†æ¶ç”¨ä½œIDLæ¥æŒ‡å¯¼ä»£ç ç”Ÿæˆï¼Œå…¶åœ¨ç¼–è§£ç æ•ˆç‡ã€æ•°æ®é‡æ–¹é¢éƒ½æœ‰ä¸é”™çš„benchmarkæ•°æ®ï¼Œæ˜¯å½“ä»Šéå¸¸æµè¡Œçš„æ¶ˆæ¯æ ¼å¼ã€‚\nprotobufå½“ç„¶ä¹Ÿä¸æ˜¯å”¯ä¸€ä¸€ç§æµè¡Œçš„æ¶ˆæ¯æ ¼å¼ï¼Œåœ¨æŸäº›å¯¹èµ„æºæ›´æ•æ„Ÿçš„æ¸¸æˆåœºæ™¯ï¼Œflatbuffersä¹Ÿæ˜¯ä¸€ç§è¢«éå¸¸é’ççš„æ¶ˆæ¯äº¤æ¢æ ¼å¼ã€‚è¿˜æœ‰thriftã€xmlã€jsonç­‰ç­‰è¯¸å¤šæ ¼å¼ï¼Œå®ƒä»¬éƒ½æœ‰å„è‡ªçš„ä¸€äº›é€‚ç”¨åœºæ™¯ï¼Œå¹¶éå–ä»£ä¸è¢«å–ä»£çš„å…³ç³»ï¼Œè€Œæ˜¯è¢«é—®é¢˜åœºæ™¯é€‰æ‹©ä¸è¢«é€‰æ‹©çš„å…³ç³»ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥æ›´æ·±å…¥äº†è§£ä¸‹ã€‚\ny.é—®é¢˜æ¡ˆä¾‹ # æœ€åæ€»ç»“ä¸¤ä¸ªåˆå…¥èŒåœºä¸ä¹…é‡åˆ°çš„pbé—®é¢˜ï¼Œè¿™ä¸¤ä¸ªé—®é¢˜æ˜¯æˆ‘å·¥ä½œä¸­çœŸå®é‡åˆ°çš„ï¼Œè¿™é‡Œä¸€å¹¶è®°å½•ä¸‹ï¼Œä¹Ÿå¯¹å…¶ä¸­ä¸pbç›¸å…³çš„å…¶ä»–çŸ¥è¯†ç‚¹è¿›è¡Œä¸€ä¸‹æ€»ç»“ã€‚\né—®é¢˜1 # å®¢æˆ·ç«¯å¸Œæœ›åè®®ä¸­æ–°å¢ä¸€ç§çŸ­è§†é¢‘ç±»å‹ï¼ŒæœåŠ¡ç«¯éœ€è¦è¯»å–å‡ºçŸ­è§†é¢‘ç±»å‹å¹¶è¿›è¡Œå­˜å‚¨ï¼Œä½†æ˜¯æœåŠ¡ç«¯æœªèƒ½æˆåŠŸæ¥æ”¶åˆ°å®¢æˆ·ç«¯æäº¤çš„æ–°çš„çŸ­è§†é¢‘ç±»å‹ã€‚\né—®é¢˜èƒŒæ™¯ï¼š\nå®¢æˆ·ç«¯ã€åå°å®šä¹‰å¥½äº†åè®®ï¼Œå®¢æˆ·ç«¯è¦æ±‚æäº¤ä¸€ç§æ–°çš„çŸ­è§†é¢‘ç±»å‹â€œæ—¥è¿¹çŸ­è§†é¢‘â€ç±»å‹ï¼Œäºæ˜¯åå°åœ¨FeedTypeè¿™ä¸ªæšä¸¾ç±»å‹é‡Œé¢å¢åŠ äº†ç¬¬3ä¸ªå­—æ®µDAY_MOMENTï¼Œç„¶åå‘¢ï¼Œå®¢æˆ·ç«¯é‡æ–°ç¼–è¯‘è¯¥pbã€åå°é‡æ–°ç¼–è¯‘è¯¥pbã€å„è‡ªå¼€å‘ï¼Œåæ¥è”è°ƒä¸€åˆ‡æ­£å¸¸â€¦â€¦\nè¿‡äº†ä¸€æ®µæ—¶é—´å‘¢ï¼Ÿå¦ä¸€ä¸ªåå°å¼€å‘åŒå­¦ä¸çŸ¥é“protoå·²ç»è¢«æ›´æ–°äº†ï¼Œä»–åªæ›´æ–°äº†æ£€å‡ºçš„feedså†™æœåŠ¡çš„ä»£ç ï¼Œå¹¶æ²¡æœ‰æ›´æ–°æ£€å‡ºçš„å…¬å…±ç›®å½•feeds/protoä¸‹çš„protoæ–‡ä»¶ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å°†æ–°çš„æ—¥è¿¹çŸ­è§†é¢‘ç±»å‹è¿™ä¸ªæšä¸¾å­—æ®µç¼–è¯‘åˆ°ä»£ç ä¸­å»ï¼Œå°±è¿™æ ·å‘å¸ƒå‡ºå»äº†â€¦â€¦\nåé¢å®¢æˆ·ç«¯åŒå­¦å‘ç°ï¼Œæ˜æ˜æäº¤çš„æ˜¯æ—¥è¿¹çŸ­è§†é¢‘ç±»å‹ï¼ˆtype=3ï¼‰ï¼Œåå°æŸ¥è¯¢è¿”å›çš„å´æ˜¯æ™®é€šçš„çŸ­è§†é¢‘ç±»å‹ï¼ˆtype=1ï¼‰ï¼Œéå¸¸ä¸è§£ï¼Œæ£€æŸ¥åå°feedså†™ä»£ç åå‘ç°å®Œå…¨æ˜¯å°†å®¢æˆ·ç«¯æäº¤çš„typeç›´æ¥å†™åˆ°tmemã€dbçš„ï¼Œå¹¶æ²¡æœ‰åšä»»ä½•æ”¹åŠ¨â€¦â€¦\né€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› å·²ç»æ˜¯å¾ˆæ˜ç™½äº†ï¼Œå°±æ˜¯protoæ–‡ä»¶æ²¡æœ‰æ›´æ–°ï¼Œæ–°å¢åŠ çš„æšä¸¾å­—æ®µæ²¡æœ‰ç¼–è¯‘è¿›å»ï¼Œä½†æ˜¯ä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿå¸¦ç€è¿™ä¸ªé—®é¢˜æˆ‘æ‰’äº†ä¸€ä¸‹ä»£ç ç»ˆäºç†æ¸…äº†è¿™èƒŒåçš„åŸå› ã€‚\né¦–å…ˆå…¶ä»–çš„åå°å¼€å‘äººå‘˜æ²¡æœ‰æ›´æ–°æ£€å‡ºçš„protoæ–‡ä»¶ï¼Œå¯¼è‡´å…¶ä¸ªäººç›®å½•ä¸‹ç¼–è¯‘å‡ºçš„ä»£ç ä¸­ç¼ºå°‘â€œæ—¥è¿¹çŸ­è§†é¢‘å­—æ®µâ€ï¼Œå½“å®¢æˆ·ç«¯æäº¤çŸ­è§†é¢‘ç±»å‹FeedType type=3çš„æ—¶å€™ï¼Œ3è¢«ç¼–ç ä¸ºvarint(3)ï¼›æœåŠ¡ç«¯æšä¸¾ç±»å‹åªæœ‰ä¸¤ä¸ªå¯æšä¸¾å€¼1ã€2æ²¡æœ‰3ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åé€šè¿‡Feed feed; feed.ParseFromStringæˆ–è€…feed.ParseFromArrayæ–¹æ³•åä¸²è¡ŒåŒ–åï¼Œè¯»å–å‡ºæ¥çš„å€¼feed.type()æ˜¯å¤šå°‘å‘¢ï¼Ÿè¿™é‡Œä¹Ÿä¸å–å…³å­äº†ï¼Œfeed.type()è¿”å›çš„æ˜¯1è€Œä¸æ˜¯3ã€‚ä¸‹é¢å°±è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™é‡Œè¿”å›çš„ç«Ÿç„¶æ˜¯1ã€‚\nä»¥å›¾1ä¸­çš„T.protoä¸ºä¾‹ï¼Œå…¶ç”Ÿæˆçš„T.pb.hä¸­åŒ…å«äº†å¦‚ä¸‹å¯¹FeedTypeæšä¸¾å€¼çš„æ£€æŸ¥ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œset_type()æ–¹æ³•æˆ–è€…MergeParitalFromCodedStreamæˆ–è€…DebugString()çš„æ—¶å€™ï¼Œæ˜¯ä¼šå¯¹æšä¸¾å€¼çš„æœ‰æ•ˆæ€§è¿›è¡Œæ£€æŸ¥çš„ï¼Œæ£€æŸ¥æšä¸¾å€¼æœ‰æ•ˆæ€§çš„æ–¹æ³•å°±æ˜¯ä¸‹å›¾ä¸­çš„FeedType_IsValid()æ–¹æ³•ã€‚è¯¥æ–¹æ³•æ˜¯åœ¨enum FeedTypeä¸­çš„TYPE_RECORD_DAYMOMENTæœªè¢«æ³¨é‡Šæ‰çš„æƒ…å†µä¸‹ç”Ÿæˆçš„ï¼Œæ‰€ä»¥switché‡Œé¢è®¤ä¸ºcase 1ã€2ã€3éƒ½æ˜¯æœ‰æ•ˆçš„ï¼›å½“æ³¨é‡Šæ‰TYPE_RECORD_DAYMOMENTç”Ÿæˆçš„switchä¸­å°±åªæœ‰case 1ã€2ã€‚æ— æ•ˆçš„æšä¸¾å€¼è¯¥å‡½æ•°è¿”å›falseï¼Œæ‰€ä»¥é™¤äº†caseé‡Œé¢å‡ºç°è¿‡çš„æšä¸¾å€¼ï¼Œå…¶ä»–çš„éƒ½æ˜¯é”™è¯¯çš„ã€‚\næšä¸¾å€¼æœ‰æ•ˆæ€§æ£€æŸ¥ï¼š\nè¿™é‡Œçš„æ–¹æ³•FeedType_IsValid()ä¼šåœ¨æŸäº›æ–­è¨€assert()ä¸­è¢«è°ƒç”¨ï¼Œå¦‚æœç¨‹åºä¸­æ²¡æœ‰å®šä¹‰å®NDEBUGï¼Œé‚£ä¹ˆä¸€æ—¦è°ƒç”¨äº†è¯¥æ–¹æ³•çš„assert()è¢«æ‰§è¡Œå°†ç›´æ¥å¯¼è‡´ç¨‹åºé€€å‡ºã€‚ä½†æ˜¯åœ¨ç°ç½‘ä¸­è‚¯å®šæ˜¯ä¸å…è®¸ç¨‹åºå°±å› ä¸ºæ”¶åˆ°äº†ä¸€ä¸ªéæ³•çš„æšä¸¾å€¼å°±â€œæŒ‚æ‰â€çš„ï¼Œé‚£ä¹ˆprotobufä¸­å¯¹è¿™ç§éæ³•çš„æšä¸¾å€¼å¿…ç„¶ä¼šæä¾›ä¸€ç§å¤„ç†æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\nå½“æ”¶åˆ°ä¸€ä¸ªpbä¸²è¡ŒåŒ–æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹å…¶åä¸²è¡ŒåŒ–å¾—åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„Messageå¯¹è±¡å®ä¾‹ï¼Œé€šå¸¸çš„åä¸²è¡ŒåŒ–æ–¹æ³•æ˜¯è°ƒç”¨Messageå¯¹è±¡å®ä¾‹çš„ParseFromStringæˆ–è€…ParseFromArrayæ–¹æ³•æ¥å®Œæˆï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†ä¸€ä¸ªéå¸¸å…³é”®çš„æ–¹æ³•ï¼šMergePartialFromCodedStreamï¼Œè¯¥æ–¹æ³•æ˜¯åŸºç±»Messageçš„æ–¹æ³•ï¼Œä½†æ˜¯ä¼šè¢«Messageå­ç±»ä¸­çš„æ–¹æ³•è¦†ç›–ï¼Œå› ä¸ºå¦‚ä½•åä¸²è¡ŒåŒ–æ•°æ®è‚¯å®šæ˜¯ç”±å­ç±»ä¸­åŒ…æ‹¬çš„æˆå‘˜æ¥å†³å®šçš„ï¼Œæ¯ä¸ªå­ç±»éƒ½åº”è¯¥æä¾›å¯¹åº”çš„åä¸²è¡ŒåŒ–å®ç°ï¼Œè¿™éƒ¨åˆ†ä»£ç æ˜¯protocè‡ªåŠ¨æ’å…¥çš„ã€‚ä»¥å›¾1ä¸­çš„message Feedä¸ºä¾‹ï¼Œprotocå¤„ç†åç”Ÿæˆçš„T.pb.ccä¸­çš„MergePartialFromCodedStreamæ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\nMergePartialFromCodedStream:\nä¸Šå›¾æ˜¯releaseç‰ˆæœ¬ä¸­read tagæ—¶è¯»å–åˆ°tag=3æšä¸¾ç±»å‹FeedType typeå­—æ®µæ—¶çš„ç›¸å…³ä»£ç ï¼Œå› ä¸ºæšä¸¾ç±»å‹ä¹Ÿæ˜¯varintç±»å‹ï¼Œæ‰€ä»¥ä¼šé¦–å…ˆæ£€æŸ¥è¯»å–åˆ°çš„tagæ˜¯å¦æ˜¯ä¸€ä¸ªvarintç±»å‹ï¼Œå¦‚æœä¸æ˜¯åˆ™å°†å…¶åŠ å…¥unknown_fields vectorï¼›å¦‚æœæ˜¯åˆ™ç»§ç»­æ£€æŸ¥å­—æ®µå€¼æ˜¯å¦æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æšä¸¾å€¼ï¼Œå¦‚æœæ˜¯åˆ™å°†å…¶å¼ºåˆ¶ç±»å‹è½¬æ¢æˆFeedTypeï¼Œå¹¶æ›´æ–°è°ƒç”¨è€…Feedå¯¹è±¡çš„æˆå‘˜typeï¼›å¦‚æœä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æšä¸¾å€¼åˆ™å°†å…¶æ·»åŠ åˆ°unknown_fieldsè¿™ä¸ªvectorä¸­ï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨è€…Feedå¯¹è±¡çš„æˆå‘˜typeå¹¶æ²¡æœ‰è¢«æ›´æ–°ï¼Œä¾ç„¶æ˜¯ä½¿ç”¨çš„æ—§å€¼ï¼Œé‚£ä¹ˆè¿™é‡Œçš„æ—§å€¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\nåœ¨cã€c++ä¸­æšä¸¾ç±»å‹å˜é‡çš„é»˜è®¤å€¼ä¸º0ï¼Œä½†æ˜¯åœ¨protobufä¸­ï¼Œä¸€ä¸ªæšä¸¾ç±»å‹å˜é‡çš„é»˜è®¤å€¼ä¸ºæšä¸¾å€¼ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œæˆ‘ä»¬è¿™é‡Œçš„FeedType typeæšä¸¾å˜é‡å¯æšä¸¾çš„ç¬¬ä¸€ä¸ªå€¼ä¸º1ï¼Œæ‰€ä»¥æœ€ç»ˆFeedType typeçš„å€¼åœ¨Feed feed; feed.ParseFromArray(\u0026hellip;rec_pb_data\u0026hellip;)ä¹‹åä¸æ˜¯3è€Œæ˜¯1ã€‚\nâ€¦â€¦\nä¸Šè¿°å°±æ˜¯ilive_feeds_write_svråœ¨æ”¶åˆ°çŸ­è§†é¢‘ç±»å‹ä¸º3æ—¶å†™å…¥tmemçŸ­è§†é¢‘ç±»å‹å´ä¸º1è¿™ä¸ªé—®é¢˜çš„åŸå› ï¼\nè¿™é‡Œåªæ˜¯åŠ æ·±äº†å¯¹protobufå¤„ç†è¿‡ç¨‹çš„ç†è§£ï¼Œå¹¶éé€ æˆé—®é¢˜çš„æ ¹æºï¼Œæ ¹æºåº”è¯¥ä»ä»£ç ç®¡ç†æ–¹é¢æ‰¾ã€‚\n PSï¼špbä¸­å¯¹æšä¸¾å€¼çš„ä½¿ç”¨å»ºè®®ï¼Œå¼ºçƒˆå°†å¯¹åº”çš„0å€¼å®šä¹‰ä¸ºInvalid/Unknownï¼Œæ­£å¸¸å–å€¼ä»1å¼€å§‹å–ï¼Œç”¨0å€¼è¡¨ç¤ºæ— æ„ä¹‰çš„æšä¸¾å€¼ï¼Œä»¥è§£å†³pbæšä¸¾æ½œåœ¨çš„å„ç§â€œå‘â€ï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œæˆ‘åšé¡¹ç›®çš„ç»å†å·²ç»æ¸…æ™°åœ°è¡¨æ˜äº†å®ƒå¯èƒ½ç»™æ‚¨çš„é¡¹ç›®å¸¦æ¥çš„é£é™©ã€‚\n é—®é¢˜2 # é—®é¢˜äºŒï¼šç›´æ’­åœºæ™¯ï¼Œç”¨æˆ·åœ¨æˆ¿é—´å†…å‘é€èŠå¤©ä¿¡æ¯ï¼Œè¯·æ±‚ä¸­åŒ…å«äº†ä¸€ä¸ªæˆ¿é—´idå­—æ®µroomidï¼Œè¡¨ç¤ºç”¨æˆ·åœ¨å“ªä¸ªæˆ¿é—´ä¸­å‘è¨€ï¼Œä½†æ˜¯æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯æäº¤çš„roomidæ˜¯é”™è¯¯çš„ã€‚\né—®é¢˜æè¿°ï¼š\nå®¢æˆ·ç«¯ã€åå°å®šä¹‰å¥½äº†protoæ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nmessage XXXReq { optional uint32 anyfield = 1; optional uint32 roomid = 2; }; message XXXRsp { optional uint32 roomid = 1; optional ustring json = 2; }; rpc XXX(XXXReq) return (XXXRsp);  ä½†æ˜¯å‘¢ï¼Œåæ¥ç”±äºåè®®å˜åŠ¨å‘ç°XXXReqä¸­çš„å­—æ®µanyfieldæ²¡æœ‰ç”¨ï¼Œå°±åˆ æ‰å§ï¼Œäºæ˜¯åå°å°±æ”¹æˆäº†ï¼š\nmessage XXXReq { optional uint32 roomid = 1; };  ä½†æ˜¯å‘¢ï¼Œå®¢æˆ·ç«¯é‚£è¾¹åªæ˜¯åˆ æ‰äº†ç¬¬ä¸€ä¸ªå­—æ®µï¼Œæ”¹æˆäº†ï¼š\nmessage XXXReq { optional uint32 roomid = 2; };  åå°å¹¶ä¸çŸ¥é“å®¢æˆ·ç«¯æ˜¯è¿™ä¹ˆæ”¹çš„â€¦â€¦ä¸€æ®µæ—¶é—´ä¹‹åï¼Œåå°åŒå­¦å‘ç°å®¢æˆ·ç«¯åŒå­¦æäº¤è¿‡æ¥çš„å‚æ•°roomidä¼¼ä¹æ˜¯æœ‰é—®é¢˜çš„ï¼Œä»€ä¹ˆé—®é¢˜å‘¢ï¼ŸåŒä¸€ä¸ªç”¨æˆ·è¿›å…¥nowä¸»æ’­æˆ¿é—´åå‘è¨€ï¼Œæ¯æ¬¡å‘è¨€è¯·æ±‚æäº¤çš„roomidéƒ½åº”è¯¥æ˜¯ä¸»æ’­è‡ªå·±çš„roomidï¼Œåº”è¯¥æ˜¯å›ºå®šçš„ï¼Œä½†æ˜¯åå°åŒå­¦å‘ç°æ‰“å°å‡ºæ¥çš„è¯·æ±‚ä¸­çš„roomidå´æ˜¯å˜åŒ–çš„ï¼Œè¿™æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ\nå…¶å®è¿™é‡Œç»è¿‡é—®é¢˜1çš„åˆ†æä¹‹åä¹Ÿå¾ˆå®¹æ˜“ç†è§£äº†ï¼Œåå°æ ¹æœ¬å°±æ²¡æœ‰è¯»å–åˆ°å®¢æˆ·ç«¯è®¾ç½®çš„tag=2çš„roomidï¼Œåå°åªæ˜¯ä½¿ç”¨äº†XXXReq reqä¸­çš„é»˜è®¤çš„roomidå€¼ï¼Œè¿™ä¸ªå˜é‡åˆæ²¡æœ‰è¿›è¡Œåˆå§‹åŒ–ï¼Œroomidä¸­çš„å€¼æ˜¯éšæœºå€¼ï¼Œè‚¯å®šæ˜¯ä¼šå˜åŒ–çš„ã€æ˜¯é”™è¯¯çš„ã€‚\n"}),a.add({id:386,href:"/tags/varint/",title:"varint",description:"",content:""}),a.add({id:387,href:"/tags/zigzag/",title:"zigzag",description:"",content:""}),a.add({id:388,href:"/blog/2021-04-19-go-sync.mutex%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/",title:"",description:"ç»ˆäºæ¥åˆ°äº†goè¯­è¨€ç›¸å…³çš„è®¾è®¡å®ç°ï¼Œgoä¸­sync.Mutexçš„è®¾è®¡æœ‰å¾ˆå¤šè®¾è®¡æ–¹é¢çš„è€ƒè™‘ã€‚\næˆ‘ä»¬çœ‹ä¸‹å¯¹åº”çš„åŠ é”è§£é”éƒ¨åˆ†ï¼Œå¯¹åº”çš„æºç  see https://sourcegraph.com/github.com/golang/go/-/blob/src/sync/mutex.go#L72\né¦–å…ˆï¼Œäº†è§£ä¸‹é”çš„å®šä¹‰ï¼Œæˆ‘ä»¬çœ‹åˆ°é‡Œé¢æœ‰ä¸ªstateå­—æ®µï¼Œè¿™ä¸ªå­—æ®µè¡¨ç¤ºçš„æ˜¯é”çš„çŠ¶æ€ï¼Œä¸º0è¡¨ç¤ºé”æ˜¯è§£é”çŠ¶æ€ï¼Œå…¶ä»–çŠ¶æ€å¯ä»¥å‚è€ƒä¸‹æºç ä¸­çš„å®šä¹‰ã€‚\n// A Mutex is a mutual exclusion lcok. // The zero value for a Mutex is an unlocked mutex. // // A Mutex must not be copied after first use. type Mutext struct { state	int32 sema	uint32 } const ( mutexLocked = 1 \u0026lt;\u0026lt; iota // mutex is locked mutexWoken mutexStarving mutexWaiterShift = iota )  ä¸‹é¢çœ‹ä¸‹åŠ è§£é”å®ç°ï¼Œå¤šæ³¨æ„ä¸‹stateç›¸å…³çš„é€»è¾‘ï¼Œæ¯”è¾ƒå®¹æ˜“å¥½ç†è§£ã€‚\nmutex.Lock() # fastpath # é¦–å…ˆï¼Œä¼šæ‰§è¡Œfastpathï¼Œä¼šå°è¯•CASåŠ é”ä¸€æ¬¡ï¼Œå¦‚æœæ²¡æœ‰å¾ˆå¤šé”ç«äº‰ï¼Œä¸”é”å¤„äºæœªåŠ é”çŠ¶æ€ï¼ˆstate=0ï¼‰ï¼Œå¤§æ¦‚ç‡ä¼šåŠ é”æˆåŠŸï¼ˆstate=1ï¼‰æˆåŠŸè¿”å›ã€‚\nå¦‚æœfastpathåŠ é”å¤±è´¥äº†ï¼Œæ¯”å¦‚å°è¯•åŠ é”å‰state != 0ï¼š",content:"ç»ˆäºæ¥åˆ°äº†goè¯­è¨€ç›¸å…³çš„è®¾è®¡å®ç°ï¼Œgoä¸­sync.Mutexçš„è®¾è®¡æœ‰å¾ˆå¤šè®¾è®¡æ–¹é¢çš„è€ƒè™‘ã€‚\næˆ‘ä»¬çœ‹ä¸‹å¯¹åº”çš„åŠ é”è§£é”éƒ¨åˆ†ï¼Œå¯¹åº”çš„æºç  see https://sourcegraph.com/github.com/golang/go/-/blob/src/sync/mutex.go#L72\né¦–å…ˆï¼Œäº†è§£ä¸‹é”çš„å®šä¹‰ï¼Œæˆ‘ä»¬çœ‹åˆ°é‡Œé¢æœ‰ä¸ªstateå­—æ®µï¼Œè¿™ä¸ªå­—æ®µè¡¨ç¤ºçš„æ˜¯é”çš„çŠ¶æ€ï¼Œä¸º0è¡¨ç¤ºé”æ˜¯è§£é”çŠ¶æ€ï¼Œå…¶ä»–çŠ¶æ€å¯ä»¥å‚è€ƒä¸‹æºç ä¸­çš„å®šä¹‰ã€‚\n// A Mutex is a mutual exclusion lcok. // The zero value for a Mutex is an unlocked mutex. // // A Mutex must not be copied after first use. type Mutext struct { state	int32 sema	uint32 } const ( mutexLocked = 1 \u0026lt;\u0026lt; iota // mutex is locked mutexWoken mutexStarving mutexWaiterShift = iota )  ä¸‹é¢çœ‹ä¸‹åŠ è§£é”å®ç°ï¼Œå¤šæ³¨æ„ä¸‹stateç›¸å…³çš„é€»è¾‘ï¼Œæ¯”è¾ƒå®¹æ˜“å¥½ç†è§£ã€‚\nmutex.Lock() # fastpath # é¦–å…ˆï¼Œä¼šæ‰§è¡Œfastpathï¼Œä¼šå°è¯•CASåŠ é”ä¸€æ¬¡ï¼Œå¦‚æœæ²¡æœ‰å¾ˆå¤šé”ç«äº‰ï¼Œä¸”é”å¤„äºæœªåŠ é”çŠ¶æ€ï¼ˆstate=0ï¼‰ï¼Œå¤§æ¦‚ç‡ä¼šåŠ é”æˆåŠŸï¼ˆstate=1ï¼‰æˆåŠŸè¿”å›ã€‚\nå¦‚æœfastpathåŠ é”å¤±è´¥äº†ï¼Œæ¯”å¦‚å°è¯•åŠ é”å‰state != 0ï¼š\n  stateå¯èƒ½ä¸º1\næ­¤æ—¶ï¼Œè¡¨ç¤ºé”å·²ç»è¢«é”å®šï¼Œæ–°goroutineå°è¯•åŠ é”è¯·æ±‚å¤±è´¥ï¼Œè¿™ç§å¾ˆå¥½ç†è§£ï¼›\n  state != 0ï¼Œä½†ä¹Ÿä¸æ˜¯1ï¼ˆmutexLockedï¼‰\nè¿™ç§æƒ…å†µå°±æ¯”è¾ƒç‰¹æ®Šäº†ï¼Œæ¶‰åŠåˆ°goçš„ä¸€äº›é”ä¼˜åŒ–ï¼Œæ‹¿ä¸ªä¾‹å­æ¥è¯´ä¸€ä¸‹ã€‚æ¯”å¦‚stateæœ‰å¯èƒ½ä¸º4ï¼ˆmutexStarvingï¼‰ï¼Œå³å®ƒç¡®å®å¤„äºè§£é”çŠ¶æ€(state\u0026amp;mutexLocked=0)ï¼Œä½†å´å¤„äºstarvationæ¨¡å¼ä¸‹ï¼Œè¿™è¯´æ˜ä¹‹å‰æœ‰å°è¯•åŠ é”çš„goroutineå¾ˆä¹…æ²¡æœ‰æ‹¿åˆ°é”äº†ï¼Œæ‰€ä»¥å°†å½“å‰é”çš„æ¨¡å¼ä»normalä¿®æ”¹ä¸ºäº†starvationã€‚\nä¸ºäº†é¿å…è°ƒåº¦å»¶è¿Ÿè¿‡å¤§ï¼Œgoä¼šä¼˜å…ˆå—ç†éƒ¨åˆ†goroutineçš„åŠ é”è¯·æ±‚ï¼Œæ‰€ä»¥ï¼Œè¿™ç§æƒ…å†µæ–°åŠ å…¥æŠ¢é”çš„goroutineä¹Ÿæ˜¯ä¸èƒ½æ‹¿åˆ°é”çš„ã€‚\n  OKï¼Œæœ‰äº†è¿™ä¸ªå¤§è‡´çš„äº†è§£ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­çœ‹åŠ é”å¤±è´¥åçš„å¤„ç†è·¯å¾„ï¼Œç»§ç»­æ‰§è¡Œslowpathã€‚\n// Lock locks m. // If the lock is already in use, the calling goroutine // blocks until the mutex is available. func (m *Mutex) Lock() { // Fast path: grab unlocked mutex. if atomic.CompareAndSwapInt32(\u0026amp;m.state, 0, mutexLocked) { if race.Enabled { race.Acquire(unsafe.Pointer(m)) } return } // Slow path (outlined so that the fast path can be inlined) m.lockSlow() }  slowpath # è¿™éƒ¨åˆ†å°±æœ‰å¾ˆå¤šä¼˜åŒ–æªæ–½äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥é˜…è¯»è¿™é‡Œçš„æºç ï¼Œæˆ‘ä»¬å…ˆå°è¯•æ€»ç»“ä¸‹ã€‚\nsee https://sourcegraph.com/github.com/golang/go/-/blob/src/sync/mutex.go#L84\nfunc (m *Mutex) lockSlow() { ... old := m.state for { // Don't spin in starvation mode, ownership is handed off to waiters // so we won't be able to acquire the mutex anyway. if old\u0026amp;(mutexLocked|mutexStarving) == mutexLocked \u0026amp;\u0026amp; runtime_canSpin(iter) { // Active spinning makes sense. // Try to set mutexWoken flag to inform Unlock // to not wake other blocked goroutines. if !awoke \u0026amp;\u0026amp; old\u0026amp;mutexWoken == 0 \u0026amp;\u0026amp; old\u0026gt;\u0026gt;mutexWaiterShift != 0 \u0026amp;\u0026amp; atomic.CompareAndSwapInt32(\u0026amp;m.state, old, old|mutexWoken) { awoke = true } runtime_doSpin() iter++ old = m.state continue } ... } ... }  åŠ é”å¤±è´¥åï¼Œå¤±è´¥åŸå› æœ‰å¤šç§ï¼Œè¦ä¹ˆæ˜¯é”å·²ç»è¢«é”å®šäº†ï¼Œè¦ä¹ˆæ˜¯å¤„äºé¥¥é¥¿æ¨¡å¼ã€‚å¯¹åº”çš„å¤„ç†æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¼€å¤´å…ˆåˆ¤æ–­ä¸‹ã€‚\nå¦‚æœold\u0026amp;(mutexLocked|mutexStarvig) == mutexLockedä¸ºtrueï¼Œåˆ™è¡¨ç¤ºä¹‹å‰åŠ é”çš„å¤±è´¥åŸå› æ˜¯ï¼Œé”å·²ç»è¢«é”å®šäº†ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿéš¾é“è¦è®©goroutineç«‹å³å»ç¡è§‰è§‰ï¼Ÿgoroutineç¡ç€åå†è¢«å”¤é†’å‚ä¸è°ƒåº¦è¿™ä¸ªå¼€é”€å’Œçº¿ç¨‹æ¯”æ˜¯å°ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰çš„å˜›ï¼Œèƒ½ä¸èƒ½å†å°è¯•å‡ æ¬¡ï¼Œé¿å…è¿‡æ—©ç¡çœ ï¼Ÿå½“ç„¶å¯ä»¥ã€‚\né‚£å°±è®©å½“å‰goroutineè‡ªæ—‹+é‡æ–°åŠ é”å‡ æ¬¡è¯•è¯•ï¼Œå°±æ˜¯è¿™é‡Œçš„runtime_canSpin(iter)æ¥æ§åˆ¶èƒ½å¦è‡ªæ—‹äº†ã€‚\n// Active spinning for sync.Mutex. //go:linkname sync_runtime_canSpin sync.runtime_canSpin //go:nosplit func sync_runtime_canSpin(i int) bool { // sync.Mutex is cooperative, so we are conservative with spinning. // Spin only few times and only if running on a multicore machine and // GOMAXPROCS\u0026gt;1 and there is at least one other running P and local runq is empty. // As opposed to runtime mutex we don't do passive spinning here, // because there can be work on global runq or on other Ps. if i \u0026gt;= active_spin || ncpu \u0026lt;= 1 || gomaxprocs \u0026lt;= int32(sched.npidle+sched.nmspinning)+1 { return false } if p := getg().m.p.ptr(); !runqempty(p) { return false } return true }  æœ€å¤šè‡ªæ—‹4æ¬¡ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–è¦æ±‚ï¼Œå°±æ˜¯å¿…é¡»è¿è¡Œåœ¨å¤šæ ¸æœºå™¨ä¸Šï¼Œå¹¶ä¸”GOMAXPROCS\u0026gt;1ï¼Œå¹¶ä¸”è‡³å°‘æœ‰å¦å¤–ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„Pä¸”å…¶runqä¸ºç©ºã€‚å¤§å®¶å¯ä»¥æƒ³ä¸€ä¸‹ä¸ºä»€ä¹ˆï¼Ÿå¦‚æœä¸è¿™ä¹ˆé™åˆ¶ï¼Œé‚£è°æ¥é‡Šæ”¾é”å‘¢ï¼Œå½“å‰goroutineå¤§æ¦‚ç‡è‡ªæ—‹æ— æ•ˆï¼Œä¹Ÿä¼˜åŒ–ä¸äº†ä»€ä¹ˆã€‚\nè¿™äº›æ¡ä»¶æ»¡è¶³æ—¶ï¼Œæ£€æŸ¥å½“å‰gè¿è¡Œçš„Pä¸Šrunqæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºæ‰å…è®¸è‡ªæ—‹ï¼Œä¸ºä»€ä¹ˆï¼Ÿä¼šå½±å“åˆ°runqä¸­çš„goroutineçš„è°ƒåº¦æ‰§è¡Œå§ã€‚\næœ€åå†çœ‹lockSlowä¸­çš„ä»£ç é€»è¾‘ï¼š\nfunc (m *Mutex) lockSlow() { ... old := m.state for { if old\u0026amp;(mutexLocked|mutexStarving) == mutexLocked \u0026amp;\u0026amp; runtime_canSpin(iter) { // Active spinning makes sense. // Try to set mutexWoken flag to inform Unlock // to not wake other blocked goroutines. if !awoke \u0026amp;\u0026amp; old\u0026amp;mutexWoken == 0 \u0026amp;\u0026amp; old\u0026gt;\u0026gt;mutexWaiterShift != 0 \u0026amp;\u0026amp; atomic.CompareAndSwapInt32(\u0026amp;m.state, old, old|mutexWoken) { awoke = true } runtime_doSpin() iter++ old = m.state continue } ... } ... }  å¤§å®¶çœ‹åˆšå¼€åŠ é”å¤±è´¥åawoke=false, å¹¶ä¸”å‡å®šold=mutexLockedï¼Œold\u0026raquo;mutexWaiterShiftè¿™ä¸ªå†™æ³•ï¼Œè®©äººçŒœæµ‹m.stateä¸­è¿˜å­˜å‚¨äº†waiterç›¸å…³çš„ä¿¡æ¯ï¼Œç„¶åå°è¯•å°†m.stateè®¾ç½®ä¸ŠmutexWokenï¼Œawoke=trueï¼Œæ²¡çœ‹å‡ºè¿™æ˜¯åœ¨å¹²å•¥ã€‚\nç„¶åruntime_doSpinå¼€å§‹ç©ºè½¬CPUï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªforå¾ªç¯ä»30å‡åˆ°0ï¼Œç»“æŸã€‚è¿™ä¹ˆåšæ— éå°±æ˜¯æƒ³ç­‰å…¶ä»–goroutineæŠŠé”é‡Šæ”¾æ‰ã€‚\nconst ( active_spin_cnt = 30 ) //go:linkname sync_runtime_doSpin sync.runtime_doSpin //go:nosplit func sync_runtime_doSpin() { procyield(active_spin_cnt) } func procyield(cycles uint32) TEXT runtimeÂ·procyield(SB),NOSPLIT,$0-0 MOVL	cycles+0(FP), AX again: PAUSE SUBL	$1, AX JNZ	again RET  ç„¶åiter++ï¼Œè¡¨ç¤ºè‡ªæ—‹æ¬¡æ•°+1ï¼ˆæœ€å¤š4æ¬¡ï¼‰ï¼Œæ›´æ–°é”çŠ¶æ€ï¼Œæ³¨æ„æ­¤æ—¶mutexWokenè®¾ç½®äº†ï¼Œç°åœ¨å¯ä»¥çŒœæµ‹ä¸‹mutexWokenè¡¨ç¤ºå•¥äº†ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯mutexæœ‰æ²¡æœ‰å”¤é†’åç¨‹æ¥æŠ¢é”ã€‚\nè‡ªæ—‹ä¹‹åcontinueï¼Œè¿›å…¥å¾ªç¯ä½“çš„ä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œç»§ç»­æ£€æŸ¥é”çš„çŠ¶æ€ï¼š\n å¦‚æœé”ä¾æ—§è¢«é”å®šï¼Œä¸”å½“å‰å¯ä»¥ç»§ç»­è‡ªæ—‹ï¼Œåˆ™ç»§ç»­è‡ªæ—‹ï¼› å¦‚æœé”ä¾æ—§è¢«é”å®šï¼Œä¸”å½“å‰è¶…è¿‡äº†è‡ªæ—‹æ¬¡æ•°ï¼Œåˆ™æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼› å¦‚æœé”è¢«è§£é”äº†ï¼Œåˆ™ä¹Ÿæ‰§è¡Œä¸‹é¢çš„é€»è¾‘ï¼›  ä¸‹é¢çš„newè¡¨ç¤ºå½“å‰ä»£ç æ‰§è¡Œå®Œåé”çš„çŠ¶æ€ï¼Œæœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µï¼š\n é”è¿˜æ²¡è¢«é‡Šæ”¾ï¼Œé”å¿…ç„¶å¤„äºé”å®šçŠ¶æ€ï¼Œnew\u0026amp;mutexLocked==1ï¼› é”å·²ç»è¢«é‡Šæ”¾ï¼Œé”å¦‚æœå¤„äºnormalæ¨¡å¼ï¼Œå½“å‰goroutineå¿…æŠ¢é”æˆåŠŸï¼Œæ‰€ä»¥new|=mutexLockedä¹Ÿå¾ˆå¥½ç†è§£ï¼› é”å·²ç»è¢«é‡Šæ”¾ï¼Œé”å¦‚æœå¤„äºstarvationæ¨¡å¼ï¼Œå½“å‰goroutineæŠ¢é”å¤±è´¥ï¼Œå…¥é˜Ÿç­‰å¾…ï¼Œä½†æ˜¯è¿™ä¸ªé”å°†ç›´æ¥é€’äº¤ç»™ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªwaiterï¼Œä¸ç”¨è¿™ä¸ªwaiterè¢«å”¤é†’åæŠ¢é”ï¼Œæ‰€ä»¥å…¶new|=mutexLockedæ²¡ä»€ä¹ˆç–‘é—®äº†ï¼›  ç»§ç»­çœ‹waiteræ ‡å¿—ä½ç›¸å…³çš„è®¾ç½®ï¼šæ£€æŸ¥oldçŠ¶æ€ï¼Œå¦‚æœä»æ˜¯é”å®šæˆ–è€…é¥¿æ­»çŠ¶æ€ï¼Œåˆ™ç›´æ¥å°†newä¸­è®¾ç½®mutexWaiteræ ‡è®°ã€‚å¹²å˜›ç”¨çš„ï¼Œè¡¨ç¤ºæœ‰waiteråœ¨ç­‰å¾…é”é‡Šæ”¾å•Šã€‚\nç»§ç»­çœ‹starvationæ ‡å¿—ä½ç›¸å…³çš„è®¾ç½®ï¼šå¦‚æœå‘ç°é”ä¹‹å‰çš„çŠ¶æ€å°±æ˜¯é¥¥é¥¿æ¨¡å¼äº†ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«é”å®šï¼Œé‚£ä¹ˆé”çš„æœ€æ–°çŠ¶æ€è¿˜æ˜¯é¥¥é¥¿æ¨¡å¼ï¼ˆnew|=mutexStarvingå²‚ä¸æ˜¯å¤šä½™ï¼Ÿï¼‰\nfunc (m *Mutex) lockSlow() { ... old := m.state for { new := old // Don't try to acquire starving mutex, new arriving goroutines must queue. if old\u0026amp;mutexStarving == 0 { new |= mutexLocked } if old\u0026amp;(mutexLocked|mutexStarving) != 0 { new += 1 \u0026lt;\u0026lt; mutexWaiterShift } // The current goroutine switches mutex to starvation mode. // But if the mutex is currently unlocked, don't do the switch. // Unlock expects that starving mutex has waiters, which will not // be true in this case. if starving \u0026amp;\u0026amp; old\u0026amp;mutexLocked != 0 { new |= mutexStarving } ... } .... }  ç»§ç»­çœ‹ï¼Œå¦‚æœå½“å‰mutexå·²ç»æœ‰è¢«å”¤é†’çš„goroutineå°è¯•æŠ¢é”ï¼Œé‚£ä¹ˆnewé‡Œé¢mutexWokenåº”è¯¥ä¸º1ï¼Œå¦‚æœä¸º0æ˜¯ä¸€ç§ä¸ä¸€è‡´çŠ¶æ€ï¼ŒæŠ¥é”™ã€‚ç„¶åä»newä¸­æ¸…é™¤è¿™ä¸€æ ‡è®°ä½ï¼Œä¹Ÿéœ€mutexwokenä»£è¡¨çš„å°±æ˜¯å½“å‰goroutineå§ï¼Œä¸€æ¬¡å”¤é†’ä¸€ä¸ªå˜›ã€‚\nfunc (m *Mutex) lockSlow() { ... old := m.state for { new := old ... if awoke { // The goroutine has been woken from sleep, // so we need to reset the flag in either case. if new\u0026amp;mutexWoken == 0 { throw(\u0026quot;sync: inconsistent mutex state\u0026quot;) } new \u0026amp;^= mutexWoken } ... } ... }  ç»§ç»­çœ‹ï¼ŒCASæ›´æ–°ä¸‹é”çŠ¶æ€m.stateï¼Œæ³¨æ„æ­¤æ—¶newé‡Œé¢è®¾ç½®äº†lockedï¼ˆstarvationå¯èƒ½æœ‰ä¹Ÿå¯èƒ½æ²¡æœ‰ï¼‰ã€‚\nç»§ç»­æ£€æŸ¥ï¼Œå¦‚æœä¹‹å‰é”çŠ¶æ€ä¸æ˜¯é”å®šçŠ¶æ€ã€ä¸æ˜¯é¥¥é¥¿çŠ¶æ€ï¼Œé‚£ä¹ˆç°åœ¨è‚¯å®šå°±æ˜¯é”å®šæˆåŠŸäº†ï¼Œé€€å‡ºå¾ªç¯ç»“æŸåŠ é”è¿‡ç¨‹ã€‚\nå¦‚æœå‘ç°waitStartTimeä¸ä¸º0ï¼Œè¯´æ˜ä¹‹å‰å·²ç»æœ‰å‡ è½®å¾ªç¯æ¥å°è¯•è¿‡è·å¾—é”äº†ï¼Œç°åœ¨è¦ç®—ä¸€ä¸‹å½“å‰è¿™æ¬¡åŠ é”æ“ä½œæ€»å…±ç­‰å¾…äº†å¤šä¹…äº†ã€‚\nfunc (m *Mutex) lockSlow() { var waitStartTime int64 ... old := m.state for { new := old ... if atomic.CompareAndSwapInt32(\u0026amp;m.state, old, new) { if old\u0026amp;(mutexLocked|mutexStarving) == 0 { break // locked the mutex with CAS } // If we were already waiting before, queue at the front of the queue. queueLifo := waitStartTime != 0 if waitStartTime == 0 { waitStartTime = runtime_nanotime() } ... } ... } ... }  ç°åœ¨æ¥ç®—ä¸€ä¸‹å½“å‰goroutineåŠ é”ç­‰å¾…äº†å¤šä¹…äº†ï¼Œè¿™ä¸ªæ—¶é—´å¾ˆå¥½ç®—ï¼Œç›´æ¥æ‹¿å½“å‰æ—¶é—´å‡å»ç¬¬ç¬¬ä¸€æ¬¡å¼€å§‹çš„æ—¶é—´å°±ç®—å‡ºæ¥äº†ï¼Œruntime_nanotime()-waitStartTime()ï¼Œå¹¶ä¸”å‘ç°ï¼Œå¦‚æœè¿™ä¸ªæ—¶é—´è¶…è¿‡é˜ˆå€¼1msï¼Œå°±ä¼šå°†starvingè®¾ä¸ºtrueï¼Œæ„å‘³ç€mutexå°†è¢«è®¾ç½®ä¸ºé¥¥é¥¿æ¨¡å¼ï¼Œå½“ç„¶å¦‚æœä»¥å‰å°±æ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œç°åœ¨è‚¯å®šä¹Ÿæ˜¯é¥¥é¥¿æ¨¡å¼äº†ã€‚\nå¦å¤–æ³¨æ„queueLifoçš„å€¼ï¼Œå¦‚æœæ˜¯æ–°æŠ¢é”çš„goroutineï¼Œé‚£ä¹ˆä¸ºfalseï¼Œè°ƒç”¨runtime_Semacquireæ—¶ä¼šå°†è¯¥goroutineå‡å¦‚åˆ°é˜Ÿåˆ—çš„æœ«å°¾æ’é˜Ÿï¼Œå¦‚æœæ˜¯ä¹‹å‰å”¤é†’è¿‡çš„goroutineï¼Œåˆ™ä¼šå°†å…¶æ·»åŠ åˆ°é˜Ÿåˆ—çš„å¯¹é¦–ï¼Œå¦‚æœé”å˜æˆäº†é¥¥é¥¿æ¨¡å¼ä¸”è¢«é‡Šæ”¾äº†ï¼Œåˆ™ç›´æ¥äº¤ç»™å¯¹é¦–çš„goroutineæ‰§è¡Œã€‚\nè¿™ä¸ªå‡½æ•°runtime_semacquiremutexï¼Œè¿˜æŒºå…³é”®çš„ï¼š\nä¿¡å·é‡semarootå¥½ç†è§£ï¼Œå®ƒæ˜¯åœ°å€addrå¤„å¯¹åº”çš„ä¿¡å·é‡ï¼Œæœ¬èº«å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªç­‰å¾…ä¿¡å·é‡çš„sudogï¼ˆç­‰å¾…æ‰§è¡Œçš„gï¼‰åˆ—è¡¨ï¼Œå¯¹mutexè€Œè¨€å°±æ˜¯ç­‰å¾…æŠ¢é”çš„goroutines/waitersåˆ—è¡¨ã€‚\nmutexé‡Œé¢ä¸ºä»€ä¹ˆè¦åŠ ä¸€ä¸ªå­—æ®µsemaï¼Œå…¶å®å°±æ˜¯ä¸ºäº†é—´æ¥å…·å¤‡è¿™æ ·ä¸€ç§èƒ½åŠ›ï¼Œç»´æŠ¤ä¸€ä¸ª\u0026amp;semaçš„ä¿¡å·é‡ï¼Œç»´æŠ¤ä¸€ä¸ªå¼•æŠ¢é”è€Œé˜»å¡çš„goroutineåˆ—è¡¨ï¼Œä»¥æ–¹ä¾¿åœ¨é”è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œå†æŠŠå®ƒä»¬å”¤é†’ã€‚\nçœ‹ä¸‹è¿™ä¸ªå‡½æ•°æ˜¯æ€ä¹ˆå®ç°çš„å§ï¼Œå®ƒè°ƒç”¨äº†semacquire1è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å†…éƒ¨å°±æ˜¯è·å¾—\u0026amp;addrå¤„å¯¹åº”çš„ä¿¡å·é‡ï¼Œç„¶åå°è¯•å¯¹semaroot.lockåŠ é”ï¼Œè¿™ä¸ªé”æ˜¯ä¸€ä¸ªruntime.mutexï¼Œ\næˆ‘æ“¦ï¼Œæˆ‘å‘ç°è¿™ä¸ªå‡½æ•°é‡Œé¢è°ƒç”¨äº†semacquire1(\u0026hellip;)ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢è°ƒç”¨äº†lockWithRankï¼ŒlockWithRankè°ƒç”¨äº†lock2()ï¼Œlock2å†…éƒ¨ä½¿ç”¨äº†Linuxç³»ç»Ÿè°ƒç”¨futexè¿™ä¸ªèƒ½å¤ŸæŠŠçº¿ç¨‹æŒ‚èµ·çš„é‡é‡çº§é”ï¼\nTODO æ‰“è„¸ï¼Œå‰é¢æ€»ç»“è¯´sync.Mutexæ²¡æœ‰ä½¿ç”¨futexï¼Œå“‡æ“¦ï¼\nm.semaè¿™ä¸ªå˜é‡è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªä¿¡å·é‡ï¼Œä½†æ˜¯è¿™ä¸ªä¿¡å·é‡æ˜¯ç”¨æ¥é€šçŸ¥å•¥çš„å‘¢ï¼Ÿè¿™ä¸ªä¿¡å·é‡å¯¹åº”çš„æœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—çš„ï¼Œå¦‚æœlifoä¸ºtrueï¼Œåˆ™è¡¨ç¤ºå°†å½“å‰çš„goroutineå¯¹åº”çš„åç»­sudogæ”¾å…¥é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œè¿™æ ·æ–¹ä¾¿é¥¿æ­»æ¨¡å¼ä¸‹ç›´æ¥å°†mutexçš„æ‹¥æœ‰æƒäº¤ç»™è¿™ä¸ªå¯¹é¦–çš„waiterï¼Œé¿å…å…¶ç­‰é”ç­‰å¤ªä¹…ã€‚\n å¦‚æœæ‹¿åˆ°äº†è¿™ä¸ªä¿¡å·é‡å°±ç«‹å³è¿”å›äº†ï¼› å¦‚æœæ‹¿ä¸åˆ°è¿™ä¸ªä¿¡å·é‡å°±è¦åšåé¢çš„å¤„ç†äº†ï¼›  å¯èƒ½æœ‰å¤šä¸ªå¹¶å‘çš„goroutineæ¥æŠ¢é”çš„æƒ…å†µï¼Œå¯èƒ½ä¹‹å‰å·²ç»æœ‰æ²¡æŠ¢åˆ°é˜»å¡çš„goroutineäº†ï¼Œè¿™é‡Œå…ˆæ‰¾ä¸€ä¸ªé˜»å¡çš„goroutineï¼Œè·å¾—ä¿¡å·é‡åœ°å€å¯¹åº”çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œè®°ä¸ºsemarootï¼Œè¿™ä¸ªç»´æŠ¤äº†mutexä¸Šå› ä¸ºæŠ¢é”å¤±è´¥è€Œç­‰å¾…çš„goroutineï¼ˆwaitersï¼‰é˜Ÿåˆ—ã€‚\nå¯¹è¿™ä¸ªsemaroot.lockçš„åŠ é”æ“ä½œï¼Œç”¨äº†è‡ªæ—‹ã€CASã€futexï¼Œä¸ºå•¥ç”¨futexå‘¢ï¼Ÿè¿™ä¸ç›¸å½“äºsync.Mutexé—´æ¥ç”¨äº†futexå˜›ï¼é‚£å¦‚æœåŠ é”å¤±è´¥ä¸æ˜¯ç›´æ¥é˜»å¡çº¿ç¨‹äº†å—ï¼\n è¿™ç§æƒ…å†µä¸‹å¥½çš„æƒ…å†µæ˜¯å‡ ä¸ªçº¿ç¨‹è‡ªæ—‹ä¸€ä¸‹æŠ¢åˆ°sync.Mutex.semaï¼Œå¤§æ¦‚ç‡ä¼šæˆåŠŸï¼Œä½†æ˜¯é”ç«äº‰ä¸¥é‡çš„æ—¶å€™è¿˜æ˜¯ä¼šå¤±è´¥ï¼Œæ€ä¹ˆåŠæ€»ä¸èƒ½ä¸€ç›´è‡ªæ—‹ä¸å¹²æ´»å•Šï¼Œæ³¨æ„äº†ï¼Œè¿™é‡Œè°ƒç”¨äº†  func (m *Mutex) lockSlow() { ... old := m.state for { new := old ... if atomic.CompareAndSwapInt32(\u0026amp;m.state, old, new) { ... queueLifo := waitStartTime != 0 ... runtime_SemacquireMutex(\u0026amp;m.sema, queueLifo, 1) starving = starving || runtime_nanotime()-waitStartTime \u0026gt; starvationThresholdNs old = m.state if old\u0026amp;mutexStarving != 0 { // If this goroutine was woken and mutex is in starvation mode, // ownership was handed off to us but mutex is in somewhat // inconsistent state: mutexLocked is not set and we are still // accounted as waiter. Fix that. if old\u0026amp;(mutexLocked|mutexWoken) != 0 || old\u0026gt;\u0026gt;mutexWaiterShift == 0 { throw(\u0026quot;sync: inconsistent mutex state\u0026quot;) } delta := int32(mutexLocked - 1\u0026lt;\u0026lt;mutexWaiterShift) if !starving || old\u0026gt;\u0026gt;mutexWaiterShift == 1 { // Exit starvation mode. // Critical to do it here and consider wait time. // Starvation mode is so inefficient, that two goroutines // can go lock-step infinitely once they switch mutex // to starvation mode. delta -= mutexStarving } atomic.AddInt32(\u0026amp;m.state, delta) break } awoke = true iter = 0 } else { old = m.state } } ... }  sync.Mutexé‡Œé¢çš„é”å®ç°ï¼Œä¸ä½¿ç”¨futexï¼Œå³å½“Lockå¤±è´¥æ—¶ï¼Œä¸ä¼šå¯¼è‡´è°ƒç”¨çš„è¿›ç¨‹çº¿ç¨‹è¢«é˜»å¡ï¼Œè€Œåªæ˜¯å°†å½“å‰goroutineé˜»å¡ï¼Œgo runtime schedulerä»ç„¶å¯ä»¥åœ¨å½“å‰çº¿ç¨‹ä¸Šè°ƒåº¦æ‰§è¡Œå…¶ä»–çš„goroutineï¼Œç­‰é”è¢«Unlockæ—¶ï¼Œå°±æœ‰æœºä¼šå†å”¤é†’ä¹‹å‰Lockå¤±è´¥çš„goroutineæ‰§è¡Œã€‚\nå¦å¤–ï¼Œgo sync.Mutexåšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå¤§è‡´æ€»ç»“ä¸€ä¸‹ã€‚sync.Mutexæœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼šnormal mode å’Œ starvation modeï¼Œä¸¤ç§æ¨¡å¼å¯¹æ‰§è¡ŒLockã€Unlockçš„goroutineä¼šäº§ç”Ÿä¸åŒçš„å½±å“ã€‚\n  normal mode\nè¯¥æ¨¡å¼ä¸‹ï¼Œwaitersï¼ˆgoroutinesï¼‰ä¼šæŒ‰ç…§åŠ é”ç”³è¯·è¿›å…¥ä¸€ä¸ªFIFOçš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªè¢«å”¤é†’çš„waiterä¸ä¸€å®šèƒ½å¤Ÿç«‹å³æŒæœ‰é”ï¼Œå®ƒè¦å’Œæ‰€æœ‰æ–°çš„å‘èµ·åŠ é”è¯·æ±‚çš„goroutinesç«äº‰ã€‚æ–°åˆ°è¾¾çš„goroutinesé€šå¸¸æœ‰ä¸€ä¸ªä¼˜åŠ¿â€”â€”å®ƒä»¬å·²ç»åœ¨CPUä¸Šè¿è¡Œäº†ï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥ä¸€ä¸ªåˆšè¢«å”¤é†’çš„waiterå¤§æ¦‚ç‡ä¼šç«äº‰é”å¤±è´¥ã€‚\nè¿™ç§æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå¤±è´¥çš„waiterä¼šè¢«åŠ å…¥åˆ°è¿™ä¸ªFIFOé˜Ÿåˆ—çš„å¯¹é¦–ï¼Œå¦‚æœä¸€ä¸ªwaiterç«äº‰é”è¶…è¿‡1msè¿˜æ²¡æœ‰æˆåŠŸï¼Œå°±ä¼šå°†mutexä»normal modeåˆ‡æ¢ä¸ºstartvation modeã€‚\n  starvation mode\nè¯¥æ¨¡å¼ä¸‹ï¼Œå½“ä¸€ä¸ªgoroutineé‡Šæ”¾é”æ—¶ï¼Œé”çš„æ‹¥æœ‰è€…ç«‹å³ä»è¯¥goroutineè½¬äº¤ç»™å¯¹é¦–çš„waiterã€‚æ–°åˆ°è¾¾çš„goroutinesä¸ä¼šå°è¯•è·å¾—é”ï¼Œå°½ç®¡å®ƒèƒ½è§‚å¯Ÿåˆ°é”å¥½åƒè¢«é‡Šæ”¾æ‰äº†ã€‚è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ–°åˆ°è¾¾çš„goroutinesä¼šè¿½åŠ åˆ°FIFOçš„é˜Ÿåˆ—çš„æœ«å°¾ã€‚\n  å½“ä¸€ä¸ªwaiteræ”¶åˆ°ä¸€ä¸ªmutexçš„æ‹¥æœ‰è€…æƒé™æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥ï¼Œå¦‚æœï¼š1ï¼‰å®ƒæ˜¯è¿™ä¸ªé”ç«äº‰ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªwaiterï¼›æˆ–è€… 2ï¼‰å®ƒçš„åŠ é”ç­‰å¾…æ—¶é—´å°äº1msï¼Œæ­¤æ—¶å°†æŠŠmutexä»starvation modeåˆ‡æ¢ä¸ºnormal modeã€‚\nmutex.Unlock() # fastpath # å…ˆå°è¯•CASå»æ‰åŠ é”æ ‡å¿—ä½ï¼Œå…¶å®è¿”å›çš„æ˜¯é”çš„æ–°çŠ¶æ€ï¼Œå¦‚æœä¹‹å‰çŠ¶æ€æ˜¯lockedï¼Œç°åœ¨unlockedå»æ‰äº†è¿™ä¸ªæ ‡å¿—ä½ï¼Œå¦‚æœæ–°çŠ¶æ€state==0ï¼Œè¡¨ç¤ºæ²¡ä»€ä¹ˆå…¶ä»–è¦å¤„ç†çš„äº†ï¼Œç›´æ¥è¿”å›å°±å¯ä»¥äº†ï¼Œåä¹‹ï¼Œåˆ™è¯´æ˜é”å¯èƒ½è¢«è®¾ç½®äº†å…¶ä»–çš„çŠ¶æ€ï¼Œå¦‚å‰é¢æåˆ°çš„é”çš„normalã€starvation modeï¼Œè¿˜éœ€è¦è¿›å…¥slowpathè¿›ä¸€æ­¥å¤„ç†ã€‚\n// Unlock unlocks m. // It is a run-time error if m is not locked on entry to Unlock. // // A locked Mutex is not associated with a particular goroutine. // It is allowed for one goroutine to lock a Mutex and then // arrange for another goroutine to unlock it. func (m *Mutex) Unlock() { if race.Enabled { _ = m.state race.Release(unsafe.Pointer(m)) } // Fast path: drop lock bit. new := atomic.AddInt32(\u0026amp;m.state, -mutexLocked) if new != 0 { // Outlined slow path to allow inlining the fast path. // To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock. m.unlockSlow(new) } }  slowpath # é”çš„çŠ¶æ€ä¸åªæ˜¯æœ‰æŒæœ‰ã€æœªæŒæœ‰è¿™å‡ ç§ï¼Œé‚£çœ‹æ¥è¿™é‡Œæ˜¯è¦å¤„ç†å…¶ä»–å‡ ç§é”çŠ¶æ€çš„æƒ…å†µäº†ã€‚\nconst ( mutexLocked = 1 \u0026lt;\u0026lt; iota // mutex is locked mutexWoken mutexStarving mutexWaiterShift = iota )  ç»§ç»­çœ‹æºç ï¼Œé¦–å…ˆåšä¸ªæ£€æŸ¥ï¼Œå½“å‰goroutineè°ƒç”¨Unlockä¹‹å‰æ˜¯å¦æœ‰æŒæœ‰è¿™æŠŠé”ï¼Œå¾ˆå¥½æ¯”è¾ƒï¼Œåªè¦æ£€æŸ¥ (new+mutexLocked) \u0026amp; mutexLocked ä¸‹ä¾¿çŸ¥é“ã€‚\nQAï¼šå¦‚æœå½“å‰goroutineæ²¡æœ‰æŒæœ‰è¿‡é”ï¼Œå‰é¢fastpathä¸­å´å»æ‰äº†é”æ ‡å¿—ä½ï¼Œèµ°åˆ°è¿™é‡Œæ£€æŸ¥å‘ç°ä¹‹å‰æ²¡æœ‰æŒæœ‰é”ï¼Œè¿™æ˜¯å¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œç›´æ¥throwäº†ï¼Œä¹Ÿæ²¡ä»€ä¹ˆå–„åçš„ï¼Œç›´æ¥é€€å‡ºå•¦ï¼Œç¨‹åºå‘˜è‡ªå·±æŠ“ç´§æ”¹bugå§ï¼Œç»§ç»­è·‘ä¹Ÿä¼šé€ æˆbugï¼\nç„¶åè¿™é‡Œé¢ä¸»è¦æ˜¯è¿™ä¸ªå‡½æ•°runtime_Semreleaseï¼š\n å¦‚æœæ˜¯æ­£å¸¸æ¨¡å¼ï¼Œè¿™ä¸ªå‡½æ•°ä»å¯¹å¤´å–å‡ºä¸€ä¸ªsudogï¼ˆç­‰å¾…é”çš„goroutineï¼‰ï¼Œç„¶åå°†å…¶ä¸¢å…¥runqç­‰å¾…è¢«è°ƒåº¦ï¼› å¦‚æœæ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œè¿™ä¸ªå‡½æ•°ä»å¤´å–å‡ºä¸€ä¸ªsudogï¼ˆç­‰å¾…é”çš„goroutineï¼‰ï¼Œç„¶åå°†å…¶ä¸¢å…¥runqï¼Œå¹¶ç«‹å³è®©å‡ºCPUï¼Œç›¸å½“äºè®©è¿™ä¸ªsudogå°½å¯èƒ½å¿«åœ°è¢«æ‰§è¡Œåˆ°ã€‚  func (m *Mutex) unlockSlow(new int32) { if (new+mutexLocked)\u0026amp;mutexLocked == 0 { throw(\u0026quot;sync: unlock of unlocked mutex\u0026quot;) } if new\u0026amp;mutexStarving == 0 { old := new for { // If there are no waiters or a goroutine has already // been woken or grabbed the lock, no need to wake anyone. // In starvation mode ownership is directly handed off from unlocking // goroutine to the next waiter. We are not part of this chain, // since we did not observe mutexStarving when we unlocked the mutex above. // So get off the way. if old\u0026gt;\u0026gt;mutexWaiterShift == 0 || old\u0026amp;(mutexLocked|mutexWoken|mutexStarving) != 0 { return } // Grab the right to wake someone. new = (old - 1\u0026lt;\u0026lt;mutexWaiterShift) | mutexWoken if atomic.CompareAndSwapInt32(\u0026amp;m.state, old, new) { runtime_Semrelease(\u0026amp;m.sema, false, 1) return } old = m.state } } else { // Starving mode: handoff mutex ownership to the next waiter, and yield // our time slice so that the next waiter can start to run immediately. // Note: mutexLocked is not set, the waiter will set it after wakeup. // But mutex is still considered locked if mutexStarving is set, // so new coming goroutines won't acquire it. runtime_Semrelease(\u0026amp;m.sema, true, 1) } }  # "}),a.add({id:389,href:"/blog/08%E9%87%8D%E8%A6%81%E7%9A%84%E9%9B%86%E7%BE%A4%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E4%B8%8B/",title:"08é‡è¦çš„é›†ç¾¤å‚æ•°é…ç½®",description:"ç•¥ï¼Œæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒï¼šhttps://time.geekbang.org/column/article/101763",content:"ç•¥ï¼Œæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒï¼šhttps://time.geekbang.org/column/article/101763\n"}),a.add({id:390,href:"/blog/09%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E6%81%AF%E5%88%86%E5%8C%BA%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/",title:"09ç”Ÿäº§è€…æ¶ˆæ¯åˆ†åŒºåŸç†å‰–æ",description:"kafkaä¸­æ•°æ®ç»„ç»‡ #  ä¸»é¢˜ topic åˆ†åŒº partitionï¼ˆä¸€ä¸ªtopicä¸‹å¯æœ‰å¤šä¸ªpartitionsï¼Œæ¯ä¸ªpartitionéƒ½æœ‰å‰¯æœ¬replicasï¼‰ æ¶ˆæ¯ messageï¼ˆåŒä¸€ä¸ªpartitionå†…çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼‰  ",content:"kafkaä¸­æ•°æ®ç»„ç»‡ #  ä¸»é¢˜ topic åˆ†åŒº partitionï¼ˆä¸€ä¸ªtopicä¸‹å¯æœ‰å¤šä¸ªpartitionsï¼Œæ¯ä¸ªpartitionéƒ½æœ‰å‰¯æœ¬replicasï¼‰ æ¶ˆæ¯ messageï¼ˆåŒä¸€ä¸ªpartitionå†…çš„æ¶ˆæ¯æ˜¯æœ‰åºçš„ï¼‰  "}),a.add({id:391,href:"/tags/c/cpp/",title:"c/cpp",description:"",content:""}),a.add({id:392,href:"/tags/desktop/",title:"desktop",description:"",content:""}),a.add({id:393,href:"/tags/go/ast/",title:"go/ast",description:"",content:""}),a.add({id:394,href:"/tags/grub/",title:"grub",description:"",content:""}),a.add({id:395,href:"/tags/plymouth/",title:"plymouth",description:"",content:""}),a.add({id:396,href:"/blog/2017-03-13-%E8%81%8A%E8%81%8A%E4%BC%B4%E6%88%91%E5%A4%9A%E5%B9%B4%E7%9A%84%E8%80%81%E5%8F%8Blinux/",title:"èŠèŠä¼´æˆ‘å¤šå¹´çš„è€å‹ï¼ŒLinux",description:"ä½¿ç”¨Linuxå·²ç»å¿«10å¹´äº†ï¼Œä»å¤§ä¸‰å¼€å§‹åˆ°ç ”ç©¶ç”Ÿæ¯•ä¸šï¼ŒLinuxä½œä¸ºäº†æˆ‘çš„ä¸»åŠ›æ“ä½œç³»ç»Ÿï¼ŒWindowså‡ ä¹æ²¡æœ‰å†æ€ä¹ˆä½¿ç”¨è¿‡ï¼ˆæ›¾ç»æˆ‘Windowsç©çš„ä¹Ÿå¾ˆæºœçš„ï¼‰ã€‚è¿™ä¹ˆå¤šå¹´ï¼ŒLinuxè®©æˆ‘é‡æ–°è®¤è¯†äº†æ¡Œé¢ç¯å¢ƒçš„æ•ˆç‡ï¼Œä¹Ÿè®©æˆ‘è®¤è¯†äº†å®šåˆ¶åŒ–çš„è‡ªç”±ï¼Œè¿˜æœ‰å®ƒç®€å•å´ç²¾å¦™ç»ä¼¦çš„è®¾è®¡ã€‚ä¹Ÿæ˜¯æ—¶é—´æ¥èŠèŠè¿™ä½è€å‹äº†ã€‚",content:"1 é‚‚é€…Linux # åˆæ¬¡æ¥è§¦Linuxæ“ä½œç³»ç»Ÿæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Ÿæƒ³æƒ³ï½ï½\né«˜ä¸‰æ¯•ä¸šåä¹°äº†ç¬¬ä¸€å°ç”µè„‘ï¼Œä¸€å°æ¸…ååŒæ–¹çš„å°å¼æœºï¼Œéšæœºèµ é€çš„å…‰ç›˜é‡Œé¢æœ‰ä¸€å¼ æ“ä½œç³» ç»Ÿå…‰ç›˜â€œå®¶ç”µä¸‹ä¹¡Linuxé€‚å†œç‰ˆâ€â€¦â€¦é‚£æ˜¯æˆ‘ç¬¬ä¸€æ¬¡æ¥è§¦å¹¶è¿è¡ŒLinuxï¼Œä½†é‚£æ—¶çš„æˆ‘å¹¶æ²¡æœ‰æ„è¯† åˆ°ï¼Œæ”¾åœ¨æˆ‘é¢å‰çš„æ˜¯ä¸€ä¸ªå³å°†æ·±æ·±åœ°å¸å¼•æˆ‘å¹¶è¦åœ¨å¤šå¹´çš„èŒä¸šç”Ÿæ¶¯ä¸­å»ä¸æ–­é”¤ç‚¼çš„å­˜åœ¨ã€‚\nå¤§ä¸€ã€å¤§äºŒè¿™ä¸¤å¹´ï¼Œæˆ‘æˆ–å¤šæˆ–å°‘åœ°æ¥è§¦åˆ°äº†Linuxï¼Œä½†æ˜¯å¹¶æ²¡æœ‰äº§ç”Ÿå¤šå¤§å…´è¶£ï¼Œç›´åˆ°æœ‰ä¸€ å¤©æˆ‘æ¿€æ€’äº†ä¸€ä¸ªåŒå­¦ã€‚å½“æ—¶ä»–æ­£åœ¨æ‘†å¼„Ubuntuï¼Œé”™è¯¯åœ°GRUBé…ç½®å¯¼è‡´ç³»ç»Ÿå¼•å¯¼å¤±è´¥ï¼Œç€æ€¥ çš„ä»–åœ¨QQç©ºé—´å‘äº†ä¸€æ¡çŠ¶æ€ï¼Œæ„æ€å°±æ˜¯å¤§ç¥æ±‚æ•‘ä¹‹ç±»çš„ã€‚å½“æ—¶æˆ‘å›äº†ä¸€ä¸ªå­—â€œæ°´â€ã€‚ä»–çœ‹å å¾ˆç”Ÿæ°”ï¼Œç³»ç»Ÿéƒ½å¯åŠ¨ä¸äº†äº†èƒ½ä¸ç€æ€¥å—ï¼Ÿäºæ˜¯å‘¢ï¼Œå°±è¨€è¾æ¿€çƒˆåœ°â€œå›æ•¬â€äº†æˆ‘å‡ å¥â€¦â€¦\näº‹åæˆ‘æƒ³ï¼ŒLinuxæœ‰è¿™ä¹ˆå¤æ‚å—ï¼Ÿäºæ˜¯æˆ‘å¼€å§‹è¯•å›¾å–äº†è§£Linuxï¼Œå½“ç„¶è¿™åªæ˜¯ä¸ªå¼•å­ï¼Œåé¢ é™†é™†ç»­ç»­çœ‹åˆ°æœ‰ä¸å°‘åŒå­¦éƒ½åœ¨ä½¿ç”¨å„ç§Linuxçš„å‘è¡Œç‰ˆï¼Œæˆ‘æ‰å†³å®šè®¤çœŸå»äº†è§£ã€å­¦ä¹ ä¸€ä¸‹ Linuxï¼Œæ²¡æƒ³åˆ°è¿™ç«Ÿæ˜¯ä¸€æ¡ä¸å½’è·¯â€¦â€¦\n LiveCD \u0026amp; RemasterSys \u0026amp; dump \u0026amp; restore GRUB 2 \u0026amp; Customize Boot Menu to bootstrap Multiple OS Plymouth Tweak KDE/GNOME/Unity Appearance (Colors \u0026amp; Themes) Linux Commandline Techs \u0026amp; Administration Unix/Linux Programming Linux Kernel 0.11 Linux Kernel 2.4 Keep going along the roadmap to Linux World!  ä¸Šé¢å¤§ä½“ä¸Šæ˜¯æˆ‘åˆè¯†ã€æŠ˜è…¾ã€å­¦ä¹ ã€åº”ç”¨ã€ç ”ç©¶Linuxçš„è¿‡ç¨‹ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹åœ¨ç›¸å½“é•¿ä¸€ æ®µäº‹æ—¶é—´å†…è¿˜å°†ä¸€ç›´å‘å‰å»¶ä¼¸ä¸‹å»ã€‚ä¸å…¶è¯´å¯¹Linuxæ„Ÿå…´è¶£ï¼Œä¸å¦‚è¯´æ˜¯å¥½å¥‡å¿ƒé©±ä½¿ï¼Œè¿˜æœ‰ å¾ˆå¤šç–‘é—®æ²¡æœ‰æ­å¼€ï¼Œè¿™é‡Œå½“ç„¶ä¸åªæ˜¯Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æœ¬èº«ã€‚\næˆ‘è¿™ä¸ªåšå®¢æ‰€è¦æè¿°çš„ä¸œè¥¿å¯èƒ½å°±æ¯”è¾ƒæ‚äº†ï¼Œè¿™é‡Œé¢æˆ‘ä¼šç©¿æ’ç€è®°å½•å¾ˆå¤šä¸œè¥¿ï½ä¸å…¶è¯´æ˜¯ åšå®¢ï¼Œä¸å¦‚è¯´æ˜¯æˆ‘è‡ªå·±çš„ä¸€ä¸ªå­¦ä¹ ç¬”è®°äº†ï¼Œä½†æ˜¯æˆ‘è¿™ä¸ªäººæ¯”è¾ƒå–œæ¬¢åˆ†äº«ï¼Œä½†æœ‰ä¸æƒ³é‚£ä¹ˆåˆ» æ„ï¼Œæ‰€ä»¥æˆ‘å°±æŠŠå®ƒä¸¢åœ¨è¿™ï¼Œè°çœ‹è§äº†æ‰¾åˆ°ç‚¹è‡ªå·±æ„Ÿå…´è¶£çš„ä¸œè¥¿ï¼Œä¹Ÿç®—æ˜¯ç§ç¼˜åˆ†ã€‚\n2 LiveCD \u0026amp; RemasterSys \u0026amp; dump \u0026amp; restore # 2.1 LiveCD # åœ¨å­¦ä¹ Linuxè¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä½“éªŒä¸åŒLinuxå‘è¡Œç‰ˆè¿™æ ·çš„éœ€æ±‚çš„ï¼Œè¿™ä¸ªæ—¶å€™ä½ æœ‰ä¸æƒ³é¢‘ç¹åœ°å®‰è£…ç³»ç»Ÿæ¥è§£å†³ã€‚LiveCDå°±æ˜¯å‘è¡Œç‰ˆå‚å•†é’ˆå¯¹ç”¨æˆ·çš„è¿™ç§éœ€æ±‚æ¨å‡ºçš„ä¸€ä¸ªç©æ„ï¼Œç”¨æˆ·å¯ä»¥æ’å…¥å…‰ç›˜åˆ°å…‰é©±ã€BIOSå¼•å¯¼ä»å…‰é©±å¯åŠ¨æ¥ä½“éªŒã€‚\nå¯èƒ½å§ï¼Œæ—¶é—´è®©ä½ æ˜ç™½ï¼ŒLinuxæœ€å¸å¼•äººçš„åœ°æ–¹ï¼Œå¹¶ä¸æ˜¯æœ‰å¾ˆå¤šçš„å‘è¡Œç‰ˆä¾›ä½ æ¢æ¥æ¢å»ï¼Œè€Œæ˜¯å†…åœ¨çš„è‡ªç”±ã€‚æœ€åï¼Œä½ è¿˜æ˜¯ä¼šæ·±åº¦ä½¿ç”¨æŸä¸€ä¸ªå‘è¡Œç‰ˆå¹¶å®‰å®šä¸‹æ¥ï¼Œè€Œé‚£äº›å„ç§å„æ ·çš„æ¡Œé¢ç¯å¢ƒä¹Ÿä¼šæœ‰ç‚¹é€‰æ‹©å›°éš¾ã€‚Ubuntu-\u0026gt;Debian-\u0026gt;Fedora-\u0026gt;OpenSuSE-\u0026gt;RHEL-\u0026gt;CentOS-\u0026gt;\u0026hellip;Fedora! Unity-\u0026gt;GNOME3-\u0026gt;GNOME2-\u0026gt;KDE-\u0026gt;\u0026hellip;-\u0026gt;KDE! æˆ‘å·²ç»åšå®ˆåœ¨Fedora/CentOS+KDEå¾ˆå¤šå¹´äº†ï¼Œé€‚åˆè‡ªå·±çš„å°±æ˜¯æœ€å¥½çš„ï¼\nLiveCDä¸ä»…å¯ä»¥å¸®åŠ©æˆ‘ä»¬é¢„å…ˆä½“éªŒLinuxå‘è¡Œç‰ˆï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å®‰è£…Linuxå‘è¡Œç‰ˆã€ä¿®å¤ç³»ç»Ÿé—®é¢˜ã€‚å¸¦ç€ä¸€å¼ LiveCDæˆ–è€…Bootable USB Installerï¼Œå°±å¥½åƒéšèº«æºå¸¦äº†ä¸€ä¸ªç§»åŠ¨ç‰ˆçš„æ“ä½œç³»ç»Ÿã€‚è¿˜æ˜¯å¾ˆæ–¹ä¾¿ã€å¾ˆé…·çš„ä¸€ä»¶äº‹æƒ…ã€‚\nUNetBootinç­‰ç±»ä¼¼çš„å°†USBå˜èº«æˆå¯å¼•å¯¼çš„Bootable Linux Installerçš„å·¥å…·ï¼Œä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„å·¥å…·ã€‚\n2.2 RemasterSys # å½“ä½ æ·±åº¦ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¼šå‘ç°ä¸ç®¡æ˜¯é…ç½®æ–‡ä»¶ï¼Œè¿˜æ˜¯GUIï¼Œè¿˜æ˜¯è½¯ä»¶åˆ—è¡¨\u0026hellip;éƒ½å·²ç»è¢«è‡ªå·±æ·±åº¦å®šåˆ¶åŒ–è¿‡äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾ˆè‡ªç„¶ä¼šå»æƒ³ç³»ç»Ÿå¤‡ä»½çš„äº‹æƒ…ï¼Œä»¥å…å‡†å¤‡å¤šå°è®¾å¤‡åŠå…¬æ—¶èƒ½éå†åœ°è¿ç§»å¤‡ä»½ï¼Œæˆ–è€…åœ¨è®¾å¤‡ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿä¾¿æ·åœ°è¿˜åŸçš„é—®é¢˜ã€‚\nå½“ä½ äº†è§£äº†Linuxå®šåˆ¶åŒ–æ„å‘³ç€ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ å°±åº”è¯¥èƒ½ä½“ä¼šåˆ°å®šåˆ¶åŒ–èƒŒåæ„å‘³ç€çš„å·¥ä½œé‡ã€æŠ•å…¥çš„æ—¶é—´ï¼Œä½ ä¸ä¼šæ„¿æ„å†ä»å®‰è£…å¼€å§‹é‡æ–°å®šåˆ¶åŒ–äº†ï¼Œ æ²¡æœ‰è§„åˆ’çš„äººæ‰å°†è¿™ç§é‡å¤æ€§åŠ³åŠ¨å½“åšæ˜¯ä¹ æƒ¯ã€‚æˆ‘ä¸ºä»€ä¹ˆä¸èƒ½å°†ç°åœ¨çš„å®Œæ•´çš„ç³»ç»Ÿåšæˆä¸€ä¸ªåˆå§‹çš„å¯å®‰è£…çš„ç³»ç»Ÿå‘¢ï¼Ÿ\nè™½ç„¶è¿™è¦èŠ±è´¹çš„æ—¶é—´ã€å­˜å‚¨å¯èƒ½ä¼šå¤§ä¸€ç‚¹ï¼Œä½†æ˜¯é€‚å½“ç²¾ç®€ä¸‹è½¯ä»¶åˆ—è¡¨ã€ç”¨æˆ·æ–‡ä»¶ï¼Œå®Œå…¨å¯ä»¥æ§åˆ¶åœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´å†…ï¼ŒæŒ‰å¸‚é¢ä¸Šå¸¸è§çš„DVDå­˜å‚¨å®¹é‡æ¥çœ‹ï¼Œå®Œå…¨æ˜¯holdå¾—ä½çš„ã€‚è€Œä¸”DVDæ˜¯çœŸçš„ä¾¿å®œï¼Œå­˜æ”¾æ—¶é—´ä¹Ÿæ›´é•¿ä¹…ã€‚\nRemasterSyså°±æ˜¯ä¸ºäº†æ»¡è¶³è¿™æ ·çš„éœ€æ±‚è€Œè®¾è®¡å‡ºæ¥çš„ï¼Œå®ƒå°±å¯ä»¥æŠŠæˆ‘ä»¬å½“å‰è¿è¡Œçš„ç³»ç»Ÿé‡æ–°åšæˆä¸€ä¸ªå¯å®‰è£…çš„ç³»ç»Ÿï¼Œå®‰è£…å®Œæˆåå°±æ˜¯ç°åœ¨çš„æ ·å­ã€‚ä½†æ˜¯åŸä½œè€…å¯èƒ½å¾ˆä¹…æ²¡æœ‰å†æ›´æ–°äº†å§ï¼Œåœ¨æˆ‘äº†è§£åˆ°è¿™æ¬¾ç³»ç»Ÿå·¥å…·æ—¶ï¼Œå®ƒå·²ç»æ¥è¿‘å¤±ä¿®çš„è¾¹ç¼˜äº†ã€‚Sad\n2.3 dump \u0026amp; restore # æ…¢æ…¢åœ°æ„è¯†åˆ°ï¼Œæ‰€è°“çš„å®šåˆ¶éƒ½æ˜¯ç§äººæ½œæ„è¯†é‡Œé¢çš„æ€æƒ³å›ºåŒ–ï¼Œæ€»æœ‰ä¸é€‚åˆä»–äººåº”ç”¨åœºæ™¯çš„æ—¶å€™ï¼Œé™¤éä½ æœ‰èƒ½åŠ›è‡ªå·±ç»™è‡ªå·±å®šåˆ¶ã€‚æœ€ç®€å•çš„ä¸œè¥¿ï¼Œå°±æ˜¯æœ€å¥½ç”¨çš„ã€æœ€é è°±çš„ã€‚ä¸€æ®µæ—¶é—´ä¸‹æ¥ï¼Œæˆ‘å‘ç°dump \u0026amp; restoreå°±æ˜¯é€¼è¿‘å®Œç¾çš„é€‰æ‹©ã€‚å®ƒä¸“æ³¨äºè½¬å‚¨ã€æ¢å¤æ“ä½œï¼Œéå¸¸åŸå§‹ã€‚\nddæœ€åŸå§‹ç›´æ¥è¯»å†™å­˜å‚¨è®¾å¤‡åŸå§‹æ•°æ®ï¼Œç”šè‡³éƒ½ä¸ç†è§£ä½ çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯å®ƒç¼ºå°‘ä¸€ç‚¹çµæ´»æ€§ã€‚\ndumpå…è®¸æˆ‘ä»¬åœ¨æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šåšä¸€äº›é€‰æ‹©ï¼Œå¦‚é€‰æ‹©å¤‡ä»½å“ªäº›ç›®å½•ã€æ–‡ä»¶ç­‰ç­‰ï¼Œdumpå¤‡ä»½çš„æ—¶å€™ä¼šåŒæ—¶å¤‡ä»½æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼Œæ•´ä¸ªæ‰“åŒ…æˆä¸€ä¸ªæ–‡ä»¶ï¼Œåç»­å¤‡ä»½æ¢å¤çš„æ—¶å€™ä½ ä¹Ÿå¯ä»¥é€šè¿‡restoreé€‰æ‹©æ¢å¤å“ªäº›æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿã€‚\nåˆšå¼€å§‹çš„æ—¶å€™ï¼Œå¯èƒ½è§‰å¾—å…¨æ˜¯å‘½ä»¤è¡Œæ“ä½œï¼Œå¥½å¤æ‚ï¼Ÿä¸‡ä¸€å‡ºé”™äº†æ€ä¹ˆåŠï¼ŸLinuxå¼ºå¤§çš„åœ°æ–¹å°±æ˜¯å‘½ä»¤è¡Œæ“ä½œï¼Œä¹ æƒ¯äº†ä¹‹åå°±çœŸçš„çˆ±ä¸Šäº†ã€‚dump \u0026amp; restoreæ˜¯ç›®å‰æˆ‘è§‰å¾—æ¯”è¾ƒå¥½ç”¨çš„ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸åƒmacOS timemachineé‚£æ ·æ–¹ä¾¿ï¼Œä½†æ˜¯å®ƒçœŸçš„ç®—å¾—ä¸Šæœ€çµæ´»çš„ã€‚\n3 GRUB 2 \u0026amp; Customize Boot Menu to bootstrap Multiple OS # 4 Plymouth # 5 Tweak KDE/GNOME/Unity Appearance (Colors \u0026amp; Themes) # 6 Linux Commandline Techs \u0026amp; Administration # 7 Unix/Linux Programming # 8 Linux Kernel 0.11 # 9 Linux Kernel 2.4 # 10 Keep going along the roadmap to Linux World! # "}),search.addEventListener('input',b,!0);function b(){var b,e;const d=5;b=this.value,e=a.search(b,{limit:d,enrich:!0});const c=new Map;for(const a of e.flatMap(a=>a.result)){if(c.has(a.doc.href))continue;c.set(a.doc.href,a.doc)}if(suggestions.innerHTML="",suggestions.classList.remove('d-none'),c.size===0&&b){const a=document.createElement('div');a.innerHTML=`No results for "<strong>${b}</strong>"`,a.classList.add("suggestion__no-results"),suggestions.appendChild(a);return}for(const[h,a]of c){const f=document.createElement('div');suggestions.appendChild(f);const b=document.createElement('a');b.href=h,f.appendChild(b);const g=document.createElement('span');g.textContent=a.title,g.classList.add("suggestion__title"),b.appendChild(g);const e=document.createElement('span');if(a.description.length>128?e.textContent=a.description.substring(0,128)+"...read more":e.textContent=a.description,e.classList.add("suggestion__description"),b.appendChild(e),suggestions.appendChild(f),suggestions.childElementCount==d)break}}})()