<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Webç«™ç‚¹æè¿°">
<title>
golang select-case å®ç°æœºåˆ¶ - ä»‹ç»
</title>




<script>
  var _hmt = _hmt || [];
  (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?1b9ed891d2beed7bd1eee821e011ff66";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
  })();
</script>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-167963378-234368158', 'auto');
	
	ga('send', 'pageview');
}
</script>


        <meta property="og:title" content="golang select-case å®ç°æœºåˆ¶ - ä»‹ç»" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Webç«™ç‚¹æè¿°"/>
<meta property="og:url" content="https://hitzhangjie.github.io/blog/2018-05-19-golang-select-case%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/"/>
<meta property="og:site_name" content="ä»‹ç»"/>




<meta property="og:image" content="https://hitzhangjie.github.io/home/me.jpg"/>

<meta property="og:image" content="https://hitzhangjie.github.io/home/profile.jpg"/>




        
<link rel="shortcut icon" href="/img/fav.ico">


        





<link rel="stylesheet" href="/css/main.min.5c5478bdd5363758f3e73657d5339b1ac7c131a401ffc3338edd7eb5e1a0114e.css" integrity="sha256-XFR4vdU2N1jz5zZX1TObGsfBMaQB/8Mzjt1&#43;teGgEU4=" crossorigin="anonymous" media="screen">




    <link rel="stylesheet" href="/custom.css" integrity="" crossorigin="anonymous" media="screen">

        
        
        
        
    </head>
    <body>
        <section id="top" class="section">
            
            <div class="container hero  fade-in one ">
                

    <h1 class="bold-title is-1">åšå®¢</h1>


            </div>
            
            <div class="section  fade-in two ">
                
<div class="container">
    <hr>
    <nav class="navbar" role="navigation" aria-label="main navigation">
        
        <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false" >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
        <div class="navbar-menu " id="navMenu">
            
            
            
            
            <a class="navbar-item" href="/">ä¸»é¡µ</a>
            

            
            

            
                
            

            
                
            

            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://hitzhangjie.github.io/projects/">
                  
                  é¡¹ç›®
                  
                  </a>
                
                
            
            
            
            
            
                
                
                
                
                  <a class="navbar-item" href="https://hitzhangjie.github.io/blog/">
                  
                  è¿”å› åšå®¢
                  
                  </a>
                
                
            
            
            
            
            
            <a class="navbar-item" href="/#about">å…³äº</a>
            
            
            
            
            
            <a class="navbar-item" href="/#thanks">è‡´è°¢</a>
            
            
            
            

            
            
            <a class="navbar-item" href="/#contact">è”ç³»æ–¹å¼</a>
            
            

            
            
            
            
            <a class="navbar-item" href="https://hitzhangjie.github.io/en/">English</a>
            
            

            
            
        </div>
    </nav>
    <hr>
</div>



                
    <div class="container">

        <h2 class="title is-1 top-pad strong-post-title">
            <a href="https://hitzhangjie.github.io/blog/2018-05-19-golang-select-case%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/">golang select-case å®ç°æœºåˆ¶</a>
        </h2>
        <div class="post-data">
            å‘è¡¨æ—¶é—´ï¼š2018-05-19 <br> 
            é˜…è¯»æ—¶é•¿ï¼š2 åˆ†é’Ÿ (379å­—)
        </div>

        <p>
        
<div class="blog-share">
    åˆ†äº«ï¼š
    
    <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=golang%20select-case%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%20https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        <span class="hidden">Twitter</span>
    </a>
    
    
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f"  onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="fab fa-facebook-f"></i>
        <span class="hidden">Facebook</span>
    </a>
    
    
    <a class="icon-pinterest" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f&amp;description=golang%20select-case%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <i class="fab fa-pinterest-p"></i>
        <span class="hidden">Pinterest</span>
    </a>
    
    
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <i class="fab fa-google-plus-g"></i>
        <span class="hidden">Google+</span>
    </a>
    
</div>



        </p>

        
        
        <p>
            æ ‡ç­¾ï¼š
            
            <a href="/tags/go">go</a>,
            
            <a href="/tags/chann">chann</a>
            
        </p>
        


    </div>
    
    <div class="container markdown top-pad">
        <h1 id="1-chanæ“ä½œè§„åˆ™">1 chanæ“ä½œè§„åˆ™</h1>
<p>åœ¨ä»‹ç»select-caseå®ç°æœºåˆ¶ä¹‹å‰ï¼Œæœ€å¥½å…ˆäº†è§£ä¸‹chanæ“ä½œè§„åˆ™ï¼Œæ˜ç™½goroutineä½•æ—¶é˜»å¡ï¼Œåˆåœ¨ä»€ä¹ˆæ—¶æœºè¢«å”¤é†’ï¼Œè¿™å¯¹åç»­ç†è§£select-caseå®ç°æœ‰å¸®åŠ©ã€‚æ‰€ä»¥æ¥ä¸‹æ¥å…ˆä»‹ç»chanæ“ä½œè§„åˆ™ï¼Œç„¶åå†ä»‹ç»select-caseçš„å®ç°ã€‚</p>
<h2 id="11-chanæ“ä½œè§„åˆ™1">1.1 chanæ“ä½œè§„åˆ™1</h2>
<p>å½“ä¸€ä¸ªgoroutineè¦ä»ä¸€ä¸ªnon-nil &amp; non-closed chanä¸Šæ¥æ”¶æ•°æ®æ—¶ï¼Œgoroutineé¦–å…ˆä¼šå»è·å–chanä¸Šçš„é”ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹æ“ä½œç›´åˆ°æŸä¸ªæ¡ä»¶è¢«æ»¡è¶³ï¼š</p>
<p>1ï¼‰å¦‚æœchanä¸Šçš„value bufferä¸ç©ºï¼Œè¿™ä¹Ÿæ„å‘³ç€chanä¸Šçš„recv goroutine queueä¹Ÿä¸€å®šæ˜¯ç©ºçš„ï¼Œè¯¥æ¥æ”¶goroutineå°†ä»value bufferä¸­unshiftå‡ºä¸€ä¸ªvalueã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœsend goroutineé˜Ÿåˆ—ä¸ç©ºçš„æƒ…å†µä¸‹ï¼Œå› ä¸ºåˆšæ‰value bufferä¸­ç©ºå‡ºäº†ä¸€ä¸ªä½ç½®ï¼Œæœ‰ä½ç½®å¯å†™ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä¼šä»send goroutine queueä¸­unshiftå‡ºä¸€ä¸ªå‘é€goroutineå¹¶è®©å…¶æ¢å¤æ‰§è¡Œï¼Œè®©å…¶æ‰§è¡ŒæŠŠæ•°æ®å†™å…¥chançš„æ“ä½œï¼Œå®é™…ä¸Šæ˜¯æ¢å¤è¯¥å‘é€è¯¥goroutineæ‰§è¡Œï¼Œå¹¶æŠŠè¯¥å‘é€goroutineè¦å‘é€çš„æ•°æ®pushåˆ°value bufferä¸­ã€‚ç„¶åå‘¢ï¼Œè¯¥æ¥æ”¶goroutineä¹Ÿæ‹¿åˆ°äº†æ•°æ®äº†ï¼Œå°±ç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…æ™¯ï¼Œchannelçš„æ¥æ”¶æ“ä½œç§°ä¸ºnon-blockingæ“ä½œã€‚</p>
<p>2ï¼‰å¦ä¸€ç§æƒ…å†µï¼Œå¦‚æœvalue bufferæ˜¯ç©ºçš„ï¼Œä½†æ˜¯send goroutine queueä¸ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œè¯¥chanä¸€å®šæ˜¯unbufferred chanï¼Œä¸ç„¶value bufferè‚¯å®šæœ‰æ•°æ®å˜›ï¼Œè¿™ä¸ªæ—¶å€™æ¥æ”¶goroutineå°†ä»send goroutine queueä¸­unshiftå‡ºä¸€ä¸ªå‘é€goroutineï¼Œå¹¶å°†è¯¥å‘é€goroutineè¦å‘é€çš„æ•°æ®æ¥æ”¶è¿‡æ¥ï¼ˆä¸¤ä¸ªgoroutineä¸€ä¸ªæœ‰å‘é€æ•°æ®åœ°å€ï¼Œä¸€ä¸ªæœ‰æ¥æ”¶æ•°æ®åœ°å€ï¼Œæ‹·è´è¿‡æ¥å°±okï¼‰ï¼Œç„¶åè¿™ä¸ªå–å‡ºçš„å‘é€goroutineå°†æ¢å¤æ‰§è¡Œï¼Œè¿™ä¸ªæ¥æ”¶goroutineä¹Ÿå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchanæ¥æ”¶æ“ä½œä¹Ÿæ˜¯non-blockingæ“ä½œã€‚</p>
<p>3ï¼‰å¦ä¸€ç§æƒ…å†µï¼Œå¦‚æœvalue bufferå’Œsend goroutine queueéƒ½æ˜¯ç©ºçš„ï¼Œæ²¡æœ‰æ•°æ®å¯æ¥æ”¶ï¼Œå°†æŠŠè¯¥æ¥æ”¶goroutine pushåˆ°chançš„recv goroutine queueï¼Œè¯¥æ¥æ”¶goroutineå°†è½¬å…¥blockingçŠ¶æ€ï¼Œä»€ä¹ˆæ—¶å€™æ¢å¤æœŸæ‰§è¡Œå‘¢ï¼Œè¦ç­‰åˆ°æœ‰ä¸€ä¸ªgoroutineå°è¯•å‘chanå‘é€æ•°æ®çš„æ—¶å€™äº†ã€‚è¿™ç§åœºæ™¯ä¸‹ï¼Œchanæ¥æ”¶æ“ä½œæ˜¯blockingæ“ä½œã€‚</p>
<h2 id="12-chanæ“ä½œè§„åˆ™2">1.2 chanæ“ä½œè§„åˆ™2</h2>
<p>å½“ä¸€ä¸ªgoroutineå¸¸è¯†å‘ä¸€ä¸ªnon-nil &amp; non-closed chanå‘é€æ•°æ®çš„æ—¶å€™ï¼Œè¯¥goroutineå°†å…ˆå°è¯•è·å–chanä¸Šçš„é”ï¼Œç„¶åæ‰§è¡Œå¦‚ä¸‹æ“ä½œç›´åˆ°æ»¡è¶³å…¶ä¸­ä¸€ç§æƒ…å†µã€‚</p>
<p>1ï¼‰å¦‚æœchançš„recv goroutine queueä¸ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œvalue bufferä¸€å®šæ˜¯ç©ºçš„ã€‚å‘é€goroutineå°†ä»recv goroutine queueä¸­unshiftå‡ºä¸€ä¸ªrecv goroutineï¼Œç„¶åç›´æ¥å°†è‡ªå·±è¦å‘é€çš„æ•°æ®æ‹·è´åˆ°è¯¥recv goroutineçš„æ¥æ”¶åœ°å€å¤„ï¼Œç„¶åæ¢å¤è¯¥recv goroutineçš„è¿è¡Œï¼Œå½“å‰å‘é€goroutineä¹Ÿç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchan sendæ“ä½œæ˜¯non-blockingæ“ä½œã€‚</p>
<p>2ï¼‰å¦‚æœchançš„recv goroutine queueæ˜¯ç©ºçš„ï¼Œå¹¶ä¸”value bufferä¸æ»¡ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œsend goroutine queueä¸€å®šæ˜¯ç©ºçš„ï¼Œå› ä¸ºvalue bufferä¸æ»¡å‘é€goroutineå¯ä»¥å‘é€å®Œæˆä¸å¯èƒ½ä¼šé˜»å¡ã€‚è¯¥å‘é€goroutineå°†è¦å‘é€çš„æ•°æ®pushåˆ°value bufferä¸­ç„¶åç»§ç»­æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchan sendæ“ä½œæ˜¯non-blockingæ“ä½œã€‚</p>
<p>3ï¼‰å¦‚æœchançš„recv goroutine queueæ˜¯ç©ºçš„ï¼Œå¹¶ä¸”value bufferæ˜¯æ»¡çš„ï¼Œå‘é€goroutineå°†è¢«pushåˆ°send goroutine queueä¸­è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ç­‰åˆ°æœ‰å…¶ä»–goroutineå°è¯•ä»chanæ¥æ”¶æ•°æ®çš„æ—¶å€™æ‰èƒ½å°†å…¶å”¤é†’æ¢å¤æ‰§è¡Œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œchan sendæ“ä½œæ˜¯blockingæ“ä½œã€‚</p>
<h2 id="13-chanæ“ä½œè§„åˆ™3">1.3 chanæ“ä½œè§„åˆ™3</h2>
<p>å½“ä¸€ä¸ªgoroutineå°è¯•closeä¸€ä¸ªnon-nil &amp; non-closed chançš„æ—¶å€™ï¼Œcloseæ“ä½œå°†ä¾æ¬¡æ‰§è¡Œå¦‚ä¸‹æ“ä½œã€‚</p>
<p>1ï¼‰å¦‚æœchançš„recv goroutine queueä¸ç©ºï¼Œè¿™ç§æƒ…å†µä¸‹value bufferä¸€å®šæ˜¯ç©ºçš„ï¼Œå› ä¸ºå¦‚æœvalue bufferå¦‚æœä¸ç©ºï¼Œä¸€å®šä¼šç»§ç»­unshift recv goroutine queueä¸­çš„goroutineæ¥æ”¶æ•°æ®ï¼Œç›´åˆ°value bufferä¸ºç©ºï¼ˆè¿™é‡Œå¯ä»¥çœ‹ä¸‹chan sendæ“ä½œï¼Œchan sendå†™å…¥æ•°æ®ä¹‹å‰ï¼Œä¸€å®šä¼šä»recv goroutine queueä¸­unshiftå‡ºä¸€ä¸ªrecv goroutineï¼‰ã€‚recv goroutine queueé‡Œé¢æ‰€æœ‰çš„goroutineå°†ä¸€ä¸ªä¸ªunshiftå‡ºæ¥å¹¶è¿”å›ä¸€ä¸ªval=0å€¼å’ŒsentBeforeClosed=falseã€‚</p>
<p>2ï¼‰å¦‚æœchançš„send goroutine queueä¸ç©ºï¼Œæ‰€æœ‰çš„goroutineå°†è¢«ä¾æ¬¡å–å‡ºå¹¶ç”Ÿæˆä¸€ä¸ªpanic for closing a close chanã€‚åœ¨è¿™closeä¹‹å‰å‘é€åˆ°chançš„æ•°æ®ä»ç„¶åœ¨chançš„value bufferä¸­å­˜ç€ã€‚</p>
<h2 id="14-chanæ“ä½œè§„åˆ™4">1.4 chanæ“ä½œè§„åˆ™4</h2>
<p>ä¸€æ—¦chanè¢«å…³é—­äº†ï¼Œchan recvæ“ä½œå°±æ°¸è¿œä¹Ÿä¸ä¼šé˜»å¡ï¼Œchançš„value bufferä¸­åœ¨closeä¹‹å‰å†™å…¥çš„æ•°æ®ä»ç„¶å­˜åœ¨ã€‚ä¸€æ—¦value bufferä¸­closeä¹‹å‰å†™å…¥çš„æ•°æ®éƒ½è¢«å–å‡ºä¹‹åï¼Œåç»­çš„æ¥æ”¶æ“ä½œå°†ä¼šè¿”å›val=0å’ŒsentBeforeClosed=trueã€‚</p>
<h1 id="15-å°ç»“">1.5 å°ç»“</h1>
<p>ç†è§£è¿™é‡Œçš„goroutineçš„blockingã€non-blockingæ“ä½œå¯¹äºç†è§£é’ˆå¯¹chançš„select-caseæ“ä½œæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ã€‚ä¸‹é¢ä»‹ç»select-caseå®ç°æœºåˆ¶ã€‚</p>
<h1 id="2-select-caseå®ç°">2 select-caseå®ç°</h1>
<h1 id="21-select-caseåŸç†ç®€è¿°">2.1 select-caseåŸç†ç®€è¿°</h1>
<p>select-caseä¸­å‡å¦‚æ²¡æœ‰defaultåˆ†æ”¯çš„è¯ï¼Œä¸€å®šè¦ç­‰åˆ°æŸä¸ªcaseåˆ†æ”¯æ»¡è¶³æ¡ä»¶ç„¶åå°†å¯¹åº”çš„goroutineå”¤é†’æ¢å¤æ‰§è¡Œæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™ä»£ç å°±ä¼šé˜»å¡åœ¨è¿™é‡Œï¼Œå³å°†å½“å‰goroutine pushåˆ°å„ä¸ªcaseåˆ†æ”¯å¯¹åº”çš„chçš„recvæˆ–è€…send goroutine queueä¸­ï¼Œå¯¹åŒä¸€ä¸ªchanä¹Ÿå¯èƒ½å°†å½“å‰goroutineåŒæ—¶pushåˆ°recvã€send goroutine queueè¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¸­ã€‚</p>
<p>ä¸ç®¡æ˜¯æ™®é€šçš„chan sendã€recvæ“ä½œï¼Œè¿˜æ˜¯select chan sendã€recvæ“ä½œï¼Œå› ä¸ºchanæ“ä½œé˜»å¡çš„goroutineéƒ½æ˜¯ä¾é å…¶ä»–goroutineå¯¹chançš„sendã€recvæ“ä½œæ¥å”¤é†’çš„ã€‚å‰é¢æˆ‘ä»¬å·²ç»è®²è¿‡äº†goroutineè¢«å”¤é†’çš„æ—¶æœºï¼Œè¿™é‡Œè¿˜è¦å†ç»†åˆ†ä¸€ä¸‹ã€‚</p>
<p>chançš„sendã€recv goroutine queueä¸­å­˜å‚¨çš„å…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆ*sudogï¼Œæˆå‘˜gp *gæŒ‡å‘å¯¹åº”çš„goroutineï¼Œelem unsafe.PointeræŒ‡å‘å¾…è¯»å†™çš„å˜é‡åœ°å€ï¼Œc *hchanæŒ‡å‘goroutineé˜»å¡åœ¨å“ªä¸ªchanä¸Šï¼ŒisSelectä¸ºtrueè¡¨ç¤ºselect chan sendã€recvï¼Œåä¹‹è¡¨ç¤ºchan sendã€recvã€‚g.selectDoneè¡¨ç¤ºselectæ“ä½œæ˜¯å¦å¤„ç†å®Œæˆï¼Œå³æ˜¯å¦æœ‰æŸä¸ªcaseåˆ†æ”¯å·²ç»æˆç«‹ã€‚</p>
<h1 id="2-select-caseæ‰§è¡Œæµç¨‹">2 select-caseæ‰§è¡Œæµç¨‹</h1>
<h2 id="21-chanæ“ä½œé˜»å¡çš„goroutineå”¤é†’æ—¶æ‰§è¡Œé€»è¾‘">2.1 chanæ“ä½œé˜»å¡çš„goroutineå”¤é†’æ—¶æ‰§è¡Œé€»è¾‘</h2>
<p>ä¸‹é¢æˆ‘ä»¬å…ˆæè¿°ä¸‹chanä¸ŠæŸä¸ªgoroutineè¢«å”¤é†’æ—¶çš„å¤„ç†é€»è¾‘ï¼Œå‡å¦‚ç°åœ¨æœ‰ä¸ªgoroutineå› ä¸ºselect chan æ“ä½œé˜»å¡åœ¨äº†ch1ã€ch2ä¸Šï¼Œé‚£ä¹ˆä¼šåˆ›å»ºå¯¹åº”çš„sudogå¯¹è±¡ï¼Œå¹¶å°†å¯¹åº”çš„æŒ‡é’ˆ*sudog pushåˆ°å„ä¸ªcaseåˆ†æ”¯å¯¹åº”çš„ch1ã€ch2ä¸Šçš„sendã€recv goroutine queueä¸­ï¼Œç­‰å¾…å…¶ä»–åç¨‹æ‰§è¡Œ(select) chan sendã€recvæ“ä½œæ—¶å°†å…¶å”¤é†’ï¼š
1ï¼‰æºç æ–‡ä»¶<strong>chan.go</strong>ï¼Œå‡å¦‚ç°åœ¨æœ‰å¦å¤–ä¸€ä¸ªgoroutineå¯¹ch1è¿›è¡Œäº†æ“ä½œï¼Œç„¶åå¯¹ch1çš„goroutineæ‰§è¡Œunshiftæ“ä½œå–å‡ºä¸€ä¸ªé˜»å¡çš„goroutineï¼Œåœ¨unshiftæ—¶è¦æ‰§è¡Œæ–¹æ³• **func (q <em>waitq) dequeue() <em>sudog</em></em>ï¼Œè¿™ä¸ªæ–¹æ³•ä»ch1çš„ç­‰å¾…é˜Ÿåˆ—ä¸­è¿”å›ä¸€ä¸ªé˜»å¡çš„goroutineã€‚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">q</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">waitq</span>) <span style="color:#a6e22e">dequeue</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">sudog</span> {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">sgp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">first</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sgp</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
		}
		<span style="color:#a6e22e">y</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sgp</span>.<span style="color:#a6e22e">next</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">first</span> = <span style="color:#66d9ef">nil</span>
			<span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">last</span> = <span style="color:#66d9ef">nil</span>
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">y</span>.<span style="color:#a6e22e">prev</span> = <span style="color:#66d9ef">nil</span>
			<span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">first</span> = <span style="color:#a6e22e">y</span>
			<span style="color:#a6e22e">sgp</span>.<span style="color:#a6e22e">next</span> = <span style="color:#66d9ef">nil</span> <span style="color:#75715e">// mark as removed (see dequeueSudog)
</span><span style="color:#75715e"></span>		}

		<span style="color:#75715e">// if a goroutine was put on this queue because of a
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// select, there is a small window between the goroutine
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// being woken up by a different case and it grabbing the
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// channel locks. Once it has the lock
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// it removes itself from the queue, so we won&#39;t see it after that.
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// We use a flag in the G struct to tell us when someone
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// else has won the race to signal this goroutine but the goroutine
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// hasn&#39;t removed itself from the queue yet.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">sgp</span>.<span style="color:#a6e22e">isSelect</span> {
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Cas</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sgp</span>.<span style="color:#a6e22e">g</span>.<span style="color:#a6e22e">selectDone</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>) {
				<span style="color:#66d9ef">continue</span>
			}
		}

		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sgp</span>
	}
}
</code></pre></div><p>å‡å¦‚é˜Ÿé¦–å…ƒç´ å°±æ˜¯ä¹‹å‰é˜»å¡çš„goroutineï¼Œé‚£ä¹ˆæ£€æµ‹åˆ°å…¶sgp.isSelect=trueï¼Œå°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªå› ä¸ºselect chan sendã€recvé˜»å¡çš„goroutineï¼Œç„¶åé€šè¿‡CASæ“ä½œå°†sgp.g.selectDoneè®¾ä¸ºtrueæ ‡è¯†å½“å‰goroutineçš„selectæ“ä½œå·²ç»å¤„ç†å®Œæˆï¼Œä¹‹åå°±å¯ä»¥å°†è¯¥goroutineè¿”å›ç”¨äºä»value bufferè¯»æˆ–è€…å‘value bufferå†™æ•°æ®äº†ï¼Œæˆ–è€…ç›´æ¥ä¸å”¤é†’å®ƒçš„goroutineäº¤æ¢æ•°æ®ï¼Œç„¶åè¯¥é˜»å¡çš„goroutineå°±å¯ä»¥æ¢å¤æ‰§è¡Œäº†ã€‚</p>
<p>è¿™é‡Œå°†sgp.g.selectDoneè®¾ä¸ºtrueï¼Œç›¸å½“äºä¼ è¾¾äº†è¯¥sgp.gå·²ç»ä»åˆšæ‰é˜»å¡å®ƒçš„select-caseå—ä¸­é€€å‡ºäº†ï¼Œå¯¹åº”çš„select-caseå—å¯ä»¥ä½œåºŸäº†ã€‚æœ‰å¿…è¦ææä¸€ä¸‹ä¸ºä»€ä¹ˆè¦æŠŠè¿™é‡Œçš„sgp.g.selectDoneè®¾ä¸ºtrueå‘¢ï¼Ÿç›´æ¥å°†è¯¥goroutineå‡ºé˜Ÿä¸å°±å®Œäº†å—ï¼Ÿä¸è¡Œï¼è€ƒè™‘ä»¥ä¸‹å¯¹chançš„æ“ä½œdequeueæ˜¯éœ€è¦å…ˆæ‹¿åˆ°chanä¸Šçš„lockçš„ï¼Œä½†æ˜¯åœ¨å°è¯•lock chanä¹‹å‰æœ‰å¯èƒ½åŒæ—¶æœ‰å¤šä¸ªcaseåˆ†æ”¯å¯¹åº”çš„chanå‡†å¤‡å°±ç»ªã€‚çœ‹ä¸ªç¤ºä¾‹ä»£ç ï¼š</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// g1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
  <span style="color:#a6e22e">ch1</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>â€¨}()

<span style="color:#75715e">// g2
</span><span style="color:#75715e"></span><span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
  <span style="color:#a6e22e">ch2</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2</span>
}

<span style="color:#66d9ef">select</span> {
  <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch1</span>:
    <span style="color:#a6e22e">doSomething</span>()
  <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ch2</span>:
    <span style="color:#a6e22e">doSomething</span>()
}
</code></pre></div><p>åç¨‹g1åœ¨ chan.chansendæ–¹æ³•ä¸­æ‰§è¡Œäº†ä¸€èˆ¬ï¼Œå‡†å¤‡lock ch1ï¼Œåç¨‹g2ä¹Ÿæ‰§è¡Œäº†ä¸€åŠï¼Œä¹Ÿå‡†å¤‡lock ch2;
åç¨‹g1æˆåŠŸlock ch1æ‰§è¡Œdequeueæ“ä½œï¼Œåç¨‹g2é¡µæˆåŠŸlock ch2æ‰§è¡Œdeq	ueueæ“ä½œï¼›
å› ä¸ºåŒä¸€ä¸ªselect-caseå—ä¸­åªèƒ½æœ‰ä¸€ä¸ªcaseåˆ†æ”¯å…è®¸æ¿€æ´»ï¼Œæ‰€ä»¥åœ¨åç¨‹gé‡Œé¢åŠ äº†ä¸ªæˆå‘˜g.selectDoneæ¥æ ‡è¯†è¯¥åç¨‹å¯¹åº”çš„select-caseæ˜¯å¦å·²ç»æˆåŠŸæ‰§è¡Œç»“æŸï¼ˆä¸€ä¸ªåç¨‹åœ¨æŸä¸ªæ—¶åˆ»åªå¯èƒ½æœ‰ä¸€ä¸ªselect-caseå—åœ¨å¤„ç†ï¼Œè¦ä¹ˆé˜»å¡æ²¡æ‰§è¡Œå®Œï¼Œè¦ä¹ˆç«‹å³æ‰§è¡Œå®Œï¼‰ï¼Œå› æ­¤dequeueæ—¶è¦é€šè¿‡CASæ“ä½œæ¥æ›´æ–°g.selectDoneçš„å€¼ï¼Œæ›´æ–°æˆåŠŸè€…å®Œæˆå‡ºé˜Ÿæ“ä½œæ¿€æ´»caseåˆ†æ”¯ï¼ŒCASå¤±è´¥çš„åˆ™è®¤ä¸ºè¯¥select-caseå·²ç»æœ‰å…¶ä»–åˆ†æ”¯è¢«æ¿€æ´»ï¼Œå½“å‰caseåˆ†æ”¯ä½œåºŸï¼Œselect-caseç»“æŸã€‚</p>
<p>è¿™é‡Œçš„CASæ“ä½œä¹Ÿå°±æ˜¯è¯´çš„å¤šä¸ªåˆ†æ”¯æ»¡è¶³æ¡ä»¶æ—¶ï¼Œgolangä¼šéšæœºé€‰æ‹©ä¸€ä¸ªåˆ†æ”¯æ‰§è¡Œçš„é“ç†ã€‚</p>
<h2 id="22-select-caseå—golangæ˜¯å¦‚ä½•æ‰§è¡Œå¤„ç†çš„">2.2 select-caseå—golangæ˜¯å¦‚ä½•æ‰§è¡Œå¤„ç†çš„</h2>
<p>æºæ–‡ä»¶<strong>select.go</strong>ä¸­æ–¹æ³• *<em>selectgo(sel <em>hselect)</em></em> ï¼Œå®ç°äº†å¯¹select-caseå—çš„å¤„ç†é€»è¾‘ï¼Œä½†æ˜¯ç”±äºä»£ç ç¯‡å¹…è¾ƒé•¿ï¼Œè¿™é‡Œä¸å†å¤åˆ¶ç²˜è´´ä»£ç ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±æŸ¥çœ‹ï¼Œè¿™é‡Œåªç®€è¦æè¿°ä¸‹å…¶æ‰§è¡Œæµç¨‹ã€‚</p>
<p><strong>selectgoé€»è¾‘å¤„ç†ç®€è¿°ï¼š</strong></p>
<ul>
<li>é¢„å¤„ç†éƒ¨åˆ†
å¯¹å„ä¸ªcaseåˆ†æ”¯æŒ‰ç…§chåœ°å€æ’åºï¼Œä¿è¯åç»­æŒ‰åºåŠ é”ï¼Œé¿å…äº§ç”Ÿæ­»é”é—®é¢˜ï¼›</li>
<li>pass 1
éƒ¨åˆ†å¤„ç†å„ä¸ªcaseåˆ†æ”¯çš„åˆ¤æ–­é€»è¾‘ï¼Œä¾æ¬¡æ£€æŸ¥å„ä¸ªcaseåˆ†æ”¯æ˜¯å¦æœ‰ç«‹å³å¯æ»¡è¶³chè¯»å†™æ“ä½œçš„ã€‚å¦‚æœå½“å‰åˆ†æ”¯æœ‰åˆ™ç«‹å³æ‰§è¡Œchè¯»å†™å¹¶å›ï¼Œselectå¤„ç†ç»“æŸï¼›æ²¡æœ‰åˆ™ç»§ç»­å¤„ç†ä¸‹ä¸€åˆ†æ”¯ï¼›å¦‚æœæ‰€æœ‰åˆ†æ”¯å‡ä¸æ»¡è¶³ç»§ç»­æ‰§è¡Œä»¥ä¸‹æµç¨‹ã€‚</li>
<li>pass 2
æ²¡æœ‰ä¸€ä¸ªcaseåˆ†æ”¯ä¸Šchanæ“ä½œç«‹å³å¯å°±ç»ªï¼Œå½“å‰goroutineéœ€è¦é˜»å¡ï¼Œéå†æ‰€æœ‰çš„caseåˆ†æ”¯ï¼Œåˆ†åˆ«æ„å»ºgoroutineå¯¹åº”çš„sudogå¹¶pushåˆ°caseåˆ†æ”¯å¯¹åº”chançš„å¯¹åº”goroutine queueä¸­ã€‚ç„¶ågoparkæŒ‚èµ·å½“å‰goroutineï¼Œç­‰å¾…æŸä¸ªåˆ†æ”¯ä¸Šchanæ“ä½œå®Œæˆæ¥å”¤é†’å½“å‰goroutineã€‚æ€ä¹ˆè¢«å”¤é†’å‘¢ï¼Ÿå‰é¢æåˆ°äº†chan.waitq.dequeue()æ–¹æ³•ä¸­é€šè¿‡CASå°†sudog.g.selectDoneè®¾ä¸º1ä¹‹åå°†è¯¥sudogè¿”å›å¹¶æ¢å¤æ‰§è¡Œï¼Œå…¶å®ä¹Ÿå°±æ˜¯å€ŸåŠ©è¿™ä¸ªæ“ä½œæ¥å”¤é†’ã€‚</li>
<li>pass 3
æ•´ä¸ªselect-caseå—å·²ç»ç»“æŸä½¿å‘½ï¼Œä¹‹å‰é˜»å¡çš„goroutineå·²è¢«å”¤é†’ï¼Œå…¶ä»–caseåˆ†æ”¯æ²¡ä»€ä¹ˆä½œç”¨äº†ï¼Œéœ€è¦åºŸå¼ƒæ‰ï¼Œpass 3éƒ¨åˆ†ä¼šå°†è¯¥goroutineä»ä¹‹å‰é˜»å¡å®ƒçš„select-caseå—ä¸­å„caseåˆ†æ”¯å¯¹åº”çš„chan recvã€send goroutine queueä¸­ç§»é™¤ï¼Œé€šè¿‡æ–¹æ³•chan.waitq.dequeueSudog(sgp *sudog)æ¥ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œé˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨ï¼Œé€šè¿‡sudog.prevå’Œsudog.nextåˆ é™¤sudogæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚</li>
</ul>
<h1 id="3-æ€»ç»“">3 æ€»ç»“</h1>
<p>æœ¬æ–‡ç®€è¦æè¿°äº†golangä¸­select-caseçš„å®ç°é€»è¾‘ï¼Œä»‹ç»äº†goroutineä¸chanæ“ä½œä¹‹é—´çš„åä½œå…³ç³»ã€‚ä¹‹å‰ZMQä½œè€…Martin Sustrikä»¿ç€golangå†™è¿‡ä¸€ä¸ªé¢å‘cçš„åº“ï¼Œlibmillï¼Œå®é™…å®ç°æ€è·¯å·®ä¸å¤šï¼Œæ„Ÿå…´è¶£çš„ä¹Ÿå¯ä»¥ç¿»ç¿»çœ‹ï¼Œ<a href="https://hitzhangjie.github.io/2017/12/03/go%E9%A3%8E%E6%A0%BC%E5%8D%8F%E7%A8%8B%E5%BA%93libmill%E4%B9%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html">libmillæºç åˆ†æ</a>ã€‚</p>

    </div>

    <br>
    <br>
    

    <div align="center">
    
<div class="blog-share">
    åˆ†äº«ï¼š
    
    <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=golang%20select-case%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%20https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <i class="fab fa-twitter"></i>
        <span class="hidden">Twitter</span>
    </a>
    
    
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f"  onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <i class="fab fa-facebook-f"></i>
        <span class="hidden">Facebook</span>
    </a>
    
    
    <a class="icon-pinterest" href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f&amp;description=golang%20select-case%20%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6" onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
        <i class="fab fa-pinterest-p"></i>
        <span class="hidden">Pinterest</span>
    </a>
    
    
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2fhitzhangjie.github.io%2fblog%2f2018-05-19-golang-select-case%25E5%25AE%259E%25E7%258E%25B0%25E6%259C%25BA%25E5%2588%25B6%2f" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <i class="fab fa-google-plus-g"></i>
        <span class="hidden">Google+</span>
    </a>
    
</div>



    </div>

    
    <br>
    <br>
    <div style="height:auto;align:center;text-align:center;"> 
        <div>
        <p>
            ~~~ å¦‚æœæ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·è®°å¾—æ‰“èµå“¦ã€‚å¸®æˆ‘å®¶å°ä¸ƒğŸ¶ã€å…ƒå®ğŸ±æ”¹å–„ä¸‹ä¼™é£Ÿå§ï¼ŒğŸ˜˜ ~~~
        </p>
        </div>

        <div>
            <img src="/common/xiaoqi.png" style="height:238px;margin-top:10px;margin-right:5px;"/>
            <img src="/common/qrcode.jpg" style="height:238px;margin-top:10px;"/>
            <img src="/common/yuanbao.png" style="height:238px;margin-top:10px;margin-left:5px;"/>
        </div>
    </div>

    



                
                <div class="container">
    <hr>
</div>
<div class="container has-text-centered top-pad">
    <a href="#top">
        <i class="fa fa-arrow-up"></i>
    </a>
</div>

<div class="container">
    <hr>
</div>

                <div class="section" id="footer">
    <div class="container has-text-centered">
    
        <span class="footer-text">
            <a href="https://github.com/victoriadrake/hugo-theme-introduction/"><strong>Introduction</strong></a> ä¸»é¢˜ä¸º <a href="http://gohugo.io/">Hugo</a> è€Œè®¾ã€‚ç”±å¼€æºç¤¾ç¾¤è´¡çŒ®è€…ä»¥ <a href="https://victoria.dev"><!-- raw HTML omitted --><!-- raw HTML omitted --> å’Œ <!-- raw HTML omitted --><!-- raw HTML omitted --></a> åˆ›é€ ã€‚
        </span>
    
    </div>
</div>

                
            </div>
        </section>
        
        


<script src="https://hitzhangjie.github.io/js/bundle.e6934e69d06bb8a213134f4c1468f9478bb7755e786dfb60e3c5a917c5335805.js" integrity="sha256-5pNOadBruKITE09MFGj5R4u3dV54bftg48WpF8UzWAU="></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-167963378-234368158', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


        
        
        
        
    </body>
</html>
